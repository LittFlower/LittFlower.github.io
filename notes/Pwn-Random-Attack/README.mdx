<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>Pwn 随机数攻击 | 花盆</title><meta name="author" content="LittFlower"/><meta name="description" content="Pwn 随机数攻击"/><meta property="og:title" content="Pwn 随机数攻击 | 花盆"/><meta property="og:description" content="Pwn 随机数攻击"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/notes/Pwn-Random-Attack/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="stylesheet" href="/fonts.css" type="text/css" preload/><link rel="stylesheet" href="/style.css" type="text/css" preload/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="pwn" class="scroll-target"><a href="#pwn"><code class="hash inline-code">#</code>Pwn 随机数攻击</a></h1>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>介绍</a></h2>
<p>随机数攻击</p>
<p>主要阅读了 glibc <code class="inline-code">rand</code> 相关的源代码，总结一下 CTF 中常见随机数攻击手法，主要还是打伪随机数预测。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>常见写法</a></h2>
<p>以 C 语言的 <code class="inline-code">rand()</code> 为例，主要写法如下：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdlib.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdio.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">time.h</span><span style="color:#B5695977">></span><br><br><span style="color:#AB5959">void</span><span style="color:#59873A"> gen_random_plus</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">	srand</span><span style="color:#1e754f">(</span><span style="color:#59873A">time</span><span style="color:#a65e2b">(</span><span style="color:#2F798A">0</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%d\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#59873A"> rand</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	return</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> main</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	int</span><span style="color:#393A34"> seed</span><span style="color:#999999">;</span><br><span style="color:#59873A">	srand</span><span style="color:#1e754f">(</span><span style="color:#393A34">seed</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%d\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#59873A"> rand</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>调用 <code class="inline-code">rand()</code> 函数会返回一个 <code class="inline-code">[0,RAND_MAX]</code> 中的随机非负整数，其中 <code class="inline-code">RAND_MAX</code> 是标准库中的一个宏，在 Linux 系统下 <code class="inline-code">RAND_MAX</code> 等于 <code class="language-math math-inline">2^{31}-1</code>。可以用取模来限制所生成的数的大小。</p>
<p>使用 <code class="inline-code">rand()</code> 需要一个随机数种子，可以使用 <code class="inline-code">srand(seed)</code> 函数来将随机种子更改为 <code class="inline-code">seed</code>，当然不初始化也是可以的。</p>
<p>同一程序使用相同的 <code class="inline-code">seed</code> 两次运行，在同一机器、同一编译器下，随机出的结果将会是相同的。</p>
<p>有一个选择是使用当前系统时间来作为随机种子：<code class="inline-code">srand(time(0))</code>。</p>
<p>还有用 linux 的 <code class="inline-code">random</code> 和 <code class="inline-code">urandom</code> 设备的，写法大概如下：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">sys/types.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">sys/stat.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">fcntl.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">unistd.h</span><span style="color:#B5695977">></span><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> main</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">    int</span><span style="color:#393A34"> fd </span><span style="color:#999999">=</span><span style="color:#59873A"> open</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">/dev/urandom</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> O_RDONLY</span><span style="color:#999999">,</span><span style="color:#393A34"> S_IRUSR</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">    int</span><span style="color:#393A34"> seed </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#59873A">    read</span><span style="color:#1e754f">(</span><span style="color:#393A34">fd</span><span style="color:#999999">,</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">seed</span><span style="color:#999999">,</span><span style="color:#2F798A"> 4</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>源码分析</a></h2>
<p><code class="inline-code">./stdlib/rand.c</code> 中定义了 <code class="inline-code">rand()</code> 函数</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#A0ADA0">/* Return a random integer between 0 and RAND_MAX.  */</span><br><span style="color:#AB5959">int</span><br><span style="color:#59873A">rand</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">void</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#1E754F">  return</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">int</span><span style="color:#1e754f">)</span><span style="color:#59873A"> __random</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>跟进去看 <code class="inline-code">__random()</code>:</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">long</span><span style="color:#AB5959"> int</span><br><span style="color:#59873A">__random</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">void</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  int32_t</span><span style="color:#393A34"> retval</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">  __libc_lock_lock</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">lock</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#999999">  </span><span style="color:#1e754f">(</span><span style="color:#AB5959">void</span><span style="color:#1e754f">)</span><span style="color:#59873A"> __random_r</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">unsafe_state</span><span style="color:#999999">,</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">retval</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">  __libc_lock_unlock</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">lock</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> retval</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>发现它调用了 <code class="inline-code">__random_r</code>，它的第一个参数 <code class="inline-code">unsafe_state</code> 是一个自定义的结构体：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">static</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> random_data unsafe_state </span><span style="color:#999999">=</span><br><span style="color:#999999">  </span><span style="color:#2993a3">{</span><br><span style="color:#A0ADA0">/* FPTR and RPTR are two pointers into the state info, a front and a rear</span><br><span style="color:#A0ADA0">   pointer.  These two pointers are always rand_sep places aparts, as they</span><br><span style="color:#A0ADA0">   cycle through the state information.  (Yes, this does mean we could get</span><br><span style="color:#A0ADA0">   away with just one pointer, but the code for random is more efficient</span><br><span style="color:#A0ADA0">   this way).  The pointers are left positioned as they would be from the call:</span><br><span style="color:#A0ADA0">    initstate(1, randtbl, 128);</span><br><span style="color:#A0ADA0">   (The position of the rear pointer, rptr, is really 0 (as explained above</span><br><span style="color:#A0ADA0">   in the initialization of randtbl) because the state table pointer is set</span><br><span style="color:#A0ADA0">   to point to randtbl[1] (as explained below).)  */</span><br><br><span style="color:#393A34">    fptr : </span><span style="color:#AB5959">&#x26;</span><span style="color:#B07D48">randtbl</span><span style="color:#1e754f">[</span><span style="color:#393A34">SEP_3 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 1</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><br><span style="color:#393A34">    rptr : </span><span style="color:#AB5959">&#x26;</span><span style="color:#B07D48">randtbl</span><span style="color:#1e754f">[</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><br><br><span style="color:#A0ADA0">/* The following things are the pointer to the state information table,</span><br><span style="color:#A0ADA0">   the type of the current generator, the degree of the current polynomial</span><br><span style="color:#A0ADA0">   being used, and the separation between the two pointers.</span><br><span style="color:#A0ADA0">   Note that for efficiency of random, we remember the first location of</span><br><span style="color:#A0ADA0">   the state information, not the zeroth.  Hence it is valid to access</span><br><span style="color:#A0ADA0">   state[-1], which is used to store the type of the R.N.G.</span><br><span style="color:#A0ADA0">   Also, we remember the last location, since this is more efficient than</span><br><span style="color:#A0ADA0">   indexing every time to find the address of the last element to see if</span><br><span style="color:#A0ADA0">   the front and rear pointers have wrapped.  */</span><br><br><span style="color:#393A34">    state : </span><span style="color:#AB5959">&#x26;</span><span style="color:#B07D48">randtbl</span><span style="color:#1e754f">[</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><br><br><span style="color:#393A34">    rand_type : TYPE_3</span><span style="color:#999999">,</span><br><span style="color:#393A34">    rand_deg : DEG_3</span><span style="color:#999999">,</span><br><span style="color:#393A34">    rand_sep : SEP_3</span><span style="color:#999999">,</span><br><br><span style="color:#393A34">    end_ptr : </span><span style="color:#AB5959">&#x26;</span><span style="color:#B07D48">randtbl</span><span style="color:#1e754f">[</span><span style="color:#AB5959">sizeof</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">randtbl</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> /</span><span style="color:#AB5959"> sizeof</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">randtbl</span><span style="color:#a13865">[</span><span style="color:#2F798A">0</span><span style="color:#a13865">]</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">]</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre></div>
<p>其中：</p>
<ul>
<li>fptr 是循环队列的头指针，初始位置为4</li>
<li>rptr 是循环队列的尾指针，初始位置为1</li>
<li>endptr：指向数组末尾，以指示队列的循环</li>
</ul>
<p>这里又涉及到一个 randtbl 数组，它的定义如下：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">static</span><span style="color:#AB5959"> int32_t</span><span style="color:#B07D48"> randtbl</span><span style="color:#2993a3">[</span><span style="color:#393A34">DEG_3 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">]</span><span style="color:#999999"> =</span><br><span style="color:#999999">  </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">    TYPE_3</span><span style="color:#999999">,</span><br><br><span style="color:#AB5959">    -</span><span style="color:#2F798A">1726662223</span><span style="color:#999999">,</span><span style="color:#2F798A"> 379960547</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1735697613</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1040273694</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1313901226</span><span style="color:#999999">,</span><br><span style="color:#2F798A">    1627687941</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">179304937</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">2073333483</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1780058412</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1989503057</span><span style="color:#999999">,</span><br><span style="color:#AB5959">    -</span><span style="color:#2F798A">615974602</span><span style="color:#999999">,</span><span style="color:#2F798A"> 344556628</span><span style="color:#999999">,</span><span style="color:#2F798A"> 939512070</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1249116260</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1507946756</span><span style="color:#999999">,</span><br><span style="color:#AB5959">    -</span><span style="color:#2F798A">812545463</span><span style="color:#999999">,</span><span style="color:#2F798A"> 154635395</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1388815473</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1926676823</span><span style="color:#999999">,</span><span style="color:#2F798A"> 525320961</span><span style="color:#999999">,</span><br><span style="color:#AB5959">    -</span><span style="color:#2F798A">1009028674</span><span style="color:#999999">,</span><span style="color:#2F798A"> 968117788</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">123449607</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1284210865</span><span style="color:#999999">,</span><span style="color:#2F798A"> 435012392</span><span style="color:#999999">,</span><br><span style="color:#AB5959">    -</span><span style="color:#2F798A">2017506339</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">911064859</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">370259173</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1132637927</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1398500161</span><span style="color:#999999">,</span><br><span style="color:#AB5959">    -</span><span style="color:#2F798A">205601318</span><span style="color:#999999">,</span><br><span style="color:#999999">  </span><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre></div>
<p>这个时候再看一下 <code class="inline-code">__random_r</code> 的算法流程：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">int</span><br><span style="color:#59873A">__random_r</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">struct</span><span style="color:#393A34"> random_data </span><span style="color:#AB5959">*</span><span style="color:#B07D48">buf</span><span style="color:#999999">,</span><span style="color:#AB5959"> int32_t</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">result</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  int32_t</span><span style="color:#AB5959"> *</span><span style="color:#393A34">state</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">buf </span><span style="color:#AB5959">==</span><span style="color:#1E754F"> NULL</span><span style="color:#AB5959"> ||</span><span style="color:#393A34"> result </span><span style="color:#AB5959">==</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    goto</span><span style="color:#393A34"> fail</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">  state </span><span style="color:#999999">=</span><span style="color:#B07D48"> buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">state</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rand_type</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> TYPE_0</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#AB5959">      int32_t</span><span style="color:#393A34"> val </span><span style="color:#999999">=</span><span style="color:#B07D48"> state</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">0</span><span style="color:#a65e2b">]</span><span style="color:#999999">;</span><br><span style="color:#393A34">      val </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#a13865">(</span><span style="color:#B07D48">state</span><span style="color:#bda437">[</span><span style="color:#2F798A">0</span><span style="color:#bda437">]</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 1103515245</span><span style="color:#a13865">)</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 12345</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">7fffffff</span><span style="color:#999999">;</span><br><span style="color:#B07D48">      state</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">0</span><span style="color:#a65e2b">]</span><span style="color:#999999"> =</span><span style="color:#393A34"> val</span><span style="color:#999999">;</span><br><span style="color:#AB5959">      *</span><span style="color:#393A34">result </span><span style="color:#999999">=</span><span style="color:#393A34"> val</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  else</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#AB5959">      int32_t</span><span style="color:#AB5959"> *</span><span style="color:#393A34">fptr </span><span style="color:#999999">=</span><span style="color:#B07D48"> buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">fptr</span><span style="color:#999999">;</span><br><span style="color:#AB5959">      int32_t</span><span style="color:#AB5959"> *</span><span style="color:#393A34">rptr </span><span style="color:#999999">=</span><span style="color:#B07D48"> buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rptr</span><span style="color:#999999">;</span><br><span style="color:#AB5959">      int32_t</span><span style="color:#AB5959"> *</span><span style="color:#393A34">end_ptr </span><span style="color:#999999">=</span><span style="color:#B07D48"> buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">end_ptr</span><span style="color:#999999">;</span><br><span style="color:#AB5959">      int32_t</span><span style="color:#393A34"> val</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">      val </span><span style="color:#999999">=</span><span style="color:#AB5959"> *</span><span style="color:#393A34">fptr </span><span style="color:#AB5959">+=</span><span style="color:#AB5959"> *</span><span style="color:#393A34">rptr</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">      /* Chucking least random bit.  */</span><br><span style="color:#AB5959">      *</span><span style="color:#393A34">result </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">val </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 1</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">7fffffff</span><span style="color:#999999">;</span><br><span style="color:#AB5959">      ++</span><span style="color:#393A34">fptr</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fptr </span><span style="color:#AB5959">></span><span style="color:#AB5959">=</span><span style="color:#393A34"> end_ptr</span><span style="color:#a65e2b">)</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">{</span><br><span style="color:#393A34">	  fptr </span><span style="color:#999999">=</span><span style="color:#393A34"> state</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	  ++</span><span style="color:#393A34">rptr</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">}</span><br><span style="color:#1E754F">      else</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">{</span><br><span style="color:#AB5959">	  ++</span><span style="color:#393A34">rptr</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	  if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">rptr </span><span style="color:#AB5959">></span><span style="color:#AB5959">=</span><span style="color:#393A34"> end_ptr</span><span style="color:#a13865">)</span><br><span style="color:#393A34">	    rptr </span><span style="color:#999999">=</span><span style="color:#393A34"> state</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">}</span><br><span style="color:#B07D48">      buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">fptr</span><span style="color:#999999"> =</span><span style="color:#393A34"> fptr</span><span style="color:#999999">;</span><br><span style="color:#B07D48">      buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rptr</span><span style="color:#999999"> =</span><span style="color:#393A34"> rptr</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><br><span style="color:#393A34"> fail:</span><br><span style="color:#59873A">  __set_errno</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">EINVAL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>注意到这个算法主要有两个流程：</p>
<ul>
<li>如果 <code class="inline-code">buf->rand_type == TYPE_0</code>，那么就是一个非常白给的 LCG，可以随便逆向预测</li>
<li>否则，队头自加队尾值，将此值保存为结果，然后队头队尾统一后移一项，再将结果作为生成的随机数返回。</li>
</ul>
<p>最后来看看 <code class="inline-code">srand</code> 函数，</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">int</span><br><span style="color:#59873A">__srandom_r</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> int</span><span style="color:#B07D48"> seed</span><span style="color:#999999">,</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> random_data </span><span style="color:#AB5959">*</span><span style="color:#B07D48">buf</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> type</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int32_t</span><span style="color:#AB5959"> *</span><span style="color:#393A34">state</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  long</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> i</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int32_t</span><span style="color:#393A34"> word</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int32_t</span><span style="color:#AB5959"> *</span><span style="color:#393A34">dst</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> kc</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">buf </span><span style="color:#AB5959">==</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    goto</span><span style="color:#393A34"> fail</span><span style="color:#999999">;</span><br><span style="color:#393A34">  type </span><span style="color:#999999">=</span><span style="color:#B07D48"> buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rand_type</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> int</span><span style="color:#a65e2b">)</span><span style="color:#393A34"> type </span><span style="color:#AB5959">></span><span style="color:#AB5959">=</span><span style="color:#393A34"> MAX_TYPES</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    goto</span><span style="color:#393A34"> fail</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">  state </span><span style="color:#999999">=</span><span style="color:#B07D48"> buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">state</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">  /* We must make sure the seed is not 0.  Take arbitrarily 1 in this case.  */</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">seed </span><span style="color:#AB5959">==</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><br><span style="color:#393A34">    seed </span><span style="color:#999999">=</span><span style="color:#2F798A"> 1</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  state</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#393A34"> seed</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">type </span><span style="color:#AB5959">==</span><span style="color:#393A34"> TYPE_0</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    goto</span><span style="color:#393A34"> done</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">  dst </span><span style="color:#999999">=</span><span style="color:#393A34"> state</span><span style="color:#999999">;</span><br><span style="color:#393A34">  word </span><span style="color:#999999">=</span><span style="color:#393A34"> seed</span><span style="color:#999999">;</span><br><span style="color:#393A34">  kc </span><span style="color:#999999">=</span><span style="color:#B07D48"> buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rand_deg</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 1</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> kc</span><span style="color:#999999">;</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">i</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#A0ADA0">      /* This does:</span><br><span style="color:#A0ADA0">	   state[i] = (16807 * state[i - 1]) % 2147483647;</span><br><span style="color:#A0ADA0">	 but avoids overflowing 31 bits.  */</span><br><span style="color:#AB5959">      long</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> hi </span><span style="color:#999999">=</span><span style="color:#393A34"> word </span><span style="color:#AB5959">/</span><span style="color:#2F798A"> 127773</span><span style="color:#999999">;</span><br><span style="color:#AB5959">      long</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> lo </span><span style="color:#999999">=</span><span style="color:#393A34"> word </span><span style="color:#AB5959">%</span><span style="color:#2F798A"> 127773</span><span style="color:#999999">;</span><br><span style="color:#393A34">      word </span><span style="color:#999999">=</span><span style="color:#2F798A"> 16807</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> lo </span><span style="color:#AB5959">-</span><span style="color:#2F798A"> 2836</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> hi</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">word </span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 0</span><span style="color:#a65e2b">)</span><br><span style="color:#393A34">	word </span><span style="color:#AB5959">+=</span><span style="color:#2F798A"> 2147483647</span><span style="color:#999999">;</span><br><span style="color:#AB5959">      *++</span><span style="color:#393A34">dst </span><span style="color:#999999">=</span><span style="color:#393A34"> word</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><br><span style="color:#B07D48">  buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">fptr</span><span style="color:#999999"> =</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">state</span><span style="color:#1e754f">[</span><span style="color:#B07D48">buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rand_sep</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rptr</span><span style="color:#999999"> =</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">state</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#393A34">  kc </span><span style="color:#AB5959">*=</span><span style="color:#2F798A"> 10</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  while</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">--</span><span style="color:#393A34">kc </span><span style="color:#AB5959">></span><span style="color:#AB5959">=</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#AB5959">      int32_t</span><span style="color:#393A34"> discard</span><span style="color:#999999">;</span><br><span style="color:#999999">      </span><span style="color:#a65e2b">(</span><span style="color:#AB5959">void</span><span style="color:#a65e2b">)</span><span style="color:#59873A"> __random_r</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">buf</span><span style="color:#999999">,</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">discard</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><br><span style="color:#393A34"> done:</span><br><span style="color:#1E754F">  return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><br><span style="color:#393A34"> fail:</span><br><span style="color:#1E754F">  return</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>可以看出来 <code class="inline-code">srand(0)</code> 和 <code class="inline-code">srand(1)</code> 是一样的。</p>
<p>这个算法会根据 LCG 打乱 state 数组。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>攻击手法</a></h2>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>随机数校验逻辑漏洞</a></h3>
<p>随机数本身无法预测，例如通过 /dev/urandom 设备读入 16 字节，和预测的数字对比，可能在这个对比处存在漏洞点，例如使用了 <code class="inline-code">strcmp()</code> 等可能被 <code class="inline-code">\x00</code> 截断的函数。</p>
<p>这是因为通过 /dev/urandom 读入的字节完全存在第一个字节就是 <code class="inline-code">\x00</code> 的可能（1/255），爆破概率是比较高的。</p>
<p>也有存在栈溢出，把 seed 覆盖掉的打法。</p>
<p>还有使用随机数只加密了部分 shellcode，可以利用 jmp 短跳转跳掉。</p>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>伪随机数预测</a></h3>
<p>显然，<code class="inline-code">rand()</code> 生成的随机数都跟 <code class="inline-code">seed</code> 有强相关性，如果题目里用的 seed 是已知常数，那么可以直接做到预测随机数。</p>
<p>可以写一个 poc <code class="inline-code">gen_random_number.c</code>：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdio.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdlib.h</span><span style="color:#B5695977">></span><br><span style="color:#AB5959">int</span><span style="color:#59873A"> gen_rand</span><span style="color:#2993a3">(</span><span style="color:#AB5959">int</span><span style="color:#B07D48"> seed</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">	srand</span><span style="color:#1e754f">(</span><span style="color:#393A34">seed</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	return</span><span style="color:#59873A"> rand</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>然后编译为动态链接库，然后 python 调用动态链接库。</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-bash language-bash"><span style="color:#59873A">$</span><span style="color:#B56959"> gcc</span><span style="color:#B56959"> A.c</span><span style="color:#A65E2B"> -share</span><span style="color:#A65E2B"> -o</span><span style="color:#B56959"> A.so</span><br></code></pre></div>
<p>模板如下：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-python language-python"><span style="color:#1E754F">from</span><span style="color:#393A34"> ctypes </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#393A34">poc </span><span style="color:#999999">=</span><span style="color:#393A34"> cdll</span><span style="color:#999999">.</span><span style="color:#393A34">LoadLibrary</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">./B.so</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc </span><span style="color:#999999">=</span><span style="color:#393A34"> cdll</span><span style="color:#999999">.</span><span style="color:#393A34">LoadLibrary</span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">/usr/lib/libc.so.6</span><span style="color:#B5695977">'</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">seed </span><span style="color:#999999">=</span><span style="color:#393A34"> poc</span><span style="color:#999999">.</span><span style="color:#393A34">find</span><span style="color:#2993a3">(</span><span style="color:#393A34">num</span><span style="color:#2993a3">)</span><br></code></pre></div>
<p>注意，这个 .so 里的 <code class="inline-code">find</code> 函数不能是 void，如果想接受返回值的话。</p>
<p>在 find 函数里的 printf 输出会晚于 pwntools 的交互。</p>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>基于时间的预测</a></h3>
<p>这个也可以打，因为时间是已知的（把 poc 和题目文件同时运行不就好了）</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdio.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">time.h</span><span style="color:#B5695977">></span><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> gen_rand</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	int</span><span style="color:#393A34"> seed </span><span style="color:#999999">=</span><span style="color:#59873A"> time</span><span style="color:#1e754f">(</span><span style="color:#2F798A">0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	srand</span><span style="color:#1e754f">(</span><span style="color:#393A34">seed</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	return</span><span style="color:#59873A"> rand</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>同样的用法。</p>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>已知一个随机数</a></h3>
<p>对于一个随机的 seed（例如从 /dev/random 或者 /dev/urandom 里读取的），也不是完全不能打。假如题目已经告诉了一个该种子生成的随机数，可以尝试检查 <code class="inline-code">buf->rand_type == TYPE_0</code> 是否成立，而这个要怎么设置呢？可以看 <code class="inline-code">initstate</code> 函数。</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">int</span><br><span style="color:#59873A">__initstate_r</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> int</span><span style="color:#B07D48"> seed</span><span style="color:#999999">,</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">arg_state</span><span style="color:#999999">,</span><span style="color:#AB5959"> size_t</span><span style="color:#B07D48"> n</span><span style="color:#999999">,</span><br><span style="color:#AB5959">	       struct</span><span style="color:#393A34"> random_data </span><span style="color:#AB5959">*</span><span style="color:#B07D48">buf</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">buf </span><span style="color:#AB5959">==</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    goto</span><span style="color:#393A34"> fail</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">  int32_t</span><span style="color:#AB5959"> *</span><span style="color:#393A34">old_state </span><span style="color:#999999">=</span><span style="color:#B07D48"> buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">state</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">old_state </span><span style="color:#AB5959">!=</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#AB5959">      int</span><span style="color:#393A34"> old_type </span><span style="color:#999999">=</span><span style="color:#B07D48"> buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rand_type</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">old_type </span><span style="color:#AB5959">==</span><span style="color:#393A34"> TYPE_0</span><span style="color:#a65e2b">)</span><br><span style="color:#B07D48">	old_state</span><span style="color:#a65e2b">[</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#a65e2b">]</span><span style="color:#999999"> =</span><span style="color:#393A34"> TYPE_0</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      else</span><br><span style="color:#B07D48">	old_state</span><span style="color:#a65e2b">[</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#a65e2b">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">MAX_TYPES </span><span style="color:#AB5959">*</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#B07D48">buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rptr</span><span style="color:#AB5959"> -</span><span style="color:#393A34"> old_state</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> old_type</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> type</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">n </span><span style="color:#AB5959">></span><span style="color:#AB5959">=</span><span style="color:#393A34"> BREAK_3</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0"> // break 3 是 128</span><br><span style="color:#393A34">    type </span><span style="color:#999999">=</span><span style="color:#393A34"> n </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> BREAK_4 </span><span style="color:#AB5959">?</span><span style="color:#393A34"> TYPE_3 </span><span style="color:#AB5959">:</span><span style="color:#393A34"> TYPE_4</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  else</span><span style="color:#1E754F"> if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">n </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> BREAK_1</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0"> // break 1 是 32</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">n </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> BREAK_0</span><span style="color:#a65e2b">)</span><span style="color:#A0ADA0"> // break 0 是 0</span><br><span style="color:#1E754F">	goto</span><span style="color:#393A34"> fail</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">      type </span><span style="color:#999999">=</span><span style="color:#393A34"> TYPE_0</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  else</span><br><span style="color:#393A34">    type </span><span style="color:#999999">=</span><span style="color:#393A34"> n </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> BREAK_2 </span><span style="color:#AB5959">?</span><span style="color:#393A34"> TYPE_1 </span><span style="color:#AB5959">:</span><span style="color:#393A34"> TYPE_2</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> degree </span><span style="color:#999999">=</span><span style="color:#B07D48"> random_poly_info</span><span style="color:#999999">.</span><span style="color:#B07D48">degrees</span><span style="color:#1e754f">[</span><span style="color:#393A34">type</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> separation </span><span style="color:#999999">=</span><span style="color:#B07D48"> random_poly_info</span><span style="color:#999999">.</span><span style="color:#B07D48">seps</span><span style="color:#1e754f">[</span><span style="color:#393A34">type</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">  buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rand_type</span><span style="color:#999999"> =</span><span style="color:#393A34"> type</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rand_sep</span><span style="color:#999999"> =</span><span style="color:#393A34"> separation</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rand_deg</span><span style="color:#999999"> =</span><span style="color:#393A34"> degree</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int32_t</span><span style="color:#AB5959"> *</span><span style="color:#393A34">state </span><span style="color:#999999">=</span><span style="color:#AB5959"> &#x26;</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#AB5959">int32_t</span><span style="color:#AB5959"> *</span><span style="color:#a65e2b">)</span><span style="color:#393A34"> arg_state</span><span style="color:#1e754f">)</span><span style="color:#1e754f">[</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><span style="color:#A0ADA0">	/* First location.  */</span><br><span style="color:#A0ADA0">  /* Must set END_PTR before srandom.  */</span><br><span style="color:#B07D48">  buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">end_ptr</span><span style="color:#999999"> =</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">state</span><span style="color:#1e754f">[</span><span style="color:#393A34">degree</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">  buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">state</span><span style="color:#999999"> =</span><span style="color:#393A34"> state</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">  __srandom_r</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">seed</span><span style="color:#999999">,</span><span style="color:#393A34"> buf</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">  state</span><span style="color:#1e754f">[</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#393A34"> TYPE_0</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">type </span><span style="color:#AB5959">!=</span><span style="color:#393A34"> TYPE_0</span><span style="color:#1e754f">)</span><br><span style="color:#B07D48">    state</span><span style="color:#1e754f">[</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">buf</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">rptr</span><span style="color:#AB5959"> -</span><span style="color:#393A34"> state</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> MAX_TYPES </span><span style="color:#AB5959">+</span><span style="color:#393A34"> type</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><br><span style="color:#393A34"> fail:</span><br><span style="color:#59873A">  __set_errno</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">EINVAL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>所以只要调用 <code class="inline-code">initstate(seed, arg_state, 8)</code> 之类的就可以设置了。</p>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>已知多个随机数</a></h3>
<p>这个攻击方式的原理是，对于一个给定的种子，其后续生成的随机数序列都是唯一确定的。</p>
<p>在<a href="https://www.mscs.dal.ca/~selinger/random/" title="https://www.mscs.dal.ca/~selinger/random/" target="_blank" rel="noopener">这篇文章</a>中，详细介绍了 GLIBC 随机数生成器的 LCG 原理。基于此，可以写出一个简单的 rand 复现：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdio.h</span><span style="color:#B5695977">></span><br><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> MAX</span><span style="color:#2F798A"> 1000</span><br><br><span style="color:#AB5959">void</span><span style="color:#59873A"> myrand</span><span style="color:#2993a3">(</span><span style="color:#AB5959">int</span><span style="color:#B07D48"> seed</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  int</span><span style="color:#B07D48"> r</span><span style="color:#1e754f">[</span><span style="color:#393A34">MAX</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> i</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">  r</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#393A34"> seed</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">i</span><span style="color:#999999">=</span><span style="color:#2F798A">1</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A">31</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">++</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#B07D48">    r</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#a65e2b">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#2F798A">16807</span><span style="color:#AB5959">LL</span><span style="color:#AB5959"> *</span><span style="color:#B07D48"> r</span><span style="color:#a13865">[</span><span style="color:#393A34">i</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#a13865">]</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> %</span><span style="color:#2F798A"> 2147483647</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">r</span><span style="color:#a13865">[</span><span style="color:#393A34">i</span><span style="color:#a13865">]</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 0</span><span style="color:#a65e2b">)</span><span style="color:#999999"> </span><span style="color:#a65e2b">{</span><br><span style="color:#B07D48">      r</span><span style="color:#a13865">[</span><span style="color:#393A34">i</span><span style="color:#a13865">]</span><span style="color:#AB5959"> +=</span><span style="color:#2F798A"> 2147483647</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">}</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">i</span><span style="color:#999999">=</span><span style="color:#2F798A">31</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A">34</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">++</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#B07D48">    r</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#a65e2b">]</span><span style="color:#999999"> =</span><span style="color:#B07D48"> r</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#AB5959">-</span><span style="color:#2F798A">31</span><span style="color:#a65e2b">]</span><span style="color:#999999">;</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">i</span><span style="color:#999999">=</span><span style="color:#2F798A">34</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A">344</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">++</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#B07D48">    r</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#a65e2b">]</span><span style="color:#999999"> =</span><span style="color:#B07D48"> r</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#AB5959">-</span><span style="color:#2F798A">31</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> +</span><span style="color:#B07D48"> r</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#AB5959">-</span><span style="color:#2F798A">3</span><span style="color:#a65e2b">]</span><span style="color:#999999">;</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">i</span><span style="color:#999999">=</span><span style="color:#2F798A">344</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34">MAX</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">++</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#B07D48">    r</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#a65e2b">]</span><span style="color:#999999"> =</span><span style="color:#B07D48"> r</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#AB5959">-</span><span style="color:#2F798A">31</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> +</span><span style="color:#B07D48"> r</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#AB5959">-</span><span style="color:#2F798A">3</span><span style="color:#a65e2b">]</span><span style="color:#999999">;</span><br><span style="color:#59873A">    printf</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%d\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#bda437">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> int</span><span style="color:#bda437">)</span><span style="color:#B07D48">r</span><span style="color:#bda437">[</span><span style="color:#393A34">i</span><span style="color:#bda437">]</span><span style="color:#a13865">)</span><span style="color:#AB5959"> </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 1</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>由此可知，在一个确定的随机种子下的序列中，下一个随机数的生成公式为：</p>
<p><code class="language-math math-inline">randlist_l = (randlist_{l-3}+randlist_{l-31}) % 2147483648</code></p>
<p>于是，如果题目中可以泄漏多个给定种子的随机数，那么可以预测出在某个随机数后的所有随机数。</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>