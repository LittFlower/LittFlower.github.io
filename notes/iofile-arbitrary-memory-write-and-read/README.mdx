<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>_IO_FILE 任意地址读写攻击面分析 | 花盆</title><meta name="author" content="LittFlower"/><meta property="og:title" content="_IO_FILE 任意地址读写攻击面分析 | 花盆"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/notes/iofile-arbitrary-memory-write-and-read/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="stylesheet" href="/fonts.css" type="text/css" preload/><link rel="stylesheet" href="/style.css" type="text/css" preload/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="_io_file" class="scroll-target"><a href="#_io_file"><code class="hash inline-code">#</code>_IO_FILE 任意地址读写攻击面分析</a></h1>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>简介</a></h2>
<p>FILE 在 Linux 系统的标准 IO 库中是用于描述文件的结构，称为文件流。 FILE 结构在程序执行 fopen 等函数时会进行创建，并分配在堆中。我们常定义一个指向 FILE 结构的指针来接收这个返回值。</p>
<p>在标准 I/O 库中，每个程序启动时有三个文件流是自动打开的：stdin、stdout、stderr。因此在初始状态下，_IO_list_all 指向了一个有这些文件流构成的链表，但是需要注意的是这三个文件流位于 libc.so 的数据段。而我们使用 fopen 创建的文件流是分配在堆内存上的。</p>
<p><code class="inline-code">FILE</code> 的结构这里不再详细描述了，之前学 apple 的时候已经看过了，简单来说在 pwndbg 调试时，可以 <code class="inline-code">p _IO_2_1_stdin</code> 查看它们的详细结构。</p>
<p>这里主要介绍一下比较常用的指针：</p>
<ul>
<li><code class="inline-code">_IO_buf_base</code>：输入（出）缓冲区的基地址，例如 <code class="inline-code">_IO_file_xsgetn</code> 函数会通过它来判断输入缓冲区是否为空，为空则会调用 <code class="inline-code">_IO_doallocbuf</code> 函数来进行初始化。</li>
<li><code class="inline-code">_IO_buf_end</code>：输入（出）缓冲区的结束地址。</li>
</ul>
<p>在建立输入输出缓冲区后，如果缓冲区作为输入缓冲区使用，则会将 <code class="inline-code">_IO_buf_base</code> 基地址赋值给 <code class="inline-code">_IO_read_base</code>，结束地址 <code class="inline-code">_IO_buf_end</code> 赋值给 <code class="inline-code">_IO_read_end</code></p>
<ul>
<li><code class="inline-code">_IO_read_ptr</code>：指向当前已经写入的地址。</li>
<li><code class="inline-code">_IO_read_base</code>：输入缓冲区的基地址。</li>
<li><code class="inline-code">_IO_read_end</code>：一般和 <code class="inline-code">_IO_read_ptr</code> 共同使用，<code class="inline-code">_IO_read_end-_IO_read_ptr</code> 表示可用的输入缓冲区大小。</li>
</ul>
<p>如果缓冲区作为输出缓冲区使用则同理。</p>
<p>而我们在 CTF 题目中非常常见的一个初始化函数是：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#59873A">setvbuf</span><span style="color:#2993a3">(</span><span style="color:#393A34">stdin</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">setvbuf</span><span style="color:#2993a3">(</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">setvbuf</span><span style="color:#2993a3">(</span><span style="color:#393A34">stderr</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre></div>
<p>这个函数的作用是设置 <code class="inline-code">_IO_buf_end - _IO_buf_base = 1</code>，这样的效果是缓冲区长度只有 1，也就是 1 字节输入/出一次。</p>
<p>另一个比较常用的指针是 <code class="inline-code">_flags</code>，这个常量的定义在 <code class="inline-code">glibc/libio/libio.h</code>：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#A0ADA0">/* Magic number and bits for the _flags field.  The magic number is</span><br><span style="color:#A0ADA0">mostly vestigial, but preserved for compatibility.  It occupies the</span><br><span style="color:#A0ADA0">high 16 bits of _flags; the low 16 bits are actual flag bits.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_MAGIC</span><span style="color:#AB5959">         0x</span><span style="color:#2F798A">FBAD0000</span><span style="color:#A0ADA0"> /* Magic number */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_MAGIC_MASK</span><span style="color:#AB5959">    0x</span><span style="color:#2F798A">FFFF0000</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_USER_BUF</span><span style="color:#AB5959">          0x</span><span style="color:#2F798A">0001</span><span style="color:#A0ADA0"> /* Don't deallocate buffer on close. */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_UNBUFFERED</span><span style="color:#AB5959">        0x</span><span style="color:#2F798A">0002</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_NO_READS</span><span style="color:#AB5959">          0x</span><span style="color:#2F798A">0004</span><span style="color:#A0ADA0"> /* Reading not allowed.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_NO_WRITES</span><span style="color:#AB5959">         0x</span><span style="color:#2F798A">0008</span><span style="color:#A0ADA0"> /* Writing not allowed.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_EOF_SEEN</span><span style="color:#AB5959">          0x</span><span style="color:#2F798A">0010</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_ERR_SEEN</span><span style="color:#AB5959">          0x</span><span style="color:#2F798A">0020</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_DELETE_DONT_CLOSE</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0040</span><span style="color:#A0ADA0"> /* Don't call close(_fileno) on close.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_LINKED</span><span style="color:#AB5959">            0x</span><span style="color:#2F798A">0080</span><span style="color:#A0ADA0"> /* In the list of all open files.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_IN_BACKUP</span><span style="color:#AB5959">         0x</span><span style="color:#2F798A">0100</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_LINE_BUF</span><span style="color:#AB5959">          0x</span><span style="color:#2F798A">0200</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_TIED_PUT_GET</span><span style="color:#AB5959">      0x</span><span style="color:#2F798A">0400</span><span style="color:#A0ADA0"> /* Put and get pointer move in unison.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_CURRENTLY_PUTTING</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0800</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_IS_APPENDING</span><span style="color:#AB5959">      0x</span><span style="color:#2F798A">1000</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_IS_FILEBUF</span><span style="color:#AB5959">        0x</span><span style="color:#2F798A">2000</span><br><span style="color:#A0ADA0">/* 0x4000  No longer used, reserved for compat.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_USER_LOCK</span><span style="color:#AB5959">         0x</span><span style="color:#2F798A">8000</span><br></code></pre></div>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>原理</a></h2>
<h3 id="stdin" class="scroll-target"><a href="#stdin"><code class="hash inline-code">#</code>stdin 攻击面分析</a></h3>
<p>以 <code class="inline-code">scanf</code> 函数为例子：</p>
<p><code class="inline-code">scanf</code> 函数在 glibc 的 <code class="inline-code">stdio-common/scanf.c</code> 里，是 <code class="inline-code">__scanf</code>，如下：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">int</span><br><span style="color:#59873A">__scanf</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">format</span><span style="color:#999999">,</span><span style="color:#999999"> ...</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#393A34">  va_list arg</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> done</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">  va_start</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">arg</span><span style="color:#999999">,</span><span style="color:#393A34"> format</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  done </span><span style="color:#999999">=</span><span style="color:#59873A"> _IO_vfscanf</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">stdin</span><span style="color:#999999">,</span><span style="color:#393A34"> format</span><span style="color:#999999">,</span><span style="color:#393A34"> arg</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  va_end</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">arg</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> done</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><span style="color:#59873A">ldbl_strong_alias</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">__scanf</span><span style="color:#999999">,</span><span style="color:#393A34"> scanf</span><span style="color:#2993a3">)</span><span style="color:#A0ADA0"> // 这里可以看到，glibc 把 __scanf 强绑定到了 scanf 上</span><br></code></pre></div>
<p>调用了 <code class="inline-code">_IO_vfscanf</code>，它在 <code class="inline-code">stdio-common/vfscanf.c</code>，如下：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">int</span><br><span style="color:#59873A">___vfscanf</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">FILE </span><span style="color:#AB5959">*</span><span style="color:#B07D48">s</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">format</span><span style="color:#999999">,</span><span style="color:#393A34"> va_list </span><span style="color:#B07D48">argptr</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#1E754F">  return</span><span style="color:#59873A"> _IO_vfscanf_internal</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">s</span><span style="color:#999999">,</span><span style="color:#393A34"> format</span><span style="color:#999999">,</span><span style="color:#393A34"> argptr</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><span style="color:#59873A">ldbl_strong_alias</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_vfscanf_internal</span><span style="color:#999999">,</span><span style="color:#393A34"> _IO_vfscanf</span><span style="color:#2993a3">)</span><br><span style="color:#59873A">ldbl_hidden_def</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_vfscanf_internal</span><span style="color:#999999">,</span><span style="color:#393A34"> _IO_vfscanf</span><span style="color:#2993a3">)</span><br><span style="color:#59873A">ldbl_strong_alias</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">___vfscanf</span><span style="color:#999999">,</span><span style="color:#393A34"> __vfscanf</span><span style="color:#2993a3">)</span><br><span style="color:#59873A">ldbl_hidden_def</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">___vfscanf</span><span style="color:#999999">,</span><span style="color:#393A34"> __vfscanf</span><span style="color:#2993a3">)</span><br><span style="color:#59873A">ldbl_weak_alias</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">___vfscanf</span><span style="color:#999999">,</span><span style="color:#393A34"> vfscanf</span><span style="color:#2993a3">)</span><br></code></pre></div>
<p>这里发现主要起作用的是 <code class="inline-code">_IO_vfscanf_internal</code>，这个函数很长，关注关键调用：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F"> define</span><span style="color:#59873A"> inchar</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">	</span><span style="color:#2993a3">(</span><span style="color:#393A34">c </span><span style="color:#AB5959">==</span><span style="color:#393A34"> EOF </span><span style="color:#AB5959">?</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#393A34">errno </span><span style="color:#999999">=</span><span style="color:#393A34"> inchar_errno</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><span style="color:#393A34"> EOF</span><span style="color:#1e754f">)</span><span style="color:#A65E2B">	      \</span><br><span style="color:#AB5959">			 :</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#393A34">c </span><span style="color:#999999">=</span><span style="color:#59873A"> _IO_getc_unlocked</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">s</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><span style="color:#A65E2B">		      \</span><br><span style="color:#999999">			    </span><span style="color:#a65e2b">(</span><span style="color:#AB5959">void</span><span style="color:#a65e2b">)</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">c </span><span style="color:#AB5959">!=</span><span style="color:#393A34"> EOF				      </span><span style="color:#A65E2B">\</span><br><span style="color:#AB5959">				    ?</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">read_in				      </span><span style="color:#A65E2B">\</span><br><span style="color:#AB5959">				    :</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#AB5959">size_t</span><span style="color:#a13865">)</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">inchar_errno </span><span style="color:#999999">=</span><span style="color:#393A34"> errno</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><span style="color:#393A34"> c</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">int</span><br><span style="color:#59873A">_IO_vfscanf_internal</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_FILE </span><span style="color:#AB5959">*</span><span style="color:#B07D48">s</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">format</span><span style="color:#999999">,</span><span style="color:#393A34"> _IO_va_list </span><span style="color:#B07D48">argptr</span><span style="color:#999999">,</span><br><span style="color:#AB5959">		      int</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">errp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#393A34">	...</span><br><span style="color:#A0ADA0">	  /* Run through the format string.  */</span><br><span style="color:#1E754F">  while</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">f </span><span style="color:#AB5959">!=</span><span style="color:#B5695977"> '</span><span style="color:#A65E2B">\0</span><span style="color:#B5695977">'</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">		...</span><br><span style="color:#393A34">	  fc </span><span style="color:#999999">=</span><span style="color:#AB5959"> *</span><span style="color:#393A34">f</span><span style="color:#AB5959">++</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	  if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fc </span><span style="color:#AB5959">!=</span><span style="color:#B5695977"> '</span><span style="color:#B56959">%</span><span style="color:#B5695977">'</span><span style="color:#a65e2b">)</span><br><span style="color:#999999">		</span><span style="color:#a65e2b">{</span><br><span style="color:#A0ADA0">		  /* Remember to skip spaces.  */</span><br><span style="color:#1E754F">		  if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#59873A">ISSPACE</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#393A34">fc</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><br><span style="color:#999999">		    </span><span style="color:#a13865">{</span><br><span style="color:#393A34">		      skip_space </span><span style="color:#999999">=</span><span style="color:#2F798A"> 1</span><span style="color:#999999">;</span><br><span style="color:#1E754F">		      continue</span><span style="color:#999999">;</span><br><span style="color:#999999">		    </span><span style="color:#a13865">}</span><br><br><span style="color:#A0ADA0">		  /* Read a character.  */</span><br><span style="color:#393A34">	  c </span><span style="color:#999999">=</span><span style="color:#59873A"> inchar</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">		...</span><br><span style="color:#999999">	  </span><span style="color:#a65e2b">}</span><br><span style="color:#393A34">	  ...</span><br><span style="color:#999999">	</span><span style="color:#1e754f">}</span><br><span style="color:#393A34">	...</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>这里调用的 <code class="inline-code">inchar ()</code> 会去调用 <code class="inline-code">_IO_getc_unlocked</code>:</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_getc_unlocked</span><span style="color:#2993a3">(</span><span style="color:#B07D48">_fp</span><span style="color:#2993a3">)</span><span style="color:#A65E2B"> \</span><br><span style="color:#999999">       </span><span style="color:#2993a3">(</span><span style="color:#59873A">_IO_BE</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#393A34">_fp</span><span style="color:#a65e2b">)</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#AB5959"> </span><span style="color:#AB5959">></span><span style="color:#AB5959">=</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">_fp</span><span style="color:#a65e2b">)</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#A65E2B"> \</span><br><span style="color:#AB5959">	?</span><span style="color:#59873A"> __uflow</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">_fp</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> :</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">_fp</span><span style="color:#1e754f">)</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#AB5959">++</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">int</span><br><span style="color:#59873A">__uflow</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_FILE </span><span style="color:#AB5959">*</span><span style="color:#B07D48">fp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#999999">#</span><span style="color:#1E754F">if</span><span style="color:#1E754F"> defined</span><span style="color:#59873A"> _LIBC</span><span style="color:#AB5959"> ||</span><span style="color:#1E754F"> defined</span><span style="color:#59873A"> _GLIBCPP_USE_WCHAR_T</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">_IO_vtable_offset</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ==</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> &#x26;&#x26;</span><span style="color:#59873A"> _IO_fwide</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> !=</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> EOF</span><span style="color:#999999">;</span><br><span style="color:#999999">#</span><span style="color:#1E754F">endif</span><br><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_mode</span><span style="color:#AB5959"> ==</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><br><span style="color:#59873A">    _IO_fwide</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">fp</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">_IO_in_put_mode</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">_IO_switch_to_get_mode</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> EOF</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">      return</span><span style="color:#393A34"> EOF</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    return</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">)</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#AB5959">++</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">_IO_in_backup</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#59873A">      _IO_switch_to_main_get_area</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">	return</span><span style="color:#AB5959"> *</span><span style="color:#a65e2b">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#a65e2b">)</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#AB5959">++</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">_IO_have_markers</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">save_for_backup</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">fp</span><span style="color:#999999">,</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">	return</span><span style="color:#393A34"> EOF</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  else</span><span style="color:#1E754F"> if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">_IO_have_backup</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0">  // 注意这里</span><br><span style="color:#59873A">    _IO_free_backup_area</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">fp</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#59873A"> _IO_UFLOW</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">fp</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_UFLOW</span><span style="color:#2993a3">(</span><span style="color:#B07D48">FP</span><span style="color:#2993a3">)</span><span style="color:#59873A"> JUMP0</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">__uflow</span><span style="color:#999999">,</span><span style="color:#393A34"> FP</span><span style="color:#2993a3">)</span><br><br></code></pre></div>
<p>然后这里会调用 <code class="inline-code">_IO_UFLOW</code>，也就是通过虚标跳到 <code class="inline-code">__uflow</code>，然后会 jump 到 <code class="inline-code">_IO_underflow_t</code>，然后这个虚表函数会指向 <code class="inline-code">_IO_file_underflow</code>：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F"> define</span><span style="color:#59873A"> _IO_new_file_underflow</span><span style="color:#393A34"> _IO_file_underflow</span><br><br><span style="color:#AB5959">int</span><br><span style="color:#59873A">_IO_new_file_underflow</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_FILE </span><span style="color:#AB5959">*</span><span style="color:#B07D48">fp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#998418">  _IO_ssize_t</span><span style="color:#393A34"> count</span><span style="color:#999999">;</span><br><span style="color:#999999">#</span><span style="color:#1E754F">if</span><span style="color:#2F798A"> 0</span><br><span style="color:#A0ADA0">  /* SysV does not make this test; take it out for compatibility */</span><br><span style="color:#A0ADA0">  if (fp->_flags &#x26; _IO_EOF_SEEN)</span><br><span style="color:#A0ADA0">    return (EOF);</span><br><span style="color:#999999">#</span><span style="color:#1E754F">endif</span><br><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34"> _IO_NO_READS</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0">  // 需要过的 check1</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#B07D48">      fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> |=</span><span style="color:#393A34"> _IO_ERR_SEEN</span><span style="color:#999999">;</span><br><span style="color:#59873A">      __set_errno</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">EBADF</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      return</span><span style="color:#393A34"> EOF</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0">  // 需要过的 check2</span><br><span style="color:#1E754F">    return</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">)</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#AB5959"> ==</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0">  // 需要过的 check3</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#A0ADA0">      /* Maybe we already have a push back pointer.  */</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_save_base</span><span style="color:#AB5959"> !=</span><span style="color:#1E754F"> NULL</span><span style="color:#a65e2b">)</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">{</span><br><span style="color:#59873A">	  free</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_save_base</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">	  fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> &#x26;=</span><span style="color:#AB5959"> ~</span><span style="color:#393A34">_IO_IN_BACKUP</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">}</span><br><span style="color:#59873A">      _IO_doallocbuf</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><br><span style="color:#393A34">  ...</span><br><br><span style="color:#59873A">  _IO_switch_to_get_mode</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">fp</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">  // 注意下面三行</span><br><span style="color:#A0ADA0">  // 也就是：_IO_new_file_underflow 中在执行系统调用之前会设置一次 FILE 指针，将</span><br><span style="color:#A0ADA0">  // _IO_read_base、_IO_read_ptr、_IO_read_end、</span><br><span style="color:#A0ADA0">  // _IO_write_base、IO_write_ptr、IO_write_end</span><br><span style="color:#A0ADA0">  // 全部设置为 _IO_buf_base。</span><br><br><span style="color:#A0ADA0">  /* This is very tricky. We have to adjust those</span><br><span style="color:#A0ADA0">     pointers before we call _IO_SYSREAD () since</span><br><span style="color:#A0ADA0">     we may longjump () out while waiting for</span><br><span style="color:#A0ADA0">     input. Those pointers may be screwed up. H.J. */</span><br><span style="color:#B07D48">  fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_base</span><span style="color:#999999"> =</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#999999"> =</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#999999"> =</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_base</span><span style="color:#999999"> =</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#999999"> =</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_end</span><br><span style="color:#999999">    =</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">  count </span><span style="color:#999999">=</span><span style="color:#59873A"> _IO_SYSREAD</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">fp</span><span style="color:#999999">,</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">,</span><br><span style="color:#B07D48">		       fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_end</span><span style="color:#AB5959"> -</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // 重点关注这里</span><br><span style="color:#393A34">  ...</span><br><span style="color:#B07D48">  fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#AB5959"> +=</span><span style="color:#393A34"> count</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 关注这里</span><br><span style="color:#393A34">  ...</span><br><span style="color:#1E754F">  return</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">)</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><span style="color:#59873A">libc_hidden_ver</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_new_file_underflow</span><span style="color:#999999">,</span><span style="color:#393A34"> _IO_file_underflow</span><span style="color:#2993a3">)</span><br></code></pre></div>
<p>这个 <code class="inline-code">_IO_SYSREAD</code> 会调用虚表里的 <code class="inline-code">__read</code> 也就是 <code class="inline-code">__GI__IO_file_read</code>，这个函数会 <code class="inline-code">jmp</code> 到 <code class="inline-code">__GI___libc_read</code>。</p>
<p>总结下来调用链就是：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-text">scanf
  -> vfscanf
	-> _IO_vfscanf_internal
	  -> _IO_getc_unlocked
		-> __uflow
		  -> _IO_new_file_underflow
			-> _IO_SYSREAD
			  -> __read = __GI___libc_read
</code></pre></div>
<p>为了绕过保护，需要构造有：</p>
<ul>
<li>设置 <code class="inline-code">fp->_flags &amp; (~0x4)</code>（这里最好就是用原来的 <code class="inline-code">_flags</code>）（也就是要设置倒数第二字节为 <code class="inline-code">\x00</code>）</li>
<li>设置 <code class="inline-code">_IO_read_end</code> 等于 <code class="inline-code">_IO_read_ptr</code></li>
<li>设置 <code class="inline-code">_fileno == 0</code></li>
<li>设置 <code class="inline-code">fp->_IO_buf_base</code> 为写入的起始位置，<code class="inline-code">fp->_IO_buf_end</code> 为写入的终止位置，<code class="inline-code">fp->_IO_buf_end - fp->_IO_buf_base</code> 为读入的长度</li>
<li><code class="inline-code">_IO_write_xxx</code> 不能随便写，保持原来的值</li>
<li><code class="inline-code">_IO_save_base</code> 不要写东西，这个是因为下面这个函数：</li>
</ul>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _IO_have_backup</span><span style="color:#2993a3">(</span><span style="color:#B07D48">fp</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">fp</span><span style="color:#1e754f">)</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_save_base</span><span style="color:#AB5959"> !=</span><span style="color:#1E754F"> NULL</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">void</span><br><span style="color:#59873A">_IO_free_backup_area</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_FILE </span><span style="color:#AB5959">*</span><span style="color:#B07D48">fp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">_IO_in_backup</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><br><span style="color:#59873A">    _IO_switch_to_main_get_area</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">fp</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  /* Just in case. */</span><br><span style="color:#59873A">  free</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_save_base</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_save_base</span><span style="color:#999999"> =</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_save_end</span><span style="color:#999999"> =</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_backup_base</span><span style="color:#999999"> =</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><span style="color:#59873A">libc_hidden_def</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_free_backup_area</span><span style="color:#2993a3">)</span><br></code></pre></div>
<p>这里会 <code class="inline-code">free</code> 一个地址，如果不合法的话程序就会 dump。</p>
<p>一个思路：这里可以释放任意合法 chunk，不过感觉没什么用。</p>
<p>可以看到，如想通过 <code class="inline-code">stdin</code> 打任意地址写，需要修改的字节还是比较多的。</p>
<p>另外，<code class="inline-code">fread</code>、<code class="inline-code">fgets</code> 等函数也是调用 stdin 中的 <code class="inline-code">_IO_new_file_underflow</code> 去调用 <code class="inline-code">read</code> 的。</p>
<p>一个 trick 是，假如只能任意地址修改有限字节，可以先改 <code class="inline-code">fp->_IO_buf_base</code>，然后二次修改。</p>
<h3 id="stdout" class="scroll-target"><a href="#stdout"><code class="hash inline-code">#</code>stdout 攻击面分析</a></h3>
<p>以 <code class="inline-code">puts</code> 为例。</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">int</span><br><span style="color:#59873A">_IO_puts</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">str</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> result </span><span style="color:#999999">=</span><span style="color:#393A34"> EOF</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  size_t</span><span style="color:#393A34"> len </span><span style="color:#999999">=</span><span style="color:#59873A"> strlen</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">str</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  _IO_acquire_lock</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">stdout</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#59873A">_IO_vtable_offset</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">stdout</span><span style="color:#a13865">)</span><span style="color:#AB5959"> !=</span><span style="color:#2F798A"> 0</span><br><span style="color:#AB5959">       ||</span><span style="color:#59873A"> _IO_fwide</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#a13865">)</span><span style="color:#AB5959"> ==</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#a65e2b">)</span><br><span style="color:#AB5959">      &#x26;&#x26;</span><span style="color:#59873A"> _IO_sputn</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#393A34"> str</span><span style="color:#999999">,</span><span style="color:#393A34"> len</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> len</span><span style="color:#A0ADA0">  // 关注这里</span><br><span style="color:#AB5959">      &#x26;&#x26;</span><span style="color:#59873A"> _IO_putc_unlocked</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B5695977">'</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#393A34"> stdout</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> !=</span><span style="color:#393A34"> EOF</span><span style="color:#1e754f">)</span><br><span style="color:#393A34">    result </span><span style="color:#999999">=</span><span style="color:#59873A"> MIN</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">INT_MAX</span><span style="color:#999999">,</span><span style="color:#393A34"> len </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 1</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">  _IO_release_lock</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">stdout</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> result</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>可以看到调用了 <code class="inline-code">_IO_sputn</code>，跟进分析：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">size_t</span><br><span style="color:#59873A">_IO_new_file_xsputn</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">FILE </span><span style="color:#AB5959">*</span><span style="color:#B07D48">f</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">data</span><span style="color:#999999">,</span><span style="color:#AB5959"> size_t</span><span style="color:#B07D48"> n</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#393A34">s </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">)</span><span style="color:#393A34"> data</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  size_t</span><span style="color:#393A34"> to_do </span><span style="color:#999999">=</span><span style="color:#393A34"> n</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> must_flush </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  size_t</span><span style="color:#393A34"> count </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">n </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">=</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">  /* This is an optimized implementation.</span><br><span style="color:#A0ADA0">     If the amount to be written straddles a block boundary</span><br><span style="color:#A0ADA0">     (or the filebuf is unbuffered), use sys_write directly. */</span><br><br><span style="color:#A0ADA0">  /* First figure out how much space is available in the buffer. */</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34"> _IO_LINE_BUF</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> &#x26;&#x26;</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34"> _IO_CURRENTLY_PUTTING</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">      count </span><span style="color:#999999">=</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_end</span><span style="color:#AB5959"> -</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">count </span><span style="color:#AB5959">></span><span style="color:#AB5959">=</span><span style="color:#393A34"> n</span><span style="color:#a65e2b">)</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">{</span><br><span style="color:#AB5959">	  const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#393A34">p</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	  for</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">p </span><span style="color:#999999">=</span><span style="color:#393A34"> s </span><span style="color:#AB5959">+</span><span style="color:#393A34"> n</span><span style="color:#999999">;</span><span style="color:#393A34"> p </span><span style="color:#AB5959">></span><span style="color:#393A34"> s</span><span style="color:#999999">;</span><span style="color:#999999"> </span><span style="color:#a13865">)</span><br><span style="color:#999999">	    </span><span style="color:#a13865">{</span><br><span style="color:#1E754F">	      if</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#AB5959">*--</span><span style="color:#393A34">p </span><span style="color:#AB5959">==</span><span style="color:#B5695977"> '</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">'</span><span style="color:#bda437">)</span><br><span style="color:#999999">		</span><span style="color:#bda437">{</span><br><span style="color:#393A34">		  count </span><span style="color:#999999">=</span><span style="color:#393A34"> p </span><span style="color:#AB5959">-</span><span style="color:#393A34"> s </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 1</span><span style="color:#999999">;</span><br><span style="color:#393A34">		  must_flush </span><span style="color:#999999">=</span><span style="color:#2F798A"> 1</span><span style="color:#999999">;</span><br><span style="color:#1E754F">		  break</span><span style="color:#999999">;</span><br><span style="color:#999999">		</span><span style="color:#bda437">}</span><br><span style="color:#999999">	    </span><span style="color:#a13865">}</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">}</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  else</span><span style="color:#1E754F"> if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_end</span><span style="color:#AB5959"> </span><span style="color:#AB5959">></span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#1e754f">)</span><br><span style="color:#393A34">    count </span><span style="color:#999999">=</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_end</span><span style="color:#AB5959"> -</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> /* Space available. */</span><br><br><span style="color:#A0ADA0">  /* Then fill the buffer. */</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">count </span><span style="color:#AB5959">></span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">count </span><span style="color:#AB5959">></span><span style="color:#393A34"> to_do</span><span style="color:#a65e2b">)</span><br><span style="color:#393A34">	count </span><span style="color:#999999">=</span><span style="color:#393A34"> to_do</span><span style="color:#999999">;</span><br><span style="color:#B07D48">      f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#999999"> =</span><span style="color:#59873A"> __mempcpy</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#999999">,</span><span style="color:#393A34"> s</span><span style="color:#999999">,</span><span style="color:#393A34"> count</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // 注意这里1️⃣</span><br><span style="color:#393A34">      s </span><span style="color:#AB5959">+=</span><span style="color:#393A34"> count</span><span style="color:#999999">;</span><br><span style="color:#393A34">      to_do </span><span style="color:#AB5959">-=</span><span style="color:#393A34"> count</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">to_do </span><span style="color:#AB5959">+</span><span style="color:#393A34"> must_flush </span><span style="color:#AB5959">></span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#AB5959">      size_t</span><span style="color:#393A34"> block_size</span><span style="color:#999999">,</span><span style="color:#393A34"> do_write</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">      /* Next flush the (full) buffer. */</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">_IO_OVERFLOW</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">f</span><span style="color:#999999">,</span><span style="color:#393A34"> EOF</span><span style="color:#a13865">)</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> EOF</span><span style="color:#a65e2b">)</span><span style="color:#A0ADA0">  // 注意这里</span><br><span style="color:#A0ADA0">	/* If nothing else has to be written we must not signal the</span><br><span style="color:#A0ADA0">	   caller that everything has been written.  */</span><br><span style="color:#1E754F">	return</span><span style="color:#393A34"> to_do </span><span style="color:#AB5959">==</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> ?</span><span style="color:#393A34"> EOF </span><span style="color:#AB5959">:</span><span style="color:#393A34"> n </span><span style="color:#AB5959">-</span><span style="color:#393A34"> to_do</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">	  ...</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> n </span><span style="color:#AB5959">-</span><span style="color:#393A34"> to_do</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>这里看到会去调用 <code class="inline-code">_IO_OVERFLOW</code>，实际上在虚表里是 <code class="inline-code">_IO_new_file_overflow</code>，这个函数实现如下，需要绕过的重要的检测也都在这个函数里：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">int</span><br><span style="color:#59873A">_IO_new_file_overflow</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">FILE </span><span style="color:#AB5959">*</span><span style="color:#B07D48">f</span><span style="color:#999999">,</span><span style="color:#AB5959"> int</span><span style="color:#B07D48"> ch</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34"> _IO_NO_WRITES</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0"> /* SET ERROR */   // check1</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#B07D48">      f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> |=</span><span style="color:#393A34"> _IO_ERR_SEEN</span><span style="color:#999999">;</span><br><span style="color:#59873A">      __set_errno</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">EBADF</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      return</span><span style="color:#393A34"> EOF</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#A0ADA0">  /* If currently reading or no buffer allocated. */</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34"> _IO_CURRENTLY_PUTTING</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ==</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> ||</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_base</span><span style="color:#AB5959"> ==</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0">   // check2</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#A0ADA0">      /* Allocate a buffer if needed. */</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_base</span><span style="color:#AB5959"> ==</span><span style="color:#1E754F"> NULL</span><span style="color:#a65e2b">)</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">{</span><br><span style="color:#59873A">	  _IO_doallocbuf</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">f</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	  _IO_setg</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">f</span><span style="color:#999999">,</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">,</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">,</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">}</span><br><span style="color:#393A34">      ...</span><br><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#AB5959"> ==</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_end</span><span style="color:#a65e2b">)</span><br><span style="color:#B07D48">	f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#999999"> =</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#999999"> =</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">;</span><br><span style="color:#B07D48">      f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#999999"> =</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#999999">;</span><br><span style="color:#B07D48">      f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_base</span><span style="color:#999999"> =</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#999999">;</span><br><span style="color:#B07D48">      f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_end</span><span style="color:#999999"> =</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_end</span><span style="color:#999999">;</span><br><span style="color:#B07D48">      f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_base</span><span style="color:#999999"> =</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_ptr</span><span style="color:#999999"> =</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">      f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> |=</span><span style="color:#393A34"> _IO_CURRENTLY_PUTTING</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_mode</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">=</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> &#x26;&#x26;</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> &#x26;</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">_IO_LINE_BUF </span><span style="color:#AB5959">|</span><span style="color:#393A34"> _IO_UNBUFFERED</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><br><span style="color:#B07D48">	f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_end</span><span style="color:#999999"> =</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">ch </span><span style="color:#AB5959">==</span><span style="color:#393A34"> EOF</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    return</span><span style="color:#59873A"> _IO_do_write</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">f</span><span style="color:#999999">,</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_base</span><span style="color:#999999">,</span><span style="color:#A0ADA0">   // 注意这里2️⃣</span><br><span style="color:#B07D48">			 f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#AB5959"> -</span><span style="color:#B07D48"> f</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_base</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  ...</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>这里会调用 <code class="inline-code">_IO_do_write</code>，这个作用是输出缓冲区。</p>
<h4 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>任意写</a></h4>
<p>这一部分的攻击面来自于上面那段“注意这里1️⃣”，如果我们劫持了 <code class="inline-code">fp->_IO_write_ptr</code> 就可以任意地址写了。</p>
<p>也就是说，只需要构造：<code class="inline-code">fp -> _IO_write_ptr</code> 和 <code class="inline-code">fp -> _IO_write_end</code>，指向要写的位置。</p>
<h4 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>任意读</a></h4>
<p>这一部分的攻击面来自于上面那段“注意这里2️⃣”</p>
<p>再看一下 <code class="inline-code">_IO_do_write</code>：</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#A0ADA0">// 位于libio/fileops.c</span><br><span style="color:#AB5959">int</span><span style="color:#59873A"> _IO_new_do_write</span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_FILE </span><span style="color:#AB5959">*</span><span style="color:#B07D48">fp</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">data</span><span style="color:#999999">,</span><span style="color:#998418"> _IO_size_t</span><span style="color:#B07D48"> to_do</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#1E754F">    return</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">to_do </span><span style="color:#AB5959">==</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> ||</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#998418">_IO_size_t</span><span style="color:#a65e2b">)</span><span style="color:#59873A">new_do_write</span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#999999">,</span><span style="color:#393A34"> data</span><span style="color:#999999">,</span><span style="color:#393A34"> to_do</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> to_do</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> ?</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> :</span><span style="color:#393A34"> EOF</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><span style="color:#59873A">libc_hidden_ver</span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_new_do_write</span><span style="color:#999999">,</span><span style="color:#393A34"> _IO_do_write</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">static</span><span style="color:#998418"> _IO_size_t</span><br><span style="color:#59873A">    new_do_write</span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_FILE </span><span style="color:#AB5959">*</span><span style="color:#B07D48">fp</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">data</span><span style="color:#999999">,</span><span style="color:#998418"> _IO_size_t</span><span style="color:#B07D48"> to_do</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#998418">    _IO_size_t</span><span style="color:#393A34"> count</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">    // 有两个判断，第一个看起来不影响，但else if里面比较复杂不可控，需要绕过</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34"> _IO_IS_APPENDING</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0">       // check3</span><br><span style="color:#A0ADA0">        /* On a system without a proper O_APPEND implementation,</span><br><span style="color:#A0ADA0">           you would need to sys_seek(0, SEEK_END) here, but is</span><br><span style="color:#A0ADA0">           not needed nor desirable for Unix- or Posix-like systems.</span><br><span style="color:#A0ADA0">           Instead, just indicate that offset (before and after) is</span><br><span style="color:#A0ADA0">           unpredictable. */</span><br><span style="color:#B07D48">        fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_offset</span><span style="color:#999999"> =</span><span style="color:#393A34"> _IO_pos_BAD</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    else</span><span style="color:#1E754F"> if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#AB5959"> !=</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_base</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0">   // check4</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#998418">        _IO_off64_t</span><span style="color:#393A34"> new_pos </span><span style="color:#999999">=</span><span style="color:#59873A"> _IO_SYSSEEK</span><span style="color:#a65e2b">(</span><span style="color:#393A34">fp</span><span style="color:#999999">,</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_base</span><span style="color:#AB5959"> -</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_read_end</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">new_pos </span><span style="color:#AB5959">==</span><span style="color:#393A34"> _IO_pos_BAD</span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">            return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#B07D48">        fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_offset</span><span style="color:#999999"> =</span><span style="color:#393A34"> new_pos</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#A0ADA0">    // 满足条件后通过系统调用执行_IO_SYSWRITE</span><br><span style="color:#A0ADA0">    // data从上面传过来的，是f->_IO_write_base, to_do是f->_IO_write_ptr - f->_IO_write_base</span><br><span style="color:#A0ADA0">    // 意思就是输出f -> _IO_write_base和_IO_write_ptr之间的内容</span><br><span style="color:#393A34">    count </span><span style="color:#999999">=</span><span style="color:#59873A"> _IO_SYSWRITE</span><span style="color:#1e754f">(</span><span style="color:#393A34">fp</span><span style="color:#999999">,</span><span style="color:#393A34"> data</span><span style="color:#999999">,</span><span style="color:#393A34"> to_do</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">    // 后面已经和我们无关</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_cur_column</span><span style="color:#AB5959"> &#x26;&#x26;</span><span style="color:#393A34"> count</span><span style="color:#1e754f">)</span><br><span style="color:#B07D48">        fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_cur_column</span><span style="color:#999999"> =</span><span style="color:#59873A"> _IO_adjust_column</span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_cur_column</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#393A34"> data</span><span style="color:#999999">,</span><span style="color:#393A34"> count</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 1</span><span style="color:#999999">;</span><br><span style="color:#59873A">    _IO_setg</span><span style="color:#1e754f">(</span><span style="color:#393A34">fp</span><span style="color:#999999">,</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">,</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">,</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_base</span><span style="color:#999999"> =</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_ptr</span><span style="color:#999999"> =</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_write_end</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_mode</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">=</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> &#x26;&#x26;</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_flags</span><span style="color:#AB5959"> &#x26;</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">_IO_LINE_BUF </span><span style="color:#AB5959">|</span><span style="color:#393A34"> _IO_UNBUFFERED</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><br><span style="color:#AB5959">                             ?</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_base</span><br><span style="color:#AB5959">                             :</span><span style="color:#B07D48"> fp</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">_IO_buf_end</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> count</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>这个函数有两个分支，一般是选择第一个分支来打。</p>
<p>总结一下这部分源码注释里标注的4次 check，总结如下：</p>
<ul>
<li>设置 <code class="inline-code">fp->_flags &amp; _IO_NO_WRITES == 0</code></li>
<li>设置 <code class="inline-code">fp->_flags &amp; _IO_CURRENTLY_PUTTING == 1</code>，这个只需要之前输出过一次就会被设置好</li>
<li>设置 <code class="inline-code">fp -> _fileno = 1</code></li>
<li>以下二选一
<ul>
<li>设置 <code class="inline-code">fp->_flags &amp; _IO_IS_APPENDING == 1</code></li>
<li>设置 <code class="inline-code">fp->_IO_read_end == fp->_IO_write_base</code></li>
</ul>
</li>
</ul>
<p>那么满足上面这些条件的具体的设置方法有很多：</p>
<p><strong>方法一</strong>：</p>
<ul>
<li>假设程序已有完整的 <code class="inline-code">_IO_2_1_stdout</code></li>
<li>修改 <code class="inline-code">fp->_IO_read_end</code> 和 <code class="inline-code">fp->_IO_write_base</code> 的倒数第二字节为 <code class="inline-code">\x00</code></li>
</ul>
<p>这个方法本质上走的是分支二，可以实现只修改两个字节就泄漏出 libc / pie。</p>
<p><strong>方法二</strong>：</p>
<ul>
<li>修改 <code class="inline-code">fp->_flags</code> 为 <code class="inline-code">0xfbad1800</code> 或 <code class="inline-code">0xfbad1887</code>，重点在于满足 <code class="inline-code">fp->_flags &amp; _IO_IS_APPENDING == 1</code></li>
<li>然后修改 <code class="inline-code">fp->_IO_write_base</code> 和 <code class="inline-code">fp->_IO_write_ptr</code> 实现任意地址读。</li>
</ul>
<p>另外，其他 <code class="inline-code">fwrite</code>、<code class="inline-code">printf</code> 等函数和 <code class="inline-code">puts</code> 的调用链也差不多。</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>