<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>CTF Pwn Protobuf 学习笔记 | 花盆</title><meta name="author" content="LittFlower"/><meta property="og:title" content="CTF Pwn Protobuf 学习笔记 | 花盆"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/notes/learning-protobuf-in-ctf/"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="preload" as="style" href="/style.css" type="text/css"/><link rel="preload" as="style" href="/fonts.css" type="text/css"/><link rel="stylesheet" href="/style.css" type="text/css"/><link rel="stylesheet" href="/fonts.css" type="text/css"/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"><div class="file"><a href="./README.mdx" class="file-link"><img src="/icons/text.png" alt loading="lazy" decoding="async"/><span>README.mdx</span></a><div class="file-meta"><span>10.5 KiB</span><span class="file-meta-date">2025-10-24 21:53</span></div></div></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="protobuf" class="scroll-target"><a href="#protobuf"><code class="hash inline-code">#</code>Protobuf 学习笔记</a></h1>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>简介</a></h2>
<p>近两年国内的比赛里，Protobuf 和 pwn 结合的题目越来越多，这里记录一下一些基本的逆向方法和注意事项。</p>
<blockquote>
<p>Protocol Buffers（简称：ProtoBuf）是一种开源跨平台的序列化数据结构的协议。其对于存储资料或在网络上进行通信的程序是很有用的。这个方法包含一个接口描述语言，描述一些数据结构，并提供程序工具根据这些描述产生代码，这些代码将用来生成或解析代表这些数据结构的字节流。
—— WikiPedia</p>
</blockquote>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>环境搭建</a></h2>
<p>由于我用的是 arch linux，所以以下安装方式主要适用于 arch linux，其他发行版或者 macos 用户可自行寻找安装方法。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-shellscript language-shellscript">sudo pacman -S protobuf protobuf-c
sudo pacman -S python-grpcio python-googleapis-common-protos
paru -S pbtk-git
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-shellscript language-shellscript">sudo pacman -S protobuf protobuf-c
sudo pacman -S python-grpcio python-googleapis-common-protos
paru -S pbtk-git
</code></pre></div>
<p>可以通过 <code class="inline-code">protoc --version</code> 的输出判断是否配置成功。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>基本语法</a></h2>
<p>先来看一个官方文档给出的例子，一些语法注释我直接写在 demo 里了：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-proto language-proto">// demo.proto
// 编译为 C 代码：protoc --c_out=. demo.proto
// 编译为 python 代码：protoc --python_out=. demo.proto
//


// syntax = "proto2"  // 有proto2和proto3两个版本，省略默认为proto2。
syntax = "proto3";

package tutorial;  // 防止命名空间冲突

/*
每个字段包括修饰符 类型 字段名，并且末尾通过等号设置唯一字段编号。

修饰符包括如下几种：
    - optional：可以不提供字段值，字段将被初始化为默认值。（Proto3 中不允许显示声明，不加修饰符即 optional）
    - repeated：类似vector，表明该字段为动态数组，可重复任意次。
    - required：必须提供字段值。（Proto3 不再支持 required）
常见的基本类型：
    - bool
    - int32
    - float
    - double
    - string
*/


message Person {  // 用于定义消息结构体，类似C语言中的struct。
  string name = 1;
  int32 id = 2;
  string email = 3;

  enum PhoneType {
    PHONE_TYPE_UNSPECIFIED = 0;
    PHONE_TYPE_MOBILE = 1;
    PHONE_TYPE_HOME = 2;
    PHONE_TYPE_WORK = 3;
  }

  message PhoneNumber {
    string number = 1;
    PhoneType type = 2;
  }

  repeated PhoneNumber phones = 4;
}

message AddressBook {
  repeated Person people = 1;
}
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-proto language-proto">// demo.proto
// 编译为 C 代码：protoc --c_out=. demo.proto
// 编译为 python 代码：protoc --python_out=. demo.proto
//


// syntax = "proto2"  // 有proto2和proto3两个版本，省略默认为proto2。
syntax = "proto3";

package tutorial;  // 防止命名空间冲突

/*
每个字段包括修饰符 类型 字段名，并且末尾通过等号设置唯一字段编号。

修饰符包括如下几种：
    - optional：可以不提供字段值，字段将被初始化为默认值。（Proto3 中不允许显示声明，不加修饰符即 optional）
    - repeated：类似vector，表明该字段为动态数组，可重复任意次。
    - required：必须提供字段值。（Proto3 不再支持 required）
常见的基本类型：
    - bool
    - int32
    - float
    - double
    - string
*/


message Person {  // 用于定义消息结构体，类似C语言中的struct。
  string name = 1;
  int32 id = 2;
  string email = 3;

  enum PhoneType {
    PHONE_TYPE_UNSPECIFIED = 0;
    PHONE_TYPE_MOBILE = 1;
    PHONE_TYPE_HOME = 2;
    PHONE_TYPE_WORK = 3;
  }

  message PhoneNumber {
    string number = 1;
    PhoneType type = 2;
  }

  repeated PhoneNumber phones = 4;
}

message AddressBook {
  repeated Person people = 1;
}
</code></pre></div>
<p><code class="inline-code">protoc --c_out=. demo.proto</code> 编译后得到 <code class="inline-code">demo.pb-c.c</code> 和 <code class="inline-code">demo.pb-c.h</code> 两个文件。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>逆向分析</a></h2>
<p>CTF 题目通常为 C 语言编写，因此为了后续逆向工作，需要理解编译后的 C 语言文件相关结构。</p>
<p>先来看 <code class="inline-code">demo.pb-c.c</code> 文件，搜索 <code class="inline-code">unpack</code> 定位到 <code class="inline-code">tutorial__person__unpack</code> 函数（一般就是 <code class="inline-code">tutorial__xxxx__unpack</code>）：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">Tutorial__Person </span><span style="color:#AB5959">*</span><br><span style="color:#393A34">       tutorial__person__unpack</span><br><span style="color:#999999">                     </span><span style="color:#2993a3">(</span><span style="color:#393A34">ProtobufCAllocator  </span><span style="color:#AB5959">*</span><span style="color:#393A34">allocator</span><span style="color:#999999">,</span><br><span style="color:#AB5959">                      size_t</span><span style="color:#393A34">               len</span><span style="color:#999999">,</span><br><span style="color:#AB5959">                      const</span><span style="color:#AB5959"> uint8_t</span><span style="color:#AB5959">       *</span><span style="color:#393A34">data</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#1E754F">  return</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">Tutorial__Person </span><span style="color:#AB5959">*</span><span style="color:#1e754f">)</span><br><span style="color:#59873A">     protobuf_c_message_unpack</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">tutorial__person__descriptor</span><span style="color:#999999">,</span><br><span style="color:#393A34">                                allocator</span><span style="color:#999999">,</span><span style="color:#393A34"> len</span><span style="color:#999999">,</span><span style="color:#393A34"> data</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">Tutorial__Person </span><span style="color:#CB7676">*</span><br><span style="color:#DBD7CAEE">       tutorial__person__unpack</span><br><span style="color:#666666">                     </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">ProtobufCAllocator  </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">allocator</span><span style="color:#666666">,</span><br><span style="color:#CB7676">                      size_t</span><span style="color:#DBD7CAEE">               len</span><span style="color:#666666">,</span><br><span style="color:#CB7676">                      const</span><span style="color:#CB7676"> uint8_t</span><span style="color:#CB7676">       *</span><span style="color:#DBD7CAEE">data</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#4D9375">  return</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Tutorial__Person </span><span style="color:#CB7676">*</span><span style="color:#4d9375">)</span><br><span style="color:#80A665">     protobuf_c_message_unpack</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">tutorial__person__descriptor</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">                                allocator</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> len</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> data</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>跟进到 <code class="inline-code">protobuf_c_message_unpack</code>，看一下函数原型：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#A0ADA0">/**</span><br><span style="color:#A0ADA0"> * Unpack a serialised message into an in-memory representation.</span><br><span style="color:#A0ADA0"> *</span><br><span style="color:#A0ADA0"> * </span><span style="color:#AB5959">\param</span><span style="color:#B07D48"> descriptor</span><br><span style="color:#A0ADA0"> *      The message descriptor.</span><br><span style="color:#A0ADA0"> * </span><span style="color:#AB5959">\param</span><span style="color:#B07D48"> allocator</span><br><span style="color:#A0ADA0"> *      `ProtobufCAllocator` to use for memory allocation. May be NULL to</span><br><span style="color:#A0ADA0"> *      specify the default allocator.</span><br><span style="color:#A0ADA0"> * </span><span style="color:#AB5959">\param</span><span style="color:#B07D48"> len</span><br><span style="color:#A0ADA0"> *      Length in bytes of the serialised message.</span><br><span style="color:#A0ADA0"> * </span><span style="color:#AB5959">\param</span><span style="color:#B07D48"> data</span><br><span style="color:#A0ADA0"> *      Pointer to the serialised message.</span><br><span style="color:#A0ADA0"> * </span><span style="color:#AB5959">\return</span><br><span style="color:#A0ADA0"> *      An unpacked message object.</span><br><span style="color:#A0ADA0"> * </span><span style="color:#AB5959">\retval</span><span style="color:#A0ADA0"> NULL</span><br><span style="color:#A0ADA0"> *      If an error occurred during unpacking.</span><br><span style="color:#A0ADA0"> */</span><br><span style="color:#393A34">PROTOBUF_C__API</span><br><span style="color:#393A34">ProtobufCMessage </span><span style="color:#AB5959">*</span><br><span style="color:#59873A">protobuf_c_message_unpack</span><span style="color:#2993a3">(</span><br><span style="color:#AB5959">	const</span><span style="color:#393A34"> ProtobufCMessageDescriptor </span><span style="color:#AB5959">*</span><span style="color:#B07D48">descriptor</span><span style="color:#999999">,</span><br><span style="color:#393A34">	ProtobufCAllocator </span><span style="color:#AB5959">*</span><span style="color:#B07D48">allocator</span><span style="color:#999999">,</span><br><span style="color:#AB5959">	size_t</span><span style="color:#B07D48"> len</span><span style="color:#999999">,</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> uint8_t</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">data</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">typedef</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> ProtobufCMessageDescriptor ProtobufCMessageDescriptor</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#758575DD">/**</span><br><span style="color:#758575DD"> * Unpack a serialised message into an in-memory representation.</span><br><span style="color:#758575DD"> *</span><br><span style="color:#758575DD"> * </span><span style="color:#CB7676">\param</span><span style="color:#BD976A"> descriptor</span><br><span style="color:#758575DD"> *      The message descriptor.</span><br><span style="color:#758575DD"> * </span><span style="color:#CB7676">\param</span><span style="color:#BD976A"> allocator</span><br><span style="color:#758575DD"> *      `ProtobufCAllocator` to use for memory allocation. May be NULL to</span><br><span style="color:#758575DD"> *      specify the default allocator.</span><br><span style="color:#758575DD"> * </span><span style="color:#CB7676">\param</span><span style="color:#BD976A"> len</span><br><span style="color:#758575DD"> *      Length in bytes of the serialised message.</span><br><span style="color:#758575DD"> * </span><span style="color:#CB7676">\param</span><span style="color:#BD976A"> data</span><br><span style="color:#758575DD"> *      Pointer to the serialised message.</span><br><span style="color:#758575DD"> * </span><span style="color:#CB7676">\return</span><br><span style="color:#758575DD"> *      An unpacked message object.</span><br><span style="color:#758575DD"> * </span><span style="color:#CB7676">\retval</span><span style="color:#758575DD"> NULL</span><br><span style="color:#758575DD"> *      If an error occurred during unpacking.</span><br><span style="color:#758575DD"> */</span><br><span style="color:#DBD7CAEE">PROTOBUF_C__API</span><br><span style="color:#DBD7CAEE">ProtobufCMessage </span><span style="color:#CB7676">*</span><br><span style="color:#80A665">protobuf_c_message_unpack</span><span style="color:#5eaab5">(</span><br><span style="color:#CB7676">	const</span><span style="color:#DBD7CAEE"> ProtobufCMessageDescriptor </span><span style="color:#CB7676">*</span><span style="color:#BD976A">descriptor</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">	ProtobufCAllocator </span><span style="color:#CB7676">*</span><span style="color:#BD976A">allocator</span><span style="color:#666666">,</span><br><span style="color:#CB7676">	size_t</span><span style="color:#BD976A"> len</span><span style="color:#666666">,</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> uint8_t</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">data</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> ProtobufCMessageDescriptor ProtobufCMessageDescriptor</span><span style="color:#666666">;</span><br></code></pre></div>
<p>阅读注释，可以看到这里比较重要的参数 1 就是一个 message descriptor，看一下这个结构体：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#A0ADA0">/**</span><br><span style="color:#A0ADA0"> * Describes a message.</span><br><span style="color:#A0ADA0"> */</span><br><span style="color:#AB5959">struct</span><span style="color:#393A34"> ProtobufCMessageDescriptor </span><span style="color:#2993a3">{</span><br><span style="color:#A0ADA0">	/** Magic value checked to ensure that the API is used correctly. */</span><br><span style="color:#AB5959">	uint32_t</span><span style="color:#393A34">			magic</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/** The qualified name (e.g., "namespace.Type"). */</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">			*</span><span style="color:#393A34">name</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** The unqualified name as given in the .proto file (e.g., "Type"). */</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">			*</span><span style="color:#393A34">short_name</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** Identifier used in generated C code. */</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">			*</span><span style="color:#393A34">c_name</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** The dot-separated namespace. */</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">			*</span><span style="color:#393A34">package_name</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/**</span><br><span style="color:#A0ADA0">	 * Size in bytes of the C structure representing an instance of this</span><br><span style="color:#A0ADA0">	 * type of message.</span><br><span style="color:#A0ADA0">	 */</span><br><span style="color:#AB5959">	size_t</span><span style="color:#393A34">				sizeof_message</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/** Number of elements in `fields`. */</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">			n_fields</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** Field descriptors, sorted by tag number. */</span><br><span style="color:#AB5959">	const</span><span style="color:#393A34"> ProtobufCFieldDescriptor	</span><span style="color:#AB5959">*</span><span style="color:#393A34">fields</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** Used for looking up fields by name. */</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> unsigned</span><span style="color:#AB5959">			*</span><span style="color:#393A34">fields_sorted_by_name</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/** Number of elements in `field_ranges`. */</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">			n_field_ranges</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** Used for looking up fields by id. */</span><br><span style="color:#AB5959">	const</span><span style="color:#393A34"> ProtobufCIntRange		</span><span style="color:#AB5959">*</span><span style="color:#393A34">field_ranges</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/** Message initialisation function. */</span><br><span style="color:#393A34">	ProtobufCMessageInit		message_init</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/** Reserved for future use. */</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">				*</span><span style="color:#393A34">reserved1</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** Reserved for future use. */</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">				*</span><span style="color:#393A34">reserved2</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** Reserved for future use. */</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">				*</span><span style="color:#393A34">reserved3</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#758575DD">/**</span><br><span style="color:#758575DD"> * Describes a message.</span><br><span style="color:#758575DD"> */</span><br><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> ProtobufCMessageDescriptor </span><span style="color:#5eaab5">{</span><br><span style="color:#758575DD">	/** Magic value checked to ensure that the API is used correctly. */</span><br><span style="color:#CB7676">	uint32_t</span><span style="color:#DBD7CAEE">			magic</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/** The qualified name (e.g., "namespace.Type"). */</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">name</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** The unqualified name as given in the .proto file (e.g., "Type"). */</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">short_name</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** Identifier used in generated C code. */</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">c_name</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** The dot-separated namespace. */</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">package_name</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/**</span><br><span style="color:#758575DD">	 * Size in bytes of the C structure representing an instance of this</span><br><span style="color:#758575DD">	 * type of message.</span><br><span style="color:#758575DD">	 */</span><br><span style="color:#CB7676">	size_t</span><span style="color:#DBD7CAEE">				sizeof_message</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/** Number of elements in `fields`. */</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">			n_fields</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** Field descriptors, sorted by tag number. */</span><br><span style="color:#CB7676">	const</span><span style="color:#DBD7CAEE"> ProtobufCFieldDescriptor	</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">fields</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** Used for looking up fields by name. */</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> unsigned</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">fields_sorted_by_name</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/** Number of elements in `field_ranges`. */</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">			n_field_ranges</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** Used for looking up fields by id. */</span><br><span style="color:#CB7676">	const</span><span style="color:#DBD7CAEE"> ProtobufCIntRange		</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">field_ranges</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/** Message initialisation function. */</span><br><span style="color:#DBD7CAEE">	ProtobufCMessageInit		message_init</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/** Reserved for future use. */</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">				*</span><span style="color:#DBD7CAEE">reserved1</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** Reserved for future use. */</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">				*</span><span style="color:#DBD7CAEE">reserved2</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** Reserved for future use. */</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">				*</span><span style="color:#DBD7CAEE">reserved3</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br></code></pre></div>
<p>如注释所说。这个 <code class="inline-code">magic</code> 一般是等于 <code class="inline-code">0x28AAEEF9</code>，在 IDA 中通过 <code class="inline-code">Search -> Immediate value ...</code> 勾选 <code class="inline-code">find all</code> 即可搜索这个魔术，找到位于 data 段的数据，就是这个结构体。</p>
<p>另一个需要重点关注的结构体是 <code class="inline-code">ProtobufCFieldDescriptor</code>：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#A0ADA0">/**</span><br><span style="color:#A0ADA0"> * Describes a single field in a message.</span><br><span style="color:#A0ADA0"> */</span><br><span style="color:#AB5959">struct</span><span style="color:#393A34"> ProtobufCFieldDescriptor </span><span style="color:#2993a3">{</span><br><span style="color:#A0ADA0">	/** Name of the field as given in the .proto file. */</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">		*</span><span style="color:#393A34">name</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/** Tag value of the field as given in the .proto file. */</span><br><span style="color:#AB5959">	uint32_t</span><span style="color:#393A34">		id</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/** Whether the field is `REQUIRED`, `OPTIONAL`, or `REPEATED`. */</span><br><span style="color:#393A34">	ProtobufCLabel		label</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/** The type of the field. */</span><br><span style="color:#393A34">	ProtobufCType		type</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/**</span><br><span style="color:#A0ADA0">	 * The offset in bytes of the message's C structure's quantifier field</span><br><span style="color:#A0ADA0">	 * (the `has_MEMBER` field for optional members or the `n_MEMBER` field</span><br><span style="color:#A0ADA0">	 * for repeated members or the case enum for oneofs).</span><br><span style="color:#A0ADA0">	 */</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">		quantifier_offset</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/**</span><br><span style="color:#A0ADA0">	 * The offset in bytes into the message's C structure for the member</span><br><span style="color:#A0ADA0">	 * itself.</span><br><span style="color:#A0ADA0">	 */</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">		offset</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/**</span><br><span style="color:#A0ADA0">	 * A type-specific descriptor.</span><br><span style="color:#A0ADA0">	 *</span><br><span style="color:#A0ADA0">	 * If `type` is `PROTOBUF_C_TYPE_ENUM`, then `descriptor` points to the</span><br><span style="color:#A0ADA0">	 * corresponding `ProtobufCEnumDescriptor`.</span><br><span style="color:#A0ADA0">	 *</span><br><span style="color:#A0ADA0">	 * If `type` is `PROTOBUF_C_TYPE_MESSAGE`, then `descriptor` points to</span><br><span style="color:#A0ADA0">	 * the corresponding `ProtobufCMessageDescriptor`.</span><br><span style="color:#A0ADA0">	 *</span><br><span style="color:#A0ADA0">	 * Otherwise this field is NULL.</span><br><span style="color:#A0ADA0">	 */</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959">		*</span><span style="color:#393A34">descriptor</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> /* for MESSAGE and ENUM types */</span><br><br><span style="color:#A0ADA0">	/** The default value for this field, if defined. May be NULL. */</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959">		*</span><span style="color:#393A34">default_value</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/**</span><br><span style="color:#A0ADA0">	 * A flag word. Zero or more of the bits defined in the</span><br><span style="color:#A0ADA0">	 * `ProtobufCFieldFlag` enum may be set.</span><br><span style="color:#A0ADA0">	 */</span><br><span style="color:#AB5959">	uint32_t</span><span style="color:#393A34">		flags</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">	/** Reserved for future use. */</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">		reserved_flags</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** Reserved for future use. */</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">			*</span><span style="color:#393A34">reserved2</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">	/** Reserved for future use. */</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">			*</span><span style="color:#393A34">reserved3</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#758575DD">/**</span><br><span style="color:#758575DD"> * Describes a single field in a message.</span><br><span style="color:#758575DD"> */</span><br><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> ProtobufCFieldDescriptor </span><span style="color:#5eaab5">{</span><br><span style="color:#758575DD">	/** Name of the field as given in the .proto file. */</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">		*</span><span style="color:#DBD7CAEE">name</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/** Tag value of the field as given in the .proto file. */</span><br><span style="color:#CB7676">	uint32_t</span><span style="color:#DBD7CAEE">		id</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/** Whether the field is `REQUIRED`, `OPTIONAL`, or `REPEATED`. */</span><br><span style="color:#DBD7CAEE">	ProtobufCLabel		label</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/** The type of the field. */</span><br><span style="color:#DBD7CAEE">	ProtobufCType		type</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/**</span><br><span style="color:#758575DD">	 * The offset in bytes of the message's C structure's quantifier field</span><br><span style="color:#758575DD">	 * (the `has_MEMBER` field for optional members or the `n_MEMBER` field</span><br><span style="color:#758575DD">	 * for repeated members or the case enum for oneofs).</span><br><span style="color:#758575DD">	 */</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">		quantifier_offset</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/**</span><br><span style="color:#758575DD">	 * The offset in bytes into the message's C structure for the member</span><br><span style="color:#758575DD">	 * itself.</span><br><span style="color:#758575DD">	 */</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">		offset</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/**</span><br><span style="color:#758575DD">	 * A type-specific descriptor.</span><br><span style="color:#758575DD">	 *</span><br><span style="color:#758575DD">	 * If `type` is `PROTOBUF_C_TYPE_ENUM`, then `descriptor` points to the</span><br><span style="color:#758575DD">	 * corresponding `ProtobufCEnumDescriptor`.</span><br><span style="color:#758575DD">	 *</span><br><span style="color:#758575DD">	 * If `type` is `PROTOBUF_C_TYPE_MESSAGE`, then `descriptor` points to</span><br><span style="color:#758575DD">	 * the corresponding `ProtobufCMessageDescriptor`.</span><br><span style="color:#758575DD">	 *</span><br><span style="color:#758575DD">	 * Otherwise this field is NULL.</span><br><span style="color:#758575DD">	 */</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676">		*</span><span style="color:#DBD7CAEE">descriptor</span><span style="color:#666666">;</span><span style="color:#758575DD"> /* for MESSAGE and ENUM types */</span><br><br><span style="color:#758575DD">	/** The default value for this field, if defined. May be NULL. */</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676">		*</span><span style="color:#DBD7CAEE">default_value</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/**</span><br><span style="color:#758575DD">	 * A flag word. Zero or more of the bits defined in the</span><br><span style="color:#758575DD">	 * `ProtobufCFieldFlag` enum may be set.</span><br><span style="color:#758575DD">	 */</span><br><span style="color:#CB7676">	uint32_t</span><span style="color:#DBD7CAEE">		flags</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">	/** Reserved for future use. */</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">		reserved_flags</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** Reserved for future use. */</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">reserved2</span><span style="color:#666666">;</span><br><span style="color:#758575DD">	/** Reserved for future use. */</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">reserved3</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br></code></pre></div>
<p>注释里写的也很清晰了，需要关注的字段 <code class="inline-code">name</code>、<code class="inline-code">label</code>、<code class="inline-code">type</code>、<code class="inline-code">descriptor</code>。</p>
<p>基本上在 IDA 里导入这些结构体，然后找到对应的数据段，先选中右键 <code class="inline-code">Undefined</code> 这些数据，然后在起始段右键 <code class="inline-code">Structure</code> 选择对应的结构体就可以恢复的非常清楚了。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>做题流程</a></h2>
<h3 id="pbtk" class="scroll-target"><a href="#pbtk"><code class="hash inline-code">#</code>pbtk</a></h3>
<p>一般来讲，可以先用 pbtk 去一把梭恢复 proto 文件，似乎默认只能识别 proto3？？不清楚为什么有的 proto2 题目无法正常恢复。</p>
<p>一般只需要使用 <code class="inline-code">pbtk/extractors/from_binary.py</code> 就可以直接梭哈。</p>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>手动恢复</a></h3>
<p>例如说一道 proto2 题目，先依次在 IDA 导入如下结构体：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">enum</span><span style="color:#393A34"> ProtobufCLabel</span><br><span style="color:#2993a3">{</span><br><span style="color:#393A34">  PROTOBUF_C_LABEL_REQUIRED </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_LABEL_OPTIONAL </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_LABEL_REPEATED </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">2</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_LABEL_NONE </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">3</span><span style="color:#999999">,</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">enum</span><span style="color:#393A34"> ProtobufCType</span><br><span style="color:#2993a3">{</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_INT32 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_SINT32 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_SFIXED32 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">2</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_INT64 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">3</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_SINT64 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_SFIXED64 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">5</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_UINT32 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">6</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_FIXED32 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">7</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_UINT64 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">8</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_FIXED64 </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">9</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_FLOAT </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_DOUBLE </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">B</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_BOOL </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">C</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_ENUM </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">D</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_STRING </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">E</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_BYTES </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">F</span><span style="color:#999999">,</span><br><span style="color:#393A34">  PROTOBUF_C_TYPE_MESSAGE </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#999999">,</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">struct</span><span style="color:#393A34"> ProtobufCMessageDescriptor </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	uint32_t</span><span style="color:#393A34">			magic</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">			*</span><span style="color:#393A34">name</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">			*</span><span style="color:#393A34">short_name</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">			*</span><span style="color:#393A34">c_name</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">			*</span><span style="color:#393A34">package_name</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	size_t</span><span style="color:#393A34">				sizeof_message</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">			n_fields</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#393A34"> ProtobufCFieldDescriptor	</span><span style="color:#AB5959">*</span><span style="color:#393A34">fields</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> unsigned</span><span style="color:#AB5959">			*</span><span style="color:#393A34">fields_sorted_by_name</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">			n_field_ranges</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">         		*</span><span style="color:#393A34">field_ranges</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">		        *</span><span style="color:#393A34">message_init</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">				*</span><span style="color:#393A34">reserved1</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">				*</span><span style="color:#393A34">reserved2</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">				*</span><span style="color:#393A34">reserved3</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">struct</span><span style="color:#393A34"> ProtobufCFieldDescriptor </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959">		*</span><span style="color:#393A34">name</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	uint32_t</span><span style="color:#393A34">		id</span><span style="color:#999999">;</span><br><span style="color:#393A34">	ProtobufCLabel		label</span><span style="color:#999999">;</span><br><span style="color:#393A34">	ProtobufCType		type</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">		quantifier_offset</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">		offset</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959">		*</span><span style="color:#393A34">descriptor</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959">		*</span><span style="color:#393A34">default_value</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	uint32_t</span><span style="color:#393A34">		flags</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	unsigned</span><span style="color:#393A34">		reserved_flags</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">			*</span><span style="color:#393A34">reserved2</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	void</span><span style="color:#AB5959">			*</span><span style="color:#393A34">reserved3</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">enum</span><span style="color:#DBD7CAEE"> ProtobufCLabel</span><br><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_LABEL_REQUIRED </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_LABEL_OPTIONAL </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">1</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_LABEL_REPEATED </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">2</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_LABEL_NONE </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">3</span><span style="color:#666666">,</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">enum</span><span style="color:#DBD7CAEE"> ProtobufCType</span><br><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_INT32 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_SINT32 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">1</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_SFIXED32 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">2</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_INT64 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">3</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_SINT64 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_SFIXED64 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">5</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_UINT32 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">6</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_FIXED32 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">7</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_UINT64 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">8</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_FIXED64 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">9</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_FLOAT </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_DOUBLE </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">B</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_BOOL </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">C</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_ENUM </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">D</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_STRING </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">E</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_BYTES </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">F</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">  PROTOBUF_C_TYPE_MESSAGE </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#666666">,</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> ProtobufCMessageDescriptor </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">	uint32_t</span><span style="color:#DBD7CAEE">			magic</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">name</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">short_name</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">c_name</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">package_name</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	size_t</span><span style="color:#DBD7CAEE">				sizeof_message</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">			n_fields</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#DBD7CAEE"> ProtobufCFieldDescriptor	</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">fields</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> unsigned</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">fields_sorted_by_name</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">			n_field_ranges</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">         		*</span><span style="color:#DBD7CAEE">field_ranges</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">		        *</span><span style="color:#DBD7CAEE">message_init</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">				*</span><span style="color:#DBD7CAEE">reserved1</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">				*</span><span style="color:#DBD7CAEE">reserved2</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">				*</span><span style="color:#DBD7CAEE">reserved3</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> ProtobufCFieldDescriptor </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676">		*</span><span style="color:#DBD7CAEE">name</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	uint32_t</span><span style="color:#DBD7CAEE">		id</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">	ProtobufCLabel		label</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">	ProtobufCType		type</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">		quantifier_offset</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">		offset</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676">		*</span><span style="color:#DBD7CAEE">descriptor</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676">		*</span><span style="color:#DBD7CAEE">default_value</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	uint32_t</span><span style="color:#DBD7CAEE">		flags</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	unsigned</span><span style="color:#DBD7CAEE">		reserved_flags</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">reserved2</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	void</span><span style="color:#CB7676">			*</span><span style="color:#DBD7CAEE">reserved3</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br></code></pre></div>
<p>把上面的结构体导入，恢复即可。</p>
<p>以 ciscn2023 初赛的一道题目为例：</p>
<p><img loading="lazy" decoding="async" fetchpriority="auto" src="https://pic1.imgdb.cn/item/68fae8863203f7be00932cb2.png" alt="恢复结果"/></p>
<p>从逆向结果可以得知，题目的标准结构体为 0x40 大小，有 4 个字段，字段对应的类型也很清楚，<code class="inline-code">label</code> 是 <code class="inline-code">required</code>，<code class="inline-code">type</code> 是 <code class="inline-code">sint64</code> or <code class="inline-code">bytes</code>。</p>
<p>重写一个 <code class="inline-code">test.proto</code>，<code class="inline-code">protoc</code> 编译后得到 <code class="inline-code">demo.pb-c.c</code>，查看结构体：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#A0ADA0">/* --- messages --- */</span><br><br><span style="color:#AB5959">struct</span><span style="color:#393A34">  Devicemsg</span><br><span style="color:#2993a3">{</span><br><span style="color:#393A34">  ProtobufCMessage base</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // ProtobufCMessage 是一个 0x18 的结构体</span><br><span style="color:#AB5959">  int64_t</span><span style="color:#393A34"> actionid</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int64_t</span><span style="color:#393A34"> msgidx</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  int64_t</span><span style="color:#393A34"> msgsize</span><span style="color:#999999">;</span><br><span style="color:#393A34">  ProtobufCBinaryData msgcontent</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // ProtobufCBinaryData 是一个 0x10 的结构体</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">struct</span><span style="color:#393A34"> ProtobufCBinaryData </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	size_t</span><span style="color:#393A34">	len</span><span style="color:#999999">;</span><span style="color:#A0ADA0">        /**&#x3C; Number of bytes in the `data` field. */</span><br><span style="color:#AB5959">	uint8_t</span><span style="color:#AB5959">	*</span><span style="color:#393A34">data</span><span style="color:#999999">;</span><span style="color:#A0ADA0">      /**&#x3C; Data bytes. */</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#758575DD">/* --- messages --- */</span><br><br><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE">  Devicemsg</span><br><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">  ProtobufCMessage base</span><span style="color:#666666">;</span><span style="color:#758575DD">  // ProtobufCMessage 是一个 0x18 的结构体</span><br><span style="color:#CB7676">  int64_t</span><span style="color:#DBD7CAEE"> actionid</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  int64_t</span><span style="color:#DBD7CAEE"> msgidx</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  int64_t</span><span style="color:#DBD7CAEE"> msgsize</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  ProtobufCBinaryData msgcontent</span><span style="color:#666666">;</span><span style="color:#758575DD">  // ProtobufCBinaryData 是一个 0x10 的结构体</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> ProtobufCBinaryData </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">	size_t</span><span style="color:#DBD7CAEE">	len</span><span style="color:#666666">;</span><span style="color:#758575DD">        /**&#x3C; Number of bytes in the `data` field. */</span><br><span style="color:#CB7676">	uint8_t</span><span style="color:#CB7676">	*</span><span style="color:#DBD7CAEE">data</span><span style="color:#666666">;</span><span style="color:#758575DD">      /**&#x3C; Data bytes. */</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br></code></pre></div>
<p>然后再把以上结构体导入 IDA 进一步逆向即可。</p>
<p>在确认结构体正确后，<code class="inline-code">protoc --python_out=. message.proto</code> 得到 <code class="inline-code">message_pb2.py</code>，然后就可以用来封装交互函数了。</p>
<p>使用 <code class="inline-code">SerializeToString</code> 序列化，<code class="inline-code">ParseFromString</code> 反序列化。</p>
<h3 id="attack" class="scroll-target"><a href="#attack"><code class="hash inline-code">#</code>attack</a></h3>
<p>搞清楚结构体之后，protobuf 在 CTF Pwn 中一般都是和堆题的 io 交互一起出，把 io 逆明白了，剩下的就是堆利用了，这里不多赘述。</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>