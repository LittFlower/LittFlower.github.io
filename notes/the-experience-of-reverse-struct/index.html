<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>逆向结构体的经验 | 花盆</title><meta name="author" content="LittFlower"/><meta property="og:title" content="逆向结构体的经验 | 花盆"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/notes/the-experience-of-reverse-struct/"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="preload" as="style" href="/style.css" type="text/css"/><link rel="preload" as="style" href="/fonts.css" type="text/css"/><link rel="stylesheet" href="/style.css" type="text/css"/><link rel="stylesheet" href="/fonts.css" type="text/css"/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"><div class="file"><a href="./README.mdx" class="file-link"><img src="/icons/text.png" alt loading="lazy" decoding="async"/><span>README.mdx</span></a><div class="file-meta"><span>6.8 KiB</span><span class="file-meta-date">2024-01-14 08:00</span></div></div></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>逆向结构体的经验</a></h1>
<p>主要说一下怎么逆向 Pwn 题里常见的各种数据结构。</p>
<h2 id="0x01." class="scroll-target"><a href="#0x01."><code class="hash inline-code">#</code>0x01. 数组</a></h2>
<p>最简单的一种就是逆向数组，因为数组的形式在经过反编译之后会呈现出指针偏移的形式，e.g. <code class="inline-code">*(p + offset)</code>。</p>
<p>比如说下面这份代码：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">int</span><span style="color:#393A34"> __fastcall </span><span style="color:#59873A">main</span><span style="color:#2993a3">(</span><span style="color:#AB5959">int</span><span style="color:#B07D48"> argc</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">argv</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">envp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> i</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+4h] [rbp-Ch]</span><br><span style="color:#393A34">  __int64 v5</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+8h] [rbp-8h]</span><br><br><span style="color:#1E754F">  for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">=</span><span style="color:#2F798A"> 9</span><span style="color:#999999">;</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">i </span><span style="color:#1e754f">)</span><br><span style="color:#999999">  </span><span style="color:#1e754f">{</span><br><span style="color:#AB5959">    *</span><span style="color:#a65e2b">(</span><span style="color:#2F798A">4</span><span style="color:#AB5959">LL</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> i </span><span style="color:#AB5959">+</span><span style="color:#393A34"> v5</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> *=</span><span style="color:#393A34"> i </span><span style="color:#AB5959">*</span><span style="color:#393A34"> i</span><span style="color:#999999">;</span><br><span style="color:#59873A">    printf</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%d\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> *</span><span style="color:#a13865">(</span><span style="color:#2F798A">4</span><span style="color:#AB5959">LL</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> i </span><span style="color:#AB5959">+</span><span style="color:#393A34"> v5</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> __fastcall </span><span style="color:#80A665">main</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> argc</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">argv</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">envp</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  int</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+4h] [rbp-Ch]</span><br><span style="color:#DBD7CAEE">  __int64 v5</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+8h] [rbp-8h]</span><br><br><span style="color:#4D9375">  for</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">=</span><span style="color:#4C9A91"> 9</span><span style="color:#666666">;</span><span style="color:#CB7676"> ++</span><span style="color:#DBD7CAEE">i </span><span style="color:#4d9375">)</span><br><span style="color:#666666">  </span><span style="color:#4d9375">{</span><br><span style="color:#CB7676">    *</span><span style="color:#d4976c">(</span><span style="color:#4C9A91">4</span><span style="color:#CB7676">LL</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> v5</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> *=</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">;</span><br><span style="color:#80A665">    printf</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%d\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#CB7676"> *</span><span style="color:#d9739f">(</span><span style="color:#4C9A91">4</span><span style="color:#CB7676">LL</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> v5</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#666666">  </span><span style="color:#4d9375">}</span><br><span style="color:#4D9375">  return</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>看到这种 <code class="inline-code">*(p + index * offset)</code> 的形式，大概率这里的 v5 是个数组指针，稍微尝试一下，发现可以恢复成如下形式：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">int</span><span style="color:#393A34"> __fastcall </span><span style="color:#59873A">main</span><span style="color:#2993a3">(</span><span style="color:#AB5959">int</span><span style="color:#B07D48"> argc</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">argv</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">envp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> i</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+4h] [rbp-Ch]</span><br><span style="color:#AB5959">  int</span><span style="color:#AB5959"> *</span><span style="color:#393A34">v5</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+8h] [rbp-8h]</span><br><br><span style="color:#1E754F">  for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">=</span><span style="color:#2F798A"> 9</span><span style="color:#999999">;</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">i </span><span style="color:#1e754f">)</span><br><span style="color:#999999">  </span><span style="color:#1e754f">{</span><br><span style="color:#B07D48">    v5</span><span style="color:#a65e2b">[</span><span style="color:#393A34">i</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> *=</span><span style="color:#393A34"> i </span><span style="color:#AB5959">*</span><span style="color:#393A34"> i</span><span style="color:#999999">;</span><br><span style="color:#59873A">    printf</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%d\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> v5</span><span style="color:#a13865">[</span><span style="color:#393A34">i</span><span style="color:#a13865">]</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> __fastcall </span><span style="color:#80A665">main</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> argc</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">argv</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">envp</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  int</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+4h] [rbp-Ch]</span><br><span style="color:#CB7676">  int</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">v5</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+8h] [rbp-8h]</span><br><br><span style="color:#4D9375">  for</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">=</span><span style="color:#4C9A91"> 9</span><span style="color:#666666">;</span><span style="color:#CB7676"> ++</span><span style="color:#DBD7CAEE">i </span><span style="color:#4d9375">)</span><br><span style="color:#666666">  </span><span style="color:#4d9375">{</span><br><span style="color:#BD976A">    v5</span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> *=</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">;</span><br><span style="color:#80A665">    printf</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%d\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> v5</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#d9739f">]</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#666666">  </span><span style="color:#4d9375">}</span><br><span style="color:#4D9375">  return</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>这里的技巧是根据初始的定义 v5 是 8 字节的整型，但是偏移是 4 字节跳转的，所以实际上数组元素的大小是 4 字节，赋个 <code class="inline-code">__int32</code> 之类的就可以。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>结构体</a></h2>
<p>结构体的逆向，一个前置知识点在于<a href="https://blog.littflower.top/posts/the-experience-of-reverse-struct/" title="https://blog.littflower.top/posts/the-experience-of-reverse-struct/" target="_blank" rel="noopener">如何计算结构体字节数</a>。</p>
<p>我这里用一道题目的某个函数来举例子。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">int</span><span style="color:#393A34"> __fastcall </span><span style="color:#59873A">feed</span><span style="color:#2993a3">(</span><span style="color:#393A34">_QWORD </span><span style="color:#AB5959">*</span><span style="color:#B07D48">a1</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">a2</span><span style="color:#999999">,</span><span style="color:#393A34"> __int64 </span><span style="color:#B07D48">a3</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 v3</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // rax</span><br><span style="color:#AB5959">  char</span><span style="color:#AB5959"> *</span><span style="color:#393A34">s1</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+20h] [rbp-20h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 v7</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+28h] [rbp-18h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 v8</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+30h] [rbp-10h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 i</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+38h] [rbp-8h]</span><br><br><span style="color:#393A34">  v3 </span><span style="color:#999999">=</span><span style="color:#59873A"> sub_12C9</span><span style="color:#1e754f">(</span><span style="color:#393A34">a2</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  v8 </span><span style="color:#999999">=</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> v3 </span><span style="color:#1e754f">)</span><br><span style="color:#999999">  </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">    v3 </span><span style="color:#999999">=</span><span style="color:#2F798A"> 10</span><span style="color:#AB5959"> *</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">v3 </span><span style="color:#AB5959">/</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">    v7 </span><span style="color:#999999">=</span><span style="color:#393A34"> v8 </span><span style="color:#AB5959">%</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    for</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#999999">;</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">i </span><span style="color:#a65e2b">)</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">{</span><br><span style="color:#393A34">      s1 </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">a1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 24</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> i </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 96</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> v7 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 80</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#AB5959"> !</span><span style="color:#59873A">strncmp</span><span style="color:#bda437">(</span><span style="color:#393A34">s1</span><span style="color:#999999">,</span><span style="color:#393A34"> a2</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#AB5959">uLL</span><span style="color:#bda437">)</span><span style="color:#999999"> </span><span style="color:#a13865">)</span><br><span style="color:#999999">      </span><span style="color:#a13865">{</span><br><span style="color:#AB5959">        *</span><span style="color:#bda437">(</span><span style="color:#393A34">s1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 2</span><span style="color:#bda437">)</span><span style="color:#AB5959"> +=</span><span style="color:#393A34"> a3</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // Pin!</span><br><span style="color:#59873A">        LODWORD</span><span style="color:#bda437">(</span><span style="color:#393A34">v3</span><span style="color:#bda437">)</span><span style="color:#999999"> =</span><span style="color:#59873A"> printf</span><span style="color:#bda437">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">It </span><span style="color:#A65E2B">%s</span><span style="color:#B56959"> has weight </span><span style="color:#A65E2B">%zu\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> s1</span><span style="color:#999999">,</span><span style="color:#AB5959"> *</span><span style="color:#296aa3">(</span><span style="color:#393A34">s1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 2</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#999999">      </span><span style="color:#a13865">}</span><br><span style="color:#393A34">      v3 </span><span style="color:#999999">=</span><span style="color:#AB5959"> *</span><span style="color:#a13865">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">a1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> v7</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34"> i </span><span style="color:#AB5959">==</span><span style="color:#393A34"> v3 </span><span style="color:#a13865">)</span><br><span style="color:#999999">      </span><span style="color:#a13865">{</span><br><span style="color:#59873A">        strncpy</span><span style="color:#bda437">(</span><span style="color:#393A34">s1</span><span style="color:#999999">,</span><span style="color:#393A34"> a2</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#AB5959">uLL</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">        *</span><span style="color:#bda437">(</span><span style="color:#393A34">s1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 2</span><span style="color:#bda437">)</span><span style="color:#AB5959"> +=</span><span style="color:#393A34"> a3</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // Pin!</span><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#393A34"> a2 </span><span style="color:#AB5959">!=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">useless</span><span style="color:#B5695977">"</span><span style="color:#999999"> </span><span style="color:#bda437">)</span><br><span style="color:#59873A">          printf</span><span style="color:#bda437">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">It </span><span style="color:#A65E2B">%s</span><span style="color:#B56959"> has weight </span><span style="color:#A65E2B">%zu\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> s1</span><span style="color:#999999">,</span><span style="color:#AB5959"> *</span><span style="color:#296aa3">(</span><span style="color:#393A34">s1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 2</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">        ++*</span><span style="color:#bda437">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">a1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> v7</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">        LODWORD</span><span style="color:#bda437">(</span><span style="color:#393A34">v3</span><span style="color:#bda437">)</span><span style="color:#999999"> =</span><span style="color:#59873A"> sub_133C</span><span style="color:#bda437">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">qword_4060</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">useless</span><span style="color:#B5695977">"</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#999999">      </span><span style="color:#a13865">}</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">}</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> __fastcall </span><span style="color:#80A665">feed</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">_QWORD </span><span style="color:#CB7676">*</span><span style="color:#BD976A">a1</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">a2</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> __int64 </span><span style="color:#BD976A">a3</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 v3</span><span style="color:#666666">;</span><span style="color:#758575DD"> // rax</span><br><span style="color:#CB7676">  char</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">s1</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+20h] [rbp-20h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 v7</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+28h] [rbp-18h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 v8</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+30h] [rbp-10h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 i</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+38h] [rbp-8h]</span><br><br><span style="color:#DBD7CAEE">  v3 </span><span style="color:#666666">=</span><span style="color:#80A665"> sub_12C9</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">a2</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  v8 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> v3 </span><span style="color:#4d9375">)</span><br><span style="color:#666666">  </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">    v3 </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 10</span><span style="color:#CB7676"> *</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">v3 </span><span style="color:#CB7676">/</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    v7 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> v8 </span><span style="color:#CB7676">%</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#666666">;</span><br><span style="color:#4D9375">    for</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676">LL</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#666666">;</span><span style="color:#CB7676"> ++</span><span style="color:#DBD7CAEE">i </span><span style="color:#d4976c">)</span><br><span style="color:#666666">    </span><span style="color:#d4976c">{</span><br><span style="color:#DBD7CAEE">      s1 </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">a1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 24</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 96</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> v7 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 80</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#CB7676"> !</span><span style="color:#80A665">strncmp</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">s1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> a2</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#CB7676">uLL</span><span style="color:#e6cc77">)</span><span style="color:#666666"> </span><span style="color:#d9739f">)</span><br><span style="color:#666666">      </span><span style="color:#d9739f">{</span><br><span style="color:#CB7676">        *</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">s1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 2</span><span style="color:#e6cc77">)</span><span style="color:#CB7676"> +=</span><span style="color:#DBD7CAEE"> a3</span><span style="color:#666666">;</span><span style="color:#758575DD"> // Pin!</span><br><span style="color:#80A665">        LODWORD</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">v3</span><span style="color:#e6cc77">)</span><span style="color:#666666"> =</span><span style="color:#80A665"> printf</span><span style="color:#e6cc77">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">It </span><span style="color:#C99076">%s</span><span style="color:#C98A7D"> has weight </span><span style="color:#C99076">%zu\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> s1</span><span style="color:#666666">,</span><span style="color:#CB7676"> *</span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">s1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 2</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#666666">      </span><span style="color:#d9739f">}</span><br><span style="color:#DBD7CAEE">      v3 </span><span style="color:#666666">=</span><span style="color:#CB7676"> *</span><span style="color:#d9739f">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">a1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> v7</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">==</span><span style="color:#DBD7CAEE"> v3 </span><span style="color:#d9739f">)</span><br><span style="color:#666666">      </span><span style="color:#d9739f">{</span><br><span style="color:#80A665">        strncpy</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">s1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> a2</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#CB7676">uLL</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">        *</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">s1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 2</span><span style="color:#e6cc77">)</span><span style="color:#CB7676"> +=</span><span style="color:#DBD7CAEE"> a3</span><span style="color:#666666">;</span><span style="color:#758575DD">  // Pin!</span><br><span style="color:#4D9375">        if</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE"> a2 </span><span style="color:#CB7676">!=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">useless</span><span style="color:#C98A7D77">"</span><span style="color:#666666"> </span><span style="color:#e6cc77">)</span><br><span style="color:#80A665">          printf</span><span style="color:#e6cc77">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">It </span><span style="color:#C99076">%s</span><span style="color:#C98A7D"> has weight </span><span style="color:#C99076">%zu\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> s1</span><span style="color:#666666">,</span><span style="color:#CB7676"> *</span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">s1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 2</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">        ++*</span><span style="color:#e6cc77">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">a1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> v7</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">        LODWORD</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">v3</span><span style="color:#e6cc77">)</span><span style="color:#666666"> =</span><span style="color:#80A665"> sub_133C</span><span style="color:#e6cc77">(</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">qword_4060</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">useless</span><span style="color:#C98A7D77">"</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#666666">      </span><span style="color:#d9739f">}</span><br><span style="color:#666666">    </span><span style="color:#d4976c">}</span><br><span style="color:#666666">  </span><span style="color:#4d9375">}</span><br><span style="color:#4D9375">  return</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>注意一下反编译得到的代码中被 Pin 的两行，可以看到这就是前面提到的数组结构，但是它的偏移是个固定值...? 这很不合理。</p>
<p>根据上下文，，我们知道这个 <code class="inline-code">printf</code> 分别打印了名称和重量，而且数据的格式也可以通过格式化字符串看出来，所以 IDA 创建一个结构体给 s1 用着先：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">struct</span><span style="color:#393A34"> map_entry</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  char</span><span style="color:#B07D48"> name</span><span style="color:#1e754f">[</span><span style="color:#2F798A">16</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#393A34">  __int32 weight</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> map_entry</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  char</span><span style="color:#BD976A"> name</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">16</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  __int32 weight</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br></code></pre></div>
<p>然后发现得到了 <code class="inline-code">*&amp;s1->weight</code> 这种东西，想一想，应该是 weight 的字节数不对，改成 <code class="inline-code">__int64</code> 就可以了。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>结构体套数组套结构体、二维数组</a></h2>
<p>根据上面两节的内容我们大概可以恢复成下面这个样子。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">int</span><span style="color:#393A34"> __fastcall </span><span style="color:#59873A">feed</span><span style="color:#2993a3">(</span><span style="color:#393A34">_QWORD </span><span style="color:#AB5959">*</span><span style="color:#B07D48">a1</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#393A34"> __int64 </span><span style="color:#B07D48">size</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 v3</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // rax</span><br><span style="color:#393A34">  map_entry </span><span style="color:#AB5959">*</span><span style="color:#393A34">s1</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+20h] [rbp-20h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 index</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+28h] [rbp-18h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 v8</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+30h] [rbp-10h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 i</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+38h] [rbp-8h]</span><br><br><span style="color:#393A34">  v3 </span><span style="color:#999999">=</span><span style="color:#59873A"> sub_12C9</span><span style="color:#1e754f">(</span><span style="color:#393A34">name</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  v8 </span><span style="color:#999999">=</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> v3 </span><span style="color:#1e754f">)</span><br><span style="color:#999999">  </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">    v3 </span><span style="color:#999999">=</span><span style="color:#2F798A"> 10</span><span style="color:#AB5959"> *</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">v3 </span><span style="color:#AB5959">/</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">    index </span><span style="color:#999999">=</span><span style="color:#393A34"> v8 </span><span style="color:#AB5959">%</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    for</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#999999">;</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">i </span><span style="color:#a65e2b">)</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">{</span><br><span style="color:#393A34">      s1 </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">a1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 24</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> i </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 96</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> index </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 80</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#AB5959"> !</span><span style="color:#59873A">strncmp</span><span style="color:#bda437">(</span><span style="color:#B07D48">s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#393A34"> name</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#AB5959">uLL</span><span style="color:#bda437">)</span><span style="color:#999999"> </span><span style="color:#a13865">)</span><br><span style="color:#999999">      </span><span style="color:#a13865">{</span><br><span style="color:#B07D48">        s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">weight</span><span style="color:#AB5959"> +=</span><span style="color:#393A34"> size</span><span style="color:#999999">;</span><br><span style="color:#59873A">        LODWORD</span><span style="color:#bda437">(</span><span style="color:#393A34">v3</span><span style="color:#bda437">)</span><span style="color:#999999"> =</span><span style="color:#59873A"> printf</span><span style="color:#bda437">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">It </span><span style="color:#A65E2B">%s</span><span style="color:#B56959"> has weight </span><span style="color:#A65E2B">%zu\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#B07D48"> s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">weight</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#999999">      </span><span style="color:#a13865">}</span><br><span style="color:#393A34">      v3 </span><span style="color:#999999">=</span><span style="color:#AB5959"> *</span><span style="color:#a13865">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">a1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> index</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34"> i </span><span style="color:#AB5959">==</span><span style="color:#393A34"> v3 </span><span style="color:#a13865">)</span><br><span style="color:#999999">      </span><span style="color:#a13865">{</span><br><span style="color:#59873A">        strncpy</span><span style="color:#bda437">(</span><span style="color:#B07D48">s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#393A34"> name</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#AB5959">uLL</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">        s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">weight</span><span style="color:#AB5959"> +=</span><span style="color:#393A34"> size</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#393A34"> name </span><span style="color:#AB5959">!=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">useless</span><span style="color:#B5695977">"</span><span style="color:#999999"> </span><span style="color:#bda437">)</span><br><span style="color:#59873A">          printf</span><span style="color:#bda437">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">It </span><span style="color:#A65E2B">%s</span><span style="color:#B56959"> has weight </span><span style="color:#A65E2B">%zu\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#B07D48"> s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">weight</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">        ++*</span><span style="color:#bda437">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">a1 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> index</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">        LODWORD</span><span style="color:#bda437">(</span><span style="color:#393A34">v3</span><span style="color:#bda437">)</span><span style="color:#999999"> =</span><span style="color:#59873A"> sub_133C</span><span style="color:#bda437">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">qword_4060</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">useless</span><span style="color:#B5695977">"</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#999999">      </span><span style="color:#a13865">}</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">}</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> __fastcall </span><span style="color:#80A665">feed</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">_QWORD </span><span style="color:#CB7676">*</span><span style="color:#BD976A">a1</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> __int64 </span><span style="color:#BD976A">size</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 v3</span><span style="color:#666666">;</span><span style="color:#758575DD"> // rax</span><br><span style="color:#DBD7CAEE">  map_entry </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">s1</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+20h] [rbp-20h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 index</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+28h] [rbp-18h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 v8</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+30h] [rbp-10h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 i</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+38h] [rbp-8h]</span><br><br><span style="color:#DBD7CAEE">  v3 </span><span style="color:#666666">=</span><span style="color:#80A665"> sub_12C9</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">name</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  v8 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> v3 </span><span style="color:#4d9375">)</span><br><span style="color:#666666">  </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">    v3 </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 10</span><span style="color:#CB7676"> *</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">v3 </span><span style="color:#CB7676">/</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    index </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> v8 </span><span style="color:#CB7676">%</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#666666">;</span><br><span style="color:#4D9375">    for</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676">LL</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#666666">;</span><span style="color:#CB7676"> ++</span><span style="color:#DBD7CAEE">i </span><span style="color:#d4976c">)</span><br><span style="color:#666666">    </span><span style="color:#d4976c">{</span><br><span style="color:#DBD7CAEE">      s1 </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">a1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 24</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 96</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> index </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 80</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#CB7676"> !</span><span style="color:#80A665">strncmp</span><span style="color:#e6cc77">(</span><span style="color:#BD976A">s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> name</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#CB7676">uLL</span><span style="color:#e6cc77">)</span><span style="color:#666666"> </span><span style="color:#d9739f">)</span><br><span style="color:#666666">      </span><span style="color:#d9739f">{</span><br><span style="color:#BD976A">        s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">weight</span><span style="color:#CB7676"> +=</span><span style="color:#DBD7CAEE"> size</span><span style="color:#666666">;</span><br><span style="color:#80A665">        LODWORD</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">v3</span><span style="color:#e6cc77">)</span><span style="color:#666666"> =</span><span style="color:#80A665"> printf</span><span style="color:#e6cc77">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">It </span><span style="color:#C99076">%s</span><span style="color:#C98A7D"> has weight </span><span style="color:#C99076">%zu\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#BD976A"> s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">weight</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#666666">      </span><span style="color:#d9739f">}</span><br><span style="color:#DBD7CAEE">      v3 </span><span style="color:#666666">=</span><span style="color:#CB7676"> *</span><span style="color:#d9739f">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">a1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> index</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">==</span><span style="color:#DBD7CAEE"> v3 </span><span style="color:#d9739f">)</span><br><span style="color:#666666">      </span><span style="color:#d9739f">{</span><br><span style="color:#80A665">        strncpy</span><span style="color:#e6cc77">(</span><span style="color:#BD976A">s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> name</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#CB7676">uLL</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">        s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">weight</span><span style="color:#CB7676"> +=</span><span style="color:#DBD7CAEE"> size</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        if</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE"> name </span><span style="color:#CB7676">!=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">useless</span><span style="color:#C98A7D77">"</span><span style="color:#666666"> </span><span style="color:#e6cc77">)</span><br><span style="color:#80A665">          printf</span><span style="color:#e6cc77">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">It </span><span style="color:#C99076">%s</span><span style="color:#C98A7D"> has weight </span><span style="color:#C99076">%zu\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#BD976A"> s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">weight</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">        ++*</span><span style="color:#e6cc77">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">a1 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> index</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">        LODWORD</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">v3</span><span style="color:#e6cc77">)</span><span style="color:#666666"> =</span><span style="color:#80A665"> sub_133C</span><span style="color:#e6cc77">(</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">qword_4060</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">useless</span><span style="color:#C98A7D77">"</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#666666">      </span><span style="color:#d9739f">}</span><br><span style="color:#666666">    </span><span style="color:#d4976c">}</span><br><span style="color:#666666">  </span><span style="color:#4d9375">}</span><br><span style="color:#4D9375">  return</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>接下来看 a1，注意到 <code class="inline-code">s1 = (*a1 + 24 * i + 96 * index + 80);</code> 这一行，由于是给 <code class="inline-code">*a1</code> 进行加偏移的操作访问内存，说明 a1 应该有个指针套指针。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">struct</span><span style="color:#393A34"> map </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">  map_data </span><span style="color:#AB5959">*</span><span style="color:#393A34">data</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> map </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">  map_data </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">data</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br></code></pre></div>
<p>再者，由于这里同时存在两个偏移量，说明是二维数组，形式如 <code class="inline-code">i * offset1 + j * offset2</code>，其中所乘的 <code class="inline-code">offset</code> 大说明相应的下标在前面，这里就是 index 在前面，i 在后面，而 <code class="inline-code">gcd(offset1, offset2)</code> 就是这个数组里元素的大小，这里是 24，说明是个自定义类型。</p>
<p>最后面有个 <code class="inline-code">80</code> 常数，说明这个数据结构的数组前面常驻 80 字节的偏移，而 <code class="inline-code">++*(*a1 + 8 * index);</code> 这一句正是在操作这 80 字节的内部，所以有</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">struct</span><span style="color:#393A34"> map_data </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">  __int64 </span><span style="color:#B07D48">bins_size</span><span style="color:#1e754f">[</span><span style="color:#2F798A">10</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#393A34">  map_entry </span><span style="color:#B07D48">bins</span><span style="color:#1e754f">[</span><span style="color:#2F798A">10</span><span style="color:#1e754f">]</span><span style="color:#1e754f">[</span><span style="color:#2F798A">96</span><span style="color:#AB5959">/</span><span style="color:#2F798A">24</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 前标的范围是根据上下文得到的，后面的范围是用大的 offset 除以小的 offset</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> map_data </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">  __int64 </span><span style="color:#BD976A">bins_size</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">10</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  map_entry </span><span style="color:#BD976A">bins</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">10</span><span style="color:#4d9375">]</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">96</span><span style="color:#CB7676">/</span><span style="color:#4C9A91">24</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 前标的范围是根据上下文得到的，后面的范围是用大的 offset 除以小的 offset</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br></code></pre></div>
<p>最后就逆的很完美了，也很容易看出来对应的漏洞。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">int</span><span style="color:#393A34"> __fastcall </span><span style="color:#59873A">feed</span><span style="color:#2993a3">(</span><span style="color:#393A34">map </span><span style="color:#AB5959">*</span><span style="color:#B07D48">a1</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#393A34"> __int64 </span><span style="color:#B07D48">size</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 v3</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // rax</span><br><span style="color:#393A34">  map_entry </span><span style="color:#AB5959">*</span><span style="color:#393A34">s1</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+20h] [rbp-20h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 index</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+28h] [rbp-18h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 v8</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+30h] [rbp-10h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#393A34"> __int64 i</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+38h] [rbp-8h]</span><br><br><span style="color:#393A34">  v3 </span><span style="color:#999999">=</span><span style="color:#59873A"> sub_12C9</span><span style="color:#1e754f">(</span><span style="color:#393A34">name</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  v8 </span><span style="color:#999999">=</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> v3 </span><span style="color:#1e754f">)</span><br><span style="color:#999999">  </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">    v3 </span><span style="color:#999999">=</span><span style="color:#2F798A"> 10</span><span style="color:#AB5959"> *</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">v3 </span><span style="color:#AB5959">/</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">    index </span><span style="color:#999999">=</span><span style="color:#393A34"> v8 </span><span style="color:#AB5959">%</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    for</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">A</span><span style="color:#999999">;</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">i </span><span style="color:#a65e2b">)</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">{</span><br><span style="color:#393A34">      s1 </span><span style="color:#999999">=</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">a1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">data</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">bins</span><span style="color:#a13865">[</span><span style="color:#393A34">index</span><span style="color:#a13865">]</span><span style="color:#a13865">[</span><span style="color:#393A34">i</span><span style="color:#a13865">]</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#AB5959"> !</span><span style="color:#59873A">strncmp</span><span style="color:#bda437">(</span><span style="color:#B07D48">s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#393A34"> name</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#AB5959">uLL</span><span style="color:#bda437">)</span><span style="color:#999999"> </span><span style="color:#a13865">)</span><br><span style="color:#999999">      </span><span style="color:#a13865">{</span><br><span style="color:#B07D48">        s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">weight</span><span style="color:#AB5959"> +=</span><span style="color:#393A34"> size</span><span style="color:#999999">;</span><br><span style="color:#59873A">        LODWORD</span><span style="color:#bda437">(</span><span style="color:#393A34">v3</span><span style="color:#bda437">)</span><span style="color:#999999"> =</span><span style="color:#59873A"> printf</span><span style="color:#bda437">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">It </span><span style="color:#A65E2B">%s</span><span style="color:#B56959"> has weight </span><span style="color:#A65E2B">%zu\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#B07D48"> s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">weight</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#999999">      </span><span style="color:#a13865">}</span><br><span style="color:#393A34">      v3 </span><span style="color:#999999">=</span><span style="color:#B07D48"> a1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">data</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">bins_size</span><span style="color:#a13865">[</span><span style="color:#393A34">index</span><span style="color:#a13865">]</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34"> i </span><span style="color:#AB5959">==</span><span style="color:#393A34"> v3 </span><span style="color:#a13865">)</span><br><span style="color:#999999">      </span><span style="color:#a13865">{</span><br><span style="color:#59873A">        strncpy</span><span style="color:#bda437">(</span><span style="color:#B07D48">s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#393A34"> name</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#AB5959">uLL</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">        s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">weight</span><span style="color:#AB5959"> +=</span><span style="color:#393A34"> size</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#393A34"> name </span><span style="color:#AB5959">!=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">useless</span><span style="color:#B5695977">"</span><span style="color:#999999"> </span><span style="color:#bda437">)</span><br><span style="color:#59873A">          printf</span><span style="color:#bda437">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">It </span><span style="color:#A65E2B">%s</span><span style="color:#B56959"> has weight </span><span style="color:#A65E2B">%zu\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">name</span><span style="color:#999999">,</span><span style="color:#B07D48"> s1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">weight</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">        ++</span><span style="color:#B07D48">a1</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">data</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">bins_size</span><span style="color:#bda437">[</span><span style="color:#393A34">index</span><span style="color:#bda437">]</span><span style="color:#999999">;</span><br><span style="color:#59873A">        LODWORD</span><span style="color:#bda437">(</span><span style="color:#393A34">v3</span><span style="color:#bda437">)</span><span style="color:#999999"> =</span><span style="color:#59873A"> gift</span><span style="color:#bda437">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">qword_4060</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">useless</span><span style="color:#B5695977">"</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#999999">      </span><span style="color:#a13865">}</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">}</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> __fastcall </span><span style="color:#80A665">feed</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">map </span><span style="color:#CB7676">*</span><span style="color:#BD976A">a1</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> __int64 </span><span style="color:#BD976A">size</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 v3</span><span style="color:#666666">;</span><span style="color:#758575DD"> // rax</span><br><span style="color:#DBD7CAEE">  map_entry </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">s1</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+20h] [rbp-20h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 index</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+28h] [rbp-18h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 v8</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+30h] [rbp-10h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#DBD7CAEE"> __int64 i</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+38h] [rbp-8h]</span><br><br><span style="color:#DBD7CAEE">  v3 </span><span style="color:#666666">=</span><span style="color:#80A665"> sub_12C9</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">name</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  v8 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> v3 </span><span style="color:#4d9375">)</span><br><span style="color:#666666">  </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">    v3 </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 10</span><span style="color:#CB7676"> *</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">v3 </span><span style="color:#CB7676">/</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    index </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> v8 </span><span style="color:#CB7676">%</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#666666">;</span><br><span style="color:#4D9375">    for</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676">LL</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">A</span><span style="color:#666666">;</span><span style="color:#CB7676"> ++</span><span style="color:#DBD7CAEE">i </span><span style="color:#d4976c">)</span><br><span style="color:#666666">    </span><span style="color:#d4976c">{</span><br><span style="color:#DBD7CAEE">      s1 </span><span style="color:#666666">=</span><span style="color:#CB7676"> &#x26;</span><span style="color:#BD976A">a1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">data</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">bins</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">index</span><span style="color:#d9739f">]</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#d9739f">]</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#CB7676"> !</span><span style="color:#80A665">strncmp</span><span style="color:#e6cc77">(</span><span style="color:#BD976A">s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> name</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#CB7676">uLL</span><span style="color:#e6cc77">)</span><span style="color:#666666"> </span><span style="color:#d9739f">)</span><br><span style="color:#666666">      </span><span style="color:#d9739f">{</span><br><span style="color:#BD976A">        s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">weight</span><span style="color:#CB7676"> +=</span><span style="color:#DBD7CAEE"> size</span><span style="color:#666666">;</span><br><span style="color:#80A665">        LODWORD</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">v3</span><span style="color:#e6cc77">)</span><span style="color:#666666"> =</span><span style="color:#80A665"> printf</span><span style="color:#e6cc77">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">It </span><span style="color:#C99076">%s</span><span style="color:#C98A7D"> has weight </span><span style="color:#C99076">%zu\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#BD976A"> s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">weight</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#666666">      </span><span style="color:#d9739f">}</span><br><span style="color:#DBD7CAEE">      v3 </span><span style="color:#666666">=</span><span style="color:#BD976A"> a1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">data</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">bins_size</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">index</span><span style="color:#d9739f">]</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">==</span><span style="color:#DBD7CAEE"> v3 </span><span style="color:#d9739f">)</span><br><span style="color:#666666">      </span><span style="color:#d9739f">{</span><br><span style="color:#80A665">        strncpy</span><span style="color:#e6cc77">(</span><span style="color:#BD976A">s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> name</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#CB7676">uLL</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">        s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">weight</span><span style="color:#CB7676"> +=</span><span style="color:#DBD7CAEE"> size</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        if</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE"> name </span><span style="color:#CB7676">!=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">useless</span><span style="color:#C98A7D77">"</span><span style="color:#666666"> </span><span style="color:#e6cc77">)</span><br><span style="color:#80A665">          printf</span><span style="color:#e6cc77">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">It </span><span style="color:#C99076">%s</span><span style="color:#C98A7D"> has weight </span><span style="color:#C99076">%zu\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">name</span><span style="color:#666666">,</span><span style="color:#BD976A"> s1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">weight</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">        ++</span><span style="color:#BD976A">a1</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">data</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">bins_size</span><span style="color:#e6cc77">[</span><span style="color:#DBD7CAEE">index</span><span style="color:#e6cc77">]</span><span style="color:#666666">;</span><br><span style="color:#80A665">        LODWORD</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">v3</span><span style="color:#e6cc77">)</span><span style="color:#666666"> =</span><span style="color:#80A665"> gift</span><span style="color:#e6cc77">(</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">qword_4060</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">useless</span><span style="color:#C98A7D77">"</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#666666">      </span><span style="color:#d9739f">}</span><br><span style="color:#666666">    </span><span style="color:#d4976c">}</span><br><span style="color:#666666">  </span><span style="color:#4d9375">}</span><br><span style="color:#4D9375">  return</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>总结</a></h2>
<ol>
<li>整数或指针：如果使用32位或64位指令（如 mov），并且偏移量是4或8的倍数，这通常意味着访问的是整数或指针。</li>
<li>字符串或字符数组：当使用指针偏移方式（如 <code class="inline-code">mov eax, [ebx+4]</code> 后的 <code class="inline-code">mov byte ptr [eax], 'A'</code> ）并且访问的是一个字节时，可能是字符或字符数组。</li>
<li>浮点数或大整数：如果程序使用 <code class="inline-code">fld</code>、<code class="inline-code">fstp</code> 这样的浮点指令，可能意味着正在处理浮点数或结构体中的浮点类型成员。</li>
</ol>
<p>总结一下，这玩意的重点还是在于细心和对上下文的合理推测，基本上把乱七八糟的指针引用弄干净了就算是逆向完成了。</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>