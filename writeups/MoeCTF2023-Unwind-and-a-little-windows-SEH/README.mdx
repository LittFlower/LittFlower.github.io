<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>Windows x86 SEH 机制 | 花盆</title><meta name="author" content="LittFlower"/><meta property="og:title" content="Windows x86 SEH 机制 | 花盆"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/writeups/MoeCTF2023-Unwind-and-a-little-windows-SEH/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="stylesheet" href="/fonts.css" type="text/css" preload/><link rel="stylesheet" href="/style.css" type="text/css" preload/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="windows-x86-seh-moectf2023-unwind" class="scroll-target"><a href="#windows-x86-seh-moectf2023-unwind"><code class="hash inline-code">#</code>Windows x86 SEH 机制暨 MoeCTF2023 Unwind 解题报告</a></h1>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>前言</a></h2>
<p>去年 MoeCTF 2022 的时候云姐姐出了个除零异常的题，当时在机房几个人七嘴八舌怼汇编还能勉强做出来....</p>
<p>今年 MoeCTF 2023 的时候云姐姐又双出了这么一个题，我做的时候就比较坐牢了......想了想还是从原理出发完全地了解一下这个知识点，再做做这么个题。</p>
<p><del>高难警告</del></p>
<h2 id="seh" class="scroll-target"><a href="#seh"><code class="hash inline-code">#</code>SEH 学习</a></h2>
<h3 id="seh" class="scroll-target"><a href="#seh"><code class="hash inline-code">#</code>认识 SEH</a></h3>
<blockquote>
<p>使用 SEH，你可以确保在执行意外终止时，可以正确地释放资源（如内存块和文件）。 ——《Structured Exception Handling》</p>
</blockquote>
<p>所谓 SEH，全称即 &quot;Structure Exception Handler&quot; —— 结构化异常处理器。</p>
<p>需要明确：SEH 是针对于<strong>异常</strong>的一种<strong>处理机制</strong>。首先，异常分为两方面来讲：硬件异常和软件异常。</p>
<ul>
<li>硬件异常：这里的“硬件”的定义十分狭隘 —— 仅限于 CPU 异常，例如除零异常，它就是 CPU 在执行除零操作时会自动触发的异常处理机制；</li>
<li>软件异常：由程序模拟的异常，软件异常可以既可以由操作系统触发，也可以由程序员随意触发。</li>
</ul>
<p><em>SEH 并非专为 C/C++ 设计，它是 windows 给的一套通用性的解决方案，因此尽管我们可以在代码中随时使用它们，但是应当优先使用 c++ ISO 标准化的异常处理（try - catch）</em><del>（也就是说不要把这东西往工程代码里写啊喂）</del></p>
<p>SEH 也有两种处理机制：</p>
<ul>
<li>异常处理程序 __except 块：它基于 <code class="inline-code">filter-expression</code> 值响应或消除异常；</li>
<li>终止处理程序 __finally 块：无论异常是否终止都要继续调用之。</li>
</ul>
<p>Windows x86 提供的异常处理机制其实只是一个简单的框架，在此基础上有各编译器提供的增强版异常处理机制。故我们将 windows SEH 机制分为系统实现的原始版本、编译器实现的增强版本 两方面来讲。</p>
<p><em>约定：简单地将 SEH 理解为：系统提供的异常处理机制，包括编译器对其进行增强的部分。</em></p>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>系统实现版本</a></h3>
<p>系统实现的原生 SEH 只是一个简单的框架，它有一个前提是“<strong>允许任何人触发异常，允许任何人处理异常</strong>”。它的运作机制如下：</p>
<ul>
<li>登记：系统把触发异常时的栈帧信息保存在一个链表里，并且将这个链表保存在线程的数据结构里。也就是说，异常涉及的行为是线程相关的。</li>
<li>抛出：线程抛出异常；</li>
<li>响应：系统找到抛出异常的线程的异常处理链表；</li>
<li>分发、处理异常（异常处理函数必须由用户具体实现）。</li>
</ul>
<p>最后一步是最核心的系统管理工作，后续会重点讲解。</p>
<h4 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>源代码</a></h4>
<p>先给出使用的数据结构与宏，后续看到不记得的数据结构与宏可以随时回滚鼠标翻阅：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EXCEPTION_CHAIN_END</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#AB5959">struct</span><span style="color:#393A34"> _EXCEPTION_REGISTRATION_RECORD </span><span style="color:#AB5959">*</span><span style="color:#393A34"> POINTER_32</span><span style="color:#1e754f">)</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0">// 标记链表结束的常量</span><br><br><br><span style="color:#1E754F">typedef</span><span style="color:#AB5959"> enum</span><span style="color:#393A34"> _EXCEPTION_DISPOSITION </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">        ExceptionContinueExecution</span><span style="color:#999999">,</span><br><span style="color:#393A34">        ExceptionContinueSearch</span><span style="color:#999999">,</span><br><span style="color:#393A34">        ExceptionNestedException</span><span style="color:#999999">,</span><br><span style="color:#393A34">        ExceptionCollidedUnwind</span><br><span style="color:#2993a3">}</span><span style="color:#393A34"> EXCEPTION_DISPOSITION</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0"> // 声明一个关于异常处理的枚举类型</span><br><br><span style="color:#1E754F">typedef</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> _EXCEPTION_RECORD </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">        DWORD ExceptionCode</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 赋予异常代码，后文会列举较为常见的一些</span><br><span style="color:#393A34">        DWORD ExceptionFlags</span><span style="color:#999999">;</span><br><span style="color:#AB5959">        struct</span><span style="color:#393A34"> _EXCEPTION_RECORD </span><span style="color:#AB5959">*</span><span style="color:#393A34">ExceptionRecord</span><span style="color:#999999">;</span><br><span style="color:#393A34">        PVOID ExceptionAddress</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 异常发生的地址</span><br><span style="color:#393A34">        DWORD NumberParameters</span><span style="color:#999999">;</span><br><span style="color:#393A34">        ULONG_PTR </span><span style="color:#B07D48">ExceptionInformation</span><span style="color:#1e754f">[</span><span style="color:#393A34">EXCEPTION_MAXIMUM_PARAMETERS</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#393A34"> EXCEPTION_RECORD</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0"> // 这个结构定义在 WINNT.H，结构中的其余项暂不关注</span><br><br><span style="color:#1E754F">typedef</span><span style="color:#393A34"> EXCEPTION_RECORD </span><span style="color:#AB5959">*</span><span style="color:#393A34">PEXCEPTION_RECORD</span><span style="color:#999999">;</span><br><br><br><span style="color:#1E754F">typedef</span><br><span style="color:#393A34">EXCEPTION_DISPOSITION</span><br><span style="color:#2993a3">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">PEXCEPTION_ROUTINE</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><br><span style="color:#393A34">        IN </span><span style="color:#AB5959">struct</span><span style="color:#393A34"> _EXCEPTION_RECORD </span><span style="color:#AB5959">*</span><span style="color:#393A34">ExceptionRecord</span><span style="color:#999999">,</span><br><span style="color:#393A34">        IN PVOID EstablisherFrame</span><span style="color:#999999">,</span><br><span style="color:#393A34">        IN OUT </span><span style="color:#AB5959">struct</span><span style="color:#393A34"> _CONTEXT </span><span style="color:#AB5959">*</span><span style="color:#393A34">ContextRecord</span><span style="color:#999999">,</span><br><span style="color:#393A34">        IN OUT PVOID DispatcherContext</span><br><span style="color:#999999">    </span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><br><span style="color:#1E754F">typedef</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> _EXCEPTION_REGISTRATION_RECORD </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">        struct</span><span style="color:#393A34"> _EXCEPTION_REGISTRATION_RECORD </span><span style="color:#AB5959">*</span><span style="color:#393A34">Next</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 链表指针</span><br><span style="color:#393A34">        PEXCEPTION_ROUTINE Handler</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 指向异常处理函数</span><br><span style="color:#2993a3">}</span><span style="color:#393A34"> EXCEPTION_REGISTRATION_RECORD</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">// 异常登记信息链表，链表中的最后一个结点会将 Next 置为 EXCEPTION_CHAIN_END，表示链表到此结束。</span><br><span style="color:#A0ADA0">// 线程信息块的第一个DWORD（在基于Intel CPU的机器上是FS:[0]）指向这个链表的头部。</span><br><br><br><span style="color:#1E754F">typedef</span><span style="color:#393A34"> EXCEPTION_REGISTRATION_RECORD </span><span style="color:#AB5959">*</span><span style="color:#393A34">PEXCEPTION_REGISTRATION_RECORD</span><span style="color:#999999">;</span><br><br><br><span style="color:#1E754F">typedef</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> _CONTEXT </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">            DWORD ContextFlags</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Dr0</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Dr1</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Dr2</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Dr3</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Dr6</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Dr7</span><span style="color:#999999">;</span><br><span style="color:#393A34">            FLOATING_SAVE_AREA FloatSave</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD SegGs</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD SegFs</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD SegEs</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD SegDs</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Edi</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Esi</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Ebx</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Edx</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Ecx</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Eax</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Ebp</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Eip</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD SegCs</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD EFlags</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD Esp</span><span style="color:#999999">;</span><br><span style="color:#393A34">            DWORD SegSs</span><span style="color:#999999">;</span><br><span style="color:#999999"> </span><span style="color:#2993a3">}</span><span style="color:#393A34"> CONTEXT</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EXCEPTION_CHAIN_END</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> _EXCEPTION_REGISTRATION_RECORD </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> POINTER_32</span><span style="color:#4d9375">)</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD">// 标记链表结束的常量</span><br><br><br><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> enum</span><span style="color:#DBD7CAEE"> _EXCEPTION_DISPOSITION </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">        ExceptionContinueExecution</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        ExceptionContinueSearch</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        ExceptionNestedException</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        ExceptionCollidedUnwind</span><br><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> EXCEPTION_DISPOSITION</span><span style="color:#666666">;</span><br><span style="color:#758575DD"> // 声明一个关于异常处理的枚举类型</span><br><br><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> _EXCEPTION_RECORD </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">        DWORD ExceptionCode</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 赋予异常代码，后文会列举较为常见的一些</span><br><span style="color:#DBD7CAEE">        DWORD ExceptionFlags</span><span style="color:#666666">;</span><br><span style="color:#CB7676">        struct</span><span style="color:#DBD7CAEE"> _EXCEPTION_RECORD </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">ExceptionRecord</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">        PVOID ExceptionAddress</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 异常发生的地址</span><br><span style="color:#DBD7CAEE">        DWORD NumberParameters</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">        ULONG_PTR </span><span style="color:#BD976A">ExceptionInformation</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">EXCEPTION_MAXIMUM_PARAMETERS</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> EXCEPTION_RECORD</span><span style="color:#666666">;</span><br><span style="color:#758575DD"> // 这个结构定义在 WINNT.H，结构中的其余项暂不关注</span><br><br><span style="color:#4D9375">typedef</span><span style="color:#DBD7CAEE"> EXCEPTION_RECORD </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">PEXCEPTION_RECORD</span><span style="color:#666666">;</span><br><br><br><span style="color:#4D9375">typedef</span><br><span style="color:#DBD7CAEE">EXCEPTION_DISPOSITION</span><br><span style="color:#5eaab5">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">PEXCEPTION_ROUTINE</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><br><span style="color:#DBD7CAEE">        IN </span><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> _EXCEPTION_RECORD </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">ExceptionRecord</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        IN PVOID EstablisherFrame</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        IN OUT </span><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> _CONTEXT </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">ContextRecord</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        IN OUT PVOID DispatcherContext</span><br><span style="color:#666666">    </span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><br><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> _EXCEPTION_REGISTRATION_RECORD </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">        struct</span><span style="color:#DBD7CAEE"> _EXCEPTION_REGISTRATION_RECORD </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">Next</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 链表指针</span><br><span style="color:#DBD7CAEE">        PEXCEPTION_ROUTINE Handler</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 指向异常处理函数</span><br><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> EXCEPTION_REGISTRATION_RECORD</span><span style="color:#666666">;</span><br><span style="color:#758575DD">// 异常登记信息链表，链表中的最后一个结点会将 Next 置为 EXCEPTION_CHAIN_END，表示链表到此结束。</span><br><span style="color:#758575DD">// 线程信息块的第一个DWORD（在基于Intel CPU的机器上是FS:[0]）指向这个链表的头部。</span><br><br><br><span style="color:#4D9375">typedef</span><span style="color:#DBD7CAEE"> EXCEPTION_REGISTRATION_RECORD </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">PEXCEPTION_REGISTRATION_RECORD</span><span style="color:#666666">;</span><br><br><br><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> _CONTEXT </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">            DWORD ContextFlags</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Dr0</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Dr1</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Dr2</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Dr3</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Dr6</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Dr7</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            FLOATING_SAVE_AREA FloatSave</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD SegGs</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD SegFs</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD SegEs</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD SegDs</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Edi</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Esi</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Ebx</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Edx</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Ecx</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Eax</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Ebp</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Eip</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD SegCs</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD EFlags</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD Esp</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            DWORD SegSs</span><span style="color:#666666">;</span><br><span style="color:#666666"> </span><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> CONTEXT</span><span style="color:#666666">;</span><br></code></pre></div>
<p>使用的关键函数：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">EXCEPTION_DISPOSITION</span><br><span style="color:#393A34">__cdecl </span><span style="color:#59873A">_except_handler</span><span style="color:#2993a3">(</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> _EXCEPTION_RECORD </span><span style="color:#AB5959">*</span><span style="color:#B07D48">ExceptionRecord</span><span style="color:#999999">,</span><br><span style="color:#AB5959">                        void</span><span style="color:#AB5959"> *</span><span style="color:#B07D48"> EstablisherFrame</span><span style="color:#999999">,</span><br><span style="color:#AB5959">                        struct</span><span style="color:#393A34"> _CONTEXT </span><span style="color:#AB5959">*</span><span style="color:#B07D48">ContextRecord</span><span style="color:#999999">,</span><br><span style="color:#AB5959">                        void</span><span style="color:#AB5959"> *</span><span style="color:#B07D48"> DispatcherContext</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">EXCEPTION_DISPOSITION</span><br><span style="color:#DBD7CAEE">__cdecl </span><span style="color:#80A665">_except_handler</span><span style="color:#5eaab5">(</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> _EXCEPTION_RECORD </span><span style="color:#CB7676">*</span><span style="color:#BD976A">ExceptionRecord</span><span style="color:#666666">,</span><br><span style="color:#CB7676">                        void</span><span style="color:#CB7676"> *</span><span style="color:#BD976A"> EstablisherFrame</span><span style="color:#666666">,</span><br><span style="color:#CB7676">                        struct</span><span style="color:#DBD7CAEE"> _CONTEXT </span><span style="color:#CB7676">*</span><span style="color:#BD976A">ContextRecord</span><span style="color:#666666">,</span><br><span style="color:#CB7676">                        void</span><span style="color:#CB7676"> *</span><span style="color:#BD976A"> DispatcherContext</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br></code></pre></div>
<p>依照源代码，我们可以更详细地理解系统最后一步的管理工作：</p>
<ul>
<li>系统找到当前异常线程的链表；</li>
<li>从链表中的第一个结点开始遍历，找到一个 <code class="inline-code">EXCEPTION_REGISTRATION_RECORD</code> 就调用它的 <code class="inline-code">Handler</code>；</li>
<li>把该异常（由第一个类型为 <code class="inline-code">EXCEPTION_RECORD</code> 的参数表示）传递给该 <code class="inline-code">Handler</code>，<code class="inline-code">Handler</code> 处理并返回一个类型为 <code class="inline-code">EXCEPTION_DISPOSITION</code> 的枚举值；
<ul>
<li>没有处理异常，继续在链表中搜索（<code class="inline-code">EXCEPTION_CONTINUE_SEARCH</code>）；</li>
<li>识别异常，但已将其消除（<code class="inline-code">EXCEPTION_CONTINUE_EXECUTION</code>）；</li>
<li>在处理异常过程中，调用表达式函数时再次触发异常（<code class="inline-code">ExceptionNestedException</code>）；</li>
<li>在展开过程中调用处理异常函数时再次触发异常（<code class="inline-code">ExceptionCollidedUnwind</code>）；</li>
</ul>
</li>
<li>系统根据不同的返回值来继续遍历异常链表或者回到触发点继续执行。</li>
</ul>
<h4 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>更进一步</a></h4>
<p><em>注意：以下的异常处理流程均为内核模式。</em></p>
<p><del>按理来说用户模式大差不差，但我没看（bushi</del></p>
<p>在 x86 架构的操作系统中，<code class="inline-code">IDT</code>（Interrupt Descriptor Table）是一种用于管理中断和异常处理的数据结构。IDT 中的 <code class="inline-code">KiTrap??</code> 项实际上是操作系统内核中的中断或异常处理程序的入口点。<code class="inline-code">KiTrap </code>是一种命名约定，后面的 <code class="inline-code">??</code> 表示具体的中断或异常号。</p>
<h5 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>硬件异常</a></h5>
<p>我们来看看更具体的内核异常流程。</p>
<p>首先，CPU 执行的指令触发了异常，CPU 改执行 <code class="inline-code">IDT</code> 中 <code class="inline-code">KiTrap??</code>，<code class="inline-code">KiTrap??</code> 会调用 <code class="inline-code">KiDispatchException</code>，该函数源代码如下：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">VOID </span><span style="color:#59873A">KiDispatchException</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><br><span style="color:#393A34">        IN PEXCEPTION_RECORD </span><span style="color:#B07D48">ExceptionRecord</span><span style="color:#999999">,</span><br><span style="color:#393A34">        IN PKEXCEPTION_FRAME </span><span style="color:#B07D48">ExceptionFrame</span><span style="color:#999999">,</span><br><span style="color:#393A34">        IN PKTRAP_FRAME </span><span style="color:#B07D48">TrapFrame</span><span style="color:#999999">,</span><br><span style="color:#393A34">        IN KPROCESSOR_MODE </span><span style="color:#B07D48">PreviousMode</span><span style="color:#999999">,</span><br><span style="color:#393A34">        IN BOOLEAN FirstChance</span><br><span style="color:#999999">    </span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">// 该函数的主要功能就是分派异常。</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">VOID </span><span style="color:#80A665">KiDispatchException</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><br><span style="color:#DBD7CAEE">        IN PEXCEPTION_RECORD </span><span style="color:#BD976A">ExceptionRecord</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        IN PKEXCEPTION_FRAME </span><span style="color:#BD976A">ExceptionFrame</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        IN PKTRAP_FRAME </span><span style="color:#BD976A">TrapFrame</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        IN KPROCESSOR_MODE </span><span style="color:#BD976A">PreviousMode</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        IN BOOLEAN FirstChance</span><br><span style="color:#666666">    </span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#758575DD">// 该函数的主要功能就是分派异常。</span><br></code></pre></div>
<ol>
<li>在当前栈中分配一个 <code class="inline-code">CONTEXT</code>，调用 <code class="inline-code">KeContextFromKframes</code> 初始化它；</li>
<li>检查 <code class="inline-code">ExceptionRecord->ExceptionCode</code>；</li>
<li>检查 <code class="inline-code">PreviousMode</code>：
<ul>
<li>如果为 <code class="inline-code">KernalMode</code>：
<ul>
<li>如果 <code class="inline-code">FirstChance</code> 为 <code class="inline-code">TRUE</code>，那么将该异常传达给内核调试器，如果内核调试器没有处理，那么调用 <code class="inline-code">RtlDispatchException</code> 进行处理。</li>
<li>如果 <code class="inline-code">FirstChance</code> 为 <code class="inline-code">FALSE</code>，那么再次将该异常传达给内核调试器，如果内核调试器没有处理，那么 <code class="inline-code">BUGCHECK</code>（程序崩溃）。</li>
</ul>
</li>
<li>如果为 <code class="inline-code">UserMode</code>：
<ul>
<li>如果 <code class="inline-code">FirstChance</code> 为 <code class="inline-code">TRUE</code>，那么将该异常传达给内核调试器，如果内核调试器没有处理，那么将异常传达给应用层调试器。如果仍然没有处理，那么将 <code class="inline-code">KTRAP_FRAME</code> 和 <code class="inline-code">EXCEPTION_RECORD</code> 拷贝到 <code class="inline-code">UserMode</code> 的栈中，并设置 <code class="inline-code">KTRAP_FRAME::Eip</code> 设置为 <code class="inline-code">ntdll!KiUserExceptionDispatcher</code>，返回（将该异常交由应用层异常处理程序进行处理）。</li>
<li>如果 <code class="inline-code">FirstChance</code> 为 <code class="inline-code">FALSE</code>，那么再次将异常传达给应用层调试器，如果仍然没有处理，那么调用 <code class="inline-code">ZwTerminateProcess</code> 结束进程，并 <code class="inline-code">BUGCHECK</code>。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>抛开应用层异常不说，我们来看 <code class="inline-code">PreviousMode</code> 是 <code class="inline-code">KernelMode</code> 的情况，其重点是调用 <code class="inline-code">RtlDispatchException</code> 的操作。在<a href="https://github.com/mic101/windows/blob/master/WRK-v1.2/base/ntos/rtl/i386/exdsptch.c" title="https://github.com/mic101/windows/blob/master/WRK-v1.2/base/ntos/rtl/i386/exdsptch.c" target="_blank" rel="noopener">这里</a>可以看到函数源代码，篇幅所限，<strong>非必要我不会贴上完整的源代码</strong>。</p>
<p>首先是这个函数的简单介绍，通过读注释了解到：这个函数的功能是通过向后搜索 <code class="inline-code">EXCEPTION_REGISTRATION_RECORD</code> 来把异常分发给以调用 <code class="inline-code">EXCEPTION_REGISTRATION_RECORD</code> 为基础的处理函数，这个搜索开始于上下文初始时指定的 <code class="inline-code">EXCEPTION_REGISTRATION_RECORD</code> ，结束于异常被处理、对栈帧的搜索非法或者已经搜索完毕。</p>
<p>定义：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">BOOLEAN </span><span style="color:#59873A">RtlDispatchException</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><br><span style="color:#393A34">        IN PEXCEPTION_RECORD </span><span style="color:#B07D48">ExceptionRecord</span><span style="color:#999999">,</span><br><span style="color:#393A34">        IN PCONTEXT ContextRecord</span><br><span style="color:#999999">    </span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">BOOLEAN </span><span style="color:#80A665">RtlDispatchException</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><br><span style="color:#DBD7CAEE">        IN PEXCEPTION_RECORD </span><span style="color:#BD976A">ExceptionRecord</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">        IN PCONTEXT ContextRecord</span><br><span style="color:#666666">    </span><span style="color:#5eaab5">)</span><br></code></pre></div>
<p>这个函数的第一个参数是提供一个指向异常记录信息的指针，第二个参数是提供一个指向堆栈信息的指针（相关的数据结构在上文已经给过）；返回值是一个 <code class="inline-code">bool</code>，如果异常被处理返回 <code class="inline-code">True</code>，否则返回 <code class="inline-code">False</code>。</p>
<p>有一个关键函数是 <code class="inline-code">RtlpExecuteHandlerForException</code>，可以在 34 行看到它的定义：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">EXCEPTION_DISPOSITION</span><br><span style="color:#59873A">RtlpExecuteHandlerForException</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><br><span style="color:#393A34">    IN PEXCEPTION_RECORD </span><span style="color:#B07D48">ExceptionRecord</span><span style="color:#999999">,</span><br><span style="color:#393A34">    IN PVOID </span><span style="color:#B07D48">EstablisherFrame</span><span style="color:#999999">,</span><br><span style="color:#393A34">    IN OUT PCONTEXT </span><span style="color:#B07D48">ContextRecord</span><span style="color:#999999">,</span><br><span style="color:#393A34">    IN OUT PVOID </span><span style="color:#B07D48">DispatcherContext</span><span style="color:#999999">,</span><br><span style="color:#393A34">    IN PEXCEPTION_ROUTINE ExceptionRoutine</span><br><span style="color:#999999">    </span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">EXCEPTION_DISPOSITION</span><br><span style="color:#80A665">RtlpExecuteHandlerForException</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><br><span style="color:#DBD7CAEE">    IN PEXCEPTION_RECORD </span><span style="color:#BD976A">ExceptionRecord</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">    IN PVOID </span><span style="color:#BD976A">EstablisherFrame</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">    IN OUT PCONTEXT </span><span style="color:#BD976A">ContextRecord</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">    IN OUT PVOID </span><span style="color:#BD976A">DispatcherContext</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">    IN PEXCEPTION_ROUTINE ExceptionRoutine</span><br><span style="color:#666666">    </span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br></code></pre></div>
<p>根据 <code class="inline-code">RtlDispatchException</code> 具体实现可以获知以下关键点：</p>
<ul>
<li>函数一开始会先进行栈空间检测，以免遍历超出栈空间；</li>
<li>依次遍历 <code class="inline-code">EXCEPTION_REGISTRATION_RECORD</code> 链表，通过 <code class="inline-code">RtlpExecuteHandlerForException</code> 调用异常处理函数，再根据后者的返回值做出不同的处理：
<ul>
<li><code class="inline-code">ExceptionContinueExecution</code>：对于 <code class="inline-code">ExceptionRecord->ExceptionFlags</code> 为 <code class="inline-code">EXCEPTION_NONCONTINUABLE </code>的异常，调用一个 <code class="inline-code">RtlRaiseException</code>； 否则结束遍历，直接返回 True；</li>
<li><code class="inline-code">ExceptionContinueSearch</code>：对于 <code class="inline-code">ExceptionRecord->ExceptionFlags</code> 为 <code class="inline-code">EXCEPTION_STACK_INVALID</code> 的函数，结束遍历，返回 <code class="inline-code">False</code>；否则继续遍历；</li>
<li><code class="inline-code">ExceptionNestedException</code>：出现了嵌套异常，从指定的新异常继续遍历。</li>
<li>其他的返回值：先调用 <code class="inline-code">RtlRaiseException</code> 起一个新异常，然后继续遍历；</li>
</ul>
</li>
</ul>
<p>总结一下 CPU 触发异常的处理与调用流程：</p>
<p><code class="inline-code">CPU test the Exception -> KiTrap?? -> KiDispatchException -> RtlDispatchException -> RtlpExecuteHandlerForException.</code></p>
<h5 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>软件异常</a></h5>
<p>软件异常跟硬件异常的处理流程非常接近，只有触发点的不同，调用流程是：</p>
<p><code class="inline-code">RtlRaiseException -> RtlDispatchException -> RtlpExecuteHandlerForException</code></p>
<p>后面两个被调用的函数咱已经聊过了，主要来看看 <code class="inline-code">RtlRaiseException</code>。</p>
<p>我们可以在<a href="https://github.com/HighSchoolSoftwareClub/Windows-Research-Kernel-WRK-/blob/master/WRK-v1.2/base/ntos/rtl/i386/raise.asm" title="https://github.com/HighSchoolSoftwareClub/Windows-Research-Kernel-WRK-/blob/master/WRK-v1.2/base/ntos/rtl/i386/raise.asm" target="_blank" rel="noopener">这里</a>的 43 行看到原型如下：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">VOID</span><br><span style="color:#59873A">RtlRaiseException</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><br><span style="color:#393A34">    IN PEXCEPTION_RECORD ExceptionRecord</span><br><span style="color:#999999">    </span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">VOID</span><br><span style="color:#80A665">RtlRaiseException</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><br><span style="color:#DBD7CAEE">    IN PEXCEPTION_RECORD ExceptionRecord</span><br><span style="color:#666666">    </span><span style="color:#5eaab5">)</span><br></code></pre></div>
<p>同样的，我们先根据注释对这个函数做一个初步了解：这个函数通过构建一个堆栈信息记录（<code class="inline-code">CONTEXT</code>）和调用异常分发程序（<code class="inline-code">RtlDispatcherException </code>）来抛出一个软件异常。如果 <code class="inline-code">RtlDispatcherException </code>找到了一个处理程序来处理异常，则调用该处理程序并恢复原程序执行，否则调用 <code class="inline-code">ZwRaiseException</code> 系统服务来提供默认处理。注意：i386 下此例程无法捕捉 <code class="inline-code">non-fp</code> 异常。</p>
<p>根据具体实现可得知：</p>
<ul>
<li>先调用 <code class="inline-code">_RtlCaptureContext</code> 获得调用者的 <code class="inline-code">CONTEXT</code>（即包括各种寄存器），注意，在此调用之前，状态标志的状态没有受到干扰；</li>
<li>获取 <code class="inline-code">PExceptionRecord</code>，并且将异常地址设置为这个函数的返回地址；</li>
<li>设置 <code class="inline-code">CONTEXT</code> 标志，表明将捕获所有的上下文信息；</li>
<li>直接运行一次 <code class="inline-code">RtlDispatchException</code>。
<ul>
<li>如果异常处理，则调用 <code class="inline-code">_ZwContinue</code>（它一般不会返回），故原程序继续执行；</li>
<li>如果异常未被处理，则进入异常处理分支，函数再次调用 <code class="inline-code">_ZwRaiseException</code>，<strong>尝试引发一个“二次”异常（second chance exception）</strong>，这次传入的异常的 <code class="inline-code">FirstChance</code> 被置为 <code class="inline-code">FALSE</code>（忘记 <code class="inline-code">FirstChance</code> 的可以回滚至硬件异常部分源代码）。</li>
</ul>
</li>
<li>如果函数参数列表自身有问题，才有可能跑到这里：它会调用 <code class="inline-code">_RtlRaiseStatus</code> 来引发一个非可继续异常，其中参数是前面异常处理的返回值，表示异常无法继续处理，程序将 BUGCHECK。</li>
</ul>
<h5 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>简单总结</a></h5>
<p>到这里，系统实现的 SEH 版本基本上已经讲解完毕。整个异常处理过程可以大概总结为：遍历异常链表，挨个调用异常注册信息的处理函数，如果其中有某个处理函数处理了该异常（返回值为 <code class="inline-code">ExceptionContinueExecution</code>），那么就从异常触发点（如果是断点异常，则要回退一个字节的指令（<code class="inline-code">int 3</code> 指令本身））重新执行。否则不管是整个链表中没有找到合适的处理函数（返回值为 <code class="inline-code">ExceptionContinueSearch </code>），或者遍历过程中出现问题（返回值为 <code class="inline-code">ExceptionNestedException</code>），系统都会简单粗暴的 BUGCHECK。</p>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>编译器增强版本</a></h3>
<p>增强版本有很多个，不同的编译器提供的的 SEH 增强版本或多或少都有不同之处。但是，他们一般都是基于 windows 系统提供的原始版本进行完善的。一个典型的增强版就是微软的编译器（后面简称为 MSC）里提供的 <code class="inline-code">__try</code>、<code class="inline-code">__finally</code>、<code class="inline-code">__except</code>。约定接下来使用这个增强版作为目标进行分析。</p>
<h4 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>初步认识</a></h4>
<p>在 Win32 SDK 文档中，有所谓的“基于帧”的异常处理程序模型：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-cpp language-cpp"><span style="color:#A0ADA0">// . . .</span><br><span style="color:#393A34">    __try </span><span style="color:#2993a3">{</span><br><span style="color:#A0ADA0">        // guarded code</span><br><span style="color:#999999">    </span><span style="color:#2993a3">}</span><br><span style="color:#59873A">    __except</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#A0ADA0"> /* filter expression */</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#A0ADA0">        // termination code</span><br><span style="color:#999999">    </span><span style="color:#2993a3">}</span><br><span style="color:#A0ADA0">    // . . .</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-cpp language-cpp"><span style="color:#758575DD">// . . .</span><br><span style="color:#DBD7CAEE">    __try </span><span style="color:#5eaab5">{</span><br><span style="color:#758575DD">        // guarded code</span><br><span style="color:#666666">    </span><span style="color:#5eaab5">}</span><br><span style="color:#80A665">    __except</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#758575DD"> /* filter expression */</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#758575DD">        // termination code</span><br><span style="color:#666666">    </span><span style="color:#5eaab5">}</span><br><span style="color:#758575DD">    // . . .</span><br></code></pre></div>
<p>称 <code class="inline-code">__try</code> 子句后的复合语句为受保护节，称 <code class="inline-code">except</code> 表达式为筛选表达式，它的值决定了异常的处理方式，称 <code class="inline-code">__except</code> 子句后的复合语句为异常处理程序。执行过程为</p>
<ol>
<li>执行受保护节</li>
<li>如果在受保护节执行过程中未发生异常，则继续执行 <strong><code class="inline-code">__except</code></strong> 子句之后的语句（注意：不会跳过异常处理程序）。</li>
<li>如果在受保护节的执行过程中或受保护节调用的任何例程中发生异常，则会计算 <strong><code class="inline-code">__except</code></strong> 表达式。
<ul>
<li>无法识别异常并将控制权转交给其他处理程序（<code class="inline-code">EXCEPTION_CONTINUE_SEARCH</code>）（0）</li>
<li>识别异常，已将其消除（<code class="inline-code">EXCEPTION_CONTINUE_EXECUTION</code>）（-1）</li>
<li>识别异常，将进行处理（<code class="inline-code">EXCEPTION_EXECUTE_HANDLER</code>）（1）</li>
</ul>
</li>
</ol>
<p>简单地说，在一个函数中，一个 <code class="inline-code">__try</code> 块中的所有代码就通过创建在这个函数的堆栈帧上的一个 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构来保护。在函数的入口处，这个新的 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构被放在异常处理程序链表的头部。在 <code class="inline-code">__try</code> 块结束后，相应的 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构从这个链表的头部被移除。正如系统原始版本中提过的，异常处理程序链表的头部被保存在 <code class="inline-code">FS:[0]</code> 处。因此，如果你在调试器中单步跟踪时看到类似下面的指令时</p>
<p><code class="inline-code"> MOV DWORD PTR FS:[00000000],ESP</code> 或者 <code class="inline-code">MOV DWORD PTR FS:[00000000],ECX</code></p>
<p>那么就可以确定这段代码正在进入或退出一个 <code class="inline-code">__try</code> / <code class="inline-code">__except</code> 块。</p>
<p>系统实现的 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构中的 <code class="inline-code">Handler</code> 函数相当于这里的 <code class="inline-code">filter expression</code>，这个过滤器表达式代码决定了后面的大括号中的代码是否执行。</p>
<p>由于过滤器表达式代码是程序员自己写的，当然可以自由决定在代码中的某个地方是否处理某个特定的异常。它可以简单的只是一句 <code class="inline-code">EXCEPTION_EXECUTE_HANDLER</code>，也可以是先 <code class="inline-code">sleep(114514)</code>，然后再返回一个值来告诉操作系统下一步做什么...（重点在于过滤器表达式返回值必须是我前面讲的有效的宏定义</p>
<p>以上听起来很简单，然而事实上，过滤器表达式代码并不是被操作系统直接调用的。实际上各个 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构的 <code class="inline-code">handler</code> 域都指向了同一个函数。这个函数在 Visual C++ Runtime 中，它被称为 <code class="inline-code">__except_handler4</code>；此外，并不是每次进入或退出一个 <code class="inline-code">__try</code> 块时就创建或撤销一个 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构。相反，在使用 SEH 的任何函数中只创建一个 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构。同样，你可以在一个函数中嵌套使用 <code class="inline-code">__try </code>块，但 Visual C++ 仍旧只是创建一个 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构。</p>
<p>显然，如果不扩增一些新的数据结构或者是使用一些 trick，以上功能是不可能实现的，这便是接下来要讲的东西。</p>
<h4 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>深入了解</a></h4>
<h5 id="vc" class="scroll-target"><a href="#vc"><code class="hash inline-code">#</code>VC 的标准异常帧</a></h5>
<p>Visual C++的 SEH实现并没有使用原始的 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构——它对原有的数据结构进行了修改（其余结构沿用），它是允许单个函数 <code class="inline-code">__except_handler4</code> 处理所有异常并将执行流程传递到相应的过滤器表达式和 <code class="inline-code">__except</code> 块的关键。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> TRYLEVEL_NONE</span><span style="color:#AB5959">             -</span><span style="color:#2F798A">2</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> TRYLEVEL_INVALID</span><span style="color:#AB5959">          -</span><span style="color:#2F798A">1</span><br><br><span style="color:#AB5959">struct</span><span style="color:#393A34"> SCOPETABLE_ENTRY</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">    unsigned</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> EnclosingLevel</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 构成链表结构</span><br><span style="color:#AB5959">    unsigned</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> FilterFunc</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 过滤器表达式代码的地址</span><br><span style="color:#AB5959">    unsigned</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> HandlerFunc</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 相应的__except块的地址</span><br><span style="color:#393A34">    DWORD GSCookieOffset</span><span style="color:#999999">;</span><br><span style="color:#393A34">    DWORD GSCookieXOROffset</span><span style="color:#999999">;</span><br><span style="color:#393A34">    DWORD EHCookieOffset</span><span style="color:#999999">;</span><br><span style="color:#393A34">    DWORD EHCookieXOROffset</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">struct</span><span style="color:#393A34"> EH4_EXCEPTION_REGISTRATION </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">        PEXCEPTION_POINTERS xpointers</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 指向 EXCEPTION_POINTERS 结构（一个标准的 Win32 结构）的指针</span><br><span style="color:#A0ADA0">                                       // 即调用 GetExceptionInformation 这个 API 时返回的指针</span><br><span style="color:#AB5959">        struct</span><span style="color:#393A34"> _EXCEPTION_REGISTRATION </span><span style="color:#AB5959">*</span><span style="color:#393A34">prev</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 将原有的 next 修改为了 prev</span><br><span style="color:#A0ADA0">        // 保留了 handler</span><br><span style="color:#AB5959">        void</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">handler</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">PEXCEPTION_RECORD</span><span style="color:#999999">,</span><br><span style="color:#393A34">                        PEXCEPTION_REGISTRATION</span><span style="color:#999999">,</span><br><span style="color:#393A34">                        PCONTEXT</span><span style="color:#999999">,</span><br><span style="color:#393A34">                        PEXCEPTION_RECORD</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">        // 新增加了 3 个域</span><br><span style="color:#AB5959">        struct</span><span style="color:#393A34"> SCOPETABLE_ENTRY </span><span style="color:#AB5959">*</span><span style="color:#393A34">scopetable</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 作用表域</span><br><span style="color:#AB5959">        int</span><span style="color:#393A34"> trylevel</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 作为 scopetable_entry 的索引</span><br><span style="color:#AB5959">        int</span><span style="color:#393A34"> _ebp</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // EXCEPTION_REGISTRATION 结构创建之前 EBP 的值</span><br><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> TRYLEVEL_NONE</span><span style="color:#CB7676">             -</span><span style="color:#4C9A91">2</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> TRYLEVEL_INVALID</span><span style="color:#CB7676">          -</span><span style="color:#4C9A91">1</span><br><br><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> SCOPETABLE_ENTRY</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">    unsigned</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> EnclosingLevel</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 构成链表结构</span><br><span style="color:#CB7676">    unsigned</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> FilterFunc</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 过滤器表达式代码的地址</span><br><span style="color:#CB7676">    unsigned</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> HandlerFunc</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 相应的__except块的地址</span><br><span style="color:#DBD7CAEE">    DWORD GSCookieOffset</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    DWORD GSCookieXOROffset</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    DWORD EHCookieOffset</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    DWORD EHCookieXOROffset</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> EH4_EXCEPTION_REGISTRATION </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">        PEXCEPTION_POINTERS xpointers</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 指向 EXCEPTION_POINTERS 结构（一个标准的 Win32 结构）的指针</span><br><span style="color:#758575DD">                                       // 即调用 GetExceptionInformation 这个 API 时返回的指针</span><br><span style="color:#CB7676">        struct</span><span style="color:#DBD7CAEE"> _EXCEPTION_REGISTRATION </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">prev</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 将原有的 next 修改为了 prev</span><br><span style="color:#758575DD">        // 保留了 handler</span><br><span style="color:#CB7676">        void</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">handler</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">PEXCEPTION_RECORD</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">                        PEXCEPTION_REGISTRATION</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">                        PCONTEXT</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">                        PEXCEPTION_RECORD</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#758575DD">        // 新增加了 3 个域</span><br><span style="color:#CB7676">        struct</span><span style="color:#DBD7CAEE"> SCOPETABLE_ENTRY </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">scopetable</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 作用表域</span><br><span style="color:#CB7676">        int</span><span style="color:#DBD7CAEE"> trylevel</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 作为 scopetable_entry 的索引</span><br><span style="color:#CB7676">        int</span><span style="color:#DBD7CAEE"> _ebp</span><span style="color:#666666">;</span><span style="color:#758575DD"> // EXCEPTION_REGISTRATION 结构创建之前 EBP 的值</span><br><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br></code></pre></div>
<p><em>注：本结构体只用于理解原始版和增强版的区别，实际代码中并没有这种形式的定义</em></p>
<p><code class="inline-code">_ebp</code> 域成为扩展的 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构的一部分并非偶然。它是通过 <code class="inline-code">PUSH EBP</code> 这条指令被包含进这个结构中的，而大多数函数开头都是这条指令（通常编译器并不为使用 FPO 优化的函数生成标准的堆栈帧，这样其第一条指令可能不是 <code class="inline-code">PUSH EBP </code>。但是如果使用了 SEH 的话，那么无论你是否使用了 FPO 优化，编译器一定生成标准的堆栈帧）。这条指令可以使 <code class="inline-code">EXCEPTION_REGISTRATION</code> 结构中所有其它的域都可以用一个相对于栈帧指针（<code class="inline-code">EBP</code>）的负偏移来访问，这样效率显然高得多。</p>
<p>根据以上源代码，可以基本模拟出一个 VSC 标准异常堆栈帧的内存布局：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">[EBP-00] _ebp
[EBP-04] trylevel
[EBP-08] scopetable数组指针
[EBP-0C] handler函数地址
[EBP-10] 指向前一个EXCEPTION_REGISTRATION结构
[EBP-14] GetExceptionInformation
[EBP-18] 栈帧中的标准ESP
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">[EBP-00] _ebp
[EBP-04] trylevel
[EBP-08] scopetable数组指针
[EBP-0C] handler函数地址
[EBP-10] 指向前一个EXCEPTION_REGISTRATION结构
[EBP-14] GetExceptionInformation
[EBP-18] 栈帧中的标准ESP
</code></pre></div>
<p>根据以上信息，我们以一个简单的伪代码分析一开始说的“嵌套的 <code class="inline-code">__try/__except</code> 块或同一个函数里多个并列 <code class="inline-code">__try/__except </code>块都共用同一个 <code class="inline-code">EXCEPTION_REGISTRATION</code> 是怎么实现的。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">VOID </span><span style="color:#59873A">SimpleSEH</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">    __try </span><span style="color:#1e754f">{</span><br><span style="color:#A0ADA0">        // A</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><span style="color:#59873A"> __except</span><span style="color:#1e754f">(</span><span style="color:#59873A">ExceptionFilter_0</span><span style="color:#a65e2b">(</span><span style="color:#393A34">...</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">        ExceptCodeBlock_0</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#393A34">    __try </span><span style="color:#1e754f">{</span><br><span style="color:#A0ADA0">        // C</span><br><span style="color:#393A34">        __try </span><span style="color:#a65e2b">{</span><br><span style="color:#A0ADA0">            // B</span><br><span style="color:#999999">        </span><span style="color:#a65e2b">}</span><span style="color:#59873A"> __except</span><span style="color:#a65e2b">(</span><span style="color:#59873A">ExceptionFilter_1</span><span style="color:#a13865">(</span><span style="color:#393A34">...</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#999999"> </span><span style="color:#a65e2b">{</span><br><span style="color:#393A34">            ExceptCodeBlock_1</span><span style="color:#999999">;</span><br><span style="color:#999999">            </span><span style="color:#a65e2b">}</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><span style="color:#59873A"> __except</span><span style="color:#1e754f">(</span><span style="color:#59873A">ExceptionFilter_2</span><span style="color:#a65e2b">(</span><span style="color:#393A34">...</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">        ExceptCodeBlock_2</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">VOID </span><span style="color:#80A665">SimpleSEH</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">    __try </span><span style="color:#4d9375">{</span><br><span style="color:#758575DD">        // A</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><span style="color:#80A665"> __except</span><span style="color:#4d9375">(</span><span style="color:#80A665">ExceptionFilter_0</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">...</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">        ExceptCodeBlock_0</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><br><span style="color:#DBD7CAEE">    __try </span><span style="color:#4d9375">{</span><br><span style="color:#758575DD">        // C</span><br><span style="color:#DBD7CAEE">        __try </span><span style="color:#d4976c">{</span><br><span style="color:#758575DD">            // B</span><br><span style="color:#666666">        </span><span style="color:#d4976c">}</span><span style="color:#80A665"> __except</span><span style="color:#d4976c">(</span><span style="color:#80A665">ExceptionFilter_1</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">...</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#666666"> </span><span style="color:#d4976c">{</span><br><span style="color:#DBD7CAEE">            ExceptCodeBlock_1</span><span style="color:#666666">;</span><br><span style="color:#666666">            </span><span style="color:#d4976c">}</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><span style="color:#80A665"> __except</span><span style="color:#4d9375">(</span><span style="color:#80A665">ExceptionFilter_2</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">...</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">        ExceptCodeBlock_2</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>编译时，编译器会为 SimpleSEH 分配一个 <code class="inline-code">EXCEPTION_REGISTRATION</code> 和一个拥有3个成员的 <code class="inline-code">scopetable</code> 数组，并将 <code class="inline-code">EXCEPTION_REGISTRATION::scopetable</code> 指向该数组（<em>请留意：<code class="inline-code">EXCEPTION_REGISTRATION::scopetable</code> 只是一个指针，不是数组</em>）。然后按照 <code class="inline-code">__try</code> 关键字出现的顺序，将对应的 <code class="inline-code">__except/__finally</code> 都存入该数组。假设我们已经了解了 <code class="inline-code">__except_handler4</code> 的具体实现（事实上我会在后文给出），并且已知这个函数会依次调用 <code class="inline-code">scopetable</code> 中的 <code class="inline-code">HandlerFunc</code>。</p>
<p>编译后得到的完整 <code class="inline-code">scopetable</code> 数组如下：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#B07D48">    scopetable</span><span style="color:#2993a3">[</span><span style="color:#2F798A">0</span><span style="color:#2993a3">]</span><span style="color:#393A34">.previousTryLevel </span><span style="color:#999999">=</span><span style="color:#393A34"> TRYLEVEL_NONE</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    scopetable</span><span style="color:#2993a3">[</span><span style="color:#2F798A">0</span><span style="color:#2993a3">]</span><span style="color:#393A34">.lpfnFilter </span><span style="color:#999999">=</span><span style="color:#393A34"> ExceptionFilter_0</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    scopetable</span><span style="color:#2993a3">[</span><span style="color:#2F798A">0</span><span style="color:#2993a3">]</span><span style="color:#393A34">.lpfnHandler </span><span style="color:#999999">=</span><span style="color:#393A34"> ExceptCodeBlock_0</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">    scopetable</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#393A34">.previousTryLevel </span><span style="color:#999999">=</span><span style="color:#393A34"> TRYLEVEL_NONE</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    scopetable</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#393A34">.lpfnFilter </span><span style="color:#999999">=</span><span style="color:#393A34"> ExceptionFilter_1</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    scopetable</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#393A34">.lpfnHandler </span><span style="color:#999999">=</span><span style="color:#393A34"> ExceptCodeBlock_1</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">    scopetable</span><span style="color:#2993a3">[</span><span style="color:#2F798A">2</span><span style="color:#2993a3">]</span><span style="color:#393A34">.previousTryLevel </span><span style="color:#999999">=</span><span style="color:#2F798A"> 1</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    scopetable</span><span style="color:#2993a3">[</span><span style="color:#2F798A">2</span><span style="color:#2993a3">]</span><span style="color:#393A34">.lpfnFilter </span><span style="color:#999999">=</span><span style="color:#393A34"> ExceptionFilter_2</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    scopetable</span><span style="color:#2993a3">[</span><span style="color:#2F798A">2</span><span style="color:#2993a3">]</span><span style="color:#393A34">.lpfnHandler </span><span style="color:#999999">=</span><span style="color:#393A34"> ExceptCodeBlock_2</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#BD976A">    scopetable</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">.previousTryLevel </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> TRYLEVEL_NONE</span><span style="color:#666666">;</span><br><span style="color:#BD976A">    scopetable</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">.lpfnFilter </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ExceptionFilter_0</span><span style="color:#666666">;</span><br><span style="color:#BD976A">    scopetable</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">.lpfnHandler </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ExceptCodeBlock_0</span><span style="color:#666666">;</span><br><br><span style="color:#BD976A">    scopetable</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">.previousTryLevel </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> TRYLEVEL_NONE</span><span style="color:#666666">;</span><br><span style="color:#BD976A">    scopetable</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">.lpfnFilter </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ExceptionFilter_1</span><span style="color:#666666">;</span><br><span style="color:#BD976A">    scopetable</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">.lpfnHandler </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ExceptCodeBlock_1</span><span style="color:#666666">;</span><br><br><span style="color:#BD976A">    scopetable</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">2</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">.previousTryLevel </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">;</span><br><span style="color:#BD976A">    scopetable</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">2</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">.lpfnFilter </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ExceptionFilter_2</span><span style="color:#666666">;</span><br><span style="color:#BD976A">    scopetable</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">2</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">.lpfnHandler </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ExceptCodeBlock_2</span><span style="color:#666666">;</span><br></code></pre></div>
<p>这个 <code class="inline-code">scopetable</code> 数组显然是一个链表。我们来模拟执行一下：</p>
<ul>
<li>假如 B 部分触发异常：首先遍历到 <code class="inline-code">scopetable[2]</code>，处理完后，找到 <code class="inline-code">scopetable[2].EnclosingTryLevel</code>，发现其值为1，那么遍历到 <code class="inline-code">scopetable[1]</code>，处理完后，找到 <code class="inline-code">scopetable[1].EnclosingTryLevel</code>，发现其值为 <code class="inline-code">TRYLEVEL_NONE</code>，于是停止遍历。</li>
<li>假如 A 部分触发异常：问题来了，这次的异常是在第一个 <code class="inline-code">__try</code> / <code class="inline-code">__except</code> 中触发的，轮不到 <code class="inline-code">scopetable[2]</code> 来处理，怎么办？</li>
</ul>
<p>不知道读者是否还记得前面给出的 <code class="inline-code">EH4_EXCEPTION_REGISTRATION::trylevel</code> 域，它的作用是标识从哪个数组单元开始遍历。与 <code class="inline-code">SCOPETABLE_ENTRY::EnclosingTryLevel</code> 不同，<code class="inline-code">EXCEPTION_REGISTRATION::trylevel</code> 是动态变化的，也就是说，这个值在 SimpleSEH 执行过程中是会经常改变的。比如：</p>
<ul>
<li>执行到 A 时，该值被修改为 0；</li>
<li>执行到 C 时，该值被修改为 1；</li>
<li>执行到 B 时，该值被修改为 2。</li>
</ul>
<p>这样，当异常触发时候，MSC 就能正确的遍历 <code class="inline-code">scopetable</code> 了。</p>
<p>到这里，我们已经熟悉了 MSC 增强版 SEH 的概要流程了，接下来将结合真实汇编代码继续分析。</p>
<p>汇编代码很简单，注释里也有详细的分析过程了，我不再多啰嗦。只提两点：</p>
<ol>
<li><code class="inline-code">EXCEPTION_REGISTRATION::scopetable</code> 指针被用 <code class="inline-code">__security_cookie</code> 进行了异或加密。</li>
<li><code class="inline-code">EXCEPTION_REGISTRATION::scopetable</code> 并不直接指向 <code class="inline-code">scopetable_entry</code> 数组，在第一个 <code class="inline-code">scopetable_entry</code> 之前有 16 个字节的坑。后续分析中会看到，它的主要作用是帮助验证 <code class="inline-code">scopetable</code> 是否被破坏。</li>
</ol>
<p>下面给出了 <code class="inline-code">__except_handler4</code> 的具体实现，MSC 并没有完全的公开这一部分的源代码，目前手上只有反编译 + 反汇编版本 <del>将就着看吧</del>：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EXCEPTION_NONCONTINUABLE</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">1</span><span style="color:#A0ADA0">    // Noncontinuable exception</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EXCEPTION_UNWINDING</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">2</span><span style="color:#A0ADA0">         // Unwind is in progress</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EXCEPTION_EXIT_UNWIND</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4</span><span style="color:#A0ADA0">       // Exit unwind is in progress</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EXCEPTION_STACK_INVALID</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">8</span><span style="color:#A0ADA0">     // Stack out of limits or unaligned</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EXCEPTION_NESTED_CALL</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#A0ADA0">      // Nested exception handler call</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EXCEPTION_TARGET_UNWIND</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#A0ADA0">    // Target unwind in progress</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EXCEPTION_COLLIDED_UNWIND</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">40</span><span style="color:#A0ADA0">  // Collided exception handler call</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EXCEPTION_UNWIND</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">EXCEPTION_UNWINDING </span><span style="color:#AB5959">|</span><span style="color:#393A34"> EXCEPTION_EXIT_UNWIND </span><span style="color:#AB5959">|</span><span style="color:#A65E2B"> \</span><br><span style="color:#393A34">                                                         EXCEPTION_TARGET_UNWIND </span><span style="color:#AB5959">|</span><span style="color:#393A34"> EXCEPTION_COLLIDED_UNWIND</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0">                                                         // 也就是 0x66</span><br><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> EH_EXCEPTION_NUMBER</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">msc</span><span style="color:#B5695977">'</span><span style="color:#AB5959"> |</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">E0000000</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">EXCEPTION_DISPOSITION</span><br><span style="color:#393A34">__cdecl </span><span style="color:#59873A">_except_handler4</span><span style="color:#2993a3">(</span><span style="color:#393A34">_EXCEPTION_RECORD</span><span style="color:#AB5959">*</span><span style="color:#B07D48"> ExceptionRecord</span><span style="color:#999999">,</span><br><span style="color:#393A34">    EXCEPTION_REGISTRATION_RECORD</span><span style="color:#AB5959">*</span><span style="color:#B07D48"> EstablisherFrame</span><span style="color:#999999">,</span><br><span style="color:#393A34">    _CONTEXT</span><span style="color:#AB5959">*</span><span style="color:#B07D48"> ContextRecord</span><span style="color:#999999">,</span><br><span style="color:#393A34">    PVOID </span><span style="color:#B07D48">DispatcherContext</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#393A34">    EH4_EXCEPTION_REGISTRATION_RECORD</span><span style="color:#AB5959">*</span><span style="color:#393A34"> EH4 </span><span style="color:#999999">=</span><span style="color:#59873A"> CONTAINING_RECORD</span><span style="color:#1e754f">(</span><br><span style="color:#393A34">        EstablisherFrame</span><span style="color:#999999">,</span><span style="color:#393A34"> EH4_EXCEPTION_REGISTRATION_RECORD</span><span style="color:#999999">,</span><span style="color:#393A34"> SubRecord</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">    void*</span><span style="color:#393A34"> EH4_END </span><span style="color:#999999">=</span><span style="color:#393A34"> EH4 </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 1</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">    EH4_SCOPETABLE</span><span style="color:#AB5959">*</span><span style="color:#393A34"> ScopeTable </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">EH4_SCOPETABLE</span><span style="color:#AB5959">*</span><span style="color:#1e754f">)</span><span style="color:#1e754f">(</span><span style="color:#393A34">__security_cookie </span><span style="color:#AB5959">^</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">DWORD</span><span style="color:#a65e2b">)</span><span style="color:#B07D48">EH4</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">EncodedScopeTable</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">    // Stack integrity checks:</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">GSCookieOffset</span><span style="color:#AB5959"> !=</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">2</span><span style="color:#1e754f">)</span><br><span style="color:#59873A">        __security_check_cookie</span><span style="color:#1e754f">(</span><br><span style="color:#AB5959">            *</span><span style="color:#a65e2b">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#a65e2b">)</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">GSCookieXOROffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EH4_END</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#AB5959"> *</span><span style="color:#a65e2b">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#a65e2b">)</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">GSCookieOffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EH4_END</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">    __security_check_cookie</span><span style="color:#1e754f">(</span><br><span style="color:#AB5959">        *</span><span style="color:#a65e2b">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#a65e2b">)</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">EHCookieXOROffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EH4_END</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#AB5959"> *</span><span style="color:#a65e2b">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#a65e2b">)</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">EHCookieOffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EH4_END</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">    EXCEPTION_DISPOSITION HandlerResult </span><span style="color:#999999">=</span><span style="color:#393A34"> ExceptionContinueSearch</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">ExceptionRecord</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">ExceptionFlags</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">66</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><span style="color:#A0ADA0"> // EXCEPTION_UNWIND 局部展开</span><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">EH4</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">TryLevel</span><span style="color:#AB5959"> ==</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">2</span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">            return</span><span style="color:#393A34"> ExceptionContinueSearch</span><span style="color:#999999">;</span><br><span style="color:#59873A">        _EH4_LocalUnwind</span><span style="color:#a65e2b">(</span><br><span style="color:#999999">            </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EstablisherFrame</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">2</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EH4_END</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">__security_cookie</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><span style="color:#1E754F"> else</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">        EXCEPTION_POINTERS ExceptionPointers </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#a65e2b">{</span><span style="color:#a65e2b">}</span><span style="color:#999999">;</span><br><span style="color:#B07D48">        ExceptionPointers</span><span style="color:#999999">.</span><span style="color:#B07D48">ExceptionRecord</span><span style="color:#999999"> =</span><span style="color:#393A34"> ExceptionRecord</span><span style="color:#999999">;</span><br><span style="color:#B07D48">        ExceptionPointers</span><span style="color:#999999">.</span><span style="color:#B07D48">ContextRecord</span><span style="color:#999999"> =</span><span style="color:#393A34"> ContextRecord</span><span style="color:#999999">;</span><br><span style="color:#B07D48">        EH4</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">ExceptionPointers</span><span style="color:#999999"> =</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">ExceptionPointers</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">        bool</span><span style="color:#393A34"> v13 </span><span style="color:#999999">=</span><span style="color:#1E754F"> false</span><span style="color:#999999">;</span><br><br><span style="color:#393A34">        DWORD LastTryLevel </span><span style="color:#999999">=</span><span style="color:#B07D48"> EH4</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">TryLevel</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">LastTryLevel </span><span style="color:#AB5959">==</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">2</span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">            return</span><span style="color:#393A34"> ExceptionContinueSearch</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        do</span><span style="color:#999999"> </span><span style="color:#a65e2b">{</span><br><span style="color:#AB5959">            void*</span><span style="color:#393A34"> FilterFunc </span><span style="color:#999999">=</span><span style="color:#B07D48"> ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">ScopeRecord</span><span style="color:#a13865">[</span><span style="color:#393A34">LastTryLevel</span><span style="color:#a13865">]</span><span style="color:#999999">.</span><span style="color:#B07D48">FilterFunc</span><span style="color:#999999">;</span><br><span style="color:#AB5959">            int</span><span style="color:#393A34"> EnclosingLevel </span><span style="color:#999999">=</span><span style="color:#B07D48"> ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">ScopeRecord</span><span style="color:#a13865">[</span><span style="color:#393A34">LastTryLevel</span><span style="color:#a13865">]</span><span style="color:#999999">.</span><span style="color:#B07D48">EnclosingLevel</span><span style="color:#999999">;</span><br><span style="color:#393A34">            EH4_SCOPETABLE_RECORD</span><span style="color:#AB5959">*</span><span style="color:#393A34"> pScopeRecord </span><span style="color:#999999">=</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">ScopeRecord</span><span style="color:#a13865">[</span><span style="color:#393A34">LastTryLevel</span><span style="color:#a13865">]</span><span style="color:#999999">;</span><br><span style="color:#1E754F">            if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">FilterFunc</span><span style="color:#a13865">)</span><span style="color:#999999"> </span><span style="color:#a13865">{</span><br><span style="color:#AB5959">                int</span><span style="color:#393A34"> FilterResult </span><span style="color:#999999">=</span><span style="color:#59873A"> _EH4_CallFilterFunc</span><span style="color:#bda437">(</span><span style="color:#393A34">FilterFunc</span><span style="color:#999999">,</span><span style="color:#393A34"> EH4_END</span><span style="color:#bda437">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">                v13 </span><span style="color:#999999">=</span><span style="color:#1E754F"> true</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">                if</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#393A34">FilterResult </span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 0</span><span style="color:#bda437">)</span><span style="color:#999999"> </span><span style="color:#bda437">{</span><br><span style="color:#393A34">                    HandlerResult </span><span style="color:#999999">=</span><span style="color:#393A34"> ExceptionContinueExecution</span><span style="color:#999999">;</span><br><span style="color:#1E754F">                    goto</span><span style="color:#393A34"> LABEL_23</span><span style="color:#999999">;</span><br><span style="color:#999999">                </span><span style="color:#bda437">}</span><br><span style="color:#1E754F">                if</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#393A34">FilterResult </span><span style="color:#AB5959">></span><span style="color:#2F798A"> 0</span><span style="color:#bda437">)</span><span style="color:#999999"> </span><span style="color:#bda437">{</span><br><span style="color:#1E754F">                    if</span><span style="color:#999999"> </span><span style="color:#296aa3">(</span><span style="color:#B07D48">ExceptionRecord</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">ExceptionCode</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> EH_EXCEPTION_NUMBER </span><span style="color:#AB5959">&#x26;&#x26;</span><span style="color:#393A34"> _pDestructExceptionObject </span><span style="color:#AB5959">&#x26;&#x26;</span><span style="color:#59873A"> _IsNonwritableInCurrentImage</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#AB5959">char*</span><span style="color:#1e754f">)</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">_pDestructExceptionObject</span><span style="color:#2993a3">)</span><span style="color:#296aa3">)</span><span style="color:#999999"> </span><span style="color:#296aa3">{</span><br><span style="color:#59873A">                        _pDestructExceptionObject</span><span style="color:#2993a3">(</span><span style="color:#393A34">ExceptionRecord</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#999999">                    </span><span style="color:#296aa3">}</span><br><span style="color:#59873A">                    _EH4_GlobalUnwind2</span><span style="color:#296aa3">(</span><span style="color:#393A34">EstablisherFrame</span><span style="color:#999999">,</span><span style="color:#393A34"> ExceptionRecord</span><span style="color:#296aa3">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // 全局展开</span><br><br><span style="color:#1E754F">                    if</span><span style="color:#999999"> </span><span style="color:#296aa3">(</span><span style="color:#B07D48">EH4</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">TryLevel</span><span style="color:#AB5959"> !=</span><span style="color:#393A34"> LastTryLevel</span><span style="color:#296aa3">)</span><span style="color:#999999"> </span><span style="color:#296aa3">{</span><br><span style="color:#59873A">                        _EH4_LocalUnwind</span><span style="color:#2993a3">(</span><span style="color:#393A34">EH4_END</span><span style="color:#999999">,</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">__security_cookie</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#999999">                    </span><span style="color:#296aa3">}</span><br><span style="color:#B07D48">                    EH4</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">TryLevel</span><span style="color:#999999"> =</span><span style="color:#393A34"> EnclosingLevel</span><span style="color:#999999">;</span><br><br><span style="color:#A0ADA0">                    // Stack integrity checks:</span><br><span style="color:#1E754F">                    if</span><span style="color:#999999"> </span><span style="color:#296aa3">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">GSCookieOffset</span><span style="color:#AB5959"> !=</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">2</span><span style="color:#296aa3">)</span><br><span style="color:#59873A">                        __security_check_cookie</span><span style="color:#296aa3">(</span><br><span style="color:#AB5959">                            *</span><span style="color:#2993a3">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#2993a3">)</span><span style="color:#2993a3">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">GSCookieXOROffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">DWORD</span><span style="color:#1e754f">)</span><span style="color:#393A34">EH4_END</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> ^</span><span style="color:#AB5959"> *</span><span style="color:#2993a3">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#2993a3">)</span><span style="color:#2993a3">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">GSCookieOffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">DWORD</span><span style="color:#1e754f">)</span><span style="color:#393A34">EH4_END</span><span style="color:#2993a3">)</span><span style="color:#296aa3">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">                    __security_check_cookie</span><span style="color:#296aa3">(</span><br><span style="color:#AB5959">                        *</span><span style="color:#2993a3">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#2993a3">)</span><span style="color:#2993a3">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">EHCookieXOROffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">DWORD</span><span style="color:#1e754f">)</span><span style="color:#393A34">EH4_END</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> ^</span><span style="color:#AB5959"> *</span><span style="color:#2993a3">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#2993a3">)</span><span style="color:#2993a3">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">EHCookieOffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">DWORD</span><span style="color:#1e754f">)</span><span style="color:#393A34">EH4_END</span><span style="color:#2993a3">)</span><span style="color:#296aa3">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">                    _EH4_TransferToHandler</span><span style="color:#296aa3">(</span><span style="color:#B07D48">pScopeRecord</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">HandlerFunc</span><span style="color:#999999">,</span><span style="color:#393A34"> EH4_END</span><span style="color:#296aa3">)</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">                     // 这段函数不会返回，即这段代码中没有 ret 指令。执行完整个 HandlerFunc 后，会接着执行其后的指令，并不会返回 _except_handler4。</span><br><br><span style="color:#59873A">                    __debugbreak</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">                    _crt_debugger_hook</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#999999">;</span><br><span style="color:#999999">                </span><span style="color:#bda437">}</span><br><span style="color:#999999">            </span><span style="color:#a13865">}</span><span style="color:#1E754F"> else</span><span style="color:#999999"> </span><span style="color:#a13865">{</span><br><span style="color:#393A34">                v13 </span><span style="color:#999999">=</span><span style="color:#1E754F"> true</span><span style="color:#999999">;</span><br><span style="color:#999999">            </span><span style="color:#a13865">}</span><br><span style="color:#393A34">            LastTryLevel </span><span style="color:#999999">=</span><span style="color:#393A34"> EnclosingLevel</span><span style="color:#999999">;</span><br><span style="color:#999999">        </span><span style="color:#a65e2b">}</span><span style="color:#1E754F"> while</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">LastTryLevel </span><span style="color:#AB5959">!=</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">2</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#AB5959">!</span><span style="color:#393A34">v13</span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">            return</span><span style="color:#393A34"> HandlerResult</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#393A34">LABEL_23:</span><br><span style="color:#A0ADA0">    // Stack integrity checks:</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">GSCookieOffset</span><span style="color:#AB5959"> !=</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">2</span><span style="color:#1e754f">)</span><br><span style="color:#59873A">        __security_check_cookie</span><span style="color:#1e754f">(</span><br><span style="color:#AB5959">            *</span><span style="color:#a65e2b">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#a65e2b">)</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">GSCookieXOROffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EH4_END</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#AB5959"> *</span><span style="color:#a65e2b">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#a65e2b">)</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">GSCookieOffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EH4_END</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">    __security_check_cookie</span><span style="color:#1e754f">(</span><br><span style="color:#AB5959">        *</span><span style="color:#a65e2b">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#a65e2b">)</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">EHCookieXOROffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EH4_END</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#AB5959"> *</span><span style="color:#a65e2b">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#a65e2b">)</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">ScopeTable</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">EHCookieOffset</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">DWORD</span><span style="color:#a13865">)</span><span style="color:#393A34">EH4_END</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> HandlerResult</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EXCEPTION_NONCONTINUABLE</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">1</span><span style="color:#758575DD">    // Noncontinuable exception</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EXCEPTION_UNWINDING</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">2</span><span style="color:#758575DD">         // Unwind is in progress</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EXCEPTION_EXIT_UNWIND</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4</span><span style="color:#758575DD">       // Exit unwind is in progress</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EXCEPTION_STACK_INVALID</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">8</span><span style="color:#758575DD">     // Stack out of limits or unaligned</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EXCEPTION_NESTED_CALL</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#758575DD">      // Nested exception handler call</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EXCEPTION_TARGET_UNWIND</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#758575DD">    // Target unwind in progress</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EXCEPTION_COLLIDED_UNWIND</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">40</span><span style="color:#758575DD">  // Collided exception handler call</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EXCEPTION_UNWIND</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">EXCEPTION_UNWINDING </span><span style="color:#CB7676">|</span><span style="color:#DBD7CAEE"> EXCEPTION_EXIT_UNWIND </span><span style="color:#CB7676">|</span><span style="color:#C99076"> \</span><br><span style="color:#DBD7CAEE">                                                         EXCEPTION_TARGET_UNWIND </span><span style="color:#CB7676">|</span><span style="color:#DBD7CAEE"> EXCEPTION_COLLIDED_UNWIND</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD">                                                         // 也就是 0x66</span><br><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> EH_EXCEPTION_NUMBER</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">msc</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> |</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">E0000000</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">EXCEPTION_DISPOSITION</span><br><span style="color:#DBD7CAEE">__cdecl </span><span style="color:#80A665">_except_handler4</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">_EXCEPTION_RECORD</span><span style="color:#CB7676">*</span><span style="color:#BD976A"> ExceptionRecord</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">    EXCEPTION_REGISTRATION_RECORD</span><span style="color:#CB7676">*</span><span style="color:#BD976A"> EstablisherFrame</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">    _CONTEXT</span><span style="color:#CB7676">*</span><span style="color:#BD976A"> ContextRecord</span><span style="color:#666666">,</span><br><span style="color:#DBD7CAEE">    PVOID </span><span style="color:#BD976A">DispatcherContext</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">    EH4_EXCEPTION_REGISTRATION_RECORD</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> EH4 </span><span style="color:#666666">=</span><span style="color:#80A665"> CONTAINING_RECORD</span><span style="color:#4d9375">(</span><br><span style="color:#DBD7CAEE">        EstablisherFrame</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> EH4_EXCEPTION_REGISTRATION_RECORD</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> SubRecord</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">    void*</span><span style="color:#DBD7CAEE"> EH4_END </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> EH4 </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">;</span><br><br><span style="color:#DBD7CAEE">    EH4_SCOPETABLE</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> ScopeTable </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">EH4_SCOPETABLE</span><span style="color:#CB7676">*</span><span style="color:#4d9375">)</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">__security_cookie </span><span style="color:#CB7676">^</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d4976c">)</span><span style="color:#BD976A">EH4</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">EncodedScopeTable</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">    // Stack integrity checks:</span><br><span style="color:#4D9375">    if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">GSCookieOffset</span><span style="color:#CB7676"> !=</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">2</span><span style="color:#4d9375">)</span><br><span style="color:#80A665">        __security_check_cookie</span><span style="color:#4d9375">(</span><br><span style="color:#CB7676">            *</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#d4976c">)</span><span style="color:#d4976c">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">GSCookieXOROffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#CB7676"> *</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#d4976c">)</span><span style="color:#d4976c">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">GSCookieOffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#80A665">    __security_check_cookie</span><span style="color:#4d9375">(</span><br><span style="color:#CB7676">        *</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#d4976c">)</span><span style="color:#d4976c">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">EHCookieXOROffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#CB7676"> *</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#d4976c">)</span><span style="color:#d4976c">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">EHCookieOffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#DBD7CAEE">    EXCEPTION_DISPOSITION HandlerResult </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ExceptionContinueSearch</span><span style="color:#666666">;</span><br><br><span style="color:#4D9375">    if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#BD976A">ExceptionRecord</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">ExceptionFlags</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">66</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><span style="color:#758575DD"> // EXCEPTION_UNWIND 局部展开</span><br><span style="color:#4D9375">        if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">EH4</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">TryLevel</span><span style="color:#CB7676"> ==</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">2</span><span style="color:#d4976c">)</span><br><span style="color:#4D9375">            return</span><span style="color:#DBD7CAEE"> ExceptionContinueSearch</span><span style="color:#666666">;</span><br><span style="color:#80A665">        _EH4_LocalUnwind</span><span style="color:#d4976c">(</span><br><span style="color:#666666">            </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EstablisherFrame</span><span style="color:#666666">,</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">2</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">__security_cookie</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><span style="color:#4D9375"> else</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">        EXCEPTION_POINTERS ExceptionPointers </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#d4976c">{</span><span style="color:#d4976c">}</span><span style="color:#666666">;</span><br><span style="color:#BD976A">        ExceptionPointers</span><span style="color:#666666">.</span><span style="color:#BD976A">ExceptionRecord</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> ExceptionRecord</span><span style="color:#666666">;</span><br><span style="color:#BD976A">        ExceptionPointers</span><span style="color:#666666">.</span><span style="color:#BD976A">ContextRecord</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> ContextRecord</span><span style="color:#666666">;</span><br><span style="color:#BD976A">        EH4</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">ExceptionPointers</span><span style="color:#666666"> =</span><span style="color:#CB7676"> &#x26;</span><span style="color:#DBD7CAEE">ExceptionPointers</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">        bool</span><span style="color:#DBD7CAEE"> v13 </span><span style="color:#666666">=</span><span style="color:#4D9375"> false</span><span style="color:#666666">;</span><br><br><span style="color:#DBD7CAEE">        DWORD LastTryLevel </span><span style="color:#666666">=</span><span style="color:#BD976A"> EH4</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">TryLevel</span><span style="color:#666666">;</span><br><br><span style="color:#4D9375">        if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">LastTryLevel </span><span style="color:#CB7676">==</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">2</span><span style="color:#d4976c">)</span><br><span style="color:#4D9375">            return</span><span style="color:#DBD7CAEE"> ExceptionContinueSearch</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        do</span><span style="color:#666666"> </span><span style="color:#d4976c">{</span><br><span style="color:#CB7676">            void*</span><span style="color:#DBD7CAEE"> FilterFunc </span><span style="color:#666666">=</span><span style="color:#BD976A"> ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">ScopeRecord</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">LastTryLevel</span><span style="color:#d9739f">]</span><span style="color:#666666">.</span><span style="color:#BD976A">FilterFunc</span><span style="color:#666666">;</span><br><span style="color:#CB7676">            int</span><span style="color:#DBD7CAEE"> EnclosingLevel </span><span style="color:#666666">=</span><span style="color:#BD976A"> ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">ScopeRecord</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">LastTryLevel</span><span style="color:#d9739f">]</span><span style="color:#666666">.</span><span style="color:#BD976A">EnclosingLevel</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">            EH4_SCOPETABLE_RECORD</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> pScopeRecord </span><span style="color:#666666">=</span><span style="color:#CB7676"> &#x26;</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">ScopeRecord</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">LastTryLevel</span><span style="color:#d9739f">]</span><span style="color:#666666">;</span><br><span style="color:#4D9375">            if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">FilterFunc</span><span style="color:#d9739f">)</span><span style="color:#666666"> </span><span style="color:#d9739f">{</span><br><span style="color:#CB7676">                int</span><span style="color:#DBD7CAEE"> FilterResult </span><span style="color:#666666">=</span><span style="color:#80A665"> _EH4_CallFilterFunc</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">FilterFunc</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> EH4_END</span><span style="color:#e6cc77">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">                v13 </span><span style="color:#666666">=</span><span style="color:#4D9375"> true</span><span style="color:#666666">;</span><br><br><span style="color:#4D9375">                if</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">FilterResult </span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 0</span><span style="color:#e6cc77">)</span><span style="color:#666666"> </span><span style="color:#e6cc77">{</span><br><span style="color:#DBD7CAEE">                    HandlerResult </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ExceptionContinueExecution</span><span style="color:#666666">;</span><br><span style="color:#4D9375">                    goto</span><span style="color:#DBD7CAEE"> LABEL_23</span><span style="color:#666666">;</span><br><span style="color:#666666">                </span><span style="color:#e6cc77">}</span><br><span style="color:#4D9375">                if</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">FilterResult </span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 0</span><span style="color:#e6cc77">)</span><span style="color:#666666"> </span><span style="color:#e6cc77">{</span><br><span style="color:#4D9375">                    if</span><span style="color:#666666"> </span><span style="color:#6394bf">(</span><span style="color:#BD976A">ExceptionRecord</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">ExceptionCode</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> EH_EXCEPTION_NUMBER </span><span style="color:#CB7676">&#x26;&#x26;</span><span style="color:#DBD7CAEE"> _pDestructExceptionObject </span><span style="color:#CB7676">&#x26;&#x26;</span><span style="color:#80A665"> _IsNonwritableInCurrentImage</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#CB7676">char*</span><span style="color:#4d9375">)</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">_pDestructExceptionObject</span><span style="color:#5eaab5">)</span><span style="color:#6394bf">)</span><span style="color:#666666"> </span><span style="color:#6394bf">{</span><br><span style="color:#80A665">                        _pDestructExceptionObject</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">ExceptionRecord</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#666666">                    </span><span style="color:#6394bf">}</span><br><span style="color:#80A665">                    _EH4_GlobalUnwind2</span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">EstablisherFrame</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ExceptionRecord</span><span style="color:#6394bf">)</span><span style="color:#666666">;</span><span style="color:#758575DD"> // 全局展开</span><br><br><span style="color:#4D9375">                    if</span><span style="color:#666666"> </span><span style="color:#6394bf">(</span><span style="color:#BD976A">EH4</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">TryLevel</span><span style="color:#CB7676"> !=</span><span style="color:#DBD7CAEE"> LastTryLevel</span><span style="color:#6394bf">)</span><span style="color:#666666"> </span><span style="color:#6394bf">{</span><br><span style="color:#80A665">                        _EH4_LocalUnwind</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#DBD7CAEE">__security_cookie</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#666666">                    </span><span style="color:#6394bf">}</span><br><span style="color:#BD976A">                    EH4</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">TryLevel</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> EnclosingLevel</span><span style="color:#666666">;</span><br><br><span style="color:#758575DD">                    // Stack integrity checks:</span><br><span style="color:#4D9375">                    if</span><span style="color:#666666"> </span><span style="color:#6394bf">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">GSCookieOffset</span><span style="color:#CB7676"> !=</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">2</span><span style="color:#6394bf">)</span><br><span style="color:#80A665">                        __security_check_cookie</span><span style="color:#6394bf">(</span><br><span style="color:#CB7676">                            *</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">GSCookieXOROffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> ^</span><span style="color:#CB7676"> *</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">GSCookieOffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#5eaab5">)</span><span style="color:#6394bf">)</span><span style="color:#666666">;</span><br><br><span style="color:#80A665">                    __security_check_cookie</span><span style="color:#6394bf">(</span><br><span style="color:#CB7676">                        *</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">EHCookieXOROffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> ^</span><span style="color:#CB7676"> *</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">EHCookieOffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#5eaab5">)</span><span style="color:#6394bf">)</span><span style="color:#666666">;</span><br><br><span style="color:#80A665">                    _EH4_TransferToHandler</span><span style="color:#6394bf">(</span><span style="color:#BD976A">pScopeRecord</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">HandlerFunc</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> EH4_END</span><span style="color:#6394bf">)</span><span style="color:#666666">;</span><br><span style="color:#758575DD">                     // 这段函数不会返回，即这段代码中没有 ret 指令。执行完整个 HandlerFunc 后，会接着执行其后的指令，并不会返回 _except_handler4。</span><br><br><span style="color:#80A665">                    __debugbreak</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">                    _crt_debugger_hook</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#666666">;</span><br><span style="color:#666666">                </span><span style="color:#e6cc77">}</span><br><span style="color:#666666">            </span><span style="color:#d9739f">}</span><span style="color:#4D9375"> else</span><span style="color:#666666"> </span><span style="color:#d9739f">{</span><br><span style="color:#DBD7CAEE">                v13 </span><span style="color:#666666">=</span><span style="color:#4D9375"> true</span><span style="color:#666666">;</span><br><span style="color:#666666">            </span><span style="color:#d9739f">}</span><br><span style="color:#DBD7CAEE">            LastTryLevel </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> EnclosingLevel</span><span style="color:#666666">;</span><br><span style="color:#666666">        </span><span style="color:#d4976c">}</span><span style="color:#4D9375"> while</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">LastTryLevel </span><span style="color:#CB7676">!=</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">2</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#CB7676">!</span><span style="color:#DBD7CAEE">v13</span><span style="color:#d4976c">)</span><br><span style="color:#4D9375">            return</span><span style="color:#DBD7CAEE"> HandlerResult</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><br><span style="color:#DBD7CAEE">LABEL_23:</span><br><span style="color:#758575DD">    // Stack integrity checks:</span><br><span style="color:#4D9375">    if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">GSCookieOffset</span><span style="color:#CB7676"> !=</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">2</span><span style="color:#4d9375">)</span><br><span style="color:#80A665">        __security_check_cookie</span><span style="color:#4d9375">(</span><br><span style="color:#CB7676">            *</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#d4976c">)</span><span style="color:#d4976c">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">GSCookieXOROffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#CB7676"> *</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#d4976c">)</span><span style="color:#d4976c">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">GSCookieOffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#80A665">    __security_check_cookie</span><span style="color:#4d9375">(</span><br><span style="color:#CB7676">        *</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#d4976c">)</span><span style="color:#d4976c">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">EHCookieXOROffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#CB7676"> *</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#d4976c">)</span><span style="color:#d4976c">(</span><span style="color:#BD976A">ScopeTable</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">EHCookieOffset</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">EH4_END</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> HandlerResult</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>关于 <code class="inline-code">_EH4_CallFilterFunc</code> 和 <code class="inline-code">_EH4_TransferToHandler</code>，手上只有反汇编代码：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-x86asm language-x86asm"><span style="color:#A0ADA0">; _EH4_CallFilterFunc</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    ebp</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    esi</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    edi</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    ebx</span><br><span style="color:#AB5959">mov</span><span style="color:#1E754F">     ebp</span><span style="color:#393A34">,</span><span style="color:#1E754F">edx</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">,</span><span style="color:#1E754F">eax</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     ebx</span><span style="color:#393A34">,</span><span style="color:#1E754F">ebx</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     edx</span><span style="color:#393A34">,</span><span style="color:#1E754F">edx</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     esi</span><span style="color:#393A34">,</span><span style="color:#1E754F">esi</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     edi</span><span style="color:#393A34">,</span><span style="color:#1E754F">edi</span><br><span style="color:#AB5959">call</span><span style="color:#1E754F">    ecx</span><span style="color:#A0ADA0"> ; FilterFunc();</span><br><span style="color:#AB5959">pop</span><span style="color:#1E754F">     ebx</span><br><span style="color:#AB5959">pop</span><span style="color:#1E754F">     edi</span><br><span style="color:#AB5959">pop</span><span style="color:#1E754F">     esi</span><br><span style="color:#AB5959">pop</span><span style="color:#1E754F">     ebp</span><br><span style="color:#AB5959">ret</span><br><br><span style="color:#A0ADA0">; _EH4_TransferToHandler</span><br><span style="color:#AB5959">mov</span><span style="color:#1E754F">     ebp</span><span style="color:#393A34">,</span><span style="color:#1E754F">edx</span><br><span style="color:#AB5959">mov</span><span style="color:#1E754F">     esi</span><span style="color:#393A34">,</span><span style="color:#1E754F">ecx</span><span style="color:#A0ADA0"> ; esi = HandlerFunc</span><br><span style="color:#AB5959">mov</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">,</span><span style="color:#1E754F">ecx</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">,</span><span style="color:#1E754F">eax</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     ebx</span><span style="color:#393A34">,</span><span style="color:#1E754F">ebx</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     ecx</span><span style="color:#393A34">,</span><span style="color:#1E754F">ecx</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     edx</span><span style="color:#393A34">,</span><span style="color:#1E754F">edx</span><br><span style="color:#AB5959">xor</span><span style="color:#1E754F">     edi</span><span style="color:#393A34">,</span><span style="color:#1E754F">edi</span><br><span style="color:#AB5959">jmp</span><span style="color:#1E754F">     esi</span><span style="color:#A0ADA0">     ; jmp HandlerFunc</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-x86asm language-x86asm"><span style="color:#758575DD">; _EH4_CallFilterFunc</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    ebp</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    esi</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    edi</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    ebx</span><br><span style="color:#CB7676">mov</span><span style="color:#4D9375">     ebp</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">edx</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">eax</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     ebx</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">ebx</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     edx</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">edx</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     esi</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">esi</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     edi</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">edi</span><br><span style="color:#CB7676">call</span><span style="color:#4D9375">    ecx</span><span style="color:#758575DD"> ; FilterFunc();</span><br><span style="color:#CB7676">pop</span><span style="color:#4D9375">     ebx</span><br><span style="color:#CB7676">pop</span><span style="color:#4D9375">     edi</span><br><span style="color:#CB7676">pop</span><span style="color:#4D9375">     esi</span><br><span style="color:#CB7676">pop</span><span style="color:#4D9375">     ebp</span><br><span style="color:#CB7676">ret</span><br><br><span style="color:#758575DD">; _EH4_TransferToHandler</span><br><span style="color:#CB7676">mov</span><span style="color:#4D9375">     ebp</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">edx</span><br><span style="color:#CB7676">mov</span><span style="color:#4D9375">     esi</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">ecx</span><span style="color:#758575DD"> ; esi = HandlerFunc</span><br><span style="color:#CB7676">mov</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">ecx</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">eax</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     ebx</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">ebx</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     ecx</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">ecx</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     edx</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">edx</span><br><span style="color:#CB7676">xor</span><span style="color:#4D9375">     edi</span><span style="color:#DBD7CAEE">,</span><span style="color:#4D9375">edi</span><br><span style="color:#CB7676">jmp</span><span style="color:#4D9375">     esi</span><span style="color:#758575DD">     ; jmp HandlerFunc</span><br></code></pre></div>
<p>根据源代码，可以总结出以下要点：</p>
<ul>
<li>VC的 <code class="inline-code">__except_handler4 </code> 函数与系统实现版本里的 <code class="inline-code">_except_handler</code> 十分相似，带有同样的四个参数；</li>
<li>之后的流程见下面的示意图：</li>
</ul>
<img src="https://s2.loli.net/2023/10/12/FTKAPHWUrqEf6Bh.jpg" width="90%"/>
<h5 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>展开</a></h5>
<p>为了说明这个概念，需要先回顾下异常发生后的处理流程。</p>
<p>我们假设一系列使用 SEH 的函数调用流程：<code class="inline-code">func1</code> -> <code class="inline-code">func2</code> -> <code class="inline-code">func3</code>，假定在 <code class="inline-code">func3</code> 执行的过程中触发了异常，由 <code class="inline-code">func1</code> 完成处理。</p>
<p>回想一下我们在学习系统实现版本的 SEH 时总结的分发软件异常流程：<code class="inline-code">RtlRaiseException</code> -> <code class="inline-code">RtlDispatchException</code> -> <code class="inline-code">RtlpExecuteHandlerForException</code>，由于 <code class="inline-code">R tlDispatchException</code> 会遍历异常链表，对每个 <code class="inline-code">EXCEPTION_REGISTRATION</code> 都调用 <code class="inline-code">RtlpExecuteHandlerForException</code>，而 <code class="inline-code">RtlpExecuteHandlerForException</code> 会调用 <code class="inline-code">EXCEPTION_REGISTRATION::handler</code>，后者在 MSC 中被实现为 <code class="inline-code">_exception_handler4</code>。又，如上分析，该函数内部遍历 <code class="inline-code">EH4_EXCEPTION_REGISTRATION::scopetable</code>，如果遇到有 <code class="inline-code">scopetable_entry::FilterFunc</code> 返回 <code class="inline-code">EXCEPTION_EXECUTE_HANDLER</code>，那么 <code class="inline-code">scopetable_entry::HandlerFunc</code> 就会被调用，来处理该异常。</p>
<p>因为 <code class="inline-code">HandlerFunc</code> 不会返回到 <code class="inline-code">_except_handler4</code>（<code class="inline-code">_EH4_TransferToHandler</code> 没有 <code class="inline-code">ret/retn</code> 指令），于是执行完 <code class="inline-code">HandlerFunc</code> 后，就会从 <code class="inline-code">HandlerFunc</code> 之后的代码继续执行下去。也就是说，假设 <code class="inline-code">func3</code> 中触发了一个异常，该异常被 <code class="inline-code">func1</code> 中的 <code class="inline-code">__except</code> 处理块处理了，那 <code class="inline-code">__except</code> 处理块执行完毕后，就从其后的指令继续执行下去，即异常处理完毕后，接着执行的就是 <code class="inline-code">func1</code> 的代码，不会再回到 <code class="inline-code">func2</code> 或者 <code class="inline-code">func3</code>。问题来了，<code class="inline-code">func2</code> 和 <code class="inline-code">func3</code> 中占用的资源怎么办？这些资源（比如申请的内存）是不会自动释放的，那岂不是会有资源泄漏问题？</p>
<p>从这里，我们可以引申出“展开”的概念：“展开”，说白了就是“清理”。（注：这里的清理主要包含动态分配的资源的清理，栈空间是由 <code class="inline-code">func1</code> 的 <code class="inline-code">mov esp,ebp</code> 这类操作顺手清理的）</p>
<p>保持思考，这个展开工作由谁来完成呢？</p>
<p>显然，由 <code class="inline-code">func1</code> 来完成肯定不合适，毕竟 <code class="inline-code">func2</code> 和 <code class="inline-code">func3</code> 有没有申请资源、申请了哪些资源，<code class="inline-code">func1</code> 无从得知。于是这个展开工作只能交给 <code class="inline-code">func2</code> 和 <code class="inline-code">func3</code> 自己来完成。</p>
<p>展开分为两种：全局展开、局部展开。</p>
<p>全局展开是指针对异常链表中的某一段，局部展开针对指定的 <code class="inline-code">EXCEPTION_REGISTRATION</code>。仍然用上面的例子，局部展开是指具体某一函数内部的清理（例如对 <code class="inline-code">func3</code> 内部分配的动态资源）；而全局展开是指，从异常触发点（<code class="inline-code">func3</code>）到异常处理点（<code class="inline-code">func1</code>）之间所有函数（包含异常触发点 <code class="inline-code">func3</code>）的局部清理的总和。</p>
<h6 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>全局展开</a></h6>
<p>有一个尴尬的事实是没有人能找到用于全局展开的 <code class="inline-code">_EH4_GlobalUnwind2</code> 的源代码（官方也没有给出），下面是利用 ida 反编译得到的结果：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-x86asm language-x86asm"><span style="color:#A0ADA0">; __fastcall _EH4_GlobalUnwind2(EstablisherFrame, ExceptionRecord)</span><br><span style="color:#393A34">@_EH4_GlobalUnwind2@</span><span style="color:#2F798A">4</span><span style="color:#393A34"> proc </span><span style="color:#AB5959">near</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    ebp</span><br><span style="color:#AB5959">mov</span><span style="color:#1E754F">     ebp</span><span style="color:#393A34">, </span><span style="color:#1E754F">esp</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    ebx</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    esi</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    edi</span><br><span style="color:#AB5959">push</span><span style="color:#2F798A">    0</span><br><span style="color:#AB5959">push</span><span style="color:#2F798A">    0</span><br><span style="color:#AB5959">push</span><span style="color:#393A34">    offset ReturnPoint</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    ecx</span><span style="color:#A0ADA0"> ; pExceptionRegistration</span><br><span style="color:#AB5959">call</span><span style="color:#393A34">    _RtlUnwind@</span><span style="color:#2F798A">16</span><span style="color:#A0ADA0">   ; RtlUnwind(x,x,x,x)</span><br><br><span style="color:#59873A">ReturnPoint</span><span style="color:#999999">:</span><br><span style="color:#AB5959">pop</span><span style="color:#1E754F">     edi</span><br><span style="color:#AB5959">pop</span><span style="color:#1E754F">     esi</span><br><span style="color:#AB5959">pop</span><span style="color:#1E754F">     ebx</span><br><span style="color:#AB5959">pop</span><span style="color:#1E754F">     ebp</span><br><span style="color:#AB5959">retn</span><br><span style="color:#393A34">@_EH4_GlobalUnwind@</span><span style="color:#2F798A">4</span><span style="color:#393A34"> endp</span><br><span style="color:#A0ADA0">; RtlUnwind 为导入函数</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-x86asm language-x86asm"><span style="color:#758575DD">; __fastcall _EH4_GlobalUnwind2(EstablisherFrame, ExceptionRecord)</span><br><span style="color:#DBD7CAEE">@_EH4_GlobalUnwind2@</span><span style="color:#4C9A91">4</span><span style="color:#DBD7CAEE"> proc </span><span style="color:#CB7676">near</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    ebp</span><br><span style="color:#CB7676">mov</span><span style="color:#4D9375">     ebp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">esp</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    ebx</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    esi</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    edi</span><br><span style="color:#CB7676">push</span><span style="color:#4C9A91">    0</span><br><span style="color:#CB7676">push</span><span style="color:#4C9A91">    0</span><br><span style="color:#CB7676">push</span><span style="color:#DBD7CAEE">    offset ReturnPoint</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    ecx</span><span style="color:#758575DD"> ; pExceptionRegistration</span><br><span style="color:#CB7676">call</span><span style="color:#DBD7CAEE">    _RtlUnwind@</span><span style="color:#4C9A91">16</span><span style="color:#758575DD">   ; RtlUnwind(x,x,x,x)</span><br><br><span style="color:#80A665">ReturnPoint</span><span style="color:#666666">:</span><br><span style="color:#CB7676">pop</span><span style="color:#4D9375">     edi</span><br><span style="color:#CB7676">pop</span><span style="color:#4D9375">     esi</span><br><span style="color:#CB7676">pop</span><span style="color:#4D9375">     ebx</span><br><span style="color:#CB7676">pop</span><span style="color:#4D9375">     ebp</span><br><span style="color:#CB7676">retn</span><br><span style="color:#DBD7CAEE">@_EH4_GlobalUnwind@</span><span style="color:#4C9A91">4</span><span style="color:#DBD7CAEE"> endp</span><br><span style="color:#758575DD">; RtlUnwind 为导入函数</span><br></code></pre></div>
<p>根据 <code class="inline-code">_EH4_GlobalUnwind2</code> 的汇编代码可以得知其调用了 <code class="inline-code">RtlUnwind</code> 函数，这个函数在 wrk 有源码实现，MSC 实现版本与之相差不多，这里我们就以其为例：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">VOID</span><br><span style="color:#59873A">RtlUnwind</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><br><span style="color:#393A34">    IN PVOID TargetFrame </span><span style="color:#B07D48">OPTIONAL</span><span style="color:#999999">,</span><span style="color:#A0ADA0"> // 要展开的目标帧</span><br><span style="color:#393A34">    IN PVOID TargetIp </span><span style="color:#B07D48">OPTIONAL</span><span style="color:#999999">,</span><span style="color:#A0ADA0"> // 展开的继续地址</span><br><span style="color:#393A34">    IN PEXCEPTION_RECORD ExceptionRecord </span><span style="color:#B07D48">OPTIONAL</span><span style="color:#999999">,</span><span style="color:#A0ADA0"> // 异常记录</span><br><span style="color:#393A34">    IN PVOID ReturnValue</span><span style="color:#A0ADA0"> // 整数返回寄存器的返回值</span><br><span style="color:#999999">    </span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">VOID</span><br><span style="color:#80A665">RtlUnwind</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><br><span style="color:#DBD7CAEE">    IN PVOID TargetFrame </span><span style="color:#BD976A">OPTIONAL</span><span style="color:#666666">,</span><span style="color:#758575DD"> // 要展开的目标帧</span><br><span style="color:#DBD7CAEE">    IN PVOID TargetIp </span><span style="color:#BD976A">OPTIONAL</span><span style="color:#666666">,</span><span style="color:#758575DD"> // 展开的继续地址</span><br><span style="color:#DBD7CAEE">    IN PEXCEPTION_RECORD ExceptionRecord </span><span style="color:#BD976A">OPTIONAL</span><span style="color:#666666">,</span><span style="color:#758575DD"> // 异常记录</span><br><span style="color:#DBD7CAEE">    IN PVOID ReturnValue</span><span style="color:#758575DD"> // 整数返回寄存器的返回值</span><br><span style="color:#666666">    </span><span style="color:#5eaab5">)</span><br></code></pre></div>
<p>代码比较长，不过并不复杂：</p>
<ul>
<li>如果没有指定要展开的目标帧的话，程序会自己构建一个，同时在异常标志中同时设置 <code class="inline-code">EXCEPTION_EXIT_UNWIND</code> 和 <code class="inline-code">EXCEPTION_UNWINDING</code> 标志</li>
<li>如果指定了目标帧，在异常标志中设置 <code class="inline-code">EXCEPTION_UNWINDING</code> 标志；</li>
<li>扫描异常注册链表：
<ul>
<li>如果是展开的目标：调用 <code class="inline-code">_ZwContinue</code> 进行系统服务继续执行；</li>
<li>如果不是展开的目标：正常情况下先调用 <code class="inline-code">RtlpExecuteHandlerForUnwind</code>，它会调用当前 <code class="inline-code">EH4_EXCEPTION_REGISTRATION->Handler</code>，根据处理结果：
<ul>
<li><code class="inline-code">ExceptionContinueSearch</code>：获取下一个帧地址并搜索</li>
<li><code class="inline-code">ExceptionCollidedUnwind</code>：调用 <code class="inline-code">handler</code> 时再次触发异常，并继续搜索。</li>
<li><code class="inline-code">EXCEPTION_NONCONTINUABLE</code>：其他处理值均无效；</li>
</ul>
</li>
<li>非正常情况：
<ul>
<li>如果堆栈没有对齐或正在处理的 <code class="inline-code">EXCEPTION_REGISTERATION</code> 超出了堆栈限制：调用 <code class="inline-code">RtlRaiseException</code> 起一个异常 <code class="inline-code">STATUS_BAD_STACK</code>，且 <code class="inline-code">EXCEPTION_NONCONTINUABLE</code>；</li>
<li>DPC 堆栈上，切换堆栈限制到 DPC 堆栈并重新启动循环</li>
</ul>
</li>
</ul>
</li>
<li>调用 <code class="inline-code">RtlpUnlinkHandler</code> 从链表中删除已被调用的 <code class="inline-code">Handler</code>。</li>
</ul>
<h6 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>局部展开</a></h6>
<p>另一个尴尬的事实是 <code class="inline-code">_EH4_LocalUnwind</code> 的源代码也没有，只能看汇编了（</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-x86asm language-x86asm"><span style="color:#393A34">_EH4_LocalUnwind</span><span style="color:#2993a3">(</span><br><span style="color:#393A34">	</span><span style="color:#1e754f">(</span><span style="color:#AB5959">DWORD</span><span style="color:#1e754f">)</span><span style="color:#393A34">EstablisherFrame,</span><br><span style="color:#393A34">	EstablisherFrame-</span><span style="color:#393A34">></span><span style="color:#393A34">TravelLevel,</span><br><span style="color:#393A34">	&#x26;EstablisherFrame-</span><span style="color:#393A34">></span><span style="color:#393A34">_ebp,</span><br><span style="color:#393A34">	__security_cookie</span><span style="color:#2993a3">)</span><span style="color:#A0ADA0">;</span><br><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    ebp</span><br><span style="color:#AB5959">mov</span><span style="color:#1E754F">     ebp</span><span style="color:#393A34">,</span><span style="color:#AB5959">dword</span><span style="color:#393A34"> ptr </span><span style="color:#2993a3">[</span><span style="color:#1E754F">esp</span><span style="color:#393A34">+</span><span style="color:#2F798A">8</span><span style="color:#2993a3">]</span><span style="color:#393A34"> </span><span style="color:#A0ADA0">; ebp = pExceptionRegistartion->_ebp</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    edx</span><span style="color:#A0ADA0"> ; ulUntilTryLevel</span><br><span style="color:#AB5959">push</span><span style="color:#1E754F">    ecx</span><span style="color:#A0ADA0"> ; pExceptionRegistartion</span><br><span style="color:#AB5959">push</span><span style="color:#AB5959">    dword</span><span style="color:#393A34"> ptr </span><span style="color:#2993a3">[</span><span style="color:#1E754F">esp</span><span style="color:#393A34">+</span><span style="color:#2F798A">14h</span><span style="color:#2993a3">]</span><span style="color:#393A34"> </span><span style="color:#A0ADA0">; push __security_cookie</span><br><span style="color:#AB5959">call</span><span style="color:#393A34">    __local_unwind4</span><br><span style="color:#AB5959">add</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">,</span><span style="color:#2F798A">0Ch</span><br><span style="color:#AB5959">pop</span><span style="color:#1E754F">     ebp</span><br><span style="color:#AB5959">ret</span><span style="color:#2F798A">     8</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-x86asm language-x86asm"><span style="color:#DBD7CAEE">_EH4_LocalUnwind</span><span style="color:#5eaab5">(</span><br><span style="color:#DBD7CAEE">	</span><span style="color:#4d9375">(</span><span style="color:#CB7676">DWORD</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">EstablisherFrame,</span><br><span style="color:#DBD7CAEE">	EstablisherFrame-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">TravelLevel,</span><br><span style="color:#DBD7CAEE">	&#x26;EstablisherFrame-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">_ebp,</span><br><span style="color:#DBD7CAEE">	__security_cookie</span><span style="color:#5eaab5">)</span><span style="color:#758575DD">;</span><br><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    ebp</span><br><span style="color:#CB7676">mov</span><span style="color:#4D9375">     ebp</span><span style="color:#DBD7CAEE">,</span><span style="color:#CB7676">dword</span><span style="color:#DBD7CAEE"> ptr </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">esp</span><span style="color:#DBD7CAEE">+</span><span style="color:#4C9A91">8</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE"> </span><span style="color:#758575DD">; ebp = pExceptionRegistartion->_ebp</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    edx</span><span style="color:#758575DD"> ; ulUntilTryLevel</span><br><span style="color:#CB7676">push</span><span style="color:#4D9375">    ecx</span><span style="color:#758575DD"> ; pExceptionRegistartion</span><br><span style="color:#CB7676">push</span><span style="color:#CB7676">    dword</span><span style="color:#DBD7CAEE"> ptr </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">esp</span><span style="color:#DBD7CAEE">+</span><span style="color:#4C9A91">14h</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE"> </span><span style="color:#758575DD">; push __security_cookie</span><br><span style="color:#CB7676">call</span><span style="color:#DBD7CAEE">    __local_unwind4</span><br><span style="color:#CB7676">add</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">,</span><span style="color:#4C9A91">0Ch</span><br><span style="color:#CB7676">pop</span><span style="color:#4D9375">     ebp</span><br><span style="color:#CB7676">ret</span><span style="color:#4C9A91">     8</span><br></code></pre></div>
<p>注意到其调用了 <code class="inline-code">__local_unwind4</code>，这个倒是有<a href="https://github.com/cradiator/CrMisc/blob/master/Msvcr90_Exception/Msvcr90_Exception/ExceptionDispatcher.cpp" title="https://github.com/cradiator/CrMisc/blob/master/Msvcr90_Exception/Msvcr90_Exception/ExceptionDispatcher.cpp" target="_blank" rel="noopener">反汇编</a>...个 p 啊：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#59873A">__declspec</span><span style="color:#2993a3">(</span><span style="color:#393A34">naked</span><span style="color:#2993a3">)</span><span style="color:#393A34"> VOID __cdecl</span><br><span style="color:#59873A">__local_unwind4</span><span style="color:#2993a3">(</span><span style="color:#393A34">DWORD</span><span style="color:#AB5959">*</span><span style="color:#B07D48"> CookiePointer</span><span style="color:#999999">,</span><span style="color:#393A34"> PVOID </span><span style="color:#B07D48">EstablishFrame</span><span style="color:#999999"> ,</span><span style="color:#393A34"> DWORD </span><span style="color:#B07D48">TargetEnclosingLevel</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#393A34">    __asm </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">        push ebx</span><br><span style="color:#393A34">        push esi</span><br><span style="color:#393A34">        push edi</span><br><span style="color:#393A34">        mov  edx</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">esp</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">10</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">        // edx = CookiePointer</span><br><span style="color:#393A34">        mov  eax</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">esp</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">14</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">        // eax = EstablishFrame</span><br><span style="color:#393A34">        mov  ecx</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">esp</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">18</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">        // ecx = EnclosingLevel</span><br><br><span style="color:#A0ADA0">        // establish new EstablishFrame for the protected seh node.</span><br><span style="color:#393A34">        push ebp</span><span style="color:#A0ADA0">                     // context frame</span><br><span style="color:#393A34">        push edx</span><span style="color:#A0ADA0">                     // CookiePointer</span><br><span style="color:#393A34">        push eax</span><span style="color:#A0ADA0">                     // PrevEstablishFrame</span><br><span style="color:#393A34">        push ecx</span><span style="color:#A0ADA0">                     // EnclosingLevel</span><br><span style="color:#393A34">        push ecx</span><span style="color:#A0ADA0">                     // Cookie</span><br><span style="color:#393A34">        push _unwind_handler4</span><span style="color:#A0ADA0">        // handler</span><br><span style="color:#393A34">        push fs:</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">0</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">                  // next</span><br><br><span style="color:#393A34">        mov  eax</span><span style="color:#999999">,</span><span style="color:#393A34"> __security_cookie</span><span style="color:#A0ADA0">  // edit the Cookie above to real value</span><br><span style="color:#393A34">        xor  eax</span><span style="color:#999999">,</span><span style="color:#393A34"> esp</span><br><span style="color:#393A34">        mov  </span><span style="color:#a65e2b">[</span><span style="color:#393A34">esp</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">08</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#393A34"> eax</span><br><br><span style="color:#A0ADA0">        // complete establish the seh.</span><br><span style="color:#393A34">        mov  fs:</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">0</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#393A34"> esp</span><br><br><span style="color:#393A34">_lu_top:</span><br><span style="color:#393A34">        mov  eax</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">esp</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">30</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">        // EstablishFrame</span><br><span style="color:#393A34">        mov  ebx</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">eax</span><span style="color:#AB5959">+</span><span style="color:#2F798A">8</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">           // EstablishFrame.EH4_SCOPETABLE</span><br><span style="color:#393A34">        mov  ecx</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">esp</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">2c</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">        // CookiePointer</span><br><span style="color:#393A34">        xor  ebx</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">ecx</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">             // ebx = decoded EH4_SCOPETABLE</span><br><span style="color:#393A34">        mov  esi</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">eax</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">0c</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">        // eax = EstablishFrame.EnclosingLevel</span><br><span style="color:#393A34">        cmp  esi</span><span style="color:#999999">,</span><span style="color:#393A34"> END_POS</span><br><span style="color:#393A34">        jz   _lu_done</span><span style="color:#A0ADA0">               // meet the last level. exit.</span><br><br><span style="color:#393A34">        mov  edx</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">esp</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">34</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">        // edx = EnclosingLevel</span><br><span style="color:#393A34">        cmp  edx</span><span style="color:#999999">,</span><span style="color:#393A34"> END_POS</span><br><span style="color:#393A34">        jz   __update_establishframe</span><br><br><span style="color:#393A34">        cmp  esi</span><span style="color:#999999">,</span><span style="color:#393A34"> edx</span><span style="color:#A0ADA0">               // EstablishFrame.EnclosingLevel &#x3C;= EnclosingLevel</span><br><span style="color:#393A34">        jbe  _lu_done</span><br><br><span style="color:#393A34">__update_establishframe:</span><br><span style="color:#A0ADA0">        // Update the EstablishFrame.EnlosingLevel to EnclosingLevel</span><br><span style="color:#393A34">        lea  esi</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">esi</span><span style="color:#AB5959">+</span><span style="color:#393A34">esi</span><span style="color:#AB5959">*</span><span style="color:#2F798A">2</span><span style="color:#a65e2b">]</span><br><span style="color:#393A34">        lea  ebx</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">ebx</span><span style="color:#AB5959">+</span><span style="color:#393A34">esi</span><span style="color:#AB5959">*</span><span style="color:#2F798A">4</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">10</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">      // ebx = &#x26;EH4_SCOPETABLE.ScopeRecord[esi]</span><br><span style="color:#393A34">        mov  ecx</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">ebx</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">                 // ecx = EH4_SCOPETABLE.ScopeRecord[esi].EnclosingLevel</span><br><span style="color:#393A34">        mov  </span><span style="color:#a65e2b">[</span><span style="color:#393A34">eax</span><span style="color:#AB5959">+0x</span><span style="color:#2F798A">0c</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#393A34"> ecx</span><span style="color:#A0ADA0">            // EstablishFrame.EnclosingLevel = EH4_SCOPETABLE.ScopeRecord[esi].EnclosingLevel</span><br><span style="color:#393A34">        cmp  </span><span style="color:#a65e2b">[</span><span style="color:#393A34">ebx</span><span style="color:#AB5959">+</span><span style="color:#2F798A">4</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#A0ADA0">                 // EH4_SCOPETABLE.ScopeRecord[esi].FilterFunc != NULL ?</span><br><span style="color:#393A34">        jnz  _lu_top</span><br><br><span style="color:#A0ADA0">//        push 0x101</span><br><span style="color:#393A34">        mov  eax</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">ebx</span><span style="color:#AB5959">+</span><span style="color:#2F798A">8</span><span style="color:#a65e2b">]</span><span style="color:#A0ADA0">               // eax = EH4_SCOPETABLE.ScopeRecord[esi].HandlerFunc</span><br><span style="color:#A0ADA0">//       call __NLG_Notify</span><br><br><span style="color:#393A34">        mov  ecx</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><br><span style="color:#393A34">        mov  eax</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#393A34">ebx</span><span style="color:#AB5959">+</span><span style="color:#2F798A">8</span><span style="color:#a65e2b">]</span><br><span style="color:#A0ADA0">//        call __NLG_Call</span><br><span style="color:#393A34">        call eax</span><br><br><span style="color:#393A34">        jmp  _lu_top</span><br><br><span style="color:#393A34">_lu_done:</span><br><span style="color:#393A34">        pop  ebx</span><br><span style="color:#393A34">        mov  fs:</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">0</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#393A34"> ebx</span><br><span style="color:#393A34">        add  esp</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">18</span><br><span style="color:#393A34">        pop  edi</span><br><span style="color:#393A34">        pop  esi</span><br><span style="color:#393A34">        pop  ebx</span><br><span style="color:#393A34">        retn</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#80A665">__declspec</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">naked</span><span style="color:#5eaab5">)</span><span style="color:#DBD7CAEE"> VOID __cdecl</span><br><span style="color:#80A665">__local_unwind4</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">DWORD</span><span style="color:#CB7676">*</span><span style="color:#BD976A"> CookiePointer</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> PVOID </span><span style="color:#BD976A">EstablishFrame</span><span style="color:#666666"> ,</span><span style="color:#DBD7CAEE"> DWORD </span><span style="color:#BD976A">TargetEnclosingLevel</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">    __asm </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">        push ebx</span><br><span style="color:#DBD7CAEE">        push esi</span><br><span style="color:#DBD7CAEE">        push edi</span><br><span style="color:#DBD7CAEE">        mov  edx</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">esp</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">10</span><span style="color:#d4976c">]</span><span style="color:#758575DD">        // edx = CookiePointer</span><br><span style="color:#DBD7CAEE">        mov  eax</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">esp</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">14</span><span style="color:#d4976c">]</span><span style="color:#758575DD">        // eax = EstablishFrame</span><br><span style="color:#DBD7CAEE">        mov  ecx</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">esp</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">18</span><span style="color:#d4976c">]</span><span style="color:#758575DD">        // ecx = EnclosingLevel</span><br><br><span style="color:#758575DD">        // establish new EstablishFrame for the protected seh node.</span><br><span style="color:#DBD7CAEE">        push ebp</span><span style="color:#758575DD">                     // context frame</span><br><span style="color:#DBD7CAEE">        push edx</span><span style="color:#758575DD">                     // CookiePointer</span><br><span style="color:#DBD7CAEE">        push eax</span><span style="color:#758575DD">                     // PrevEstablishFrame</span><br><span style="color:#DBD7CAEE">        push ecx</span><span style="color:#758575DD">                     // EnclosingLevel</span><br><span style="color:#DBD7CAEE">        push ecx</span><span style="color:#758575DD">                     // Cookie</span><br><span style="color:#DBD7CAEE">        push _unwind_handler4</span><span style="color:#758575DD">        // handler</span><br><span style="color:#DBD7CAEE">        push fs:</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">0</span><span style="color:#d4976c">]</span><span style="color:#758575DD">                  // next</span><br><br><span style="color:#DBD7CAEE">        mov  eax</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> __security_cookie</span><span style="color:#758575DD">  // edit the Cookie above to real value</span><br><span style="color:#DBD7CAEE">        xor  eax</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> esp</span><br><span style="color:#DBD7CAEE">        mov  </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">esp</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">08</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> eax</span><br><br><span style="color:#758575DD">        // complete establish the seh.</span><br><span style="color:#DBD7CAEE">        mov  fs:</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">0</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> esp</span><br><br><span style="color:#DBD7CAEE">_lu_top:</span><br><span style="color:#DBD7CAEE">        mov  eax</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">esp</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">30</span><span style="color:#d4976c">]</span><span style="color:#758575DD">        // EstablishFrame</span><br><span style="color:#DBD7CAEE">        mov  ebx</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">eax</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">8</span><span style="color:#d4976c">]</span><span style="color:#758575DD">           // EstablishFrame.EH4_SCOPETABLE</span><br><span style="color:#DBD7CAEE">        mov  ecx</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">esp</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">2c</span><span style="color:#d4976c">]</span><span style="color:#758575DD">        // CookiePointer</span><br><span style="color:#DBD7CAEE">        xor  ebx</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">ecx</span><span style="color:#d4976c">]</span><span style="color:#758575DD">             // ebx = decoded EH4_SCOPETABLE</span><br><span style="color:#DBD7CAEE">        mov  esi</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">eax</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">0c</span><span style="color:#d4976c">]</span><span style="color:#758575DD">        // eax = EstablishFrame.EnclosingLevel</span><br><span style="color:#DBD7CAEE">        cmp  esi</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> END_POS</span><br><span style="color:#DBD7CAEE">        jz   _lu_done</span><span style="color:#758575DD">               // meet the last level. exit.</span><br><br><span style="color:#DBD7CAEE">        mov  edx</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">esp</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">34</span><span style="color:#d4976c">]</span><span style="color:#758575DD">        // edx = EnclosingLevel</span><br><span style="color:#DBD7CAEE">        cmp  edx</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> END_POS</span><br><span style="color:#DBD7CAEE">        jz   __update_establishframe</span><br><br><span style="color:#DBD7CAEE">        cmp  esi</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> edx</span><span style="color:#758575DD">               // EstablishFrame.EnclosingLevel &#x3C;= EnclosingLevel</span><br><span style="color:#DBD7CAEE">        jbe  _lu_done</span><br><br><span style="color:#DBD7CAEE">__update_establishframe:</span><br><span style="color:#758575DD">        // Update the EstablishFrame.EnlosingLevel to EnclosingLevel</span><br><span style="color:#DBD7CAEE">        lea  esi</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">esi</span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE">esi</span><span style="color:#CB7676">*</span><span style="color:#4C9A91">2</span><span style="color:#d4976c">]</span><br><span style="color:#DBD7CAEE">        lea  ebx</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">ebx</span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE">esi</span><span style="color:#CB7676">*</span><span style="color:#4C9A91">4</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">10</span><span style="color:#d4976c">]</span><span style="color:#758575DD">      // ebx = &#x26;EH4_SCOPETABLE.ScopeRecord[esi]</span><br><span style="color:#DBD7CAEE">        mov  ecx</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">ebx</span><span style="color:#d4976c">]</span><span style="color:#758575DD">                 // ecx = EH4_SCOPETABLE.ScopeRecord[esi].EnclosingLevel</span><br><span style="color:#DBD7CAEE">        mov  </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">eax</span><span style="color:#CB7676">+0x</span><span style="color:#4C9A91">0c</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ecx</span><span style="color:#758575DD">            // EstablishFrame.EnclosingLevel = EH4_SCOPETABLE.ScopeRecord[esi].EnclosingLevel</span><br><span style="color:#DBD7CAEE">        cmp  </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">ebx</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">4</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#758575DD">                 // EH4_SCOPETABLE.ScopeRecord[esi].FilterFunc != NULL ?</span><br><span style="color:#DBD7CAEE">        jnz  _lu_top</span><br><br><span style="color:#758575DD">//        push 0x101</span><br><span style="color:#DBD7CAEE">        mov  eax</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">ebx</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">8</span><span style="color:#d4976c">]</span><span style="color:#758575DD">               // eax = EH4_SCOPETABLE.ScopeRecord[esi].HandlerFunc</span><br><span style="color:#758575DD">//       call __NLG_Notify</span><br><br><span style="color:#DBD7CAEE">        mov  ecx</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><br><span style="color:#DBD7CAEE">        mov  eax</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">ebx</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">8</span><span style="color:#d4976c">]</span><br><span style="color:#758575DD">//        call __NLG_Call</span><br><span style="color:#DBD7CAEE">        call eax</span><br><br><span style="color:#DBD7CAEE">        jmp  _lu_top</span><br><br><span style="color:#DBD7CAEE">_lu_done:</span><br><span style="color:#DBD7CAEE">        pop  ebx</span><br><span style="color:#DBD7CAEE">        mov  fs:</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">0</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ebx</span><br><span style="color:#DBD7CAEE">        add  esp</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">18</span><br><span style="color:#DBD7CAEE">        pop  edi</span><br><span style="color:#DBD7CAEE">        pop  esi</span><br><span style="color:#DBD7CAEE">        pop  ebx</span><br><span style="color:#DBD7CAEE">        retn</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>这东西的逻辑倒是不复杂，关键点在于它会调用当前节点的 <code class="inline-code">HandlerFunc</code>。</p>
<p>总结一下，在异常处理过程中：</p>
<ul>
<li>每个异常至少会遍历异常链表两次：
<ul>
<li>一次是在 <code class="inline-code">RtlDispatchException</code> 中，遍历的目的是找到愿意处理该异常的 <code class="inline-code">_EXCEPTION_REGISTRATION_RECORD</code>，遍历的同时会调用 <code class="inline-code">RtlpExecuteHandlerForException</code> 运行异常处理程序；</li>
<li>第二次是在展开过程中，遍历的目的是为了对每个遍历到的 <code class="inline-code">EXCEPTION_REGISTRATION_RECORD</code> 进行局部展开，遍历的同时会调用 <code class="inline-code">RtlpExecuteHandlerForUnwind</code> 运行异常处理程序（局部展开的话调用 <code class="inline-code">__local_unwind4</code> 起 <code class="inline-code">HandlerFunc</code>）</li>
</ul>
</li>
<li>每个异常的 <code class="inline-code">scopetable</code> 也会被遍历至少两次：
<ul>
<li>一次是 <code class="inline-code">__except_handler4</code> 中，遍历目的也是找到愿意处理该异常的 <code class="inline-code">scopetable_entry</code>，遍历的同时调用 <code class="inline-code">scopetable</code> 中的 HandlerFunc；</li>
<li>第二次是 <code class="inline-code">__local_unwind4</code> 函数内，遍历的目的是找到所有指定范围内的能用的 <code class="inline-code">FilterFunc</code>，遍历的同时调用 <code class="inline-code">scopetable</code> 中的 HandlerFunc。</li>
</ul>
</li>
</ul>
<p>到这里，windows 的 SEH 机制就基本讲完了。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>相关题目</a></h2>
<p><del>有谁还记得这篇博客本来是 wp 的（（（</del></p>
<p>我们现在以 MoeCTF 2023 unwind 为例来应用一下上面的知识。</p>
<p>先看看 <code class="inline-code">main_0</code> 函数：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">int</span><span style="color:#393A34"> __cdecl </span><span style="color:#59873A">main_0</span><span style="color:#2993a3">(</span><span style="color:#AB5959">int</span><span style="color:#B07D48"> argc</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">argv</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">envp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">    char</span><span style="color:#393A34"> v4</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [esp+0h] [ebp-100h]</span><br><br><span style="color:#59873A">    __CheckForDebuggerJustMyCode</span><span style="color:#1e754f">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">unk_41C063</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    sub_4113E3</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    puts</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Welcome to moectf2023!!! Now you find YunZh1Jun's revenge!!!</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    puts</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Do you know TEA(an encryption algorithm)? Do you know unwind in SEH? </span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    puts</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">I believe you can understand them! So let me check your flag~</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    sub_4110CD</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Input:</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> v4</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    sub_4113CA</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%64s</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#AB5959">char</span><span style="color:#a65e2b">)</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">byte_41A578</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    MEMORY</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#59873A">    sub_4110FF</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    puts</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Right flag! Have fun in moectf2023~</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> __cdecl </span><span style="color:#80A665">main_0</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> argc</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">argv</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">envp</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">    char</span><span style="color:#DBD7CAEE"> v4</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [esp+0h] [ebp-100h]</span><br><br><span style="color:#80A665">    __CheckForDebuggerJustMyCode</span><span style="color:#4d9375">(</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">unk_41C063</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    sub_4113E3</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    puts</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Welcome to moectf2023!!! Now you find YunZh1Jun's revenge!!!</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    puts</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Do you know TEA(an encryption algorithm)? Do you know unwind in SEH? </span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    puts</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">I believe you can understand them! So let me check your flag~</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    sub_4110CD</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Input:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> v4</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    sub_4113CA</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%64s</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#CB7676">char</span><span style="color:#d4976c">)</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">byte_41A578</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">    MEMORY</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666"> =</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><br><span style="color:#80A665">    sub_4110FF</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    puts</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Right flag! Have fun in moectf2023~</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">    return</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>可以看到 <code class="inline-code">MEMORY[0] = 0;</code> 被标着显眼的大红色，这其实是一个很强的提示：即程序中触发了非法内存访问的异常（<code class="inline-code">MEMORY[0]</code> 一定是一个非法的地址）。</p>
<p>来看汇编，在开头可以看到 <code class="inline-code">unwind</code>、<code class="inline-code">__except_handler4</code> 等 ida 加的注释，实际上，整个 main_0 函数 其实就是一个巨大的 __except_handler4 函数。</p>
<p>在输入函数正下方是第一个 try-except：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-x86asm language-x86asm"><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415908</span><span style="color:#A0ADA0"> ;   __try { // __except at loc_415928</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415908</span><span style="color:#AB5959"> mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+ms_exc.registration.TryLevel</span><span style="color:#2993a3">]</span><span style="color:#393A34">, </span><span style="color:#2F798A">0</span><span style="color:#A0ADA0"> ; 注册的第一个 try 块，其 scopetable->trylevel 标记为 0</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041590F </span><span style="color:#AB5959">mov</span><span style="color:#393A34">     large </span><span style="color:#AB5959">dword</span><span style="color:#393A34"> ptr </span><span style="color:#1E754F">ds</span><span style="color:#393A34">:</span><span style="color:#2F798A">0</span><span style="color:#393A34">, </span><span style="color:#2F798A">0</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041590F </span><span style="color:#A0ADA0">;   } // starts at 415908</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415919</span><span style="color:#AB5959"> mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+ms_exc.registration.TryLevel</span><span style="color:#2993a3">]</span><span style="color:#393A34">, </span><span style="color:#2F798A">0FFFFFFFEh</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415920</span><span style="color:#AB5959"> jmp</span><span style="color:#393A34">     short loc_41597A</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415920</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415922</span><span style="color:#A0ADA0"> ; ---------------------------------------------------------------------------</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415922</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415922</span><span style="color:#59873A"> loc_415922</span><span style="color:#999999">:</span><span style="color:#A0ADA0">                             ; DATA XREF: .rdata:stru_4192E8↓o</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415922</span><span style="color:#A0ADA0"> ;   __except filter // owned by 415908</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415922</span><span style="color:#AB5959"> mov</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">, </span><span style="color:#2F798A">1</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415927</span><span style="color:#AB5959"> retn</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415927</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415928</span><span style="color:#A0ADA0"> ; ---------------------------------------------------------------------------</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415928</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415928</span><span style="color:#59873A"> loc_415928</span><span style="color:#999999">:</span><span style="color:#A0ADA0">                             ; DATA XREF: .rdata:stru_4192E8↓o</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415928</span><span style="color:#A0ADA0"> ;   __except(loc_415922) // owned by 415908</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415928</span><span style="color:#AB5959"> mov</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+ms_exc.old_esp</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041592B </span><span style="color:#AB5959">push</span><span style="color:#393A34">    offset aDx3906                  </span><span style="color:#A0ADA0">; "DX3906"</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415930</span><span style="color:#AB5959"> push</span><span style="color:#393A34">    offset flag</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415935</span><span style="color:#AB5959"> call</span><span style="color:#393A34">    sub_41136B</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415935</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041593A </span><span style="color:#AB5959">add</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#2F798A">8</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">0041593D</span><span style="color:#AB5959"> push</span><span style="color:#393A34">    offset aDoctor3                 </span><span style="color:#A0ADA0">; "doctor3"</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415942</span><span style="color:#AB5959"> push</span><span style="color:#393A34">    offset unk_41A580</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415947</span><span style="color:#AB5959"> call</span><span style="color:#393A34">    sub_41136B</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415947</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041594C </span><span style="color:#AB5959">add</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#2F798A">8</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041594F </span><span style="color:#AB5959">push</span><span style="color:#393A34">    offset aFux1aoyun               </span><span style="color:#A0ADA0">; "FUX1AOYUN"</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415954</span><span style="color:#AB5959"> push</span><span style="color:#393A34">    offset unk_41A588</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415959</span><span style="color:#AB5959"> call</span><span style="color:#393A34">    sub_41136B</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415959</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041595E </span><span style="color:#AB5959">add</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#2F798A">8</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415961</span><span style="color:#AB5959"> push</span><span style="color:#393A34">    offset aR3verier                </span><span style="color:#A0ADA0">; "R3verier"</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415966</span><span style="color:#AB5959"> push</span><span style="color:#393A34">    offset unk_41A590</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041596B </span><span style="color:#AB5959">call</span><span style="color:#393A34">    sub_41136B</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041596B</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415970</span><span style="color:#AB5959"> add</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#2F798A">8</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415973</span><span style="color:#AB5959"> mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+ms_exc.registration.TryLevel</span><span style="color:#2993a3">]</span><span style="color:#393A34">, -</span><span style="color:#2F798A">2</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-x86asm language-x86asm"><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415908</span><span style="color:#758575DD"> ;   __try { // __except at loc_415928</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415908</span><span style="color:#CB7676"> mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+ms_exc.registration.TryLevel</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">0</span><span style="color:#758575DD"> ; 注册的第一个 try 块，其 scopetable->trylevel 标记为 0</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041590F </span><span style="color:#CB7676">mov</span><span style="color:#DBD7CAEE">     large </span><span style="color:#CB7676">dword</span><span style="color:#DBD7CAEE"> ptr </span><span style="color:#4D9375">ds</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">0</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041590F </span><span style="color:#758575DD">;   } // starts at 415908</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415919</span><span style="color:#CB7676"> mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+ms_exc.registration.TryLevel</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">0FFFFFFFEh</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415920</span><span style="color:#CB7676"> jmp</span><span style="color:#DBD7CAEE">     short loc_41597A</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415920</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415922</span><span style="color:#758575DD"> ; ---------------------------------------------------------------------------</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415922</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415922</span><span style="color:#80A665"> loc_415922</span><span style="color:#666666">:</span><span style="color:#758575DD">                             ; DATA XREF: .rdata:stru_4192E8↓o</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415922</span><span style="color:#758575DD"> ;   __except filter // owned by 415908</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415922</span><span style="color:#CB7676"> mov</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">1</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415927</span><span style="color:#CB7676"> retn</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415927</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415928</span><span style="color:#758575DD"> ; ---------------------------------------------------------------------------</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415928</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415928</span><span style="color:#80A665"> loc_415928</span><span style="color:#666666">:</span><span style="color:#758575DD">                             ; DATA XREF: .rdata:stru_4192E8↓o</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415928</span><span style="color:#758575DD"> ;   __except(loc_415922) // owned by 415908</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415928</span><span style="color:#CB7676"> mov</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+ms_exc.old_esp</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041592B </span><span style="color:#CB7676">push</span><span style="color:#DBD7CAEE">    offset aDx3906                  </span><span style="color:#758575DD">; "DX3906"</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415930</span><span style="color:#CB7676"> push</span><span style="color:#DBD7CAEE">    offset flag</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415935</span><span style="color:#CB7676"> call</span><span style="color:#DBD7CAEE">    sub_41136B</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415935</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041593A </span><span style="color:#CB7676">add</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">8</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0041593D</span><span style="color:#CB7676"> push</span><span style="color:#DBD7CAEE">    offset aDoctor3                 </span><span style="color:#758575DD">; "doctor3"</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415942</span><span style="color:#CB7676"> push</span><span style="color:#DBD7CAEE">    offset unk_41A580</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415947</span><span style="color:#CB7676"> call</span><span style="color:#DBD7CAEE">    sub_41136B</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415947</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041594C </span><span style="color:#CB7676">add</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">8</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041594F </span><span style="color:#CB7676">push</span><span style="color:#DBD7CAEE">    offset aFux1aoyun               </span><span style="color:#758575DD">; "FUX1AOYUN"</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415954</span><span style="color:#CB7676"> push</span><span style="color:#DBD7CAEE">    offset unk_41A588</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415959</span><span style="color:#CB7676"> call</span><span style="color:#DBD7CAEE">    sub_41136B</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415959</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041595E </span><span style="color:#CB7676">add</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">8</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415961</span><span style="color:#CB7676"> push</span><span style="color:#DBD7CAEE">    offset aR3verier                </span><span style="color:#758575DD">; "R3verier"</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415966</span><span style="color:#CB7676"> push</span><span style="color:#DBD7CAEE">    offset unk_41A590</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041596B </span><span style="color:#CB7676">call</span><span style="color:#DBD7CAEE">    sub_41136B</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041596B</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415970</span><span style="color:#CB7676"> add</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">8</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415973</span><span style="color:#CB7676"> mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+ms_exc.registration.TryLevel</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, -</span><span style="color:#4C9A91">2</span><br></code></pre></div>
<p>既然有了前面知识的铺垫，那么这一段汇编代码理解起来应该没有什么难度：注意到 <code class="inline-code">.text:0041590F</code> 处会触发了一个读写非法地址异常，往下紧接着就是 __except filter，它直接返回了 1，也就是 EXCEPTION_EXECUTE_HANDLER，根据前面的知识，__except_handler4 在获取 FilterFunc 后会根据调用 filter 并根据 FilterResult 决定下一步的操作，这里为 1，故会进行全局展开，也就是接着调用 RtlUnwind，RtlUnwind 又会起一个 EH4_EXCEPTION_REGISTRATION->Handler，也就是我们这里的 __except 块。</p>
<p>注意到这里的 except 块调用了 4 次 sub_41136B，这个函数是一个正常的 TEA 加密，每次 TEA 会加密 8*8 位二进制，后面会讲。</p>
<p>我们接着来看，在一个异常被处理后，程序继续执行：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-x86asm language-x86asm"><span style="color:#59873A">.text</span><span style="color:#393A34">:0041597A                               </span><span style="color:#59873A">loc_41597A</span><span style="color:#999999">:</span><span style="color:#A0ADA0">                             ; CODE XREF: _main_0+D0↑j</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041597A                               </span><span style="color:#A0ADA0">;   __try { // __except at loc_415995</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041597A C7 </span><span style="color:#2F798A">45</span><span style="color:#393A34"> FC </span><span style="color:#2F798A">01</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+ms_exc.registration.TryLevel</span><span style="color:#2993a3">]</span><span style="color:#393A34">, </span><span style="color:#2F798A">1</span><span style="color:#A0ADA0"> ; 注册第二个异常快</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415981</span><span style="color:#393A34"> E8 </span><span style="color:#2F798A">79</span><span style="color:#393A34"> B7 FF FF                </span><span style="color:#AB5959">call</span><span style="color:#393A34">    sub_4110FF</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415981</span><span style="color:#A0ADA0">                               ;   } // starts at 41597A</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415981</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415986</span><span style="color:#393A34"> C7 </span><span style="color:#2F798A">45</span><span style="color:#393A34"> FC FE FF FF FF          </span><span style="color:#AB5959">mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+ms_exc.registration.TryLevel</span><span style="color:#2993a3">]</span><span style="color:#393A34">, -</span><span style="color:#2F798A">2</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">0041598D</span><span style="color:#393A34"> EB </span><span style="color:#2F798A">72</span><span style="color:#AB5959">                         jmp</span><span style="color:#393A34">     short loc_415A01</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">0041598D</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041598F                               </span><span style="color:#A0ADA0">; ---------------------------------------------------------------------------</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041598F</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041598F                               </span><span style="color:#59873A">loc_41598F</span><span style="color:#999999">:</span><span style="color:#A0ADA0">                             ; DATA XREF: .rdata:stru_4192E8↓o</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041598F                               </span><span style="color:#A0ADA0">;   __except filter // owned by 41597A</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041598F B8 </span><span style="color:#2F798A">01</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">                mov</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">, </span><span style="color:#2F798A">1</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415994</span><span style="color:#393A34"> C3                            </span><span style="color:#AB5959">retn</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415994</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415995</span><span style="color:#A0ADA0">                               ; ---------------------------------------------------------------------------</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415995</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415995</span><span style="color:#59873A">                               loc_415995</span><span style="color:#999999">:</span><span style="color:#A0ADA0">                             ; DATA XREF: .rdata:stru_4192E8↓o</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415995</span><span style="color:#A0ADA0">                               ;   __except(loc_41598F) // owned by 41597A</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415995</span><span style="color:#393A34"> 8B </span><span style="color:#2F798A">65</span><span style="color:#393A34"> E8                      </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+ms_exc.old_esp</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00415998</span><span style="color:#393A34"> C7 </span><span style="color:#2F798A">45</span><span style="color:#393A34"> E0 </span><span style="color:#2F798A">00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_20</span><span style="color:#2993a3">]</span><span style="color:#393A34">, </span><span style="color:#2F798A">0</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041599F EB </span><span style="color:#2F798A">09</span><span style="color:#AB5959">                         jmp</span><span style="color:#393A34">     short loc_4159AA</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-x86asm language-x86asm"><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041597A                               </span><span style="color:#80A665">loc_41597A</span><span style="color:#666666">:</span><span style="color:#758575DD">                             ; CODE XREF: _main_0+D0↑j</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041597A                               </span><span style="color:#758575DD">;   __try { // __except at loc_415995</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041597A C7 </span><span style="color:#4C9A91">45</span><span style="color:#DBD7CAEE"> FC </span><span style="color:#4C9A91">01</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+ms_exc.registration.TryLevel</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">1</span><span style="color:#758575DD"> ; 注册第二个异常快</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415981</span><span style="color:#DBD7CAEE"> E8 </span><span style="color:#4C9A91">79</span><span style="color:#DBD7CAEE"> B7 FF FF                </span><span style="color:#CB7676">call</span><span style="color:#DBD7CAEE">    sub_4110FF</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415981</span><span style="color:#758575DD">                               ;   } // starts at 41597A</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415981</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415986</span><span style="color:#DBD7CAEE"> C7 </span><span style="color:#4C9A91">45</span><span style="color:#DBD7CAEE"> FC FE FF FF FF          </span><span style="color:#CB7676">mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+ms_exc.registration.TryLevel</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, -</span><span style="color:#4C9A91">2</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0041598D</span><span style="color:#DBD7CAEE"> EB </span><span style="color:#4C9A91">72</span><span style="color:#CB7676">                         jmp</span><span style="color:#DBD7CAEE">     short loc_415A01</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0041598D</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041598F                               </span><span style="color:#758575DD">; ---------------------------------------------------------------------------</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041598F</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041598F                               </span><span style="color:#80A665">loc_41598F</span><span style="color:#666666">:</span><span style="color:#758575DD">                             ; DATA XREF: .rdata:stru_4192E8↓o</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041598F                               </span><span style="color:#758575DD">;   __except filter // owned by 41597A</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041598F B8 </span><span style="color:#4C9A91">01</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">                mov</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">1</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415994</span><span style="color:#DBD7CAEE"> C3                            </span><span style="color:#CB7676">retn</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415994</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415995</span><span style="color:#758575DD">                               ; ---------------------------------------------------------------------------</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415995</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415995</span><span style="color:#80A665">                               loc_415995</span><span style="color:#666666">:</span><span style="color:#758575DD">                             ; DATA XREF: .rdata:stru_4192E8↓o</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415995</span><span style="color:#758575DD">                               ;   __except(loc_41598F) // owned by 41597A</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415995</span><span style="color:#DBD7CAEE"> 8B </span><span style="color:#4C9A91">65</span><span style="color:#DBD7CAEE"> E8                      </span><span style="color:#CB7676">mov</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+ms_exc.old_esp</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00415998</span><span style="color:#DBD7CAEE"> C7 </span><span style="color:#4C9A91">45</span><span style="color:#DBD7CAEE"> E0 </span><span style="color:#4C9A91">00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_20</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">0</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041599F EB </span><span style="color:#4C9A91">09</span><span style="color:#CB7676">                         jmp</span><span style="color:#DBD7CAEE">     short loc_4159AA</span><br></code></pre></div>
<p>注意到 <code class="inline-code">.text:00415981</code> 调用了一个 <code class="inline-code">sub_4110FF</code>，双击进去看：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-x86asm language-x86asm"><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411820</span><span style="color:#393A34">                               sub_411820 proc </span><span style="color:#AB5959">near</span><span style="color:#A0ADA0">                    ; CODE XREF: sub_4110FF↑j</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411820</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411820</span><span style="color:#393A34">                               var_E4= </span><span style="color:#AB5959">dword</span><span style="color:#393A34"> ptr -</span><span style="color:#2F798A">0E4h</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411820</span><span style="color:#393A34">                               var_10= </span><span style="color:#AB5959">byte</span><span style="color:#393A34"> ptr -</span><span style="color:#2F798A">10h</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411820</span><span style="color:#393A34">                               var_C= </span><span style="color:#AB5959">dword</span><span style="color:#393A34"> ptr -</span><span style="color:#2F798A">0Ch</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411820</span><span style="color:#393A34">                               var_4= </span><span style="color:#AB5959">dword</span><span style="color:#393A34"> ptr -</span><span style="color:#2F798A">4</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411820</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411820</span><span style="color:#2F798A"> 55</span><span style="color:#AB5959">                            push</span><span style="color:#1E754F">    ebp</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411821</span><span style="color:#393A34"> 8B EC                         </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">     ebp</span><span style="color:#393A34">, </span><span style="color:#1E754F">esp</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411823</span><span style="color:#2F798A"> 81</span><span style="color:#393A34"> EC D0 </span><span style="color:#2F798A">00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">             sub</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#2F798A">0D0h</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411829</span><span style="color:#2F798A"> 53</span><span style="color:#AB5959">                            push</span><span style="color:#1E754F">    ebx</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041182A </span><span style="color:#2F798A">56</span><span style="color:#AB5959">                            push</span><span style="color:#1E754F">    esi</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041182B </span><span style="color:#2F798A">57</span><span style="color:#AB5959">                            push</span><span style="color:#1E754F">    edi</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041182C </span><span style="color:#2F798A">8D</span><span style="color:#2F798A"> 7D</span><span style="color:#393A34"> F0                      </span><span style="color:#AB5959">lea</span><span style="color:#1E754F">     edi</span><span style="color:#393A34">, </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_10</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041182F B9 </span><span style="color:#2F798A">04</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">                mov</span><span style="color:#1E754F">     ecx</span><span style="color:#393A34">, </span><span style="color:#2F798A">4</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411834</span><span style="color:#393A34"> B8 CC CC CC CC                </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">, </span><span style="color:#2F798A">0CCCCCCCCh</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411839</span><span style="color:#393A34"> F3 AB                         </span><span style="color:#AB5959">rep</span><span style="color:#AB5959"> stosd</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041183B A1 </span><span style="color:#2F798A">08</span><span style="color:#393A34"> A1 </span><span style="color:#2F798A">41</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">                mov</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">, ___security_cookie</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411840</span><span style="color:#2F798A"> 33</span><span style="color:#393A34"> C5                         </span><span style="color:#AB5959">xor</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">, </span><span style="color:#1E754F">ebp</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411842</span><span style="color:#2F798A"> 89</span><span style="color:#2F798A"> 45</span><span style="color:#393A34"> FC                      </span><span style="color:#AB5959">mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_4</span><span style="color:#2993a3">]</span><span style="color:#393A34">, </span><span style="color:#1E754F">eax</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411845</span><span style="color:#393A34"> C7 </span><span style="color:#2F798A">45</span><span style="color:#393A34"> F4 FD </span><span style="color:#2F798A">12</span><span style="color:#2F798A"> 41</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_C</span><span style="color:#2993a3">]</span><span style="color:#393A34">, offset loc_4112FD </span><span style="color:#A0ADA0">; trick</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041184C FF </span><span style="color:#2F798A">75</span><span style="color:#393A34"> F4                      </span><span style="color:#AB5959">push</span><span style="color:#393A34">    </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_C</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041184F </span><span style="color:#2F798A">64</span><span style="color:#393A34"> FF </span><span style="color:#2F798A">35</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          push</span><span style="color:#393A34">    large </span><span style="color:#AB5959">dword</span><span style="color:#393A34"> ptr </span><span style="color:#1E754F">fs</span><span style="color:#393A34">:</span><span style="color:#2F798A">0</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411856</span><span style="color:#2F798A"> 64</span><span style="color:#2F798A"> 89</span><span style="color:#2F798A"> 25</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          mov</span><span style="color:#393A34">     large </span><span style="color:#1E754F">fs</span><span style="color:#393A34">:</span><span style="color:#2F798A">0</span><span style="color:#393A34">, </span><span style="color:#1E754F">esp</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">0041185D</span><span style="color:#393A34"> CC                            </span><span style="color:#AB5959">int</span><span style="color:#2F798A">     3</span><span style="color:#A0ADA0">                               ; Trap to Debugger</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041185E 8B </span><span style="color:#2F798A">04</span><span style="color:#2F798A"> 24</span><span style="color:#AB5959">                      mov</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">, </span><span style="color:#2993a3">[</span><span style="color:#1E754F">esp</span><span style="color:#393A34">+</span><span style="color:#2F798A">0E4h</span><span style="color:#393A34">+var_E4</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411861</span><span style="color:#2F798A"> 64</span><span style="color:#393A34"> A3 </span><span style="color:#2F798A">00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">             mov</span><span style="color:#393A34">     large </span><span style="color:#1E754F">fs</span><span style="color:#393A34">:</span><span style="color:#2F798A">0</span><span style="color:#393A34">, </span><span style="color:#1E754F">eax</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411867</span><span style="color:#2F798A"> 83</span><span style="color:#393A34"> C4 </span><span style="color:#2F798A">08</span><span style="color:#AB5959">                      add</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#2F798A">8</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041186A 5F                            </span><span style="color:#AB5959">pop</span><span style="color:#1E754F">     edi</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041186B 5E                            </span><span style="color:#AB5959">pop</span><span style="color:#1E754F">     esi</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041186C 5B                            </span><span style="color:#AB5959">pop</span><span style="color:#1E754F">     ebx</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">0041186D</span><span style="color:#393A34"> 8B </span><span style="color:#2F798A">4D</span><span style="color:#393A34"> FC                      </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">     ecx</span><span style="color:#393A34">, </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_4</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411870</span><span style="color:#2F798A"> 33</span><span style="color:#393A34"> CD                         </span><span style="color:#AB5959">xor</span><span style="color:#1E754F">     ecx</span><span style="color:#393A34">, </span><span style="color:#1E754F">ebp</span><span style="color:#A0ADA0">                        ; StackCookie</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411872</span><span style="color:#393A34"> E8 D3 F8 FF FF                </span><span style="color:#AB5959">call</span><span style="color:#393A34">    j_@__security_check_cookie@</span><span style="color:#2F798A">4</span><span style="color:#A0ADA0">    ; __security_check_cookie(x)</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411872</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411877</span><span style="color:#2F798A"> 81</span><span style="color:#393A34"> C4 D0 </span><span style="color:#2F798A">00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">             add</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#2F798A">0D0h</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">0041187D</span><span style="color:#393A34"> 3B EC                         </span><span style="color:#AB5959">cmp</span><span style="color:#1E754F">     ebp</span><span style="color:#393A34">, </span><span style="color:#1E754F">esp</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041187F E8 C0 F9 FF FF                </span><span style="color:#AB5959">call</span><span style="color:#393A34">    j___RTC_CheckEsp</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041187F</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411884</span><span style="color:#393A34"> 8B E5                         </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">     esp</span><span style="color:#393A34">, </span><span style="color:#1E754F">ebp</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411886</span><span style="color:#2F798A"> 5D</span><span style="color:#AB5959">                            pop</span><span style="color:#1E754F">     ebp</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411887</span><span style="color:#393A34"> C3                            </span><span style="color:#AB5959">retn</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-x86asm language-x86asm"><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411820</span><span style="color:#DBD7CAEE">                               sub_411820 proc </span><span style="color:#CB7676">near</span><span style="color:#758575DD">                    ; CODE XREF: sub_4110FF↑j</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411820</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411820</span><span style="color:#DBD7CAEE">                               var_E4= </span><span style="color:#CB7676">dword</span><span style="color:#DBD7CAEE"> ptr -</span><span style="color:#4C9A91">0E4h</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411820</span><span style="color:#DBD7CAEE">                               var_10= </span><span style="color:#CB7676">byte</span><span style="color:#DBD7CAEE"> ptr -</span><span style="color:#4C9A91">10h</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411820</span><span style="color:#DBD7CAEE">                               var_C= </span><span style="color:#CB7676">dword</span><span style="color:#DBD7CAEE"> ptr -</span><span style="color:#4C9A91">0Ch</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411820</span><span style="color:#DBD7CAEE">                               var_4= </span><span style="color:#CB7676">dword</span><span style="color:#DBD7CAEE"> ptr -</span><span style="color:#4C9A91">4</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411820</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411820</span><span style="color:#4C9A91"> 55</span><span style="color:#CB7676">                            push</span><span style="color:#4D9375">    ebp</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411821</span><span style="color:#DBD7CAEE"> 8B EC                         </span><span style="color:#CB7676">mov</span><span style="color:#4D9375">     ebp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">esp</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411823</span><span style="color:#4C9A91"> 81</span><span style="color:#DBD7CAEE"> EC D0 </span><span style="color:#4C9A91">00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">             sub</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">0D0h</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411829</span><span style="color:#4C9A91"> 53</span><span style="color:#CB7676">                            push</span><span style="color:#4D9375">    ebx</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041182A </span><span style="color:#4C9A91">56</span><span style="color:#CB7676">                            push</span><span style="color:#4D9375">    esi</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041182B </span><span style="color:#4C9A91">57</span><span style="color:#CB7676">                            push</span><span style="color:#4D9375">    edi</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041182C </span><span style="color:#4C9A91">8D</span><span style="color:#4C9A91"> 7D</span><span style="color:#DBD7CAEE"> F0                      </span><span style="color:#CB7676">lea</span><span style="color:#4D9375">     edi</span><span style="color:#DBD7CAEE">, </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_10</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041182F B9 </span><span style="color:#4C9A91">04</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">                mov</span><span style="color:#4D9375">     ecx</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">4</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411834</span><span style="color:#DBD7CAEE"> B8 CC CC CC CC                </span><span style="color:#CB7676">mov</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">0CCCCCCCCh</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411839</span><span style="color:#DBD7CAEE"> F3 AB                         </span><span style="color:#CB7676">rep</span><span style="color:#CB7676"> stosd</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041183B A1 </span><span style="color:#4C9A91">08</span><span style="color:#DBD7CAEE"> A1 </span><span style="color:#4C9A91">41</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">                mov</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">, ___security_cookie</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411840</span><span style="color:#4C9A91"> 33</span><span style="color:#DBD7CAEE"> C5                         </span><span style="color:#CB7676">xor</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">ebp</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411842</span><span style="color:#4C9A91"> 89</span><span style="color:#4C9A91"> 45</span><span style="color:#DBD7CAEE"> FC                      </span><span style="color:#CB7676">mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_4</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">eax</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411845</span><span style="color:#DBD7CAEE"> C7 </span><span style="color:#4C9A91">45</span><span style="color:#DBD7CAEE"> F4 FD </span><span style="color:#4C9A91">12</span><span style="color:#4C9A91"> 41</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_C</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, offset loc_4112FD </span><span style="color:#758575DD">; trick</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041184C FF </span><span style="color:#4C9A91">75</span><span style="color:#DBD7CAEE"> F4                      </span><span style="color:#CB7676">push</span><span style="color:#DBD7CAEE">    </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_C</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041184F </span><span style="color:#4C9A91">64</span><span style="color:#DBD7CAEE"> FF </span><span style="color:#4C9A91">35</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          push</span><span style="color:#DBD7CAEE">    large </span><span style="color:#CB7676">dword</span><span style="color:#DBD7CAEE"> ptr </span><span style="color:#4D9375">fs</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411856</span><span style="color:#4C9A91"> 64</span><span style="color:#4C9A91"> 89</span><span style="color:#4C9A91"> 25</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          mov</span><span style="color:#DBD7CAEE">     large </span><span style="color:#4D9375">fs</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">esp</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0041185D</span><span style="color:#DBD7CAEE"> CC                            </span><span style="color:#CB7676">int</span><span style="color:#4C9A91">     3</span><span style="color:#758575DD">                               ; Trap to Debugger</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041185E 8B </span><span style="color:#4C9A91">04</span><span style="color:#4C9A91"> 24</span><span style="color:#CB7676">                      mov</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">, </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">esp</span><span style="color:#DBD7CAEE">+</span><span style="color:#4C9A91">0E4h</span><span style="color:#DBD7CAEE">+var_E4</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411861</span><span style="color:#4C9A91"> 64</span><span style="color:#DBD7CAEE"> A3 </span><span style="color:#4C9A91">00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">             mov</span><span style="color:#DBD7CAEE">     large </span><span style="color:#4D9375">fs</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">eax</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411867</span><span style="color:#4C9A91"> 83</span><span style="color:#DBD7CAEE"> C4 </span><span style="color:#4C9A91">08</span><span style="color:#CB7676">                      add</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">8</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041186A 5F                            </span><span style="color:#CB7676">pop</span><span style="color:#4D9375">     edi</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041186B 5E                            </span><span style="color:#CB7676">pop</span><span style="color:#4D9375">     esi</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041186C 5B                            </span><span style="color:#CB7676">pop</span><span style="color:#4D9375">     ebx</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0041186D</span><span style="color:#DBD7CAEE"> 8B </span><span style="color:#4C9A91">4D</span><span style="color:#DBD7CAEE"> FC                      </span><span style="color:#CB7676">mov</span><span style="color:#4D9375">     ecx</span><span style="color:#DBD7CAEE">, </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_4</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411870</span><span style="color:#4C9A91"> 33</span><span style="color:#DBD7CAEE"> CD                         </span><span style="color:#CB7676">xor</span><span style="color:#4D9375">     ecx</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">ebp</span><span style="color:#758575DD">                        ; StackCookie</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411872</span><span style="color:#DBD7CAEE"> E8 D3 F8 FF FF                </span><span style="color:#CB7676">call</span><span style="color:#DBD7CAEE">    j_@__security_check_cookie@</span><span style="color:#4C9A91">4</span><span style="color:#758575DD">    ; __security_check_cookie(x)</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411872</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411877</span><span style="color:#4C9A91"> 81</span><span style="color:#DBD7CAEE"> C4 D0 </span><span style="color:#4C9A91">00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">             add</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">0D0h</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0041187D</span><span style="color:#DBD7CAEE"> 3B EC                         </span><span style="color:#CB7676">cmp</span><span style="color:#4D9375">     ebp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">esp</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041187F E8 C0 F9 FF FF                </span><span style="color:#CB7676">call</span><span style="color:#DBD7CAEE">    j___RTC_CheckEsp</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041187F</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411884</span><span style="color:#DBD7CAEE"> 8B E5                         </span><span style="color:#CB7676">mov</span><span style="color:#4D9375">     esp</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">ebp</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411886</span><span style="color:#4C9A91"> 5D</span><span style="color:#CB7676">                            pop</span><span style="color:#4D9375">     ebp</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411887</span><span style="color:#DBD7CAEE"> C3                            </span><span style="color:#CB7676">retn</span><br></code></pre></div>
<p>注意到 <code class="inline-code">.text:0041185D</code> 的 <code class="inline-code">int 3</code> 触发了调试异常，第一次做到这里的时候，我们可能会立马返回去看 <code class="inline-code">loc_415995</code> 处的 <code class="inline-code">except</code> 块，毕竟它的 filterfunc 也是直接返回了 EXCEPTION_EXECUTE_HANDLER，_except_handler4 肯定会调用这里。</p>
<p>停下来思考。</p>
<p>还记得在前言中提到的 trick 吗？这道题目最大的坑就是在进行栈完整性检查后的一段汇编中：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-x86asm language-x86asm"><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411845</span><span style="color:#393A34"> C7 </span><span style="color:#2F798A">45</span><span style="color:#393A34"> F4 FD </span><span style="color:#2F798A">12</span><span style="color:#2F798A"> 41</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_C</span><span style="color:#2993a3">]</span><span style="color:#393A34">, offset loc_4112FD </span><span style="color:#A0ADA0">; trick</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041184C FF </span><span style="color:#2F798A">75</span><span style="color:#393A34"> F4                      </span><span style="color:#AB5959">push</span><span style="color:#393A34">    </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_C</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:0041184F </span><span style="color:#2F798A">64</span><span style="color:#393A34"> FF </span><span style="color:#2F798A">35</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          push</span><span style="color:#393A34">    large </span><span style="color:#AB5959">dword</span><span style="color:#393A34"> ptr </span><span style="color:#1E754F">fs</span><span style="color:#393A34">:</span><span style="color:#2F798A">0</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:</span><span style="color:#2F798A">00411856</span><span style="color:#2F798A"> 64</span><span style="color:#2F798A"> 89</span><span style="color:#2F798A"> 25</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          mov</span><span style="color:#393A34">     large </span><span style="color:#1E754F">fs</span><span style="color:#393A34">:</span><span style="color:#2F798A">0</span><span style="color:#393A34">, </span><span style="color:#1E754F">esp</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-x86asm language-x86asm"><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411845</span><span style="color:#DBD7CAEE"> C7 </span><span style="color:#4C9A91">45</span><span style="color:#DBD7CAEE"> F4 FD </span><span style="color:#4C9A91">12</span><span style="color:#4C9A91"> 41</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_C</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, offset loc_4112FD </span><span style="color:#758575DD">; trick</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041184C FF </span><span style="color:#4C9A91">75</span><span style="color:#DBD7CAEE"> F4                      </span><span style="color:#CB7676">push</span><span style="color:#DBD7CAEE">    </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_C</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:0041184F </span><span style="color:#4C9A91">64</span><span style="color:#DBD7CAEE"> FF </span><span style="color:#4C9A91">35</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          push</span><span style="color:#DBD7CAEE">    large </span><span style="color:#CB7676">dword</span><span style="color:#DBD7CAEE"> ptr </span><span style="color:#4D9375">fs</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">00411856</span><span style="color:#4C9A91"> 64</span><span style="color:#4C9A91"> 89</span><span style="color:#4C9A91"> 25</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          mov</span><span style="color:#DBD7CAEE">     large </span><span style="color:#4D9375">fs</span><span style="color:#DBD7CAEE">:</span><span style="color:#4C9A91">0</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">esp</span><br></code></pre></div>
<p>在这里，其再次注册了一个异常处理块，也就是说，出题人在这里插入了一个异常链表的节点，这个节点里的 loc_4112FD 函数第一次被 RtlDispatchException 调用，紧接着在栈展开时又被调用一次，但是这个 新的 EXECEPTION_REGISTRATION 结构并不处理异常，<code class="inline-code">loc_415995</code> 处的 <code class="inline-code">except</code> 块，这个块的工作正是逐个检查输入值是否正确。</p>
<p>然后我们来看那个正常的 TEA：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">int</span><span style="color:#393A34"> __cdecl </span><span style="color:#59873A">sub_415700</span><span style="color:#2993a3">(</span><span style="color:#AB5959">unsigned</span><span style="color:#AB5959"> int</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">v</span><span style="color:#999999">,</span><span style="color:#393A34"> _DWORD </span><span style="color:#AB5959">*</span><span style="color:#B07D48">k</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">    int</span><span style="color:#393A34"> i</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [esp+D0h] [ebp-68h]</span><br><span style="color:#AB5959">    unsigned</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> v1</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [esp+118h] [ebp-20h]</span><br><span style="color:#AB5959">    unsigned</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> v0</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [esp+124h] [ebp-14h]</span><br><span style="color:#AB5959">    int</span><span style="color:#393A34"> sum</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [esp+130h] [ebp-8h]</span><br><br><span style="color:#59873A">    __CheckForDebuggerJustMyCode</span><span style="color:#1e754f">(</span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34">unk_41C063</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">    sum </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#393A34">    v0 </span><span style="color:#999999">=</span><span style="color:#AB5959"> *</span><span style="color:#393A34">v</span><span style="color:#999999">;</span><br><span style="color:#393A34">    v1 </span><span style="color:#999999">=</span><span style="color:#B07D48"> v</span><span style="color:#1e754f">[</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 32</span><span style="color:#999999">;</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">i </span><span style="color:#1e754f">)</span><br><span style="color:#999999">    </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">        sum </span><span style="color:#AB5959">-=</span><span style="color:#2F798A"> 1640531527</span><span style="color:#999999">;</span><br><span style="color:#393A34">        v0 </span><span style="color:#AB5959">+=</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">k</span><span style="color:#a13865">[</span><span style="color:#2F798A">1</span><span style="color:#a13865">]</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">v1 </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 5</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">sum </span><span style="color:#AB5959">+</span><span style="color:#393A34"> v1</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#AB5959">*</span><span style="color:#393A34">k </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 16</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> v1</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">        v1 </span><span style="color:#AB5959">+=</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">k</span><span style="color:#a13865">[</span><span style="color:#2F798A">3</span><span style="color:#a13865">]</span><span style="color:#AB5959"> +</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">v0 </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 5</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">sum </span><span style="color:#AB5959">+</span><span style="color:#393A34"> v0</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">k</span><span style="color:#a13865">[</span><span style="color:#2F798A">2</span><span style="color:#a13865">]</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 16</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> v0</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><br><span style="color:#AB5959">    *</span><span style="color:#393A34">v </span><span style="color:#999999">=</span><span style="color:#393A34"> v0</span><span style="color:#999999">;</span><br><span style="color:#B07D48">    v</span><span style="color:#1e754f">[</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#393A34"> v1</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    return</span><span style="color:#AB5959"> ++</span><span style="color:#393A34">cnt</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> __cdecl </span><span style="color:#80A665">sub_415700</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">unsigned</span><span style="color:#CB7676"> int</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">v</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _DWORD </span><span style="color:#CB7676">*</span><span style="color:#BD976A">k</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [esp+D0h] [ebp-68h]</span><br><span style="color:#CB7676">    unsigned</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> v1</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [esp+118h] [ebp-20h]</span><br><span style="color:#CB7676">    unsigned</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> v0</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [esp+124h] [ebp-14h]</span><br><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> sum</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [esp+130h] [ebp-8h]</span><br><br><span style="color:#80A665">    __CheckForDebuggerJustMyCode</span><span style="color:#4d9375">(</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">unk_41C063</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    sum </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    v0 </span><span style="color:#666666">=</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">v</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    v1 </span><span style="color:#666666">=</span><span style="color:#BD976A"> v</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#4D9375">    for</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 32</span><span style="color:#666666">;</span><span style="color:#CB7676"> ++</span><span style="color:#DBD7CAEE">i </span><span style="color:#4d9375">)</span><br><span style="color:#666666">    </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">        sum </span><span style="color:#CB7676">-=</span><span style="color:#4C9A91"> 1640531527</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">        v0 </span><span style="color:#CB7676">+=</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">k</span><span style="color:#d9739f">[</span><span style="color:#4C9A91">1</span><span style="color:#d9739f">]</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">v1 </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 5</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">sum </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> v1</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">k </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 16</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> v1</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">        v1 </span><span style="color:#CB7676">+=</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">k</span><span style="color:#d9739f">[</span><span style="color:#4C9A91">3</span><span style="color:#d9739f">]</span><span style="color:#CB7676"> +</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">v0 </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 5</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">sum </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> v0</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">k</span><span style="color:#d9739f">[</span><span style="color:#4C9A91">2</span><span style="color:#d9739f">]</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 16</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> v0</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><br><span style="color:#CB7676">    *</span><span style="color:#DBD7CAEE">v </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> v0</span><span style="color:#666666">;</span><br><span style="color:#BD976A">    v</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> v1</span><span style="color:#666666">;</span><br><span style="color:#4D9375">    return</span><span style="color:#CB7676"> ++</span><span style="color:#DBD7CAEE">cnt</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>我简单改了一下变量名称，这个函数也就是 TEA 的加密函数，通过动调可以获得 sum 值，于是可以简单写一个解密脚本：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">void</span><span style="color:#59873A"> decrypt</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">uint32_t*</span><span style="color:#B07D48"> v</span><span style="color:#999999">,</span><span style="color:#AB5959"> uint32_t*</span><span style="color:#B07D48"> k</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">    uint32_t</span><span style="color:#393A34"> v0 </span><span style="color:#999999">=</span><span style="color:#B07D48"> v</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#393A34"> v1 </span><span style="color:#999999">=</span><span style="color:#B07D48"> v</span><span style="color:#1e754f">[</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#393A34"> sum </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">C6EF3720</span><span style="color:#999999">,</span><span style="color:#393A34"> i</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  /* set up */</span><br><span style="color:#AB5959">    uint32_t</span><span style="color:#393A34"> delta </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">61C88647</span><span style="color:#999999">;</span><span style="color:#A0ADA0">                     /* a key schedule constant */</span><br><span style="color:#AB5959">    uint32_t</span><span style="color:#393A34"> k0 </span><span style="color:#999999">=</span><span style="color:#B07D48"> k</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#393A34"> k1 </span><span style="color:#999999">=</span><span style="color:#B07D48"> k</span><span style="color:#1e754f">[</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#393A34"> k2 </span><span style="color:#999999">=</span><span style="color:#B07D48"> k</span><span style="color:#1e754f">[</span><span style="color:#2F798A">2</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#393A34"> k3 </span><span style="color:#999999">=</span><span style="color:#B07D48"> k</span><span style="color:#1e754f">[</span><span style="color:#2F798A">3</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><span style="color:#A0ADA0">   /* cache key */</span><br><span style="color:#1E754F">    for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 32</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">++</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><span style="color:#A0ADA0">                         /* basic cycle start */</span><br><span style="color:#393A34">        v1 </span><span style="color:#AB5959">-=</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#a13865">(</span><span style="color:#393A34">v0 </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 4</span><span style="color:#a13865">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> k2</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">v0 </span><span style="color:#AB5959">+</span><span style="color:#393A34"> sum</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#a13865">(</span><span style="color:#393A34">v0 </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 5</span><span style="color:#a13865">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> k3</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">        v0 </span><span style="color:#AB5959">-=</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#a13865">(</span><span style="color:#393A34">v1 </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 4</span><span style="color:#a13865">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> k0</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">v1 </span><span style="color:#AB5959">+</span><span style="color:#393A34"> sum</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#a13865">(</span><span style="color:#393A34">v1 </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 5</span><span style="color:#a13865">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> k1</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">        sum </span><span style="color:#AB5959">+=</span><span style="color:#393A34"> delta</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#1e754f">}</span><span style="color:#A0ADA0">                                              /* end cycle */</span><br><span style="color:#B07D48">    v</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#393A34"> v0</span><span style="color:#999999">;</span><span style="color:#B07D48"> v</span><span style="color:#1e754f">[</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#393A34"> v1</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">void</span><span style="color:#80A665"> decrypt</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#CB7676">uint32_t*</span><span style="color:#BD976A"> v</span><span style="color:#666666">,</span><span style="color:#CB7676"> uint32_t*</span><span style="color:#BD976A"> k</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">    uint32_t</span><span style="color:#DBD7CAEE"> v0 </span><span style="color:#666666">=</span><span style="color:#BD976A"> v</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> v1 </span><span style="color:#666666">=</span><span style="color:#BD976A"> v</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> sum </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">C6EF3720</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">;</span><span style="color:#758575DD">  /* set up */</span><br><span style="color:#CB7676">    uint32_t</span><span style="color:#DBD7CAEE"> delta </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">61C88647</span><span style="color:#666666">;</span><span style="color:#758575DD">                     /* a key schedule constant */</span><br><span style="color:#CB7676">    uint32_t</span><span style="color:#DBD7CAEE"> k0 </span><span style="color:#666666">=</span><span style="color:#BD976A"> k</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> k1 </span><span style="color:#666666">=</span><span style="color:#BD976A"> k</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> k2 </span><span style="color:#666666">=</span><span style="color:#BD976A"> k</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">2</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> k3 </span><span style="color:#666666">=</span><span style="color:#BD976A"> k</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">3</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><span style="color:#758575DD">   /* cache key */</span><br><span style="color:#4D9375">    for</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 32</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i</span><span style="color:#CB7676">++</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><span style="color:#758575DD">                         /* basic cycle start */</span><br><span style="color:#DBD7CAEE">        v1 </span><span style="color:#CB7676">-=</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">v0 </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 4</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> k2</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">v0 </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> sum</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">v0 </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 5</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> k3</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">        v0 </span><span style="color:#CB7676">-=</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">v1 </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 4</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> k0</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">v1 </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> sum</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">v1 </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 5</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> k1</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">        sum </span><span style="color:#CB7676">+=</span><span style="color:#DBD7CAEE"> delta</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#4d9375">}</span><span style="color:#758575DD">                                              /* end cycle */</span><br><span style="color:#BD976A">    v</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> v0</span><span style="color:#666666">;</span><span style="color:#BD976A"> v</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> v1</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>加密流程大概是：将 flag 转为 16 进制，然后每次取 16 位进行加密，密钥在 R3verier 四个里轮换（密钥也是转为 16 进制，不足 32 位补 0，注意下字节序），这个流程进行四次可以将 flag 前一半加密；然后再对后一半以此流程加密，重复两次。</p>
<p>最终用来对比的密文在：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-x86asm language-x86asm"><span style="color:#59873A">.text</span><span style="color:#393A34">:004159A1                               </span><span style="color:#59873A">loc_4159A1</span><span style="color:#999999">:</span><span style="color:#A0ADA0">                             ; CODE XREF: _main_0:loc_4159F8↓j</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159A1 8B </span><span style="color:#2F798A">45</span><span style="color:#393A34"> E0                      </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">, </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_20</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159A4 </span><span style="color:#2F798A">83</span><span style="color:#393A34"> C0 </span><span style="color:#2F798A">01</span><span style="color:#AB5959">                      add</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">, </span><span style="color:#2F798A">1</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159A7 </span><span style="color:#2F798A">89</span><span style="color:#2F798A"> 45</span><span style="color:#393A34"> E0                      </span><span style="color:#AB5959">mov</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_20</span><span style="color:#2993a3">]</span><span style="color:#393A34">, </span><span style="color:#1E754F">eax</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159AA                               </span><span style="color:#59873A">loc_4159AA</span><span style="color:#999999">:</span><span style="color:#A0ADA0">                             ; CODE XREF: _main_0+14F↑j</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159AA </span><span style="color:#2F798A">83</span><span style="color:#2F798A"> 7D</span><span style="color:#393A34"> E0 </span><span style="color:#2F798A">40</span><span style="color:#AB5959">                   cmp</span><span style="color:#393A34">     </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_20</span><span style="color:#2993a3">]</span><span style="color:#393A34">, </span><span style="color:#2F798A">40h</span><span style="color:#A0ADA0"> ; '@'</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159AE </span><span style="color:#2F798A">7D</span><span style="color:#393A34"> 4A                         </span><span style="color:#AB5959">jge</span><span style="color:#393A34">     short loc_4159FA</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159AE</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159B0 8B </span><span style="color:#2F798A">45</span><span style="color:#393A34"> E0                      </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">     eax</span><span style="color:#393A34">, </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_20</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159B3 0F B6 </span><span style="color:#2F798A">88</span><span style="color:#2F798A"> 00</span><span style="color:#393A34"> A0 </span><span style="color:#2F798A">41</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          movzx</span><span style="color:#1E754F">   ecx</span><span style="color:#393A34">, byte_41A000</span><span style="color:#2993a3">[</span><span style="color:#1E754F">eax</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159BA 8B </span><span style="color:#2F798A">55</span><span style="color:#393A34"> E0                      </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">     edx</span><span style="color:#393A34">, </span><span style="color:#2993a3">[</span><span style="color:#1E754F">ebp</span><span style="color:#393A34">+var_20</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159BD 0F B6 </span><span style="color:#2F798A">82</span><span style="color:#2F798A"> 78</span><span style="color:#393A34"> A5 </span><span style="color:#2F798A">41</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">          movzx</span><span style="color:#1E754F">   eax</span><span style="color:#393A34">, flag</span><span style="color:#2993a3">[</span><span style="color:#1E754F">edx</span><span style="color:#2993a3">]</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159C4 3B C8                         </span><span style="color:#AB5959">cmp</span><span style="color:#1E754F">     ecx</span><span style="color:#393A34">, </span><span style="color:#1E754F">eax</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159C6 </span><span style="color:#2F798A">74</span><span style="color:#2F798A"> 30</span><span style="color:#AB5959">                         jz</span><span style="color:#393A34">      short loc_4159F8</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159C6</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159C8 8B F4                         </span><span style="color:#AB5959">mov</span><span style="color:#1E754F">     esi</span><span style="color:#393A34">, </span><span style="color:#1E754F">esp</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159CA </span><span style="color:#2F798A">68</span><span style="color:#2F798A"> 38</span><span style="color:#393A34"> 7C </span><span style="color:#2F798A">41</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">                push</span><span style="color:#393A34">    offset aOoooooooooopsT          </span><span style="color:#A0ADA0">; "Ooooooooooops!Try again!"</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159CF FF </span><span style="color:#2F798A">15</span><span style="color:#2F798A"> 74</span><span style="color:#393A34"> B1 </span><span style="color:#2F798A">41</span><span style="color:#2F798A"> 00</span><span style="color:#AB5959">             call</span><span style="color:#1E754F">    ds</span><span style="color:#393A34">:puts</span><br><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159F8                               </span><span style="color:#59873A">loc_4159F8</span><span style="color:#999999">:</span><span style="color:#A0ADA0">                             ; CODE XREF: _main_0+176↑j</span><br><span style="color:#59873A">.text</span><span style="color:#393A34">:004159F8 EB A7                         </span><span style="color:#AB5959">jmp</span><span style="color:#393A34">     short loc_4159A1</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-x86asm language-x86asm"><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159A1                               </span><span style="color:#80A665">loc_4159A1</span><span style="color:#666666">:</span><span style="color:#758575DD">                             ; CODE XREF: _main_0:loc_4159F8↓j</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159A1 8B </span><span style="color:#4C9A91">45</span><span style="color:#DBD7CAEE"> E0                      </span><span style="color:#CB7676">mov</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">, </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_20</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159A4 </span><span style="color:#4C9A91">83</span><span style="color:#DBD7CAEE"> C0 </span><span style="color:#4C9A91">01</span><span style="color:#CB7676">                      add</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">1</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159A7 </span><span style="color:#4C9A91">89</span><span style="color:#4C9A91"> 45</span><span style="color:#DBD7CAEE"> E0                      </span><span style="color:#CB7676">mov</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_20</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">eax</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159AA                               </span><span style="color:#80A665">loc_4159AA</span><span style="color:#666666">:</span><span style="color:#758575DD">                             ; CODE XREF: _main_0+14F↑j</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159AA </span><span style="color:#4C9A91">83</span><span style="color:#4C9A91"> 7D</span><span style="color:#DBD7CAEE"> E0 </span><span style="color:#4C9A91">40</span><span style="color:#CB7676">                   cmp</span><span style="color:#DBD7CAEE">     </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_20</span><span style="color:#5eaab5">]</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">40h</span><span style="color:#758575DD"> ; '@'</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159AE </span><span style="color:#4C9A91">7D</span><span style="color:#DBD7CAEE"> 4A                         </span><span style="color:#CB7676">jge</span><span style="color:#DBD7CAEE">     short loc_4159FA</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159AE</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159B0 8B </span><span style="color:#4C9A91">45</span><span style="color:#DBD7CAEE"> E0                      </span><span style="color:#CB7676">mov</span><span style="color:#4D9375">     eax</span><span style="color:#DBD7CAEE">, </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_20</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159B3 0F B6 </span><span style="color:#4C9A91">88</span><span style="color:#4C9A91"> 00</span><span style="color:#DBD7CAEE"> A0 </span><span style="color:#4C9A91">41</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          movzx</span><span style="color:#4D9375">   ecx</span><span style="color:#DBD7CAEE">, byte_41A000</span><span style="color:#5eaab5">[</span><span style="color:#4D9375">eax</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159BA 8B </span><span style="color:#4C9A91">55</span><span style="color:#DBD7CAEE"> E0                      </span><span style="color:#CB7676">mov</span><span style="color:#4D9375">     edx</span><span style="color:#DBD7CAEE">, </span><span style="color:#5eaab5">[</span><span style="color:#4D9375">ebp</span><span style="color:#DBD7CAEE">+var_20</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159BD 0F B6 </span><span style="color:#4C9A91">82</span><span style="color:#4C9A91"> 78</span><span style="color:#DBD7CAEE"> A5 </span><span style="color:#4C9A91">41</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">          movzx</span><span style="color:#4D9375">   eax</span><span style="color:#DBD7CAEE">, flag</span><span style="color:#5eaab5">[</span><span style="color:#4D9375">edx</span><span style="color:#5eaab5">]</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159C4 3B C8                         </span><span style="color:#CB7676">cmp</span><span style="color:#4D9375">     ecx</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">eax</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159C6 </span><span style="color:#4C9A91">74</span><span style="color:#4C9A91"> 30</span><span style="color:#CB7676">                         jz</span><span style="color:#DBD7CAEE">      short loc_4159F8</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159C6</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159C8 8B F4                         </span><span style="color:#CB7676">mov</span><span style="color:#4D9375">     esi</span><span style="color:#DBD7CAEE">, </span><span style="color:#4D9375">esp</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159CA </span><span style="color:#4C9A91">68</span><span style="color:#4C9A91"> 38</span><span style="color:#DBD7CAEE"> 7C </span><span style="color:#4C9A91">41</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">                push</span><span style="color:#DBD7CAEE">    offset aOoooooooooopsT          </span><span style="color:#758575DD">; "Ooooooooooops!Try again!"</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159CF FF </span><span style="color:#4C9A91">15</span><span style="color:#4C9A91"> 74</span><span style="color:#DBD7CAEE"> B1 </span><span style="color:#4C9A91">41</span><span style="color:#4C9A91"> 00</span><span style="color:#CB7676">             call</span><span style="color:#4D9375">    ds</span><span style="color:#DBD7CAEE">:puts</span><br><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159F8                               </span><span style="color:#80A665">loc_4159F8</span><span style="color:#666666">:</span><span style="color:#758575DD">                             ; CODE XREF: _main_0+176↑j</span><br><span style="color:#80A665">.text</span><span style="color:#DBD7CAEE">:004159F8 EB A7                         </span><span style="color:#CB7676">jmp</span><span style="color:#DBD7CAEE">     short loc_4159A1</span><br></code></pre></div>
<p>这一部分汇编比较简单（我删掉了一部分没用的），实际上实现了一个逐位比较密文的循环，故正确的 flag 对应的密文可以在 byte_41A000 里找到，双击进去就有，正好 64 个字符（128 位 16 进制）。</p>
<p>解密就是先将密文一分为二，前一半解密一次，后一半解密两次（注意字节序），拼接一下输出为字符串就得到 flag 了。</p>
<h2 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>参考</a></h2>
<p>（排名不分先后）</p>
<ol>
<li><a href="https://bbs.kanxue.com/thread-206603.htm" title="https://bbs.kanxue.com/thread-206603.htm" target="_blank" rel="noopener">15pb调试器学习总结_except_handler4以及栈展开分析 - By 流韵山庄</a></li>
<li><a href="https://blog.csdn.net/chenlycly/article/details/52575260#t3" title="https://blog.csdn.net/chenlycly/article/details/52575260#t3" target="_blank" rel="noopener">深入解析结构化异常处理(SEH) - by Matt Pietrek</a></li>
<li><a href="https://boxcounter.com/posts/2011-10-19-seh-x86/" title="https://boxcounter.com/posts/2011-10-19-seh-x86/" target="_blank" rel="noopener">SEH分析笔记（x86篇） - By boxcounter</a></li>
<li><a href="https://blog.51cto.com/u_15127670/3677805" title="https://blog.51cto.com/u_15127670/3677805" target="_blank" rel="noopener">Windows异常处理机制简介</a></li>
<li><a href="https://blog.csdn.net/qq_18218335/article/details/70941426" title="https://blog.csdn.net/qq_18218335/article/details/70941426" target="_blank" rel="noopener">SEH进阶（2）</a></li>
<li><a href="https://github.com/cradiator/CrMisc" title="https://github.com/cradiator/CrMisc" target="_blank" rel="noopener">部分反编译代码来源 - By cradiator</a></li>
<li><a href="https://blog.csdn.net/yuzl32/article/details/5457022" title="https://blog.csdn.net/yuzl32/article/details/5457022" target="_blank" rel="noopener">逆向分析MSVCR90D.dll!_EH4_LocalUnwind函数 - By yuzl32</a></li>
<li><a href="https://www.yunzh1jun.com/2022/05/27/WindowsSEH/" title="https://www.yunzh1jun.com/2022/05/27/WindowsSEH/" target="_blank" rel="noopener">Windows-SEH学习笔记 - By 云之君</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/382909501" title="https://zhuanlan.zhihu.com/p/382909501" target="_blank" rel="noopener">windows 异常处理</a></li>
<li><a href="https://github.com/HighSchoolSoftwareClub/Windows-Research-Kernel-WRK-" title="https://github.com/HighSchoolSoftwareClub/Windows-Research-Kernel-WRK-" target="_blank" rel="noopener">Windows-Research-Kernel-WRK - By HighSchoolSoftwareClub</a></li>
<li><a href="https://github.com/Speedi13/ManualMapped_SEH_32bit" title="https://github.com/Speedi13/ManualMapped_SEH_32bit" target="_blank" rel="noopener">ManualMapped_SEH_32bit - By Speedi13</a></li>
<li>chatgpt.</li>
</ol></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>